

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/blog/img/favicon.png">
  <link rel="icon" href="/blog/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="">
  <meta name="keywords" content="">
  
  <title>萤火的博客</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.5.3/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/blog/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.1.2/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/blog/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"zhaoguocheng.gitee.io","root":"/blog/","version":"1.8.11","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":200}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/blog/js/utils.js" ></script>
  <script  src="/blog/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.2.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/blog/">&nbsp;<strong>萤火的博客</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/">
                <i class="iconfont icon-home-fill"></i>
                主页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/blog/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-10-26 20:40" pubdate>
        2021年10月26日 晚上
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      5.3k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      63
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none"></h1>
            
            <div class="markdown-body">
              <h3 id="慢查询"><a href="#慢查询" class="headerlink" title="慢查询"></a>慢查询</h3><p>es里面的操作，主要分为两种，一种写入（增删改），另一种是查询（搜索）。</p>
<p>搜索慢查询日志</p>
<p>无论是慢查询日志，还是慢写入日志，都是针对shard级别的，shard上面执行的慢的写入或者是搜索，都会记录在针对这个shard的日志中。</p>
<p>shard level的搜索慢查询日志，辉将搜索性能较慢的查询写入一个专门的日志文件中。可以针对query phase和fetch phase单独设置慢查询的阈值，而具体的慢查询阈值可以在elasticsearch.yml中设置：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-tag">index</span><span class="hljs-selector-class">.search</span><span class="hljs-selector-class">.slowlog</span><span class="hljs-selector-class">.threshold</span><span class="hljs-selector-class">.query</span><span class="hljs-selector-class">.warn</span>: 10<span class="hljs-selector-tag">s</span><br><span class="hljs-selector-tag">index</span><span class="hljs-selector-class">.search</span><span class="hljs-selector-class">.slowlog</span><span class="hljs-selector-class">.threshold</span><span class="hljs-selector-class">.query</span><span class="hljs-selector-class">.info</span>: 5<span class="hljs-selector-tag">s</span><br><span class="hljs-selector-tag">index</span><span class="hljs-selector-class">.search</span><span class="hljs-selector-class">.slowlog</span><span class="hljs-selector-class">.threshold</span><span class="hljs-selector-class">.query</span><span class="hljs-selector-class">.debug</span>: 2<span class="hljs-selector-tag">s</span><br><span class="hljs-selector-tag">index</span><span class="hljs-selector-class">.search</span><span class="hljs-selector-class">.slowlog</span><span class="hljs-selector-class">.threshold</span><span class="hljs-selector-class">.query</span><span class="hljs-selector-class">.trace</span>: 500<span class="hljs-selector-tag">ms</span><br><br><span class="hljs-selector-tag">index</span><span class="hljs-selector-class">.search</span><span class="hljs-selector-class">.slowlog</span><span class="hljs-selector-class">.threshold</span><span class="hljs-selector-class">.fetch</span><span class="hljs-selector-class">.warn</span>: 1<span class="hljs-selector-tag">s</span><br><span class="hljs-selector-tag">index</span><span class="hljs-selector-class">.search</span><span class="hljs-selector-class">.slowlog</span><span class="hljs-selector-class">.threshold</span><span class="hljs-selector-class">.fetch</span><span class="hljs-selector-class">.info</span>: 800<span class="hljs-selector-tag">ms</span><br><span class="hljs-selector-tag">index</span><span class="hljs-selector-class">.search</span><span class="hljs-selector-class">.slowlog</span><span class="hljs-selector-class">.threshold</span><span class="hljs-selector-class">.fetch</span><span class="hljs-selector-class">.debug</span>: 500<span class="hljs-selector-tag">ms</span><br><span class="hljs-selector-tag">index</span><span class="hljs-selector-class">.search</span><span class="hljs-selector-class">.slowlog</span><span class="hljs-selector-class">.threshold</span><span class="hljs-selector-class">.fetch</span><span class="hljs-selector-class">.trace</span>: 200<span class="hljs-selector-tag">ms</span><br></code></pre></td></tr></table></figure>

<p>而慢查询日志具体的格式，都是在log4j2.properties中配置的，比如下面的配置：</p>
<figure class="highlight roboconf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs roboconf">appender.index_search_slowlog_rolling.type = RollingFile<br>appender.index_search_slowlog_rolling.name = index_search_slowlog_rolling<br>appender.index_search_slowlog_rolling.fileName = $&#123;<span class="hljs-attribute">sys</span>:es<span class="hljs-variable">.logs</span>&#125;_index_search_slowlog<span class="hljs-variable">.log</span><br>appender<span class="hljs-variable">.index_search_slowlog_rolling</span><span class="hljs-variable">.layout</span><span class="hljs-variable">.type</span> = PatternLayout<br>appender<span class="hljs-variable">.index_search_slowlog_rolling</span><span class="hljs-variable">.layout</span><span class="hljs-variable">.pattern</span> = [%d&#123;ISO8601&#125;][%-5p][%-25c] %.10000m%n<br>appender<span class="hljs-variable">.index_search_slowlog_rolling</span><span class="hljs-variable">.filePattern</span> = $&#123;sys:es<span class="hljs-variable">.logs</span>&#125;_index_search_slowlog-%d&#123;yyyy-MM-dd&#125;<span class="hljs-variable">.log</span><br>appender<span class="hljs-variable">.index_search_slowlog_rolling</span><span class="hljs-variable">.policies</span><span class="hljs-variable">.type</span> = Policies<br>appender<span class="hljs-variable">.index_search_slowlog_rolling</span><span class="hljs-variable">.policies</span><span class="hljs-variable">.time</span><span class="hljs-variable">.type</span> = TimeBasedTriggeringPolicy<br>appender<span class="hljs-variable">.index_search_slowlog_rolling</span><span class="hljs-variable">.policies</span><span class="hljs-variable">.time</span><span class="hljs-variable">.interval</span> = 1<br>appender<span class="hljs-variable">.index_search_slowlog_rolling</span><span class="hljs-variable">.policies</span><span class="hljs-variable">.time</span><span class="hljs-variable">.modulate</span> = true<br><br>logger<span class="hljs-variable">.index_search_slowlog_rolling</span><span class="hljs-variable">.name</span> = index<span class="hljs-variable">.search</span><span class="hljs-variable">.slowlog</span><br>logger<span class="hljs-variable">.index_search_slowlog_rolling</span><span class="hljs-variable">.level</span> = trace<br>logger<span class="hljs-variable">.index_search_slowlog_rolling</span><span class="hljs-variable">.appenderRef</span><span class="hljs-variable">.index_search_slowlog_rolling</span><span class="hljs-variable">.ref</span> = index_search_slowlog_rolling<br>logger<span class="hljs-variable">.index_search_slowlog_rolling</span><span class="hljs-variable">.additivity</span> = false<br></code></pre></td></tr></table></figure>

<p>索引慢写入日志</p>
<p>可以用如下的配置来设置索引写入慢日志的阈值：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-tag">index</span><span class="hljs-selector-class">.indexing</span><span class="hljs-selector-class">.slowlog</span><span class="hljs-selector-class">.threshold</span><span class="hljs-selector-class">.index</span><span class="hljs-selector-class">.warn</span>: 10<span class="hljs-selector-tag">s</span><br><span class="hljs-selector-tag">index</span><span class="hljs-selector-class">.indexing</span><span class="hljs-selector-class">.slowlog</span><span class="hljs-selector-class">.threshold</span><span class="hljs-selector-class">.index</span><span class="hljs-selector-class">.info</span>: 5<span class="hljs-selector-tag">s</span><br><span class="hljs-selector-tag">index</span><span class="hljs-selector-class">.indexing</span><span class="hljs-selector-class">.slowlog</span><span class="hljs-selector-class">.threshold</span><span class="hljs-selector-class">.index</span><span class="hljs-selector-class">.debug</span>: 2<span class="hljs-selector-tag">s</span><br><span class="hljs-selector-tag">index</span><span class="hljs-selector-class">.indexing</span><span class="hljs-selector-class">.slowlog</span><span class="hljs-selector-class">.threshold</span><span class="hljs-selector-class">.index</span><span class="hljs-selector-class">.trace</span>: 500<span class="hljs-selector-tag">ms</span><br><span class="hljs-selector-tag">index</span><span class="hljs-selector-class">.indexing</span><span class="hljs-selector-class">.slowlog</span><span class="hljs-selector-class">.level</span>: <span class="hljs-selector-tag">info</span><br><span class="hljs-selector-tag">index</span><span class="hljs-selector-class">.indexing</span><span class="hljs-selector-class">.slowlog</span><span class="hljs-selector-class">.source</span>: 1000<br></code></pre></td></tr></table></figure>

<p>用下面的log4j.properties配置就可以设置索引慢写入日志的格式：</p>
<figure class="highlight roboconf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs roboconf">appender.index_indexing_slowlog_rolling.type = RollingFile<br>appender.index_indexing_slowlog_rolling.name = index_indexing_slowlog_rolling<br>appender.index_indexing_slowlog_rolling.fileName = $&#123;<span class="hljs-attribute">sys</span>:es<span class="hljs-variable">.logs</span>&#125;_index_indexing_slowlog<span class="hljs-variable">.log</span><br>appender<span class="hljs-variable">.index_indexing_slowlog_rolling</span><span class="hljs-variable">.layout</span><span class="hljs-variable">.type</span> = PatternLayout<br>appender<span class="hljs-variable">.index_indexing_slowlog_rolling</span><span class="hljs-variable">.layout</span><span class="hljs-variable">.pattern</span> = [%d&#123;ISO8601&#125;][%-5p][%-25c] %marker%.10000m%n<br>appender<span class="hljs-variable">.index_indexing_slowlog_rolling</span><span class="hljs-variable">.filePattern</span> = $&#123;sys:es<span class="hljs-variable">.logs</span>&#125;_index_indexing_slowlog-%d&#123;yyyy-MM-dd&#125;<span class="hljs-variable">.log</span><br>appender<span class="hljs-variable">.index_indexing_slowlog_rolling</span><span class="hljs-variable">.policies</span><span class="hljs-variable">.type</span> = Policies<br>appender<span class="hljs-variable">.index_indexing_slowlog_rolling</span><span class="hljs-variable">.policies</span><span class="hljs-variable">.time</span><span class="hljs-variable">.type</span> = TimeBasedTriggeringPolicy<br>appender<span class="hljs-variable">.index_indexing_slowlog_rolling</span><span class="hljs-variable">.policies</span><span class="hljs-variable">.time</span><span class="hljs-variable">.interval</span> = 1<br>appender<span class="hljs-variable">.index_indexing_slowlog_rolling</span><span class="hljs-variable">.policies</span><span class="hljs-variable">.time</span><span class="hljs-variable">.modulate</span> = true<br><br>logger<span class="hljs-variable">.index_indexing_slowlog</span><span class="hljs-variable">.name</span> = index<span class="hljs-variable">.indexing</span><span class="hljs-variable">.slowlog</span><span class="hljs-variable">.index</span><br>logger<span class="hljs-variable">.index_indexing_slowlog</span><span class="hljs-variable">.level</span> = trace<br>logger<span class="hljs-variable">.index_indexing_slowlog</span><span class="hljs-variable">.appenderRef</span><span class="hljs-variable">.index_indexing_slowlog_rolling</span><span class="hljs-variable">.ref</span> = index_indexing_slowlog_rolling<br>logger<span class="hljs-variable">.index_indexing_slowlog</span><span class="hljs-variable">.additivity</span> = false<br></code></pre></td></tr></table></figure>

<h3 id="基础调优"><a href="#基础调优" class="headerlink" title="基础调优"></a>基础调优</h3><p>搜索结果不要返回过大的结果集</p>
<p>es是一个搜索引擎，所以如果用这个搜索引擎对大量的数据进行搜索，并且返回搜索结果中排在最前面的少数结果，是非常合适的。然而，如果要做成类似数据库的东西，每次都进行大批量的查询，是很不合适的。如果真的要做大批量结果的查询，记得考虑用scroll api。</p>
<p>避免超大的document</p>
<p>http.max_context_length的默认值是100mb，意味着你一次document写入时，document的内容不能超过100mb，否则es就会拒绝写入。而且es底层的lucene引擎还是有一个2gb的最大限制。</p>
<p>即使我们不考虑引擎层的限制，超大的document在实际生产环境中是很不好的。超大document会耗费更多的网络资源，内存资源和磁盘资源，甚至对那些不要求获取_source的请求，也是一样，因为es需要从_source中提取_id字段，对于超大document这个获取_id字段的过程的资源开销也是很大的。而将这种超大document写入es也会使用大量的内存，占用内存空间的大小甚至会是documdent本身大小的数倍。近似匹配的搜索，比如phrase query，以及高亮显示，对超大document的资源开销会更大，因为这些操作的性能开销直接跟document的大小成正比。</p>
<p>因此对于超大document，可以考虑进行拆分。比如要对一些书进行搜索，可以将每一篇章或者一个段落作为一个document，然后给一个field标识出来这些document属于哪本书，这样每个document的大小相比于使用整本书作为一个document要小得多。这就可以避免超大document导致的各种开销，同时可以优化搜索的体验。比如说，如果一个用户要搜索两个单词，foo和bar，如果在两个不同的段落中分别匹配了一个单词，肯定匹配效果要比，一个段落中匹配了两个单词要差。</p>
<p>避免稀疏的数据</p>
<p>lucene的内核结构跟稠密的数据配合起来性能会更好。比如有100个document，每个document都有20个field，20个field都有值，这就是稠密的数据。但是如果100个document，每个document的field都不一样，有的document有2个field，有的document有50个field，这就是稀疏的数据。</p>
<p>原因就是，lucene在内部会通过doc id来唯一标识一个document，这个doc id是integer类型，范围在0到索引中含有的document数量之间。这些doc id是用来在lucene内部的api之间进行通信的，比如说，对一个term用一个match query来进行搜索，就会产生一个doc id集合，然后这些doc id会用来获取对应的norm值，以用来计算每个doc的相关度分数。而根据doc id查找norm的过程，是通过每个document的每个field保留一个字节来进行的一个算法，这个过程叫做norm查找，norm就是每个document的每个field保留的一个字节。对于每个doc id对应的那个norm值，可以通过读取es一个内置索引，叫做doc_id的索引，中的一个字节来获取。这个过程是性能很高的，而且可以帮助lucene快速的定位到每个document的norm值，但是同时这样的话document本身就不需要存储这一个字节的norm值了。</p>
<p>在实际运行过程中，这就意味着，如果一个索引有100个document，对于每个field，就需要100个字节来存储norm值，即使100个document中只有10个document含有某个field，但是对那个field来说，还是要100个字节来存储norm值。这就会对存储产生更大的开销，存储空间被浪费的一个问题，而且也会影响读写性能。</p>
<p>下面有一些避免稀疏数据的办法：</p>
<p>避免将没有任何关联性的数据写入同一个索引</p>
<p>我们必须避免将结构完全不一样的数据写入同一个索引中，因为结构完全不一样的数据，field是完全不一样的，会导致index数据非常稀疏。最好将这种数据写入不同的索引中，如果这种索引数据量比较少，那么可以考虑给其很少的primary shard，比如1个，避免资源浪费。</p>
<p>对document的结构进行规范化/标准化</p>
<p>即使我们真的要将不同类型的document写入相同的索引中，还是有办法可以避免稀疏性，那就是对不同类型的document进行标准化。比如说，如果所有的document都有一个时间戳field，不过有的叫做timestamp，有的叫做creation_date，那么可以将不同document的这个field重命名为相同的字段，尽量让document的结构相同。另外一个，就是比如有的document有一个字段，叫做goods_type，但是有的document没有这个字段，此时可以对没有这个字段的document，补充一个goods_type给一个默认值，比如default。</p>
<p>避免使用多个types存储不一样结构的document</p>
<p>很多人会很喜欢在一个index中放很多个types来存储不同类型的数据。但是其实不是这样的，最好不要这么干，如果你在一个index中有多个type，但是这些type的数据结构不太一样，那么这些type实际上底层都是写到这个索引中的，还是会导致稀疏性。如果多个type的结构不太一样，最好放入不同的索引中，不要写入一个索引中。</p>
<p>对稀疏的field禁用norms和doc_values</p>
<p>如果上面的步骤都没法做，那么只能对那种稀疏的field，禁止norms和doc_values字段，因为这两个字段的存储机制类似，都是每个field有一个全量的存储，对存储浪费很大。如果一个field不需要考虑其相关度分数，那么可以禁用norms，如果不需要对一个field进行排序或者聚合，那么可以禁用doc_values字段。</p>
<h3 id="写入性能优化"><a href="#写入性能优化" class="headerlink" title="写入性能优化"></a>写入性能优化</h3><p>用bulk批量写入</p>
<p>如果要往es里面灌入数据的话，尽量采用bulk的方式，每次批量写个几百条。bulk批量写入的性能比一条一条写入大量的document的性能要好很多。</p>
<p>bulk size并非越大越好，而是根据集群环境具体要测试出来的，因为越大的bulk size会导致内存压力过大，因此最好一个请求不要发送超过10mb的数据量。如果需要得到bulk请求最佳的大小，可以对单个es node的单个shard做压测。先bulk写入100个document，然后200个，400个，以此类推，每次都将bulk size加倍一次。如果bulk写入性能开始变平缓的时候，那么这个就是最佳的bulk大小。</p>
<p>使用多线程将数据写入es</p>
<p>单线程发送bulk请求是无法最大化es集群写入的吞吐量的。如果要利用集群的所有资源，就需要使用多线程并发将数据bulk写入集群中。为了更好的利用集群的资源，这样多线程并发写入，可以减少每次底层磁盘fsync的次数和开销。一样，可以对单个es节点的单个shard做压测，比如说，先是2个线程，然后是4个线程，然后是8个线程，每次线程数量倍增。一旦发现es返回了TOO_MANY_REQUESTS的错误，JavaClient也就是EsRejectedExecutionException，此时就说明es是说已经到了一个并发写入的最大瓶颈了。</p>
<p>增加refresh间隔</p>
<p>默认的refresh间隔是1s，用index.refresh_interval参数可以设置，这样会其强迫es每秒中都将内存中的数据写入磁盘中，创建一个新的segment file。正是这个间隔，让我们每次写入数据后，1s以后才能看到。但是如果我们将这个间隔调大，比如30s，可以接受写入的数据30s后才看到，那么我们就可以获取更大的写入吞吐量，因为30s内都是写内存的，每隔30s才会创建一个segment file。</p>
<p>禁止refresh和replia</p>
<p>如果我们要一次性加载大批量的数据进es，可以先禁止refresh和replia复制，将index.refresh_interval设置为-1，将index.number_of_replicas设置为0即可。这可能会导致我们的数据丢失，因为没有refresh和replica机制了。但是不需要创建segment file，也不需要将数据replica复制到其他的replica shasrd上面去。此时写入的速度会非常快，一旦写完之后，可以将refresh和replica修改回正常的状态。</p>
<p>禁止swapping交换内存</p>
<p>之前讲解果，可以将swapping禁止掉，有的时候，如果要将es jvm内存交换到磁盘，再交换回内存，大量磁盘IO，性能很差</p>
<p>给filesystem cache更多的内存</p>
<p>filesystem cache被用来执行更多的IO操作，如果我们能给filesystem cache更多的内存资源，那么es的写入性能会好很多。</p>
<p>使用自动生成的id</p>
<p>如果我们要手动给es document设置一个id，那么es需要每次都去确认一下那个id是否存在，这个过程是比较耗费时间的。如果我们使用自动生成的id，那么es就可以跳过这个步骤，写入性能会更好。对于你的业务中的表id，可以作为es document的一个field。</p>
<p>用性能更好的硬件</p>
<p>我们可以给filesystem cache更多的内存，也可以使用SSD替代机械硬盘，避免使用NAS等网络存储，考虑使用RAID 0来条带化存储提升磁盘并行读写效率，等等。</p>
<p>index buffer</p>
<p>如果我们要进行非常重的高并发写入操作，那么最好将index buffer调大一些，indices.memory.index_buffer_size，这个可以调节大一些，设置的这个index buffer大小，是所有的shard公用的，但是如果除以shard数量以后，算出来平均每个shard可以使用的内存大小，一般建议，但是对于每个shard来说，最多给512mb，因为再大性能就没什么提升了。es会将这个设置作为每个shard共享的index buffer，那些特别活跃的shard会更多的使用这个buffer。默认这个参数的值是10%，也就是jvm heap的10%，如果我们给jvm heap分配10gb内存，那么这个index buffer就有1gb，对于两个shard共享来说，是足够的了。</p>
<h3 id="搜索性能优化"><a href="#搜索性能优化" class="headerlink" title="搜索性能优化"></a>搜索性能优化</h3><p>给filesysgtem cache更多的内存</p>
<p>es的搜索引擎严重依赖于底层的filesystem cache，如果filesystem cache内存可以容纳所有的indx segment file索引数据文件，那么搜索的时候性能会非常高。</p>
<p>比如es节点有3台机器，每台机器64G内存，给es jvm heap是32G，那么剩下来留给filesystem cache的就是每台机器才32g，总共集群里给filesystem cache的就是32 * 3 = 96gb内存。如果在3台机器上的索引数据文件一共占用了1T的磁盘容量，这时其实只有十分之一的数据可以放内存，执行搜索操作大部分操作都是走磁盘性能肯定差。最佳的情况下，es集群的内存，至少需要容纳总数据量的一半。这时大部分操作是走内存的，性能一般可以到几秒钟。</p>
<p>最佳的情况下，es集群只存储少量数据，使的全部数据都可以加载到内存中，这时搜索的性能非常之高，一般可以在1秒以内。比如说现在有一份数据，有100个字段，其实用来搜索的只有10个字段，建议是将10个字段的数据，存入es，剩下90个字段的数据，可以放mysql，hadoop hbase，都可以。这样的话，es数据量很少，10个字段的数据都可以放内存用来搜索，搜索出来id后，通过id去mysql，hbase里面去查询明细的数据。</p>
<p>用更快的硬件资源</p>
<ol>
<li>给filesystem cache更多的内存资源</li>
<li>用SSD固态硬盘</li>
<li>使用本地存储系统，不要用NFS等网络存储系统</li>
<li>给更多的CPU资源</li>
</ol>
<p>document模型设计</p>
<p>document模型设计是非常重要的，尽量避免在搜索的时候执行复杂的操作。如果确实需要，可以采取以下两种方式：</p>
<ol>
<li>在写入数据的时候，就设计好模型，加几个字段，把处理好的数据写入加的字段里面。</li>
<li>用java程序封装，通过java对es搜索出来的数据进行一些特别复杂的操作。</li>
</ol>
<p>预先index data</p>
<p>为了性能，提前优化data index时的数据模型，比如说document有一个price field，然后大多数查询都对一个固定的范围，对这个field使用range范围查询，那么可以提前将这个price的范围处理出来，写入一个字段中。比如下面这样：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk">PUT index<span class="hljs-regexp">/type/</span><span class="hljs-number">1</span><br>&#123;<br>  <span class="hljs-string">&quot;designation&quot;</span>: <span class="hljs-string">&quot;spoon&quot;</span>,<br>  <span class="hljs-string">&quot;price&quot;</span>: <span class="hljs-number">13</span><br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs excel">GET <span class="hljs-built_in">index</span>/_<span class="hljs-built_in">search</span><br>&#123;<br>  <span class="hljs-string">&quot;aggs&quot;</span><span class="hljs-symbol">:</span> &#123;<br>    <span class="hljs-string">&quot;price_ranges&quot;</span><span class="hljs-symbol">:</span> &#123;<br>      <span class="hljs-string">&quot;range&quot;</span><span class="hljs-symbol">:</span> &#123;<br>        <span class="hljs-string">&quot;field&quot;</span><span class="hljs-symbol">:</span> <span class="hljs-string">&quot;price&quot;</span>,<br>        <span class="hljs-string">&quot;ranges&quot;</span><span class="hljs-symbol">:</span> [<br>          &#123; <span class="hljs-string">&quot;to&quot;</span><span class="hljs-symbol">:</span> <span class="hljs-number">10</span> &#125;,<br>          &#123; <span class="hljs-string">&quot;from&quot;</span><span class="hljs-symbol">:</span> <span class="hljs-number">10</span>, <span class="hljs-string">&quot;to&quot;</span><span class="hljs-symbol">:</span> <span class="hljs-number">100</span> &#125;,<br>          &#123; <span class="hljs-string">&quot;from&quot;</span><span class="hljs-symbol">:</span> <span class="hljs-number">100</span> &#125;<br>        ]<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>我们完全可以增加一个price_range字段：</p>
<figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sas"><span class="hljs-meta">PUT</span> <span class="hljs-meta">index</span><br>&#123;<br>  <span class="hljs-string">&quot;mappings&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;type&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;price_range&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;keyword&quot;</span><br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后写入的时候，直接计算出来这个range：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs awk">PUT index<span class="hljs-regexp">/type/</span><span class="hljs-number">1</span><br>&#123;<br>  <span class="hljs-string">&quot;designation&quot;</span>: <span class="hljs-string">&quot;spoon&quot;</span>,<br>  <span class="hljs-string">&quot;price&quot;</span>: <span class="hljs-number">13</span>,<br>  <span class="hljs-string">&quot;price_range&quot;</span>: <span class="hljs-string">&quot;10-100&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后搜索的时候，就可以直接用term查询了，性能非常高：</p>
<figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs excel">GET <span class="hljs-built_in">index</span>/_<span class="hljs-built_in">search</span><br>&#123;<br>  <span class="hljs-string">&quot;aggs&quot;</span><span class="hljs-symbol">:</span> &#123;<br>    <span class="hljs-string">&quot;price_ranges&quot;</span><span class="hljs-symbol">:</span> &#123;<br>      <span class="hljs-string">&quot;terms&quot;</span><span class="hljs-symbol">:</span> &#123;<br>        <span class="hljs-string">&quot;field&quot;</span><span class="hljs-symbol">:</span> <span class="hljs-string">&quot;price_range&quot;</span><br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>预热filesystem cache</p>
<p>如果我们重启了es，那么filesystem cache是空壳的，就需要不断的查询才能重新让filesystem cache热起来，我们可以先说动对一些数据进行查询。</p>
<p>比如说，你本来一个查询，要用户点击以后才执行，才能从磁盘加载到filesystem cache里，第一次执行要10s，以后每次就几百毫秒</p>
<p>你完全可以，自己早上的时候，就程序执行那个查询，预热，数据就加载到filesystem cahce，程序执行的时候是10s，以后用户真的来看的时候就才几百毫秒</p>
<p>避免使用script脚本</p>
<p>说实话，一般是避免使用es script的，实际生产中更是少用，性能不高，尽量不要使用</p>
<p>使用固定范围的日期查询</p>
<p>尽量不要使用now这种内置函数来执行日期查询，因为默认now是到毫秒级的，是无法缓存结果，尽量使用一个阶段范围，比如now/m，就是到分钟级</p>
<p>那么如果一分钟内，都执行这个查询，是可以取用查询缓存的</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs awk">PUT index<span class="hljs-regexp">/type/</span><span class="hljs-number">1</span><br>&#123;<br>  <span class="hljs-string">&quot;my_date&quot;</span>: <span class="hljs-string">&quot;2016-05-11T16:30:55.328Z&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs excel">GET <span class="hljs-built_in">index</span>/_<span class="hljs-built_in">search</span><br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span><span class="hljs-symbol">:</span> &#123;<br>    <span class="hljs-string">&quot;constant_score&quot;</span><span class="hljs-symbol">:</span> &#123;<br>      <span class="hljs-string">&quot;filter&quot;</span><span class="hljs-symbol">:</span> &#123;<br>        <span class="hljs-string">&quot;range&quot;</span><span class="hljs-symbol">:</span> &#123;<br>          <span class="hljs-string">&quot;my_date&quot;</span><span class="hljs-symbol">:</span> &#123;<br>            <span class="hljs-string">&quot;gte&quot;</span><span class="hljs-symbol">:</span> <span class="hljs-string">&quot;now-1h&quot;</span>,<br>            <span class="hljs-string">&quot;lte&quot;</span><span class="hljs-symbol">:</span> <span class="hljs-string">&quot;now&quot;</span><br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>完全可以替换为：</p>
<figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs excel">GET <span class="hljs-built_in">index</span>/_<span class="hljs-built_in">search</span><br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span><span class="hljs-symbol">:</span> &#123;<br>    <span class="hljs-string">&quot;constant_score&quot;</span><span class="hljs-symbol">:</span> &#123;<br>      <span class="hljs-string">&quot;filter&quot;</span><span class="hljs-symbol">:</span> &#123;<br>        <span class="hljs-string">&quot;range&quot;</span><span class="hljs-symbol">:</span> &#123;<br>          <span class="hljs-string">&quot;my_date&quot;</span><span class="hljs-symbol">:</span> &#123;<br>            <span class="hljs-string">&quot;gte&quot;</span><span class="hljs-symbol">:</span> <span class="hljs-string">&quot;now-1h/m&quot;</span>,<br>            <span class="hljs-string">&quot;lte&quot;</span><span class="hljs-symbol">:</span> <span class="hljs-string">&quot;now/m&quot;</span><br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="磁盘读写性能优化"><a href="#磁盘读写性能优化" class="headerlink" title="磁盘读写性能优化"></a>磁盘读写性能优化</h3><p>优化磁盘空间的占用，可以减少磁盘空间的占用，使得更多的数据可以进入filesystem cache</p>
<p>禁用不需要的功能</p>
<p>es的功能分四种：</p>
<ul>
<li>聚合：doc values</li>
<li>搜索：倒排索引，index</li>
<li>评分：norms</li>
<li>近似匹配：index_options（freqs）</li>
</ul>
<p>任何一个功能不需要，就把对应的存储的数据给干掉，这样可以节约磁盘空间的占用，也可以优化磁盘的读写性能。</p>
<p>默认情况下，es在写入document到索引的时候，都会给大多数的field增加一份doc values，就是正排索引，用来进行聚合或者排序的。比如说，如果我们有一个叫做foo的数字类型field，我们要对这个字段运行histograms aggr聚合操作，但是可能我们并不需要对这个字段进行搜索，那么就可以禁止为这个字段生成倒排索引，只需要doc value正排索引即可。禁用倒排索引：</p>
<figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs axapta">PUT <span class="hljs-keyword">index</span><br>&#123;<br>  <span class="hljs-string">&quot;mappings&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;type&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;foo&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;integer&quot;</span>,<br>          <span class="hljs-string">&quot;index&quot;</span>: <span class="hljs-literal">false</span><br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>text类型的field会存储norm值，用来计算doc的相关度分数，如果我们需要对一个text field进行搜索，但是不关心这个field的分数，那么可以禁用norm值</p>
<figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs axapta">PUT <span class="hljs-keyword">index</span><br>&#123;<br>  <span class="hljs-string">&quot;mappings&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;type&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;foo&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span>,<br>          <span class="hljs-string">&quot;norms&quot;</span>: <span class="hljs-literal">false</span><br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>text field还会存储出现频率以及位置，出现频率也是用来计算相关度分数的，位置是用来进行phrase query这种近似匹配操作的，如果我们不需要执行phrase query近似匹配，那么可以禁用位置这个属性：</p>
<figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sas"><span class="hljs-meta">PUT</span> <span class="hljs-meta">index</span><br>&#123;<br>  <span class="hljs-string">&quot;mappings&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;type&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;foo&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span>,<br>          <span class="hljs-string">&quot;index_options&quot;</span>: <span class="hljs-string">&quot;freqs&quot;</span><br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>此外，如果我们不关心相关度评分，我们可以配置es仅仅为每个term索引对应的document，我们可以对这个field进行搜索，但是phrase query这种近似匹配会报错，而且相关度评分会不准确：</p>
<figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs axapta">PUT <span class="hljs-keyword">index</span><br>&#123;<br>  <span class="hljs-string">&quot;mappings&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;type&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;foo&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span>,<br>          <span class="hljs-string">&quot;norms&quot;</span>: <span class="hljs-literal">false</span>,<br>          <span class="hljs-string">&quot;index_options&quot;</span>: <span class="hljs-string">&quot;freqs&quot;</span><br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>不要用默认的动态string类型映射</p>
<p>默认的动态string类型映射会将string类型的field同时映射为text类型以及keyword类型，这会浪费磁盘空间，因为我们不一定两种都需要。通常来说，id field这种字段可能只需要keyword映射，而body field可能只需要text field。</p>
<p>可以通过手动设置mappings映射来避免字符串类型的field被自动映射为text和keyword：</p>
<figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs sas"><span class="hljs-meta">PUT</span> <span class="hljs-meta">index</span><br>&#123;<br>  <span class="hljs-string">&quot;mappings&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;type&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;dynamic_templates&quot;</span>: [<br>        &#123;<br>          <span class="hljs-string">&quot;strings&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;match_mapping_type&quot;</span>: <span class="hljs-string">&quot;string&quot;</span>,<br>            <span class="hljs-string">&quot;mapping&quot;</span>: &#123;<br>              <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;keyword&quot;</span><br>            &#125;<br>          &#125;<br>        &#125;<br>      ]<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>禁止_all field</p>
<p>_all field会将document中所有field的值都合并在一起进行索引，很耗费空空间，如果不需要一次性对所有的field都进行搜索，那么最好禁用_all field。</p>
<p>使用best_compression</p>
<p>_source field和其他field都很耗费磁盘空间，最好是对其使用best_compression进行压缩。用elasticsearch.yml中的index.codec来设置，将其设置为best_compression即可。</p>
<p>用最小的最合适的数字类型</p>
<p>es支持4种数字类型，byte，short，integer，long。如果最小的类型就合适，那么就用最小的类型。</p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/blog/2021/11/20/Elasticsearch/elasticsearch%E5%9F%BA%E7%A1%80/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile"></span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/blog/2021/10/21/Elasticsearch/elasticsearch%E7%B4%A2%E5%BC%95%E7%AE%A1%E7%90%86/">
                        <span class="hidden-mobile"></span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.staticfile.org/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":200})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.staticfile.org/jquery/3.5.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.5.3/js/bootstrap.min.js" ></script>
<script  src="/blog/js/events.js" ></script>
<script  src="/blog/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/blog/js/img-lazyload.js" ></script>
  



  



  <script  src="https://cdn.staticfile.org/tocbot/4.12.0/tocbot.min.js" ></script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>






  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/blog/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/blog/local-search.xml";
      jQuery('#local-search-input').on('click', function() {
        searchFunc(path, 'local-search-input', 'local-search-result');
      });
      jQuery('#modalSearch').on('shown.bs.modal', function() {
        jQuery('#local-search-input').focus();
      });
    })()
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/blog/js/boot.js" ></script>


</body>
</html>
