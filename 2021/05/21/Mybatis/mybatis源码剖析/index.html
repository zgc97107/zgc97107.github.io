

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="">
  <meta name="keywords" content="">
  
    <meta name="description" content="概述MyBatis 是一款优秀的持久层框架，也是当前最流行的java持久层框架之一，它内部封装了jdbc，使开发者只需要关注sql语句本身，而不需要花费精力去处理加载驱动、创建连接、创建statement等繁杂的过程。采用ORM思想解决了实体和数据库映射的问题，对jdbc进行了封装，屏蔽了jdbc api底层访问细节，使我们不用与jdbc api打交道，就可以完成对数据库的持久化操作。  myba">
<meta property="og:type" content="article">
<meta property="og:title" content="mybatis源码剖析">
<meta property="og:url" content="https://zgc97107.github.io/2021/05/21/Mybatis/mybatis%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/index.html">
<meta property="og:site_name" content="萤火的博客">
<meta property="og:description" content="概述MyBatis 是一款优秀的持久层框架，也是当前最流行的java持久层框架之一，它内部封装了jdbc，使开发者只需要关注sql语句本身，而不需要花费精力去处理加载驱动、创建连接、创建statement等繁杂的过程。采用ORM思想解决了实体和数据库映射的问题，对jdbc进行了封装，屏蔽了jdbc api底层访问细节，使我们不用与jdbc api打交道，就可以完成对数据库的持久化操作。  myba">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://zgc97107.github.io/2021/05/21/Mybatis/mybatis%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/image-20210524175900708.png">
<meta property="og:image" content="https://zgc97107.github.io/2021/05/21/Mybatis/mybatis%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/image-20210524180609347.png">
<meta property="og:image" content="https://zgc97107.github.io/2021/05/21/Mybatis/mybatis%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/image-20210524181031999.png">
<meta property="og:image" content="https://zgc97107.github.io/2021/05/21/Mybatis/mybatis%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/image-20210524181142108.png">
<meta property="og:image" content="https://zgc97107.github.io/2021/05/21/Mybatis/mybatis%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/image-20210524181306066.png">
<meta property="og:image" content="https://zgc97107.github.io/2021/05/21/Mybatis/mybatis%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/image-20210524225426054.png">
<meta property="og:image" content="https://zgc97107.github.io/2021/05/21/Mybatis/mybatis%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/image-20210524230610780.png">
<meta property="og:image" content="https://zgc97107.github.io/2021/05/21/Mybatis/mybatis%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/image-20210524231216534.png">
<meta property="og:image" content="https://zgc97107.github.io/2021/05/21/Mybatis/mybatis%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/image-20210524233213028.png">
<meta property="og:image" content="https://zgc97107.github.io/2021/05/21/Mybatis/mybatis%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/image-20210524234035669.png">
<meta property="og:image" content="https://zgc97107.github.io/2021/05/21/Mybatis/mybatis%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/image-20210525183539555.png">
<meta property="og:image" content="https://zgc97107.github.io/2021/05/21/Mybatis/mybatis%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/image-20210525184045156.png">
<meta property="og:image" content="https://zgc97107.github.io/2021/05/21/Mybatis/mybatis%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/image-20210525190449384.png">
<meta property="og:image" content="https://zgc97107.github.io/2021/05/21/Mybatis/mybatis%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/image-20210525213818893.png">
<meta property="article:published_time" content="2021-05-21T03:24:56.000Z">
<meta property="article:modified_time" content="2021-05-21T03:24:56.000Z">
<meta property="article:tag" content="mybatis">
<meta property="article:tag" content="源码">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://zgc97107.github.io/2021/05/21/Mybatis/mybatis%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/image-20210524175900708.png">
  
  
  
  <title>mybatis源码剖析 - 萤火的博客</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"zgc97107.github.io","root":"/","version":"1.9.3","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 5.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>萤火的博客</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                主页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="mybatis源码剖析"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2021-05-21 11:24" pubdate>
          2021年5月21日 上午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          73k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          609 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar category-bar" style="margin-right: -1rem">
    





<div class="category-list">
  
  
    
    
    
    <div class="category row nomargin-x">
      <a class="category-item 
          list-group-item category-item-action col-10 col-md-11 col-xm-11" title="Mybatis"
        id="heading-dcfb60bf74123650041eacb77b10c116" role="tab" data-toggle="collapse" href="#collapse-dcfb60bf74123650041eacb77b10c116"
        aria-expanded="true"
      >
        Mybatis
        <span class="list-group-count">(1)</span>
        <i class="iconfont icon-arrowright"></i>
      </a>
      
      <div class="category-collapse collapse show" id="collapse-dcfb60bf74123650041eacb77b10c116"
           role="tabpanel" aria-labelledby="heading-dcfb60bf74123650041eacb77b10c116">
        
        
          
  <div class="category-post-list">
    
    
      
      
        <a href="/2021/05/21/Mybatis/mybatis%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/" title="mybatis源码剖析"
           class="list-group-item list-group-item-action
           active">
          <span class="category-post">mybatis源码剖析</span>
        </a>
      
    
  </div>

        
      </div>
    </div>
  
</div>


  </aside>


    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">mybatis源码剖析</h1>
            
            
              <div class="markdown-body">
                
                <h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>MyBatis 是一款优秀的持久层框架，也是当前最流行的java持久层框架之一，它内部封装了jdbc，使开发者只需要关注sql语句本身，而不需要花费精力去处理加载驱动、创建连接、创建statement等繁杂的过程。采用ORM思想解决了实体和数据库映射的问题，对jdbc进行了封装，屏蔽了jdbc api底层访问细节，使我们不用与jdbc api打交道，就可以完成对数据库的持久化操作。 </p>
<p>mybatis通过xml或注解的方式将要执行的各种statement配置起来，并通过java对象和statement中sql的动态参数进行映射生成最终执行的sql语句，最后由mybatis框架执行sql并将结果映射为java对象并返回。</p>
<p>为了更好地学习和理解mybatis背后的设计思路，作为高级开发人员，有必要深入研究了解优秀框架的源码，以便更好的借鉴其思想。同时，框架作为设计模式的主要应用场景，通过研究优秀框架的源码，可以更好的领会设计模式的精髓。</p>
<p>MyBatis官方文档：<a target="_blank" rel="noopener" href="https://mybatis.org/mybatis-3/zh/index.html">https://mybatis.org/mybatis-3/zh/index.html</a></p>
<h3 id="架构体系深入剖析"><a href="#架构体系深入剖析" class="headerlink" title="架构体系深入剖析"></a>架构体系深入剖析</h3><h4 id="整体架构体系"><a href="#整体架构体系" class="headerlink" title="整体架构体系"></a>整体架构体系</h4><p><img src="/2021/05/21/Mybatis/mybatis%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/image-20210524175900708.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="工作机制和实现原理"><a href="#工作机制和实现原理" class="headerlink" title="工作机制和实现原理"></a>工作机制和实现原理</h4><ol>
<li><p>API接口层：提供给外部使用的接口API，开发人员通过这些本地API来操纵数据库。 接口层一接收到调用请求就会调用数据处理层来完成具体的数据处理。 </p>
</li>
<li><p>数据处理层：负责具体的SQL查找、SQL解析、SQL执行和执行结果映射处理等。 它主要的目的是根据调用的请求完成一次数据库操作。 </p>
</li>
<li><p>基础支撑层：负责最基础的功能支撑，包括连接管理、事务管理、配置加载和缓存处理，这些都是共用的东西，将他们抽取出来作为最基础的组件。为上层的数据处理层提供最基础的支撑。</p>
</li>
</ol>
<h5 id="接口层"><a href="#接口层" class="headerlink" title="接口层"></a>接口层</h5><p><strong>概述</strong></p>
<p>对应 session 模块。接口层相对简单，其核心是 SqlSession 接口，该接口中定义了 MyBatis 暴露给应用程序调用的API，也就是上层应用与 MyBatis 交互的桥梁。接口层在接收到调用请求时，会调用核心处理层的相应模块来完成具体的数据库操作。</p>
<p><strong>作用</strong></p>
<p>使用SqlSession接口和Mapper接口通知调用哪个sql还有关联参数。</p>
<p>可以实现数据的增/删/改/查接口 配置信息维护接口，进行动态的更改配置</p>
<p><strong>获取SqlSession流程分析：</strong></p>
<p><img src="/2021/05/21/Mybatis/mybatis%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/image-20210524180609347.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>SqlSession源码分析</strong></p>
<p>作用：Mybatis工作的主要顶层API，表示和数据库交互的会话，完成必要数据库增删改查功能</p>
<h5 id="数据处理核心层"><a href="#数据处理核心层" class="headerlink" title="数据处理核心层"></a>数据处理核心层</h5><p>在核心处理层中，实现了 MyBatis 的核心处理流程。其中包括 MyBatis 的<strong>初始化</strong>以及完成一次<strong>数据库操作</strong>的涉及的全部流程 。</p>
<h6 id="配置解析"><a href="#配置解析" class="headerlink" title="配置解析"></a>配置解析</h6><p><strong>概述</strong></p>
<p>对应 builder 和 mapping 模块。前者为配置解析过程，后者主要为 SQL 操作解析后的映射。</p>
<p>在 MyBatis 初始化过程中，会加载 mybatis-config.xml 配置文件、映射配置文件以及 Mapper 接口中的注解信息，解析后的配置信息会形成相应的对象并保存到 Confifiguration 对象中。利用该 Confifiguration 对象创建 SqlSessionFactory对象。待 MyBatis 初始化之后，开发人员可以通过初始化得到 SqlSessionFactory 创建 SqlSession 对象并完成数据库操作。</p>
<p><strong>Configuration</strong> 概述：是一个所有配置信息的容器对象 实战分析：Configuration对象涉及到的配置信息分析</p>
<p><img src="/2021/05/21/Mybatis/mybatis%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/image-20210524181031999.png" srcset="/img/loading.gif" lazyload></p>
<p>简单的理解：MyBatis初始化的过程，就是创建 Confifiguration对象，加载各种配置信息的过程</p>
<h6 id="sql解析"><a href="#sql解析" class="headerlink" title="sql解析"></a>sql解析</h6><p>MyBatis 中的 scripting 模块，会根据用户传入的实参，解析映射文件中定义的动态 SQL 节点，并形成数据库可执行的 SQL 语句。之后会处理 SQL 语句中的占位符，绑定用户传入的实参负责根据用户传递的parameterObject，动态地生成SQL语句，将信息封装到BoundSql对象中，并返回。</p>
<p> SqlSource 接口继承体系</p>
<p><img src="/2021/05/21/Mybatis/mybatis%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/image-20210524181142108.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>各个实现类分析：</strong></p>
<ul>
<li><p>RawSqlSource 负责处理静态 SQL 语句，它们最终会把处理后的 SQL 封装 StaticSqlSource 进行返回。 </p>
</li>
<li><p>StaticSqlSource 处理包含的 SQL 可能含有 “?”占位符，可以被数据库直接执行。 </p>
</li>
<li><p>DynamicSqlSource 负责处理动态 SQL 语句。 </p>
</li>
<li><p>ProviderSqlSource 实现 SqlSource 接口，基于方法上的 <code>@ProviderXXX</code> 注解的 SqlSource 实现类。</p>
</li>
</ul>
<h6 id="SQL执行（Executor）"><a href="#SQL执行（Executor）" class="headerlink" title="SQL执行（Executor）"></a>SQL执行（Executor）</h6><p><strong>概述</strong></p>
<p>对应 executor 模块，是MyBatis执行器，是MyBatis 调度的核心，负责SQL语句的生成和查询缓存的维护。</p>
<p>SQL 语句的执行涉及多个组件 ，其中比较重要的是 Executor、StatementHandler、ParameterHandler 和 ResultSetHandler 。</p>
<p><strong>Executor</strong> 主要负责维护一级缓存和二级缓存，并提供事务管理的相关操作，它会将数据库相关操作委托给 StatementHandler完成。</p>
<p><strong>StatementHandler</strong> 首先通过 <strong>ParameterHandler</strong> 完成 SQL 语句的实参绑定，然后通过java.sql.Statement 对象执行 SQL 语句并得到结果集，最后通过 <strong>ResultSetHandler</strong> 完成结果集的映射，得到结果对象并返回。</p>
<p><img src="/2021/05/21/Mybatis/mybatis%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/image-20210524181306066.png" srcset="/img/loading.gif" lazyload></p>
<h5 id="基础支撑层"><a href="#基础支撑层" class="headerlink" title="基础支撑层"></a>基础支撑层</h5><p>基础支持层，包含整个 MyBatis 的基础模块，这些模块为核心处理层的功能提供了良好的支撑。</p>
<ul>
<li><p><strong>日志</strong>：对应 logging 包，Mybatis提供了详细的日志输出信息，还能够集成多种日志框架，其日志模块的主要功能就是集成第三 方日志框架。 相关设计模式：适配器模式。</p>
</li>
<li><p><strong>缓存机制：</strong>对应 cache 包，包括一级缓存和二级缓存，</p>
<ul>
<li><p>一级缓存：Session或Statement作用域级别的缓存，默认是Session，BaseExecutor中根据MappedStatement的Id、SQL、参数值以及rowBound(边界)来构造CacheKey，并使用BaseExccutor中的localCache来维护此缓存， 默认开启。</p>
</li>
<li><p>二级缓存：全局的二级缓存，通过CacheExecutor来实现，其委托TransactionalCacheManager来保存/获取缓存 </p>
</li>
</ul>
<p>两级缓存与Mybatis以及整个应用是运行在同一个JVM中的，共享同一块内存，如果这两级缓存中的数据量较大，则可能影响系统中其它功能，需要缓存大量数据时，优先考虑使用Redis、Memcache等缓存产品。</p>
</li>
<li><p><strong>数据源/连接池</strong>：对应 datasource 包，Mybatis自身提供了相应的数据源实现，也提供了与第三方数据源集成的接口。 主要实现类是PooledDataSource，包含了最大活动连接数、最大空闲连接数、最长取出时间(避免某 个线程过度占用)、连接不够时的等待时间。 连接池、检测连接状态等，选择性能优秀的数据源组件，对于提供ORM框架以及整个应用的性能都 是非常重要的。</p>
</li>
<li><p><strong>事务管理：</strong>对应 transaction 包，对Java原生的反射进行了很好的封装，提供了简易的API，方便上层调用，并且对反射操作进行了一系 列的优化，提高了反射操作的性能。 进行了类的元数据（MetaClass） ， 对象的元数据（MetaObject）的缓存。</p>
</li>
<li><p><strong>IO</strong> <strong>模块</strong>：对应 io 包，资源加载模块，主要是对类加载器进行封装，确定类加载器的使用顺序，并提供了加载类文件以及其他资源文件的功能 。</p>
</li>
<li><p><strong>解析器：</strong> 对应 parsing 包解析器模块，主要提供了两个功能: </p>
<ul>
<li>对 XPath 进行封装，为 MyBatis 初始化时解析 mybatis-config.xml 配置文件以及映射配置文件提供支持。 为处理动态 SQL 语句中的占位符提供支持。</li>
</ul>
</li>
</ul>
<h4 id="核心配置文件解析原理"><a href="#核心配置文件解析原理" class="headerlink" title="核心配置文件解析原理"></a>核心配置文件解析原理</h4><p>在 MyBatis 初始化过程中，会加载 mybatis-config.xml 配置文件、映射配置文件以及 Mapper 接口中的注解信息，解析后的配置信息会形成相应的对象并保存到 Configuration 对象中</p>
<p>通过资源类Resources读入“SqlMapConfifig.xml”文件 使用SqlSessionFactoryBuilder类生成我们需要的SqlSessionFactory类。 </p>
<p>mybatis解析配置文件最本质的目的是为了获得Configuration对象;然后，利用该 Configuration 对象创建 SqlSessionFactory对象。待 MyBatis 初始化之后，可以通过初始化得到 SqlSessionFactory 创建 SqlSession 对象并完成数据库操作。</p>
<h5 id="XML-解析流程"><a href="#XML-解析流程" class="headerlink" title="XML 解析流程"></a>XML 解析流程</h5><h6 id="入口"><a href="#入口" class="headerlink" title="入口"></a>入口</h6><p>MyBatis 的初始化流程的入口是 SqlSessionFactoryBuilder 的 build 方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 构造 SqlSessionFactory 对象</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> reader      Reader 对象</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> environment 环境</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> properties  Properties 变量</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> SqlSessionFactory 对象</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> SqlSessionFactory <span class="hljs-title">build</span><span class="hljs-params">(Reader reader, String environment, Properties properties)</span> </span>&#123;<br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-comment">// &lt;1&gt; 创建 XMLConfigBuilder 对象</span><br>    XMLConfigBuilder parser = <span class="hljs-keyword">new</span> XMLConfigBuilder(reader, environment, properties);<br>    <span class="hljs-comment">// &lt;2&gt; 执行 XML 解析</span><br>    <span class="hljs-comment">// &lt;3&gt; 创建 DefaultSqlSessionFactory 对象</span><br>    <span class="hljs-keyword">return</span> build(parser.parse());<br>  &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>    <span class="hljs-keyword">throw</span> ExceptionFactory.wrapException(<span class="hljs-string">&quot;Error building SqlSession.&quot;</span>, e);<br>  &#125; <span class="hljs-keyword">finally</span> &#123;<br>    ErrorContext.instance().reset();<br>    <span class="hljs-keyword">try</span> &#123;<br>      reader.close();<br>    &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>      <span class="hljs-comment">// Intentionally ignore. Prefer previous error.</span><br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p> <strong>XMLConfigBuilder</strong></p>
<p>org.apache.ibatis.builder.xml.XMLConfigBuilder ，继承 BaseBuilder 抽象类，XML 配置构建器，主要负责解析mybatis-confifig.xml 配置文件，部分代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">XMLConfigBuilder</span><span class="hljs-params">(InputStream inputStream, String environment, Properties props)</span> </span>&#123;<br>  <span class="hljs-keyword">this</span>(<span class="hljs-keyword">new</span> XPathParser(inputStream, <span class="hljs-keyword">true</span>, props, <span class="hljs-keyword">new</span> XMLMapperEntityResolver()), environment, props);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">XMLConfigBuilder</span><span class="hljs-params">(XPathParser parser, String environment, Properties props)</span> </span>&#123;<br>  <span class="hljs-comment">// &lt;1&gt; 创建 Configuration 对象</span><br>  <span class="hljs-keyword">super</span>(<span class="hljs-keyword">new</span> Configuration());<br>  ErrorContext.instance().resource(<span class="hljs-string">&quot;SQL Mapper Configuration&quot;</span>);<br>  <span class="hljs-comment">// &lt;2&gt; 设置 Configuration 的 variables 属性</span><br>  <span class="hljs-keyword">this</span>.configuration.setVariables(props);<br>  <span class="hljs-keyword">this</span>.parsed = <span class="hljs-keyword">false</span>;<br>  <span class="hljs-keyword">this</span>.environment = environment;<br>  <span class="hljs-keyword">this</span>.parser = parser;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> Configuration <span class="hljs-title">parse</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-comment">// &lt;1.1&gt; 若已解析，抛出 BuilderException 异常</span><br>  <span class="hljs-keyword">if</span> (parsed) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BuilderException(<span class="hljs-string">&quot;Each XMLConfigBuilder can only be used once.&quot;</span>);<br>  &#125;<br>  <span class="hljs-comment">// &lt;1.2&gt; 标记已解析</span><br>  parsed = <span class="hljs-keyword">true</span>;<br>  <span class="hljs-comment">// &lt;2&gt; 解析 XML configuration 节点</span><br>  parseConfiguration(parser.evalNode(<span class="hljs-string">&quot;/configuration&quot;</span>));<br>  <span class="hljs-keyword">return</span> configuration;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">parseConfiguration</span><span class="hljs-params">(XNode root)</span> </span>&#123;<br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-comment">// issue #117 read properties first</span><br>    <span class="hljs-comment">// &lt;1&gt; 解析 &lt;properties /&gt; 标签</span><br>    propertiesElement(root.evalNode(<span class="hljs-string">&quot;properties&quot;</span>));<br>    <span class="hljs-comment">// &lt;2&gt; 解析 &lt;settings /&gt; 标签</span><br>    Properties settings = settingsAsProperties(root.evalNode(<span class="hljs-string">&quot;settings&quot;</span>));<br>    <span class="hljs-comment">// &lt;3&gt; 加载自定义 VFS 实现类</span><br>    loadCustomVfs(settings);<br>    loadCustomLogImpl(settings);<br>    <span class="hljs-comment">// &lt;4&gt; 解析 &lt;typeAliases /&gt; 标签</span><br>    typeAliasesElement(root.evalNode(<span class="hljs-string">&quot;typeAliases&quot;</span>));<br>    <span class="hljs-comment">// &lt;5&gt; 解析 &lt;plugins /&gt; 标签</span><br>    pluginElement(root.evalNode(<span class="hljs-string">&quot;plugins&quot;</span>));<br>    <span class="hljs-comment">// &lt;6&gt; 解析 &lt;objectFactory /&gt; 标签</span><br>    objectFactoryElement(root.evalNode(<span class="hljs-string">&quot;objectFactory&quot;</span>));<br>    <span class="hljs-comment">// &lt;7&gt; 解析 &lt;objectWrapperFactory /&gt; 标签</span><br>    objectWrapperFactoryElement(root.evalNode(<span class="hljs-string">&quot;objectWrapperFactory&quot;</span>));<br>    <span class="hljs-comment">// &lt;8&gt; 解析 &lt;reflectorFactory /&gt; 标签</span><br>    reflectorFactoryElement(root.evalNode(<span class="hljs-string">&quot;reflectorFactory&quot;</span>));<br>    <span class="hljs-comment">// &lt;9&gt; 赋值 &lt;settings /&gt; 到 Configuration 属性</span><br>    settingsElement(settings);<br>    <span class="hljs-comment">// read it after objectFactory and objectWrapperFactory issue #631</span><br>    <span class="hljs-comment">// &lt;10&gt; 解析 &lt;environments /&gt; 标签</span><br>    environmentsElement(root.evalNode(<span class="hljs-string">&quot;environments&quot;</span>));<br>    <span class="hljs-comment">// &lt;11&gt; 解析 &lt;databaseIdProvider /&gt; 标签</span><br>    databaseIdProviderElement(root.evalNode(<span class="hljs-string">&quot;databaseIdProvider&quot;</span>));<br>    <span class="hljs-comment">// &lt;12&gt; 解析 &lt;typeHandlers /&gt; 标签</span><br>    typeHandlerElement(root.evalNode(<span class="hljs-string">&quot;typeHandlers&quot;</span>));<br>    <span class="hljs-comment">// &lt;13&gt; 解析 &lt;mappers /&gt; 标签</span><br>    mapperElement(root.evalNode(<span class="hljs-string">&quot;mappers&quot;</span>));<br>  &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BuilderException(<span class="hljs-string">&quot;Error parsing SQL Mapper Configuration. Cause: &quot;</span> + e, e);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>new Configuration()</strong></p>
<p>配置文件解析的本质就是获得Configuration对象，很多成员变量需要根据 XML 配置文件解析后来赋值</p>
<p><strong>parser.parse()</strong></p>
<p>该函数就是XML解析的核心，解析全局配置文件，调用parse.evalNode()方法，将指定路径的config配置文件转换为XNode对象 调用parseConfiguration()方法逐步解析配置文件中的各个节点</p>
<p><strong>build(configuration)</strong></p>
<p>该函数用来创建一个具体的SqlSessionFactory对象。 创建DefaultSqlSessionFactory对象， 并将configuration赋值给相应的成员变量</p>
<h5 id="核心解析逻辑"><a href="#核心解析逻辑" class="headerlink" title="核心解析逻辑"></a>核心解析逻辑</h5><p><strong>XMLConfigBuilder</strong>的构造函数中会创建org.apache.ibatis.parsing.XPathParser 对象，XPathParser是基于 JavaXPath 解析器，用于解析 MyBatis mybatis- config.xml 和 **Mapper.xml 等 XML 配置文件。属性如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">XPathParser</span> </span>&#123;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * XML Document 对象</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Document document;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 是否校验</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> validation;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * XML 实体解析器</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">private</span> EntityResolver entityResolver;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 变量 Properties 对象</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">private</span> Properties variables;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Java XPath 对象</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">private</span> XPath xpath;<br>  <br>  <span class="hljs-comment">// ... 省略部分代码</span><br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 构造 XPathParser 对象</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> xml            XML 文件地址</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> validation     是否校验 XML</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> variables      变量 Properties 对象</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> entityResolver XML 实体解析器</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">XPathParser</span><span class="hljs-params">(String xml, <span class="hljs-keyword">boolean</span> validation, Properties variables, EntityResolver entityResolver)</span> </span>&#123;<br>    commonConstructor(validation, variables, entityResolver);<br>    <span class="hljs-keyword">this</span>.document = createDocument(<span class="hljs-keyword">new</span> InputSource(<span class="hljs-keyword">new</span> StringReader(xml)));<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 创建 Document 对象 ---&gt;将 XML 文件解析成 Document 对象</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> inputSource XML 的 InputSource 对象</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> Document 对象</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-function"><span class="hljs-keyword">private</span> Document <span class="hljs-title">createDocument</span><span class="hljs-params">(InputSource inputSource)</span> </span>&#123;<br>    <span class="hljs-comment">// important: this must only be called AFTER common constructor</span><br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// 1&gt; 创建 DocumentBuilderFactory 对象</span><br>      DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();<br>      factory.setFeature(XMLConstants.FEATURE_SECURE_PROCESSING, <span class="hljs-keyword">true</span>);<br>      <span class="hljs-comment">// 设置是否验证 XML</span><br>      factory.setValidating(validation);<br><br>      factory.setNamespaceAware(<span class="hljs-keyword">false</span>);<br>      factory.setIgnoringComments(<span class="hljs-keyword">true</span>);<br>      factory.setIgnoringElementContentWhitespace(<span class="hljs-keyword">false</span>);<br>      factory.setCoalescing(<span class="hljs-keyword">false</span>);<br>      factory.setExpandEntityReferences(<span class="hljs-keyword">true</span>);<br><br>      <span class="hljs-comment">// 2&gt; 创建 DocumentBuilder 对象</span><br>      DocumentBuilder builder = factory.newDocumentBuilder();<br>      <span class="hljs-comment">// 设置实体解析器</span><br>      builder.setEntityResolver(entityResolver);<br>      builder.setErrorHandler(<span class="hljs-keyword">new</span> ErrorHandler() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">error</span><span class="hljs-params">(SAXParseException exception)</span> <span class="hljs-keyword">throws</span> SAXException </span>&#123;<br>          <span class="hljs-keyword">throw</span> exception;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">fatalError</span><span class="hljs-params">(SAXParseException exception)</span> <span class="hljs-keyword">throws</span> SAXException </span>&#123;<br>          <span class="hljs-keyword">throw</span> exception;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">warning</span><span class="hljs-params">(SAXParseException exception)</span> <span class="hljs-keyword">throws</span> SAXException </span>&#123;<br>          <span class="hljs-comment">// NOP</span><br>        &#125;<br>      &#125;);<br>      <span class="hljs-comment">// 3&gt; 解析 XML 文件</span><br>      <span class="hljs-keyword">return</span> builder.parse(inputSource);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BuilderException(<span class="hljs-string">&quot;Error creating document instance.  Cause: &quot;</span> + e, e);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 公用的构造方法逻辑</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">commonConstructor</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> validation, Properties variables, EntityResolver entityResolver)</span> </span>&#123;<br>    <span class="hljs-keyword">this</span>.validation = validation;<br>    <span class="hljs-keyword">this</span>.entityResolver = entityResolver;<br>    <span class="hljs-keyword">this</span>.variables = variables;<br>    <span class="hljs-comment">// 创建 XPathFactory 对象</span><br>    XPathFactory factory = XPathFactory.newInstance();<br>    <span class="hljs-keyword">this</span>.xpath = factory.newXPath();<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>在创建XPathParser时，会进行org.apache.ibatis.builder.xml.XMLMapperEntityResolver 的创建，XMLMapperEntityResolver实现 了EntityResolver 接口，用于加载本地的 mybatis-3-config.dtd 和 mybatis-3- mapper.dtd 这两个 DTD 文件。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">XMLMapperEntityResolver</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">EntityResolver</span> </span>&#123;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String IBATIS_CONFIG_SYSTEM = <span class="hljs-string">&quot;ibatis-3-config.dtd&quot;</span>;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String IBATIS_MAPPER_SYSTEM = <span class="hljs-string">&quot;ibatis-3-mapper.dtd&quot;</span>;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String MYBATIS_CONFIG_SYSTEM = <span class="hljs-string">&quot;mybatis-3-config.dtd&quot;</span>;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String MYBATIS_MAPPER_SYSTEM = <span class="hljs-string">&quot;mybatis-3-mapper.dtd&quot;</span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 本地 mybatis-config.dtd 文件</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String MYBATIS_CONFIG_DTD = <span class="hljs-string">&quot;org/apache/ibatis/builder/xml/mybatis-3-config.dtd&quot;</span>;<br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 本地 mybatis-mapper.dtd 文件</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String MYBATIS_MAPPER_DTD = <span class="hljs-string">&quot;org/apache/ibatis/builder/xml/mybatis-3-mapper.dtd&quot;</span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Converts a public DTD into a local one.</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> publicId The public id that is what comes after &quot;PUBLIC&quot;</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> systemId The system id that is what comes after the public id.</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> The InputSource for the DTD</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@throws</span> org.xml.sax.SAXException If anything goes wrong</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> InputSource <span class="hljs-title">resolveEntity</span><span class="hljs-params">(String publicId, String systemId)</span> <span class="hljs-keyword">throws</span> SAXException </span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">if</span> (systemId != <span class="hljs-keyword">null</span>) &#123;<br>        String lowerCaseSystemId = systemId.toLowerCase(Locale.ENGLISH);<br>        <span class="hljs-comment">// 本地 mybatis-config.dtd 文件</span><br>        <span class="hljs-keyword">if</span> (lowerCaseSystemId.contains(MYBATIS_CONFIG_SYSTEM) || lowerCaseSystemId.contains(IBATIS_CONFIG_SYSTEM)) &#123;<br>          <span class="hljs-keyword">return</span> getInputSource(MYBATIS_CONFIG_DTD, publicId, systemId);<br>          <span class="hljs-comment">// 本地 mybatis-mapper.dtd 文件</span><br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (lowerCaseSystemId.contains(MYBATIS_MAPPER_SYSTEM) || lowerCaseSystemId.contains(IBATIS_MAPPER_SYSTEM)) &#123;<br>          <span class="hljs-keyword">return</span> getInputSource(MYBATIS_MAPPER_DTD, publicId, systemId);<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> SAXException(e.toString());<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-keyword">private</span> InputSource <span class="hljs-title">getInputSource</span><span class="hljs-params">(String path, String publicId, String systemId)</span> </span>&#123;<br>    InputSource source = <span class="hljs-keyword">null</span>;<br>    <span class="hljs-keyword">if</span> (path != <span class="hljs-keyword">null</span>) &#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// 创建 InputSource 对象</span><br>        InputStream in = Resources.getResourceAsStream(path);<br>        source = <span class="hljs-keyword">new</span> InputSource(in);<br>        <span class="hljs-comment">// 设置 publicId、systemId 属性</span><br>        source.setPublicId(publicId);<br>        source.setSystemId(systemId);<br>      &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>        <span class="hljs-comment">// ignore, null is ok</span><br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> source;<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="mapper映射文件解析原理"><a href="#mapper映射文件解析原理" class="headerlink" title="mapper映射文件解析原理"></a>mapper映射文件解析原理</h4><p>其实XMLConfigBuilder在parseConfiguration()方法中解析核心配置文件中mappers节点时，会调用mapperElement()方法，创建XMLMapperBuilder()对象进一步解析mapper映射文件。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">mapperElement</span><span class="hljs-params">(XNode parent)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>  <span class="hljs-keyword">if</span> (parent != <span class="hljs-keyword">null</span>) &#123;<br>    <span class="hljs-keyword">for</span> (XNode child : parent.getChildren()) &#123;<br>      <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;package&quot;</span>.equals(child.getName())) &#123;<br>        String mapperPackage = child.getStringAttribute(<span class="hljs-string">&quot;name&quot;</span>);<br>        configuration.addMappers(mapperPackage);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        String resource = child.getStringAttribute(<span class="hljs-string">&quot;resource&quot;</span>);<br>        String url = child.getStringAttribute(<span class="hljs-string">&quot;url&quot;</span>);<br>        String mapperClass = child.getStringAttribute(<span class="hljs-string">&quot;class&quot;</span>);<br>        <span class="hljs-keyword">if</span> (resource != <span class="hljs-keyword">null</span> &amp;&amp; url == <span class="hljs-keyword">null</span> &amp;&amp; mapperClass == <span class="hljs-keyword">null</span>) &#123;<br>          ErrorContext.instance().resource(resource);<br>          InputStream inputStream = Resources.getResourceAsStream(resource);<br>          XMLMapperBuilder mapperParser = <span class="hljs-keyword">new</span> XMLMapperBuilder(inputStream, configuration, resource, configuration.getSqlFragments());<br>          mapperParser.parse();<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (resource == <span class="hljs-keyword">null</span> &amp;&amp; url != <span class="hljs-keyword">null</span> &amp;&amp; mapperClass == <span class="hljs-keyword">null</span>) &#123;<br>          ErrorContext.instance().resource(url);<br>          InputStream inputStream = Resources.getUrlAsStream(url);<br>          XMLMapperBuilder mapperParser = <span class="hljs-keyword">new</span> XMLMapperBuilder(inputStream, configuration, url, configuration.getSqlFragments());<br>          mapperParser.parse();<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (resource == <span class="hljs-keyword">null</span> &amp;&amp; url == <span class="hljs-keyword">null</span> &amp;&amp; mapperClass != <span class="hljs-keyword">null</span>) &#123;<br>          Class&lt;?&gt; mapperInterface = Resources.classForName(mapperClass);<br>          configuration.addMapper(mapperInterface);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BuilderException(<span class="hljs-string">&quot;A mapper element may only specify a url, resource or class, but not more than one.&quot;</span>);<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="XMLMapperBuilder"><a href="#XMLMapperBuilder" class="headerlink" title="XMLMapperBuilder"></a>XMLMapperBuilder</h5><p>org.apache.ibatis.builder.xml.XMLMapperBuilder ，继承 BaseBuilder 抽象类，Mapper XML 配置构建器，主要负责解析 Mapper 映射配置文件。</p>
<p>当在配置文件中配置package后，会遍历该包下所有的类，指定mapper文件的路径resource/url/class ，具体解析逻辑通过XMLMapperBuilder类来完成，解析xml文件中的&lt;mapper&gt;节点 </p>
<p>parse() 方法，解析 Mapper XML 配置文件。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">parse</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-comment">// &lt;1&gt; 判断当前 Mapper 是否已经加载过</span><br>  <span class="hljs-keyword">if</span> (!configuration.isResourceLoaded(resource)) &#123;<br>    <span class="hljs-comment">// &lt;2&gt; 解析 `&lt;mapper /&gt;` 节点</span><br>    configurationElement(parser.evalNode(<span class="hljs-string">&quot;/mapper&quot;</span>));<br>    <span class="hljs-comment">// &lt;3&gt; 标记该 Mapper 已经加载过</span><br>    configuration.addLoadedResource(resource);<br>    <span class="hljs-comment">// &lt;4&gt; 绑定 Mapper</span><br>    bindMapperForNamespace();<br>  &#125;<br>  <span class="hljs-comment">// &lt;5&gt; 解析待定的 &lt;resultMap /&gt; 节点</span><br>  parsePendingResultMaps();<br>  <span class="hljs-comment">// &lt;6&gt; 解析待定的 &lt;cache-ref /&gt; 节点</span><br>  parsePendingCacheRefs();<br>  <span class="hljs-comment">// &lt;7&gt; 解析待定的 SQL 语句的节点</span><br>  parsePendingStatements();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>configurationElement(XNode context) 方法，解析 &lt;mapper /&gt; 节点。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configurationElement</span><span class="hljs-params">(XNode context)</span> </span>&#123;<br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-comment">// &lt;1&gt; 获得 namespace 属性</span><br>    String namespace = context.getStringAttribute(<span class="hljs-string">&quot;namespace&quot;</span>);<br>    <span class="hljs-keyword">if</span> (namespace == <span class="hljs-keyword">null</span> || namespace.isEmpty()) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BuilderException(<span class="hljs-string">&quot;Mapper&#x27;s namespace cannot be empty&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">// &lt;1&gt; 设置 namespace 属性</span><br>    builderAssistant.setCurrentNamespace(namespace);<br>    <span class="hljs-comment">// &lt;2&gt; 解析 &lt;cache-ref /&gt; 节点</span><br>    cacheRefElement(context.evalNode(<span class="hljs-string">&quot;cache-ref&quot;</span>));<br>    <span class="hljs-comment">// &lt;3&gt; 解析 &lt;cache /&gt; 节点</span><br>    cacheElement(context.evalNode(<span class="hljs-string">&quot;cache&quot;</span>));<br>    <span class="hljs-comment">// 已废弃！老式风格的参数映射。内联参数是首选,这个元素可能在将来被移除，这里不会记录。</span><br>    parameterMapElement(context.evalNodes(<span class="hljs-string">&quot;/mapper/parameterMap&quot;</span>));<br>    <span class="hljs-comment">// &lt;4&gt; 解析 &lt;resultMap /&gt; 节点</span><br>    resultMapElements(context.evalNodes(<span class="hljs-string">&quot;/mapper/resultMap&quot;</span>));<br>    <span class="hljs-comment">// &lt;5&gt; 解析 &lt;sql /&gt; 节点</span><br>    sqlElement(context.evalNodes(<span class="hljs-string">&quot;/mapper/sql&quot;</span>));<br>    <span class="hljs-comment">// &lt;6&gt; 解析 &lt;select /&gt; &lt;insert /&gt; &lt;update /&gt; &lt;delete /&gt; 节点</span><br>    buildStatementFromContext(context.evalNodes(<span class="hljs-string">&quot;select|insert|update|delete&quot;</span>));<br>  &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BuilderException(<span class="hljs-string">&quot;Error parsing Mapper XML. The XML location is &#x27;&quot;</span> + resource + <span class="hljs-string">&quot;&#x27;. Cause: &quot;</span> + e, e);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>cacheRefElement(XNode context) 方法，解析 &lt;cache-ref /&gt; 节点。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">cacheRefElement</span><span class="hljs-params">(XNode context)</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (context != <span class="hljs-keyword">null</span>) &#123;<br>    <span class="hljs-comment">// &lt;1&gt; 获得指向的 namespace 名字，并添加到 configuration 的 cacheRefMap 中</span><br>    configuration.addCacheRef(builderAssistant.getCurrentNamespace(), context.getStringAttribute(<span class="hljs-string">&quot;namespace&quot;</span>));<br>    <span class="hljs-comment">// &lt;2&gt; 创建 CacheRefResolver 对象，并执行解析</span><br>    CacheRefResolver cacheRefResolver = <span class="hljs-keyword">new</span> CacheRefResolver(builderAssistant, context.getStringAttribute(<span class="hljs-string">&quot;namespace&quot;</span>));<br>    <span class="hljs-keyword">try</span> &#123;<br>      cacheRefResolver.resolveCacheRef();<br>    &#125; <span class="hljs-keyword">catch</span> (IncompleteElementException e) &#123;<br>      <span class="hljs-comment">// &lt;3&gt; 解析失败，添加到 configuration 的 incompleteCacheRefs 中</span><br>      configuration.addIncompleteCacheRef(cacheRefResolver);<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>cacheElement(XNode context) 方法，解析 cache /&gt; 标签。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">cacheElement</span><span class="hljs-params">(XNode context)</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (context != <span class="hljs-keyword">null</span>) &#123;<br>    <span class="hljs-comment">// &lt;1&gt; 获得负责存储的 Cache 实现类</span><br>    String type = context.getStringAttribute(<span class="hljs-string">&quot;type&quot;</span>, <span class="hljs-string">&quot;PERPETUAL&quot;</span>);<br>    Class&lt;? extends Cache&gt; typeClass = typeAliasRegistry.resolveAlias(type);<br>    <span class="hljs-comment">// &lt;2&gt; 获得负责过期的 Cache 实现类</span><br>    String eviction = context.getStringAttribute(<span class="hljs-string">&quot;eviction&quot;</span>, <span class="hljs-string">&quot;LRU&quot;</span>);<br>    Class&lt;? extends Cache&gt; evictionClass = typeAliasRegistry.resolveAlias(eviction);<br>    <span class="hljs-comment">// &lt;3&gt; 获得 flushInterval、size、readWrite、blocking 属性</span><br>    Long flushInterval = context.getLongAttribute(<span class="hljs-string">&quot;flushInterval&quot;</span>);<br>    Integer size = context.getIntAttribute(<span class="hljs-string">&quot;size&quot;</span>);<br>    <span class="hljs-keyword">boolean</span> readWrite = !context.getBooleanAttribute(<span class="hljs-string">&quot;readOnly&quot;</span>, <span class="hljs-keyword">false</span>);<br>    <span class="hljs-keyword">boolean</span> blocking = context.getBooleanAttribute(<span class="hljs-string">&quot;blocking&quot;</span>, <span class="hljs-keyword">false</span>);<br>    <span class="hljs-comment">// &lt;4&gt; 获得 Properties 属性</span><br>    Properties props = context.getChildrenAsProperties();<br>    <span class="hljs-comment">// &lt;5&gt; 创建 Cache 对象</span><br>    builderAssistant.useNewCache(typeClass, evictionClass, flushInterval, size, readWrite, blocking, props);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>resultMapElements(List&lt;XNode&gt; list) 方法，解析 &lt;resultMap /&gt; 节点们。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> ResultMap <span class="hljs-title">resultMapElement</span><span class="hljs-params">(XNode resultMapNode, List&lt;ResultMapping&gt; additionalResultMappings, Class&lt;?&gt; enclosingType)</span> </span>&#123;<br>  ErrorContext.instance().activity(<span class="hljs-string">&quot;processing &quot;</span> + resultMapNode.getValueBasedIdentifier());<br>  <span class="hljs-comment">// &lt;1&gt; 获得 type 属性</span><br>  String type = resultMapNode.getStringAttribute(<span class="hljs-string">&quot;type&quot;</span>,<br>      resultMapNode.getStringAttribute(<span class="hljs-string">&quot;ofType&quot;</span>,<br>          resultMapNode.getStringAttribute(<span class="hljs-string">&quot;resultType&quot;</span>,<br>              resultMapNode.getStringAttribute(<span class="hljs-string">&quot;javaType&quot;</span>))));<br>  <span class="hljs-comment">// &lt;2&gt; 解析 type 对应的类</span><br>  Class&lt;?&gt; typeClass = resolveClass(type);<br>  <span class="hljs-keyword">if</span> (typeClass == <span class="hljs-keyword">null</span>) &#123;<br>    typeClass = inheritEnclosingType(resultMapNode, enclosingType);<br>  &#125;<br>  Discriminator discriminator = <span class="hljs-keyword">null</span>;<br>  <span class="hljs-comment">// &lt;3&gt; 创建 ResultMapping 集合</span><br>  List&lt;ResultMapping&gt; resultMappings = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;(additionalResultMappings);<br>  <span class="hljs-comment">// &lt;4&gt; 遍历 &lt;resultMap /&gt; 的子节点</span><br>  List&lt;XNode&gt; resultChildren = resultMapNode.getChildren();<br>  <span class="hljs-keyword">for</span> (XNode resultChild : resultChildren) &#123;<br>    <span class="hljs-comment">// &lt;4.1&gt; 处理 &lt;constructor /&gt; 节点</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;constructor&quot;</span>.equals(resultChild.getName())) &#123;<br>      processConstructorElement(resultChild, typeClass, resultMappings);<br>    <span class="hljs-comment">// &lt;4.2&gt; 处理 &lt;discriminator /&gt; 节点</span><br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;discriminator&quot;</span>.equals(resultChild.getName())) &#123;<br>      discriminator = processDiscriminatorElement(resultChild, typeClass, resultMappings);<br>    <span class="hljs-comment">// &lt;4.3&gt; 处理其它节点</span><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      List&lt;ResultFlag&gt; flags = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>      <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;id&quot;</span>.equals(resultChild.getName())) &#123;<br>        flags.add(ResultFlag.ID);<br>      &#125;<br>      resultMappings.add(buildResultMappingFromContext(resultChild, typeClass, flags));<br>    &#125;<br>  &#125;<br>  <span class="hljs-comment">// &lt;5&gt; 获得 id 属性</span><br>  String id = resultMapNode.getStringAttribute(<span class="hljs-string">&quot;id&quot;</span>,<br>          resultMapNode.getValueBasedIdentifier());<br>  <span class="hljs-comment">// &lt;6&gt; 获得 extends 属性</span><br>  String extend = resultMapNode.getStringAttribute(<span class="hljs-string">&quot;extends&quot;</span>);<br>  <span class="hljs-comment">// &lt;7&gt; 获得 autoMapping 属性</span><br>  Boolean autoMapping = resultMapNode.getBooleanAttribute(<span class="hljs-string">&quot;autoMapping&quot;</span>);<br>  <span class="hljs-comment">// &lt;8&gt; 创建 ResultMapResolver 对象，执行解析</span><br>  ResultMapResolver resultMapResolver = <span class="hljs-keyword">new</span> ResultMapResolver(builderAssistant, id, typeClass, extend, discriminator, resultMappings, autoMapping);<br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-keyword">return</span> resultMapResolver.resolve();<br>  &#125; <span class="hljs-keyword">catch</span> (IncompleteElementException e) &#123;<br>    <span class="hljs-comment">// &lt;9&gt; 解析失败，添加到 configuration 中</span><br>    configuration.addIncompleteResultMap(resultMapResolver);<br>    <span class="hljs-keyword">throw</span> e;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>buildStatementFromContext(List&lt;XNode&gt; list) 方法，解析 &lt;select /&gt; 、 &lt;insert /&gt; 、 &lt;update /&gt; 、 &lt;delete /&gt; 节点们。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">buildStatementFromContext</span><span class="hljs-params">(List&lt;XNode&gt; list, String requiredDatabaseId)</span> </span>&#123;<br>  <span class="hljs-comment">// &lt;1&gt; 遍历 &lt;select /&gt; &lt;insert /&gt; &lt;update /&gt; &lt;delete /&gt; 节点</span><br>  <span class="hljs-keyword">for</span> (XNode context : list) &#123;<br>    <span class="hljs-comment">// &lt;1&gt; 创建 XMLStatementBuilder 对象，执行解析 ===================&gt;</span><br>    <span class="hljs-keyword">final</span> XMLStatementBuilder statementParser = <span class="hljs-keyword">new</span> XMLStatementBuilder(configuration, builderAssistant, context, requiredDatabaseId);<br>    <span class="hljs-keyword">try</span> &#123;<br>      statementParser.parseStatementNode();<br>    &#125; <span class="hljs-keyword">catch</span> (IncompleteElementException e) &#123;<br>      <span class="hljs-comment">// &lt;2&gt; 解析失败，添加到 configuration 中</span><br>      configuration.addIncompleteStatement(statementParser);<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="XMLStatementBuilder"><a href="#XMLStatementBuilder" class="headerlink" title="XMLStatementBuilder"></a>XMLStatementBuilder</h5><p>解析mapper.xml文件中的crud节点，org.apache.ibatis.builder.xml.XMLStatementBuilder ，继承 BaseBuilder 抽象类，Statement XML 配置构建器，主要负责解析 Statement 配置，即 &lt;select /&gt; 、 &lt;insert /&gt; 、 </p>
<p>&lt;update /&gt; 、 &lt;delete /&gt; 标签。</p>
<p>开启SQL节点解析，源码开始解析的入口parseStatementNode</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">parseStatementNode</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-comment">// &lt;1&gt; 获得 id 属性，编号</span><br>  String id = context.getStringAttribute(<span class="hljs-string">&quot;id&quot;</span>);<br>  <span class="hljs-comment">// &lt;2&gt; 获得 databaseId ， 判断 databaseId 是否匹配</span><br>  String databaseId = context.getStringAttribute(<span class="hljs-string">&quot;databaseId&quot;</span>);<br>  <span class="hljs-keyword">if</span> (!databaseIdMatchesCurrent(id, databaseId, <span class="hljs-keyword">this</span>.requiredDatabaseId)) &#123;<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br><br>  <span class="hljs-comment">// &lt;3&gt; 获得 SQL 对应的 SqlCommandType 枚举值</span><br>  String nodeName = context.getNode().getNodeName();<br>  SqlCommandType sqlCommandType = SqlCommandType.valueOf(nodeName.toUpperCase(Locale.ENGLISH));<br>  <span class="hljs-comment">// &lt;4&gt; 获得各种属性</span><br>  <span class="hljs-keyword">boolean</span> isSelect = sqlCommandType == SqlCommandType.SELECT;<br>  <span class="hljs-keyword">boolean</span> flushCache = context.getBooleanAttribute(<span class="hljs-string">&quot;flushCache&quot;</span>, !isSelect);<br>  <span class="hljs-keyword">boolean</span> useCache = context.getBooleanAttribute(<span class="hljs-string">&quot;useCache&quot;</span>, isSelect);<br>  <span class="hljs-keyword">boolean</span> resultOrdered = context.getBooleanAttribute(<span class="hljs-string">&quot;resultOrdered&quot;</span>, <span class="hljs-keyword">false</span>);<br><br>  <span class="hljs-comment">// Include Fragments before parsing</span><br>  <span class="hljs-comment">// &lt;5&gt; 创建 XMLIncludeTransformer 对象，并替换 &lt;include /&gt; 标签相关的内容</span><br>  XMLIncludeTransformer includeParser = <span class="hljs-keyword">new</span> XMLIncludeTransformer(configuration, builderAssistant);<br>  includeParser.applyIncludes(context.getNode());<br><br>  String parameterType = context.getStringAttribute(<span class="hljs-string">&quot;parameterType&quot;</span>);<br>  Class&lt;?&gt; parameterTypeClass = resolveClass(parameterType);<br><br>  <span class="hljs-comment">// &lt;6&gt; 获得 lang 对应的 LanguageDriver 对象</span><br>  String lang = context.getStringAttribute(<span class="hljs-string">&quot;lang&quot;</span>);<br>  LanguageDriver langDriver = getLanguageDriver(lang);<br><br>  <span class="hljs-comment">// Parse selectKey after includes and remove them.</span><br>  <span class="hljs-comment">// &lt;7&gt; 解析 &lt;selectKey /&gt; 标签</span><br>  processSelectKeyNodes(id, parameterTypeClass, langDriver);<br><br><br>  <span class="hljs-comment">// Parse the SQL (pre: &lt;selectKey&gt; and &lt;include&gt; were parsed and removed)</span><br>  <span class="hljs-comment">// &lt;8&gt; 获得 KeyGenerator 对象</span><br>  KeyGenerator keyGenerator;<br>  <span class="hljs-comment">// &lt;8.1&gt; 优先，从 configuration 中获得 KeyGenerator 对象。如果存在，意味着是 &lt;selectKey /&gt; 标签配置的</span><br>  String keyStatementId = id + SelectKeyGenerator.SELECT_KEY_SUFFIX;<br>  keyStatementId = builderAssistant.applyCurrentNamespace(keyStatementId, <span class="hljs-keyword">true</span>);<br>  <span class="hljs-keyword">if</span> (configuration.hasKeyGenerator(keyStatementId)) &#123;<br>    keyGenerator = configuration.getKeyGenerator(keyStatementId);<br>  <span class="hljs-comment">// &lt;8.2&gt; 其次，根据标签属性的情况，判断是否使用对应的 Jdbc3KeyGenerator 或者 NoKeyGenerator 对象</span><br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    keyGenerator = context.getBooleanAttribute(<span class="hljs-string">&quot;useGeneratedKeys&quot;</span>,<br>        configuration.isUseGeneratedKeys() &amp;&amp; SqlCommandType.INSERT.equals(sqlCommandType))<br>        ? Jdbc3KeyGenerator.INSTANCE : NoKeyGenerator.INSTANCE;<br>  &#125;<br>  <span class="hljs-comment">// &lt;9&gt; 创建 SqlSource</span><br>  SqlSource sqlSource = langDriver.createSqlSource(configuration, context, parameterTypeClass);<br>  StatementType statementType = StatementType.valueOf(context.getStringAttribute(<span class="hljs-string">&quot;statementType&quot;</span>, StatementType.PREPARED.toString()));<br>  <span class="hljs-comment">// &lt;10&gt; 获得各种属性</span><br>  Integer fetchSize = context.getIntAttribute(<span class="hljs-string">&quot;fetchSize&quot;</span>);<br>  Integer timeout = context.getIntAttribute(<span class="hljs-string">&quot;timeout&quot;</span>);<br>  String parameterMap = context.getStringAttribute(<span class="hljs-string">&quot;parameterMap&quot;</span>);<br>  <span class="hljs-comment">// &lt;11&gt; 获得 resultType 对应的类</span><br>  String resultType = context.getStringAttribute(<span class="hljs-string">&quot;resultType&quot;</span>);<br>  Class&lt;?&gt; resultTypeClass = resolveClass(resultType);<br>  String resultMap = context.getStringAttribute(<span class="hljs-string">&quot;resultMap&quot;</span>);<br>  <span class="hljs-comment">// &lt;12&gt; 获得 resultSet 对应的枚举值</span><br>  String resultSetType = context.getStringAttribute(<span class="hljs-string">&quot;resultSetType&quot;</span>);<br>  <span class="hljs-comment">// &lt;13&gt; 获得 statementType 对应的枚举值</span><br>  ResultSetType resultSetTypeEnum = resolveResultSetType(resultSetType);<br>  <span class="hljs-keyword">if</span> (resultSetTypeEnum == <span class="hljs-keyword">null</span>) &#123;<br>    resultSetTypeEnum = configuration.getDefaultResultSetType();<br>  &#125;<br>  <span class="hljs-comment">// &lt;14&gt; 获得 KeyGenerator 对象</span><br>  String keyProperty = context.getStringAttribute(<span class="hljs-string">&quot;keyProperty&quot;</span>);<br>  String keyColumn = context.getStringAttribute(<span class="hljs-string">&quot;keyColumn&quot;</span>);<br>  String resultSets = context.getStringAttribute(<span class="hljs-string">&quot;resultSets&quot;</span>);<br><br>  <span class="hljs-comment">// 创建 MappedStatement 对象</span><br>  builderAssistant.addMappedStatement(id, sqlSource, statementType, sqlCommandType,<br>      fetchSize, timeout, parameterMap, parameterTypeClass, resultMap, resultTypeClass,<br>      resultSetTypeEnum, flushCache, useCache, resultOrdered,<br>      keyGenerator, keyProperty, keyColumn, databaseId, langDriver, resultSets);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>databaseIdMatchesCurrent(String id, String databaseId, String requiredDatabaseId) 方法会在第二步判断databaseId是否匹配时调用，判断 databaseId 是否匹配。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">databaseIdMatchesCurrent</span><span class="hljs-params">(String id, String databaseId, String requiredDatabaseId)</span> </span>&#123;<br>  <span class="hljs-comment">// 如果不匹配，则返回 false</span><br>  <span class="hljs-keyword">if</span> (requiredDatabaseId != <span class="hljs-keyword">null</span>) &#123;<br>    <span class="hljs-keyword">return</span> requiredDatabaseId.equals(databaseId);<br>  &#125;<br>  <span class="hljs-comment">// 如果未设置 requiredDatabaseId ，但是 databaseId 存在，说明还是不匹配，则返回 false</span><br>  <span class="hljs-keyword">if</span> (databaseId != <span class="hljs-keyword">null</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>  &#125;<br>  <span class="hljs-comment">// 判断是否已经存在</span><br>  id = builderAssistant.applyCurrentNamespace(id, <span class="hljs-keyword">false</span>);<br>  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.configuration.hasStatement(id, <span class="hljs-keyword">false</span>)) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>  &#125;<br>  <span class="hljs-comment">// skip this statement if there is a previous one with a not null databaseId</span><br>  MappedStatement previous = <span class="hljs-keyword">this</span>.configuration.getMappedStatement(id, <span class="hljs-keyword">false</span>); <span class="hljs-comment">// issue #2</span><br>  <span class="hljs-comment">// 若存在，则判断原有的sqlFragment是否databaseId 为空。因为，当前databaseId为空，这样两者才能匹配。</span><br>  <span class="hljs-keyword">return</span> previous.getDatabaseId() == <span class="hljs-keyword">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="XMLIncludeTransformer"><a href="#XMLIncludeTransformer" class="headerlink" title="XMLIncludeTransformer"></a>XMLIncludeTransformer</h5><p>org.apache.ibatis.builder.xml.XMLIncludeTransformer ，会在XMLStatementBuilder.parseStatementNode()&lt;5&gt;中，进行XML &lt;include /&gt; 标签的转换，该过程会将其替换成节点中定义的SQL片段，并将其中的”${xxx}“占位符替换为真实的参数，applyIncludes(Node source) 方法，将 &lt;include /&gt; 标签，替换成引用的 &lt;sql /&gt; 。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">applyIncludes</span><span class="hljs-params">(Node source)</span> </span>&#123;<br>  <span class="hljs-comment">// &lt;1&gt; 创建 variablesContext ，并将 configurationVariables 添加到其中</span><br>  Properties variablesContext = <span class="hljs-keyword">new</span> Properties();<br>  Properties configurationVariables = configuration.getVariables();<br>  Optional.ofNullable(configurationVariables).ifPresent(variablesContext::putAll);<br>  <span class="hljs-comment">// &lt;2&gt; 处理 &lt;include /&gt;</span><br>  applyIncludes(source, variablesContext, <span class="hljs-keyword">false</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>#applyIncludes(Node source, final Properties variablesContext, boolean included) 方法，使用递归的方式，将 &lt;include /&gt; 标签，替换成引用的 &lt;sql /&gt; 。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">applyIncludes</span><span class="hljs-params">(Node source, <span class="hljs-keyword">final</span> Properties variablesContext, <span class="hljs-keyword">boolean</span> included)</span> </span>&#123;<br>  <span class="hljs-comment">// &lt;1&gt; 如果是 &lt;include /&gt; 标签</span><br>  <span class="hljs-keyword">if</span> (source.getNodeName().equals(<span class="hljs-string">&quot;include&quot;</span>)) &#123;<br>    <span class="hljs-comment">// &lt;1.1&gt; 获得 &lt;sql /&gt; 对应的节点</span><br>    Node toInclude = findSqlFragment(getStringAttribute(source, <span class="hljs-string">&quot;refid&quot;</span>), variablesContext);<br>    <span class="hljs-comment">// &lt;1.2&gt; 获得包含 &lt;include /&gt; 标签内的属性</span><br>    Properties toIncludeContext = getVariablesContext(source, variablesContext);<br>    <span class="hljs-comment">// &lt;1.3&gt; 递归调用 #applyIncludes(...) 方法，继续替换。注意，此处是 &lt;sql /&gt; 对应 的节点</span><br>    applyIncludes(toInclude, toIncludeContext, <span class="hljs-keyword">true</span>);<br>    <span class="hljs-keyword">if</span> (toInclude.getOwnerDocument() != source.getOwnerDocument()) &#123;<br>      toInclude = source.getOwnerDocument().importNode(toInclude, <span class="hljs-keyword">true</span>);<br>    &#125;<br>    <span class="hljs-comment">// &lt;1.4&gt; 将 &lt;include /&gt; 节点替换成 &lt;sql /&gt; 节点</span><br>    source.getParentNode().replaceChild(toInclude, source);<br>    <span class="hljs-comment">// &lt;1.4&gt; 将 &lt;sql /&gt; 子节点添加到 &lt;sql /&gt; 节点前面</span><br>    <span class="hljs-keyword">while</span> (toInclude.hasChildNodes()) &#123;<br>      <span class="hljs-comment">// &lt;1.4&gt; 移除 &lt;include /&gt; 标签自身</span><br>      toInclude.getParentNode().insertBefore(toInclude.getFirstChild(), toInclude);<br>    &#125;<br>    toInclude.getParentNode().removeChild(toInclude);<br>  <span class="hljs-comment">// &lt;2&gt; 如果节点类型为 Node.ELEMENT_NODE</span><br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (source.getNodeType() == Node.ELEMENT_NODE) &#123;<br>    <span class="hljs-comment">// &lt;2.1&gt; 如果在处理 &lt;include /&gt; 标签中，则替换其上的属性</span><br>    <span class="hljs-keyword">if</span> (included &amp;&amp; !variablesContext.isEmpty()) &#123;<br>      <span class="hljs-comment">// replace variables in attribute values</span><br>      NamedNodeMap attributes = source.getAttributes();<br>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; attributes.getLength(); i++) &#123;<br>        Node attr = attributes.item(i);<br>        attr.setNodeValue(PropertyParser.parse(attr.getNodeValue(), variablesContext));<br>      &#125;<br>    &#125;<br>    <span class="hljs-comment">// &lt;2.2&gt; 遍历子节点，递归调用 #applyIncludes(...) 方法，继续替换</span><br>    NodeList children = source.getChildNodes();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; children.getLength(); i++) &#123;<br>      applyIncludes(children.item(i), variablesContext, included);<br>    &#125;<br>  <span class="hljs-comment">// &lt;3&gt; 如果在处理 &lt;include /&gt; 标签中，并且节点类型为 Node.TEXT_NODE ，并且变量非空</span><br>  <span class="hljs-comment">// 则进行变量的替换，并修改原节点 source</span><br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (included &amp;&amp; (source.getNodeType() == Node.TEXT_NODE || source.getNodeType() == Node.CDATA_SECTION_NODE)<br>      &amp;&amp; !variablesContext.isEmpty()) &#123;<br>    <span class="hljs-comment">// replace variables in text node</span><br>    source.setNodeValue(PropertyParser.parse(source.getNodeValue(), variablesContext));<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>findSqlFragment(String refid, Properties variables) 方法，获得对应的 &lt;sql /&gt; 节点。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> Node <span class="hljs-title">findSqlFragment</span><span class="hljs-params">(String refid, Properties variables)</span> </span>&#123;<br>  <span class="hljs-comment">// 因为 refid 可能是动态变量，所以进行替换</span><br>  refid = PropertyParser.parse(refid, variables);<br>  <span class="hljs-comment">// 获得完整的 refid ，格式为 &quot;$&#123;namespace&#125;.$&#123;refid&#125;&quot;</span><br>  refid = builderAssistant.applyCurrentNamespace(refid, <span class="hljs-keyword">true</span>);<br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-comment">// 获得对应的 &lt;sql /&gt; 节点</span><br>    XNode nodeToInclude = configuration.getSqlFragments().get(refid);<br>    <span class="hljs-comment">// 获得 Node 节点，进行克隆</span><br>    <span class="hljs-keyword">return</span> nodeToInclude.getNode().cloneNode(<span class="hljs-keyword">true</span>);<br>  &#125; <span class="hljs-keyword">catch</span> (IllegalArgumentException e) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IncompleteElementException(<span class="hljs-string">&quot;Could not find SQL statement to include with refid &#x27;&quot;</span> + refid + <span class="hljs-string">&quot;&#x27;&quot;</span>, e);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="SqlSourceBuilder创建-SqlSource"><a href="#SqlSourceBuilder创建-SqlSource" class="headerlink" title="SqlSourceBuilder创建 SqlSource"></a>SqlSourceBuilder创建 SqlSource</h5><p>org.apache.ibatis.mapping.SqlSource ，SQL 来源接口，会在XMLStatementBuilder.parseStatementNode()&lt;9&gt;中进行创建。代表从 Mapper XML 或方法注解上，读取的一条 SQL 内容。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">SqlSource</span> </span>&#123;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   *  根据传入的参数对象，返回 BoundSql 对象 </span><br><span class="hljs-comment">   *   <span class="hljs-doctag">@param</span> parameterObject 参数对象 </span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> BoundSql 对象 </span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-function">BoundSql <span class="hljs-title">getBoundSql</span><span class="hljs-params">(Object parameterObject)</span></span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/2021/05/21/Mybatis/mybatis%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/image-20210524225426054.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li><p>RawSqlSource 负责处理静态 SQL 语句，它们最终会把处理后的 SQL 封装 StaticSqlSource 进行返回。使用 #{} 表达式，或者不使用任何表达式的情况，所以它是<strong>静态</strong>的，仅需要在构造方法中，直接生成对应的 SQL 。</p>
</li>
<li><p>StaticSqlSource处理包含的 SQL 可能含有 “？” 占位符，可以被数据库直接执行。</p>
</li>
<li><p>DynamicSqlSource 负责处理动态 SQL 语句。使用了 OGNL 表达式，或者使用了 ${} 表达式的 SQL ，所以它是<strong>动态</strong>的，需要在每次执行 #getBoundSql(Object parameterObject) 方法，根据参数，生成对应的 SQL 。</p>
</li>
<li><p>ProviderSqlSource 实现 SqlSource 接口，基于方法上的 @ProviderXXX 注解的 SqlSource 实现类。</p>
</li>
</ul>
<p>org.apache.ibatis.builder.SqlSourceBuilder ，SqlSource 构建器。负责将 SQL 语句中的 #{} 替换成相应的 ? 占位符，并获取该 ? 占位符对应的 ParameterMapping对象。</p>
<p>org.apache.ibatis.builder.SqlSourceBuilder ，SqlSource 构建器。负责将 SQL 语句中的 #{} 替换成相应的 ? 占位符，并获取该 ? 占位符对应的 ParameterMapping对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 执行解析原始 SQL ，成为 SqlSource 对象</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> originalSql 原始 SQL</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> parameterType 参数类型</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> additionalParameters</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> SqlSource 对象</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> SqlSource <span class="hljs-title">parse</span><span class="hljs-params">(String originalSql, Class&lt;?&gt; parameterType, Map&lt;String, Object&gt; additionalParameters)</span> </span>&#123;<br>  <span class="hljs-comment">// &lt;1&gt; 创建 ParameterMappingTokenHandler 对象</span><br>  ParameterMappingTokenHandler handler = <span class="hljs-keyword">new</span> ParameterMappingTokenHandler(configuration, parameterType, additionalParameters);<br>  <span class="hljs-comment">// &lt;2&gt; 创建 GenericTokenParser 对象</span><br>  GenericTokenParser parser = <span class="hljs-keyword">new</span> GenericTokenParser(<span class="hljs-string">&quot;#&#123;&quot;</span>, <span class="hljs-string">&quot;&#125;&quot;</span>, handler);<br>  String sql;<br>  <span class="hljs-keyword">if</span> (configuration.isShrinkWhitespacesInSql()) &#123;<br>    <span class="hljs-comment">// &lt;3&gt; 执行解析</span><br>    sql = parser.parse(removeExtraWhitespaces(originalSql));<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    sql = parser.parse(originalSql);<br>  &#125;<br>  <span class="hljs-comment">// &lt;4&gt; 创建 StaticSqlSource 对象</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> StaticSqlSource(configuration, sql, handler.getParameterMappings());<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ParameterMappingTokenHandler的handlerToken方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 注意：ParameterMappingTokenHandler 是 SqlSourceBuilder 的内部私有静态类</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> content</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">handleToken</span><span class="hljs-params">(String content)</span> </span>&#123;<br>  <span class="hljs-comment">// &lt;1&gt; 构建 ParameterMapping 对象，并添加到 parameterMappings 中</span><br>  parameterMappings.add(buildParameterMapping(content));<br>  <span class="hljs-comment">// &lt;2&gt; 返回 ? 占位符</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;?&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="核心执行器executor详解"><a href="#核心执行器executor详解" class="headerlink" title="核心执行器executor详解"></a>核心执行器executor详解</h3><h4 id="JDBC封装的执行过程"><a href="#JDBC封装的执行过程" class="headerlink" title="JDBC封装的执行过程"></a>JDBC封装的执行过程</h4><p><img src="/2021/05/21/Mybatis/mybatis%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/image-20210524230610780.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="核心执行组件介绍"><a href="#核心执行组件介绍" class="headerlink" title="核心执行组件介绍"></a>核心执行组件介绍</h4><p>在Mybatis中，SqlSession对数据库的操作，将委托给执行器Executor来完成都将委托给执行器Executor来完成;</p>
<p>Mybatis执行过程，主要的执行模块是： SqlSession-&gt;Executor-&gt;StatementHandler-&gt;数据库</p>
<p><strong>四个核心组件：</strong></p>
<ul>
<li>动态代理 MapperProxy </li>
<li>SQL会话 SqlSession </li>
<li>执行器 Executor </li>
<li>JDBC处理器 StatementHandler</li>
</ul>
<p><strong>SqlSession</strong></p>
<p>SqlSession采用了门面模式方便来让我们使用。他不能跨线程使用，一级缓存生命周期和它一致；</p>
<p>基本功能：增删改查基本的操作功能；</p>
<p>辅助功能：提交、关闭会话；</p>
<p>门面模式：提供一个统一的门面接口API，使得系统更加容易使用。</p>
<p><strong>Executor</strong></p>
<p>基本功能：改、查、<strong>维护缓存</strong>；</p>
<p>辅助功能：提交、关闭执行器、<strong>批处理刷新</strong>；</p>
<p><strong>Executor</strong> 主要负责维护一级缓存和二级缓存，并提供事务管理的相关操作，它会将数据库相关操作委托给 StatementHandler完成。</p>
<p><strong>StatementHandler</strong></p>
<p>经过执行器处理后交给了StatementHandler（声明处理器）；</p>
<p>主要作用就是：参数处理、结果处理；</p>
<p><strong>StatementHandler</strong> 首先通过 <strong>ParameterHandler</strong> 完成 SQL 语句的实参绑定，然后通过java.sql.Statement 对象执行 SQL 语句并得到结果集，最后通过 <strong>ResultSetHandler</strong> 完成结果集的映射，得到结果对象并返回。</p>
<h4 id="Executor执行器分析"><a href="#Executor执行器分析" class="headerlink" title="Executor执行器分析"></a>Executor执行器分析</h4><h5 id="JDBC中的执行器"><a href="#JDBC中的执行器" class="headerlink" title="JDBC中的执行器"></a>JDBC中的执行器</h5><p>JDBC有三种执行器分别是<strong>Statement（简单执行器）</strong>、<strong>PreparedStatement（预处理执行器）</strong>、**</p>
<p><strong>CallableStatement（存储过程执行器）</strong></p>
<ul>
<li><p>Statement：基本功能：执行静态SQL</p>
</li>
<li><p>PreparedStatement：设置预编译，防止SQL注入</p>
</li>
<li><p>CallableStatement：设置出参、读取参数（用于执行存储过程）</p>
</li>
</ul>
<h5 id="Mybatis执行器"><a href="#Mybatis执行器" class="headerlink" title="Mybatis执行器"></a>Mybatis执行器</h5><h6 id="Executor继承结构分析"><a href="#Executor继承结构分析" class="headerlink" title="Executor继承结构分析"></a>Executor继承结构分析</h6><p><img src="/2021/05/21/Mybatis/mybatis%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/image-20210524231216534.png" srcset="/img/loading.gif" lazyload></p>
<p>Mybatis给我们提供了三种执行器，分别是 :</p>
<ul>
<li>SimpleExecutor(简单执行器)</li>
<li>ResuseExecutor(可重用执行器)</li>
<li>BathExecutor(批处理执行器）</li>
</ul>
<p>这三个执行器继承了一个<strong>BaseExecutor</strong>（基础执行器），而这个基础执行器实现了Executor接口，其中简单执行器是默认的执行器。</p>
<p>其实还有一种执行器<strong>CachingExecutor</strong>(二级缓存执行器)你开启二级缓存则会实例化它，在 BaseExecutor的基础上，实现<strong>二级缓存</strong>功能。 （注意: BaseExecutor 的本地缓存，就是一级缓存。）</p>
<h6 id="Executor接口"><a href="#Executor接口" class="headerlink" title="Executor接口"></a>Executor接口</h6><p>org.apache.ibatis.executor.Executor ，执行器接口。</p>
<p>主要定义了以下内容：</p>
<ul>
<li>读和写操作相关的方法</li>
<li>事务相关的方法</li>
<li>缓存相关的方法</li>
<li>设置延迟加载的方法</li>
<li>设置包装的 Executor 对象的方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Executor</span> </span>&#123;<br><br>  <span class="hljs-comment">// 空 ResultHandler 对象的枚举</span><br>  ResultHandler NO_RESULT_HANDLER = <span class="hljs-keyword">null</span>;<br><br>  <span class="hljs-comment">// 更新 or 插入 or 删除，由传入的 MappedStatement 的 SQL 所决定</span><br>  <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">update</span><span class="hljs-params">(MappedStatement ms, Object parameter)</span> <span class="hljs-keyword">throws</span> SQLException</span>;<br><br>  <span class="hljs-comment">// 查询，带 ResultHandler + CacheKey + BoundSql</span><br>  &lt;E&gt; <span class="hljs-function">List&lt;E&gt; <span class="hljs-title">query</span><span class="hljs-params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey cacheKey, BoundSql boundSql)</span> <span class="hljs-keyword">throws</span> SQLException</span>;<br><br>  <span class="hljs-comment">// 查询，带 ResultHandler</span><br>  &lt;E&gt; <span class="hljs-function">List&lt;E&gt; <span class="hljs-title">query</span><span class="hljs-params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler)</span> <span class="hljs-keyword">throws</span> SQLException</span>;<br><br>  <span class="hljs-comment">// 查询，返回值为 Cursor</span><br>  &lt;E&gt; <span class="hljs-function">Cursor&lt;E&gt; <span class="hljs-title">queryCursor</span><span class="hljs-params">(MappedStatement ms, Object parameter, RowBounds rowBounds)</span> <span class="hljs-keyword">throws</span> SQLException</span>;<br><br>  <span class="hljs-comment">// 刷入批处理语句</span><br>  <span class="hljs-function">List&lt;BatchResult&gt; <span class="hljs-title">flushStatements</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException</span>;<br><br>  <span class="hljs-comment">// 提交事务</span><br>  <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">commit</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> required)</span> <span class="hljs-keyword">throws</span> SQLException</span>;<br><br>  <span class="hljs-comment">// 回滚事务</span><br>  <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">rollback</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> required)</span> <span class="hljs-keyword">throws</span> SQLException</span>;<br><br>  <span class="hljs-comment">// 创建 CacheKey 对象</span><br>  <span class="hljs-function">CacheKey <span class="hljs-title">createCacheKey</span><span class="hljs-params">(MappedStatement ms, Object parameterObject, RowBounds rowBounds, BoundSql boundSql)</span></span>;<br><br>  <span class="hljs-comment">// 判断是否缓存</span><br>  <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">isCached</span><span class="hljs-params">(MappedStatement ms, CacheKey key)</span></span>;<br><br>  <span class="hljs-comment">// 清除本地缓存</span><br>  <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">clearLocalCache</span><span class="hljs-params">()</span></span>;<br><br>  <span class="hljs-comment">// 延迟加载</span><br>  <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">deferLoad</span><span class="hljs-params">(MappedStatement ms, MetaObject resultObject, String property, CacheKey key, Class&lt;?&gt; targetType)</span></span>;<br><br>  <span class="hljs-comment">// 获得事务</span><br>  <span class="hljs-function">Transaction <span class="hljs-title">getTransaction</span><span class="hljs-params">()</span></span>;<br><br>  <span class="hljs-comment">// 关闭事务</span><br>  <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">close</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> forceRollback)</span></span>;<br><br>  <span class="hljs-comment">// 判断事务是否关闭</span><br>  <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">isClosed</span><span class="hljs-params">()</span></span>;<br><br>  <span class="hljs-comment">// 设置包装的 Executor 对象</span><br>  <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setExecutorWrapper</span><span class="hljs-params">(Executor executor)</span></span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h6 id="BaseExecutor（基础执行器）"><a href="#BaseExecutor（基础执行器）" class="headerlink" title="BaseExecutor（基础执行器）"></a>BaseExecutor（基础执行器）</h6><p>基础执行器：维护一级缓存，是simple、reuse、batch这三个执行器的父类。主要逻辑是维护缓存，其他实现交给子类。 org.apache.ibatis.executor.BaseExecutor 实现 Executor 接口，提供骨架方法，从而使子类只要实现指定的几个抽象方法即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BaseExecutor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Executor</span> </span>&#123;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Log log = LogFactory.getLog(BaseExecutor.class);<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 事务对象</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">protected</span> Transaction transaction;<br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 包装的 Executor 对象</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">protected</span> Executor wrapper;<br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * DeferredLoad( 延迟加载 ) 队列</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">protected</span> ConcurrentLinkedQueue&lt;DeferredLoad&gt; deferredLoads;<br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 本地缓存，即一级缓存</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">protected</span> PerpetualCache localCache;<br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 本地输出类型的参数的缓存</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">protected</span> PerpetualCache localOutputParameterCache;<br>  <span class="hljs-keyword">protected</span> Configuration configuration;<br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 记录嵌套查询的层级</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">int</span> queryStack;<br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 是否关闭</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> closed;<br>  <br>  <span class="hljs-comment">/** clearLocalCache() 方法，清理一级（本地）缓存 */</span><br>  <br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">update</span><span class="hljs-params">(MappedStatement ms, Object parameter)</span> <span class="hljs-keyword">throws</span> SQLException </span>&#123;<br>    ErrorContext.instance().resource(ms.getResource()).activity(<span class="hljs-string">&quot;executing an update&quot;</span>).object(ms.getId());<br>    <span class="hljs-comment">// &lt;1&gt; 已经关闭，则抛出 ExecutorException 异常</span><br>    <span class="hljs-keyword">if</span> (closed) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ExecutorException(<span class="hljs-string">&quot;Executor was closed.&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">// &lt;2&gt; 清空本地缓存</span><br>    clearLocalCache();<br>    <span class="hljs-comment">// &lt;3&gt; 执行写操作</span><br>    <span class="hljs-keyword">return</span> doUpdate(ms, parameter);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;E&gt; <span class="hljs-function">List&lt;E&gt; <span class="hljs-title">query</span><span class="hljs-params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler)</span> <span class="hljs-keyword">throws</span> SQLException </span>&#123;<br>    <span class="hljs-comment">// &lt;1&gt; 获得 BoundSql 对象</span><br>    BoundSql boundSql = ms.getBoundSql(parameter);<br>    <span class="hljs-comment">// &lt;2&gt; 创建 CacheKey 对象</span><br>    CacheKey key = createCacheKey(ms, parameter, rowBounds, boundSql);<br>    <span class="hljs-comment">// &lt;3&gt; 查询</span><br>    <span class="hljs-keyword">return</span> query(ms, parameter, rowBounds, resultHandler, key, boundSql);<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * clearLocalCache() 方法，清理一级（本地）缓存</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">clearLocalCache</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (!closed) &#123;<br>      <span class="hljs-comment">// 清理 localCache</span><br>      localCache.clear();<br>      <span class="hljs-comment">// 清理 localOutputParameterCache</span><br>      localOutputParameterCache.clear();<br>    &#125;<br>  &#125;<br>  <br>  <span class="hljs-comment">// createCacheKey(MappedStatement ms, Object parameterObject, RowBounds rowBounds, BoundSql boundSql) 方法，创建 CacheKey 对象</span><br>  <br>  <span class="hljs-comment">// isCached(MappedStatement ms, CacheKey key) 方法，判断一级缓存是否存在</span><br>  <br>  <span class="hljs-comment">// ...略</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h6 id="SimpleExecutor（简单执行器）"><a href="#SimpleExecutor（简单执行器）" class="headerlink" title="SimpleExecutor（简单执行器）"></a>SimpleExecutor（简单执行器）</h6><ul>
<li><p>每次读或写操作都会创建一个新的预处理器（PrepareStatement）;</p>
</li>
<li><p>每次执行的的SQL都会进行一次预编译;</p>
</li>
<li><p>执行完成后，关闭该 Statement 对象。</p>
</li>
</ul>
<p>org.apache.ibatis.executor.SimpleExecutor ，继承 BaseExecutor 抽象类，简单的 Executor 实现类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SimpleExecutor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseExecutor</span> </span>&#123;<br><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">SimpleExecutor</span><span class="hljs-params">(Configuration configuration, Transaction transaction)</span> </span>&#123;<br>    <span class="hljs-keyword">super</span>(configuration, transaction);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">doUpdate</span><span class="hljs-params">(MappedStatement ms, Object parameter)</span> <span class="hljs-keyword">throws</span> SQLException </span>&#123;<br>    Statement stmt = <span class="hljs-keyword">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>      Configuration configuration = ms.getConfiguration();<br>      <span class="hljs-comment">// &lt;1&gt; 创建 StatementHandler 对象</span><br>      StatementHandler handler = configuration.newStatementHandler(<span class="hljs-keyword">this</span>, ms, parameter, RowBounds.DEFAULT, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>);<br>      <span class="hljs-comment">// &lt;2&gt; 初始化 StatementHandler 对象</span><br>      stmt = prepareStatement(handler, ms.getStatementLog());<br>      <span class="hljs-comment">// &lt;3&gt; 执行 StatementHandler ，进行写操作</span><br>      <span class="hljs-keyword">return</span> handler.update(stmt);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      <span class="hljs-comment">// &lt;4&gt; 关闭 StatementHandler 对象</span><br>      closeStatement(stmt);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;E&gt; <span class="hljs-function">List&lt;E&gt; <span class="hljs-title">doQuery</span><span class="hljs-params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> <span class="hljs-keyword">throws</span> SQLException </span>&#123;<br>    Statement stmt = <span class="hljs-keyword">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>      Configuration configuration = ms.getConfiguration();<br>      <span class="hljs-comment">// &lt;1&gt; 创建 StatementHandler 对象</span><br>      StatementHandler handler = configuration.newStatementHandler(wrapper, ms, parameter, rowBounds, resultHandler, boundSql);<br>      <span class="hljs-comment">// &lt;2&gt; 初始化 StatementHandler 对象</span><br>      stmt = prepareStatement(handler, ms.getStatementLog());<br>      <span class="hljs-comment">// &lt;3&gt; 执行 StatementHandler ，进行读操作</span><br>      <span class="hljs-keyword">return</span> handler.query(stmt, resultHandler);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      <span class="hljs-comment">// &lt;4&gt; 关闭 StatementHandler 对象</span><br>      closeStatement(stmt);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">protected</span> &lt;E&gt; <span class="hljs-function">Cursor&lt;E&gt; <span class="hljs-title">doQueryCursor</span><span class="hljs-params">(MappedStatement ms, Object parameter, RowBounds rowBounds, BoundSql boundSql)</span> <span class="hljs-keyword">throws</span> SQLException </span>&#123;<br>    Configuration configuration = ms.getConfiguration();<br>    StatementHandler handler = configuration.newStatementHandler(wrapper, ms, parameter, rowBounds, <span class="hljs-keyword">null</span>, boundSql);<br>    Statement stmt = prepareStatement(handler, ms.getStatementLog());<br>    Cursor&lt;E&gt; cursor = handler.queryCursor(stmt);<br>    stmt.closeOnCompletion();<br>    <span class="hljs-keyword">return</span> cursor;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;BatchResult&gt; <span class="hljs-title">doFlushStatements</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isRollback)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> Collections.emptyList();<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-keyword">private</span> Statement <span class="hljs-title">prepareStatement</span><span class="hljs-params">(StatementHandler handler, Log statementLog)</span> <span class="hljs-keyword">throws</span> SQLException </span>&#123;<br>    Statement stmt;<br>    <span class="hljs-comment">// &lt;2.1&gt; 获得 Connection 对象</span><br>    Connection connection = getConnection(statementLog);<br>    <span class="hljs-comment">// &lt;2.2&gt; 创建 Statement 或 PrepareStatement 对象</span><br>    stmt = handler.prepare(connection, transaction.getTimeout());<br>    <span class="hljs-comment">// &lt;2.3&gt; 设置 SQL 上的参数，例如 PrepareStatement 对象上的占位符</span><br>    handler.parameterize(stmt);<br>    <span class="hljs-keyword">return</span> stmt;<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h6 id="ReuseExecutor（可重用执行器）"><a href="#ReuseExecutor（可重用执行器）" class="headerlink" title="ReuseExecutor（可重用执行器）"></a>ReuseExecutor（可重用执行器）</h6><ul>
<li><p>每次开始读或写操作，以sql作为key，查找Statement对象优先从缓存中获取对应的 Statement对象。如果不存在，才进行创建。( 只要是相同的SQL只会进行一次预处理)</p>
</li>
<li><p>执行完成后，不关闭该 Statement 对象，而是放置于Map&lt;String, Statement&gt;内，供下一次使用。</p>
</li>
<li><p>其它的，和 SimpleExecutor 是一致的</p>
</li>
</ul>
<p><strong>原理：</strong>可重用的执行器内部用了一个map，用来缓存SQL语句对应的Statement对象 ，Key是我们的SQL语句，value是我们的Statement对象 <code>private final Map&lt;String, Statement&gt; statementMap = new HashMap&lt;String, Statement&gt;(); </code></p>
<p>org.apache.ibatis.executor.ReuseExecutor ，继承 BaseExecutor 抽象类，可重用的 Executor 实现类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ReuseExecutor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseExecutor</span> </span>&#123;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, Statement&gt; statementMap = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ReuseExecutor</span><span class="hljs-params">(Configuration configuration, Transaction transaction)</span> </span>&#123;<br>    <span class="hljs-keyword">super</span>(configuration, transaction);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">doUpdate</span><span class="hljs-params">(MappedStatement ms, Object parameter)</span> <span class="hljs-keyword">throws</span> SQLException </span>&#123;<br>    Configuration configuration = ms.getConfiguration();<br>    StatementHandler handler = configuration.newStatementHandler(<span class="hljs-keyword">this</span>, ms, parameter, RowBounds.DEFAULT, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>);<br>    Statement stmt = prepareStatement(handler, ms.getStatementLog());<br>    <span class="hljs-keyword">return</span> handler.update(stmt);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;E&gt; <span class="hljs-function">List&lt;E&gt; <span class="hljs-title">doQuery</span><span class="hljs-params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> <span class="hljs-keyword">throws</span> SQLException </span>&#123;<br>    Configuration configuration = ms.getConfiguration();<br>    <span class="hljs-comment">// 创建 StatementHandler 对象</span><br>    StatementHandler handler = configuration.newStatementHandler(wrapper, ms, parameter, rowBounds, resultHandler, boundSql);<br>    <span class="hljs-comment">// 初始化 StatementHandler 对象</span><br>    Statement stmt = prepareStatement(handler, ms.getStatementLog());<br>    <span class="hljs-comment">// 执行 StatementHandler ，进行读操作</span><br>    <span class="hljs-keyword">return</span> handler.query(stmt, resultHandler);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">protected</span> &lt;E&gt; <span class="hljs-function">Cursor&lt;E&gt; <span class="hljs-title">doQueryCursor</span><span class="hljs-params">(MappedStatement ms, Object parameter, RowBounds rowBounds, BoundSql boundSql)</span> <span class="hljs-keyword">throws</span> SQLException </span>&#123;<br>    Configuration configuration = ms.getConfiguration();<br>    <span class="hljs-comment">// 创建 StatementHandler 对象</span><br>    StatementHandler handler = configuration.newStatementHandler(wrapper, ms, parameter, rowBounds, <span class="hljs-keyword">null</span>, boundSql);<br>    <span class="hljs-comment">// 初始化 StatementHandler 对象</span><br>    Statement stmt = prepareStatement(handler, ms.getStatementLog());<br>    <span class="hljs-comment">// 执行 StatementHandler ，进行写操作</span><br>    <span class="hljs-keyword">return</span> handler.queryCursor(stmt);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;BatchResult&gt; <span class="hljs-title">doFlushStatements</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isRollback)</span> </span>&#123;<br>    <span class="hljs-keyword">for</span> (Statement stmt : statementMap.values()) &#123;<br>      closeStatement(stmt);<br>    &#125;<br>    statementMap.clear();<br>    <span class="hljs-keyword">return</span> Collections.emptyList();<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-keyword">private</span> Statement <span class="hljs-title">prepareStatement</span><span class="hljs-params">(StatementHandler handler, Log statementLog)</span> <span class="hljs-keyword">throws</span> SQLException </span>&#123;<br>    Statement stmt;<br>    BoundSql boundSql = handler.getBoundSql();<br>    String sql = boundSql.getSql();<br>    <span class="hljs-comment">// 存在</span><br>    <span class="hljs-keyword">if</span> (hasStatementFor(sql)) &#123;<br>      <span class="hljs-comment">// &lt;1.1&gt; 从缓存中获得 Statement 或 PrepareStatement 对象</span><br>      stmt = getStatement(sql);<br>      <span class="hljs-comment">// &lt;1.2&gt; 设置事务超时时间</span><br>      applyTransactionTimeout(stmt);<br>    <span class="hljs-comment">// 不存在</span><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// &lt;2.1&gt; 获得 Connection 对象</span><br>      Connection connection = getConnection(statementLog);<br>      <span class="hljs-comment">// &lt;2.2&gt; 创建 Statement 或 PrepareStatement 对象</span><br>      stmt = handler.prepare(connection, transaction.getTimeout());<br>      <span class="hljs-comment">// &lt;2.3&gt; 添加到缓存中</span><br>      putStatement(sql, stmt);<br>    &#125;<br>    <span class="hljs-comment">// &lt;2&gt; 设置 SQL 上的参数，例如 PrepareStatement 对象上的占位符</span><br>    handler.parameterize(stmt);<br>    <span class="hljs-keyword">return</span> stmt;<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">hasStatementFor</span><span class="hljs-params">(String sql)</span> </span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      Statement statement = statementMap.get(sql);<br>      <span class="hljs-keyword">return</span> statement != <span class="hljs-keyword">null</span> &amp;&amp; !statement.getConnection().isClosed();<br>    &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-keyword">private</span> Statement <span class="hljs-title">getStatement</span><span class="hljs-params">(String s)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> statementMap.get(s);<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">putStatement</span><span class="hljs-params">(String sql, Statement stmt)</span> </span>&#123;<br>    statementMap.put(sql, stmt);<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/2021/05/21/Mybatis/mybatis%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/image-20210524233213028.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>注意：</strong></p>
<p>ReuseExecutor 考虑到重用性，但是 Statement 最终还是需要有地方关闭。答案就在#doFlushStatements(boolean isRollback) 方法中。而 BaseExecutor 在关闭 #close() 方法中，最终也会调用该方法，从而完成关闭缓存的 Statement 对象们，BaseExecutor 在提交或者回滚事务方法中，最终也会调用该方法，也能完成关闭缓存的 Statement对象们。</p>
<h6 id="BatchExecutor（批处理执行器）"><a href="#BatchExecutor（批处理执行器）" class="headerlink" title="BatchExecutor（批处理执行器）"></a>BatchExecutor（批处理执行器）</h6><ul>
<li><p>批处理只对增删改SQL有效（没有select，JDBC批处理不支持select）；</p>
</li>
<li><p>将所有增删改sql都添加到批处理中（addBatch()），等待统一执行（executeBatch()），它缓存了多个Statement对象，每个Statement对象都是addBatch()完毕后，等待逐一执行executeBatch()批处理的；</p>
</li>
<li><p>执行sql需要满足三个条件才能使用同一个Statement(使用同一个Statement是为了压缩体积、减少SQL预处理)</p>
<ol>
<li>sql相同</li>
<li>同一个MappedStatement（sql标签的配置都在这里面）</li>
<li>执行的顺序必须是连续的</li>
</ol>
</li>
</ul>
<p>org.apache.ibatis.executor.BatchExecutor ，继承 BaseExecutor 抽象类，批量执行的 Executor实现类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BatchExecutor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseExecutor</span> </span>&#123;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> BATCH_UPDATE_RETURN_VALUE = Integer.MIN_VALUE + <span class="hljs-number">1002</span>;<br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Statement 数组</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;Statement&gt; statementList = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * BatchResult 数组</span><br><span class="hljs-comment">   * 每一个 BatchResult 元素，对应一个 &#123;<span class="hljs-doctag">@link</span> #statementList&#125; 的 Statement 元素</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;BatchResult&gt; batchResultList = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 当前 SQL</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">private</span> String currentSql;<br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 当前 MappedStatement 对象</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">private</span> MappedStatement currentStatement;<br><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">BatchExecutor</span><span class="hljs-params">(Configuration configuration, Transaction transaction)</span> </span>&#123;<br>    <span class="hljs-keyword">super</span>(configuration, transaction);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">doUpdate</span><span class="hljs-params">(MappedStatement ms, Object parameterObject)</span> <span class="hljs-keyword">throws</span> SQLException </span>&#123;<br>    <span class="hljs-keyword">final</span> Configuration configuration = ms.getConfiguration();<br>    <span class="hljs-comment">// &lt;1&gt; 创建 StatementHandler 对象</span><br>    <span class="hljs-keyword">final</span> StatementHandler handler = configuration.newStatementHandler(<span class="hljs-keyword">this</span>, ms, parameterObject, RowBounds.DEFAULT, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>);<br>    <span class="hljs-keyword">final</span> BoundSql boundSql = handler.getBoundSql();<br>    <span class="hljs-keyword">final</span> String sql = boundSql.getSql();<br>    <span class="hljs-keyword">final</span> Statement stmt;<br>    <span class="hljs-comment">// &lt;2&gt; 如果匹配最后一次 currentSql 和 currentStatement ，则聚合到 BatchResult 中</span><br>    <span class="hljs-keyword">if</span> (sql.equals(currentSql) &amp;&amp; ms.equals(currentStatement)) &#123;<br>      <span class="hljs-comment">// &lt;2.1&gt; 获得最后一次的 Statement 对象</span><br>      <span class="hljs-keyword">int</span> last = statementList.size() - <span class="hljs-number">1</span>;<br>      stmt = statementList.get(last);<br>      <span class="hljs-comment">// &lt;2.2&gt; 设置事务超时时间</span><br>      applyTransactionTimeout(stmt);<br>      <span class="hljs-comment">// &lt;2.3&gt; 设置 SQL 上的参数，例如 PrepareStatement 对象上的占位符</span><br>      handler.parameterize(stmt);<span class="hljs-comment">// fix Issues 322</span><br>      <span class="hljs-comment">// &lt;2.4&gt; 获得最后一次的 BatchResult 对象，并添加参数到其中</span><br>      BatchResult batchResult = batchResultList.get(last);<br>      batchResult.addParameterObject(parameterObject);<br>      <span class="hljs-comment">// &lt;3&gt; 如果不匹配最后一次 currentSql 和 currentStatement ，则新建 BatchResult 对象</span><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// &lt;3.1&gt; 获得 Connection</span><br>      Connection connection = getConnection(ms.getStatementLog());<br>      <span class="hljs-comment">// &lt;3.2&gt; 创建 Statement 或 PrepareStatement 对象</span><br>      stmt = handler.prepare(connection, transaction.getTimeout());<br>      <span class="hljs-comment">// &lt;3.3&gt; 设置 SQL 上的参数，例如 PrepareStatement 对象上的占位符</span><br>      handler.parameterize(stmt);    <span class="hljs-comment">// fix Issues 322</span><br>      <span class="hljs-comment">// &lt;3.4&gt; 重新设置 currentSql 和 currentStatement</span><br>      currentSql = sql;<br>      currentStatement = ms;<br>      <span class="hljs-comment">// &lt;3.5&gt; 添加 Statement 到 statementList 中</span><br>      statementList.add(stmt);<br>      <span class="hljs-comment">// &lt;3.6&gt; 创建 BatchResult 对象，并添加到 batchResultList 中</span><br>      batchResultList.add(<span class="hljs-keyword">new</span> BatchResult(ms, sql, parameterObject));<br>    &#125;<br>    <span class="hljs-comment">// &lt;4&gt; 批处理</span><br>    handler.batch(stmt);<br>    <span class="hljs-keyword">return</span> BATCH_UPDATE_RETURN_VALUE;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;E&gt; <span class="hljs-function">List&lt;E&gt; <span class="hljs-title">doQuery</span><span class="hljs-params">(MappedStatement ms, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span></span><br><span class="hljs-function">    <span class="hljs-keyword">throws</span> SQLException </span>&#123;<br>    <span class="hljs-comment">//和 SimpleExecutor 的该方法，逻辑差不多。区别在发生查询之前，先调用 #flushStatements() 方法，刷入批处理语句。</span><br>    Statement stmt = <span class="hljs-keyword">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// 刷入批处理语句</span><br>      flushStatements();<br>      Configuration configuration = ms.getConfiguration();<br>      <span class="hljs-comment">// 创建 StatementHandler 对象</span><br>      StatementHandler handler = configuration.newStatementHandler(wrapper, ms, parameterObject, rowBounds, resultHandler, boundSql);<br>      <span class="hljs-comment">// 获得 Connection 对象</span><br>      Connection connection = getConnection(ms.getStatementLog());<br>      <span class="hljs-comment">// 创建 Statement 或 PrepareStatement 对象</span><br>      stmt = handler.prepare(connection, transaction.getTimeout());<br>      <span class="hljs-comment">// 设置 SQL 上的参数，例如 PrepareStatement 对象上的占位符</span><br>      handler.parameterize(stmt);<br>      <span class="hljs-comment">// 执行 StatementHandler ，进行读操作</span><br>      <span class="hljs-keyword">return</span> handler.query(stmt, resultHandler);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      <span class="hljs-comment">// 关闭 StatementHandler 对象</span><br>      closeStatement(stmt);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">protected</span> &lt;E&gt; <span class="hljs-function">Cursor&lt;E&gt; <span class="hljs-title">doQueryCursor</span><span class="hljs-params">(MappedStatement ms, Object parameter, RowBounds rowBounds, BoundSql boundSql)</span> <span class="hljs-keyword">throws</span> SQLException </span>&#123;<br>    flushStatements();<br>    Configuration configuration = ms.getConfiguration();<br>    StatementHandler handler = configuration.newStatementHandler(wrapper, ms, parameter, rowBounds, <span class="hljs-keyword">null</span>, boundSql);<br>    Connection connection = getConnection(ms.getStatementLog());<br>    Statement stmt = handler.prepare(connection, transaction.getTimeout());<br>    handler.parameterize(stmt);<br>    Cursor&lt;E&gt; cursor = handler.queryCursor(stmt);<br>    stmt.closeOnCompletion();<br>    <span class="hljs-keyword">return</span> cursor;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;BatchResult&gt; <span class="hljs-title">doFlushStatements</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isRollback)</span> <span class="hljs-keyword">throws</span> SQLException </span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      List&lt;BatchResult&gt; results = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>      <span class="hljs-keyword">if</span> (isRollback) &#123;<br>        <span class="hljs-keyword">return</span> Collections.emptyList();<br>      &#125;<br>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>, n = statementList.size(); i &lt; n; i++) &#123;<br>        Statement stmt = statementList.get(i);<br>        applyTransactionTimeout(stmt);<br>        BatchResult batchResult = batchResultList.get(i);<br>        <span class="hljs-keyword">try</span> &#123;<br>          batchResult.setUpdateCounts(stmt.executeBatch());<br>          MappedStatement ms = batchResult.getMappedStatement();<br>          List&lt;Object&gt; parameterObjects = batchResult.getParameterObjects();<br>          KeyGenerator keyGenerator = ms.getKeyGenerator();<br>          <span class="hljs-keyword">if</span> (Jdbc3KeyGenerator.class.equals(keyGenerator.getClass())) &#123;<br>            Jdbc3KeyGenerator jdbc3KeyGenerator = (Jdbc3KeyGenerator) keyGenerator;<br>            jdbc3KeyGenerator.processBatch(ms, stmt, parameterObjects);<br>          &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!NoKeyGenerator.class.equals(keyGenerator.getClass())) &#123; <span class="hljs-comment">//issue #141</span><br>            <span class="hljs-keyword">for</span> (Object parameter : parameterObjects) &#123;<br>              keyGenerator.processAfter(<span class="hljs-keyword">this</span>, ms, stmt, parameter);<br>            &#125;<br>          &#125;<br>          <span class="hljs-comment">// Close statement to close cursor #1109</span><br>          closeStatement(stmt);<br>        &#125; <span class="hljs-keyword">catch</span> (BatchUpdateException e) &#123;<br>          StringBuilder message = <span class="hljs-keyword">new</span> StringBuilder();<br>          message.append(batchResult.getMappedStatement().getId())<br>            .append(<span class="hljs-string">&quot; (batch index #&quot;</span>)<br>            .append(i + <span class="hljs-number">1</span>)<br>            .append(<span class="hljs-string">&quot;)&quot;</span>)<br>            .append(<span class="hljs-string">&quot; failed.&quot;</span>);<br>          <span class="hljs-keyword">if</span> (i &gt; <span class="hljs-number">0</span>) &#123;<br>            message.append(<span class="hljs-string">&quot; &quot;</span>)<br>              .append(i)<br>              .append(<span class="hljs-string">&quot; prior sub executor(s) completed successfully, but will be rolled back.&quot;</span>);<br>          &#125;<br>          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BatchExecutorException(message.toString(), e, results, batchResult);<br>        &#125;<br>        results.add(batchResult);<br>      &#125;<br>      <span class="hljs-keyword">return</span> results;<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      <span class="hljs-keyword">for</span> (Statement stmt : statementList) &#123;<br>        closeStatement(stmt);<br>      &#125;<br>      currentSql = <span class="hljs-keyword">null</span>;<br>      statementList.clear();<br>      batchResultList.clear();<br>    &#125;<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li><p>doUpdate代码上 if (sql.equals(currentSql) &amp;&amp; ms.equals(currentStatement)) 可以看出上一个添加的是否是这个sql（currentSql）并且是同一个MappedStatementcurrentStatement（映射语句）;</p>
</li>
<li><p>满足条件就将参数放到当前这个BatchResult对象中的参数。属性是（parameterObject） 【batchResult.addParameterObject(parameterObject);】</p>
</li>
<li><p>不满足条件则获取一个Statement实例 再实例化BatchResult对象。最后放到list中去，再给current和MappedStatement currentStatement赋值</p>
</li>
<li><p>批处理提交必须执行flflushStatements才会生效(会将一个个的Statement提交)可以减少与数据库交互次数</p>
</li>
</ul>
<h6 id="CachingExecutor（二级缓存执行器）"><a href="#CachingExecutor（二级缓存执行器）" class="headerlink" title="CachingExecutor（二级缓存执行器）"></a>CachingExecutor（二级缓存执行器）</h6><p>CachingExecutor二级缓存执行器，属于缓存章节内容，在后面缓存章节详细讲解；</p>
<h5 id="Executor的创建"><a href="#Executor的创建" class="headerlink" title="Executor的创建"></a>Executor的创建</h5><p><img src="/2021/05/21/Mybatis/mybatis%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/image-20210524234035669.png" srcset="/img/loading.gif" lazyload></p>
<p>Configuration 类中，提供 newExecutor 方法，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 创建 Executor 对象 -----------------在创建SqlSession执行</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> transaction  事务对象</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> executorType 执行器类型</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> 对象</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> Executor <span class="hljs-title">newExecutor</span><span class="hljs-params">(Transaction transaction, ExecutorType executorType)</span> </span>&#123;<br>  <span class="hljs-comment">// &lt;1&gt; 获得执行器类型</span><br>  <span class="hljs-comment">// 可以通过在 mybatis-config.xml 配置 &lt;setting name=&quot;defaultExecutorType&quot; value=&quot;&quot; /&gt;</span><br>  <span class="hljs-comment">// 使用默认</span><br>  executorType = executorType == <span class="hljs-keyword">null</span> ? defaultExecutorType : executorType;<br>  <span class="hljs-comment">// 使用默认</span><br>  executorType = executorType == <span class="hljs-keyword">null</span> ? ExecutorType.SIMPLE : executorType;<br>  <span class="hljs-comment">// &lt;2&gt; 3个分支3种执行器BatchExecutor/ReuseExecutor/SimpleExecutor： 默认为 SimpleExecutor 对象</span><br>  Executor executor;<br>  <span class="hljs-keyword">if</span> (ExecutorType.BATCH == executorType) &#123;<br>    executor = <span class="hljs-keyword">new</span> BatchExecutor(<span class="hljs-keyword">this</span>, transaction);<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ExecutorType.REUSE == executorType) &#123;<br>    executor = <span class="hljs-keyword">new</span> ReuseExecutor(<span class="hljs-keyword">this</span>, transaction);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    executor = <span class="hljs-keyword">new</span> SimpleExecutor(<span class="hljs-keyword">this</span>, transaction);<br>  &#125;<br>  <span class="hljs-comment">// &lt;3&gt; 如果开启缓存，创建 CachingExecutor 对象，装饰者模式进行包装</span><br>  <span class="hljs-keyword">if</span> (cacheEnabled) &#123;<br>    executor = <span class="hljs-keyword">new</span> CachingExecutor(executor);<br>  &#125;<br>  <span class="hljs-comment">// &lt;4&gt; 应用插件</span><br>  executor = (Executor) interceptorChain.pluginAll(executor);<br>  <span class="hljs-keyword">return</span> executor;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>小结：</strong></p>
<ol>
<li><p>我们可以在 ExecutorType 中看到，枚举了三种类型： SIMPLE 、REUSE 、BATCH</p>
</li>
<li><p>如果没有指定类型，默认为 SimpleExecutor 对象</p>
</li>
<li><p>如果开启缓存，创建 CachingExecutor 对象，进行包装</p>
</li>
</ol>
<h3 id="缓存原理"><a href="#缓存原理" class="headerlink" title="缓存原理"></a>缓存原理</h3><p>Mybatis 提供了缓存策略，通过缓存策略来减少数据库的查询次数，从而提高性能。</p>
<p>Mybatis的缓存分为：一级缓存和二级缓存</p>
<h4 id="一级缓存"><a href="#一级缓存" class="headerlink" title="一级缓存"></a>一级缓存</h4><p><strong>概述：</strong></p>
<p>当使用MyBatis开启一次和数据库的会话，MyBatis会创建出一个SqlSession对象表示一次数据库会话，建立一个简单的缓存，将每次查询到的结果缓存起来，当下次查询的时候，如果判断先前有个完全一样的查询，会直接从缓存中直接将结果取出，返回给用户，不需要再进行一次数据库查询了。</p>
<p><strong>说明：</strong></p>
<p>对于会话（Session）级别的数据缓存，称之为一级数据缓存，简称一级缓存。</p>
<p><strong>特点：</strong></p>
<ul>
<li><p>一级缓存是默认开启的</p>
</li>
<li><p>一级缓存是基于SqlSession生命周期的</p>
</li>
</ul>
<p><img src="/2021/05/21/Mybatis/mybatis%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/image-20210525183539555.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-comment">SqlSession</span> -- <span class="hljs-comment">DefaultSqlSession</span> <br><span class="hljs-comment">Executor</span>     -- <span class="hljs-comment">BaseExecutor</span> -- <span class="hljs-comment">“PerpetualCache</span> <span class="hljs-comment">localCache”</span><br></code></pre></td></tr></table></figure>

<p><strong>小结：</strong></p>
<p><strong>一级缓存生命周期</strong>：当会话结束时，SqlSession对象及其内部的Executor对象还有PerpetualCache对象也一并释放掉。如果SqlSession调用了close()方法，会释放掉一级缓存PerpetualCache对象，一级缓存将不可用 如果SqlSession调用了clearCache()，会清空PerpetualCache对象中的数据，但是该对象仍可使用 SqlSession中执行了任何一个update操作(update()、delete()、insert()) ，都会清空PerpetualCache对象的数据，但是该对象可以继续使用。</p>
<h4 id="二级缓存"><a href="#二级缓存" class="headerlink" title="二级缓存"></a>二级缓存</h4><p><strong>概述：</strong></p>
<p>一级缓存中，其最大的共享范围就是一个 SqlSession 内部；</p>
<p>如果多个 SqlSession 之间需要共享缓存，则需要使用到<strong>二级缓存</strong>。</p>
<p>开启二级缓存后，会使用 CachingExecutor 装饰 Executor ，进入一级缓存的查询流程前，先在CachingExecutor 进行二级缓存的查询。</p>
<p> <strong>二级缓存示意图</strong></p>
<p><img src="/2021/05/21/Mybatis/mybatis%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/image-20210525184045156.png" srcset="/img/loading.gif" lazyload></p>
<p>开启二级缓存后，执行器Executor会被CachingExecutor包装一层。（装饰器模式） 二级缓存是手动开启的，作用域为sessionfactory 二级缓存则是全局级别的，不同的session共用同一个二级缓存维护二级缓存，只有在提交事务之后二级缓存才会保存 （查询的时候先走二级缓存再走一级缓存【开启二级缓存的条件下】）</p>
<p>二级缓存采用的是<strong>装饰器模式</strong>，在不改变原有类和继承的情况下，通过<strong>包装原对象</strong>去扩展一个新的功能，其中有个属性是 Executor delegate，这里存的就是三种执行器中的一种，默认是SimpleExecutor，可以通过配置替换。</p>
<p><strong>在mysql配置文件中开启二级缓存：</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">settings</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--这个配置使全局的映射器(二级缓存)启用或禁用缓存--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">setting</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;cacheEnabled&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span> /&gt;</span><br>        .....<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">settings</span>&gt;</span><br>    ....<br><span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p><strong>CachingExecutor剖析</strong></p>
<p>org.apache.ibatis.executor.CachingExecutor ，实现 Executor 接口，支持<strong>二级缓存</strong>的 Executor的实现类。</p>
<ul>
<li><p>先从缓存中获取查询结果，存在就返回;</p>
</li>
<li><p>不存在，再委托给Executor delegate去数据库取;</p>
</li>
<li><p>delegate可以是SimpleExecutor、ReuseExecutor、BatchExecutor。 </p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CachingExecutor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Executor</span> </span>&#123;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Executor delegate;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> TransactionalCacheManager tcm = <span class="hljs-keyword">new</span> TransactionalCacheManager();<br><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CachingExecutor</span><span class="hljs-params">(Executor delegate)</span> </span>&#123;<br>    <span class="hljs-keyword">this</span>.delegate = delegate;<br>    delegate.setExecutorWrapper(<span class="hljs-keyword">this</span>);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> Transaction <span class="hljs-title">getTransaction</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> delegate.getTransaction();<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">close</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> forceRollback)</span> </span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// issues #499, #524 and #573</span><br>      <span class="hljs-keyword">if</span> (forceRollback) &#123;<br>        tcm.rollback();<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        tcm.commit();<br>      &#125;<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      delegate.close(forceRollback);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isClosed</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> delegate.isClosed();<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">update</span><span class="hljs-params">(MappedStatement ms, Object parameterObject)</span> <span class="hljs-keyword">throws</span> SQLException </span>&#123;<br>    <span class="hljs-comment">// 如果需要清空缓存，则进行清空</span><br>    flushCacheIfRequired(ms);<br>    <span class="hljs-comment">// 执行 delegate 对应的方法</span><br>    <span class="hljs-keyword">return</span> delegate.update(ms, parameterObject);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;E&gt; <span class="hljs-function">Cursor&lt;E&gt; <span class="hljs-title">queryCursor</span><span class="hljs-params">(MappedStatement ms, Object parameter, RowBounds rowBounds)</span> <span class="hljs-keyword">throws</span> SQLException </span>&#123;<br>    flushCacheIfRequired(ms);<br>    <span class="hljs-keyword">return</span> delegate.queryCursor(ms, parameter, rowBounds);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;E&gt; <span class="hljs-function">List&lt;E&gt; <span class="hljs-title">query</span><span class="hljs-params">(MappedStatement ms, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler)</span> <span class="hljs-keyword">throws</span> SQLException </span>&#123;<br>    <span class="hljs-comment">// 获得 BoundSql 对象</span><br>    BoundSql boundSql = ms.getBoundSql(parameterObject);<br>    <span class="hljs-comment">// 创建 CacheKey 对象</span><br>    CacheKey key = createCacheKey(ms, parameterObject, rowBounds, boundSql);<br>    <span class="hljs-comment">// 查询</span><br>    <span class="hljs-keyword">return</span> query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;E&gt; <span class="hljs-function">List&lt;E&gt; <span class="hljs-title">query</span><span class="hljs-params">(MappedStatement ms, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql)</span></span><br><span class="hljs-function">      <span class="hljs-keyword">throws</span> SQLException </span>&#123;<br>    <span class="hljs-comment">// &lt;1&gt; 获得 Cache 对象，即当前 MappedStatement 对象的二级缓存。</span><br>    Cache cache = ms.getCache();<br>    <span class="hljs-keyword">if</span> (cache != <span class="hljs-keyword">null</span>) &#123;<br>      <span class="hljs-comment">// &lt;2.1&gt; 如果需要清空缓存，则进行清空</span><br>      flushCacheIfRequired(ms);<br>      <span class="hljs-keyword">if</span> (ms.isUseCache() &amp;&amp; resultHandler == <span class="hljs-keyword">null</span>) &#123;<br>        <span class="hljs-comment">// 存储过程相关</span><br>        ensureNoOutParams(ms, boundSql);<br>        <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>        <span class="hljs-comment">// &lt;2.3&gt; 从二级缓存中，获取结果</span><br>        List&lt;E&gt; list = (List&lt;E&gt;) tcm.getObject(cache, key);<br>        <span class="hljs-keyword">if</span> (list == <span class="hljs-keyword">null</span>) &#123;<br>          <span class="hljs-comment">// &lt;2.4.1&gt; 如果不存在，则从数据库中查询</span><br>          list = delegate.query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);<br>          <span class="hljs-comment">// &lt;2.4.2&gt; 缓存结果到二级缓存中</span><br>          tcm.putObject(cache, key, list); <span class="hljs-comment">// issue #578 and #116</span><br>        &#125;<br>        <span class="hljs-comment">// &lt;2.5&gt; 如果存在，则直接返回结果</span><br>        <span class="hljs-keyword">return</span> list;<br>      &#125;<br>    &#125;<br>    <span class="hljs-comment">// &lt;3&gt; 不使用缓存，则从数据库中查询</span><br>    <span class="hljs-keyword">return</span> delegate.query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;BatchResult&gt; <span class="hljs-title">flushStatements</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException </span>&#123;<br>    <span class="hljs-keyword">return</span> delegate.flushStatements();<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">commit</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> required)</span> <span class="hljs-keyword">throws</span> SQLException </span>&#123;<br>    delegate.commit(required);<br>    tcm.commit();<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">rollback</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> required)</span> <span class="hljs-keyword">throws</span> SQLException </span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      delegate.rollback(required);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      <span class="hljs-keyword">if</span> (required) &#123;<br>        tcm.rollback();<br>      &#125;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ensureNoOutParams</span><span class="hljs-params">(MappedStatement ms, BoundSql boundSql)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (ms.getStatementType() == StatementType.CALLABLE) &#123;<br>      <span class="hljs-keyword">for</span> (ParameterMapping parameterMapping : boundSql.getParameterMappings()) &#123;<br>        <span class="hljs-keyword">if</span> (parameterMapping.getMode() != ParameterMode.IN) &#123;<br>          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ExecutorException(<span class="hljs-string">&quot;Caching stored procedures with OUT params is not supported.  Please configure useCache=false in &quot;</span> + ms.getId() + <span class="hljs-string">&quot; statement.&quot;</span>);<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> CacheKey <span class="hljs-title">createCacheKey</span><span class="hljs-params">(MappedStatement ms, Object parameterObject, RowBounds rowBounds, BoundSql boundSql)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> delegate.createCacheKey(ms, parameterObject, rowBounds, boundSql);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isCached</span><span class="hljs-params">(MappedStatement ms, CacheKey key)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> delegate.isCached(ms, key);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">deferLoad</span><span class="hljs-params">(MappedStatement ms, MetaObject resultObject, String property, CacheKey key, Class&lt;?&gt; targetType)</span> </span>&#123;<br>    delegate.deferLoad(ms, resultObject, property, key, targetType);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">clearLocalCache</span><span class="hljs-params">()</span> </span>&#123;<br>    delegate.clearLocalCache();<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">flushCacheIfRequired</span><span class="hljs-params">(MappedStatement ms)</span> </span>&#123;<br>    Cache cache = ms.getCache();<br>    <span class="hljs-keyword">if</span> (cache != <span class="hljs-keyword">null</span> &amp;&amp; ms.isFlushCacheRequired()) &#123;<br>      tcm.clear(cache);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setExecutorWrapper</span><span class="hljs-params">(Executor executor)</span> </span>&#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> UnsupportedOperationException(<span class="hljs-string">&quot;This method should not be called&quot;</span>);<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<ol>
<li><p>获得 Cache 对象，即当前 MappedStatement 对象的<strong>二级缓存</strong></p>
</li>
<li><p>如果没有 Cache 对象，说明该 MappedStatement 对象，未设置<strong>二级缓存</strong>，则调用 delegate属性的 #query(…) 方法，直接从数据库中查询。</p>
</li>
<li><p>如果有 Cache 对象，说明该 MappedStatement 对象，有设置<strong>二级缓存</strong>： </p>
</li>
</ol>
<h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><ul>
<li><p>在优化系统性能时，优化数据库性能是非常重要的一个环节，而添加缓存则是优化数据库时最有效的手段之一。</p>
</li>
<li><p>正确、合理地使用缓存可以将一部分数据库请求拦截在缓存这一层。</p>
</li>
<li><p>MyBatis 中提供的<strong>一级缓存和二级缓存</strong>，而这两级缓存都是依赖于基础支持层中的缓存模块实现的。这里需要注意的是，在分布式环境下，由于默认的MyBatis Cache实现都是基于本地的，<strong>占用系统资源，并且有一定安全性问题</strong>，建议直接使用Redis、Memcached等分布式缓存可能成本更低，安全性也更高。</p>
</li>
</ul>
<h3 id="SQL执行过程"><a href="#SQL执行过程" class="headerlink" title="SQL执行过程"></a>SQL执行过程</h3><h4 id="核心执行组件"><a href="#核心执行组件" class="headerlink" title="核心执行组件"></a>核心执行组件</h4><p><img src="/2021/05/21/Mybatis/mybatis%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/image-20210525190449384.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="SQL执行的入口分析"><a href="#SQL执行的入口分析" class="headerlink" title="SQL执行的入口分析"></a>SQL执行的入口分析</h4><h5 id="为Mapper接口创建代理对象"><a href="#为Mapper接口创建代理对象" class="headerlink" title="为Mapper接口创建代理对象"></a>为Mapper接口创建代理对象</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 方式1</span><br>User user = session.selectOne(<span class="hljs-string">&quot;com.itheima.dao.UserMapper.findUserById&quot;</span>, <span class="hljs-number">101</span>); <br><span class="hljs-comment">// 方式2</span><br>UserMapper mapper = session.getMapper(UserMapper.class); List&lt;User&gt; userList = mapper.findAll();<br></code></pre></td></tr></table></figure>

<h5 id="执行代理逻辑"><a href="#执行代理逻辑" class="headerlink" title="执行代理逻辑"></a>执行代理逻辑</h5><p>方式1入口分析</p>
<p>sqlSessionFactory默认生成的SqlSession为DefaultSqlSession类型，其中的selectOne()方法也会调用到selectList()方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> &lt;E&gt; <span class="hljs-function">List&lt;E&gt; <span class="hljs-title">selectList</span><span class="hljs-params">(String statement, Object parameter, RowBounds rowBounds)</span> </span>&#123;<br>  <span class="hljs-keyword">try</span> &#123;<br>    MappedStatement ms = configuration.getMappedStatement(statement);<br>    <span class="hljs-comment">// CURD操作是交给Excetor去处理的</span><br>    <span class="hljs-keyword">return</span> executor.query(ms, wrapCollection(parameter), rowBounds, Executor.NO_RESULT_HANDLER);<br>  &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>    <span class="hljs-keyword">throw</span> ExceptionFactory.wrapException(<span class="hljs-string">&quot;Error querying database.  Cause: &quot;</span> + e, e);<br>  &#125; <span class="hljs-keyword">finally</span> &#123;<br>    ErrorContext.instance().reset();<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>方式2入口分析</p>
<p>DefaultSqlSession类获取代理对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-function">T <span class="hljs-title">getMapper</span><span class="hljs-params">(Class&lt;T&gt; type)</span> </span>&#123;<br>  <span class="hljs-keyword">return</span> configuration.getMapper(type, <span class="hljs-keyword">this</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>Configuration类获取代理对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-function">T <span class="hljs-title">getMapper</span><span class="hljs-params">(Class&lt;T&gt; type, SqlSession sqlSession)</span> </span>&#123;<br>  <span class="hljs-keyword">return</span> mapperRegistry.getMapper(type, sqlSession);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>MapperRegistry类中通过mapperProxyFactory.newInstance(sqlSession)创建代理对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-function">T <span class="hljs-title">getMapper</span><span class="hljs-params">(Class&lt;T&gt; type, SqlSession sqlSession)</span> </span>&#123;<br>  <span class="hljs-comment">//从缓存中获取该Mapper接口的代理工厂对象</span><br>  <span class="hljs-keyword">final</span> MapperProxyFactory&lt;T&gt; mapperProxyFactory = (MapperProxyFactory&lt;T&gt;) knownMappers.get(type);<br>  <span class="hljs-comment">//如果该Mapper接口没有注册过，则抛异常</span><br>  <span class="hljs-keyword">if</span> (mapperProxyFactory == <span class="hljs-keyword">null</span>) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BindingException(<span class="hljs-string">&quot;Type &quot;</span> + type + <span class="hljs-string">&quot; is not known to the MapperRegistry.&quot;</span>);<br>  &#125;<br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-comment">//使用代理工厂创建Mapper接口的代理对象</span><br>    <span class="hljs-keyword">return</span> mapperProxyFactory.newInstance(sqlSession);<br>  &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BindingException(<span class="hljs-string">&quot;Error getting mapper instance. Cause: &quot;</span> + e, e);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>mapperProxyFactory.newInstance(sqlSession)中会创建MapperProxy对象并返回，MapperProxy对象中的inovoke方法会在Mapper的方法调用时执行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;<br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-keyword">if</span> (Object.class.equals(method.getDeclaringClass())) &#123;<br>      <span class="hljs-comment">//如果是Object方法，则调用方法本身</span><br>      <span class="hljs-keyword">return</span> method.invoke(<span class="hljs-keyword">this</span>, args);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">//调用接口方法：根据被调用接口的Method对象，从缓存中获取MapperMethodInvoker对象</span><br>      <span class="hljs-comment">//mapper接口中的每一个方法都对应一个MapperMethodInvoker对象，而MapperMethodInvoker对象里面的MapperMethod保存着对应的SQL信息和返回类型以完成SQL调用</span><br>      <span class="hljs-keyword">return</span> cachedInvoker(method).invoke(proxy, method, args, sqlSession);<br>    &#125;<br>  &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;<br>    <span class="hljs-keyword">throw</span> ExceptionUtil.unwrapThrowable(t);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>cachedInvoker方法会获取缓存中MapperMethodInvoker，如果没有则创建一个，MapperMethodInvoker内部封装着MethodHandler</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> MapperMethodInvoker <span class="hljs-title">cachedInvoker</span><span class="hljs-params">(Method method)</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;<br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-comment">// A workaround for https://bugs.openjdk.java.net/browse/JDK-8161372</span><br>    <span class="hljs-comment">// It should be removed once the fix is backported to Java 8 or</span><br>    <span class="hljs-comment">// MyBatis drops Java 8 support. See gh-1929</span><br>    MapperMethodInvoker invoker = methodCache.get(method);<br>    <span class="hljs-keyword">if</span> (invoker != <span class="hljs-keyword">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> invoker;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> methodCache.computeIfAbsent(method, m -&gt; &#123;<br>      <span class="hljs-keyword">if</span> (m.isDefault()) &#123;<br>        <span class="hljs-comment">//如果调用接口的是默认方法（default方法）</span><br>        <span class="hljs-keyword">try</span> &#123;<br>          <span class="hljs-keyword">if</span> (privateLookupInMethod == <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DefaultMethodInvoker(getMethodHandleJava8(method));<br>          &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DefaultMethodInvoker(getMethodHandleJava9(method));<br>          &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException | InstantiationException | InvocationTargetException<br>          | NoSuchMethodException e) &#123;<br>          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);<br>        &#125;<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">//如果调用的普通方法（非default方法），则创建一个PlainMethodInvoker并放入缓存，其中MapperMethod保存对应接口方法的SQL以及入参和出参的数据类型等信息</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> PlainMethodInvoker(<span class="hljs-keyword">new</span> MapperMethod(mapperInterface, method, sqlSession.getConfiguration()));<br>      &#125;<br>    &#125;);<br>  &#125; <span class="hljs-keyword">catch</span> (RuntimeException re) &#123;<br>    Throwable cause = re.getCause();<br>    <span class="hljs-keyword">throw</span> cause == <span class="hljs-keyword">null</span> ? re : cause;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>PainMethodInvoker为MapperProxy的内部类，当cacheInvoker返回了PalinMethodInvoker实例之后，紧接着调用了这个实例的invoke方法 代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args, SqlSession sqlSession)</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;<br>  <span class="hljs-comment">//Mybatis实现接口方法的核心: MapperMethod::execute方法</span><br>  <span class="hljs-keyword">return</span> mapperMethod.execute(sqlSession, args);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>MapperMethod中的invoke方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">execute</span><span class="hljs-params">(SqlSession sqlSession, Object[] args)</span> </span>&#123;<br>  Object result;<br>  <span class="hljs-keyword">switch</span> (command.getType()) &#123;<br>    <span class="hljs-keyword">case</span> INSERT: &#123;<br>      <span class="hljs-comment">// 将args进行解析，如果是多个参数则根据@Param注解指定名称将参数转换为Map，如果是封装实体则不转换</span><br>      Object param = method.convertArgsToSqlCommandParam(args);<br>      result = rowCountResult(sqlSession.insert(command.getName(), param));<br>      <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-keyword">case</span> UPDATE: &#123;<br>      Object param = method.convertArgsToSqlCommandParam(args);<br>      result = rowCountResult(sqlSession.update(command.getName(), param));<br>      <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-keyword">case</span> DELETE: &#123;<br>      Object param = method.convertArgsToSqlCommandParam(args);<br>      result = rowCountResult(sqlSession.delete(command.getName(), param));<br>      <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-keyword">case</span> SELECT:<br>      <span class="hljs-keyword">if</span> (method.returnsVoid() &amp;&amp; method.hasResultHandler()) &#123;<br>        executeWithResultHandler(sqlSession, args);<br>        result = <span class="hljs-keyword">null</span>;<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (method.returnsMany()) &#123;<br>        result = executeForMany(sqlSession, args);<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (method.returnsMap()) &#123;<br>        result = executeForMap(sqlSession, args);<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (method.returnsCursor()) &#123;<br>        result = executeForCursor(sqlSession, args);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// 解析参数，由于SqlSession.selectOne方法只接受一个参数，</span><br>        <span class="hljs-comment">// 但是Mapper中可能传入多个参数，比如通过@Param注解指定的参数，</span><br>        <span class="hljs-comment">// 所以这里需要将Mapper接口方法中的多个参数转化为一个ParamMap</span><br>        <span class="hljs-comment">// 如果是传入的单个封装实体，就直接返回实体</span><br>        Object param = method.convertArgsToSqlCommandParam(args);<br>        <span class="hljs-comment">//可以看到动态代理最后还是使用SqlSession操作数据库的</span><br>        result = sqlSession.selectOne(command.getName(), param);<br>        <span class="hljs-keyword">if</span> (method.returnsOptional()<br>            &amp;&amp; (result == <span class="hljs-keyword">null</span> || !method.getReturnType().equals(result.getClass()))) &#123;<br>          result = Optional.ofNullable(result);<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> FLUSH:<br>      result = sqlSession.flushStatements();<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">default</span>:<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BindingException(<span class="hljs-string">&quot;Unknown execution method for: &quot;</span> + command.getName());<br>  &#125;<br>  <span class="hljs-keyword">if</span> (result == <span class="hljs-keyword">null</span> &amp;&amp; method.getReturnType().isPrimitive() &amp;&amp; !method.returnsVoid()) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BindingException(<span class="hljs-string">&quot;Mapper method &#x27;&quot;</span> + command.getName()<br>        + <span class="hljs-string">&quot; attempted to return null from a method with a primitive return type (&quot;</span> + method.getReturnType() + <span class="hljs-string">&quot;).&quot;</span>);<br>  &#125;<br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>

<p> execute()方法最终都会走到sqlSession方法，比如executeForMany()方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> &lt;E&gt; <span class="hljs-function">Object <span class="hljs-title">executeForMany</span><span class="hljs-params">(SqlSession sqlSession, Object[] args)</span> </span>&#123;<br>  List&lt;E&gt; result;<br>  Object param = method.convertArgsToSqlCommandParam(args);<br>  <span class="hljs-keyword">if</span> (method.hasRowBounds()) &#123;<br>    RowBounds rowBounds = method.extractRowBounds(args);<br>    result = sqlSession.selectList(command.getName(), param, rowBounds);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    result = sqlSession.selectList(command.getName(), param);<br>  &#125;<br>  <span class="hljs-comment">// issue #510 Collections &amp; arrays support</span><br>  <span class="hljs-keyword">if</span> (!method.getReturnType().isAssignableFrom(result.getClass())) &#123;<br>    <span class="hljs-keyword">if</span> (method.getReturnType().isArray()) &#123;<br>      <span class="hljs-keyword">return</span> convertToArray(result);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> convertToDeclaredCollection(sqlSession.getConfiguration(), result);<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="查询语句的执行过程分析"><a href="#查询语句的执行过程分析" class="headerlink" title="查询语句的执行过程分析"></a>查询语句的执行过程分析</h4><h5 id="selectOne方法分析"><a href="#selectOne方法分析" class="headerlink" title="selectOne方法分析"></a>selectOne方法分析</h5><p>DefaultSqlSession类中的selectOne方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-function">T <span class="hljs-title">selectOne</span><span class="hljs-params">(String statement, Object parameter)</span> </span>&#123;<br>  <span class="hljs-comment">// Popular vote was to return null on 0 results and throw exception on too many.</span><br>  <span class="hljs-comment">// selectOne()会调用selectList()。</span><br>  List&lt;T&gt; list = <span class="hljs-keyword">this</span>.selectList(statement, parameter);<br>  <span class="hljs-keyword">if</span> (list.size() == <span class="hljs-number">1</span>) &#123;<br>    <span class="hljs-keyword">return</span> list.get(<span class="hljs-number">0</span>);<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (list.size() &gt; <span class="hljs-number">1</span>) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> TooManyResultsException(<span class="hljs-string">&quot;Expected one result (or null) to be returned by selectOne(), but found: &quot;</span> + list.size());<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>selectOne方法会调用其中的selectList方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> &lt;E&gt; <span class="hljs-function">List&lt;E&gt; <span class="hljs-title">selectList</span><span class="hljs-params">(String statement, Object parameter, RowBounds rowBounds)</span> </span>&#123;<br>  <span class="hljs-keyword">try</span> &#123;<br>    MappedStatement ms = configuration.getMappedStatement(statement);<br>    <span class="hljs-comment">// CURD操作是交给Excetor去处理的</span><br>    <span class="hljs-keyword">return</span> executor.query(ms, wrapCollection(parameter), rowBounds, Executor.NO_RESULT_HANDLER);<br>  &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>    <span class="hljs-keyword">throw</span> ExceptionFactory.wrapException(<span class="hljs-string">&quot;Error querying database.  Cause: &quot;</span> + e, e);<br>  &#125; <span class="hljs-keyword">finally</span> &#123;<br>    ErrorContext.instance().reset();<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="sql获取"><a href="#sql获取" class="headerlink" title="sql获取"></a>sql获取</h5><p>selectList方法最终会调用到Executor接口的query方法</p>
<p>以下为BaseExecutor中的query方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> &lt;E&gt; <span class="hljs-function">List&lt;E&gt; <span class="hljs-title">query</span><span class="hljs-params">(MappedStatement ms, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler)</span> <span class="hljs-keyword">throws</span> SQLException </span>&#123;<br>  <span class="hljs-comment">// 获得 BoundSql 对象，比如 select * from xxx</span><br>  BoundSql boundSql = ms.getBoundSql(parameterObject);<br>  <span class="hljs-comment">// 创建 CacheKey 对象</span><br>  CacheKey key = createCacheKey(ms, parameterObject, rowBounds, boundSql);<br>  <span class="hljs-comment">// 查询</span><br>  <span class="hljs-keyword">return</span> query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> &lt;E&gt; <span class="hljs-function">List&lt;E&gt; <span class="hljs-title">query</span><span class="hljs-params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql)</span> <span class="hljs-keyword">throws</span> SQLException </span>&#123;<br>  ErrorContext.instance().resource(ms.getResource()).activity(<span class="hljs-string">&quot;executing a query&quot;</span>).object(ms.getId());<br>  <span class="hljs-keyword">if</span> (closed) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ExecutorException(<span class="hljs-string">&quot;Executor was closed.&quot;</span>);<br>  &#125;<br>  <span class="hljs-keyword">if</span> (queryStack == <span class="hljs-number">0</span> &amp;&amp; ms.isFlushCacheRequired()) &#123;<br>    clearLocalCache();<br>  &#125;<br>  List&lt;E&gt; list;<br>  <span class="hljs-keyword">try</span> &#123;<br>    queryStack++;<br>    <span class="hljs-comment">//localCache是一级缓存，如果找不到就调用queryFromDatabase从数据库中查找</span><br>    list = resultHandler == <span class="hljs-keyword">null</span> ? (List&lt;E&gt;) localCache.getObject(key) : <span class="hljs-keyword">null</span>;<br>    <span class="hljs-keyword">if</span> (list != <span class="hljs-keyword">null</span>) &#123;<br>      handleLocallyCachedOutputParameters(ms, key, parameter, boundSql);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      list = queryFromDatabase(ms, parameter, rowBounds, resultHandler, key, boundSql);<br>    &#125;<br>  &#125; <span class="hljs-keyword">finally</span> &#123;<br>    queryStack--;<br>  &#125;<br>  <span class="hljs-keyword">if</span> (queryStack == <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-keyword">for</span> (DeferredLoad deferredLoad : deferredLoads) &#123;<br>      deferredLoad.load();<br>    &#125;<br>    <span class="hljs-comment">// issue #601</span><br>    deferredLoads.clear();<br>    <span class="hljs-keyword">if</span> (configuration.getLocalCacheScope() == LocalCacheScope.STATEMENT) &#123;<br>      <span class="hljs-comment">// issue #482</span><br>      clearLocalCache();<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> list;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>如果没有获取到缓存，就会调用queryFromDatabase方法来执行查询</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> &lt;E&gt; <span class="hljs-function">List&lt;E&gt; <span class="hljs-title">queryFromDatabase</span><span class="hljs-params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql)</span> <span class="hljs-keyword">throws</span> SQLException </span>&#123;<br>  List&lt;E&gt; list;<br>  localCache.putObject(key, EXECUTION_PLACEHOLDER);<br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-comment">// 查询</span><br>    list = doQuery(ms, parameter, rowBounds, resultHandler, boundSql);<br>  &#125; <span class="hljs-keyword">finally</span> &#123;<br>    localCache.removeObject(key);<br>  &#125;<br>  localCache.putObject(key, list);<br>  <span class="hljs-keyword">if</span> (ms.getStatementType() == StatementType.CALLABLE) &#123;<br>    localOutputParameterCache.putObject(key, parameter);<br>  &#125;<br>  <span class="hljs-keyword">return</span> list;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>SimpleExecutor中的doQuery方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> &lt;E&gt; <span class="hljs-function">List&lt;E&gt; <span class="hljs-title">doQuery</span><span class="hljs-params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> <span class="hljs-keyword">throws</span> SQLException </span>&#123;<br>  Statement stmt = <span class="hljs-keyword">null</span>;<br>  <span class="hljs-keyword">try</span> &#123;<br>    Configuration configuration = ms.getConfiguration();<br>    <span class="hljs-comment">// &lt;1&gt; 创建 StatementHandler 对象</span><br>    StatementHandler handler = configuration.newStatementHandler(wrapper, ms, parameter, rowBounds, resultHandler, boundSql);<br>    <span class="hljs-comment">// &lt;2&gt; 初始化 StatementHandler 对象，包括SQL查询参数的设置</span><br>    stmt = prepareStatement(handler, ms.getStatementLog());<br>    <span class="hljs-comment">// &lt;3&gt; 执行 StatementHandler ，进行SQL查询操作和结果集的封装</span><br>    <span class="hljs-keyword">return</span> handler.query(stmt, resultHandler);<br>  &#125; <span class="hljs-keyword">finally</span> &#123;<br>    <span class="hljs-comment">// &lt;4&gt; 关闭 StatementHandler 对象</span><br>    closeStatement(stmt);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="参数设置"><a href="#参数设置" class="headerlink" title="参数设置"></a>参数设置</h5><p>SimpleExecutor中的prepareStatement方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> Statement <span class="hljs-title">prepareStatement</span><span class="hljs-params">(StatementHandler handler, Log statementLog)</span> <span class="hljs-keyword">throws</span> SQLException </span>&#123;<br>  Statement stmt;<br>  <span class="hljs-comment">// &lt;2.1&gt; 获得 Connection 对象</span><br>  Connection connection = getConnection(statementLog);<br>  <span class="hljs-comment">// &lt;2.2&gt; 创建 Statement 或 PrepareStatement 对象</span><br>  stmt = handler.prepare(connection, transaction.getTimeout());<br>  <span class="hljs-comment">// &lt;2.3&gt; 设置 SQL 上的参数，例如 PrepareStatement 对象上的占位符</span><br>  handler.parameterize(stmt);<br>  <span class="hljs-keyword">return</span> stmt;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>RoutingStatementHandler、PreparedStatementHandler中的parameterize方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">parameterize</span><span class="hljs-params">(Statement statement)</span> <span class="hljs-keyword">throws</span> SQLException </span>&#123;<br>  parameterHandler.setParameters((PreparedStatement) statement);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>DefaultParameterHandler中的setParameters方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setParameters</span><span class="hljs-params">(PreparedStatement ps)</span> </span>&#123;<br>  ErrorContext.instance().activity(<span class="hljs-string">&quot;setting parameters&quot;</span>).object(mappedStatement.getParameterMap().getId());<br>  List&lt;ParameterMapping&gt; parameterMappings = boundSql.getParameterMappings();<br>  <span class="hljs-keyword">if</span> (parameterMappings != <span class="hljs-keyword">null</span>) &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; parameterMappings.size(); i++) &#123;<br>      ParameterMapping parameterMapping = parameterMappings.get(i);<br>      <span class="hljs-keyword">if</span> (parameterMapping.getMode() != ParameterMode.OUT) &#123;<br>        Object value;<br>        String propertyName = parameterMapping.getProperty();<br>        <span class="hljs-keyword">if</span> (boundSql.hasAdditionalParameter(propertyName)) &#123; <span class="hljs-comment">// issue #448 ask first for additional params</span><br>          value = boundSql.getAdditionalParameter(propertyName);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (parameterObject == <span class="hljs-keyword">null</span>) &#123;<br>          value = <span class="hljs-keyword">null</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (typeHandlerRegistry.hasTypeHandler(parameterObject.getClass())) &#123;<br>          value = parameterObject;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          MetaObject metaObject = configuration.newMetaObject(parameterObject);<br>          value = metaObject.getValue(propertyName);<br>        &#125;<br>        TypeHandler typeHandler = parameterMapping.getTypeHandler();<br>        JdbcType jdbcType = parameterMapping.getJdbcType();<br>        <span class="hljs-keyword">if</span> (value == <span class="hljs-keyword">null</span> &amp;&amp; jdbcType == <span class="hljs-keyword">null</span>) &#123;<br>          jdbcType = configuration.getJdbcTypeForNull();<br>        &#125;<br>        <span class="hljs-keyword">try</span> &#123;<br>          typeHandler.setParameter(ps, i + <span class="hljs-number">1</span>, value, jdbcType);<br>        &#125; <span class="hljs-keyword">catch</span> (TypeException | SQLException e) &#123;<br>          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> TypeException(<span class="hljs-string">&quot;Could not set parameters for mapping: &quot;</span> + parameterMapping + <span class="hljs-string">&quot;. Cause: &quot;</span> + e, e);<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="SQL执行和结果集的封装"><a href="#SQL执行和结果集的封装" class="headerlink" title="SQL执行和结果集的封装"></a>SQL执行和结果集的封装</h5><p>RoutingStatementHandler中的query方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> &lt;E&gt; <span class="hljs-function">List&lt;E&gt; <span class="hljs-title">query</span><span class="hljs-params">(Statement statement, ResultHandler resultHandler)</span> <span class="hljs-keyword">throws</span> SQLException </span>&#123;<br>  <span class="hljs-keyword">return</span> delegate.query(statement, resultHandler);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>PreparedStatementHandler中的query方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> &lt;E&gt; <span class="hljs-function">List&lt;E&gt; <span class="hljs-title">query</span><span class="hljs-params">(Statement statement, ResultHandler resultHandler)</span> <span class="hljs-keyword">throws</span> SQLException </span>&#123;<br>  <span class="hljs-comment">// 这里就到了熟悉的PreparedStatement了</span><br>  PreparedStatement ps = (PreparedStatement) statement;<br>  <span class="hljs-comment">// 执行SQL查询操作</span><br>  ps.execute();<br>  <span class="hljs-comment">// 结果交给ResultHandler来处理</span><br>  <span class="hljs-keyword">return</span> resultSetHandler.handleResultSets(ps);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>DefaultResultSetHandler类（封装返回值，将查询结果封装成Object对象） </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;Object&gt; <span class="hljs-title">handleResultSets</span><span class="hljs-params">(Statement stmt)</span> <span class="hljs-keyword">throws</span> SQLException </span>&#123;<br>  ErrorContext.instance().activity(<span class="hljs-string">&quot;handling results&quot;</span>).object(mappedStatement.getId());<br><br>  <span class="hljs-keyword">final</span> List&lt;Object&gt; multipleResults = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br><br>  <span class="hljs-keyword">int</span> resultSetCount = <span class="hljs-number">0</span>;<br>  ResultSetWrapper rsw = getFirstResultSet(stmt);<br><br>  List&lt;ResultMap&gt; resultMaps = mappedStatement.getResultMaps();<br>  <span class="hljs-keyword">int</span> resultMapCount = resultMaps.size();<br>  validateResultMapsCount(rsw, resultMapCount);<br>  <span class="hljs-keyword">while</span> (rsw != <span class="hljs-keyword">null</span> &amp;&amp; resultMapCount &gt; resultSetCount) &#123;<br>    ResultMap resultMap = resultMaps.get(resultSetCount);<br>    handleResultSet(rsw, resultMap, multipleResults, <span class="hljs-keyword">null</span>);<br>    rsw = getNextResultSet(stmt);<br>    cleanUpAfterHandlingResultSet();<br>    resultSetCount++;<br>  &#125;<br><br>  String[] resultSets = mappedStatement.getResultSets();<br>  <span class="hljs-keyword">if</span> (resultSets != <span class="hljs-keyword">null</span>) &#123;<br>    <span class="hljs-keyword">while</span> (rsw != <span class="hljs-keyword">null</span> &amp;&amp; resultSetCount &lt; resultSets.length) &#123;<br>      ResultMapping parentMapping = nextResultMaps.get(resultSets[resultSetCount]);<br>      <span class="hljs-keyword">if</span> (parentMapping != <span class="hljs-keyword">null</span>) &#123;<br>        String nestedResultMapId = parentMapping.getNestedResultMapId();<br>        ResultMap resultMap = configuration.getResultMap(nestedResultMapId);<br>        handleResultSet(rsw, resultMap, <span class="hljs-keyword">null</span>, parentMapping);<br>      &#125;<br>      rsw = getNextResultSet(stmt);<br>      cleanUpAfterHandlingResultSet();<br>      resultSetCount++;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> collapseSingleResultList(multipleResults);<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="整体流程"><a href="#整体流程" class="headerlink" title="整体流程"></a>整体流程</h5><p><img src="/2021/05/21/Mybatis/mybatis%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/image-20210525213818893.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="更新语句的执行过程分析"><a href="#更新语句的执行过程分析" class="headerlink" title="更新语句的执行过程分析"></a>更新语句的执行过程分析</h4><ol>
<li><p>Executor 的 update 方法分析</p>
<ul>
<li>insert、update 和 delete 操作都会清空一二级缓存</li>
</ul>
</li>
<li><p>doUpdate 方法</p>
</li>
<li><p>PreparedStatementHandler 的 update 方法</p>
<ul>
<li>默认是创建PreparedStatementHandler，然后执行prepareStatement方法。</li>
<li>执行结果为受影响行数</li>
<li>执行更新语句的SQL</li>
</ul>
</li>
</ol>
<h5 id="sqlsession增删改方法分析"><a href="#sqlsession增删改方法分析" class="headerlink" title="sqlsession增删改方法分析"></a>sqlsession增删改方法分析</h5><p>DefaultSqlsession中的insert、delete、update都是通过调用update语句进行的相关逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">update</span><span class="hljs-params">(String statement, Object parameter)</span> </span>&#123;<br>  <span class="hljs-keyword">try</span> &#123;<br>    dirty = <span class="hljs-keyword">true</span>;<br>    MappedStatement ms = configuration.getMappedStatement(statement);<br>    <span class="hljs-comment">// 增删改 最终底层都是 update</span><br>    <span class="hljs-keyword">return</span> executor.update(ms, wrapCollection(parameter));<br>  &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>    <span class="hljs-keyword">throw</span> ExceptionFactory.wrapException(<span class="hljs-string">&quot;Error updating database.  Cause: &quot;</span> + e, e);<br>  &#125; <span class="hljs-keyword">finally</span> &#123;<br>    ErrorContext.instance().reset();<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="sql获取-1"><a href="#sql获取-1" class="headerlink" title="sql获取"></a>sql获取</h5><p>CachingExecutor中的update方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">update</span><span class="hljs-params">(MappedStatement ms, Object parameterObject)</span> <span class="hljs-keyword">throws</span> SQLException </span>&#123;<br>  <span class="hljs-comment">// 如果需要清空缓存，则进行清空</span><br>  flushCacheIfRequired(ms);<br>  <span class="hljs-comment">// 执行 delegate 对应的方法</span><br>  <span class="hljs-keyword">return</span> delegate.update(ms, parameterObject);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>BaseExecutor中的update方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">update</span><span class="hljs-params">(MappedStatement ms, Object parameter)</span> <span class="hljs-keyword">throws</span> SQLException </span>&#123;<br>  ErrorContext.instance().resource(ms.getResource()).activity(<span class="hljs-string">&quot;executing an update&quot;</span>).object(ms.getId());<br>  <span class="hljs-comment">// &lt;1&gt; 已经关闭，则抛出 ExecutorException 异常</span><br>  <span class="hljs-keyword">if</span> (closed) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ExecutorException(<span class="hljs-string">&quot;Executor was closed.&quot;</span>);<br>  &#125;<br>  <span class="hljs-comment">// &lt;2&gt; 清空 LocalCache 一级缓存</span><br>  clearLocalCache();<br>  <span class="hljs-comment">// &lt;3&gt; 执行写操作</span><br>  <span class="hljs-keyword">return</span> doUpdate(ms, parameter);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>SimpleExecutor中的doUpdate方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">doUpdate</span><span class="hljs-params">(MappedStatement ms, Object parameter)</span> <span class="hljs-keyword">throws</span> SQLException </span>&#123;<br>  Statement stmt = <span class="hljs-keyword">null</span>;<br>  <span class="hljs-keyword">try</span> &#123;<br>    Configuration configuration = ms.getConfiguration();<br>    <span class="hljs-comment">// &lt;1&gt; 创建 StatementHandler 对象</span><br>    StatementHandler handler = configuration.newStatementHandler(<span class="hljs-keyword">this</span>, ms, parameter, RowBounds.DEFAULT, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>);<br>    <span class="hljs-comment">// &lt;2&gt; 初始化 StatementHandler 对象，并进行参数映射</span><br>    stmt = prepareStatement(handler, ms.getStatementLog());<br>    <span class="hljs-comment">// &lt;3&gt; 执行 StatementHandler，进行具体sql指令</span><br>    <span class="hljs-keyword">return</span> handler.update(stmt);<br>  &#125; <span class="hljs-keyword">finally</span> &#123;<br>    <span class="hljs-comment">// &lt;4&gt; 关闭 StatementHandler 对象</span><br>    closeStatement(stmt);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="SQL执行"><a href="#SQL执行" class="headerlink" title="SQL执行"></a>SQL执行</h5><p>RoutingStatementHandler.update</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">update</span><span class="hljs-params">(Statement statement)</span> <span class="hljs-keyword">throws</span> SQLException </span>&#123;<br>  <span class="hljs-keyword">return</span> delegate.update(statement);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>PreparedStatementHandler.update</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">update</span><span class="hljs-params">(Statement statement)</span> <span class="hljs-keyword">throws</span> SQLException </span>&#123;<br>  <span class="hljs-comment">// 这里就是底层JDBC的PreparedStatement 操作了</span><br>  PreparedStatement ps = (PreparedStatement) statement;<br>  <span class="hljs-comment">// 执行SQL增删改操作</span><br>  ps.execute();<br>  <span class="hljs-comment">// 获取影响的行数</span><br>  <span class="hljs-keyword">int</span> rows = ps.getUpdateCount();<br>  Object parameterObject = boundSql.getParameterObject();<br>  KeyGenerator keyGenerator = mappedStatement.getKeyGenerator();<br>  keyGenerator.processAfter(executor, mappedStatement, ps, parameterObject);<br>  <span class="hljs-comment">// 返回影响的行数</span><br>  <span class="hljs-keyword">return</span> rows;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h5><p>mybatis执行SQL的流程都是</p>
<ol>
<li><p>根据statement字符串从confifiguration中获取对应的mappedStatement；</p>
</li>
<li><p>根据获取的mappedStatement创建相应的Statement实例；</p>
</li>
<li><p>根据传入的参数对statement实例进行参数设置；</p>
</li>
<li><p>执行statement并执行后置操作；</p>
</li>
</ol>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Mybatis/" class="category-chain-item">Mybatis</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/mybatis/">#mybatis</a>
      
        <a href="/tags/%E6%BA%90%E7%A0%81/">#源码</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>mybatis源码剖析</div>
      <div>https://zgc97107.github.io/2021/05/21/Mybatis/mybatis源码剖析/</div>
    </div>
    <div class="license-meta">
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2021年5月21日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/05/25/%E5%88%86%E5%B8%83%E5%BC%8F%E5%BC%80%E5%8F%91%E6%8A%80%E6%9C%AF/%E9%AB%98%E5%B9%B6%E5%8F%91%E8%AE%A2%E7%A5%A8%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90/" title="高并发订票系统分析">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">高并发订票系统分析</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/04/27/Dubbo/dubbo%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/" title="Dubbo源码剖析">
                        <span class="hidden-mobile">Dubbo源码剖析</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
