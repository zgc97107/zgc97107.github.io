

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/blog/img/favicon.png">
  <link rel="icon" type="image/png" href="/blog/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="">
  <meta name="keywords" content="">
  <title>Springå®ä¾‹åŒ–Beançš„è¿‡ç¨‹ - ğŸğŸŠ&#39;s blog</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/blog/lib/hint/hint.min.css" />

  
    
    <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/github-gist.min.css" />
  

  


<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_6peoq002giu.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_pjno9b9zyxs.css">


<link  rel="stylesheet" href="/blog/css/main.css" />

<!-- è‡ªå®šä¹‰æ ·å¼ä¿æŒåœ¨æœ€åº•éƒ¨ -->


  <script  src="/blog/js/utils.js" ></script>
  <script  src="/blog/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 4.2.1"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/blog/">&nbsp;<strong>ğŸğŸŠ's blog</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/">
                <i class="iconfont icon-home-fill"></i>
                ä¸»é¡µ
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/archives/">
                <i class="iconfont icon-archive-fill"></i>
                å½’æ¡£
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/categories/">
                <i class="iconfont icon-category-fill"></i>
                åˆ†ç±»
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/tags/">
                <i class="iconfont icon-tags-fill"></i>
                æ ‡ç­¾
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/about/">
                <i class="iconfont icon-user-fill"></i>
                å…³äº
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax=true
         style="background: url('/blog/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container page-header text-center fade-in-up">
            <span class="h2" id="subtitle">
              
            </span>

            
              
  <div class="mt-3 post-meta">
    <i class="iconfont icon-date-fill" aria-hidden="true"></i>
    <time datetime="2020-04-15 21:09" pubdate>
      2020å¹´4æœˆ15æ—¥ æ™šä¸Š
    </time>
  </div>


<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      15k å­—
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      241
       åˆ†é’Ÿ
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto" id="post">
            <!-- SEO header -->
            <h1 style="display: none">Springå®ä¾‹åŒ–Beançš„è¿‡ç¨‹</h1>
            
            <div class="markdown-body" id="post-body">
              <h2 id="DeanDefinitionç®€ä»‹"><a href="#DeanDefinitionç®€ä»‹" class="headerlink" title="DeanDefinitionç®€ä»‹"></a>DeanDefinitionç®€ä»‹</h2><p>BeanDefinitionåœ¨springä¸­è´¯ç©¿å§‹ç»ˆï¼Œspringè¦æ ¹æ®BeanDefinitonå¯¹è±¡æ¥å®ä¾‹åŒ–beanã€‚åœ¨å®ä¾‹åŒ–ä¹‹å‰ï¼Œéœ€è¦è§£æbeanæ ‡ç­¾å¹¶å°è£…æˆBeanDefinitonå¯¹è±¡ã€‚</p>
<h3 id="BeanDefinitionå®ç°ç±»"><a href="#BeanDefinitionå®ç°ç±»" class="headerlink" title="BeanDefinitionå®ç°ç±»"></a>BeanDefinitionå®ç°ç±»</h3><ul>
<li>ChildBeanDefinitionï¼šChildBeanDefinitioå¯ä»¥ç»§æ‰¿parent bean definitionçš„è®¾ç½®ï¼Œå¯¹RootBeanDefinition æœ‰ä¸€å®šçš„ä¾èµ–å…³ç³»ã€‚ ChildBeanDefinitionå¯ä»¥ç»§æ‰¿çˆ¶ç±»çš„æ„é€ å‚æ•°å€¼ï¼Œå±æ€§å€¼å¹¶å¯ä»¥é‡å†™çˆ¶ç±»çš„æ–¹æ³•ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥å¢åŠ æ–°çš„å±æ€§æˆ–è€…æ–¹æ³•ã€‚è‹¥æŒ‡å®šåˆå§‹åŒ–æ–¹æ³•ï¼Œé”€æ¯æ–¹æ³•æˆ–è€…é™æ€å·¥å‚æ–¹æ³•ï¼ŒChildBeanDefinitionå°†é‡å†™ç›¸åº”çˆ¶ç±»çš„è®¾ç½®ã€‚</li>
<li>RootBeanDefinitionï¼šRootBeanDefinitionæ˜¯ä¸€ä¸ªå¯åˆå¹¶çš„bean definitionï¼Œå³åœ¨spring beanFactoryè¿è¡ŒæœŸé—´ï¼Œå¯ä»¥è¿”å›ä¸€ä¸ªç‰¹å®šçš„beanã€‚</li>
<li>GenericBeanDefinitionï¼šä»spring 2.5ä»¥åäº†æä¾›çš„æ›´å¥½çš„æ³¨å†Œbean definitionç±»ï¼Œç”¨æ¥æ›¿ä»£ChildBeanDefinitionè·ŸRootBeanDefinitionã€‚æ ‡å‡†BeanDefinitionï¼Œé™¤äº†å…·æœ‰æŒ‡å®šç±»ã€å¯é€‰çš„æ„é€ å‚æ•°å€¼å’Œå±æ€§å‚æ•°è¿™äº›å…¶å®ƒBeanDefinitionä¸€æ ·çš„ç‰¹æ€§å¤–ï¼Œå®ƒè¿˜å…·æœ‰é€šè¿‡parenetNameå±æ€§æ¥åŠ¨æ€è®¾ç½®parent bean definitionï¼Œè€Œéç¡¬ç¼–ç ä½œä¸ºroot bean definitionã€‚ </li>
</ul>
<h3 id="BeanDefinitionä¸­çš„å±æ€§"><a href="#BeanDefinitionä¸­çš„å±æ€§" class="headerlink" title="BeanDefinitionä¸­çš„å±æ€§"></a>BeanDefinitionä¸­çš„å±æ€§</h3><img src="/blog/2020/04/15/spring-%E5%AE%9E%E4%BE%8B%E5%8C%96bean%E7%9A%84%E8%BF%87%E7%A8%8B/pic1.png" srcset="/blog/img/loading.gif" class>

<ul>
<li><p>idï¼šBean çš„å”¯ä¸€æ ‡è¯†åã€‚å®ƒå¿…é¡»æ˜¯åˆæ³•çš„ XMLIDï¼Œåœ¨æ•´ä¸ª XML æ–‡æ¡£ä¸­å”¯ä¸€ã€‚</p>
</li>
<li><p>nameï¼šç”¨æ¥ä¸ºidåˆ›å»ºä¸€ä¸ªæˆ–å¤šä¸ªåˆ«åã€‚å®ƒå¯ä»¥æ˜¯ä»»æ„çš„å­—æ¯ç¬¦åˆã€‚å¤šä¸ªåˆ«åä¹‹é—´ç”¨é€—å·æˆ–ç©ºæ ¼åˆ†å¼€ã€‚</p>
</li>
<li><p>classï¼šç”¨æ¥å®šä¹‰ç±»çš„å…¨é™å®šå(åŒ…å+ç±»å)ã€‚åªæœ‰å­ç±» Bean ä¸ç”¨å®šä¹‰è¯¥å±æ€§ã€‚</p>
</li>
<li><p>parentï¼šå­ç±»Bean å®šä¹‰å®ƒæ‰€å¼•ç”¨å®ƒçš„çˆ¶ç±»Beanã€‚è¿™æ—¶å‰é¢çš„class å±æ€§å¤±æ•ˆã€‚å­ç±»Beanä¼šç»§æ‰¿çˆ¶ç±»Beançš„æ‰€æœ‰å±æ€§ï¼Œå­ç±»Beanä¹Ÿå¯ä»¥è¦†ç›–çˆ¶ç±» Bean çš„å±æ€§ã€‚æ³¨æ„:å­ç±» Bean å’Œçˆ¶ç±» Bean æ˜¯åŒä¸€ ä¸ª Java ç±»ã€‚</p>
</li>
<li><p>abstract(é»˜è®¤ä¸ºâ€falseâ€)ï¼šç”¨æ¥å®šä¹‰Beanæ˜¯å¦ä¸ºæŠ½è±¡Beanã€‚å®ƒè¡¨ç¤ºè¿™ä¸ªBeanå°†ä¸ä¼šè¢«å®ä¾‹åŒ–ï¼Œä¸€èˆ¬ç”¨äºçˆ¶ç±» Beanï¼Œå› ä¸ºçˆ¶ç±»Beanä¸»è¦æ˜¯ä¾›å­ç±»Beanç»§æ‰¿ä½¿ç”¨ã€‚</p>
</li>
<li><p>lazy-init(é»˜è®¤ä¸ºâ€œdefaultâ€)ï¼šç”¨æ¥å®šä¹‰è¿™ä¸ªBeanæ˜¯å¦å®ç°æ‡’åˆå§‹åŒ–ã€‚å¦‚æœä¸ºâ€œtrueâ€ï¼Œå®ƒå°†åœ¨BeanFactory å¯åŠ¨æ—¶åˆå§‹åŒ–æ‰€æœ‰çš„SingletonBeanã€‚åä¹‹ï¼Œå¦‚æœä¸ºâ€œfalseâ€ï¼Œå®ƒåªåœ¨Beanè¯·æ±‚æ—¶æ‰å¼€å§‹åˆ›å»ºSingletonBeanã€‚</p>
</li>
<li><p>autowireï¼š(è‡ªåŠ¨è£…é…ï¼Œé»˜è®¤ä¸ºâ€œdefaultâ€ï¼šå®ƒå®šä¹‰äº†Beançš„è‡ªåŠ¨è£…è½½æ–¹å¼ã€‚ </p>
<ul>
<li><p>â€œnoâ€ï¼šä¸ä½¿ç”¨è‡ªåŠ¨è£…é…åŠŸèƒ½ã€‚</p>
</li>
<li><p>â€œbyNameâ€ï¼šé€šè¿‡ Bean çš„å±æ€§åå®ç°è‡ªåŠ¨è£…é…ã€‚</p>
</li>
<li><p>â€œbyTypeâ€ï¼šé€šè¿‡ Bean çš„ç±»å‹å®ç°è‡ªåŠ¨è£…é…ã€‚</p>
</li>
<li><p>â€œconstructorâ€ï¼šç±»ä¼¼äº byTypeï¼Œä½†å®ƒæ˜¯ç”¨äºæ„é€ å‡½æ•°çš„å‚æ•°çš„è‡ªåŠ¨ç»„è£…ã€‚</p>
</li>
<li><p>â€œautodetectâ€ï¼šé€šè¿‡ Bean ç±»çš„åçœæœºåˆ¶(introspection)å†³å®šæ˜¯ä½¿ç”¨â€œconstructorâ€è¿˜æ˜¯ä½¿ç”¨â€œbyTypeâ€ã€‚</p>
</li>
</ul>
</li>
<li><p>depends-on(ä¾èµ–å¯¹è±¡)ï¼šè¿™ä¸ªBeanåœ¨åˆå§‹åŒ–æ—¶ä¾èµ–çš„å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡ä¼šåœ¨è¿™ä¸ªBeanåˆå§‹åŒ–ä¹‹å‰åˆ›å»ºã€‚</p>
</li>
<li><p>init-methodï¼šç”¨æ¥å®šä¹‰Beançš„åˆå§‹åŒ–æ–¹æ³•ï¼Œå®ƒä¼šåœ¨Beanç»„è£…ä¹‹åè°ƒç”¨ã€‚å®ƒå¿…é¡»æ˜¯ä¸€ä¸ªæ— å‚æ•°çš„æ–¹æ³•ã€‚</p>
</li>
<li><p>destroy-methodï¼šç”¨æ¥å®šä¹‰Beançš„é”€æ¯æ–¹æ³•ï¼Œå®ƒåœ¨BeanFactoryå…³é—­æ—¶è°ƒç”¨ã€‚åŒæ ·ï¼Œå®ƒä¹Ÿå¿…é¡»æ˜¯ä¸€ä¸ªæ— å‚æ•°çš„æ–¹æ³•ã€‚å®ƒåªèƒ½åº”ç”¨äº singletonBeanã€‚</p>
</li>
<li><p>factory-methodï¼šå®šä¹‰åˆ›å»ºè¯¥Beanå¯¹è±¡çš„å·¥å‚æ–¹æ³•ã€‚å®ƒç”¨äºä¸‹é¢çš„â€œfactory-beanâ€ï¼Œè¡¨ç¤º è¿™ä¸ªBeanæ˜¯é€šè¿‡å·¥å‚æ–¹æ³•åˆ›å»ºã€‚æ­¤æ—¶ï¼Œâ€œclassâ€å±æ€§å¤±æ•ˆã€‚</p>
</li>
<li><p>factory-beanï¼šå®šä¹‰åˆ›å»ºè¯¥Beanå¯¹è±¡çš„å·¥å‚ç±»ã€‚å¦‚æœä½¿ç”¨äº†â€œfactory-beanâ€åˆ™â€œclassâ€å±æ€§å¤±æ•ˆã€‚</p>
</li>
<li><p>autowire-candidateï¼šé‡‡ç”¨xmlæ ¼å¼é…ç½®beanæ—¶ï¼Œå°†&lt;bean/&gt;å…ƒç´ çš„autowire-candidateå±æ€§è®¾ç½®ä¸º falseï¼Œè¿™æ ·å®¹å™¨åœ¨æŸ¥æ‰¾è‡ªåŠ¨è£…é…å¯¹è±¡æ—¶ï¼Œå°†ä¸è€ƒè™‘è¯¥beanï¼Œå³å®ƒä¸ä¼šè¢«è€ƒè™‘ä½œä¸ºå…¶å®ƒbeanè‡ªåŠ¨è£…é…çš„å€™é€‰è€…ï¼Œä½†æ˜¯è¯¥beanæœ¬èº«è¿˜æ˜¯å¯ä»¥ä½¿ç”¨è‡ªåŠ¨è£…é…æ¥æ³¨å…¥å…¶å®ƒbeançš„ã€‚</p>
</li>
<li><p>MutablePropertyValuesï¼šç”¨äºå°è£…&lt;property&gt;æ ‡ç­¾çš„ä¿¡æ¯ï¼Œå…¶å®ç±»é‡Œé¢å°±æ˜¯æœ‰ä¸€ä¸ªlistï¼Œlisté‡Œé¢æ˜¯PropertyValueå¯¹è±¡ï¼ŒPropertyValueå°±æ˜¯ä¸€ä¸ªnameå’Œvalueå±æ€§ï¼Œç”¨äºå°è£…&lt;property&gt;æ ‡ç­¾çš„åç§°å’Œå€¼ä¿¡æ¯</p>
</li>
<li><p>ConstructorArgumentValuesï¼šç”¨äºå°è£…&lt;constructor-arg&gt;\æ ‡ç­¾çš„ä¿¡æ¯ï¼Œå…¶å®ç±»é‡Œé¢å°±æ˜¯æœ‰ä¸€ä¸ªmapï¼Œmapä¸­ç”¨æ„é€ å‡½æ•°çš„å‚æ•°é¡ºåºä½œä¸ºkeyï¼Œå€¼ä½œä¸ºvalueå­˜å‚¨åˆ°mapä¸­</p>
</li>
<li><p>MethodOverridesï¼šç”¨äºå°è£…lookup-methodå’Œreplaced-methodæ ‡ç­¾çš„ä¿¡æ¯ï¼ŒåŒæ ·çš„ç±»é‡Œé¢æœ‰ä¸€ä¸ªSetå¯¹è±¡æ·»åŠ LookupOverrideå¯¹è±¡å’ŒReplaceOverrideå¯¹è±¡</p>
</li>
</ul>
<h2 id="invokeBeanFactoryPostProcessors-æ–¹æ³•"><a href="#invokeBeanFactoryPostProcessors-æ–¹æ³•" class="headerlink" title="invokeBeanFactoryPostProcessors()æ–¹æ³•"></a>invokeBeanFactoryPostProcessors()æ–¹æ³•</h2><p>invokeBeanFactoryPostProcessors()æ–¹æ³•åœ¨springçš„æ ¸å¿ƒæ–¹æ³•refresh()ä¸­è°ƒç”¨ï¼Œä¸»è¦ç”¨äºå¤„ç†BeanFactoryPostProcessoræ¥å£ï¼Œæ˜¯é’ˆå¯¹BeanFactoryçš„æ‰©å±•ï¼Œä¸»è¦ç”¨åœ¨beanå®ä¾‹åŒ–ä¹‹å‰ï¼Œè¯»å–beançš„å®šä¹‰ï¼Œå®Œæˆå¯¹BeanDefinitionçš„ä¿®æ”¹ã€‚</p>
<p>è¯¥æ–¹æ³•ä¼šå®ä¾‹åŒ–å’Œè°ƒç”¨æ‰€æœ‰çš„BeanFactoryPostProcessorï¼ˆåŒ…æ‹¬å­ç±»BeanDefinitionRegistryPostProcessorï¼‰ï¼Œå¹¶è°ƒç”¨postProcessBeanDefinitionRegistry()æ–¹æ³•ã€‚</p>
<p>postProcessBeanDefinitionRegistry()æ–¹æ³•çš„å…¥å‚ä¸ºBeanDefinitionRegistryå¯¹è±¡ï¼Œé€šè¿‡è¿™ä¸ªå¯¹è±¡å¯ä»¥å®Œæˆå¯¹æ‰€æœ‰BeanDefinitionå¯¹è±¡çš„å¢åˆ æ”¹æŸ¥ã€‚</p>
<p>åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¼šå¯¹å®ç°æ’åºæ¥å£çš„BeanFactoryPostProcessorè¿›è¡Œæ’åºï¼Œç„¶åæŒ‰ç…§é¡ºåºè¿›è¡Œè°ƒç”¨ã€‚</p>
<p>è°ƒç”¨é¡ºåºä¸º: </p>
<ol>
<li>å®ç°PriorityOrderedæ’åºæ¥å£</li>
<li>å®ç°Orderedæ’åºæ¥å£</li>
<li>æ²¡æœ‰å®ç°æ¥å£çš„è°ƒç”¨</li>
</ol>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">invokeBeanFactoryPostProcessors</span><span class="hljs-params">(</span></span>
<span class="hljs-function"><span class="hljs-params">		ConfigurableListableBeanFactory beanFactory, List&lt;BeanFactoryPostProcessor&gt; beanFactoryPostProcessors)</span> </span>&#123;

	<span class="hljs-comment">// Invoke BeanDefinitionRegistryPostProcessors first, if any.</span>
	Set&lt;String&gt; processedBeans = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

	<span class="hljs-keyword">if</span> (beanFactory <span class="hljs-keyword">instanceof</span> BeanDefinitionRegistry) &#123;
		BeanDefinitionRegistry registry = (BeanDefinitionRegistry) beanFactory;
		List&lt;BeanFactoryPostProcessor&gt; regularPostProcessors = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
		List&lt;BeanDefinitionRegistryPostProcessor&gt; registryProcessors = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

		<span class="hljs-keyword">for</span> (BeanFactoryPostProcessor postProcessor : beanFactoryPostProcessors) &#123;
			<span class="hljs-keyword">if</span> (postProcessor <span class="hljs-keyword">instanceof</span> BeanDefinitionRegistryPostProcessor) &#123;
				BeanDefinitionRegistryPostProcessor registryProcessor =
						(BeanDefinitionRegistryPostProcessor) postProcessor;
				registryProcessor.postProcessBeanDefinitionRegistry(registry);
				registryProcessors.add(registryProcessor);
			&#125;
			<span class="hljs-keyword">else</span> &#123;
				regularPostProcessors.add(postProcessor);
			&#125;
		&#125;

		<span class="hljs-comment">// Do not initialize FactoryBeans here: We need to leave all regular beans</span>
		<span class="hljs-comment">// uninitialized to let the bean factory post-processors apply to them!</span>
		<span class="hljs-comment">// Separate between BeanDefinitionRegistryPostProcessors that implement</span>
		<span class="hljs-comment">// PriorityOrdered, Ordered, and the rest.</span>
		List&lt;BeanDefinitionRegistryPostProcessor&gt; currentRegistryProcessors = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

		<span class="hljs-comment">//è·å–å®ç°äº†BeanDefinitionRegistryPostProcessoræ¥å£çš„æ‰€æœ‰ç±»çš„BeanDefinitionå¯¹è±¡çš„beanName</span>
		<span class="hljs-comment">// First, invoke the BeanDefinitionRegistryPostProcessors that implement PriorityOrdered.</span>
		String[] postProcessorNames =
				beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">true</span>, <span class="hljs-title">false</span>)</span>;
		<span class="hljs-keyword">for</span> (String ppName : postProcessorNames) &#123;
			<span class="hljs-comment">//åˆ¤æ–­æ˜¯å¦å®ç°äº†æ’åºæ¥å£ PriorityOrdered</span>
			<span class="hljs-keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered<span class="hljs-class">.<span class="hljs-keyword">class</span>)) </span>&#123;
				currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
				processedBeans.add(ppName);
			&#125;
		&#125;

		<span class="hljs-comment">//æ’åº</span>
		sortPostProcessors(currentRegistryProcessors, beanFactory);
		registryProcessors.addAll(currentRegistryProcessors);

		<span class="hljs-comment">//è°ƒç”¨è¿‡ç¨‹</span>
		invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);
		currentRegistryProcessors.clear();

		<span class="hljs-comment">// Next, invoke the BeanDefinitionRegistryPostProcessors that implement Ordered.</span>
		postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">true</span>, <span class="hljs-title">false</span>)</span>;
		<span class="hljs-keyword">for</span> (String ppName : postProcessorNames) &#123;

			<span class="hljs-comment">//åˆ¤æ–­æ˜¯å¦æ˜¯å®ç°çš„Orderedæ¥å£</span>
			<span class="hljs-keyword">if</span> (!processedBeans.contains(ppName) &amp;&amp; beanFactory.isTypeMatch(ppName, Ordered<span class="hljs-class">.<span class="hljs-keyword">class</span>)) </span>&#123;
         <span class="hljs-comment">//å®Œæˆå®ä¾‹åŒ–</span>
				currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
				processedBeans.add(ppName);
			&#125;
		&#125;
		sortPostProcessors(currentRegistryProcessors, beanFactory);
		registryProcessors.addAll(currentRegistryProcessors);
		invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);
		currentRegistryProcessors.clear();

		<span class="hljs-comment">//æ²¡å®ç°æ’åºæ¥å£çš„è°ƒç”¨</span>
		<span class="hljs-comment">// Finally, invoke all other BeanDefinitionRegistryPostProcessors until no further ones appear.</span>
		<span class="hljs-keyword">boolean</span> reiterate = <span class="hljs-keyword">true</span>;
		<span class="hljs-keyword">while</span> (reiterate) &#123;
			reiterate = <span class="hljs-keyword">false</span>;
			postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">true</span>, <span class="hljs-title">false</span>)</span>;
			<span class="hljs-keyword">for</span> (String ppName : postProcessorNames) &#123;
				<span class="hljs-keyword">if</span> (!processedBeans.contains(ppName)) &#123;
					currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
					processedBeans.add(ppName);
					reiterate = <span class="hljs-keyword">true</span>;
				&#125;
			&#125;
			sortPostProcessors(currentRegistryProcessors, beanFactory);
			registryProcessors.addAll(currentRegistryProcessors);
			<span class="hljs-comment">//</span>
			invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);
			currentRegistryProcessors.clear();
		&#125;

		<span class="hljs-comment">//è°ƒç”¨postProcessBeanFactoryæ–¹æ³•</span>
		<span class="hljs-comment">// Now, invoke the postProcessBeanFactory callback of all processors handled so far.</span>
		invokeBeanFactoryPostProcessors(registryProcessors, beanFactory);
		invokeBeanFactoryPostProcessors(regularPostProcessors, beanFactory);
	&#125;

	<span class="hljs-keyword">else</span> &#123;
		<span class="hljs-comment">// Invoke factory processors registered with the context instance.</span>
		invokeBeanFactoryPostProcessors(beanFactoryPostProcessors, beanFactory);
	&#125;

	<span class="hljs-comment">//è·å–å®ç°äº†BeanFactoryPostProcessoræ¥å£çš„ç±»ï¼Œè·å–beanDefinitionçš„åç§°</span>
	<span class="hljs-comment">// Do not initialize FactoryBeans here: We need to leave all regular beans</span>
	<span class="hljs-comment">// uninitialized to let the bean factory post-processors apply to them!</span>
	String[] postProcessorNames =
			beanFactory.getBeanNamesForType(BeanFactoryPostProcessor<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">true</span>, <span class="hljs-title">false</span>)</span>;

	<span class="hljs-comment">// Separate between BeanFactoryPostProcessors that implement PriorityOrdered,</span>
	<span class="hljs-comment">// Ordered, and the rest.</span>
	List&lt;BeanFactoryPostProcessor&gt; priorityOrderedPostProcessors = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
	List&lt;String&gt; orderedPostProcessorNames = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
	List&lt;String&gt; nonOrderedPostProcessorNames = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
	<span class="hljs-keyword">for</span> (String ppName : postProcessorNames) &#123;
		<span class="hljs-keyword">if</span> (processedBeans.contains(ppName)) &#123;
			<span class="hljs-comment">// skip - already processed in first phase above</span>
		&#125;
		<span class="hljs-comment">//å®ç°äº†PriorityOrderedæ¥å£çš„</span>
		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered<span class="hljs-class">.<span class="hljs-keyword">class</span>)) </span>&#123;
			priorityOrderedPostProcessors.add(beanFactory.getBean(ppName, BeanFactoryPostProcessor<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
		&#125;
		<span class="hljs-comment">//å®ç°äº†Orderedæ¥å£çš„</span>
		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (beanFactory.isTypeMatch(ppName, Ordered<span class="hljs-class">.<span class="hljs-keyword">class</span>)) </span>&#123;
			orderedPostProcessorNames.add(ppName);
		&#125;
		<span class="hljs-keyword">else</span> &#123;
			<span class="hljs-comment">//æ²¡å®ç°æ¥å£çš„</span>
			nonOrderedPostProcessorNames.add(ppName);
		&#125;
	&#125;

	<span class="hljs-comment">//æ’åº</span>
	<span class="hljs-comment">// First, invoke the BeanFactoryPostProcessors that implement PriorityOrdered.</span>
	sortPostProcessors(priorityOrderedPostProcessors, beanFactory);

	<span class="hljs-comment">//è°ƒç”¨</span>
	invokeBeanFactoryPostProcessors(priorityOrderedPostProcessors, beanFactory);

	<span class="hljs-comment">// Next, invoke the BeanFactoryPostProcessors that implement Ordered.</span>
	List&lt;BeanFactoryPostProcessor&gt; orderedPostProcessors = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
	<span class="hljs-keyword">for</span> (String postProcessorName : orderedPostProcessorNames) &#123;
		orderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
	&#125;
	sortPostProcessors(orderedPostProcessors, beanFactory);
	invokeBeanFactoryPostProcessors(orderedPostProcessors, beanFactory);

	<span class="hljs-comment">// Finally, invoke all other BeanFactoryPostProcessors.</span>
	List&lt;BeanFactoryPostProcessor&gt; nonOrderedPostProcessors = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
	<span class="hljs-keyword">for</span> (String postProcessorName : nonOrderedPostProcessorNames) &#123;
		nonOrderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
	&#125;
	invokeBeanFactoryPostProcessors(nonOrderedPostProcessors, beanFactory);

	<span class="hljs-comment">// Clear cached merged bean definitions since the post-processors might have</span>
	<span class="hljs-comment">// modified the original metadata, e.g. replacing placeholders in values...</span>
	beanFactory.clearMetadataCache();
&#125;</code></pre>

<h2 id="registerBeanPostProcessors-æ–¹æ³•"><a href="#registerBeanPostProcessors-æ–¹æ³•" class="headerlink" title="registerBeanPostProcessors()æ–¹æ³•"></a>registerBeanPostProcessors()æ–¹æ³•</h2><p>registerBeanPostProcessorsæ–¹æ³•ä¸»è¦ç”¨äºå¤„ç†BeanPostProcessoræ¥å£ï¼Œä¼šå®ä¾‹åŒ–æ‰€æœ‰çš„BeanPostProcessorï¼Œå°†æ‰€æœ‰å®ç°äº†BeanPostProcessoræ¥å£çš„ç±»åŠ è½½åˆ°BeanFactoryä¸­ã€‚BeanPostProcessoræ¥å£ç”¨äºåœ¨BeanDefinationåˆå§‹åŒ–è¿‡ç¨‹ä¸­å¯¹Beanè¿›è¡Œä¸€äº›æ“ä½œã€‚</p>
<p>è°ƒç”¨é¡ºåºä¸invokeBeanFactoryPostProcessors()æ–¹æ³•ç›¸åŒã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">registerBeanPostProcessors</span><span class="hljs-params">(</span></span>
<span class="hljs-function"><span class="hljs-params">		ConfigurableListableBeanFactory beanFactory, AbstractApplicationContext applicationContext)</span> </span>&#123;

	<span class="hljs-comment">//æ‹¿åˆ°å·¥ç¨‹é‡Œé¢æ‰€æœ‰å®ç°äº†BeanPostProcessoræ¥å£çš„ç±»ï¼Œè·å–åˆ°BeanDefinitionçš„åç§°</span>
	String[] postProcessorNames = beanFactory.getBeanNamesForType(BeanPostProcessor<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">true</span>, <span class="hljs-title">false</span>)</span>;

	<span class="hljs-comment">// Register BeanPostProcessorChecker that logs an info message when</span>
	<span class="hljs-comment">// a bean is created during BeanPostProcessor instantiation, i.e. when</span>
	<span class="hljs-comment">// a bean is not eligible for getting processed by all BeanPostProcessors.</span>
	<span class="hljs-keyword">int</span> beanProcessorTargetCount = beanFactory.getBeanPostProcessorCount() + <span class="hljs-number">1</span> + postProcessorNames.length;
	beanFactory.addBeanPostProcessor(<span class="hljs-keyword">new</span> BeanPostProcessorChecker(beanFactory, beanProcessorTargetCount));

	<span class="hljs-comment">// Separate between BeanPostProcessors that implement PriorityOrdered,</span>
	<span class="hljs-comment">// Ordered, and the rest.</span>
	List&lt;BeanPostProcessor&gt; priorityOrderedPostProcessors = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
	List&lt;BeanPostProcessor&gt; internalPostProcessors = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
	List&lt;String&gt; orderedPostProcessorNames = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
	List&lt;String&gt; nonOrderedPostProcessorNames = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

	<span class="hljs-comment">//æå‰å®ä¾‹åŒ–BeanPostProcessorç±»å‹çš„beanï¼Œç„¶åbeanè¿›è¡Œæ’åº</span>
	<span class="hljs-keyword">for</span> (String ppName : postProcessorNames) &#123;
		<span class="hljs-keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered<span class="hljs-class">.<span class="hljs-keyword">class</span>)) </span>&#123;

			<span class="hljs-comment">//getBeanæ˜¯å®ä¾‹åŒ–æ–¹æ³•ï¼Œåé¢æˆ‘ä»¬åœ¨è®²beanå®ä¾‹åŒ–è¿‡ç¨‹æ˜¯ä¼šç€é‡è®²åˆ°</span>
			BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
			priorityOrderedPostProcessors.add(pp);

			<span class="hljs-comment">//åˆ¤æ–­ç±»å‹æ˜¯å¦æ˜¯MergedBeanDefinitionPostProcessorï¼Œå¦‚æœæ˜¯åˆ™ä»£ç æ˜¯å†…éƒ¨ä½¿ç”¨çš„</span>
			<span class="hljs-keyword">if</span> (pp <span class="hljs-keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;
				internalPostProcessors.add(pp);
			&#125;
		&#125;
		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (beanFactory.isTypeMatch(ppName, Ordered<span class="hljs-class">.<span class="hljs-keyword">class</span>)) </span>&#123;
			orderedPostProcessorNames.add(ppName);
		&#125;
		<span class="hljs-keyword">else</span> &#123;
			nonOrderedPostProcessorNames.add(ppName);
		&#125;
	&#125;

	<span class="hljs-comment">// First, register the BeanPostProcessors that implement PriorityOrdered.</span>
	sortPostProcessors(priorityOrderedPostProcessors, beanFactory);

	<span class="hljs-comment">//æ³¨å†Œåˆ°BeanFactoryä¸­</span>
	registerBeanPostProcessors(beanFactory, priorityOrderedPostProcessors);

	<span class="hljs-comment">// Next, register the BeanPostProcessors that implement Ordered.</span>
	List&lt;BeanPostProcessor&gt; orderedPostProcessors = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
	<span class="hljs-keyword">for</span> (String ppName : orderedPostProcessorNames) &#123;
		BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
		orderedPostProcessors.add(pp);
		<span class="hljs-keyword">if</span> (pp <span class="hljs-keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;
			internalPostProcessors.add(pp);
		&#125;
	&#125;
	sortPostProcessors(orderedPostProcessors, beanFactory);
	registerBeanPostProcessors(beanFactory, orderedPostProcessors);

	<span class="hljs-comment">// Now, register all regular BeanPostProcessors.</span>
	List&lt;BeanPostProcessor&gt; nonOrderedPostProcessors = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
	<span class="hljs-keyword">for</span> (String ppName : nonOrderedPostProcessorNames) &#123;
		BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
		nonOrderedPostProcessors.add(pp);
		<span class="hljs-keyword">if</span> (pp <span class="hljs-keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;
			internalPostProcessors.add(pp);
		&#125;
	&#125;
	registerBeanPostProcessors(beanFactory, nonOrderedPostProcessors);

	<span class="hljs-comment">// Finally, re-register all internal BeanPostProcessors.</span>
	sortPostProcessors(internalPostProcessors, beanFactory);
	registerBeanPostProcessors(beanFactory, internalPostProcessors);

	<span class="hljs-comment">// Re-register post-processor for detecting inner beans as ApplicationListeners,</span>
	<span class="hljs-comment">// moving it to the end of the processor chain (for picking up proxies etc).</span>
	beanFactory.addBeanPostProcessor(<span class="hljs-keyword">new</span> ApplicationListenerDetector(applicationContext));
&#125;</code></pre>

<h2 id="finishBeanFactoryInitialization-æ–¹æ³•"><a href="#finishBeanFactoryInitialization-æ–¹æ³•" class="headerlink" title="finishBeanFactoryInitialization()æ–¹æ³•"></a>finishBeanFactoryInitialization()æ–¹æ³•</h2><p>è¿™ä¸ªæ–¹æ³•æ˜¯springä¸­æœ€é‡è¦çš„æ–¹æ³•ï¼ŒåŒ…æ‹¬beanå®ä¾‹åŒ–è¿‡ç¨‹ã€iocã€æ³¨è§£æ”¯æŒã€BeanPostProcessorçš„æ‰§è¡Œã€Aopçš„å…¥å£ã€‚</p>
<ol>
<li><p>preInstantiateSingletons()æ˜¯ä»–çš„ä¸»è¦æ–¹æ³•ï¼Œå®Œæˆå¯¹beançš„å®ä¾‹åŒ–ã€‚è¯¥æ–¹æ³•ä¼šéå†beanDefinitionNamesï¼Œé¦–å…ˆä¼šå°†çˆ¶å­BeanDefinitionåˆå¹¶ï¼Œç„¶åå°†å…·æœ‰æŸäº›ç‰¹å¾çš„BeanDefinitioné€šè¿‡getBean()æ–¹æ³•å®ä¾‹åŒ–ã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">preInstantiateSingletons</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> BeansException </span>&#123;
	<span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;
		logger.trace(<span class="hljs-string">"Pre-instantiating singletons in "</span> + <span class="hljs-keyword">this</span>);
	&#125;
   
	<span class="hljs-comment">// Iterate over a copy to allow for init methods which in turn register new bean definitions.</span>
	<span class="hljs-comment">// While this may not be part of the regular factory bootstrap, it does otherwise work fine.</span>
	<span class="hljs-comment">//xmlè§£ææ—¶ï¼Œè®²è¿‡ï¼ŒæŠŠæ‰€æœ‰beanNameéƒ½ç¼“å­˜åˆ°beanDefinitionNamesäº†</span>
	List&lt;String&gt; beanNames = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;(<span class="hljs-keyword">this</span>.beanDefinitionNames);
   
	<span class="hljs-comment">// Trigger initialization of all non-lazy singleton beans...</span>
	<span class="hljs-keyword">for</span> (String beanName : beanNames) &#123;
		<span class="hljs-comment">//æŠŠçˆ¶BeanDefinitioné‡Œé¢çš„å±æ€§æ‹¿åˆ°å­BeanDefinitionä¸­</span>
     <span class="hljs-comment">//åœ¨è§£æxmlæ—¶çˆ¶å­æ ‡ç­¾ä¼šè¢«è§£æä¸ºä¸¤ä¸ªBeanDefinitionä½†åªä¼šå®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡</span>
		RootBeanDefinition bd = getMergedLocalBeanDefinition(beanName);
   
		<span class="hljs-comment">//å¦‚æœä¸æ˜¯æŠ½è±¡çš„ï¼Œå•ä¾‹çš„ï¼Œéæ‡’åŠ è½½çš„å°±å®ä¾‹åŒ–</span>
		<span class="hljs-keyword">if</span> (!bd.isAbstract() &amp;&amp; bd.isSingleton() &amp;&amp; !bd.isLazyInit()) &#123;
   
			<span class="hljs-comment">//åˆ¤æ–­beanæ˜¯å¦å®ç°äº†FactoryBeanæ¥å£ï¼Œè¿™é‡Œå¯ä»¥ä¸çœ‹</span>
			<span class="hljs-keyword">if</span> (isFactoryBean(beanName)) &#123;
				Object bean = getBean(FACTORY_BEAN_PREFIX + beanName);
				<span class="hljs-keyword">if</span> (bean <span class="hljs-keyword">instanceof</span> FactoryBean) &#123;
					<span class="hljs-keyword">final</span> FactoryBean&lt;?&gt; factory = (FactoryBean&lt;?&gt;) bean;
					<span class="hljs-keyword">boolean</span> isEagerInit;
					<span class="hljs-keyword">if</span> (System.getSecurityManager() != <span class="hljs-keyword">null</span> &amp;&amp; factory <span class="hljs-keyword">instanceof</span> SmartFactoryBean) &#123;
						isEagerInit = AccessController.doPrivileged((PrivilegedAction&lt;Boolean&gt;)
										((SmartFactoryBean&lt;?&gt;) factory)::isEagerInit,
								getAccessControlContext());
					&#125;
					<span class="hljs-keyword">else</span> &#123;
						isEagerInit = (factory <span class="hljs-keyword">instanceof</span> SmartFactoryBean &amp;&amp;
								((SmartFactoryBean&lt;?&gt;) factory).isEagerInit());
					&#125;
					<span class="hljs-keyword">if</span> (isEagerInit) &#123;
						getBean(beanName);
					&#125;
				&#125;
			&#125;
			<span class="hljs-keyword">else</span> &#123;
				<span class="hljs-comment">//ä¸»è¦ä»è¿™é‡Œè¿›å…¥ï¼Œçœ‹çœ‹å®ä¾‹åŒ–è¿‡ç¨‹</span>
				getBean(beanName);
			&#125;
		&#125;
	&#125;
   
	<span class="hljs-comment">// Trigger post-initialization callback for all applicable beans...</span>
	<span class="hljs-keyword">for</span> (String beanName : beanNames) &#123;
		Object singletonInstance = getSingleton(beanName);
		<span class="hljs-keyword">if</span> (singletonInstance <span class="hljs-keyword">instanceof</span> SmartInitializingSingleton) &#123;
			<span class="hljs-keyword">final</span> SmartInitializingSingleton smartSingleton = (SmartInitializingSingleton) singletonInstance;
			<span class="hljs-keyword">if</span> (System.getSecurityManager() != <span class="hljs-keyword">null</span>) &#123;
				AccessController.doPrivileged((PrivilegedAction&lt;Object&gt;) () -&gt; &#123;
					smartSingleton.afterSingletonsInstantiated();
					<span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
				&#125;, getAccessControlContext());
			&#125;
			<span class="hljs-keyword">else</span> &#123;
				smartSingleton.afterSingletonsInstantiated();
			&#125;
		&#125;
	&#125;
&#125;</code></pre>
</li>
<li><p>getBean()æ˜¯å®ä¾‹åŒ–çš„æ ¸å¿ƒæ–¹æ³•ï¼ŒdoGetBean()æ–¹æ³•æ˜¯getBean()æ–¹æ³•çš„ä¸»è¦æ–¹æ³•ã€‚è¯¥æ–¹æ³•é¦–å…ˆä¼šå°è¯•ä»ç¼“å­˜ä¸­è·å–å®ä¾‹ï¼Œå¦‚æœæ²¡æœ‰å†è¿›è¡Œç±»çš„å®ä¾‹åŒ–ï¼Œæ­¤æ—¶ç¼“å­˜ä¸­ä¸€èˆ¬æ˜¯æ²¡æœ‰å®ä¾‹çš„ã€‚åœ¨ç±»å®ä¾‹åŒ–ä¹‹å‰ä¼šåˆ¤æ–­ç±»ä¸Šæ˜¯å¦æœ‰@Dependonæ³¨è§£ï¼Œå¦‚æœæœ‰å°±å…ˆå®ä¾‹åŒ–@Dependonæ³¨è§£ä¸­çš„ç±»ã€‚ç±»çš„å®ä¾‹åŒ–æ˜¯é€šè¿‡getSingleton()æ–¹æ³•å®ç°çš„ã€‚getObjectForBeanInstance()æ–¹æ³•ç”¨äºå¯¹BeanFactoryæ¥å£çš„æ”¯æŒï¼Œä¹‹åä¼šè¿›è¡Œå•ç‹¬åˆ†æã€‚</p>
<pre><code class="hljs java"><span class="hljs-keyword">protected</span> &lt;T&gt; <span class="hljs-function">T <span class="hljs-title">doGetBean</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String name, @Nullable <span class="hljs-keyword">final</span> Class&lt;T&gt; requiredType,</span></span>
<span class="hljs-function"><span class="hljs-params">			@Nullable <span class="hljs-keyword">final</span> Object[] args, <span class="hljs-keyword">boolean</span> typeCheckOnly)</span> <span class="hljs-keyword">throws</span> BeansException </span>&#123;

		<span class="hljs-keyword">final</span> String beanName = transformedBeanName(name);
		Object bean;

		<span class="hljs-comment">//ä»ç¼“å­˜ä¸­æ‹¿å®ä¾‹</span>
		<span class="hljs-comment">// Eagerly check singleton cache for manually registered singletons.</span>
		Object sharedInstance = getSingleton(beanName);
		<span class="hljs-comment">//å¦‚æœç¼“å­˜é‡Œé¢èƒ½æ‹¿åˆ°å®ä¾‹</span>
		<span class="hljs-keyword">if</span> (sharedInstance != <span class="hljs-keyword">null</span> &amp;&amp; args == <span class="hljs-keyword">null</span>) &#123;
			<span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;
				<span class="hljs-keyword">if</span> (isSingletonCurrentlyInCreation(beanName)) &#123;
					logger.trace(<span class="hljs-string">"Returning eagerly cached instance of singleton bean '"</span> + beanName +
							<span class="hljs-string">"' that is not fully initialized yet - a consequence of a circular reference"</span>);
				&#125;
				<span class="hljs-keyword">else</span> &#123;
					logger.trace(<span class="hljs-string">"Returning cached instance of singleton bean '"</span> + beanName + <span class="hljs-string">"'"</span>);
				&#125;
			&#125;
			<span class="hljs-comment">//æ”¹æ–¹æ³•æ˜¯FactoryBeanæ¥å£çš„è°ƒç”¨å…¥å£</span>
			bean = getObjectForBeanInstance(sharedInstance, name, beanName, <span class="hljs-keyword">null</span>);
		&#125;

		<span class="hljs-keyword">else</span> &#123;

			<span class="hljs-comment">//å¦‚æœsingletonObjectsç¼“å­˜é‡Œé¢æ²¡æœ‰ï¼Œåˆ™èµ°ä¸‹æ¥</span>
			<span class="hljs-comment">// Fail if we're already creating this bean instance:</span>
			<span class="hljs-comment">// We're assumably within a circular reference.</span>

			<span class="hljs-comment">//å¦‚æœæ˜¯scope æ˜¯Prototypeçš„ï¼Œæ ¡éªŒæ˜¯å¦æœ‰å‡ºç°å¾ªç¯ä¾èµ–ï¼Œå¦‚æœæœ‰åˆ™ç›´æ¥æŠ¥é”™</span>
			<span class="hljs-keyword">if</span> (isPrototypeCurrentlyInCreation(beanName)) &#123;
				<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCurrentlyInCreationException(beanName);
			&#125;

			<span class="hljs-comment">// Check if bean definition exists in this factory.</span>
			BeanFactory parentBeanFactory = getParentBeanFactory();
			<span class="hljs-keyword">if</span> (parentBeanFactory != <span class="hljs-keyword">null</span> &amp;&amp; !containsBeanDefinition(beanName)) &#123;
				<span class="hljs-comment">// Not found -&gt; check parent.</span>
				String nameToLookup = originalBeanName(name);
				<span class="hljs-keyword">if</span> (parentBeanFactory <span class="hljs-keyword">instanceof</span> AbstractBeanFactory) &#123;
					<span class="hljs-keyword">return</span> ((AbstractBeanFactory) parentBeanFactory).doGetBean(
							nameToLookup, requiredType, args, typeCheckOnly);
				&#125;
				<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (args != <span class="hljs-keyword">null</span>) &#123;
					<span class="hljs-comment">// Delegation to parent with explicit args.</span>
					<span class="hljs-keyword">return</span> (T) parentBeanFactory.getBean(nameToLookup, args);
				&#125;
				<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (requiredType != <span class="hljs-keyword">null</span>) &#123;
					<span class="hljs-comment">// No args -&gt; delegate to standard getBean method.</span>
					<span class="hljs-keyword">return</span> parentBeanFactory.getBean(nameToLookup, requiredType);
				&#125;
				<span class="hljs-keyword">else</span> &#123;
					<span class="hljs-keyword">return</span> (T) parentBeanFactory.getBean(nameToLookup);
				&#125;
			&#125;

			<span class="hljs-keyword">if</span> (!typeCheckOnly) &#123;
				markBeanAsCreated(beanName);
			&#125;

			<span class="hljs-keyword">try</span> &#123;
				<span class="hljs-comment">//çˆ¶å­BeanDefinitionåˆå¹¶</span>
				<span class="hljs-keyword">final</span> RootBeanDefinition mbd = getMergedLocalBeanDefinition(beanName);
				checkMergedBeanDefinition(mbd, beanName, args);

				<span class="hljs-comment">//è·å–ä¾èµ–å¯¹è±¡å±æ€§ï¼Œä¾èµ–å¯¹è±¡è¦å…ˆå®ä¾‹åŒ–</span>
				<span class="hljs-comment">// Guarantee initialization of beans that the current bean depends on.</span>
				String[] dependsOn = mbd.getDependsOn();
				<span class="hljs-keyword">if</span> (dependsOn != <span class="hljs-keyword">null</span>) &#123;
					<span class="hljs-keyword">for</span> (String dep : dependsOn) &#123;
						<span class="hljs-keyword">if</span> (isDependent(beanName, dep)) &#123;
							<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName,
									<span class="hljs-string">"Circular depends-on relationship between '"</span> + beanName + <span class="hljs-string">"' and '"</span> + dep + <span class="hljs-string">"'"</span>);
						&#125;
						registerDependentBean(dep, beanName);
						<span class="hljs-keyword">try</span> &#123;
							<span class="hljs-comment">//å®ä¾‹åŒ–</span>
							getBean(dep);
					&#125;
						<span class="hljs-keyword">catch</span> (NoSuchBeanDefinitionException ex) &#123;
							<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName,
									<span class="hljs-string">"'"</span> + beanName + <span class="hljs-string">"' depends on missing bean '"</span> + dep + <span class="hljs-string">"'"</span>, ex);
						&#125;
					&#125;
				&#125;

				<span class="hljs-comment">//ç€é‡çœ‹ï¼Œå¤§éƒ¨åˆ†æ˜¯å•ä¾‹çš„æƒ…å†µ</span>
				<span class="hljs-comment">// Create bean instance.</span>
				<span class="hljs-keyword">if</span> (mbd.isSingleton()) &#123;
					sharedInstance = getSingleton(beanName, () -&gt; &#123;
						<span class="hljs-keyword">try</span> &#123;
							<span class="hljs-keyword">return</span> createBean(beanName, mbd, args);
						&#125;
						<span class="hljs-keyword">catch</span> (BeansException ex) &#123;
							<span class="hljs-comment">// Explicitly remove instance from singleton cache: It might have been put there</span>
							<span class="hljs-comment">// eagerly by the creation process, to allow for circular reference resolution.</span>
							<span class="hljs-comment">// Also remove any beans that received a temporary reference to the bean.</span>
							destroySingleton(beanName);
							<span class="hljs-keyword">throw</span> ex;
						&#125;
					&#125;);
					<span class="hljs-comment">//è¯¥æ–¹æ³•æ˜¯FactoryBeanæ¥å£çš„è°ƒç”¨å…¥å£</span>
					bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);
				&#125;

				<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mbd.isPrototype()) &#123;
					<span class="hljs-comment">// It's a prototype -&gt; create a new instance.</span>
					Object prototypeInstance = <span class="hljs-keyword">null</span>;
					<span class="hljs-keyword">try</span> &#123;
						beforePrototypeCreation(beanName);
						prototypeInstance = createBean(beanName, mbd, args);
					&#125;
					<span class="hljs-keyword">finally</span> &#123;
						afterPrototypeCreation(beanName);
					&#125;
					<span class="hljs-comment">//è¯¥æ–¹æ³•æ˜¯FactoryBeanæ¥å£çš„è°ƒç”¨å…¥å£</span>
					bean = getObjectForBeanInstance(prototypeInstance, name, beanName, mbd);
				&#125;

				<span class="hljs-keyword">else</span> &#123;
					String scopeName = mbd.getScope();
					<span class="hljs-keyword">final</span> Scope scope = <span class="hljs-keyword">this</span>.scopes.get(scopeName);
					<span class="hljs-keyword">if</span> (scope == <span class="hljs-keyword">null</span>) &#123;
						<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(<span class="hljs-string">"No Scope registered for scope name '"</span> + scopeName + <span class="hljs-string">"'"</span>);
					&#125;
					<span class="hljs-keyword">try</span> &#123;
						Object scopedInstance = scope.get(beanName, () -&gt; &#123;
							beforePrototypeCreation(beanName);
							<span class="hljs-keyword">try</span> &#123;
								<span class="hljs-keyword">return</span> createBean(beanName, mbd, args);
							&#125;
							<span class="hljs-keyword">finally</span> &#123;
								afterPrototypeCreation(beanName);
							&#125;
						&#125;);
						<span class="hljs-comment">//æ”¹æ–¹æ³•æ˜¯FactoryBeanæ¥å£çš„è°ƒç”¨å…¥å£</span>
						bean = getObjectForBeanInstance(scopedInstance, name, beanName, mbd);
					&#125;
					<span class="hljs-keyword">catch</span> (IllegalStateException ex) &#123;
						<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(beanName,
								<span class="hljs-string">"Scope '"</span> + scopeName + <span class="hljs-string">"' is not active for the current thread; consider "</span> +
								<span class="hljs-string">"defining a scoped proxy for this bean if you intend to refer to it from a singleton"</span>,
								ex);
					&#125;
				&#125;
			&#125;
			<span class="hljs-keyword">catch</span> (BeansException ex) &#123;
				cleanupAfterBeanCreationFailure(beanName);
				<span class="hljs-keyword">throw</span> ex;
			&#125;
		&#125;

		<span class="hljs-comment">// Check if required type matches the type of the actual bean instance.</span>
		<span class="hljs-keyword">if</span> (requiredType != <span class="hljs-keyword">null</span> &amp;&amp; !requiredType.isInstance(bean)) &#123;
			<span class="hljs-keyword">try</span> &#123;
				T convertedBean = getTypeConverter().convertIfNecessary(bean, requiredType);
				<span class="hljs-keyword">if</span> (convertedBean == <span class="hljs-keyword">null</span>) &#123;
					<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanNotOfRequiredTypeException(name, requiredType, bean.getClass());
				&#125;
				<span class="hljs-keyword">return</span> convertedBean;
			&#125;
			<span class="hljs-keyword">catch</span> (TypeMismatchException ex) &#123;
				<span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;
					logger.trace(<span class="hljs-string">"Failed to convert bean '"</span> + name + <span class="hljs-string">"' to required type '"</span> +
							ClassUtils.getQualifiedName(requiredType) + <span class="hljs-string">"'"</span>, ex);
				&#125;
				<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanNotOfRequiredTypeException(name, requiredType, bean.getClass());
			&#125;
		&#125;
		<span class="hljs-keyword">return</span> (T) bean;
	&#125;</code></pre>
</li>
<li><p>getSingleton()æ–¹æ³•åœ¨åˆ›å»ºå‰ä¼šå°†beanNameæ·»åŠ åˆ°singletonsCurrentlyInCreationå®¹å™¨ä¸­ï¼Œè¯¥å®¹å™¨ä¸­å­˜å‚¨ç€æ­£åœ¨å®ä¾‹åŒ–çš„beanNameï¼Œç„¶åè°ƒç”¨ä¼ å…¥çš„singletonFactoryçš„getObject()æ–¹æ³•åˆ›å»ºå®ä¾‹ï¼Œåˆ›å»ºå®Œæˆåå†ä»å®¹å™¨ä¸­åˆ é™¤ï¼Œå¹¶æ”¾å…¥ä¸€çº§ç¼“å­˜ä¸­ã€‚getObject()æ–¹æ³•ä¼šè°ƒç”¨ä¸Šå±‚ä¼ å…¥çš„æ–¹æ³•createBean()ã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">getSingleton</span><span class="hljs-params">(String beanName, ObjectFactory&lt;?&gt; singletonFactory)</span> </span>&#123;
	Assert.notNull(beanName, <span class="hljs-string">"Bean name must not be null"</span>);
	<span class="hljs-keyword">synchronized</span> (<span class="hljs-keyword">this</span>.singletonObjects) &#123;
		<span class="hljs-comment">//å¦‚æœç¼“å­˜ä¸­æœ‰ï¼Œåˆ™ç›´æ¥è¿”å›</span>
		Object singletonObject = <span class="hljs-keyword">this</span>.singletonObjects.get(beanName);
		<span class="hljs-keyword">if</span> (singletonObject == <span class="hljs-keyword">null</span>) &#123;
			<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.singletonsCurrentlyInDestruction) &#123;
				<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationNotAllowedException(beanName,
						<span class="hljs-string">"Singleton bean creation not allowed while singletons of this factory are in destruction "</span> +
						<span class="hljs-string">"(Do not request a bean from a BeanFactory in a destroy method implementation!)"</span>);
			&#125;
			<span class="hljs-keyword">if</span> (logger.isDebugEnabled()) &#123;
				logger.debug(<span class="hljs-string">"Creating shared instance of singleton bean '"</span> + beanName + <span class="hljs-string">"'"</span>);
			&#125;
   
			<span class="hljs-comment">//æŠŠbeanNameæ·»åŠ åˆ°singletonsCurrentlyInCreation Setå®¹å™¨ä¸­ï¼Œåœ¨è¿™ä¸ªé›†åˆé‡Œé¢çš„beanéƒ½æ˜¯æ­£åœ¨å®ä¾‹åŒ–çš„bean</span>
			beforeSingletonCreation(beanName);
			<span class="hljs-keyword">boolean</span> newSingleton = <span class="hljs-keyword">false</span>;
			<span class="hljs-keyword">boolean</span> recordSuppressedExceptions = (<span class="hljs-keyword">this</span>.suppressedExceptions == <span class="hljs-keyword">null</span>);
			<span class="hljs-keyword">if</span> (recordSuppressedExceptions) &#123;
				<span class="hljs-keyword">this</span>.suppressedExceptions = <span class="hljs-keyword">new</span> LinkedHashSet&lt;&gt;();
			&#125;
       <span class="hljs-comment">//è°ƒç”¨ä¸Šå±‚ä¼ å…¥çš„æ–¹æ³•åˆ›å»ºå®ä¾‹</span>
			<span class="hljs-keyword">try</span> &#123;
				singletonObject = singletonFactory.getObject();
				newSingleton = <span class="hljs-keyword">true</span>;
			&#125;
			<span class="hljs-keyword">catch</span> (IllegalStateException ex) &#123;
				<span class="hljs-comment">// Has the singleton object implicitly appeared in the meantime -&gt;</span>
				<span class="hljs-comment">// if yes, proceed with it since the exception indicates that state.</span>
				singletonObject = <span class="hljs-keyword">this</span>.singletonObjects.get(beanName);
				<span class="hljs-keyword">if</span> (singletonObject == <span class="hljs-keyword">null</span>) &#123;
					<span class="hljs-keyword">throw</span> ex;
				&#125;
			&#125;
			<span class="hljs-keyword">catch</span> (BeanCreationException ex) &#123;
				<span class="hljs-keyword">if</span> (recordSuppressedExceptions) &#123;
					<span class="hljs-keyword">for</span> (Exception suppressedException : <span class="hljs-keyword">this</span>.suppressedExceptions) &#123;
						ex.addRelatedCause(suppressedException);
					&#125;
				&#125;
				<span class="hljs-keyword">throw</span> ex;
			&#125;
			<span class="hljs-keyword">finally</span> &#123;
				<span class="hljs-keyword">if</span> (recordSuppressedExceptions) &#123;
					<span class="hljs-keyword">this</span>.suppressedExceptions = <span class="hljs-keyword">null</span>;
				&#125;
				<span class="hljs-comment">//beanåˆ›å»ºå®ŒæˆåsingletonsCurrentlyInCreationè¦åˆ é™¤è¯¥bean</span>
				afterSingletonCreation(beanName);
			&#125;
			<span class="hljs-keyword">if</span> (newSingleton) &#123;
				<span class="hljs-comment">//åˆ›å»ºå¯¹è±¡æˆåŠŸæ—¶ï¼ŒæŠŠå¯¹è±¡ç¼“å­˜åˆ°singletonObjectsç¼“å­˜ä¸­,beanåˆ›å»ºå®Œæˆæ—¶æ”¾å…¥ä¸€çº§ç¼“å­˜</span>
				addSingleton(beanName, singletonObject);
			&#125;
		&#125;
		<span class="hljs-keyword">return</span> singletonObject;
	&#125;</code></pre>
</li>
<li><p>doCreateBean()æ˜¯createBean()çš„ä¸»è¦æ–¹æ³•ã€‚æ­¤æ–¹æ³•ä¸­é¦–å…ˆä¼šé€šè¿‡createBeanInstance()æ–¹æ³•åˆ›å»ºå®ä¾‹ï¼Œç„¶åè°ƒç”¨applyMergedBeanDefinitionPostProcessors()æ–¹æ³•å®Œæˆæ³¨è§£çš„è£…é…ï¼Œæ”¶é›†ã€‚addSingletonFactory()æ–¹æ³•ç”¨äºè§£å†³å¾ªç¯ä¾èµ–çš„é—®é¢˜ï¼Œä¹‹åä¼šè¿›è¡Œåˆ†æã€‚populateBean()æ–¹æ³•ç”¨äºå®ŒæˆapplyMergedBeanDefinitionPostProcessors(æ–¹æ³•è£…é…çš„æ³¨è§£è¿›è¡Œå¤„ç†ï¼Œä¸»è¦å®ŒæˆIOCã€DIç­‰å·¥ä½œã€‚initializeBean()æ–¹æ³•ç”¨äºå®Œæˆå®ä¾‹åŒ–åçš„ä¸€äº›æ“ä½œã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> Object <span class="hljs-title">doCreateBean</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String beanName, <span class="hljs-keyword">final</span> RootBeanDefinition mbd, <span class="hljs-keyword">final</span> @Nullable Object[] args)</span></span>
<span class="hljs-function">		<span class="hljs-keyword">throws</span> BeanCreationException </span>&#123;
   
	<span class="hljs-comment">// Instantiate the bean.</span>
	BeanWrapper instanceWrapper = <span class="hljs-keyword">null</span>;
	<span class="hljs-keyword">if</span> (mbd.isSingleton()) &#123;
		instanceWrapper = <span class="hljs-keyword">this</span>.factoryBeanInstanceCache.remove(beanName);
	&#125;
	<span class="hljs-keyword">if</span> (instanceWrapper == <span class="hljs-keyword">null</span>) &#123;
		<span class="hljs-comment">//åˆ›å»ºå®ä¾‹ é‡ç‚¹çœ‹ é‡è¦ç¨‹åº¦ï¼š5</span>
		instanceWrapper = createBeanInstance(beanName, mbd, args);
	&#125;
	<span class="hljs-keyword">final</span> Object bean = instanceWrapper.getWrappedInstance();
	Class&lt;?&gt; beanType = instanceWrapper.getWrappedClass();
	<span class="hljs-keyword">if</span> (beanType != NullBean<span class="hljs-class">.<span class="hljs-keyword">class</span>) </span>&#123;
		mbd.resolvedTargetType = beanType;
	&#125;
   
	<span class="hljs-comment">// Allow post-processors to modify the merged bean definition.</span>
	<span class="hljs-keyword">synchronized</span> (mbd.postProcessingLock) &#123;
		<span class="hljs-keyword">if</span> (!mbd.postProcessed) &#123;
			<span class="hljs-keyword">try</span> &#123;
				<span class="hljs-comment">//CommonAnnotationBeanPostProcessor  æ”¯æŒäº†@PostConstructï¼Œ@PreDestroy,@Resourceæ³¨è§£</span>
				<span class="hljs-comment">//AutowiredAnnotationBeanPostProcessor æ”¯æŒ @Autowired,@Valueæ³¨è§£</span>
				<span class="hljs-comment">//BeanPostProcessoræ¥å£çš„å…¸å‹è¿ç”¨ï¼Œè¿™é‡Œè¦ç†è§£è¿™ä¸ªæ¥å£</span>
				<span class="hljs-comment">//å¯¹ç±»ä¸­æ³¨è§£çš„è£…é…è¿‡ç¨‹</span>
				<span class="hljs-comment">//é‡è¦ç¨‹åº¦5ï¼Œå¿…é¡»çœ‹</span>
				applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName);
			&#125;
			<span class="hljs-keyword">catch</span> (Throwable ex) &#123;
				<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName,
						<span class="hljs-string">"Post-processing of merged bean definition failed"</span>, ex);
			&#125;
			mbd.postProcessed = <span class="hljs-keyword">true</span>;
		&#125;
	&#125;
   
	<span class="hljs-comment">// Eagerly cache singletons to be able to resolve circular references</span>
	<span class="hljs-comment">// even when triggered by lifecycle interfaces like BeanFactoryAware.</span>
	<span class="hljs-comment">//æ˜¯å¦	å•ä¾‹beanæå‰æš´éœ²</span>
	<span class="hljs-keyword">boolean</span> earlySingletonExposure = (mbd.isSingleton() &amp;&amp; <span class="hljs-keyword">this</span>.allowCircularReferences &amp;&amp;
			isSingletonCurrentlyInCreation(beanName));
	<span class="hljs-keyword">if</span> (earlySingletonExposure) &#123;
		<span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;
			logger.trace(<span class="hljs-string">"Eagerly caching bean '"</span> + beanName +
					<span class="hljs-string">"' to allow for resolving potential circular references"</span>);
		&#125;
		<span class="hljs-comment">//è¿™é‡Œç€é‡ç†è§£ï¼Œå¯¹ç†è§£å¾ªç¯ä¾èµ–å¸®åŠ©éå¸¸å¤§ï¼Œé‡è¦ç¨‹åº¦ 5   æ·»åŠ ä¸‰çº§ç¼“å­˜</span>
		addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean));
	&#125;
   
	<span class="hljs-comment">// Initialize the bean instance.</span>
	Object exposedObject = bean;
	<span class="hljs-keyword">try</span> &#123;
		<span class="hljs-comment">//ioc diï¼Œä¾èµ–æ³¨å…¥çš„æ ¸å¿ƒæ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¿…é¡»çœ‹ï¼Œé‡è¦ç¨‹åº¦ï¼š5</span>
		populateBean(beanName, mbd, instanceWrapper);
   
		<span class="hljs-comment">//bean å®ä¾‹åŒ–+iocä¾èµ–æ³¨å…¥å®Œä»¥åçš„è°ƒç”¨ï¼Œéå¸¸é‡è¦ï¼Œé‡è¦ç¨‹åº¦ï¼š5</span>
		exposedObject = initializeBean(beanName, exposedObject, mbd);
	&#125;
	<span class="hljs-keyword">catch</span> (Throwable ex) &#123;
		<span class="hljs-keyword">if</span> (ex <span class="hljs-keyword">instanceof</span> BeanCreationException &amp;&amp; beanName.equals(((BeanCreationException) ex).getBeanName())) &#123;
			<span class="hljs-keyword">throw</span> (BeanCreationException) ex;
		&#125;
		<span class="hljs-keyword">else</span> &#123;
			<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(
					mbd.getResourceDescription(), beanName, <span class="hljs-string">"Initialization of bean failed"</span>, ex);
		&#125;
	&#125;
   
	<span class="hljs-keyword">if</span> (earlySingletonExposure) &#123;
		Object earlySingletonReference = getSingleton(beanName, <span class="hljs-keyword">false</span>);
		<span class="hljs-keyword">if</span> (earlySingletonReference != <span class="hljs-keyword">null</span>) &#123;
			<span class="hljs-keyword">if</span> (exposedObject == bean) &#123;
				exposedObject = earlySingletonReference;
			&#125;
			<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.allowRawInjectionDespiteWrapping &amp;&amp; hasDependentBean(beanName)) &#123;
				String[] dependentBeans = getDependentBeans(beanName);
				Set&lt;String&gt; actualDependentBeans = <span class="hljs-keyword">new</span> LinkedHashSet&lt;&gt;(dependentBeans.length);
				<span class="hljs-keyword">for</span> (String dependentBean : dependentBeans) &#123;
					<span class="hljs-keyword">if</span> (!removeSingletonIfCreatedForTypeCheckOnly(dependentBean)) &#123;
						actualDependentBeans.add(dependentBean);
					&#125;
				&#125;
				<span class="hljs-keyword">if</span> (!actualDependentBeans.isEmpty()) &#123;
					<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCurrentlyInCreationException(beanName,
							<span class="hljs-string">"Bean with name '"</span> + beanName + <span class="hljs-string">"' has been injected into other beans ["</span> +
							StringUtils.collectionToCommaDelimitedString(actualDependentBeans) +
							<span class="hljs-string">"] in its raw version as part of a circular reference, but has eventually been "</span> +
							<span class="hljs-string">"wrapped. This means that said other beans do not use the final version of the "</span> +
							<span class="hljs-string">"bean. This is often the result of over-eager type matching - consider using "</span> +
							<span class="hljs-string">"'getBeanNamesOfType' with the 'allowEagerInit' flag turned off, for example."</span>);
				&#125;
			&#125;
		&#125;
	&#125;
   
	<span class="hljs-comment">// Register bean as disposable.</span>
	<span class="hljs-keyword">try</span> &#123;
		<span class="hljs-comment">//æ³¨å†Œbeané”€æ¯æ—¶çš„ç±»DisposableBeanAdapter</span>
		registerDisposableBeanIfNecessary(beanName, bean, mbd);
	&#125;
	<span class="hljs-keyword">catch</span> (BeanDefinitionValidationException ex) &#123;
		<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(
				mbd.getResourceDescription(), beanName, <span class="hljs-string">"Invalid destruction signature"</span>, ex);
	&#125;
   
	<span class="hljs-keyword">return</span> exposedObject;
&#125;</code></pre>

</li>
</ol>
<h3 id="createBeanInstance-æ–¹æ³•"><a href="#createBeanInstance-æ–¹æ³•" class="headerlink" title="createBeanInstance()æ–¹æ³•"></a>createBeanInstance()æ–¹æ³•</h3><ol>
<li><p>createBeanInstance()æ–¹æ³•ï¼Œé¦–å…ˆä¼šé€šè¿‡åå°„æ‹¿åˆ°Classå¯¹è±¡ï¼Œç„¶åä¼šæ£€æŸ¥æ˜¯å¦æœ‰FactoryMethodNameå±æ€§ï¼Œå¦‚æœæœ‰åˆ™è°ƒç”¨instantiateUsingFactoryMethod()æ–¹æ³•åˆ›å»ºåè¿”å›ï¼Œå¦‚æœæ²¡æœ‰ä¼šä½¿ç”¨determineConstructorsFromBeanPostProcessors()æ–¹æ³•æ‰«ææœ‰Autowiredæ³¨è§£çš„æ„é€ å‡½æ•°ï¼Œå¦‚æœæœ‰åˆ™ä½¿ç”¨autowireConstructor()æ–¹æ³•åˆ›å»ºå¯¹è±¡å¹¶è¿”å›ï¼Œæ— å‚æ„é€ ç›´æ¥ä½¿ç”¨åå°„è°ƒç”¨æ„é€ å‡½æ•°åˆ›å»ºå®ä¾‹å¹¶åŒ…è£…ä¸ºBeanWrapperImplè¿”å›ã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> BeanWrapper <span class="hljs-title">createBeanInstance</span><span class="hljs-params">(String beanName, RootBeanDefinition mbd, @Nullable Object[] args)</span> </span>&#123;
	<span class="hljs-comment">// Make sure bean class is actually resolved at this point.</span>
	<span class="hljs-comment">//åå°„æ‹¿åˆ°Classå¯¹è±¡</span>
	Class&lt;?&gt; beanClass = resolveBeanClass(mbd, beanName);
   
	<span class="hljs-keyword">if</span> (beanClass != <span class="hljs-keyword">null</span> &amp;&amp; !Modifier.isPublic(beanClass.getModifiers()) &amp;&amp; !mbd.isNonPublicAccessAllowed()) &#123;
		<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName,
				<span class="hljs-string">"Bean class isn't public, and non-public access not allowed: "</span> + beanClass.getName());
	&#125;
   
	Supplier&lt;?&gt; instanceSupplier = mbd.getInstanceSupplier();
	<span class="hljs-keyword">if</span> (instanceSupplier != <span class="hljs-keyword">null</span>) &#123;
		<span class="hljs-keyword">return</span> obtainFromSupplier(instanceSupplier, beanName);
	&#125;
   
	<span class="hljs-comment">//å¦‚æœæœ‰FactoryMethodNameå±æ€§</span>
	<span class="hljs-keyword">if</span> (mbd.getFactoryMethodName() != <span class="hljs-keyword">null</span>) &#123;
		<span class="hljs-keyword">return</span> instantiateUsingFactoryMethod(beanName, mbd, args);
	&#125;
   
	<span class="hljs-comment">// Shortcut when re-creating the same bean...</span>
	<span class="hljs-keyword">boolean</span> resolved = <span class="hljs-keyword">false</span>;
	<span class="hljs-keyword">boolean</span> autowireNecessary = <span class="hljs-keyword">false</span>;
	<span class="hljs-keyword">if</span> (args == <span class="hljs-keyword">null</span>) &#123;
		<span class="hljs-keyword">synchronized</span> (mbd.constructorArgumentLock) &#123;
			<span class="hljs-keyword">if</span> (mbd.resolvedConstructorOrFactoryMethod != <span class="hljs-keyword">null</span>) &#123;
				resolved = <span class="hljs-keyword">true</span>;
				autowireNecessary = mbd.constructorArgumentsResolved;
			&#125;
		&#125;
	&#125;
	<span class="hljs-keyword">if</span> (resolved) &#123;
		<span class="hljs-keyword">if</span> (autowireNecessary) &#123;
			<span class="hljs-keyword">return</span> autowireConstructor(beanName, mbd, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>);
		&#125;
		<span class="hljs-keyword">else</span> &#123;
			<span class="hljs-keyword">return</span> instantiateBean(beanName, mbd);
		&#125;
	&#125;
   
	<span class="hljs-comment">// Candidate constructors for autowiring?</span>
	<span class="hljs-comment">//å¯»æ‰¾å½“å‰æ­£åœ¨å®ä¾‹åŒ–çš„beanä¸­æœ‰@Autowiredæ³¨è§£çš„æ„é€ å‡½æ•°</span>
	Constructor&lt;?&gt;[] ctors = determineConstructorsFromBeanPostProcessors(beanClass, beanName);
	<span class="hljs-keyword">if</span> (ctors != <span class="hljs-keyword">null</span> || mbd.getResolvedAutowireMode() == AUTOWIRE_CONSTRUCTOR ||
			mbd.hasConstructorArgumentValues() || !ObjectUtils.isEmpty(args)) &#123;
		<span class="hljs-comment">//å¦‚æœctorsä¸ä¸ºç©ºï¼Œå°±è¯´æ˜æ„é€ å‡½æ•°ä¸Šæœ‰@Autowiredæ³¨è§£</span>
		<span class="hljs-keyword">return</span> autowireConstructor(beanName, mbd, ctors, args);
	&#125;
   
	<span class="hljs-comment">// Preferred constructors for default construction?</span>
	ctors = mbd.getPreferredConstructors();
	<span class="hljs-keyword">if</span> (ctors != <span class="hljs-keyword">null</span>) &#123;
		<span class="hljs-keyword">return</span> autowireConstructor(beanName, mbd, ctors, <span class="hljs-keyword">null</span>);
	&#125;
   
	<span class="hljs-comment">//æ— å‚æ„é€ å‡½æ•°çš„å®ä¾‹åŒ–,å¤§éƒ¨åˆ†çš„å®ä¾‹æ˜¯é‡‡ç”¨çš„æ— å‚æ„é€ å‡½æ•°çš„æ–¹å¼å®ä¾‹åŒ–</span>
	<span class="hljs-comment">// No special handling: simply use no-arg constructor.</span>
	<span class="hljs-keyword">return</span> instantiateBean(beanName, mbd);
&#125;</code></pre>
</li>
<li><p>instantiateUsingFactoryMethod()æ–¹æ³•æ˜¯é€šè¿‡åå°„è°ƒç”¨ç±»ä¸­çš„factoryMethodæ–¹æ³•åˆ›å»ºå¯¹è±¡ï¼Œç„¶åå°†å¯¹è±¡åŒ…è£…ä¸ºBeanWrapperImplå¯¹è±¡ã€‚BeanWrapperImplå¯¹è±¡ä¸­åŒ…å«å¯¹å®ä¾‹çš„å¼•ç”¨ï¼Œä»¥åŠä¸€äº›ç¼–è¾‘å™¨å’Œç±»å‹è½¬æ¢å™¨ï¼Œè¿™ä¸ªå¯¹è±¡ä¸éœ€è¦æ·±ç©¶ï¼Œäº†è§£å³å¯ã€‚@Beanæ³¨è§£å…¶å®å°±æ˜¯æŠŠæ–¹æ³•åç§°è®¾ç½®åˆ°BeanDefinitionçš„factoryMethodå±æ€§ä¸­ã€‚è¯¥æ–¹æ³•é‡Œé¢çš„å‚æ•°è§£æè¿‡ç¨‹ä¸éœ€è¦äº†è§£ã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> BeanWrapper <span class="hljs-title">instantiateUsingFactoryMethod</span><span class="hljs-params">(</span></span>
<span class="hljs-function"><span class="hljs-params">		String beanName, RootBeanDefinition mbd, @Nullable Object[] explicitArgs)</span> </span>&#123;
   
	BeanWrapperImpl bw = <span class="hljs-keyword">new</span> BeanWrapperImpl();
	<span class="hljs-keyword">this</span>.beanFactory.initBeanWrapper(bw);
   
	Object factoryBean;
	Class&lt;?&gt; factoryClass;
	<span class="hljs-keyword">boolean</span> isStatic;
   
	String factoryBeanName = mbd.getFactoryBeanName();
	<span class="hljs-keyword">if</span> (factoryBeanName != <span class="hljs-keyword">null</span>) &#123;
		<span class="hljs-keyword">if</span> (factoryBeanName.equals(beanName)) &#123;
			<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanDefinitionStoreException(mbd.getResourceDescription(), beanName,
					<span class="hljs-string">"factory-bean reference points back to the same bean definition"</span>);
		&#125;
		factoryBean = <span class="hljs-keyword">this</span>.beanFactory.getBean(factoryBeanName);
		<span class="hljs-keyword">if</span> (mbd.isSingleton() &amp;&amp; <span class="hljs-keyword">this</span>.beanFactory.containsSingleton(beanName)) &#123;
			<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ImplicitlyAppearedSingletonException();
		&#125;
		factoryClass = factoryBean.getClass();
		isStatic = <span class="hljs-keyword">false</span>;
	&#125;
	<span class="hljs-keyword">else</span> &#123;
		<span class="hljs-comment">// It's a static factory method on the bean class.</span>
		<span class="hljs-keyword">if</span> (!mbd.hasBeanClass()) &#123;
			<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanDefinitionStoreException(mbd.getResourceDescription(), beanName,
					<span class="hljs-string">"bean definition declares neither a bean class nor a factory-bean reference"</span>);
		&#125;
		factoryBean = <span class="hljs-keyword">null</span>;
		factoryClass = mbd.getBeanClass();
		isStatic = <span class="hljs-keyword">true</span>;
	&#125;
   
	Method factoryMethodToUse = <span class="hljs-keyword">null</span>;
	ArgumentsHolder argsHolderToUse = <span class="hljs-keyword">null</span>;
	Object[] argsToUse = <span class="hljs-keyword">null</span>;
   
	<span class="hljs-keyword">if</span> (explicitArgs != <span class="hljs-keyword">null</span>) &#123;
		argsToUse = explicitArgs;
	&#125;
	<span class="hljs-keyword">else</span> &#123;
		Object[] argsToResolve = <span class="hljs-keyword">null</span>;
		<span class="hljs-keyword">synchronized</span> (mbd.constructorArgumentLock) &#123;
			factoryMethodToUse = (Method) mbd.resolvedConstructorOrFactoryMethod;
			<span class="hljs-keyword">if</span> (factoryMethodToUse != <span class="hljs-keyword">null</span> &amp;&amp; mbd.constructorArgumentsResolved) &#123;
				<span class="hljs-comment">// Found a cached factory method...</span>
				argsToUse = mbd.resolvedConstructorArguments;
				<span class="hljs-keyword">if</span> (argsToUse == <span class="hljs-keyword">null</span>) &#123;
					argsToResolve = mbd.preparedConstructorArguments;
				&#125;
			&#125;
		&#125;
		<span class="hljs-keyword">if</span> (argsToResolve != <span class="hljs-keyword">null</span>) &#123;
			argsToUse = resolvePreparedArguments(beanName, mbd, bw, factoryMethodToUse, argsToResolve, <span class="hljs-keyword">true</span>);
		&#125;
	&#125;
   
	<span class="hljs-keyword">if</span> (factoryMethodToUse == <span class="hljs-keyword">null</span> || argsToUse == <span class="hljs-keyword">null</span>) &#123;
		<span class="hljs-comment">// Need to determine the factory method...</span>
		<span class="hljs-comment">// Try all methods with this name to see if they match the given arguments.</span>
		factoryClass = ClassUtils.getUserClass(factoryClass);
   
		Method[] rawCandidates = getCandidateMethods(factoryClass, mbd);
		List&lt;Method&gt; candidateList = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
		<span class="hljs-keyword">for</span> (Method candidate : rawCandidates) &#123;
			<span class="hljs-keyword">if</span> (Modifier.isStatic(candidate.getModifiers()) == isStatic &amp;&amp; mbd.isFactoryMethod(candidate)) &#123;
				candidateList.add(candidate);
			&#125;
		&#125;
   
		<span class="hljs-keyword">if</span> (candidateList.size() == <span class="hljs-number">1</span> &amp;&amp; explicitArgs == <span class="hljs-keyword">null</span> &amp;&amp; !mbd.hasConstructorArgumentValues()) &#123;
			Method uniqueCandidate = candidateList.get(<span class="hljs-number">0</span>);
			<span class="hljs-keyword">if</span> (uniqueCandidate.getParameterCount() == <span class="hljs-number">0</span>) &#123;
				mbd.factoryMethodToIntrospect = uniqueCandidate;
				<span class="hljs-keyword">synchronized</span> (mbd.constructorArgumentLock) &#123;
					mbd.resolvedConstructorOrFactoryMethod = uniqueCandidate;
					mbd.constructorArgumentsResolved = <span class="hljs-keyword">true</span>;
					mbd.resolvedConstructorArguments = EMPTY_ARGS;
				&#125;
				bw.setBeanInstance(instantiate(beanName, mbd, factoryBean, uniqueCandidate, EMPTY_ARGS));
				<span class="hljs-keyword">return</span> bw;
			&#125;
		&#125;
   
		Method[] candidates = candidateList.toArray(<span class="hljs-keyword">new</span> Method[<span class="hljs-number">0</span>]);
		AutowireUtils.sortFactoryMethods(candidates);
   
		ConstructorArgumentValues resolvedValues = <span class="hljs-keyword">null</span>;
		<span class="hljs-keyword">boolean</span> autowiring = (mbd.getResolvedAutowireMode() == AutowireCapableBeanFactory.AUTOWIRE_CONSTRUCTOR);
		<span class="hljs-keyword">int</span> minTypeDiffWeight = Integer.MAX_VALUE;
		Set&lt;Method&gt; ambiguousFactoryMethods = <span class="hljs-keyword">null</span>;
   
		<span class="hljs-keyword">int</span> minNrOfArgs;
		<span class="hljs-keyword">if</span> (explicitArgs != <span class="hljs-keyword">null</span>) &#123;
			minNrOfArgs = explicitArgs.length;
		&#125;
		<span class="hljs-keyword">else</span> &#123;
			<span class="hljs-comment">// We don't have arguments passed in programmatically, so we need to resolve the</span>
			<span class="hljs-comment">// arguments specified in the constructor arguments held in the bean definition.</span>
			<span class="hljs-keyword">if</span> (mbd.hasConstructorArgumentValues()) &#123;
				ConstructorArgumentValues cargs = mbd.getConstructorArgumentValues();
				resolvedValues = <span class="hljs-keyword">new</span> ConstructorArgumentValues();
				minNrOfArgs = resolveConstructorArguments(beanName, mbd, bw, cargs, resolvedValues);
			&#125;
			<span class="hljs-keyword">else</span> &#123;
				minNrOfArgs = <span class="hljs-number">0</span>;
			&#125;
		&#125;
   
		LinkedList&lt;UnsatisfiedDependencyException&gt; causes = <span class="hljs-keyword">null</span>;
   
		<span class="hljs-keyword">for</span> (Method candidate : candidates) &#123;
			Class&lt;?&gt;[] paramTypes = candidate.getParameterTypes();
   
			<span class="hljs-keyword">if</span> (paramTypes.length &gt;= minNrOfArgs) &#123;
				ArgumentsHolder argsHolder;
   
				<span class="hljs-keyword">if</span> (explicitArgs != <span class="hljs-keyword">null</span>) &#123;
					<span class="hljs-comment">// Explicit arguments given -&gt; arguments length must match exactly.</span>
					<span class="hljs-keyword">if</span> (paramTypes.length != explicitArgs.length) &#123;
						<span class="hljs-keyword">continue</span>;
					&#125;
					argsHolder = <span class="hljs-keyword">new</span> ArgumentsHolder(explicitArgs);
				&#125;
				<span class="hljs-keyword">else</span> &#123;
					<span class="hljs-comment">// Resolved constructor arguments: type conversion and/or autowiring necessary.</span>
					<span class="hljs-keyword">try</span> &#123;
						String[] paramNames = <span class="hljs-keyword">null</span>;
						ParameterNameDiscoverer pnd = <span class="hljs-keyword">this</span>.beanFactory.getParameterNameDiscoverer();
						<span class="hljs-keyword">if</span> (pnd != <span class="hljs-keyword">null</span>) &#123;
							paramNames = pnd.getParameterNames(candidate);
						&#125;
						argsHolder = createArgumentArray(beanName, mbd, resolvedValues, bw,
								paramTypes, paramNames, candidate, autowiring, candidates.length == <span class="hljs-number">1</span>);
					&#125;
					<span class="hljs-keyword">catch</span> (UnsatisfiedDependencyException ex) &#123;
						<span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;
							logger.trace(<span class="hljs-string">"Ignoring factory method ["</span> + candidate + <span class="hljs-string">"] of bean '"</span> + beanName + <span class="hljs-string">"': "</span> + ex);
						&#125;
						<span class="hljs-comment">// Swallow and try next overloaded factory method.</span>
						<span class="hljs-keyword">if</span> (causes == <span class="hljs-keyword">null</span>) &#123;
							causes = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();
						&#125;
						causes.add(ex);
						<span class="hljs-keyword">continue</span>;
					&#125;
				&#125;
   
				<span class="hljs-keyword">int</span> typeDiffWeight = (mbd.isLenientConstructorResolution() ?
						argsHolder.getTypeDifferenceWeight(paramTypes) : argsHolder.getAssignabilityWeight(paramTypes));
				<span class="hljs-comment">// Choose this factory method if it represents the closest match.</span>
				<span class="hljs-keyword">if</span> (typeDiffWeight &lt; minTypeDiffWeight) &#123;
					factoryMethodToUse = candidate;
					argsHolderToUse = argsHolder;
					argsToUse = argsHolder.arguments;
					minTypeDiffWeight = typeDiffWeight;
					ambiguousFactoryMethods = <span class="hljs-keyword">null</span>;
				&#125;
				<span class="hljs-comment">// Find out about ambiguity: In case of the same type difference weight</span>
				<span class="hljs-comment">// for methods with the same number of parameters, collect such candidates</span>
				<span class="hljs-comment">// and eventually raise an ambiguity exception.</span>
				<span class="hljs-comment">// However, only perform that check in non-lenient constructor resolution mode,</span>
				<span class="hljs-comment">// and explicitly ignore overridden methods (with the same parameter signature).</span>
				<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (factoryMethodToUse != <span class="hljs-keyword">null</span> &amp;&amp; typeDiffWeight == minTypeDiffWeight &amp;&amp;
						!mbd.isLenientConstructorResolution() &amp;&amp;
						paramTypes.length == factoryMethodToUse.getParameterCount() &amp;&amp;
						!Arrays.equals(paramTypes, factoryMethodToUse.getParameterTypes())) &#123;
					<span class="hljs-keyword">if</span> (ambiguousFactoryMethods == <span class="hljs-keyword">null</span>) &#123;
						ambiguousFactoryMethods = <span class="hljs-keyword">new</span> LinkedHashSet&lt;&gt;();
						ambiguousFactoryMethods.add(factoryMethodToUse);
					&#125;
					ambiguousFactoryMethods.add(candidate);
				&#125;
			&#125;
		&#125;
   
		<span class="hljs-keyword">if</span> (factoryMethodToUse == <span class="hljs-keyword">null</span>) &#123;
			<span class="hljs-keyword">if</span> (causes != <span class="hljs-keyword">null</span>) &#123;
				UnsatisfiedDependencyException ex = causes.removeLast();
				<span class="hljs-keyword">for</span> (Exception cause : causes) &#123;
					<span class="hljs-keyword">this</span>.beanFactory.onSuppressedException(cause);
				&#125;
				<span class="hljs-keyword">throw</span> ex;
			&#125;
			List&lt;String&gt; argTypes = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;(minNrOfArgs);
			<span class="hljs-keyword">if</span> (explicitArgs != <span class="hljs-keyword">null</span>) &#123;
				<span class="hljs-keyword">for</span> (Object arg : explicitArgs) &#123;
					argTypes.add(arg != <span class="hljs-keyword">null</span> ? arg.getClass().getSimpleName() : <span class="hljs-string">"null"</span>);
				&#125;
			&#125;
			<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (resolvedValues != <span class="hljs-keyword">null</span>) &#123;
				Set&lt;ValueHolder&gt; valueHolders = <span class="hljs-keyword">new</span> LinkedHashSet&lt;&gt;(resolvedValues.getArgumentCount());
				valueHolders.addAll(resolvedValues.getIndexedArgumentValues().values());
				valueHolders.addAll(resolvedValues.getGenericArgumentValues());
				<span class="hljs-keyword">for</span> (ValueHolder value : valueHolders) &#123;
					String argType = (value.getType() != <span class="hljs-keyword">null</span> ? ClassUtils.getShortName(value.getType()) :
							(value.getValue() != <span class="hljs-keyword">null</span> ? value.getValue().getClass().getSimpleName() : <span class="hljs-string">"null"</span>));
					argTypes.add(argType);
				&#125;
			&#125;
			String argDesc = StringUtils.collectionToCommaDelimitedString(argTypes);
			<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName,
					<span class="hljs-string">"No matching factory method found: "</span> +
					(mbd.getFactoryBeanName() != <span class="hljs-keyword">null</span> ?
						<span class="hljs-string">"factory bean '"</span> + mbd.getFactoryBeanName() + <span class="hljs-string">"'; "</span> : <span class="hljs-string">""</span>) +
					<span class="hljs-string">"factory method '"</span> + mbd.getFactoryMethodName() + <span class="hljs-string">"("</span> + argDesc + <span class="hljs-string">")'. "</span> +
					<span class="hljs-string">"Check that a method with the specified name "</span> +
					(minNrOfArgs &gt; <span class="hljs-number">0</span> ? <span class="hljs-string">"and arguments "</span> : <span class="hljs-string">""</span>) +
					<span class="hljs-string">"exists and that it is "</span> +
					(isStatic ? <span class="hljs-string">"static"</span> : <span class="hljs-string">"non-static"</span>) + <span class="hljs-string">"."</span>);
		&#125;
		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">void</span><span class="hljs-class">.<span class="hljs-keyword">class</span> </span>== factoryMethodToUse.getReturnType()) &#123;
			<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName,
					<span class="hljs-string">"Invalid factory method '"</span> + mbd.getFactoryMethodName() +
					<span class="hljs-string">"': needs to have a non-void return type!"</span>);
		&#125;
		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ambiguousFactoryMethods != <span class="hljs-keyword">null</span>) &#123;
			<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName,
					<span class="hljs-string">"Ambiguous factory method matches found in bean '"</span> + beanName + <span class="hljs-string">"' "</span> +
					<span class="hljs-string">"(hint: specify index/type/name arguments for simple parameters to avoid type ambiguities): "</span> +
					ambiguousFactoryMethods);
		&#125;
   
		<span class="hljs-keyword">if</span> (explicitArgs == <span class="hljs-keyword">null</span> &amp;&amp; argsHolderToUse != <span class="hljs-keyword">null</span>) &#123;
			mbd.factoryMethodToIntrospect = factoryMethodToUse;
			argsHolderToUse.storeCache(mbd, factoryMethodToUse);
		&#125;
	&#125;
   
	Assert.state(argsToUse != <span class="hljs-keyword">null</span>, <span class="hljs-string">"Unresolved factory method arguments"</span>);
	bw.setBeanInstance(instantiate(beanName, mbd, factoryBean, factoryMethodToUse, argsToUse));
	<span class="hljs-keyword">return</span> bw;
&#125;</code></pre>
</li>
<li><p>determineConstructorsFromBeanPostProcessors()é¦–å…ˆä¼šè·å–æ‰€æœ‰çš„BeanPostProcessorï¼Œç„¶åè°ƒç”¨determineCandidateConstructors()æ–¹æ³•è·å–å¸¦@Autowiredæ³¨è§£çš„æ„é€ å‡½æ•°ã€‚è¯¥æ–¹æ³•æ˜¯BeanPostProcessoræ¥å£ç±»çš„é¦–æ¬¡åº”ç”¨ï¼Œæœ€ç»ˆä¼šæ‰åˆ°AutowiredAnnotationBeanPostProcessorç±»çš„æ–¹æ³•ï¼Œåœ¨æ–¹æ³•ä¸­ä¼šæ‰«ææœ‰æ³¨è§£çš„æ„é€ å‡½æ•°å¹¶è¿”å›ã€‚</p>
<pre><code class="hljs java"><span class="hljs-keyword">protected</span> Constructor&lt;?&gt;[] determineConstructorsFromBeanPostProcessors(<span class="hljs-meta">@Nullable</span> Class&lt;?&gt; beanClass, String beanName)
		<span class="hljs-keyword">throws</span> BeansException &#123;
   
	<span class="hljs-keyword">if</span> (beanClass != <span class="hljs-keyword">null</span> &amp;&amp; hasInstantiationAwareBeanPostProcessors()) &#123;
		<span class="hljs-comment">//è·å–æ‰€æœ‰çš„BeanPostProcessors</span>
		<span class="hljs-keyword">for</span> (BeanPostProcessor bp : getBeanPostProcessors()) &#123;
			<span class="hljs-keyword">if</span> (bp <span class="hljs-keyword">instanceof</span> SmartInstantiationAwareBeanPostProcessor) &#123;
				SmartInstantiationAwareBeanPostProcessor ibp = (SmartInstantiationAwareBeanPostProcessor) bp;
				<span class="hljs-comment">//æ‰¾åˆ°åˆé€‚çš„æ„é€ å‡½æ•°</span>
				Constructor&lt;?&gt;[] ctors = ibp.determineCandidateConstructors(beanClass, beanName);
				<span class="hljs-keyword">if</span> (ctors != <span class="hljs-keyword">null</span>) &#123;
					<span class="hljs-keyword">return</span> ctors;
				&#125;
			&#125;
		&#125;
	&#125;
	<span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
&#125;</code></pre>
</li>
<li><p>AutowiredAnnotationBeanPostProcessorä¸­çš„determineCandidateConstructors()æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šè¿”å›æœ‰@Autowiredæ³¨è§£çš„æ„é€ å‡½æ•°ã€‚è¯¥æ–¹æ³•é¦–å…ˆä¼šæ‰«ææ‰€æœ‰æ–¹æ³•ï¼Œå¤„ç†æœ‰@Lookupæ³¨è§£çš„æ–¹æ³•ï¼Œç„¶åæ‹¿åˆ°æ‰€æœ‰çš„æ„é€ å‡½æ•°å¹¶ä½¿ç”¨findAutowiredAnnotation()æ–¹æ³•å¯¹@Autowiredè·Ÿ@Valueæ³¨è§£è¿›è¡Œæ‰«æï¼Œè¿”å›æœ‰@Autowiredçš„æ„é€ å‡½æ•°ã€‚</p>
<pre><code class="hljs java"><span class="hljs-keyword">public</span> Constructor&lt;?&gt;[] determineCandidateConstructors(Class&lt;?&gt; beanClass, <span class="hljs-keyword">final</span> String beanName)
		<span class="hljs-keyword">throws</span> BeanCreationException &#123;
   
	<span class="hljs-comment">// Let's check for lookup methods here..</span>
	<span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.lookupMethodsChecked.contains(beanName)) &#123;
		<span class="hljs-keyword">try</span> &#123;
			<span class="hljs-comment">//æ‹¿åˆ°æ‰€æœ‰æ–¹æ³•ï¼Œå¾ªç¯å›è°ƒlambdaä¸­çš„å†…å®¹</span>
			ReflectionUtils.doWithMethods(beanClass, method -&gt; &#123;
				<span class="hljs-comment">//å¯¹æ³¨è§£@Lookupçš„æ”¯æŒï¼Œè¯¥æ³¨è§£ç”¨äºæ›¿ä»£æ–¹æ³•è¿”å›å€¼</span>
				Lookup lookup = method.getAnnotation(Lookup<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
				<span class="hljs-keyword">if</span> (lookup != <span class="hljs-keyword">null</span>) &#123;
					Assert.state(<span class="hljs-keyword">this</span>.beanFactory != <span class="hljs-keyword">null</span>, <span class="hljs-string">"No BeanFactory available"</span>);
					LookupOverride override = <span class="hljs-keyword">new</span> LookupOverride(method, lookup.value());
					<span class="hljs-keyword">try</span> &#123;
						RootBeanDefinition mbd = (RootBeanDefinition) <span class="hljs-keyword">this</span>.beanFactory.getMergedBeanDefinition(beanName);
						mbd.getMethodOverrides().addOverride(override);
					&#125;
					<span class="hljs-keyword">catch</span> (NoSuchBeanDefinitionException ex) &#123;
						<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(beanName,
								<span class="hljs-string">"Cannot apply @Lookup to beans without corresponding bean definition"</span>);
					&#125;
				&#125;
			&#125;);
		&#125;
		<span class="hljs-keyword">catch</span> (IllegalStateException ex) &#123;
			<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(beanName, <span class="hljs-string">"Lookup method resolution failed"</span>, ex);
		&#125;
		<span class="hljs-keyword">this</span>.lookupMethodsChecked.add(beanName);
	&#125;
   
	<span class="hljs-comment">// Quick check on the concurrent map first, with minimal locking.</span>
	Constructor&lt;?&gt;[] candidateConstructors = <span class="hljs-keyword">this</span>.candidateConstructorsCache.get(beanClass);
	<span class="hljs-keyword">if</span> (candidateConstructors == <span class="hljs-keyword">null</span>) &#123;
		<span class="hljs-comment">// Fully synchronized resolution now...</span>
		<span class="hljs-keyword">synchronized</span> (<span class="hljs-keyword">this</span>.candidateConstructorsCache) &#123;
			candidateConstructors = <span class="hljs-keyword">this</span>.candidateConstructorsCache.get(beanClass);
			<span class="hljs-keyword">if</span> (candidateConstructors == <span class="hljs-keyword">null</span>) &#123;
				Constructor&lt;?&gt;[] rawCandidates;
				<span class="hljs-keyword">try</span> &#123;
					<span class="hljs-comment">//è·å–beanå¯¹åº”çš„æ‰€æœ‰æ„é€ å™¨</span>
					rawCandidates = beanClass.getDeclaredConstructors();
				&#125;
				<span class="hljs-keyword">catch</span> (Throwable ex) &#123;
					<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(beanName,
							<span class="hljs-string">"Resolution of declared constructors on bean Class ["</span> + beanClass.getName() +
							<span class="hljs-string">"] from ClassLoader ["</span> + beanClass.getClassLoader() + <span class="hljs-string">"] failed"</span>, ex);
				&#125;
				List&lt;Constructor&lt;?&gt;&gt; candidates = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;(rawCandidates.length);
				Constructor&lt;?&gt; requiredConstructor = <span class="hljs-keyword">null</span>;
				Constructor&lt;?&gt; defaultConstructor = <span class="hljs-keyword">null</span>;
				Constructor&lt;?&gt; primaryConstructor = BeanUtils.findPrimaryConstructor(beanClass);
				<span class="hljs-keyword">int</span> nonSyntheticConstructors = <span class="hljs-number">0</span>;
				<span class="hljs-keyword">for</span> (Constructor&lt;?&gt; candidate : rawCandidates) &#123;
					<span class="hljs-keyword">if</span> (!candidate.isSynthetic()) &#123;
						nonSyntheticConstructors++;
					&#125;
					<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (primaryConstructor != <span class="hljs-keyword">null</span>) &#123;
						<span class="hljs-keyword">continue</span>;
					&#125;
					<span class="hljs-comment">//è·å–åˆ°æ„é€ å‡½æ•°ä¸Šçš„@Autowiredæ³¨è§£ä¿¡æ¯,è¿™ä¸ªæ–¹æ³•å¯ä»¥ä¸çœ‹</span>
					AnnotationAttributes ann = findAutowiredAnnotation(candidate);
					<span class="hljs-keyword">if</span> (ann == <span class="hljs-keyword">null</span>) &#123;
						Class&lt;?&gt; userClass = ClassUtils.getUserClass(beanClass);
						<span class="hljs-keyword">if</span> (userClass != beanClass) &#123;
							<span class="hljs-keyword">try</span> &#123;
								Constructor&lt;?&gt; superCtor =
										userClass.getDeclaredConstructor(candidate.getParameterTypes());
   
								ann = findAutowiredAnnotation(superCtor);
							&#125;
							<span class="hljs-keyword">catch</span> (NoSuchMethodException ex) &#123;
								<span class="hljs-comment">// Simply proceed, no equivalent superclass constructor found...</span>
							&#125;
						&#125;
					&#125;
					<span class="hljs-keyword">if</span> (ann != <span class="hljs-keyword">null</span>) &#123;
						<span class="hljs-keyword">if</span> (requiredConstructor != <span class="hljs-keyword">null</span>) &#123;
							<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(beanName,
									<span class="hljs-string">"Invalid autowire-marked constructor: "</span> + candidate +
									<span class="hljs-string">". Found constructor with 'required' Autowired annotation already: "</span> +
									requiredConstructor);
						&#125;
						<span class="hljs-comment">//è·å–åˆ°@Autowiredé‡Œé¢çš„requiredæ–¹æ³•çš„å€¼</span>
						<span class="hljs-keyword">boolean</span> required = determineRequiredStatus(ann);
						<span class="hljs-keyword">if</span> (required) &#123;
							<span class="hljs-keyword">if</span> (!candidates.isEmpty()) &#123;
								<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(beanName,
										<span class="hljs-string">"Invalid autowire-marked constructors: "</span> + candidates +
										<span class="hljs-string">". Found constructor with 'required' Autowired annotation: "</span> +
										candidate);
							&#125;
							requiredConstructor = candidate;
						&#125;
						candidates.add(candidate);
					&#125;
					<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (candidate.getParameterCount() == <span class="hljs-number">0</span>) &#123;
						defaultConstructor = candidate;
					&#125;
				&#125;
				<span class="hljs-keyword">if</span> (!candidates.isEmpty()) &#123;
					<span class="hljs-comment">// Add default constructor to list of optional constructors, as fallback.</span>
					<span class="hljs-keyword">if</span> (requiredConstructor == <span class="hljs-keyword">null</span>) &#123;
						<span class="hljs-keyword">if</span> (defaultConstructor != <span class="hljs-keyword">null</span>) &#123;
							candidates.add(defaultConstructor);
						&#125;
						<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (candidates.size() == <span class="hljs-number">1</span> &amp;&amp; logger.isInfoEnabled()) &#123;
							logger.info(<span class="hljs-string">"Inconsistent constructor declaration on bean with name '"</span> + beanName +
									<span class="hljs-string">"': single autowire-marked constructor flagged as optional - "</span> +
									<span class="hljs-string">"this constructor is effectively required since there is no "</span> +
									<span class="hljs-string">"default constructor to fall back to: "</span> + candidates.get(<span class="hljs-number">0</span>));
						&#125;
					&#125;
					candidateConstructors = candidates.toArray(<span class="hljs-keyword">new</span> Constructor&lt;?&gt;[<span class="hljs-number">0</span>]);
				&#125;
				<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rawCandidates.length == <span class="hljs-number">1</span> &amp;&amp; rawCandidates[<span class="hljs-number">0</span>].getParameterCount() &gt; <span class="hljs-number">0</span>) &#123;
					candidateConstructors = <span class="hljs-keyword">new</span> Constructor&lt;?&gt;[] &#123;rawCandidates[<span class="hljs-number">0</span>]&#125;;
				&#125;
				<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (nonSyntheticConstructors == <span class="hljs-number">2</span> &amp;&amp; primaryConstructor != <span class="hljs-keyword">null</span> &amp;&amp;
						defaultConstructor != <span class="hljs-keyword">null</span> &amp;&amp; !primaryConstructor.equals(defaultConstructor)) &#123;
					candidateConstructors = <span class="hljs-keyword">new</span> Constructor&lt;?&gt;[] &#123;primaryConstructor, defaultConstructor&#125;;
				&#125;
				<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (nonSyntheticConstructors == <span class="hljs-number">1</span> &amp;&amp; primaryConstructor != <span class="hljs-keyword">null</span>) &#123;
					candidateConstructors = <span class="hljs-keyword">new</span> Constructor&lt;?&gt;[] &#123;primaryConstructor&#125;;
				&#125;
				<span class="hljs-keyword">else</span> &#123;
					candidateConstructors = <span class="hljs-keyword">new</span> Constructor&lt;?&gt;[<span class="hljs-number">0</span>];
				&#125;
				<span class="hljs-keyword">this</span>.candidateConstructorsCache.put(beanClass, candidateConstructors);
			&#125;
		&#125;
	&#125;
	<span class="hljs-keyword">return</span> (candidateConstructors.length &gt; <span class="hljs-number">0</span> ? candidateConstructors : <span class="hljs-keyword">null</span>);
&#125;</code></pre>
</li>
<li><p>autowireConstructor()æ–¹æ³•ä¸­ä¼šè·å–@Autowiredçš„å‚æ•°ï¼Œè¿‡ç¨‹ä¸­ä¼šè§¦å‘getBean()æ–¹æ³•ï¼Œæ­¤æ—¶çš„getBean()æ–¹æ³•å¯èƒ½æ˜¯ä»ç¼“å­˜ä¸­è·å–ã€‚è·å–åˆ°å‚æ•°åä½¿ç”¨åå°„åˆ›å»ºå®ä¾‹å¹¶åŒ…è£…ä¸ºBeanWrapperImplåè¿”å›ã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> BeanWrapper <span class="hljs-title">autowireConstructor</span><span class="hljs-params">(String beanName, RootBeanDefinition mbd,</span></span>
<span class="hljs-function"><span class="hljs-params">			@Nullable Constructor&lt;?&gt;[] chosenCtors, @Nullable Object[] explicitArgs)</span> </span>&#123;

		BeanWrapperImpl bw = <span class="hljs-keyword">new</span> BeanWrapperImpl();
		<span class="hljs-comment">//å¿½ç•¥å¯ä»¥ä¸çœ‹ï¼Œè®¾ç½®ç±»å‹è½¬æ¢å™¨ï¼Œæ³¨å†Œè‡ªå®šä¹‰ç¼–è¾‘å™¨</span>
		<span class="hljs-keyword">this</span>.beanFactory.initBeanWrapper(bw);

		Constructor&lt;?&gt; constructorToUse = <span class="hljs-keyword">null</span>;
		ArgumentsHolder argsHolderToUse = <span class="hljs-keyword">null</span>;
		Object[] argsToUse = <span class="hljs-keyword">null</span>;

		<span class="hljs-keyword">if</span> (explicitArgs != <span class="hljs-keyword">null</span>) &#123;
			argsToUse = explicitArgs;
		&#125;
		<span class="hljs-keyword">else</span> &#123;
			Object[] argsToResolve = <span class="hljs-keyword">null</span>;
			<span class="hljs-keyword">synchronized</span> (mbd.constructorArgumentLock) &#123;
				constructorToUse = (Constructor&lt;?&gt;) mbd.resolvedConstructorOrFactoryMethod;
				<span class="hljs-keyword">if</span> (constructorToUse != <span class="hljs-keyword">null</span> &amp;&amp; mbd.constructorArgumentsResolved) &#123;
					<span class="hljs-comment">// Found a cached constructor...</span>
					argsToUse = mbd.resolvedConstructorArguments;
					<span class="hljs-keyword">if</span> (argsToUse == <span class="hljs-keyword">null</span>) &#123;
						argsToResolve = mbd.preparedConstructorArguments;
					&#125;
				&#125;
			&#125;
			<span class="hljs-keyword">if</span> (argsToResolve != <span class="hljs-keyword">null</span>) &#123;
				argsToUse = resolvePreparedArguments(beanName, mbd, bw, constructorToUse, argsToResolve, <span class="hljs-keyword">true</span>);
			&#125;
		&#125;

		<span class="hljs-keyword">if</span> (constructorToUse == <span class="hljs-keyword">null</span> || argsToUse == <span class="hljs-keyword">null</span>) &#123;
			<span class="hljs-comment">// Take specified constructors, if any.</span>
			Constructor&lt;?&gt;[] candidates = chosenCtors;
			<span class="hljs-keyword">if</span> (candidates == <span class="hljs-keyword">null</span>) &#123;
				Class&lt;?&gt; beanClass = mbd.getBeanClass();
				<span class="hljs-keyword">try</span> &#123;
					candidates = (mbd.isNonPublicAccessAllowed() ?
							beanClass.getDeclaredConstructors() : beanClass.getConstructors());
				&#125;
				<span class="hljs-keyword">catch</span> (Throwable ex) &#123;
					<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName,
							<span class="hljs-string">"Resolution of declared constructors on bean Class ["</span> + beanClass.getName() +
							<span class="hljs-string">"] from ClassLoader ["</span> + beanClass.getClassLoader() + <span class="hljs-string">"] failed"</span>, ex);
				&#125;
			&#125;

			<span class="hljs-comment">//mbd.hasConstructorArgumentValues()è¿™ä¸ªæ˜¯falseçš„ï¼Œå› ä¸ºæ˜¯@Autowiredçš„æ„é€ å‡½æ•°ï¼Œä¸æ˜¯&lt;constructor-arg&gt;æ ‡ç­¾</span>
			<span class="hljs-keyword">if</span> (candidates.length == <span class="hljs-number">1</span> &amp;&amp; explicitArgs == <span class="hljs-keyword">null</span> &amp;&amp; !mbd.hasConstructorArgumentValues()) &#123;
				Constructor&lt;?&gt; uniqueCandidate = candidates[<span class="hljs-number">0</span>];
				<span class="hljs-comment">//å¦‚æœæ˜¯æ— å‚æ„é€ å‡½æ•°</span>
				<span class="hljs-keyword">if</span> (uniqueCandidate.getParameterCount() == <span class="hljs-number">0</span>) &#123;
					<span class="hljs-keyword">synchronized</span> (mbd.constructorArgumentLock) &#123;
						mbd.resolvedConstructorOrFactoryMethod = uniqueCandidate;
						mbd.constructorArgumentsResolved = <span class="hljs-keyword">true</span>;
						mbd.resolvedConstructorArguments = EMPTY_ARGS;
					&#125;
					bw.setBeanInstance(instantiate(beanName, mbd, uniqueCandidate, EMPTY_ARGS));
					<span class="hljs-keyword">return</span> bw;
				&#125;
			&#125;

			<span class="hljs-comment">// Need to resolve the constructor.</span>
			<span class="hljs-keyword">boolean</span> autowiring = (chosenCtors != <span class="hljs-keyword">null</span> ||
					mbd.getResolvedAutowireMode() == AutowireCapableBeanFactory.AUTOWIRE_CONSTRUCTOR);
			ConstructorArgumentValues resolvedValues = <span class="hljs-keyword">null</span>;

			<span class="hljs-keyword">int</span> minNrOfArgs;
			<span class="hljs-keyword">if</span> (explicitArgs != <span class="hljs-keyword">null</span>) &#123;
				minNrOfArgs = explicitArgs.length;
			&#125;
			<span class="hljs-keyword">else</span> &#123;
				ConstructorArgumentValues cargs = mbd.getConstructorArgumentValues();
				resolvedValues = <span class="hljs-keyword">new</span> ConstructorArgumentValues();
				minNrOfArgs = resolveConstructorArguments(beanName, mbd, bw, cargs, resolvedValues);
			&#125;

			AutowireUtils.sortConstructors(candidates);
			<span class="hljs-keyword">int</span> minTypeDiffWeight = Integer.MAX_VALUE;
			Set&lt;Constructor&lt;?&gt;&gt; ambiguousConstructors = <span class="hljs-keyword">null</span>;
			LinkedList&lt;UnsatisfiedDependencyException&gt; causes = <span class="hljs-keyword">null</span>;

			<span class="hljs-keyword">for</span> (Constructor&lt;?&gt; candidate : candidates) &#123;
				<span class="hljs-comment">//è·å–åˆ°æ„é€ å‡½æ•°çš„å‚æ•°ç±»å‹</span>
				Class&lt;?&gt;[] paramTypes = candidate.getParameterTypes();

				<span class="hljs-keyword">if</span> (constructorToUse != <span class="hljs-keyword">null</span> &amp;&amp; argsToUse != <span class="hljs-keyword">null</span> &amp;&amp; argsToUse.length &gt; paramTypes.length) &#123;
					<span class="hljs-comment">// Already found greedy constructor that can be satisfied -&gt;</span>
					<span class="hljs-comment">// do not look any further, there are only less greedy constructors left.</span>
					<span class="hljs-keyword">break</span>;
				&#125;
				<span class="hljs-keyword">if</span> (paramTypes.length &lt; minNrOfArgs) &#123;
					<span class="hljs-keyword">continue</span>;
				&#125;

				ArgumentsHolder argsHolder;
				<span class="hljs-keyword">if</span> (resolvedValues != <span class="hljs-keyword">null</span>) &#123;
					<span class="hljs-keyword">try</span> &#123;
						String[] paramNames = ConstructorPropertiesChecker.evaluate(candidate, paramTypes.length);
						<span class="hljs-keyword">if</span> (paramNames == <span class="hljs-keyword">null</span>) &#123;
							ParameterNameDiscoverer pnd = <span class="hljs-keyword">this</span>.beanFactory.getParameterNameDiscoverer();
							<span class="hljs-keyword">if</span> (pnd != <span class="hljs-keyword">null</span>) &#123;
								<span class="hljs-comment">//è·å–æ„é€ å‡½æ•°ä¸­å‚æ•°çš„åç§°</span>
								paramNames = pnd.getParameterNames(candidate);
							&#125;
						&#125;
						<span class="hljs-comment">//è·å–åˆ°å‚æ•°çš„å€¼ï¼Œå»ºè®®ä¸è¦çœ‹ï¼Œæ¯”è¾ƒæ·±ï¼Œä¸»æµç¨‹å¼„æ‡‚åå†å»ç»†ç»†æ‰“ç£¨</span>
						argsHolder = createArgumentArray(beanName, mbd, resolvedValues, bw, paramTypes, paramNames,
								getUserDeclaredConstructor(candidate), autowiring, candidates.length == <span class="hljs-number">1</span>);
					&#125;
					<span class="hljs-keyword">catch</span> (UnsatisfiedDependencyException ex) &#123;
						<span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;
							logger.trace(<span class="hljs-string">"Ignoring constructor ["</span> + candidate + <span class="hljs-string">"] of bean '"</span> + beanName + <span class="hljs-string">"': "</span> + ex);
						&#125;
						<span class="hljs-comment">// Swallow and try next constructor.</span>
						<span class="hljs-keyword">if</span> (causes == <span class="hljs-keyword">null</span>) &#123;
							causes = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();
						&#125;
						causes.add(ex);
						<span class="hljs-keyword">continue</span>;
					&#125;
				&#125;
				<span class="hljs-keyword">else</span> &#123;
					<span class="hljs-comment">// Explicit arguments given -&gt; arguments length must match exactly.</span>
					<span class="hljs-keyword">if</span> (paramTypes.length != explicitArgs.length) &#123;
						<span class="hljs-keyword">continue</span>;
					&#125;
					argsHolder = <span class="hljs-keyword">new</span> ArgumentsHolder(explicitArgs);
				&#125;

				<span class="hljs-keyword">int</span> typeDiffWeight = (mbd.isLenientConstructorResolution() ?
						argsHolder.getTypeDifferenceWeight(paramTypes) : argsHolder.getAssignabilityWeight(paramTypes));
				<span class="hljs-comment">// Choose this constructor if it represents the closest match.</span>
				<span class="hljs-keyword">if</span> (typeDiffWeight &lt; minTypeDiffWeight) &#123;
					constructorToUse = candidate;
					argsHolderToUse = argsHolder;
					argsToUse = argsHolder.arguments;
					minTypeDiffWeight = typeDiffWeight;
					ambiguousConstructors = <span class="hljs-keyword">null</span>;
				&#125;
				<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (constructorToUse != <span class="hljs-keyword">null</span> &amp;&amp; typeDiffWeight == minTypeDiffWeight) &#123;
					<span class="hljs-keyword">if</span> (ambiguousConstructors == <span class="hljs-keyword">null</span>) &#123;
						ambiguousConstructors = <span class="hljs-keyword">new</span> LinkedHashSet&lt;&gt;();
						ambiguousConstructors.add(constructorToUse);
					&#125;
					ambiguousConstructors.add(candidate);
				&#125;
			&#125;

			<span class="hljs-keyword">if</span> (constructorToUse == <span class="hljs-keyword">null</span>) &#123;
				<span class="hljs-keyword">if</span> (causes != <span class="hljs-keyword">null</span>) &#123;
					UnsatisfiedDependencyException ex = causes.removeLast();
					<span class="hljs-keyword">for</span> (Exception cause : causes) &#123;
						<span class="hljs-keyword">this</span>.beanFactory.onSuppressedException(cause);
					&#125;
					<span class="hljs-keyword">throw</span> ex;
				&#125;
				<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName,
						<span class="hljs-string">"Could not resolve matching constructor "</span> +
						<span class="hljs-string">"(hint: specify index/type/name arguments for simple parameters to avoid type ambiguities)"</span>);
			&#125;
			<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ambiguousConstructors != <span class="hljs-keyword">null</span> &amp;&amp; !mbd.isLenientConstructorResolution()) &#123;
				<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName,
						<span class="hljs-string">"Ambiguous constructor matches found in bean '"</span> + beanName + <span class="hljs-string">"' "</span> +
						<span class="hljs-string">"(hint: specify index/type/name arguments for simple parameters to avoid type ambiguities): "</span> +
						ambiguousConstructors);
			&#125;

			<span class="hljs-keyword">if</span> (explicitArgs == <span class="hljs-keyword">null</span> &amp;&amp; argsHolderToUse != <span class="hljs-keyword">null</span>) &#123;
				argsHolderToUse.storeCache(mbd, constructorToUse);
			&#125;
		&#125;

		Assert.state(argsToUse != <span class="hljs-keyword">null</span>, <span class="hljs-string">"Unresolved constructor arguments"</span>);

		<span class="hljs-comment">//æœ‰å‚æ„é€ å‡½æ•°çš„å®ä¾‹åŒ–ï¼Œåå°„å®ä¾‹åŒ–</span>
		bw.setBeanInstance(instantiate(beanName, mbd, constructorToUse, argsToUse));
		<span class="hljs-keyword">return</span> bw;
	&#125;</code></pre>


</li>
</ol>
<h3 id="applyMergedBeanDefinitionPostProcessors-æ–¹æ³•"><a href="#applyMergedBeanDefinitionPostProcessors-æ–¹æ³•" class="headerlink" title="applyMergedBeanDefinitionPostProcessors()æ–¹æ³•"></a>applyMergedBeanDefinitionPostProcessors()æ–¹æ³•</h3><ol>
<li><p>applyMergedBeanDefinitionPostProcessors()æ–¹æ³•ä¼šæ‹¿åˆ°æ‰€æœ‰çš„BeanPostProcessoræ¥å£ï¼Œç„¶åè°ƒç”¨MergedBeanDefinitionPostProcessoræ¥å£çš„postProcessMergedBeanDefinition()æ–¹æ³•å®Œæˆæ³¨è§£çš„æ”¶é›†ã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">applyMergedBeanDefinitionPostProcessors</span><span class="hljs-params">(RootBeanDefinition mbd, Class&lt;?&gt; beanType, String beanName)</span> </span>&#123;
	<span class="hljs-keyword">for</span> (BeanPostProcessor bp : getBeanPostProcessors()) &#123;
		<span class="hljs-keyword">if</span> (bp <span class="hljs-keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;
			MergedBeanDefinitionPostProcessor bdp = (MergedBeanDefinitionPostProcessor) bp;
			bdp.postProcessMergedBeanDefinition(mbd, beanType, beanName);
		&#125;
	&#125;
&#125;</code></pre>
</li>
<li><p>CommonAnnotationBeanPostProcessorçš„postProcessMergedBeanDefinition()æ–¹æ³•ä¼šè°ƒç”¨InitDestroyAnnotationBeanPostProcessorçš„postProcessMergedBeanDefinition()æ–¹æ³•å®Œæˆ@postConstructè·Ÿ@PreDestory()æ³¨è§£çš„æ‰«æï¼Œç„¶åè°ƒç”¨findResourceMetadata()æ‰«æ@Resourceæ³¨è§£ã€‚</p>
<pre><code class="hljs reasonml">public void post<span class="hljs-constructor">ProcessMergedBeanDefinition(RootBeanDefinition <span class="hljs-params">beanDefinition</span>, Class&lt;?&gt; <span class="hljs-params">beanType</span>, String <span class="hljs-params">beanName</span>)</span> &#123;
	<span class="hljs-comment">//æ‰«æ@PostConstruct @PreDestroy</span>
	super.post<span class="hljs-constructor">ProcessMergedBeanDefinition(<span class="hljs-params">beanDefinition</span>, <span class="hljs-params">beanType</span>, <span class="hljs-params">beanName</span>)</span>;
	<span class="hljs-comment">//æ‰«æ@Resource,æ‰«æå±æ€§å’Œæ–¹æ³•ä¸Šé¢æ˜¯å¦æœ‰@Resourceæ³¨è§£ï¼Œå¦‚æœæœ‰åˆ™æ”¶é›†èµ·æ¥å°è£…æˆå¯¹è±¡</span>
	InjectionMetadata metadata = find<span class="hljs-constructor">ResourceMetadata(<span class="hljs-params">beanName</span>, <span class="hljs-params">beanType</span>, <span class="hljs-params">null</span>)</span>;
	metadata.check<span class="hljs-constructor">ConfigMembers(<span class="hljs-params">beanDefinition</span>)</span>;
&#125;</code></pre>
</li>
<li><p>InitDestroyAnnotationBeanPostProcessorçš„postProcessMergedBeanDefinition()æ–¹æ³•ä¼šè°ƒç”¨findLifecycleMetadata()æ–¹æ³•ï¼Œç„¶åå†æ¬¡å°è£…å…¶è¿”å›çš„LifecycleMetadataå¯¹è±¡ã€‚buildLifecycleMetadata()æ˜¯findLifecycleMetadata()çš„æ ¸å¿ƒæ–¹æ³•ï¼Œä¼šå¾ªç¯åˆ¤æ–­ç±»ä¸­çš„æ‰€æœ‰æ–¹æ³•æ˜¯å¦æœ‰@postConstructè·Ÿ@PreDestory()æ³¨è§£ï¼Œå¦‚æœæœ‰å°±å°†è¿™ä¸ªæ–¹æ³•æ”¾åˆ°å®¹å™¨ä¸­ï¼Œæœ€ååŒ…è£…ä¸ºLifecycleMetadataå¹¶è¿”å›ã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> LifecycleMetadata <span class="hljs-title">buildLifecycleMetadata</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Class&lt;?&gt; clazz)</span> </span>&#123;
	List&lt;LifecycleElement&gt; initMethods = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
	List&lt;LifecycleElement&gt; destroyMethods = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
	Class&lt;?&gt; targetClass = clazz;
   
	<span class="hljs-keyword">do</span> &#123;
		<span class="hljs-keyword">final</span> List&lt;LifecycleElement&gt; currInitMethods = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
		<span class="hljs-keyword">final</span> List&lt;LifecycleElement&gt; currDestroyMethods = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
   
		ReflectionUtils.doWithLocalMethods(targetClass, method -&gt; &#123;
			<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.initAnnotationType != <span class="hljs-keyword">null</span> &amp;&amp; method.isAnnotationPresent(<span class="hljs-keyword">this</span>.initAnnotationType)) &#123;
				LifecycleElement element = <span class="hljs-keyword">new</span> LifecycleElement(method);
				currInitMethods.add(element);
				<span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;
					logger.trace(<span class="hljs-string">"Found init method on class ["</span> + clazz.getName() + <span class="hljs-string">"]: "</span> + method);
				&#125;
			&#125;
			<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.destroyAnnotationType != <span class="hljs-keyword">null</span> &amp;&amp; method.isAnnotationPresent(<span class="hljs-keyword">this</span>.destroyAnnotationType)) &#123;
				currDestroyMethods.add(<span class="hljs-keyword">new</span> LifecycleElement(method));
				<span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;
					logger.trace(<span class="hljs-string">"Found destroy method on class ["</span> + clazz.getName() + <span class="hljs-string">"]: "</span> + method);
				&#125;
			&#125;
		&#125;);
   
		initMethods.addAll(<span class="hljs-number">0</span>, currInitMethods);
		destroyMethods.addAll(currDestroyMethods);
		targetClass = targetClass.getSuperclass();
	&#125;
	<span class="hljs-keyword">while</span> (targetClass != <span class="hljs-keyword">null</span> &amp;&amp; targetClass != Object<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
   
	<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> LifecycleMetadata(clazz, initMethods, destroyMethods);
&#125;</code></pre>
</li>
<li><p>findResourceMetadata()æ–¹æ³•ä¼šè°ƒç”¨buildResourceMetadata()æ–¹æ³•è·å–åŒ…è£…åçš„InjectionMetadataï¼Œæ”¾å…¥ç¼“å­˜åè¿”å›ã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> InjectionMetadata <span class="hljs-title">findResourceMetadata</span><span class="hljs-params">(String beanName, <span class="hljs-keyword">final</span> Class&lt;?&gt; clazz, @Nullable PropertyValues pvs)</span> </span>&#123;
	<span class="hljs-comment">// Fall back to class name as cache key, for backwards compatibility with custom callers.</span>
	String cacheKey = (StringUtils.hasLength(beanName) ? beanName : clazz.getName());
	<span class="hljs-comment">// Quick check on the concurrent map first, with minimal locking.</span>
	InjectionMetadata metadata = <span class="hljs-keyword">this</span>.injectionMetadataCache.get(cacheKey);
	<span class="hljs-keyword">if</span> (InjectionMetadata.needsRefresh(metadata, clazz)) &#123;
		<span class="hljs-keyword">synchronized</span> (<span class="hljs-keyword">this</span>.injectionMetadataCache) &#123;
			metadata = <span class="hljs-keyword">this</span>.injectionMetadataCache.get(cacheKey);
			<span class="hljs-keyword">if</span> (InjectionMetadata.needsRefresh(metadata, clazz)) &#123;
				<span class="hljs-keyword">if</span> (metadata != <span class="hljs-keyword">null</span>) &#123;
					metadata.clear(pvs);
				&#125;
				<span class="hljs-comment">//ä¸»è¦çœ‹è¿™ä¸ªæ–¹æ³•</span>
				metadata = buildResourceMetadata(clazz);
				<span class="hljs-keyword">this</span>.injectionMetadataCache.put(cacheKey, metadata);
			&#125;
		&#125;
	&#125;
	<span class="hljs-keyword">return</span> metadata;
&#125;</code></pre>
</li>
<li><p>buildResourceMetadata()æ–¹æ³•ä¼šå»è·å–ç±»ä¸Šçš„æ‰€æœ‰å±æ€§ï¼Œç„¶åå¾ªç¯è°ƒç”¨lambdaä¸­çš„å†…å®¹æ”¾åˆ°å®¹å™¨ä¸­ï¼Œæœ€åå°è£…ä¸ºInjectionMetadataå¯¹è±¡åè¿”å›ã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> InjectionMetadata <span class="hljs-title">buildResourceMetadata</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Class&lt;?&gt; clazz)</span> </span>&#123;
	List&lt;InjectionMetadata.InjectedElement&gt; elements = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
	Class&lt;?&gt; targetClass = clazz;
   
	<span class="hljs-keyword">do</span> &#123;
		<span class="hljs-keyword">final</span> List&lt;InjectionMetadata.InjectedElement&gt; currElements = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
   
		ReflectionUtils.doWithLocalFields(targetClass, field -&gt; &#123;
			<span class="hljs-keyword">if</span> (webServiceRefClass != <span class="hljs-keyword">null</span> &amp;&amp; field.isAnnotationPresent(webServiceRefClass)) &#123;
				<span class="hljs-keyword">if</span> (Modifier.isStatic(field.getModifiers())) &#123;
					<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(<span class="hljs-string">"@WebServiceRef annotation is not supported on static fields"</span>);
				&#125;
				currElements.add(<span class="hljs-keyword">new</span> WebServiceRefElement(field, field, <span class="hljs-keyword">null</span>));
			&#125;
			<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ejbRefClass != <span class="hljs-keyword">null</span> &amp;&amp; field.isAnnotationPresent(ejbRefClass)) &#123;
				<span class="hljs-keyword">if</span> (Modifier.isStatic(field.getModifiers())) &#123;
					<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(<span class="hljs-string">"@EJB annotation is not supported on static fields"</span>);
				&#125;
				currElements.add(<span class="hljs-keyword">new</span> EjbRefElement(field, field, <span class="hljs-keyword">null</span>));
			&#125;
			<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (field.isAnnotationPresent(Resource<span class="hljs-class">.<span class="hljs-keyword">class</span>)) </span>&#123;
				<span class="hljs-keyword">if</span> (Modifier.isStatic(field.getModifiers())) &#123;
					<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(<span class="hljs-string">"@Resource annotation is not supported on static fields"</span>);
				&#125;
				<span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.ignoredResourceTypes.contains(field.getType().getName())) &#123;
					currElements.add(<span class="hljs-keyword">new</span> ResourceElement(field, field, <span class="hljs-keyword">null</span>));
				&#125;
			&#125;
		&#125;);
   
		ReflectionUtils.doWithLocalMethods(targetClass, method -&gt; &#123;
			Method bridgedMethod = BridgeMethodResolver.findBridgedMethod(method);
			<span class="hljs-keyword">if</span> (!BridgeMethodResolver.isVisibilityBridgeMethodPair(method, bridgedMethod)) &#123;
				<span class="hljs-keyword">return</span>;
			&#125;
			<span class="hljs-keyword">if</span> (method.equals(ClassUtils.getMostSpecificMethod(method, clazz))) &#123;
				<span class="hljs-keyword">if</span> (webServiceRefClass != <span class="hljs-keyword">null</span> &amp;&amp; bridgedMethod.isAnnotationPresent(webServiceRefClass)) &#123;
					<span class="hljs-keyword">if</span> (Modifier.isStatic(method.getModifiers())) &#123;
						<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(<span class="hljs-string">"@WebServiceRef annotation is not supported on static methods"</span>);
					&#125;
					<span class="hljs-keyword">if</span> (method.getParameterCount() != <span class="hljs-number">1</span>) &#123;
						<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(<span class="hljs-string">"@WebServiceRef annotation requires a single-arg method: "</span> + method);
					&#125;
					PropertyDescriptor pd = BeanUtils.findPropertyForMethod(bridgedMethod, clazz);
					currElements.add(<span class="hljs-keyword">new</span> WebServiceRefElement(method, bridgedMethod, pd));
				&#125;
				<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ejbRefClass != <span class="hljs-keyword">null</span> &amp;&amp; bridgedMethod.isAnnotationPresent(ejbRefClass)) &#123;
					<span class="hljs-keyword">if</span> (Modifier.isStatic(method.getModifiers())) &#123;
						<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(<span class="hljs-string">"@EJB annotation is not supported on static methods"</span>);
					&#125;
					<span class="hljs-keyword">if</span> (method.getParameterCount() != <span class="hljs-number">1</span>) &#123;
						<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(<span class="hljs-string">"@EJB annotation requires a single-arg method: "</span> + method);
					&#125;
					PropertyDescriptor pd = BeanUtils.findPropertyForMethod(bridgedMethod, clazz);
					currElements.add(<span class="hljs-keyword">new</span> EjbRefElement(method, bridgedMethod, pd));
				&#125;
				<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (bridgedMethod.isAnnotationPresent(Resource<span class="hljs-class">.<span class="hljs-keyword">class</span>)) </span>&#123;
					<span class="hljs-keyword">if</span> (Modifier.isStatic(method.getModifiers())) &#123;
						<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(<span class="hljs-string">"@Resource annotation is not supported on static methods"</span>);
					&#125;
					Class&lt;?&gt;[] paramTypes = method.getParameterTypes();
					<span class="hljs-keyword">if</span> (paramTypes.length != <span class="hljs-number">1</span>) &#123;
						<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(<span class="hljs-string">"@Resource annotation requires a single-arg method: "</span> + method);
					&#125;
					<span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.ignoredResourceTypes.contains(paramTypes[<span class="hljs-number">0</span>].getName())) &#123;
						PropertyDescriptor pd = BeanUtils.findPropertyForMethod(bridgedMethod, clazz);
						currElements.add(<span class="hljs-keyword">new</span> ResourceElement(method, bridgedMethod, pd));
					&#125;
				&#125;
			&#125;
		&#125;);
   
		elements.addAll(<span class="hljs-number">0</span>, currElements);
		targetClass = targetClass.getSuperclass();
	&#125;
	<span class="hljs-keyword">while</span> (targetClass != <span class="hljs-keyword">null</span> &amp;&amp; targetClass != Object<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
   
	<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> InjectionMetadata(clazz, elements);
&#125;</code></pre>

</li>
</ol>
<p>æ³¨ï¼šå…¶ä»–ç±»å‹çš„BeanPostProcessoræ”¶é›†è¿‡ç¨‹ä¸InitDestroyAnnotationBeanPostProcessoråŸºæœ¬ç›¸åŒï¼Œåªæ˜¯æ‰«æçš„æ³¨è§£ä¸åŒï¼Œæ­¤å¤„ä¸åœ¨èµ˜è¿°ã€‚</p>
<h3 id="populateBean-æ–¹æ³•"><a href="#populateBean-æ–¹æ³•" class="headerlink" title="populateBean()æ–¹æ³•"></a>populateBean()æ–¹æ³•</h3><ol>
<li><p>ä¾èµ–æ³¨å…¥çš„æ ¸å¿ƒæ–¹æ³•ï¼Œä¸»è¦æ–¹æ³•ä¸ºpostProcessProperties()ï¼Œä¾æ®applyMergedBeanDefinitionPostProcessorsæ”¶é›†çš„æ³¨è§£è¿›è¡Œä¾èµ–æ³¨å…¥ã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">populateBean</span><span class="hljs-params">(String beanName, RootBeanDefinition mbd, @Nullable BeanWrapper bw)</span> </span>&#123;
	<span class="hljs-keyword">if</span> (bw == <span class="hljs-keyword">null</span>) &#123;
		<span class="hljs-keyword">if</span> (mbd.hasPropertyValues()) &#123;
			<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(
					mbd.getResourceDescription(), beanName, <span class="hljs-string">"Cannot apply property values to null instance"</span>);
		&#125;
		<span class="hljs-keyword">else</span> &#123;
			<span class="hljs-comment">// Skip property population phase for null instance.</span>
			<span class="hljs-keyword">return</span>;
		&#125;
	&#125;
   
	<span class="hljs-comment">// Give any InstantiationAwareBeanPostProcessors the opportunity to modify the</span>
	<span class="hljs-comment">// state of the bean before properties are set. This can be used, for example,</span>
	<span class="hljs-comment">// to support styles of field injection.</span>
	<span class="hljs-keyword">boolean</span> continueWithPropertyPopulation = <span class="hljs-keyword">true</span>;
   
	<span class="hljs-comment">//è¿™é‡Œå¾ˆæœ‰æ„æ€ï¼Œå†™æ¥å£å¯ä»¥è®©æ‰€æœ‰ç±»éƒ½ä¸èƒ½ä¾èµ–æ³¨å…¥</span>
	<span class="hljs-keyword">if</span> (!mbd.isSynthetic() &amp;&amp; hasInstantiationAwareBeanPostProcessors()) &#123;
		<span class="hljs-keyword">for</span> (BeanPostProcessor bp : getBeanPostProcessors()) &#123;
			<span class="hljs-keyword">if</span> (bp <span class="hljs-keyword">instanceof</span> InstantiationAwareBeanPostProcessor) &#123;
				InstantiationAwareBeanPostProcessor ibp = (InstantiationAwareBeanPostProcessor) bp;
				<span class="hljs-keyword">if</span> (!ibp.postProcessAfterInstantiation(bw.getWrappedInstance(), beanName)) &#123;
   
					<span class="hljs-comment">//æ˜¯å¦éœ€è¦DIï¼Œä¾èµ–æ³¨å…¥</span>
					continueWithPropertyPopulation = <span class="hljs-keyword">false</span>;
					<span class="hljs-keyword">break</span>;
				&#125;
			&#125;
		&#125;
	&#125;
   
	<span class="hljs-keyword">if</span> (!continueWithPropertyPopulation) &#123;
		<span class="hljs-keyword">return</span>;
	&#125;
   
	PropertyValues pvs = (mbd.hasPropertyValues() ? mbd.getPropertyValues() : <span class="hljs-keyword">null</span>);
   
	<span class="hljs-keyword">if</span> (mbd.getResolvedAutowireMode() == AUTOWIRE_BY_NAME || mbd.getResolvedAutowireMode() == AUTOWIRE_BY_TYPE) &#123;
		MutablePropertyValues newPvs = <span class="hljs-keyword">new</span> MutablePropertyValues(pvs);
		<span class="hljs-comment">// Add property values based on autowire by name if applicable.</span>
		<span class="hljs-keyword">if</span> (mbd.getResolvedAutowireMode() == AUTOWIRE_BY_NAME) &#123;
			autowireByName(beanName, mbd, bw, newPvs);
		&#125;
		<span class="hljs-comment">// Add property values based on autowire by type if applicable.</span>
		<span class="hljs-keyword">if</span> (mbd.getResolvedAutowireMode() == AUTOWIRE_BY_TYPE) &#123;
			autowireByType(beanName, mbd, bw, newPvs);
		&#125;
		pvs = newPvs;
	&#125;
   
	<span class="hljs-keyword">boolean</span> hasInstAwareBpps = hasInstantiationAwareBeanPostProcessors();
	<span class="hljs-keyword">boolean</span> needsDepCheck = (mbd.getDependencyCheck() != AbstractBeanDefinition.DEPENDENCY_CHECK_NONE);
   
	PropertyDescriptor[] filteredPds = <span class="hljs-keyword">null</span>;
   
	<span class="hljs-comment">//é‡ç‚¹çœ‹è¿™ä¸ªifä»£ç å—ï¼Œé‡è¦ç¨‹åº¦ 5</span>
	<span class="hljs-keyword">if</span> (hasInstAwareBpps) &#123;
		<span class="hljs-keyword">if</span> (pvs == <span class="hljs-keyword">null</span>) &#123;
			pvs = mbd.getPropertyValues();
		&#125;
		<span class="hljs-keyword">for</span> (BeanPostProcessor bp : getBeanPostProcessors()) &#123;
			<span class="hljs-keyword">if</span> (bp <span class="hljs-keyword">instanceof</span> InstantiationAwareBeanPostProcessor) &#123;
				InstantiationAwareBeanPostProcessor ibp = (InstantiationAwareBeanPostProcessor) bp;
				<span class="hljs-comment">//ä¾èµ–æ³¨å…¥è¿‡ç¨‹ï¼Œ@Autowiredçš„æ”¯æŒ</span>
				PropertyValues pvsToUse = ibp.postProcessProperties(pvs, bw.getWrappedInstance(), beanName);
				<span class="hljs-keyword">if</span> (pvsToUse == <span class="hljs-keyword">null</span>) &#123;
					<span class="hljs-keyword">if</span> (filteredPds == <span class="hljs-keyword">null</span>) &#123;
						filteredPds = filterPropertyDescriptorsForDependencyCheck(bw, mbd.allowCaching);
					&#125;
   
					<span class="hljs-comment">//è€ç‰ˆæœ¬ç”¨è¿™ä¸ªå®Œæˆä¾èµ–æ³¨å…¥è¿‡ç¨‹ï¼Œ@Autowiredçš„æ”¯æŒ</span>
					pvsToUse = ibp.postProcessPropertyValues(pvs, filteredPds, bw.getWrappedInstance(), beanName);
					<span class="hljs-keyword">if</span> (pvsToUse == <span class="hljs-keyword">null</span>) &#123;
						<span class="hljs-keyword">return</span>;
					&#125;
				&#125;
				pvs = pvsToUse;
			&#125;
		&#125;
	&#125;
	<span class="hljs-keyword">if</span> (needsDepCheck) &#123;
		<span class="hljs-keyword">if</span> (filteredPds == <span class="hljs-keyword">null</span>) &#123;
			filteredPds = filterPropertyDescriptorsForDependencyCheck(bw, mbd.allowCaching);
		&#125;
		checkDependencies(beanName, mbd, filteredPds, pvs);
	&#125;
   
	<span class="hljs-comment">//è¿™ä¸ªæ–¹æ³•å¾ˆé¸¡è‚‹äº†ï¼Œå»ºè®®ä¸çœ‹ï¼Œæ˜¯è€ç‰ˆæœ¬ç”¨&lt;property name="username" value="Jack"/&gt;</span>
	<span class="hljs-comment">//æ ‡ç­¾åšä¾èµ–æ³¨å…¥çš„ä»£ç å®ç°ï¼Œå¤æ‚ä¸”æ— ç”¨</span>
	<span class="hljs-keyword">if</span> (pvs != <span class="hljs-keyword">null</span>) &#123;
		applyPropertyValues(beanName, mbd, bw, pvs);
	&#125;
&#125;</code></pre>
</li>
<li><p>AutowiredAnnotationBeanPostProcessorçš„postProcessProperties()æ–¹æ³•ã€‚è¯¥æ–¹æ³•é¦–å…ˆä»ç¼“å­˜ä¸­è·å–ä¹‹å‰æ”¶é›†å¥½çš„æ‰€æœ‰InjectionMetadataå¯¹è±¡ï¼Œç„¶åè°ƒç”¨å¾ªç¯è°ƒç”¨inject()æ–¹æ³•è¿›è¡Œæ³¨å…¥ã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> PropertyValues <span class="hljs-title">postProcessProperties</span><span class="hljs-params">(PropertyValues pvs, Object bean, String beanName)</span> </span>&#123;
   <span class="hljs-comment">// ä»ç¼“å­˜ä¸­è·å–InjectionMetadataå¯¹è±¡</span>
	InjectionMetadata metadata = findAutowiringMetadata(beanName, bean.getClass(), pvs);
	<span class="hljs-keyword">try</span> &#123;
		metadata.inject(bean, beanName, pvs);
	&#125;
	<span class="hljs-keyword">catch</span> (BeanCreationException ex) &#123;
		<span class="hljs-keyword">throw</span> ex;
	&#125;
	<span class="hljs-keyword">catch</span> (Throwable ex) &#123;
		<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(beanName, <span class="hljs-string">"Injection of autowired dependencies failed"</span>, ex);
	&#125;
	<span class="hljs-keyword">return</span> pvs;
&#125;</code></pre>
</li>
<li><p>æ­¤å¤„ä¸ºinject()æ–¹æ³•ï¼Œå…ˆä»springå®¹å™¨ä¸­æ‹¿åˆ°å‚æ•°å¯¹åº”çš„å€¼ï¼Œè¿™æ—¶å¯èƒ½ä¼šè§¦å‘å®ä¾‹åŒ–ï¼Œç„¶åé€šè¿‡åå°„å®Œæˆå¯¹è±¡çš„æ³¨å…¥ã€‚</p>
<pre><code class="hljs java">	<span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">inject</span><span class="hljs-params">(Object bean, @Nullable String beanName, @Nullable PropertyValues pvs)</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;
		Field field = (Field) <span class="hljs-keyword">this</span>.member;
		Object value;
		<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.cached) &#123;
			value = resolvedCachedArgument(beanName, <span class="hljs-keyword">this</span>.cachedFieldValue);
		&#125;
		<span class="hljs-keyword">else</span> &#123;
			DependencyDescriptor desc = <span class="hljs-keyword">new</span> DependencyDescriptor(field, <span class="hljs-keyword">this</span>.required);
			desc.setContainingClass(bean.getClass());
			Set&lt;String&gt; autowiredBeanNames = <span class="hljs-keyword">new</span> LinkedHashSet&lt;&gt;(<span class="hljs-number">1</span>);
			Assert.state(beanFactory != <span class="hljs-keyword">null</span>, <span class="hljs-string">"No BeanFactory available"</span>);
			TypeConverter typeConverter = beanFactory.getTypeConverter();
			<span class="hljs-keyword">try</span> &#123;
				value = beanFactory.resolveDependency(desc, beanName, autowiredBeanNames, typeConverter);
			&#125;
			<span class="hljs-keyword">catch</span> (BeansException ex) &#123;
				<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> UnsatisfiedDependencyException(<span class="hljs-keyword">null</span>, beanName, <span class="hljs-keyword">new</span> InjectionPoint(field), ex);
			&#125;
			<span class="hljs-keyword">synchronized</span> (<span class="hljs-keyword">this</span>) &#123;
				<span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.cached) &#123;
					<span class="hljs-keyword">if</span> (value != <span class="hljs-keyword">null</span> || <span class="hljs-keyword">this</span>.required) &#123;
						<span class="hljs-keyword">this</span>.cachedFieldValue = desc;
						registerDependentBeans(beanName, autowiredBeanNames);
						<span class="hljs-keyword">if</span> (autowiredBeanNames.size() == <span class="hljs-number">1</span>) &#123;
							String autowiredBeanName = autowiredBeanNames.iterator().next();
							<span class="hljs-keyword">if</span> (beanFactory.containsBean(autowiredBeanName) &amp;&amp;
									beanFactory.isTypeMatch(autowiredBeanName, field.getType())) &#123;
								<span class="hljs-keyword">this</span>.cachedFieldValue = <span class="hljs-keyword">new</span> ShortcutDependencyDescriptor(
										desc, autowiredBeanName, field.getType());
							&#125;
						&#125;
					&#125;
					<span class="hljs-keyword">else</span> &#123;
						<span class="hljs-keyword">this</span>.cachedFieldValue = <span class="hljs-keyword">null</span>;
					&#125;
					<span class="hljs-keyword">this</span>.cached = <span class="hljs-keyword">true</span>;
				&#125;
			&#125;
		&#125;
		<span class="hljs-keyword">if</span> (value != <span class="hljs-keyword">null</span>) &#123;
			ReflectionUtils.makeAccessible(field);
			field.set(bean, value);
		&#125;
	&#125;
&#125;</code></pre>

</li>
</ol>
<p>æ³¨ï¼šå…¶ä»–ç±»çš„postProcessPropertiesä¸æ­¤å¤„åŸºæœ¬ç›¸åŒã€‚</p>
<h3 id="initializeBean-æ–¹æ³•"><a href="#initializeBean-æ–¹æ³•" class="headerlink" title="initializeBean()æ–¹æ³•"></a>initializeBean()æ–¹æ³•</h3><ol>
<li><p>initializeBean()æ–¹æ³•æ˜¯BeanDefinitionå®ä¾‹åŒ–å®Œæˆåçš„æ“ä½œã€‚é¦–å…ˆä¼šä½¿ç”¨applyBeanPostProcessorsBeforeInitialization()æ–¹æ³•å¯¹@PostConstructï¼ŒAwareæ¥å£è¿›è¡Œè°ƒç”¨ï¼Œç„¶åä½¿ç”¨invokeInitMethods()æ¥å£ï¼Œå®Œæˆå¯¹InitializingBeanæ¥å£çš„afterPropertiesSet()æ–¹æ³•ã€BeanDefinationä¸­init-methodå¯¹åº”æ–¹æ³•çš„è°ƒç”¨ã€‚è¿™äº›æ³¨è§£åœ¨applyMergedBeanDefinitionPostProcessors()æ–¹æ³•ä¸­å·²ç»è¢«æ”¶é›†å¹¶å°è£…ä¸ºMetadataå¯¹è±¡ã€‚applyBeanPostProcessorsAfterInitialization()æ–¹æ³•æ˜¯aopå…¥å£ç±»ï¼Œåœ¨ä¹‹åä¼šæœ‰è¯¦ç»†åˆ†æã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> Object <span class="hljs-title">initializeBean</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String beanName, <span class="hljs-keyword">final</span> Object bean, @Nullable RootBeanDefinition mbd)</span> </span>&#123;
	<span class="hljs-keyword">if</span> (System.getSecurityManager() != <span class="hljs-keyword">null</span>) &#123;
		AccessController.doPrivileged((PrivilegedAction&lt;Object&gt;) () -&gt; &#123;
			invokeAwareMethods(beanName, bean);
			<span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
		&#125;, getAccessControlContext());
	&#125;
	<span class="hljs-keyword">else</span> &#123;
		<span class="hljs-comment">//è°ƒç”¨Awareæ–¹æ³•</span>
		invokeAwareMethods(beanName, bean);
	&#125;
   
	Object wrappedBean = bean;
	<span class="hljs-keyword">if</span> (mbd == <span class="hljs-keyword">null</span> || !mbd.isSynthetic()) &#123;
		<span class="hljs-comment">//å¯¹ç±»ä¸­æŸäº›ç‰¹æ®Šæ–¹æ³•çš„è°ƒç”¨ï¼Œæ¯”å¦‚@PostConstructï¼ŒAwareæ¥å£ï¼Œéå¸¸é‡è¦ é‡è¦ç¨‹åº¦ ï¼š5</span>
		wrappedBean = applyBeanPostProcessorsBeforeInitialization(wrappedBean, beanName);
	&#125;
   
	<span class="hljs-keyword">try</span> &#123;
		<span class="hljs-comment">//InitializingBeanæ¥å£ï¼ŒafterPropertiesSetï¼Œinit-methodå±æ€§è°ƒç”¨,éå¸¸é‡è¦ï¼Œé‡è¦ç¨‹åº¦ï¼š5</span>
		invokeInitMethods(beanName, wrappedBean, mbd);
	&#125;
	<span class="hljs-keyword">catch</span> (Throwable ex) &#123;
		<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(
				(mbd != <span class="hljs-keyword">null</span> ? mbd.getResourceDescription() : <span class="hljs-keyword">null</span>),
				beanName, <span class="hljs-string">"Invocation of init method failed"</span>, ex);
	&#125;
	<span class="hljs-keyword">if</span> (mbd == <span class="hljs-keyword">null</span> || !mbd.isSynthetic()) &#123;
		wrappedBean = applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName);
	&#125;
   
	<span class="hljs-keyword">return</span> wrappedBean;
&#125;</code></pre>
</li>
<li><p>applyBeanPostProcessorsBeforeInitialization()æ–¹æ³•</p>
<pre><code class="hljs java"><span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">applyBeanPostProcessorsBeforeInitialization</span><span class="hljs-params">(Object existingBean, String beanName)</span></span>
<span class="hljs-function">		<span class="hljs-keyword">throws</span> BeansException </span>&#123;
   
	Object result = existingBean;
	<span class="hljs-comment">/*</span>
<span class="hljs-comment">	* ç€é‡çœ‹å‡ ä¸ª</span>
<span class="hljs-comment">	* 1ã€ApplicationContextAwareProcessor  å¯¹æŸä¸ªAwareæ¥å£æ–¹æ³•çš„è°ƒç”¨</span>
<span class="hljs-comment">	* 2ã€InitDestroyAnnotationBeanPostProcessor  @PostConstructæ³¨è§£æ–¹æ³•çš„è°ƒç”¨</span>
<span class="hljs-comment">	*</span>
<span class="hljs-comment">	* 3ã€ImportAwareBeanPostProcessor  å¯¹ImportAwareç±»å‹å®ä¾‹setImportMetadataè°ƒç”¨</span>
<span class="hljs-comment">	* è¿™ä¸ªå¯¹ç†è§£springbootæœ‰å¾ˆå¤§å¸®åŠ©ã€‚ è¿™é‡Œæš‚æ—¶ä¸éœ€è¦æ·±å…¥çœ‹</span>
<span class="hljs-comment">	* */</span>
	<span class="hljs-keyword">for</span> (BeanPostProcessor processor : getBeanPostProcessors()) &#123;
		Object current = processor.postProcessBeforeInitialization(result, beanName);
		<span class="hljs-keyword">if</span> (current == <span class="hljs-keyword">null</span>) &#123;
			<span class="hljs-keyword">return</span> result;
		&#125;
		result = current;
	&#125;
	<span class="hljs-keyword">return</span> result;
&#125;</code></pre>
</li>
<li><p>InitDestroyAnnotationBeanPostProcessorçš„postProcessBeforeInitialization()æ–¹æ³•ä¼šé€šè¿‡åå°„è°ƒç”¨metadataä¸­çš„æ–¹æ³•ï¼Œæ­¤å¤„è¢«è°ƒç”¨çš„æ–¹æ³•ä¸èƒ½æœ‰ä»»ä½•å‚æ•°ã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">postProcessBeforeInitialization</span><span class="hljs-params">(Object bean, String beanName)</span> <span class="hljs-keyword">throws</span> BeansException </span>&#123;
	LifecycleMetadata metadata = findLifecycleMetadata(bean.getClass());
	<span class="hljs-keyword">try</span> &#123;
		<span class="hljs-comment">//è°ƒç”¨@PostConstructæ³¨è§£çš„æ–¹æ³•</span>
		metadata.invokeInitMethods(bean, beanName);
	&#125;
	<span class="hljs-keyword">catch</span> (InvocationTargetException ex) &#123;
		<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(beanName, <span class="hljs-string">"Invocation of init method failed"</span>, ex.getTargetException());
	&#125;
	<span class="hljs-keyword">catch</span> (Throwable ex) &#123;
		<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(beanName, <span class="hljs-string">"Failed to invoke init method"</span>, ex);
	&#125;
	<span class="hljs-keyword">return</span> bean;
&#125;</code></pre>
</li>
<li><p>invokeInitMethods()æ–¹æ³•é¦–å…ˆä¼šåˆ¤æ–­beanæ˜¯å¦å®ç°äº†InitializingBeanæ¥å£ï¼Œå¦‚æœæ˜¯å°±ç›´æ¥é€šè¿‡åå°„è°ƒç”¨è¯¥æ¥å£çš„afterPropertiesSet()æ–¹æ³•ã€‚ç„¶åä¼šé€šè¿‡invokeCustomInitMethod()æ–¹æ³•è°ƒç”¨initMethod()æ–¹æ³•æ–¹æ³•ã€‚å¦‚æœè¦åœ¨Beanå®ä¾‹åŒ–ä¹‹åå»åšä¸€äº›äº‹æƒ…å¯ä»¥å®ç°InitializingBeanæ¥å£ï¼Œæ¯”å¦‚ç¼“å­˜é¢„çƒ­ï¼Œæ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒç­‰ï¼ŒMybatisä¸­xmlçš„è§£æä¹Ÿæ˜¯ç”¨äº†è¯¥æ¥å£ã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">invokeInitMethods</span><span class="hljs-params">(String beanName, <span class="hljs-keyword">final</span> Object bean, @Nullable RootBeanDefinition mbd)</span></span>
<span class="hljs-function">		<span class="hljs-keyword">throws</span> Throwable </span>&#123;
   
	<span class="hljs-keyword">boolean</span> isInitializingBean = (bean <span class="hljs-keyword">instanceof</span> InitializingBean);
	<span class="hljs-keyword">if</span> (isInitializingBean &amp;&amp; (mbd == <span class="hljs-keyword">null</span> || !mbd.isExternallyManagedInitMethod(<span class="hljs-string">"afterPropertiesSet"</span>))) &#123;
		<span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;
			logger.trace(<span class="hljs-string">"Invoking afterPropertiesSet() on bean with name '"</span> + beanName + <span class="hljs-string">"'"</span>);
		&#125;
		<span class="hljs-keyword">if</span> (System.getSecurityManager() != <span class="hljs-keyword">null</span>) &#123;
			<span class="hljs-keyword">try</span> &#123;
				AccessController.doPrivileged((PrivilegedExceptionAction&lt;Object&gt;) () -&gt; &#123;
					((InitializingBean) bean).afterPropertiesSet();
					<span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
				&#125;, getAccessControlContext());
			&#125;
			<span class="hljs-keyword">catch</span> (PrivilegedActionException pae) &#123;
				<span class="hljs-keyword">throw</span> pae.getException();
			&#125;
		&#125;
		<span class="hljs-keyword">else</span> &#123;
			((InitializingBean) bean).afterPropertiesSet();
		&#125;
	&#125;
   
	<span class="hljs-keyword">if</span> (mbd != <span class="hljs-keyword">null</span> &amp;&amp; bean.getClass() != NullBean<span class="hljs-class">.<span class="hljs-keyword">class</span>) </span>&#123;
		String initMethodName = mbd.getInitMethodName();
		<span class="hljs-keyword">if</span> (StringUtils.hasLength(initMethodName) &amp;&amp;
				!(isInitializingBean &amp;&amp; <span class="hljs-string">"afterPropertiesSet"</span>.equals(initMethodName)) &amp;&amp;
				!mbd.isExternallyManagedInitMethod(initMethodName)) &#123;
			invokeCustomInitMethod(beanName, bean, mbd);
		&#125;
	&#125;
&#125;</code></pre>

</li>
</ol>
<h3 id="registerDisposableBeanIfNecessary-æ–¹æ³•"><a href="#registerDisposableBeanIfNecessary-æ–¹æ³•" class="headerlink" title="registerDisposableBeanIfNecessary()æ–¹æ³•"></a>registerDisposableBeanIfNecessary()æ–¹æ³•</h3><p>è¯¥æ–¹æ³•é¦–å…ˆä¼šå°†éœ€è¦é”€æ¯çš„BeanåŒ…è£…ä¸ºDisposableBeanAdapterå¯¹è±¡ï¼Œç„¶åé€šè¿‡registerDisposableBean()æ–¹æ³•æ”¾å…¥disposableBeanså®¹å™¨ä¸­ã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">registerDisposableBeanIfNecessary</span><span class="hljs-params">(String beanName, Object bean, RootBeanDefinition mbd)</span> </span>&#123;
	AccessControlContext acc = (System.getSecurityManager() != <span class="hljs-keyword">null</span> ? getAccessControlContext() : <span class="hljs-keyword">null</span>);
	<span class="hljs-keyword">if</span> (!mbd.isPrototype() &amp;&amp; requiresDestruction(bean, mbd)) &#123;
		<span class="hljs-keyword">if</span> (mbd.isSingleton()) &#123;
			<span class="hljs-comment">// Register a DisposableBean implementation that performs all destruction</span>
			<span class="hljs-comment">// work for the given bean: DestructionAwareBeanPostProcessors,</span>
			<span class="hljs-comment">// DisposableBean interface, custom destroy method.</span>
			registerDisposableBean(beanName,
					<span class="hljs-keyword">new</span> DisposableBeanAdapter(bean, beanName, mbd, getBeanPostProcessors(), acc));
		&#125;
		<span class="hljs-keyword">else</span> &#123;
			<span class="hljs-comment">// A bean with a custom scope...</span>
			Scope scope = <span class="hljs-keyword">this</span>.scopes.get(mbd.getScope());
			<span class="hljs-keyword">if</span> (scope == <span class="hljs-keyword">null</span>) &#123;
				<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(<span class="hljs-string">"No Scope registered for scope name '"</span> + mbd.getScope() + <span class="hljs-string">"'"</span>);
			&#125;
			scope.registerDestructionCallback(beanName,
					<span class="hljs-keyword">new</span> DisposableBeanAdapter(bean, beanName, mbd, getBeanPostProcessors(), acc));
		&#125;
	&#125;
&#125;</code></pre>

<p>DisposableBeanAdapterçš„æ„é€ æ–¹æ³•ã€‚è¯¥æ–¹æ³•é¦–å…ˆä¼šæ‹¿åˆ°ç±»çš„destory-methodå±æ€§ï¼Œç„¶åé€šè¿‡filterPostProcessors()æ–¹æ³•è·å–åˆ°DestructionAwareBeanPostProcessorç±»å‹çš„BeanPostProcessorã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">DisposableBeanAdapter</span><span class="hljs-params">(Object bean, String beanName, RootBeanDefinition beanDefinition,</span></span>
<span class="hljs-function"><span class="hljs-params">		List&lt;BeanPostProcessor&gt; postProcessors, @Nullable AccessControlContext acc)</span> </span>&#123;

	Assert.notNull(bean, <span class="hljs-string">"Disposable bean must not be null"</span>);
	<span class="hljs-keyword">this</span>.bean = bean;
	<span class="hljs-keyword">this</span>.beanName = beanName;
	<span class="hljs-keyword">this</span>.invokeDisposableBean =
			(<span class="hljs-keyword">this</span>.bean <span class="hljs-keyword">instanceof</span> DisposableBean &amp;&amp; !beanDefinition.isExternallyManagedDestroyMethod(<span class="hljs-string">"destroy"</span>));
	<span class="hljs-keyword">this</span>.nonPublicAccessAllowed = beanDefinition.isNonPublicAccessAllowed();
	<span class="hljs-keyword">this</span>.acc = acc;
	String destroyMethodName = inferDestroyMethodIfNecessary(bean, beanDefinition);
	<span class="hljs-keyword">if</span> (destroyMethodName != <span class="hljs-keyword">null</span> &amp;&amp; !(<span class="hljs-keyword">this</span>.invokeDisposableBean &amp;&amp; <span class="hljs-string">"destroy"</span>.equals(destroyMethodName)) &amp;&amp;
			!beanDefinition.isExternallyManagedDestroyMethod(destroyMethodName)) &#123;
		<span class="hljs-keyword">this</span>.destroyMethodName = destroyMethodName;
		<span class="hljs-keyword">this</span>.destroyMethod = determineDestroyMethod(destroyMethodName);
		<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.destroyMethod == <span class="hljs-keyword">null</span>) &#123;
			<span class="hljs-keyword">if</span> (beanDefinition.isEnforceDestroyMethod()) &#123;
				<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanDefinitionValidationException(<span class="hljs-string">"Could not find a destroy method named '"</span> +
						destroyMethodName + <span class="hljs-string">"' on bean with name '"</span> + beanName + <span class="hljs-string">"'"</span>);
			&#125;
		&#125;
		<span class="hljs-keyword">else</span> &#123;
			Class&lt;?&gt;[] paramTypes = <span class="hljs-keyword">this</span>.destroyMethod.getParameterTypes();
			<span class="hljs-keyword">if</span> (paramTypes.length &gt; <span class="hljs-number">1</span>) &#123;
				<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanDefinitionValidationException(<span class="hljs-string">"Method '"</span> + destroyMethodName + <span class="hljs-string">"' of bean '"</span> +
						beanName + <span class="hljs-string">"' has more than one parameter - not supported as destroy method"</span>);
			&#125;
			<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (paramTypes.length == <span class="hljs-number">1</span> &amp;&amp; <span class="hljs-keyword">boolean</span><span class="hljs-class">.<span class="hljs-keyword">class</span> !</span>= paramTypes[<span class="hljs-number">0</span>]) &#123;
				<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanDefinitionValidationException(<span class="hljs-string">"Method '"</span> + destroyMethodName + <span class="hljs-string">"' of bean '"</span> +
						beanName + <span class="hljs-string">"' has a non-boolean parameter - not supported as destroy method"</span>);
			&#125;
		&#125;
	&#125;
	<span class="hljs-keyword">this</span>.beanPostProcessors = filterPostProcessors(postProcessors, bean);
&#125;</code></pre>

<p>destory()æ–¹æ³•é¦–å…ˆä¼šè°ƒç”¨BeanPostProcessoræ¥å£çš„postProcessBeforeDestruction()æ–¹æ³•ï¼Œç„¶åè°ƒç”¨DisposableBeanæ¥å£çš„distory()æ–¹æ³•ï¼Œå†é€šè¿‡åå°„è°ƒç”¨destory-methodå±æ€§è®¾ç½®çš„æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•ä¸€èˆ¬ç”±tomcatä¸­servletè§„èŒƒä¸­çš„ContextLoaderListener.contextDestroyed()æ–¹æ³•è§¦å‘ã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">destroy</span><span class="hljs-params">()</span> </span>&#123;
	<span class="hljs-keyword">if</span> (!CollectionUtils.isEmpty(<span class="hljs-keyword">this</span>.beanPostProcessors)) &#123;
		<span class="hljs-keyword">for</span> (DestructionAwareBeanPostProcessor processor : <span class="hljs-keyword">this</span>.beanPostProcessors) &#123;
			processor.postProcessBeforeDestruction(<span class="hljs-keyword">this</span>.bean, <span class="hljs-keyword">this</span>.beanName);
		&#125;
	&#125;

	<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.invokeDisposableBean) &#123;
		<span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;
			logger.trace(<span class="hljs-string">"Invoking destroy() on bean with name '"</span> + <span class="hljs-keyword">this</span>.beanName + <span class="hljs-string">"'"</span>);
		&#125;
		<span class="hljs-keyword">try</span> &#123;
			<span class="hljs-keyword">if</span> (System.getSecurityManager() != <span class="hljs-keyword">null</span>) &#123;
				AccessController.doPrivileged((PrivilegedExceptionAction&lt;Object&gt;) () -&gt; &#123;
					((DisposableBean) <span class="hljs-keyword">this</span>.bean).destroy();
					<span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
				&#125;, <span class="hljs-keyword">this</span>.acc);
			&#125;
			<span class="hljs-keyword">else</span> &#123;
				((DisposableBean) <span class="hljs-keyword">this</span>.bean).destroy();
			&#125;
		&#125;
		<span class="hljs-keyword">catch</span> (Throwable ex) &#123;
			String msg = <span class="hljs-string">"Invocation of destroy method failed on bean with name '"</span> + <span class="hljs-keyword">this</span>.beanName + <span class="hljs-string">"'"</span>;
			<span class="hljs-keyword">if</span> (logger.isDebugEnabled()) &#123;
				logger.info(msg, ex);
			&#125;
			<span class="hljs-keyword">else</span> &#123;
				logger.info(msg + <span class="hljs-string">": "</span> + ex);
			&#125;
		&#125;
	&#125;

	<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.destroyMethod != <span class="hljs-keyword">null</span>) &#123;
		invokeCustomDestroyMethod(<span class="hljs-keyword">this</span>.destroyMethod);
	&#125;
	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.destroyMethodName != <span class="hljs-keyword">null</span>) &#123;
		Method methodToCall = determineDestroyMethod(<span class="hljs-keyword">this</span>.destroyMethodName);
		<span class="hljs-keyword">if</span> (methodToCall != <span class="hljs-keyword">null</span>) &#123;
			invokeCustomDestroyMethod(methodToCall);
		&#125;
	&#125;
&#125;</code></pre>

<h2 id="å•å®ä¾‹å¾ªç¯ä¾èµ–"><a href="#å•å®ä¾‹å¾ªç¯ä¾èµ–" class="headerlink" title="å•å®ä¾‹å¾ªç¯ä¾èµ–"></a>å•å®ä¾‹å¾ªç¯ä¾èµ–</h2><p><a href="https://www.processon.com/view/link/5df9ce52e4b0c4255ea1a84f" target="_blank" rel="noopener">å¾ªç¯ä¾èµ–æµç¨‹å›¾</a></p>
<p>å•ä¾‹å®ä¾‹æ— å‚æ„é€ å‡½æ•°çš„å¾ªç¯ä¾èµ–æ˜¯å¯ä»¥è§£å†³çš„ï¼Œä½†å¦‚æœæ˜¯å‚æ„é€ å‡½æ•°@Autowired çš„æ–¹å¼é€ æˆçš„å¾ªç¯ä¾èµ–ä¼šç›´æ¥æŠ¥é”™ï¼Œå¤šä¾‹çš„å¾ªç¯ä¾èµ–ä¹Ÿæ˜¯ç›´æ¥æŠ¥é”™ã€‚</p>
<p>doGetBean()æ–¹æ³•çš„å†åˆ†æã€‚åœ¨è°ƒç”¨doGetBean()æ–¹æ³•è·å–å®ä¾‹æ—¶ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­ä¼šå°è¯•é€šè¿‡getSingleton(beanName)æ–¹æ³•ä»ç¼“å­˜ä¸­è·å–å®ä¾‹ï¼Œå¦‚æœæ²¡æœ‰ä¼šé€šè¿‡getSingleton()çš„é‡è½½æ–¹æ³•åˆ›å»ºå®ä¾‹ã€‚</p>
<pre><code class="hljs java"><span class="hljs-keyword">protected</span> &lt;T&gt; <span class="hljs-function">T <span class="hljs-title">doGetBean</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String name, @Nullable <span class="hljs-keyword">final</span> Class&lt;T&gt; requiredType,</span></span>
<span class="hljs-function"><span class="hljs-params">		@Nullable <span class="hljs-keyword">final</span> Object[] args, <span class="hljs-keyword">boolean</span> typeCheckOnly)</span> <span class="hljs-keyword">throws</span> BeansException </span>&#123;

	<span class="hljs-keyword">final</span> String beanName = transformedBeanName(name);
	Object bean;

	<span class="hljs-comment">//ä»ç¼“å­˜ä¸­æ‹¿å®ä¾‹</span>
	<span class="hljs-comment">// Eagerly check singleton cache for manually registered singletons.</span>
	Object sharedInstance = getSingleton(beanName);
	<span class="hljs-comment">//å¦‚æœç¼“å­˜é‡Œé¢èƒ½æ‹¿åˆ°å®ä¾‹</span>
	<span class="hljs-keyword">if</span> (sharedInstance != <span class="hljs-keyword">null</span> &amp;&amp; args == <span class="hljs-keyword">null</span>) &#123;
		<span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;
			<span class="hljs-keyword">if</span> (isSingletonCurrentlyInCreation(beanName)) &#123;
				logger.trace(<span class="hljs-string">"Returning eagerly cached instance of singleton bean '"</span> + beanName +
						<span class="hljs-string">"' that is not fully initialized yet - a consequence of a circular reference"</span>);
			&#125;
			<span class="hljs-keyword">else</span> &#123;
				logger.trace(<span class="hljs-string">"Returning cached instance of singleton bean '"</span> + beanName + <span class="hljs-string">"'"</span>);
			&#125;
		&#125;
		<span class="hljs-comment">//æ”¹æ–¹æ³•æ˜¯FactoryBeanæ¥å£çš„è°ƒç”¨å…¥å£</span>
		bean = getObjectForBeanInstance(sharedInstance, name, beanName, <span class="hljs-keyword">null</span>);
	&#125;

	<span class="hljs-keyword">else</span> &#123;

		<span class="hljs-comment">//å¦‚æœsingletonObjectsç¼“å­˜é‡Œé¢æ²¡æœ‰ï¼Œåˆ™èµ°ä¸‹æ¥</span>
		<span class="hljs-comment">// Fail if we're already creating this bean instance:</span>
		<span class="hljs-comment">// We're assumably within a circular reference.</span>

		<span class="hljs-comment">//å¦‚æœæ˜¯scope æ˜¯Prototypeçš„ï¼Œæ ¡éªŒæ˜¯å¦æœ‰å‡ºç°å¾ªç¯ä¾èµ–ï¼Œå¦‚æœæœ‰åˆ™ç›´æ¥æŠ¥é”™</span>
		<span class="hljs-keyword">if</span> (isPrototypeCurrentlyInCreation(beanName)) &#123;
			<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCurrentlyInCreationException(beanName);
		&#125;

		<span class="hljs-comment">// Check if bean definition exists in this factory.</span>
		BeanFactory parentBeanFactory = getParentBeanFactory();
		<span class="hljs-keyword">if</span> (parentBeanFactory != <span class="hljs-keyword">null</span> &amp;&amp; !containsBeanDefinition(beanName)) &#123;
			<span class="hljs-comment">// Not found -&gt; check parent.</span>
			String nameToLookup = originalBeanName(name);
			<span class="hljs-keyword">if</span> (parentBeanFactory <span class="hljs-keyword">instanceof</span> AbstractBeanFactory) &#123;
				<span class="hljs-keyword">return</span> ((AbstractBeanFactory) parentBeanFactory).doGetBean(
						nameToLookup, requiredType, args, typeCheckOnly);
			&#125;
			<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (args != <span class="hljs-keyword">null</span>) &#123;
				<span class="hljs-comment">// Delegation to parent with explicit args.</span>
				<span class="hljs-keyword">return</span> (T) parentBeanFactory.getBean(nameToLookup, args);
			&#125;
			<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (requiredType != <span class="hljs-keyword">null</span>) &#123;
				<span class="hljs-comment">// No args -&gt; delegate to standard getBean method.</span>
				<span class="hljs-keyword">return</span> parentBeanFactory.getBean(nameToLookup, requiredType);
			&#125;
			<span class="hljs-keyword">else</span> &#123;
				<span class="hljs-keyword">return</span> (T) parentBeanFactory.getBean(nameToLookup);
			&#125;
		&#125;

		<span class="hljs-keyword">if</span> (!typeCheckOnly) &#123;
			markBeanAsCreated(beanName);
		&#125;

		<span class="hljs-keyword">try</span> &#123;
			<span class="hljs-comment">//çˆ¶å­BeanDefinitionåˆå¹¶</span>
			<span class="hljs-keyword">final</span> RootBeanDefinition mbd = getMergedLocalBeanDefinition(beanName);
			checkMergedBeanDefinition(mbd, beanName, args);

			<span class="hljs-comment">//è·å–ä¾èµ–å¯¹è±¡å±æ€§ï¼Œä¾èµ–å¯¹è±¡è¦å…ˆå®ä¾‹åŒ–</span>
			<span class="hljs-comment">// Guarantee initialization of beans that the current bean depends on.</span>
			String[] dependsOn = mbd.getDependsOn();
			<span class="hljs-keyword">if</span> (dependsOn != <span class="hljs-keyword">null</span>) &#123;
				<span class="hljs-keyword">for</span> (String dep : dependsOn) &#123;
					<span class="hljs-keyword">if</span> (isDependent(beanName, dep)) &#123;
						<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName,
								<span class="hljs-string">"Circular depends-on relationship between '"</span> + beanName + <span class="hljs-string">"' and '"</span> + dep + <span class="hljs-string">"'"</span>);
					&#125;
					registerDependentBean(dep, beanName);
					<span class="hljs-keyword">try</span> &#123;
						<span class="hljs-comment">//å®ä¾‹åŒ–</span>
						getBean(dep);
				&#125;
					<span class="hljs-keyword">catch</span> (NoSuchBeanDefinitionException ex) &#123;
						<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName,
								<span class="hljs-string">"'"</span> + beanName + <span class="hljs-string">"' depends on missing bean '"</span> + dep + <span class="hljs-string">"'"</span>, ex);
					&#125;
				&#125;
			&#125;

			<span class="hljs-comment">//ç€é‡çœ‹ï¼Œå¤§éƒ¨åˆ†æ˜¯å•ä¾‹çš„æƒ…å†µ</span>
			<span class="hljs-comment">// Create bean instance.</span>
			<span class="hljs-keyword">if</span> (mbd.isSingleton()) &#123;
				sharedInstance = getSingleton(beanName, () -&gt; &#123;
					<span class="hljs-keyword">try</span> &#123;
						<span class="hljs-keyword">return</span> createBean(beanName, mbd, args);
					&#125;
					<span class="hljs-keyword">catch</span> (BeansException ex) &#123;
						<span class="hljs-comment">// Explicitly remove instance from singleton cache: It might have been put there</span>
						<span class="hljs-comment">// eagerly by the creation process, to allow for circular reference resolution.</span>
						<span class="hljs-comment">// Also remove any beans that received a temporary reference to the bean.</span>
						destroySingleton(beanName);
						<span class="hljs-keyword">throw</span> ex;
					&#125;
				&#125;);
				<span class="hljs-comment">//è¯¥æ–¹æ³•æ˜¯FactoryBeanæ¥å£çš„è°ƒç”¨å…¥å£</span>
				bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);
			&#125;

			<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mbd.isPrototype()) &#123;
				<span class="hljs-comment">// It's a prototype -&gt; create a new instance.</span>
				Object prototypeInstance = <span class="hljs-keyword">null</span>;
				<span class="hljs-keyword">try</span> &#123;
					beforePrototypeCreation(beanName);
					prototypeInstance = createBean(beanName, mbd, args);
				&#125;
				<span class="hljs-keyword">finally</span> &#123;
					afterPrototypeCreation(beanName);
				&#125;
				<span class="hljs-comment">//è¯¥æ–¹æ³•æ˜¯FactoryBeanæ¥å£çš„è°ƒç”¨å…¥å£</span>
				bean = getObjectForBeanInstance(prototypeInstance, name, beanName, mbd);
			&#125;

			<span class="hljs-keyword">else</span> &#123;
				String scopeName = mbd.getScope();
				<span class="hljs-keyword">final</span> Scope scope = <span class="hljs-keyword">this</span>.scopes.get(scopeName);
				<span class="hljs-keyword">if</span> (scope == <span class="hljs-keyword">null</span>) &#123;
					<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(<span class="hljs-string">"No Scope registered for scope name '"</span> + scopeName + <span class="hljs-string">"'"</span>);
				&#125;
				<span class="hljs-keyword">try</span> &#123;
					Object scopedInstance = scope.get(beanName, () -&gt; &#123;
						beforePrototypeCreation(beanName);
						<span class="hljs-keyword">try</span> &#123;
							<span class="hljs-keyword">return</span> createBean(beanName, mbd, args);
						&#125;
						<span class="hljs-keyword">finally</span> &#123;
							afterPrototypeCreation(beanName);
						&#125;
					&#125;);
					<span class="hljs-comment">//è¯¥æ–¹æ³•æ˜¯FactoryBeanæ¥å£çš„è°ƒç”¨å…¥å£</span>
					bean = getObjectForBeanInstance(scopedInstance, name, beanName, mbd);
				&#125;
				<span class="hljs-keyword">catch</span> (IllegalStateException ex) &#123;
					<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(beanName,
							<span class="hljs-string">"Scope '"</span> + scopeName + <span class="hljs-string">"' is not active for the current thread; consider "</span> +
							<span class="hljs-string">"defining a scoped proxy for this bean if you intend to refer to it from a singleton"</span>,
							ex);
				&#125;
			&#125;
		&#125;
		<span class="hljs-keyword">catch</span> (BeansException ex) &#123;
			cleanupAfterBeanCreationFailure(beanName);
			<span class="hljs-keyword">throw</span> ex;
		&#125;
	&#125;

	<span class="hljs-comment">// Check if required type matches the type of the actual bean instance.</span>
	<span class="hljs-keyword">if</span> (requiredType != <span class="hljs-keyword">null</span> &amp;&amp; !requiredType.isInstance(bean)) &#123;
		<span class="hljs-keyword">try</span> &#123;
			T convertedBean = getTypeConverter().convertIfNecessary(bean, requiredType);
			<span class="hljs-keyword">if</span> (convertedBean == <span class="hljs-keyword">null</span>) &#123;
				<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanNotOfRequiredTypeException(name, requiredType, bean.getClass());
			&#125;
			<span class="hljs-keyword">return</span> convertedBean;
		&#125;
		<span class="hljs-keyword">catch</span> (TypeMismatchException ex) &#123;
			<span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;
				logger.trace(<span class="hljs-string">"Failed to convert bean '"</span> + name + <span class="hljs-string">"' to required type '"</span> +
						ClassUtils.getQualifiedName(requiredType) + <span class="hljs-string">"'"</span>, ex);
			&#125;
			<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanNotOfRequiredTypeException(name, requiredType, bean.getClass());
		&#125;
	&#125;
	<span class="hljs-keyword">return</span> (T) bean;
&#125;</code></pre>

<p>getSingleton()æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ç”¨äºä»ç¼“å­˜ä¸­è·å–å®ä¾‹ï¼Œä¼šæŒ‰ç…§ä¸€çº§ç¼“å­˜ã€äºŒçº§ç¼“å­˜ã€ä¸‰çº§ç¼“å­˜çš„é¡ºåºè·å–ï¼Œå†ä»ä¸‰çº§ç¼“å­˜ä¸­è·å–å®ä¾‹åï¼Œä¼šå°†å®ä¾‹æ”¾åˆ°äºŒçº§ç¼“å­˜å¹¶åˆ é™¤ä¸‰çº§ç¼“å­˜ã€‚ä¸€çº§ç¼“å­˜ä¸­çš„beanæ˜¯å®Œæˆå®ä¾‹åŒ–ï¼ŒIOCã€DIæ³¨å…¥çš„ï¼Œä¸‰çº§ç¼“å­˜ä¸­æ—¶ä»…ä»…æ‰§è¡Œå®Œæ„é€ æ–¹æ³•ï¼Œè¿˜æ²¡æœ‰å¯¹å±æ€§è¿›è¡Œèµ‹å€¼æ“ä½œçš„beanï¼ŒäºŒçº§ç¼“å­˜ä¸­çš„beanä¸ä¸‰çº§ç¼“å­˜ç›¸åŒï¼ŒäºŒçº§ç¼“å­˜å­˜åœ¨çš„æ„ä¹‰æ˜¯ä¸ºäº†æå‡æ•ˆç‡ã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> Object <span class="hljs-title">getSingleton</span><span class="hljs-params">(String beanName, <span class="hljs-keyword">boolean</span> allowEarlyReference)</span> </span>&#123;
	<span class="hljs-comment">//æ ¹æ®beanNameä»ç¼“å­˜ä¸­æ‹¿å®ä¾‹</span>
	<span class="hljs-comment">//å…ˆä»ä¸€çº§ç¼“å­˜æ‹¿</span>
	Object singletonObject = <span class="hljs-keyword">this</span>.singletonObjects.get(beanName);
	<span class="hljs-comment">//å¦‚æœbeanè¿˜æ­£åœ¨åˆ›å»ºï¼Œè¿˜æ²¡åˆ›å»ºå®Œæˆï¼Œå…¶å®å°±æ˜¯å †å†…å­˜æœ‰äº†ï¼Œå±æ€§è¿˜æ²¡æœ‰DIä¾èµ–æ³¨å…¥</span>
	<span class="hljs-keyword">if</span> (singletonObject == <span class="hljs-keyword">null</span> &amp;&amp; isSingletonCurrentlyInCreation(beanName)) &#123;
		<span class="hljs-keyword">synchronized</span> (<span class="hljs-keyword">this</span>.singletonObjects) &#123;
			<span class="hljs-comment">//ä»äºŒçº§ç¼“å­˜ä¸­æ‹¿</span>
			singletonObject = <span class="hljs-keyword">this</span>.earlySingletonObjects.get(beanName);

			<span class="hljs-comment">//å¦‚æœè¿˜æ‹¿ä¸åˆ°ï¼Œå¹¶ä¸”å…è®¸beanæå‰æš´éœ²</span>
			<span class="hljs-keyword">if</span> (singletonObject == <span class="hljs-keyword">null</span> &amp;&amp; allowEarlyReference) &#123;
				<span class="hljs-comment">//ä»ä¸‰çº§ç¼“å­˜ä¸­æ‹¿åˆ°å¯¹è±¡å·¥å‚</span>
				ObjectFactory&lt;?&gt; singletonFactory = <span class="hljs-keyword">this</span>.singletonFactories.get(beanName);
				<span class="hljs-keyword">if</span> (singletonFactory != <span class="hljs-keyword">null</span>) &#123;
					<span class="hljs-comment">//ä»å·¥å‚ä¸­æ‹¿åˆ°å¯¹è±¡</span>
					singletonObject = singletonFactory.getObject();
					<span class="hljs-comment">//å‡çº§åˆ°äºŒçº§ç¼“å­˜</span>
					<span class="hljs-keyword">this</span>.earlySingletonObjects.put(beanName, singletonObject);
					<span class="hljs-comment">//åˆ é™¤ä¸‰çº§ç¼“å­˜</span>
					<span class="hljs-keyword">this</span>.singletonFactories.remove(beanName);
				&#125;
			&#125;
		&#125;
	&#125;
	<span class="hljs-keyword">return</span> singletonObject;
&#125;</code></pre>

<p>é‡è½½çš„getSingleton()æ–¹æ³•ï¼Œè¯¥æ–¹æ³•åœ¨åˆ›å»ºBeanä¹‹å‰ä¼šå°†beanNameæ·»åŠ åˆ°singletonsCurrentlyInCreationå®¹å™¨ä¸­ï¼Œå¦‚æœå®¹å™¨ä¸­å·²æœ‰è¯¥beanNameä¼šç›´æ¥æŠ¥é”™ï¼Œç„¶åé€šè¿‡singletonFactory.getObject()æ–¹æ³•åˆ›å»ºå®ä¾‹ï¼Œå¦‚æœæœ‰è¿”å›å€¼ï¼Œå°±è¡¨ç¤ºå®ä¾‹å·²ç»å®Œæˆåˆ›å»ºï¼Œå†ä»å®¹å™¨ä¸­åˆ é™¤beanNameï¼Œåˆ›å»ºå®Œæˆåè°ƒç”¨addSingleton()æ–¹æ³•æ”¾å…¥ä¸€çº§ç¼“å­˜ã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">getSingleton</span><span class="hljs-params">(String beanName, ObjectFactory&lt;?&gt; singletonFactory)</span> </span>&#123;
	Assert.notNull(beanName, <span class="hljs-string">"Bean name must not be null"</span>);
	<span class="hljs-keyword">synchronized</span> (<span class="hljs-keyword">this</span>.singletonObjects) &#123;
		<span class="hljs-comment">//å¦‚æœç¼“å­˜ä¸­æœ‰ï¼Œåˆ™ç›´æ¥è¿”å›</span>
		Object singletonObject = <span class="hljs-keyword">this</span>.singletonObjects.get(beanName);
		<span class="hljs-keyword">if</span> (singletonObject == <span class="hljs-keyword">null</span>) &#123;
			<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.singletonsCurrentlyInDestruction) &#123;
				<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationNotAllowedException(beanName,
						<span class="hljs-string">"Singleton bean creation not allowed while singletons of this factory are in destruction "</span> +
						<span class="hljs-string">"(Do not request a bean from a BeanFactory in a destroy method implementation!)"</span>);
			&#125;
			<span class="hljs-keyword">if</span> (logger.isDebugEnabled()) &#123;
				logger.debug(<span class="hljs-string">"Creating shared instance of singleton bean '"</span> + beanName + <span class="hljs-string">"'"</span>);
			&#125;

			<span class="hljs-comment">//æŠŠbeanNameæ·»åŠ åˆ°singletonsCurrentlyInCreation Setå®¹å™¨ä¸­ï¼Œåœ¨è¿™ä¸ªé›†åˆé‡Œé¢çš„beanéƒ½æ˜¯æ­£åœ¨å®ä¾‹åŒ–çš„bean</span>
			beforeSingletonCreation(beanName);
			<span class="hljs-keyword">boolean</span> newSingleton = <span class="hljs-keyword">false</span>;
			<span class="hljs-keyword">boolean</span> recordSuppressedExceptions = (<span class="hljs-keyword">this</span>.suppressedExceptions == <span class="hljs-keyword">null</span>);
			<span class="hljs-keyword">if</span> (recordSuppressedExceptions) &#123;
				<span class="hljs-keyword">this</span>.suppressedExceptions = <span class="hljs-keyword">new</span> LinkedHashSet&lt;&gt;();
			&#125;
			<span class="hljs-keyword">try</span> &#123;
				singletonObject = singletonFactory.getObject();
				newSingleton = <span class="hljs-keyword">true</span>;
			&#125;
			<span class="hljs-keyword">catch</span> (IllegalStateException ex) &#123;
				<span class="hljs-comment">// Has the singleton object implicitly appeared in the meantime -&gt;</span>
				<span class="hljs-comment">// if yes, proceed with it since the exception indicates that state.</span>
				singletonObject = <span class="hljs-keyword">this</span>.singletonObjects.get(beanName);
				<span class="hljs-keyword">if</span> (singletonObject == <span class="hljs-keyword">null</span>) &#123;
					<span class="hljs-keyword">throw</span> ex;
				&#125;
			&#125;
			<span class="hljs-keyword">catch</span> (BeanCreationException ex) &#123;
				<span class="hljs-keyword">if</span> (recordSuppressedExceptions) &#123;
					<span class="hljs-keyword">for</span> (Exception suppressedException : <span class="hljs-keyword">this</span>.suppressedExceptions) &#123;
						ex.addRelatedCause(suppressedException);
					&#125;
				&#125;
				<span class="hljs-keyword">throw</span> ex;
			&#125;
			<span class="hljs-keyword">finally</span> &#123;
				<span class="hljs-keyword">if</span> (recordSuppressedExceptions) &#123;
					<span class="hljs-keyword">this</span>.suppressedExceptions = <span class="hljs-keyword">null</span>;
				&#125;
				<span class="hljs-comment">//beanåˆ›å»ºå®ŒæˆåsingletonsCurrentlyInCreationè¦åˆ é™¤è¯¥bean</span>
				afterSingletonCreation(beanName);
			&#125;
			<span class="hljs-keyword">if</span> (newSingleton) &#123;
				<span class="hljs-comment">//åˆ›å»ºå¯¹è±¡æˆåŠŸæ—¶ï¼ŒæŠŠå¯¹è±¡ç¼“å­˜åˆ°singletonObjectsç¼“å­˜ä¸­,beanåˆ›å»ºå®Œæˆæ—¶æ”¾å…¥ä¸€çº§ç¼“å­˜</span>
				addSingleton(beanName, singletonObject);
			&#125;
		&#125;
		<span class="hljs-keyword">return</span> singletonObject;
	&#125;</code></pre>

<p>addSington()æ–¹æ³•ï¼Œè¯¥æ–¹æ³•åœ¨å®ä¾‹åˆ›å»ºåä¼šå°†å®ä¾‹æ”¾å…¥ä¸€çº§ç¼“å­˜ï¼Œå¹¶åˆ é™¤äºŒçº§ã€ä¸‰çº§ç¼“å­˜ä¸­çš„å®ä¾‹ã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addSingleton</span><span class="hljs-params">(String beanName, Object singletonObject)</span> </span>&#123;
	<span class="hljs-keyword">synchronized</span> (<span class="hljs-keyword">this</span>.singletonObjects) &#123;
		<span class="hljs-comment">//ä¸€çº§ç¼“å­˜</span>
		<span class="hljs-keyword">this</span>.singletonObjects.put(beanName, singletonObject);
		<span class="hljs-comment">//ä¸‰çº§ç¼“å­˜</span>
		<span class="hljs-keyword">this</span>.singletonFactories.remove(beanName);
		<span class="hljs-comment">//äºŒçº§ç¼“å­˜</span>
		<span class="hljs-keyword">this</span>.earlySingletonObjects.remove(beanName);
		<span class="hljs-keyword">this</span>.registeredSingletons.add(beanName);
	&#125;
&#125;</code></pre>

<p>singletonFactory.getObject()æ–¹æ³•ä¼šå›è°ƒåˆ°doCreateBean()æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å®Œæˆå®ä¾‹çš„æ„é€ å‡½æ•°ååˆ›å»ºå®ä¾‹åï¼Œä¼šåˆ¤æ–­ç±»æ˜¯å¦éœ€è¦æå‰æš´éœ²ï¼Œå¦‚æœéœ€è¦ä¼šè°ƒç”¨addSingletonFactory()æ–¹æ³•å°†æ­£åœ¨åˆ›å»ºçš„beanæ·»åŠ åˆ°ä¸‰çº§ç¼“å­˜ï¼Œæ³¨æ„æ­¤æ—¶æ³¨è§£è£…é…å·²ç»å®Œæˆï¼Œä½†å¯¹æ³¨è§£çš„IOCã€DIç­‰æ“ä½œè¿˜æœªå¼€å§‹ã€‚addSingletonFactory()æ–¹æ³•ä¼šè°ƒç”¨åˆ°getEarlyBeanReference()æ–¹æ³•è·å–å®Œæˆå®ä¾‹åŒ–çš„beanã€‚åˆ¤æ–­beanæ˜¯å¦æ­£åœ¨åˆ›å»ºçš„æ–¹æ³•ä¸ºåˆ¤æ–­beanNameåœ¨singletonsCurrentlyInCreationä¸­æ˜¯å¦å­˜åœ¨ã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> Object <span class="hljs-title">doCreateBean</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String beanName, <span class="hljs-keyword">final</span> RootBeanDefinition mbd, <span class="hljs-keyword">final</span> @Nullable Object[] args)</span></span>
<span class="hljs-function">		<span class="hljs-keyword">throws</span> BeanCreationException </span>&#123;

	<span class="hljs-comment">// Instantiate the bean.</span>
	BeanWrapper instanceWrapper = <span class="hljs-keyword">null</span>;
	<span class="hljs-keyword">if</span> (mbd.isSingleton()) &#123;
		instanceWrapper = <span class="hljs-keyword">this</span>.factoryBeanInstanceCache.remove(beanName);
	&#125;
	<span class="hljs-keyword">if</span> (instanceWrapper == <span class="hljs-keyword">null</span>) &#123;
		<span class="hljs-comment">//åˆ›å»ºå®ä¾‹ é‡ç‚¹çœ‹ é‡è¦ç¨‹åº¦ï¼š5</span>
		instanceWrapper = createBeanInstance(beanName, mbd, args);
	&#125;
	<span class="hljs-keyword">final</span> Object bean = instanceWrapper.getWrappedInstance();
	Class&lt;?&gt; beanType = instanceWrapper.getWrappedClass();
	<span class="hljs-keyword">if</span> (beanType != NullBean<span class="hljs-class">.<span class="hljs-keyword">class</span>) </span>&#123;
		mbd.resolvedTargetType = beanType;
	&#125;

	<span class="hljs-comment">// Allow post-processors to modify the merged bean definition.</span>
	<span class="hljs-keyword">synchronized</span> (mbd.postProcessingLock) &#123;
		<span class="hljs-keyword">if</span> (!mbd.postProcessed) &#123;
			<span class="hljs-keyword">try</span> &#123;
				<span class="hljs-comment">//CommonAnnotationBeanPostProcessor  æ”¯æŒäº†@PostConstructï¼Œ@PreDestroy,@Resourceæ³¨è§£</span>
				<span class="hljs-comment">//AutowiredAnnotationBeanPostProcessor æ”¯æŒ @Autowired,@Valueæ³¨è§£</span>
				<span class="hljs-comment">//BeanPostProcessoræ¥å£çš„å…¸å‹è¿ç”¨ï¼Œè¿™é‡Œè¦ç†è§£è¿™ä¸ªæ¥å£</span>
				<span class="hljs-comment">//å¯¹ç±»ä¸­æ³¨è§£çš„è£…é…è¿‡ç¨‹</span>
				<span class="hljs-comment">//é‡è¦ç¨‹åº¦5ï¼Œå¿…é¡»çœ‹</span>
				applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName);
			&#125;
			<span class="hljs-keyword">catch</span> (Throwable ex) &#123;
				<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName,
						<span class="hljs-string">"Post-processing of merged bean definition failed"</span>, ex);
			&#125;
			mbd.postProcessed = <span class="hljs-keyword">true</span>;
		&#125;
	&#125;

	<span class="hljs-comment">// Eagerly cache singletons to be able to resolve circular references</span>
	<span class="hljs-comment">// even when triggered by lifecycle interfaces like BeanFactoryAware.</span>
	<span class="hljs-comment">//æ˜¯å¦	å•ä¾‹beanæå‰æš´éœ²</span>
	<span class="hljs-keyword">boolean</span> earlySingletonExposure = (mbd.isSingleton() &amp;&amp; <span class="hljs-keyword">this</span>.allowCircularReferences &amp;&amp;
			isSingletonCurrentlyInCreation(beanName));
	<span class="hljs-keyword">if</span> (earlySingletonExposure) &#123;
		<span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;
			logger.trace(<span class="hljs-string">"Eagerly caching bean '"</span> + beanName +
					<span class="hljs-string">"' to allow for resolving potential circular references"</span>);
		&#125;
		<span class="hljs-comment">//è¿™é‡Œç€é‡ç†è§£ï¼Œå¯¹ç†è§£å¾ªç¯ä¾èµ–å¸®åŠ©éå¸¸å¤§ï¼Œé‡è¦ç¨‹åº¦ 5   æ·»åŠ ä¸‰çº§ç¼“å­˜</span>
		addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean));
	&#125;

	<span class="hljs-comment">// Initialize the bean instance.</span>
	Object exposedObject = bean;
	<span class="hljs-keyword">try</span> &#123;
		<span class="hljs-comment">//ioc diï¼Œä¾èµ–æ³¨å…¥çš„æ ¸å¿ƒæ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¿…é¡»çœ‹ï¼Œé‡è¦ç¨‹åº¦ï¼š5</span>
		populateBean(beanName, mbd, instanceWrapper);

		<span class="hljs-comment">//bean å®ä¾‹åŒ–+iocä¾èµ–æ³¨å…¥å®Œä»¥åçš„è°ƒç”¨ï¼Œéå¸¸é‡è¦ï¼Œé‡è¦ç¨‹åº¦ï¼š5</span>
		exposedObject = initializeBean(beanName, exposedObject, mbd);
	&#125;
	<span class="hljs-keyword">catch</span> (Throwable ex) &#123;
		<span class="hljs-keyword">if</span> (ex <span class="hljs-keyword">instanceof</span> BeanCreationException &amp;&amp; beanName.equals(((BeanCreationException) ex).getBeanName())) &#123;
			<span class="hljs-keyword">throw</span> (BeanCreationException) ex;
		&#125;
		<span class="hljs-keyword">else</span> &#123;
			<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(
					mbd.getResourceDescription(), beanName, <span class="hljs-string">"Initialization of bean failed"</span>, ex);
		&#125;
	&#125;

	<span class="hljs-keyword">if</span> (earlySingletonExposure) &#123;
		Object earlySingletonReference = getSingleton(beanName, <span class="hljs-keyword">false</span>);
		<span class="hljs-keyword">if</span> (earlySingletonReference != <span class="hljs-keyword">null</span>) &#123;
			<span class="hljs-keyword">if</span> (exposedObject == bean) &#123;
				exposedObject = earlySingletonReference;
			&#125;
			<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.allowRawInjectionDespiteWrapping &amp;&amp; hasDependentBean(beanName)) &#123;
				String[] dependentBeans = getDependentBeans(beanName);
				Set&lt;String&gt; actualDependentBeans = <span class="hljs-keyword">new</span> LinkedHashSet&lt;&gt;(dependentBeans.length);
				<span class="hljs-keyword">for</span> (String dependentBean : dependentBeans) &#123;
					<span class="hljs-keyword">if</span> (!removeSingletonIfCreatedForTypeCheckOnly(dependentBean)) &#123;
						actualDependentBeans.add(dependentBean);
					&#125;
				&#125;
				<span class="hljs-keyword">if</span> (!actualDependentBeans.isEmpty()) &#123;
					<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCurrentlyInCreationException(beanName,
							<span class="hljs-string">"Bean with name '"</span> + beanName + <span class="hljs-string">"' has been injected into other beans ["</span> +
							StringUtils.collectionToCommaDelimitedString(actualDependentBeans) +
							<span class="hljs-string">"] in its raw version as part of a circular reference, but has eventually been "</span> +
							<span class="hljs-string">"wrapped. This means that said other beans do not use the final version of the "</span> +
							<span class="hljs-string">"bean. This is often the result of over-eager type matching - consider using "</span> +
							<span class="hljs-string">"'getBeanNamesOfType' with the 'allowEagerInit' flag turned off, for example."</span>);
				&#125;
			&#125;
		&#125;
	&#125;

	<span class="hljs-comment">// Register bean as disposable.</span>
	<span class="hljs-keyword">try</span> &#123;
		<span class="hljs-comment">//æ³¨å†Œbeané”€æ¯æ—¶çš„ç±»DisposableBeanAdapter</span>
		registerDisposableBeanIfNecessary(beanName, bean, mbd);
	&#125;
	<span class="hljs-keyword">catch</span> (BeanDefinitionValidationException ex) &#123;
		<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(
				mbd.getResourceDescription(), beanName, <span class="hljs-string">"Invalid destruction signature"</span>, ex);
	&#125;

	<span class="hljs-keyword">return</span> exposedObject;
&#125;</code></pre>

<p>getEarlyBeanReference()ä¼šå°†åˆšæ‰§è¡Œå®Œæ„é€ å‡½æ•°ï¼Œè¿˜æ²¡æœ‰è¿›è¡Œå±æ€§è®¾ç½®çš„ç±»è¿”å›ã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> Object <span class="hljs-title">getEarlyBeanReference</span><span class="hljs-params">(String beanName, RootBeanDefinition mbd, Object bean)</span> </span>&#123;
	Object exposedObject = bean;
	<span class="hljs-keyword">if</span> (!mbd.isSynthetic() &amp;&amp; hasInstantiationAwareBeanPostProcessors()) &#123;
		<span class="hljs-keyword">for</span> (BeanPostProcessor bp : getBeanPostProcessors()) &#123;
			<span class="hljs-keyword">if</span> (bp <span class="hljs-keyword">instanceof</span> SmartInstantiationAwareBeanPostProcessor) &#123;
				SmartInstantiationAwareBeanPostProcessor ibp = (SmartInstantiationAwareBeanPostProcessor) bp;
				exposedObject = ibp.getEarlyBeanReference(exposedObject, beanName);
			&#125;
		&#125;
	&#125;
	<span class="hljs-keyword">return</span> exposedObject;
&#125;</code></pre>

<p>å¾ªç¯ä¾èµ–æ­¥éª¤:</p>
<ol>
<li>Aç±»æ— å‚æ„é€ å‡½æ•°å®ä¾‹åŒ–åï¼Œè®¾ç½®ä¸‰çº§ç¼“å­˜ã€‚</li>
<li>Aç±»è¿›è¡Œä¾èµ–æ³¨å…¥ï¼Œè°ƒç”¨Bç±»çš„getBean()æ“ä½œã€‚</li>
<li>Bç±»æ— å‚æ„é€ å‡½æ•°å®ä¾‹åŒ–åï¼Œè®¾ç½®ä¸‰çº§ç¼“å­˜ã€‚</li>
<li>Bç±»ä¾èµ–æ³¨å…¥ï¼Œå†æ¬¡è§¦å‘äº†Aç±»getBean()æ“ä½œã€‚</li>
<li>Bç±»æ‹¿åˆ°äº†Açš„ä¸‰çº§ç¼“å­˜ä¸­çš„å®ä¾‹å¹¶æ³¨å…¥ã€‚</li>
<li>Bç±»çš„å®ä¾‹åŒ–å®Œæˆï¼Œç”±äºBç±»çš„åˆå§‹åŒ–æ˜¯Aç±»è°ƒç”¨getBean()å®Œæˆçš„ï¼ŒBç±»å®Œæˆå®ä¾‹åŒ–åä¼šè¿”å›ç»™Aç±»ã€‚</li>
<li>Aç±»è·å–åˆ°Bç±»ï¼Œå®Œæˆä¾èµ–æ³¨å…¥ã€‚</li>
</ol>
<p>çœ‹å®Œä¸Šé¢çš„æµç¨‹åï¼Œå¯¹äºæœ‰å‚æ„é€ å‡½æ•°ä¸­çš„@Autowiredé€ æˆçš„å¾ªç¯ä¾èµ–ç›´æ¥æŠ¥é”™çš„åŸå› å°±æ˜¾è€Œæ˜“è§äº†ã€‚å¦‚æœAç±»åœ¨æ‰§è¡Œæœ‰@Autowiredæ³¨è§£çš„æ„é€ å‡½æ•°æ—¶éœ€è¦æ³¨å…¥Bç±»ï¼ŒBç±»çš„æ„é€ å‡½æ•°ä¸­ä¹Ÿä½¿ç”¨@Autowiredè¦æ±‚æ³¨å…¥Aç±»ï¼Œé‚£ä¹ˆåœ¨è°ƒç”¨Açš„æ„é€ å‡½æ•°æ—¶ä¼šè§¦å‘Bç±»çš„åˆå§‹åŒ–ã€‚è€Œè¦å¤„ç†Bç±»æ„é€ å‡½æ•°çš„@Autowiredå°±éœ€è¦è·å–Açš„å®ä¾‹ï¼Œå°±ä¼šå†æ¬¡è§¦å‘Aç±»çš„getBean()ï¼Œä½†æ­¤æ—¶Açš„æ„é€ å‡½æ•°è¿˜æ²¡æœ‰å®Œæˆï¼Œé€šè¿‡ä¸‰çº§ç¼“å­˜æ˜¯æ‹¿ä¸åˆ°Aç±»çš„ï¼Œæ‰€ä»¥ä¼šå†æ¬¡è§¦å‘getSingletonå¾€singletonsCurrentlyInCreationä¸­æ”¾å…¥beanNameï¼Œä½†ç”±äºåœ¨ä¸Šé¢æ‰§è¡ŒAçš„æ„é€ å‡½æ•°ä¹‹å‰å°±å·²ç»å¾€singletonsCurrentlyInCreationæ”¾å…¥äº†Aç±»çš„beanNameï¼Œæ­¤æ—¶å†æ¬¡æ”¾å…¥ä¼šç›´æ¥æŠ¥é”™ã€‚</p>
<h2 id="FactoryBeanæ¥å£"><a href="#FactoryBeanæ¥å£" class="headerlink" title="FactoryBeanæ¥å£"></a>FactoryBeanæ¥å£</h2><p>è¯¥æ¥å£ä¸»è¦æ˜¯åœ¨BeanFactoryå®Œæˆå®ä¾‹åŒ–åï¼Œåˆ›å»ºäº¤ç»™Springç®¡ç†çš„ã€å¯ä»¥ç”¨äº@Autowiredæ³¨è§£çš„å¯¹è±¡ã€‚æ³¨æ„æ­¤æ—¶æ ¹æ®beanNameè·å–çš„æ˜¯BeanFactoryæ¥å£åˆ›å»ºçš„å®ä¾‹ï¼Œå¦‚æœè¦è·å–BeanFactoryæ¥å£çš„å®ä¾‹éœ€è¦åœ¨BeanNameå‰åŠ ä¸Š&amp;ç¬¦å·ã€‚</p>
<p>getObjectForBeanInstance()æ–¹æ³•ç”¨äºå¯¹è¯¥æ¥å£çš„æ”¯æŒï¼Œå¦‚æœbeanNameä¸æ˜¯ä»¥&amp;å¼€å¤´ï¼Œå¹¶ä¸”beanInstanceæ˜¯FactoryBeanç±»å‹ï¼Œå°±ä¼šä»ç¼“å­˜é‡Œé¢æ‹¿FactoryBeanç±»å‹çš„å®ä¾‹ï¼Œç„¶åè°ƒç”¨getObjectFromFactoryBean()æ–¹æ³•åˆ›å»ºå®ä¾‹ã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> Object <span class="hljs-title">getObjectForBeanInstance</span><span class="hljs-params">(</span></span>
<span class="hljs-function"><span class="hljs-params">		Object beanInstance, String name, String beanName, @Nullable RootBeanDefinition mbd)</span> </span>&#123;

	<span class="hljs-comment">// Don't let calling code try to dereference the factory if the bean isn't a factory.</span>
	<span class="hljs-keyword">if</span> (BeanFactoryUtils.isFactoryDereference(name)) &#123;
		<span class="hljs-keyword">if</span> (beanInstance <span class="hljs-keyword">instanceof</span> NullBean) &#123;
			<span class="hljs-keyword">return</span> beanInstance;
		&#125;
		<span class="hljs-keyword">if</span> (!(beanInstance <span class="hljs-keyword">instanceof</span> FactoryBean)) &#123;
			<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanIsNotAFactoryException(transformedBeanName(name), beanInstance.getClass());
		&#125;
	&#125;

	<span class="hljs-comment">// Now we have the bean instance, which may be a normal bean or a FactoryBean.</span>
	<span class="hljs-comment">// If it's a FactoryBean, we use it to create a bean instance, unless the</span>
	<span class="hljs-comment">// caller actually wants a reference to the factory.</span>
	<span class="hljs-comment">//å¦‚æœå®ä¾‹ä¸æ˜¯FactoryBeanç±»å‹çš„ï¼Œæˆ–è€…nameæ˜¯ä»¥&amp;å·å¼€å¤´çš„ï¼Œåˆ™ç›´æ¥è¿”å›å®ä¾‹</span>
	<span class="hljs-keyword">if</span> (!(beanInstance <span class="hljs-keyword">instanceof</span> FactoryBean) || BeanFactoryUtils.isFactoryDereference(name)) &#123;
		<span class="hljs-keyword">return</span> beanInstance;
	&#125;

	<span class="hljs-comment">//å¦‚æœä»£ç èƒ½èµ°ä¸‹æ¥ï¼Œåˆ™è¯´æ˜ beanNameä¸æ˜¯ä»¥&amp;å¼€å¤´ï¼Œå¹¶ä¸”beanInstanceæ˜¯FactoryBeanç±»å‹çš„</span>
	Object object = <span class="hljs-keyword">null</span>;
	<span class="hljs-keyword">if</span> (mbd == <span class="hljs-keyword">null</span>) &#123;
		<span class="hljs-comment">//ä»ç¼“å­˜é‡Œé¢æ‹¿FactoryBeanç±»å‹çš„å®ä¾‹</span>
		object = getCachedObjectForFactoryBean(beanName);
	&#125;
	<span class="hljs-keyword">if</span> (object == <span class="hljs-keyword">null</span>) &#123;
		<span class="hljs-comment">// Return bean instance from factory.</span>
		FactoryBean&lt;?&gt; factory = (FactoryBean&lt;?&gt;) beanInstance;
		<span class="hljs-comment">// Caches object obtained from FactoryBean if it is a singleton.</span>
		<span class="hljs-keyword">if</span> (mbd == <span class="hljs-keyword">null</span> &amp;&amp; containsBeanDefinition(beanName)) &#123;
			mbd = getMergedLocalBeanDefinition(beanName);
		&#125;
		<span class="hljs-keyword">boolean</span> synthetic = (mbd != <span class="hljs-keyword">null</span> &amp;&amp; mbd.isSynthetic());

		<span class="hljs-comment">//é‡ç‚¹çœ‹</span>
		object = getObjectFromFactoryBean(factory, beanName, !synthetic);
	&#125;
	<span class="hljs-keyword">return</span> object;
&#125;</code></pre>

<p>getObjectFromFactoryBean()æ–¹æ³•ä¼šè°ƒç”¨FactoryBeanæ¥å£çš„getObject()æ–¹æ³•è·å–å®ä¾‹ï¼Œç„¶åå°†åˆ›å»ºçš„å¯¹è±¡ä¼šæ”¾å…¥factoryBeanObjectCacheå®¹å™¨ä¸­ï¼Œè€Œä¸æ˜¯ä¸€çº§ç¼“å­˜çš„å®¹å™¨ã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> Object <span class="hljs-title">getObjectFromFactoryBean</span><span class="hljs-params">(FactoryBean&lt;?&gt; factory, String beanName, <span class="hljs-keyword">boolean</span> shouldPostProcess)</span> </span>&#123;
	<span class="hljs-keyword">if</span> (factory.isSingleton() &amp;&amp; containsSingleton(beanName)) &#123;
		<span class="hljs-keyword">synchronized</span> (getSingletonMutex()) &#123;
			Object object = <span class="hljs-keyword">this</span>.factoryBeanObjectCache.get(beanName);
			<span class="hljs-keyword">if</span> (object == <span class="hljs-keyword">null</span>) &#123;
				<span class="hljs-comment">//è°ƒç”¨getObjectæ–¹æ³•</span>
				object = doGetObjectFromFactoryBean(factory, beanName);
				<span class="hljs-comment">// Only post-process and store if not put there already during getObject() call above</span>
				<span class="hljs-comment">// (e.g. because of circular reference processing triggered by custom getBean calls)</span>
				Object alreadyThere = <span class="hljs-keyword">this</span>.factoryBeanObjectCache.get(beanName);
				<span class="hljs-keyword">if</span> (alreadyThere != <span class="hljs-keyword">null</span>) &#123;
					object = alreadyThere;
				&#125;
				<span class="hljs-keyword">else</span> &#123;
					<span class="hljs-keyword">if</span> (shouldPostProcess) &#123;
						<span class="hljs-keyword">if</span> (isSingletonCurrentlyInCreation(beanName)) &#123;
							<span class="hljs-comment">// Temporarily return non-post-processed object, not storing it yet..</span>
							<span class="hljs-keyword">return</span> object;
						&#125;
						beforeSingletonCreation(beanName);
						<span class="hljs-keyword">try</span> &#123;
							object = postProcessObjectFromFactoryBean(object, beanName);
						&#125;
						<span class="hljs-keyword">catch</span> (Throwable ex) &#123;
							<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(beanName,
									<span class="hljs-string">"Post-processing of FactoryBean's singleton object failed"</span>, ex);
						&#125;
						<span class="hljs-keyword">finally</span> &#123;
							afterSingletonCreation(beanName);
						&#125;
					&#125;
					<span class="hljs-keyword">if</span> (containsSingleton(beanName)) &#123;
						<span class="hljs-comment">//æŠŠå®ä¾‹ç¼“å­˜åˆ°factoryBeanObjectCache mapä¸­ï¼Œè¿™ä¸ªæ˜¯å•ç‹¬ç¼“å­˜FactoryBeanç±»å‹å®ä¾‹çš„map</span>
						<span class="hljs-keyword">this</span>.factoryBeanObjectCache.put(beanName, object);
					&#125;
				&#125;
			&#125;
			<span class="hljs-keyword">return</span> object;
		&#125;
	&#125;
	<span class="hljs-keyword">else</span> &#123;
		Object object = doGetObjectFromFactoryBean(factory, beanName);
		<span class="hljs-keyword">if</span> (shouldPostProcess) &#123;
			<span class="hljs-keyword">try</span> &#123;
				object = postProcessObjectFromFactoryBean(object, beanName);
			&#125;
			<span class="hljs-keyword">catch</span> (Throwable ex) &#123;
				<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(beanName, <span class="hljs-string">"Post-processing of FactoryBean's object failed"</span>, ex);
			&#125;
		&#125;
		<span class="hljs-keyword">return</span> object;
	&#125;
&#125;</code></pre>

<h2 id="BeanPostProcessoræ¥å£"><a href="#BeanPostProcessoræ¥å£" class="headerlink" title="BeanPostProcessoræ¥å£"></a>BeanPostProcessoræ¥å£</h2><p>BeanPostProcessoræ¥å£ç±»å‹å®ä¾‹æ˜¯é’ˆå¯¹æŸç§ç‰¹å®šåŠŸèƒ½çš„åŸ‹ç‚¹ï¼Œåœ¨è¿™ä¸ªç‚¹ä¼šæ ¹æ®æ¥å£ç±»å‹æ¥è¿‡æ»¤æ‰ä¸å…³æ³¨è¿™ä¸ªç‚¹çš„å…¶ä»–ç±»ï¼Œåªæœ‰çœŸæ­£å…³æ³¨çš„ç±»æ‰ä¼šåœ¨è¿™ä¸ªç‚¹è¿›è¡Œç›¸åº”çš„åŠŸèƒ½å®ç°ã€‚åœ¨ä½¿ç”¨æ—¶é€šå¸¸ä¼šæ‹¿åˆ°æ‰€æœ‰çš„BeanPostProcessoræ¥å£ï¼Œç„¶åå¾ªç¯æ ¹æ®BeanPostProcessoræ¥å£çš„ç±»å‹è¿›è¡Œè¿‡æ»¤ï¼Œæˆ–è€…ç›´æ¥è°ƒç”¨å¯¹åº”çš„æ–¹æ³•ï¼Œå¦‚æœè¯¥BeanPostProcessoræ¥å£ä¸å…³æ³¨è¿™ä¸ªç‚¹ï¼Œå¯¹åº”çš„æ–¹æ³•ä¸­å°±æ²¡æœ‰ç›¸åº”çš„å®ç°ã€‚</p>
<h3 id="è·å–æœ‰-Autowiredæ³¨è§£çš„æ„é€ å‡½æ•°åŸ‹ç‚¹"><a href="#è·å–æœ‰-Autowiredæ³¨è§£çš„æ„é€ å‡½æ•°åŸ‹ç‚¹" class="headerlink" title="è·å–æœ‰@Autowiredæ³¨è§£çš„æ„é€ å‡½æ•°åŸ‹ç‚¹"></a>è·å–æœ‰@Autowiredæ³¨è§£çš„æ„é€ å‡½æ•°åŸ‹ç‚¹</h3><p>doCreateBean()åˆå§‹åŒ–Beanå®ä¾‹æ—¶ï¼Œç”¨äºåˆ›å»ºBeanå®ä¾‹çš„createBeanInstance()æ–¹æ³•ä¸­ï¼Œä¼šè°ƒç”¨determineConstructorsFromBeanPostProcessors()æ–¹æ³•è·å¾—æœ‰@Autowiredæ³¨è§£çš„æ„é€ æ–¹æ³•ã€‚</p>
<pre><code class="hljs reasonml"><span class="hljs-comment">// Candidate constructors for autowiring?</span>
<span class="hljs-comment">//å¯»æ‰¾å½“å‰æ­£åœ¨å®ä¾‹åŒ–çš„beanä¸­æœ‰@Autowiredæ³¨è§£çš„æ„é€ å‡½æ•°</span>
Constructor&lt;?&gt;<span class="hljs-literal">[]</span> ctors = determine<span class="hljs-constructor">ConstructorsFromBeanPostProcessors(<span class="hljs-params">beanClass</span>, <span class="hljs-params">beanName</span>)</span>;
<span class="hljs-keyword">if</span> (ctors != null<span class="hljs-operator"> || </span>mbd.get<span class="hljs-constructor">ResolvedAutowireMode()</span><span class="hljs-operator"> == </span>AUTOWIRE_CONSTRUCTOR <span class="hljs-pattern-match"><span class="hljs-operator">||</span></span>
<span class="hljs-pattern-match">		mbd.has<span class="hljs-constructor">ConstructorArgumentValues()</span> <span class="hljs-operator">||</span> !<span class="hljs-constructor">ObjectUtils</span>.is<span class="hljs-constructor">Empty(<span class="hljs-params">args</span>)</span>) &#123;</span>
<span class="hljs-pattern-match">	<span class="hljs-operator">/</span><span class="hljs-operator">/</span>å¦‚æœctorsä¸ä¸ºç©ºï¼Œå°±è¯´æ˜æ„é€ å‡½æ•°ä¸Šæœ‰@<span class="hljs-constructor">Autowired</span>æ³¨è§£</span>
<span class="hljs-pattern-match">	return autowire<span class="hljs-constructor">Constructor(<span class="hljs-params">beanName</span>, <span class="hljs-params">mbd</span>, <span class="hljs-params">ctors</span>, <span class="hljs-params">args</span>)</span>;</span>
<span class="hljs-pattern-match">&#125;</span></code></pre>

<p>è¿™é‡Œè¿‡æ»¤çš„æ¥å£ç±»å‹æ˜¯SmartInstantiationAwareBeanPostProcessorï¼Œè°ƒç”¨çš„æ–¹æ³•æ˜¯determineCandidateConstructors()ã€‚</p>
<pre><code class="hljs java"><span class="hljs-keyword">protected</span> Constructor&lt;?&gt;[] determineConstructorsFromBeanPostProcessors(<span class="hljs-meta">@Nullable</span> Class&lt;?&gt; beanClass, String beanName)
		<span class="hljs-keyword">throws</span> BeansException &#123;

	<span class="hljs-keyword">if</span> (beanClass != <span class="hljs-keyword">null</span> &amp;&amp; hasInstantiationAwareBeanPostProcessors()) &#123;
		<span class="hljs-comment">//è·å–æ‰€æœ‰çš„BeanPostProcessors</span>
		<span class="hljs-keyword">for</span> (BeanPostProcessor bp : getBeanPostProcessors()) &#123;
			<span class="hljs-keyword">if</span> (bp <span class="hljs-keyword">instanceof</span> SmartInstantiationAwareBeanPostProcessor) &#123;
				SmartInstantiationAwareBeanPostProcessor ibp = (SmartInstantiationAwareBeanPostProcessor) bp;
				<span class="hljs-comment">//æ‰¾åˆ°åˆé€‚çš„æ„é€ å‡½æ•°</span>
				Constructor&lt;?&gt;[] ctors = ibp.determineCandidateConstructors(beanClass, beanName);
				<span class="hljs-keyword">if</span> (ctors != <span class="hljs-keyword">null</span>) &#123;
					<span class="hljs-keyword">return</span> ctors;
				&#125;
			&#125;
		&#125;
	&#125;
	<span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
&#125;</code></pre>

<h3 id="æ”¶é›†-Resourceã€-Autowiredã€-Value-PostConstructã€-PreDestroyæ³¨è§£çš„æ–¹æ³•å’Œå±æ€§åŸ‹ç‚¹"><a href="#æ”¶é›†-Resourceã€-Autowiredã€-Value-PostConstructã€-PreDestroyæ³¨è§£çš„æ–¹æ³•å’Œå±æ€§åŸ‹ç‚¹" class="headerlink" title="æ”¶é›†@Resourceã€@Autowiredã€@Value@PostConstructã€@PreDestroyæ³¨è§£çš„æ–¹æ³•å’Œå±æ€§åŸ‹ç‚¹"></a>æ”¶é›†@Resourceã€@Autowiredã€@Value@PostConstructã€@PreDestroyæ³¨è§£çš„æ–¹æ³•å’Œå±æ€§åŸ‹ç‚¹</h3><p>doCreateBean()è¿›è¡Œæ³¨è§£çš„è£…é…æ—¶ï¼Œä¼šä½¿ç”¨applyMergedBeanDefinitionPostProcessors()æ–¹æ³•ã€‚</p>
<pre><code class="hljs java"><span class="hljs-keyword">synchronized</span> (mbd.postProcessingLock) &#123;
	<span class="hljs-keyword">if</span> (!mbd.postProcessed) &#123;
		<span class="hljs-keyword">try</span> &#123;
			<span class="hljs-comment">//CommonAnnotationBeanPostProcessor  æ”¯æŒäº†@PostConstructï¼Œ@PreDestroy,@Resourceæ³¨è§£</span>
			<span class="hljs-comment">//AutowiredAnnotationBeanPostProcessor æ”¯æŒ @Autowired,@Valueæ³¨è§£</span>
			<span class="hljs-comment">//BeanPostProcessoræ¥å£çš„å…¸å‹è¿ç”¨ï¼Œè¿™é‡Œè¦ç†è§£è¿™ä¸ªæ¥å£</span>
			<span class="hljs-comment">//å¯¹ç±»ä¸­æ³¨è§£çš„è£…é…è¿‡ç¨‹</span>
			<span class="hljs-comment">//é‡è¦ç¨‹åº¦5ï¼Œå¿…é¡»çœ‹</span>
			applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName);
		&#125;
		<span class="hljs-keyword">catch</span> (Throwable ex) &#123;
			<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName,
					<span class="hljs-string">"Post-processing of merged bean definition failed"</span>, ex);
		&#125;
		mbd.postProcessed = <span class="hljs-keyword">true</span>;
	&#125;
&#125;</code></pre>

<p>è¿‡æ»¤çš„æ¥å£ç±»å‹æ˜¯MergedBeanDefinitionPostProcessorï¼Œè°ƒç”¨çš„æ–¹æ³•æ˜¯postProcessMergedBeanDefinition()ã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">applyMergedBeanDefinitionPostProcessors</span><span class="hljs-params">(RootBeanDefinition mbd, Class&lt;?&gt; beanType, String beanName)</span> </span>&#123;
	<span class="hljs-keyword">for</span> (BeanPostProcessor bp : getBeanPostProcessors()) &#123;
		<span class="hljs-keyword">if</span> (bp <span class="hljs-keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;
			MergedBeanDefinitionPostProcessor bdp = (MergedBeanDefinitionPostProcessor) bp;
			bdp.postProcessMergedBeanDefinition(mbd, beanType, beanName);
		&#125;
	&#125;
&#125;</code></pre>

<h3 id="å¾ªç¯ä¾èµ–è§£å†³ä¸­beançš„æå‰æš´éœ²åŸ‹ç‚¹"><a href="#å¾ªç¯ä¾èµ–è§£å†³ä¸­beançš„æå‰æš´éœ²åŸ‹ç‚¹" class="headerlink" title="å¾ªç¯ä¾èµ–è§£å†³ä¸­beançš„æå‰æš´éœ²åŸ‹ç‚¹"></a>å¾ªç¯ä¾èµ–è§£å†³ä¸­beançš„æå‰æš´éœ²åŸ‹ç‚¹</h3><p>doCreateBean()å¯¹Beanè¿›è¡Œæå‰æš´éœ²æ—¶ï¼Œä¼šè°ƒç”¨getEarlyBeanReference()æ–¹æ³•è·å–åˆ°Beanå®ä¾‹ã€‚</p>
<pre><code class="hljs java"><span class="hljs-comment">//æ˜¯å¦	å•ä¾‹beanæå‰æš´éœ²</span>
<span class="hljs-keyword">boolean</span> earlySingletonExposure = (mbd.isSingleton() &amp;&amp; <span class="hljs-keyword">this</span>.allowCircularReferences &amp;&amp;
		isSingletonCurrentlyInCreation(beanName));
<span class="hljs-keyword">if</span> (earlySingletonExposure) &#123;
	<span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;
		logger.trace(<span class="hljs-string">"Eagerly caching bean '"</span> + beanName +
				<span class="hljs-string">"' to allow for resolving potential circular references"</span>);
	&#125;
	<span class="hljs-comment">//è¿™é‡Œç€é‡ç†è§£ï¼Œå¯¹ç†è§£å¾ªç¯ä¾èµ–å¸®åŠ©éå¸¸å¤§ï¼Œé‡è¦ç¨‹åº¦ 5   æ·»åŠ ä¸‰çº§ç¼“å­˜</span>
	addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean));
&#125;</code></pre>

<p>è¿‡æ»¤çš„æ¥å£ç±»å‹æ˜¯SmartInstantiationAwareBeanPostProcessorï¼Œè°ƒç”¨çš„æ–¹æ³•æ˜¯determineCandidateConstructors()ã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> Object <span class="hljs-title">getEarlyBeanReference</span><span class="hljs-params">(String beanName, RootBeanDefinition mbd, Object bean)</span> </span>&#123;
	Object exposedObject = bean;
	<span class="hljs-keyword">if</span> (!mbd.isSynthetic() &amp;&amp; hasInstantiationAwareBeanPostProcessors()) &#123;
		<span class="hljs-keyword">for</span> (BeanPostProcessor bp : getBeanPostProcessors()) &#123;
			<span class="hljs-keyword">if</span> (bp <span class="hljs-keyword">instanceof</span> SmartInstantiationAwareBeanPostProcessor) &#123;
				SmartInstantiationAwareBeanPostProcessor ibp = (SmartInstantiationAwareBeanPostProcessor) bp;
				exposedObject = ibp.getEarlyBeanReference(exposedObject, beanName);
			&#125;
		&#125;
	&#125;
	<span class="hljs-keyword">return</span> exposedObject;
&#125;</code></pre>

<h3 id="é˜»æ­¢ä¾èµ–æ³¨å…¥åŸ‹ç‚¹"><a href="#é˜»æ­¢ä¾èµ–æ³¨å…¥åŸ‹ç‚¹" class="headerlink" title="é˜»æ­¢ä¾èµ–æ³¨å…¥åŸ‹ç‚¹"></a>é˜»æ­¢ä¾èµ–æ³¨å…¥åŸ‹ç‚¹</h3><p>ä½äºdoCreateBean()è¿›è¡Œä¾èµ–æ³¨å…¥æ—¶ï¼ŒpopulateBean()æ–¹æ³•ä¸­ã€‚</p>
<p>è¿‡æ»¤çš„æ¥å£ç±»å‹æ˜¯InstantiationAwareBeanPostProcessorï¼Œè°ƒç”¨çš„æ–¹æ³•æ˜¯postProcessAfterInstantiationã€‚</p>
<pre><code class="hljs java"><span class="hljs-comment">//è¿™é‡Œå†™æ¥å£å¯ä»¥è®©æ‰€æœ‰ç±»éƒ½ä¸èƒ½ä¾èµ–æ³¨å…¥</span>
<span class="hljs-keyword">if</span> (!mbd.isSynthetic() &amp;&amp; hasInstantiationAwareBeanPostProcessors()) &#123;
	<span class="hljs-keyword">for</span> (BeanPostProcessor bp : getBeanPostProcessors()) &#123;
		<span class="hljs-keyword">if</span> (bp <span class="hljs-keyword">instanceof</span> InstantiationAwareBeanPostProcessor) &#123;
			InstantiationAwareBeanPostProcessor ibp = (InstantiationAwareBeanPostProcessor) bp;
			<span class="hljs-keyword">if</span> (!ibp.postProcessAfterInstantiation(bw.getWrappedInstance(), beanName)) &#123;

				<span class="hljs-comment">//æ˜¯å¦éœ€è¦DIï¼Œä¾èµ–æ³¨å…¥</span>
				continueWithPropertyPopulation = <span class="hljs-keyword">false</span>;
				<span class="hljs-keyword">break</span>;
			&#125;
		&#125;
	&#125;
&#125;</code></pre>

<h3 id="IOC-DI-ä¾èµ–æ³¨å…¥åŸ‹ç‚¹"><a href="#IOC-DI-ä¾èµ–æ³¨å…¥åŸ‹ç‚¹" class="headerlink" title="IOC/DI ä¾èµ–æ³¨å…¥åŸ‹ç‚¹"></a>IOC/DI ä¾èµ–æ³¨å…¥åŸ‹ç‚¹</h3><p>ä½äºdoCreateBean()è¿›è¡Œä¾èµ–æ³¨å…¥æ—¶ï¼ŒpopulateBean()æ–¹æ³•ä¸­ã€‚</p>
<p>è¿‡æ»¤çš„æ¥å£ç±»å‹æ˜¯InstantiationAwareBeanPostProcessorï¼Œè°ƒç”¨çš„æ–¹æ³•æ˜¯postProcessPropertiesã€‚</p>
<pre><code class="hljs java"><span class="hljs-comment">//é‡ç‚¹çœ‹è¿™ä¸ªifä»£ç å—ï¼Œé‡è¦ç¨‹åº¦ 5</span>
<span class="hljs-keyword">if</span> (hasInstAwareBpps) &#123;
	<span class="hljs-keyword">if</span> (pvs == <span class="hljs-keyword">null</span>) &#123;
		pvs = mbd.getPropertyValues();
	&#125;
	<span class="hljs-keyword">for</span> (BeanPostProcessor bp : getBeanPostProcessors()) &#123;
		<span class="hljs-keyword">if</span> (bp <span class="hljs-keyword">instanceof</span> InstantiationAwareBeanPostProcessor) &#123;
			InstantiationAwareBeanPostProcessor ibp = (InstantiationAwareBeanPostProcessor) bp;
			<span class="hljs-comment">//ä¾èµ–æ³¨å…¥è¿‡ç¨‹ï¼Œ@Autowiredçš„æ”¯æŒ</span>
			PropertyValues pvsToUse = ibp.postProcessProperties(pvs, bw.getWrappedInstance(), beanName);
			<span class="hljs-keyword">if</span> (pvsToUse == <span class="hljs-keyword">null</span>) &#123;
				<span class="hljs-keyword">if</span> (filteredPds == <span class="hljs-keyword">null</span>) &#123;
					filteredPds = filterPropertyDescriptorsForDependencyCheck(bw, mbd.allowCaching);
				&#125;

				<span class="hljs-comment">//è€ç‰ˆæœ¬ç”¨è¿™ä¸ªå®Œæˆä¾èµ–æ³¨å…¥è¿‡ç¨‹ï¼Œ@Autowiredçš„æ”¯æŒ</span>
				pvsToUse = ibp.postProcessPropertyValues(pvs, filteredPds, bw.getWrappedInstance(), beanName);
				<span class="hljs-keyword">if</span> (pvsToUse == <span class="hljs-keyword">null</span>) &#123;
					<span class="hljs-keyword">return</span>;
				&#125;
			&#125;
			pvs = pvsToUse;
		&#125;
	&#125;
  &#125;</code></pre>

<h3 id="Beané”€æ¯çš„åŸ‹ç‚¹"><a href="#Beané”€æ¯çš„åŸ‹ç‚¹" class="headerlink" title="Beané”€æ¯çš„åŸ‹ç‚¹"></a>Beané”€æ¯çš„åŸ‹ç‚¹</h3><p>ä½äºdoGreateBean().registerDisposableBeanIfNecessary()æ–¹æ³•ä¸­è°ƒç”¨DisposableBeanAdapterçš„æ„é€ å‡½æ•°æ—¶ã€‚ç”¨äºå¯»æ‰¾DestructionAwareBeanPostProcessorç±»å‹çš„BeanPostProcessorã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> List&lt;DestructionAwareBeanPostProcessor&gt; <span class="hljs-title">filterPostProcessors</span><span class="hljs-params">(List&lt;BeanPostProcessor&gt; processors, Object bean)</span> </span>&#123;
	List&lt;DestructionAwareBeanPostProcessor&gt; filteredPostProcessors = <span class="hljs-keyword">null</span>;
	<span class="hljs-keyword">if</span> (!CollectionUtils.isEmpty(processors)) &#123;
		filteredPostProcessors = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;(processors.size());
		<span class="hljs-keyword">for</span> (BeanPostProcessor processor : processors) &#123;
			<span class="hljs-keyword">if</span> (processor <span class="hljs-keyword">instanceof</span> DestructionAwareBeanPostProcessor) &#123;
				DestructionAwareBeanPostProcessor dabpp = (DestructionAwareBeanPostProcessor) processor;
				<span class="hljs-keyword">if</span> (dabpp.requiresDestruction(bean)) &#123;
					filteredPostProcessors.add(dabpp);
				&#125;
			&#125;
		&#125;
	&#125;
	<span class="hljs-keyword">return</span> filteredPostProcessors;
&#125;</code></pre>


            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/blog/categories/Spring%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/">Springæºç è§£æ</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/blog/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/">æºç è§£æ</a>
                    
                      <a class="hover-with-bg" href="/blog/tags/spring/">spring</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" target="_blank" rel="nofollow noopener noopener">CC BY-SA 4.0 åè®®</a> ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</p>
              
              
                <div class="post-prevnext row">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/blog/2020/04/18/spring-%E5%9F%BA%E4%BA%8E%E6%B3%A8%E8%A7%A3%E7%9A%84%E5%90%AF%E5%8A%A8%E6%96%B9%E5%BC%8F%E8%A7%A3%E6%9E%90%E5%92%8CBean%E7%9A%84%E4%BD%9C%E7%94%A8%E5%9F%9F/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">SpringåŸºäºæ³¨è§£çš„å¯åŠ¨æ–¹å¼è§£æå’ŒBeançš„ä½œç”¨åŸŸ</span>
                        <span class="visible-mobile">ä¸Šä¸€ç¯‡</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/blog/2020/04/13/spring-%E5%88%9D%E5%A7%8B%E5%8C%96%E5%85%A5%E5%8F%A3%E5%92%8Cxml%E8%A7%A3%E6%9E%90/">
                        <span class="hidden-mobile">Springçš„åˆå§‹åŒ–å…¥å£å’Œxmlè§£æ</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener">
        <span>Fluid</span></a>
    </div>
    
  <div class="statistics">
    
    

    
      
        <!-- ä¸è’œå­ç»Ÿè®¡PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            æ€»è®¿é—®é‡ 
            <span id="busuanzi_value_site_pv"></span>
             æ¬¡
          </span>
      
      
        <!-- ä¸è’œå­ç»Ÿè®¡UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            æ€»è®¿å®¢æ•° 
            <span id="busuanzi_value_site_uv"></span>
             äºº
          </span>
      
    
  </div>


    

    
  </div>
</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/blog/js/debouncer.js" ></script>
<script  src="/blog/js/main.js" ></script>

<!-- Plugins -->


  
    <script  src="/blog/js/lazyload.js" ></script>
  



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/blog/js/clipboard-use.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: '#post-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "Springå®ä¾‹åŒ–Beançš„è¿‡ç¨‹&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/blog/js/local-search.js" ></script>
  <script>
    var path = "/blog/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>







  
  
    <script type="text/javascript">
      //å®šä¹‰è·å–è¯è¯­ä¸‹æ ‡
      var a_idx = 0;
      jQuery(document).ready(function ($) {
        //ç‚¹å‡»bodyæ—¶è§¦å‘äº‹ä»¶
        $("body").click(function (e) {
          //éœ€è¦æ˜¾ç¤ºçš„è¯è¯­
          var a = new Array("å¯Œå¼º", "æ°‘ä¸»", "æ–‡æ˜", "å’Œè°", "è‡ªç”±", "å¹³ç­‰", "å…¬æ­£", "æ³•æ²»", "çˆ±å›½", "æ•¬ä¸š", "è¯šä¿¡", "å‹å–„");
          //è®¾ç½®è¯è¯­ç»™spanæ ‡ç­¾
          var $i = $("<span/>").text(a[a_idx]);
          //ä¸‹æ ‡ç­‰äºåŸæ¥ä¸‹æ ‡+1  ä½™ è¯è¯­æ€»æ•°
          a_idx = (a_idx + 1) % a.length;
          //è·å–é¼ æ ‡æŒ‡é’ˆçš„ä½ç½®ï¼Œåˆ†åˆ«ç›¸å¯¹äºæ–‡æ¡£çš„å·¦å’Œå³è¾¹ç¼˜ã€‚
          //è·å–xå’Œyçš„æŒ‡é’ˆåæ ‡
          var x = e.pageX, y = e.pageY;
          //åœ¨é¼ æ ‡çš„æŒ‡é’ˆçš„ä½ç½®ç»™$iå®šä¹‰çš„spanæ ‡ç­¾æ·»åŠ cssæ ·å¼
          $i.css({
            "z-index": 999,
            "top": y - 20,
            "left": x,
            "position": "absolute",
            "font-weight": "bold",
            "color": rand_color()
          });
          // éšæœºé¢œè‰²
          function rand_color() {
            return "rgb(" + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + ")"
          }
          //åœ¨bodyæ·»åŠ è¿™ä¸ªæ ‡ç­¾
          $("body").append($i);
          //animate() æ–¹æ³•æ‰§è¡Œ CSS å±æ€§é›†çš„è‡ªå®šä¹‰åŠ¨ç”»ã€‚
          //è¯¥æ–¹æ³•é€šè¿‡CSSæ ·å¼å°†å…ƒç´ ä»ä¸€ä¸ªçŠ¶æ€æ”¹å˜ä¸ºå¦ä¸€ä¸ªçŠ¶æ€ã€‚CSSå±æ€§å€¼æ˜¯é€æ¸æ”¹å˜çš„ï¼Œè¿™æ ·å°±å¯ä»¥åˆ›å»ºåŠ¨ç”»æ•ˆæœã€‚
          //è¯¦æƒ…è¯·çœ‹http://www.w3school.com.cn/jquery/effect_animate.asp
          $i.animate({
            //å°†åŸæ¥çš„ä½ç½®å‘ä¸Šç§»åŠ¨180
            "top": y - 180,
            "opacity": 0
            //1500åŠ¨ç”»çš„é€Ÿåº¦
          }, 1500, function () {
            //æ—¶é—´åˆ°äº†è‡ªåŠ¨åˆ é™¤
            $i.remove();
          });
        });
      })
      ;
    </script>
  














</body>
</html>
