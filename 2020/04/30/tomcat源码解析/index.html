<!DOCTYPE html>
<html lang="zh-CN">





<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="">
  <meta name="keywords" content="">
  <title>tomcatæºç è§£æ - ğŸğŸŠ&#39;s blog</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/5.12.1/css/all.min.css" />
<link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />
<link  rel="stylesheet" href="https://cdn.staticfile.org/mdbootstrap/4.13.0/css/mdb.min.css" />
<link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/3.0.1/github-markdown.min.css" />

<link rel="stylesheet" href="//at.alicdn.com/t/font_1067060_qzomjdt8bmp.css">



  <link  rel="stylesheet" href="/lib/prettify/tomorrow-night-eighties.min.css" />

<link  rel="stylesheet" href="/css/main.css" />


  <link defer rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />


<!-- è‡ªå®šä¹‰æ ·å¼ä¿æŒåœ¨æœ€åº•éƒ¨ -->


<meta name="generator" content="Hexo 4.2.1"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>ğŸğŸŠ's blog</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/">é¦–é¡µ</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/archives/">å½’æ¡£</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/categories/">åˆ†ç±»</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/tags/">æ ‡ç­¾</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/about">å…³äº</a>
          </li>
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="view intro-2" id="background" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask rgba-black-light flex-center">
          <div class="container text-center white-text fadeInUp">
            <span class="h2" id="subtitle">
              
            </span>

            
              
                <p class="mt-3 post-meta">
                  <i class="fas fa-calendar-alt" aria-hidden="true"></i>
                  æ˜ŸæœŸå››, å››æœˆ 30æ—¥ 2020, 6:26 æ™šä¸Š
                </p>
              

              <p class="mt-1">
                
                  
                  <span class="post-meta">
                    <i class="far fa-chart-bar"></i>
                    6.9k å­—
                  </span>
                

                
                  
                  <span class="post-meta">
                      <i class="far fa-clock"></i>
                      29 åˆ†é’Ÿ
                  </span>
                

                
                  <!-- ä¸è’œå­ç»Ÿè®¡æ–‡ç« PV -->
                  
                  <span id="busuanzi_container_page_pv" class="post-meta" style="display: none">
                    <i class="far fa-eye" aria-hidden="true"></i>
                    <span id="busuanzi_value_page_pv"></span> æ¬¡
                  </span>
                
              </p>
            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5 z-depth-3" id="board">
          <div class="post-content mx-auto" id="post">
            
              <p
                class="note note-warning">æœ¬æ–‡æœ€åæ›´æ–°äºï¼šæ˜ŸæœŸäºŒ, äº”æœˆ 5æ—¥ 2020, 11:27 æ™šä¸Š</p>
            
            <div class="markdown-body">
              <h2 id="tomcatæºç ç›®å½•"><a href="#tomcatæºç ç›®å½•" class="headerlink" title="tomcatæºç ç›®å½•"></a>tomcatæºç ç›®å½•</h2><ul>
<li><p>catalinaç›®å½•ï¼šcatalinaåŒ…å«æ‰€æœ‰çš„Servletå®¹å™¨å®ç°ï¼Œä»¥åŠæ¶‰åŠåˆ°å®‰å…¨ã€ä¼šè¯ã€é›†ç¾¤ã€éƒ¨ç½²ç®¡ç†Servletå®¹å™¨çš„å„ä¸ªæ–¹é¢ï¼ŒåŒæ—¶ï¼Œå®ƒè¿˜åŒ…å«äº†å¯åŠ¨å…¥å£ã€‚</p>
</li>
<li><p>coyoteç›®å½•ï¼šcoyoteæ˜¯Tomcaté“¾æ¥å™¨æ¡†æ¶çš„åç§°ï¼Œæ˜¯TomcatæœåŠ¡å™¨æä¾›çš„å®¢æˆ·ç«¯è®¿é—®çš„å¤–éƒ¨æ¥å£ï¼Œå®¢æˆ·ç«¯é€šè¿‡Coyoteä¸æœåŠ¡å™¨å»ºç«‹é“¾æ¥ã€å‘é€è¯·æ±‚å¹¶æ¥æ”¶å“åº”ã€‚</p>
</li>
<li><p>Elç›®å½•ï¼Œæä¾›javaè¡¨è¾¾å¼è¯­è¨€</p>
</li>
<li><p>Jasperæ¨¡å—æä¾›JSPå¼•æ“</p>
</li>
<li><p>Namingæ¨¡å—æä¾›JNDIçš„æœåŠ¡</p>
</li>
<li><p>Juliæä¾›æœåŠ¡å™¨æ—¥å¿—çš„æœåŠ¡</p>
</li>
<li><p>tomcatæä¾›å¤–éƒ¨è°ƒç”¨çš„æ¥å£api</p>
</li>
</ul>
<h2 id="tomcatç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†"><a href="#tomcatç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†" class="headerlink" title="tomcatç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†"></a>tomcatç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†</h2><p>tomcatçš„æ¶æ„è®¾è®¡æ˜¯æ¸…æ™°çš„ã€æ¨¡å—åŒ–ã€å®ƒæ‹¥æœ‰å¾ˆå¤šç»„ä»¶ï¼ŒåŠ å…¥åœ¨å¯åŠ¨Tomcatæ—¶ä¸€ä¸ªä¸€ä¸ªç»„ä»¶å¯åŠ¨ï¼Œå¾ˆå®¹æ˜“é—æ¼ç»„ä»¶ï¼ŒåŒæ—¶è¿˜ä¼šå¯¹åé¢çš„åŠ¨æ€ç»„ä»¶æ‹“å±•å¸¦æ¥éº»çƒ¦ã€‚å¦‚æœé‡‡ç”¨æˆ‘ä»¬ä¼ ç»Ÿçš„æ–¹å¼çš„è¯ï¼Œç»„ä»¶åœ¨å¯åŠ¨è¿‡ç¨‹ä¸­å¦‚æœå‘ç”Ÿå¼‚å¸¸ï¼Œä¼šå¾ˆéš¾ç®¡ç†ï¼Œæ¯”å¦‚ä½ çš„ä¸‹ä¸€ä¸ªç»„ä»¶è°ƒç”¨äº†start()æ–¹æ³•ï¼Œä½†æ˜¯å¦‚æœå®ƒçš„ä¸Šçº§ç»„ä»¶è¿˜æ²¡æœ‰start()ç”šè‡³è¿˜æ²¡æœ‰init()çš„è¯ï¼ŒTomcatçš„å¯åŠ¨ä¼šéå¸¸éš¾ç®¡ç†ï¼Œå› æ­¤ï¼ŒTomcatçš„è®¾è®¡è€…æå‡ºä¸€ä¸ªè§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ç”Ÿå‘½å‘¨æœŸç»Ÿä¸€æ¥å£Lifecycleå®šä¹‰ä¸€äº›çŠ¶æ€å¸¸é‡ï¼Œç„¶åå°†å¯åŠ¨ã€åœæ­¢ã€å…³é—­åŠæ‰€æœ‰ä¸ç”Ÿå‘½å‘¨æœŸç›¸å…³çš„æ–¹æ³•éƒ½ç»„ç»‡åˆ°ä¸€èµ·ï¼Œè¿™æ ·å°±å¯ä»¥å¾ˆæ–¹ä¾¿ç®¡ç†tomcatå„ä¸ªå®¹å™¨ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸã€‚</p>
<p>LifecycleBaseå®ç°äº†Lifecycleæ¥å£ï¼Œåœ¨init()æ–¹æ³•ä¸­åˆå§‹åŒ–ä¹‹å‰ä¼šè¿›è¡ŒçŠ¶æ€æ£€æŸ¥ï¼š</p>
<pre><code class="java">@Override
public final synchronized void init() throws LifecycleException {
    //é˜²æ­¢ç»„ä»¶å¯åŠ¨æ—¶çŠ¶æ€ä¸å¯¹
    if (!state.equals(LifecycleState.NEW)) {
        invalidTransition(Lifecycle.BEFORE_INIT_EVENT);
    }

    try {
        //è®¾ç½®åˆå§‹åŒ–çŠ¶æ€
        setStateInternal(LifecycleState.INITIALIZING, null, false);
        initInternal();
        //è®¾ç½®åˆå§‹åŒ–å®Œæˆ
        setStateInternal(LifecycleState.INITIALIZED, null, false);
    } catch (Throwable t) {
        handleSubClassException(t, &quot;lifecycleBase.initFail&quot;, toString());
    }
}</code></pre>
<p>init()æ–¹æ³•ä¸­ä¼šè°ƒç”¨å­ç±»çš„initInternal()æ–¹æ³•ï¼Œè¿™é‡Œä½¿ç”¨äº†æ¨¡ç‰ˆæ–¹æ³•è®¾è®¡æ¨¡å¼ï¼ŒLifecycleBaseä¸ºéª¨æ¶ç±»ï¼ŒinitInternal()çš„å…·ä½“å®ç°åœ¨å­ç±»ä¸­ï¼Œspringä¸­ä¹Ÿä½¿ç”¨äº†è¿™ç§è®¾è®¡æ¨¡å¼ã€‚</p>
<p>start()æ–¹æ³•ä¸­åŒæ ·ä¼šè¿›è¡Œç›¸åº”çš„åˆ¤æ–­ã€‚</p>
<pre><code class="java">@Override
public final synchronized void start() throws LifecycleException {
    // ç»Ÿä¸€è¿›è¡Œç”Ÿå‘½å‘¨æœŸçš„ç®¡ç†
    if (LifecycleState.STARTING_PREP.equals(state) || LifecycleState.STARTING.equals(state) ||
            LifecycleState.STARTED.equals(state)) {
        if (log.isDebugEnabled()) {
            Exception e = new LifecycleException();
            log.debug(sm.getString(&quot;lifecycleBase.alreadyStarted&quot;, toString()), e);
        } else if (log.isInfoEnabled()) {
            log.info(sm.getString(&quot;lifecycleBase.alreadyStarted&quot;, toString()));
        }
        return;
    }
    // æ£€æŸ¥ç»„ä»¶ç”Ÿå‘½å‘¨æœŸçŠ¶æ€
    if (state.equals(LifecycleState.NEW)) {
        init();
    } else if (state.equals(LifecycleState.FAILED)) {
        stop();
    } else if (!state.equals(LifecycleState.INITIALIZED) &amp;&amp;
            !state.equals(LifecycleState.STOPPED)) {
        invalidTransition(Lifecycle.BEFORE_START_EVENT);
    }

    try {
        // è®¾ç½®ç»„ä»¶çŠ¶æ€
        setStateInternal(LifecycleState.STARTING_PREP, null, false);
        // è°ƒç”¨å…·ä½“å®ç°ç±»çš„æ–¹æ³•
        startInternal();
        // ç»Ÿä¸€è¿›è¡Œç”Ÿå‘½å‘¨æœŸçš„ç®¡ç†
        if (state.equals(LifecycleState.FAILED)) {
            // å¤±è´¥ï¼Œè°ƒç”¨stop()æ–¹æ³•å®Œæˆæ¸…ç†
            stop();
        } else if (!state.equals(LifecycleState.STARTING)) {
            // ä¸æ˜¯å·²ç»åœ¨å¯åŠ¨çš„çŠ¶æ€
            invalidTransition(Lifecycle.AFTER_START_EVENT);
        } else {
            // è®¾ç½®ç»„ä»¶çŠ¶æ€
            setStateInternal(LifecycleState.STARTED, null, false);
        }
    } catch (Throwable t) {
        // This is an &#39;uncontrolled&#39; failure so put the component into the
        // FAILED state and throw an exception.
        handleSubClassException(t, &quot;lifecycleBase.startFail&quot;, toString());
    }
}</code></pre>
<p>tomcatå†…éƒ¨æ¶æ„ä¸­å„ä¸ªæ ¸å¿ƒç»„ä»¶æœ‰åŒ…å«ä¸è¢«åŒ…å«å…³ç³»ï¼Œä¾‹å¦‚ï¼šServeråŒ…å«äº†Serviceï¼ŒServiceåˆåŒ…å«äº†Containerå’ŒConnectorï¼Œè¿™ä¸ªç»“æ„æœ‰ä¸€ç‚¹åƒæ•°æ®ç»“æ„ä¸­çš„æ ‘ï¼Œæ ‘çš„æ ¹ç»“ç‚¹æ²¡æœ‰çˆ¶èŠ‚ç‚¹ï¼Œå…¶ä»–èŠ‚ç‚¹æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªçˆ¶èŠ‚ç‚¹ï¼Œæ¯ä¸€ä¸ªçˆ¶èŠ‚ç‚¹æœ‰0è‡³å¤šä¸ªå­èŠ‚ç‚¹ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡çˆ¶å®¹å™¨å¯åŠ¨å®ƒçš„å­å®¹å™¨ï¼Œè¿™æ ·åªè¦å¯åŠ¨æ ¹å®¹å™¨ï¼Œå°±å¯ä»¥æŠŠå…¶ä»–æ‰€æœ‰çš„å®¹å™¨éƒ½å¯åŠ¨ï¼Œä»è€Œè¾¾åˆ°äº†ç»Ÿä¸€çš„å¯åŠ¨ï¼Œåœæ­¢ã€å…³é—­çš„æ•ˆæœã€‚</p>
<h2 id="tomcatç»„ä»¶åˆ†æ"><a href="#tomcatç»„ä»¶åˆ†æ" class="headerlink" title="tomcatç»„ä»¶åˆ†æ"></a>tomcatç»„ä»¶åˆ†æ</h2><h3 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h3><p>ç»§æ‰¿ç»“æ„ï¼š</p>
<img src="/2020/04/30/tomcat%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/pic6.png" srcset="/img/loading.gif" class>

<p>Serveræ˜¯tomcatæœ€é¡¶å±‚çš„å®¹å™¨ï¼Œä»£è¡¨æ•´ä¸ªæœåŠ¡å™¨ï¼ŒTomcatä¸­çš„æ ‡å‡†å®ç°ä¸ºStandardServerç±»ã€‚</p>
<h3 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h3><p>ç»§æ‰¿ç»“æ„ï¼š</p>
<img src="/2020/04/30/tomcat%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/pic7.png" srcset="/img/loading.gif" class>

<p>å…¶ä¸­LifecycleMBeanBaseç”¨äºç›‘ç£å¯¹è±¡çŠ¶æ€ã€‚</p>
<p>Serviceä¸­è¯·æ±‚ç›‘å¬å’Œè¯·æ±‚å¤„ç†åˆ†å¼€ä¸ºä¸¤ä¸ªæ¨¡å—ï¼š</p>
<img src="/2020/04/30/tomcat%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/pic8.png" srcset="/img/loading.gif" class>

<p>Connectorè´Ÿè´£è¯·æ±‚ç›‘å¬ï¼ŒContainerè´Ÿè´£è¯·æ±‚å¤„ç†ï¼Œä¸€ä¸ªServiceå¯ä»¥æœ‰å¤šä¸ªConnectorï¼Œä½†åªèƒ½æœ‰ä¸€ä¸ªContainerã€‚</p>
<h3 id="Connector"><a href="#Connector" class="headerlink" title="Connector"></a>Connector</h3><img src="/2020/04/30/tomcat%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/pic8.png" srcset="/img/loading.gif" class>

<p>Connectorä½¿ç”¨ProtocolHandleræ¥å¤„ç†è¯·æ±‚ï¼ŒProtocolHandleråŒ…å«ä¸‰ä¸ªéƒ¨ä»¶ï¼š</p>
<ul>
<li>Endpointï¼šç”¨æ¥å¤„ç†åº•å±‚çš„Scoketçš„ç½‘ç»œè¿æ¥ã€‚</li>
<li>Processorï¼šç”¨äºå°†Endpointæ¥æ”¶åˆ°çš„Socketå°è£…ä¸ºRequest</li>
<li>Adapterï¼šä½œä¸ºé€‚é…å™¨å°†Reqeustå°†ä¸ºServletRequestäº¤ç»™Containerè¿›è¡Œå…·ä½“çš„å¤„ç†ã€‚</li>
</ul>
<h3 id="Container"><a href="#Container" class="headerlink" title="Container"></a>Container</h3><img src="/2020/04/30/tomcat%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/pic9.png" srcset="/img/loading.gif" class>

<ul>
<li>Engineï¼šå¼•æ“ï¼Œåœ¨servler.xmlä¸­å®šä¹‰äº†ä¸€ä¸ªåä¸ºCatalinaçš„Englineï¼Œåªèƒ½æœ‰ä¸€ä¸ªã€‚</li>
<li>Hostï¼šç«™ç‚¹ã€è™šæ‹Ÿä¸»æœºï¼Œä¸€ä¸ªEnglineåŒ…å«å¤šä¸ªHostçš„è®¾è®¡ï¼Œä½¿å¾—ä¸€ä¸ªæœåŠ¡å™¨å®ä¾‹å¯ä»¥æ‰¿æ‹…å¤šä¸ªåŸŸåçš„æœåŠ¡ï¼Œæ˜¯å¾ˆçµæ´»çš„è®¾è®¡</li>
<li>Contextï¼šåº”ç”¨ï¼Œé»˜è®¤é…ç½®ä¸‹webappsä¸‹çš„æ¯ä¸ªç›®å½•éƒ½æ˜¯ä¸€ä¸ªåº”ç”¨ã€‚</li>
<li>Wrapperï¼šä¸€ä¸ªServletã€‚</li>
</ul>
<h2 id="tomcatå¯åŠ¨æµç¨‹"><a href="#tomcatå¯åŠ¨æµç¨‹" class="headerlink" title="tomcatå¯åŠ¨æµç¨‹"></a>tomcatå¯åŠ¨æµç¨‹</h2><p>tomcatç»„ä»¶çš„å¯åŠ¨æµç¨‹ï¼š</p>
<img src="/2020/04/30/tomcat%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/pic1.png" srcset="/img/loading.gif" class>

<h3 id="å…¥å£ç±»Bootstrap"><a href="#å…¥å£ç±»Bootstrap" class="headerlink" title="å…¥å£ç±»Bootstrap"></a>å…¥å£ç±»Bootstrap</h3><p>start.shä¼šæ‰§è¡Œcatalina.shï¼Œcatalina.shä¼šè°ƒç”¨Bootstrapç±»ä¸­çš„main()æ–¹æ³•ã€‚</p>
<pre><code class="java">public static void main(String args[]) {

    //åˆå§‹åŒ–é˜¶æ®µ init()æ–¹æ³•
    synchronized (daemonLock) {
        if (daemon == null) {
            // Don&#39;t set daemon until init() has completed
            Bootstrap bootstrap = new Bootstrap();
            try {
                bootstrap.init();
            } catch (Throwable t) {
                handleThrowable(t);
                t.printStackTrace();
                return;
            }
            daemon = bootstrap;
        } else {
            // When running as a service the call to stop will be on a new
            // thread so make sure the correct class loader is used to
            // prevent a range of class not found exceptions.
            Thread.currentThread().setContextClassLoader(daemon.catalinaLoader);
        }
    }

    //è¿è¡Œé˜¶æ®µ start()
    try {
        String command = &quot;start&quot;;
        if (args.length &gt; 0) {
            command = args[args.length - 1];
        }

        if (command.equals(&quot;startd&quot;)) {
            args[args.length - 1] = &quot;start&quot;;
            daemon.load(args);
            daemon.start();
        } else if (command.equals(&quot;stopd&quot;)) {
            args[args.length - 1] = &quot;stop&quot;;
            daemon.stop();
        } else if (command.equals(&quot;start&quot;)) {
            daemon.setAwait(true);
            daemon.load(args);
            daemon.start();
            if (null == daemon.getServer()) {
                System.exit(1);
            }
        } else if (command.equals(&quot;stop&quot;)) {
            daemon.stopServer(args);
        } else if (command.equals(&quot;configtest&quot;)) {
            daemon.load(args);
            if (null == daemon.getServer()) {
                System.exit(1);
            }
            System.exit(0);
        } else {
            log.warn(&quot;Bootstrap: command \&quot;&quot; + command + &quot;\&quot; does not exist.&quot;);
        }
    } catch (Throwable t) {
        // Unwrap the Exception for clearer error reporting
        if (t instanceof InvocationTargetException &amp;&amp;
                t.getCause() != null) {
            t = t.getCause();
        }
        handleThrowable(t);
        t.printStackTrace();
        System.exit(1);
    }
}</code></pre>
<p>main()æ–¹æ³•é¦–å…ˆä¼šè°ƒç”¨init()æ–¹æ³•åŠstart()æ–¹æ³•ï¼Œinit()æ–¹æ³•ä¸­ä¼šé€šè¿‡åå°„åŠ è½½Catalinaã€‚</p>
<pre><code class="java">public void init() throws Exception {

    //ç±»åŠ è½½å™¨åˆå§‹åŒ–
    initClassLoaders();

    //è®¾ç½®çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼Œæ¥è§£å†³æœ‰å¯èƒ½çš„ClassNotFoundExceptioné—®é¢˜
    Thread.currentThread().setContextClassLoader(catalinaLoader);

    SecurityClassLoad.securityClassLoad(catalinaLoader);

    // åŠ è½½å¯åŠ¨ç±»Catalinaå¹¶è°ƒç”¨å…¶process()æ–¹æ³•
    if (log.isDebugEnabled())
        log.debug(&quot;Loading startup class&quot;);
    Class&lt;?&gt; startupClass = catalinaLoader.loadClass(&quot;org.apache.catalina.startup.Catalina&quot;);
    Object startupInstance = startupClass.getConstructor().newInstance();

    // è®¾ç½®å…±äº«ç±»åŠ è½½å™¨sharedLoader
    if (log.isDebugEnabled())
        log.debug(&quot;Setting startup class properties&quot;);
    String methodName = &quot;setParentClassLoader&quot;;
    Class&lt;?&gt; paramTypes[] = new Class[1];
    paramTypes[0] = Class.forName(&quot;java.lang.ClassLoader&quot;);
    Object paramValues[] = new Object[1];
    // æŠŠsharedåŠ è½½å™¨ä¼ é€’ç»™catalina
    paramValues[0] = sharedLoader;
    Method method =
        startupInstance.getClass().getMethod(methodName, paramTypes);
    method.invoke(startupInstance, paramValues);

    catalinaDaemon = startupInstance;
}</code></pre>
<p>start()æ–¹æ³•ä¸­ä¼šé€šè¿‡åå°„è°ƒç”¨Catalinaçš„startæ–¹æ³•ã€‚</p>
<pre><code class="java">public void start() throws Exception {
    if (catalinaDaemon == null) {
        init();
    }

    Method method = catalinaDaemon.getClass().getMethod(&quot;start&quot;, (Class [])null);
    method.invoke(catalinaDaemon, (Object [])null);
}</code></pre>
<h3 id="Catalina"><a href="#Catalina" class="headerlink" title="Catalina"></a>Catalina</h3><p>Bootstrapçš„init()æ–¹æ³•ä¼šè°ƒç”¨åˆ°Catalinaçš„load()æ–¹æ³•ï¼Œload()æ–¹æ³•ä¸­ä¼šé€šè¿‡æ–‡ä»¶æµçš„æ–¹å¼åŠ è½½å„ç§æ–‡ä»¶åŠé…ç½®ä¿¡æ¯ï¼Œæœ€åè°ƒç”¨Serverçš„init()æ–¹æ³•ï¼ŒåŒæ ·çš„ï¼Œstart()æ–¹æ³•ä¸­ä¼šè°ƒç”¨Servlerçš„start()æ–¹æ³•ï¼Œè¿™é‡Œä¸åœ¨è¿›è¡Œè¯¦ç»†åˆ†æã€‚</p>
<h3 id="Server-1"><a href="#Server-1" class="headerlink" title="Server"></a>Server</h3><p>è¿™é‡Œä½¿ç”¨äº†æ¨¡ç‰ˆæ–¹æ³•è®¾è®¡æ¨¡å¼ï¼Œstart()æ–¹æ³•å°†è°ƒç”¨å­ç±»ä¸­çš„startInternal()æ–¹æ³•ã€‚StandardServerä¸­çš„startInternal()æ–¹æ³•ä¼šå¾ªç¯è°ƒç”¨æ‰€æœ‰çš„Serviceçš„start()æ–¹æ³•ï¼ŒåŒæ ·çš„initInternal()æ–¹æ³•ä¸­ä¹Ÿä¼šè°ƒç”¨æ‰€æœ‰Serviceçš„init()æ–¹æ³•ã€‚</p>
<pre><code class="java">protected void startInternal() throws LifecycleException {

    fireLifecycleEvent(CONFIGURE_START_EVENT, null);
    setState(LifecycleState.STARTING);

    globalNamingResources.start();

    // Start our defined Services
    synchronized (servicesLock) {
        for (int i = 0; i &lt; services.length; i++) {
            services[i].start();
        }
    }
}</code></pre>
<h3 id="Service-1"><a href="#Service-1" class="headerlink" title="Service"></a>Service</h3><p>StandardServiceä¸­çš„startInternal()æ–¹æ³•ï¼Œè¯¥æ–¹æ³•é¦–å…ˆä¼šå¯åŠ¨å®¹å™¨ï¼Œç„¶åå¯åŠ¨çº¿ç¨‹æ‰§è¡Œå™¨ï¼Œè‡ªå®šä¹‰è¿æ¥å™¨ã€‚</p>
<pre><code class="java">    @Override
    protected void startInternal() throws LifecycleException {

        if(log.isInfoEnabled())
            log.info(sm.getString(&quot;standardService.start.name&quot;, this.name));
        setState(LifecycleState.STARTING);

        // é¦–å…ˆå¯åŠ¨çš„æ˜¯å®¹å™¨
        if (engine != null) {
            synchronized (engine) {
                engine.start();
            }
        }
        // çº¿ç¨‹æ‰§è¡Œå™¨
        synchronized (executors) {
            for (Executor executor: executors) {
                executor.start();
            }
        }

        mapperListener.start();

        // å¯åŠ¨è‡ªå®šä¹‰çš„è¿æ¥å™¨
        synchronized (connectorsLock) {
            for (Connector connector: connectors) {
                try {
                    // If it has already failed, don&#39;t try and start it
                    if (connector.getState() != LifecycleState.FAILED) {
                        connector.start();
                    }
                } catch (Exception e) {
                    log.error(sm.getString(
                            &quot;standardService.connector.startFailed&quot;,
                            connector), e);
                }
            }
        }
    }</code></pre>
<h2 id="tomcatçš„è¯·æ±‚å¤„ç†è¿‡ç¨‹"><a href="#tomcatçš„è¯·æ±‚å¤„ç†è¿‡ç¨‹" class="headerlink" title="tomcatçš„è¯·æ±‚å¤„ç†è¿‡ç¨‹"></a>tomcatçš„è¯·æ±‚å¤„ç†è¿‡ç¨‹</h2><ol>
<li>ç”¨æˆ·ç‚¹å‡»ç½‘é¡µå†…å®¹ï¼Œè¯·æ±‚è¢«å‘é€åˆ°æœ¬æœºç«¯å£8080ï¼Œè¢«åœ¨é‚£é‡Œç›‘å¬çš„Coyote HTTP/1.1 Connectorè·å¾—ã€‚</li>
<li>ConnectoræŠŠè¯¥è¯·æ±‚äº¤ç»™å®ƒæ‰€åœ¨çš„Serviceçš„Engineæ¥å¤„ç†ï¼Œå¹¶ç­‰å¾…Engineçš„å›åº”ã€‚</li>
<li>Engineè·å¾—è¯·æ±‚localhost/test/index.jspï¼ŒåŒ¹é…æ‰€æœ‰çš„è™šæ‹Ÿä¸»æœºHostã€‚</li>
<li>EngineåŒ¹é…åˆ°åä¸ºlocalhostçš„Hostï¼ˆå³ä½¿åŒ¹é…ä¸åˆ°ä¹ŸæŠŠè¯·æ±‚äº¤ç»™è¯¥Hostå¤„ç†ï¼Œå› ä¸ºè¯¥Hostè¢«å®šä¹‰ä¸ºè¯¥Engineçš„é»˜è®¤ä¸»æœºï¼‰ï¼Œåä¸ºlocalhostçš„Hostè·å¾—è¯·æ±‚/test/index.jspï¼ŒåŒ¹é…å®ƒæ‰€æ‹¥æœ‰çš„æ‰€æœ‰çš„Contextã€‚HoståŒ¹é…åˆ°è·¯å¾„ä¸º/testçš„Contextï¼ˆå¦‚æœåŒ¹é…ä¸åˆ°å°±æŠŠè¯¥è¯·æ±‚äº¤ç»™è·¯å¾„åä¸ºâ€œ â€çš„Contextå»å¤„ç†ï¼‰ã€‚</li>
<li>path=â€œ/testâ€çš„Contextè·å¾—è¯·æ±‚/index.jspï¼Œåœ¨å®ƒçš„mapping tableä¸­å¯»æ‰¾å‡ºå¯¹åº”çš„Servletã€‚ContextåŒ¹é…åˆ°URL PATTERNä¸º*.jspçš„Servlet,å¯¹åº”äºJspServletç±»ã€‚</li>
<li>æ„é€ HttpServletRequestå¯¹è±¡å’ŒHttpServletResponseå¯¹è±¡ï¼Œä½œä¸ºå‚æ•°è°ƒç”¨JspServletçš„doGet()æˆ–doPost()ã€‚æ‰§è¡Œä¸šåŠ¡é€»è¾‘ã€æ•°æ®å­˜å‚¨ç­‰ç¨‹åºã€‚</li>
<li>ContextæŠŠæ‰§è¡Œå®Œä¹‹åçš„HttpServletResponseå¯¹è±¡è¿”å›ç»™Hostã€‚</li>
<li>HostæŠŠHttpServletResponseå¯¹è±¡è¿”å›ç»™Engineã€‚</li>
<li>EngineæŠŠHttpServletResponseå¯¹è±¡è¿”å›Connectorã€‚</li>
<li>ConnectoræŠŠHttpServletResponseå¯¹è±¡è¿”å›ç»™å®¢æˆ·Browserã€‚</li>
</ol>
<h2 id="ç®¡é“æ¨¡å¼"><a href="#ç®¡é“æ¨¡å¼" class="headerlink" title="ç®¡é“æ¨¡å¼"></a>ç®¡é“æ¨¡å¼</h2><h3 id="ç®¡é“ä¸é˜€é—¨"><a href="#ç®¡é“ä¸é˜€é—¨" class="headerlink" title="ç®¡é“ä¸é˜€é—¨"></a>ç®¡é“ä¸é˜€é—¨</h3><p>åœ¨ä¸€ä¸ªæ¯”è¾ƒå¤æ‚çš„å¤§å‹ç³»ç»Ÿä¸­ï¼Œå¦‚æœä¸€ä¸ªå¯¹è±¡æˆ–æ•°æ®æµéœ€è¦è¿›è¡Œç¹æ‚çš„é€»è¾‘å¤„ç†ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©åœ¨ä¸€ä¸ªå¤§çš„ç»„ä»¶ä¸­ç›´æ¥å¤„ç†è¿™äº›ç¹æ‚çš„é€»è¾‘å¤„ç†ï¼Œè¿™ä¸ªæ–¹å¼è™½ç„¶è¾¾åˆ°ç›®çš„ï¼Œä½†æ˜¯æ‹“å±•æ€§å’Œå¯é‡ç”¨æ€§å·®ã€‚å› ä¸ºç‰µä¸€å‘è€ŒåŠ¨å…¨èº«ã€‚</p>
<p>ç®¡é“æ˜¯å°±åƒä¸€æ¡ç®¡é“æŠŠå¤šä¸ªå¯¹è±¡è¿æ¥èµ·æ¥ï¼Œæ•´ä½“çœ‹èµ·æ¥å°±åƒè‹¥å¹²ä¸ªé˜€é—¨åµŒå¥—åœ¨ç®¡é“ä¸­ï¼Œè€Œå¤„ç†é€»è¾‘æ”¾åœ¨é˜€é—¨ä¸Šã€‚å®ƒçš„ç»“æ„å’Œå®ç°æ˜¯éå¸¸å€¼å¾—æˆ‘ä»¬å­¦ä¹ å’Œå€Ÿé‰´çš„ã€‚</p>
<h3 id="ç®¡é“çš„å®ç°"><a href="#ç®¡é“çš„å®ç°" class="headerlink" title="ç®¡é“çš„å®ç°"></a>ç®¡é“çš„å®ç°</h3><p>é¦–å…ˆéœ€è¦å®šä¹‰é˜€é—¨æ¥å£ï¼Œé˜€é—¨æ¥å£ä¸­åŒ…å«ä¸‹ä¸€ä¸ªé˜€é—¨çš„å¼•ç”¨ï¼Œæ¯ä¸ªé˜€é—¨å®Œæˆè‡ªå·±çš„é€»è¾‘åå°†è°ƒç”¨ä¸‹ä¸€ä¸ªé˜€é—¨çš„æ–¹æ³•ï¼Œç›´åˆ°åŸºç¡€é˜€é—¨ï¼ŒåŸºç¡€é˜€é—¨çš„æ–¹æ³•ä¸­ä¸å†å¯¹ä¸‹ä¸€ä¸ªé˜€é—¨è¿›è¡Œè°ƒç”¨ã€‚ç®¡é“æ¥å£ä¸­ä¿å­˜æœ‰ç¬¬ä¸€ä¸ªé˜€é—¨åŠåŸºç¡€é˜€é—¨çš„å¼•ç”¨ï¼ŒåŸºç¡€é˜€é—¨çš„å°†ä½œä¸ºé˜€é—¨æ·»åŠ æ—¶çš„é¡ºåºæ¯”è¾ƒï¼Œç¬¬ä¸€ä¸ªé˜€é—¨å°†ç”¨äºç®¡é“è°ƒç”¨çš„å¼€å§‹ï¼Œç®¡é“è°ƒç”¨å¼€å§‹äºç¬¬ä¸€ä¸ªç®¡é“ï¼Œç»ˆæ­¢äºåŸºç¡€ç®¡é“ã€‚</p>
<p>ç®¡é“æ¥å£ï¼š</p>
<pre><code class="java">public interface Pipeline {
    //è·å–ç¬¬ä¸€ä¸ªé˜€é—¨
    public Valve getFirst();
    public Valve getBasic();
    //è®¾ç½®é˜€é—¨
    public void setBasic(Valve valve);
    //æ·»åŠ é˜€é—¨
    public void addVave(Valve valve);
}</code></pre>
<p>é˜€é—¨æ¥å£</p>
<pre><code class="java">public interface Valve {
    public Valve getNext();
    public void setNext(Valve valve);
    public void invoke(String handing);
}</code></pre>
<p>ç®¡é“æ¥å£çš„å®ç°ï¼š</p>
<pre><code class="java">public class StandardPipeline implements  Pipeline {
    //é˜€é—¨ï¼ˆéåŸºç¡€ï¼Œå®šä¹‰ä¸€ä¸ªfirstï¼‰
    protected Valve first = null;
    //åŸºç¡€é˜€é—¨
    protected Valve basic = null;

    @Override
    public Valve getBasic() {
        return basic;
    }

    @Override
    public void setBasic(Valve valve) {
        this.basic=valve;
    }

    @Override
    public Valve getFirst() {
        return first;
    }

    //æ·»åŠ é˜€é—¨ï¼Œé“¾å¼æ„å»ºé˜€é—¨çš„æ‰§è¡Œé¡ºåºï¼ˆå…ˆå®šåˆ¶ã€æœ€ååŸºç¡€é˜€é—¨ï¼‰
    @Override
    public void addVave(Valve valve) {
        if(first == null){
            first = valve;
            valve.setNext(basic);
        }else{
            Valve current =first;
            while(current !=null){
                if(current.getNext() == basic){
                    current.setNext(valve);
                    valve.setNext(basic);
                }
                current = current.getNext();
            }
        }
    }
}</code></pre>
<p>åŸºç¡€é˜€é—¨</p>
<pre><code class="java">public class StandardValve implements Valve {
    protected  Valve next =null;
    @Override
    public Valve getNext() {
        return next;
    }

    @Override
    public void setNext(Valve valve) {
        this.next =valve;
    }

    @Override
    public void invoke(String request) {
        System.out.println(&quot;åŸºç¡€é˜€é—¨å¤„ç†&quot;);
    }
}</code></pre>
<p>ç¬¬ä¸€ä¸ªé˜€é—¨</p>
<pre><code class="java">public class FirstValve implements Valve {
    protected  Valve next =null;
    @Override
    public Valve getNext() {
        return next;
    }

    @Override
    public void setNext(Valve valve) {
        this.next =valve;
    }

    @Override
    public void invoke(String request) {
        System.out.println(&quot;é˜€é—¨1å¤„ç†&quot;);
        getNext().invoke(request);
    }
}</code></pre>
<p>ç¬¬äºŒä¸ªé˜€é—¨</p>
<pre><code class="java">public class SecondValve implements Valve {
    protected  Valve next =null;
    @Override
    public Valve getNext() {
        return next;
    }

    @Override
    public void setNext(Valve valve) {
        this.next =valve;
    }

    @Override
    public void invoke(String request) {
        System.out.println(&quot;é˜€é—¨2å¤„ç†&quot;);
        getNext().invoke(request);
    }
}</code></pre>
<p>æµ‹è¯•ç±»</p>
<pre><code class="java">public class Demo {
    public static void main(String[] args) {
        String request =&quot;è¿™ä¸ªæ˜¯ä¸€ä¸ªServletè¯·æ±‚&quot;;
        //newå‡ºä¸€ä¸ªç®¡é“
        StandardPipeline pipeline = new StandardPipeline();
        //ä¸‰ä¸ªé˜€é—¨(ä¸€ä¸ªåŸºç¡€ã€2ä¸ªå®šåˆ¶)
        StandardValve standardValve = new StandardValve();
        FirstValve firstValve = new FirstValve();
        SecondValve secondValve = new SecondValve();
        //è®¾ç½®åŸºç¡€é˜€é—¨(å®šåˆ¶é˜€é—¨)
        pipeline.setBasic(standardValve);
        //è®¾ç½®éåŸºç¡€é˜€é—¨
        pipeline.addVave(firstValve);
        pipeline.addVave(secondValve);
        //è°ƒç”¨å¯¹è±¡ç®¡é“ä¸­çš„ç¬¬ä¸€ä¸ªé˜€é—¨
        pipeline.getFirst().invoke(request);
    }
}</code></pre>
<h2 id="tomcatä¸­çš„ç®¡é“"><a href="#tomcatä¸­çš„ç®¡é“" class="headerlink" title="tomcatä¸­çš„ç®¡é“"></a>tomcatä¸­çš„ç®¡é“</h2><img src="/2020/04/30/tomcat%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/pic3.png" srcset="/img/loading.gif" class>

<p>å…¶ä¸­çš„Engineã€Hostã€Contextã€warpperåˆ†åˆ«å¯¹åº”StandardEngineValveã€StandardHostValveã€StandardContextValveã€StandardWrapperValveå››ç§é˜€é—¨ã€‚</p>
<h3 id="ç®¡é“å¤„ç†æµç¨‹"><a href="#ç®¡é“å¤„ç†æµç¨‹" class="headerlink" title="ç®¡é“å¤„ç†æµç¨‹"></a>ç®¡é“å¤„ç†æµç¨‹</h3><img src="/2020/04/30/tomcat%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/pic4.png" srcset="/img/loading.gif" class>

<p>æ¥æ”¶åˆ°è¯·æ±‚ååœ¨CoyoteAdapterçš„service()æ–¹æ³•ä¸­çš„<code>connector.getContainer().getPipeline().getFirst().invoke(request, response);</code>å°†è·å–ç®¡é“å¹¶å¼€å§‹é˜€é—¨çš„è°ƒç”¨è¿‡ç¨‹å¯¹reqeustã€responseè¿›è¡Œå¤„ç†ã€‚</p>
<p>StandardEngineValueç±»ä¸­çš„invoke()æ–¹æ³•ã€‚</p>
<pre><code class="java">@Override
public final void invoke(Request request, Response response)
    throws IOException, ServletException {

    // æ‹¿åˆ°Englineä¸­åŒ…å«çš„host
    Host host = request.getHost();
    if (host == null) {
        response.sendError
            (HttpServletResponse.SC_BAD_REQUEST,
             sm.getString(&quot;standardEngine.noHost&quot;,
                          request.getServerName()));
        return;
    }
    if (request.isAsyncSupported()) {
        request.setAsyncSupported(host.getPipeline().isAsyncSupported());
    }

    // å°†requestï¼Œresponseäº¤ç»™ä¸‹ä¸€ä¸ªé˜€é—¨
    host.getPipeline().getFirst().invoke(request, response);

}</code></pre>
<p>tomcatçš„Pipelineå¤„ç†æ˜¯è¿™æ ·çš„ï¼š</p>
<ol>
<li><p>åœ¨ç”Ÿäº§çº¿ä¸Šçš„ç¬¬ä¸€ä¸ªå·¥äººæ‹¿åˆ°ç”Ÿäº§åŸæ–™åï¼ŒäºŒè¯ä¸è¯´å°±äººç»™ä¸‹ä¸€ä¸ªå·¥äººï¼Œä¸‹ä¸€ä¸ªå·¥äººä¹Ÿæ˜¯ä¸€æ ·ç›´æ¥æ‰”ç»™ä¸‹ä¸€ä¸ªå·¥äººï¼Œç›´åˆ°æœ€åä¸€ä¸ªå·¥äººï¼Œè€Œæœ€åä¸€ä¸ªå·¥äººè¢«å®‰æ’ä¸ºä¸Šé¢æè¿‡çš„StandardValveï¼Œä»–è¦å®Œæˆçš„æ˜¯æŠŠç”Ÿäº§èµ„æ–™è¿ç»™è‡ªå·±æ‰€åœ¨åŒ…å«çš„containerçš„Pipelineä¸Šå»ã€‚â€¨</p>
</li>
<li><p>å››ä¸ªcontainerå°±ç›¸å½“äºæœ‰å››ä¸ªç”Ÿäº§çº¿ï¼ˆPipelineï¼‰ï¼Œå½“StandardWrapperValveæ‹¿åˆ°èµ„æºå¼€å§‹è°ƒç”¨servletï¼Œè¿”å›åï¼Œå†ä¸€æ­¥ä¸€æ­¥æŒ‰ç…§åˆšæ‰ä¸¢ç”Ÿäº§åŸæ–™æ˜¯çš„é¡ºåºçš„å€’åºä¸€æ¬¡æ‰§è¡Œã€‚</p>
</li>
</ol>
<h3 id="è‡ªå®šä¹‰tomcaté˜€é—¨"><a href="#è‡ªå®šä¹‰tomcaté˜€é—¨" class="headerlink" title="è‡ªå®šä¹‰tomcaté˜€é—¨"></a>è‡ªå®šä¹‰tomcaté˜€é—¨</h3><p>ç®¡é“æœºåˆ¶ç»™æˆ‘ä»¬å¸¦æ¥äº†æ›´å¥½çš„æ‹“å±•æ€§ï¼Œä¾‹å¦‚ï¼Œä½ è¦æ·»åŠ ä¸€ä¸ªé¢å¤–çš„é€»è¾‘å¤„ç†é˜€é—¨æ˜¯å¾ˆå®¹æ˜“çš„ã€‚è‡ªå®šä¹‰ä¸ªé˜€é—¨PrintIPValveï¼Œåªè¦ç»§æ‰¿ValveBaseå¹¶é‡å†™invokeæ–¹æ³•å³å¯ã€‚æ³¨æ„åœ¨invokeæ–¹æ³•ä¸­ä¸€å®šè¦æ‰§è¡Œè°ƒç”¨ä¸‹ä¸€ä¸ªé˜€é—¨çš„æ“ä½œï¼Œå¦åˆ™ä¼šå‡ºç°å¼‚å¸¸ã€‚</p>
<pre><code class="java">public class PrintIPValve extends ValveBase{
    @Override
    public void invoke(Request request, Response response) throws IOException, ServletException {
        System.out.println(&quot;------è‡ªå®šä¹‰é˜€é—¨PrintIPValve:&quot;+request.getRemoteAddr());
        getNext().invoke(request,response);
    }
}</code></pre>
<p>é…ç½®Tomcatçš„æ ¸å¿ƒé…ç½®æ–‡ä»¶server.xml,è¿™é‡ŒæŠŠé˜€é—¨é…ç½®åˆ°Engineå®¹å™¨ä¸‹ï¼Œä½œç”¨èŒƒå›´å°±æ˜¯æ•´ä¸ªå¼•æ“ï¼Œä¹Ÿå¯ä»¥æ ¹æ®ä½œç”¨èŒƒå›´é…ç½®åœ¨Hostæˆ–è€…æ˜¯Contextä¸‹</p>
<pre><code>&lt;Valve className=&quot;org.apache.catalina.valves.PrintIPValve&quot; /&gt;</code></pre><p>æºç ä¸­å¯ä»¥ç›´æ¥ç”Ÿæ•ˆï¼Œä½†æ˜¯å¦‚æœæ˜¯è¿è¡Œç‰ˆæœ¬ï¼Œå¯ä»¥å°†è¿™ä¸ªç±»å¯¼å‡ºæˆä¸€ä¸ªJaråŒ…æ”¾å…¥Tomcat/libç›®å½•ä¸‹ï¼Œä¹Ÿå¯ä»¥ç›´æ¥å°†.classæ–‡ä»¶æ‰“åŒ…è¿›catalina.jaråŒ…ä¸­ã€‚</p>
<h3 id="tomcatä¸­æä¾›å¸¸ç”¨çš„é˜€é—¨"><a href="#tomcatä¸­æä¾›å¸¸ç”¨çš„é˜€é—¨" class="headerlink" title="tomcatä¸­æä¾›å¸¸ç”¨çš„é˜€é—¨"></a>tomcatä¸­æä¾›å¸¸ç”¨çš„é˜€é—¨</h3><p>AccessLogValveï¼šè¯·æ±‚è®¿é—®æ—¥å¿—é˜€é—¨ï¼Œé€šè¿‡æ­¤é˜€é—¨å¯ä»¥è®°å½•æ‰€æœ‰å®¢æˆ·ç«¯çš„è®¿é—®æ—¥å¿—ï¼ŒåŒ…æ‹¬è¿œç¨‹ä¸»æœºIPï¼Œè¿œç¨‹ä¸»æœºåï¼Œè¯·æ±‚æ–¹æ³•ï¼Œè¯·æ±‚åè®®ï¼Œä¼šè¯IDï¼Œè¯·æ±‚æ—¶é—´ï¼Œå¤„ç†æ—¶é•¿ï¼Œæ•°æ®åŒ…å¤§å°ç­‰ã€‚å®ƒæä¾›ä»»æ„å‚æ•°åŒ–çš„é…ç½®ï¼Œå¯ä»¥é€šè¿‡ä»»æ„ç»„åˆæ¥å®šåˆ¶è®¿é—®æ—¥å¿—çš„æ ¼å¼ã€‚</p>
<p>JDBCAccessLogValveï¼šåŒæ ·æ˜¯è®°å½•è®¿é—®æ—¥å¿—çš„é˜€é—¨ï¼Œä½†æ˜¯å®ƒæœ‰åŠ©äºå°†è®¿é—®æ—¥å¿—é€šè¿‡JDBCæŒä¹…åŒ–åˆ°æ•°æ®åº“ä¸­ã€‚</p>
<p>ErrorReportValveï¼šè¿™æ˜¯ä¸€ä¸ªè®²é”™è¯¯ä»¥HTMLæ ¼å¼è¾“å‡ºçš„é˜€é—¨ã€‚</p>
<p>PersistentValveï¼šè¿™æ˜¯å¯¹æ¯ä¸€ä¸ªè¯·æ±‚çš„ä¼šè¯å®ç°æŒä¹…åŒ–çš„é˜€é—¨ã€‚</p>
<p>RemoteAddrValveï¼šè®¿é—®æ§åˆ¶é˜€é—¨ã€‚å¯ä»¥é€šè¿‡é…ç½®å†³å®šå“ªäº›IPå¯ä»¥è®¿é—®WEBåº”ç”¨ã€‚</p>
<p>RemoteHostValveï¼šè®¿é—®æ§åˆ¶é˜€é—¨ï¼Œé€šè¿‡é…ç½®è§‰å¾—å“ªäº›ä¸»æœºåå¯ä»¥è®¿é—®WEBåº”ç”¨ã€‚</p>
<p>RemoteIpValveï¼šé’ˆå¯¹ä»£ç†æˆ–è€…è´Ÿè½½å‡è¡¡å¤„ç†çš„ä¸€ä¸ªé˜€é—¨ï¼Œä¸€èˆ¬ç»è¿‡ä»£ç†æˆ–è€…è´Ÿè½½å‡è¡¡è½¬å‘çš„è¯·æ±‚éƒ½å°†è‡ªå·±çš„IPæ·»åŠ åˆ°è¯·æ±‚å¤´â€X-Forwarded-Forâ€ä¸­ï¼Œæ­¤æ—¶ï¼Œé€šè¿‡é˜€é—¨å¯ä»¥è·å–è®¿é—®è€…çœŸå®çš„IPã€‚</p>
<p>SemaphoreValveï¼šè¿™ä¸ªæ˜¯ä¸€ä¸ªæ§åˆ¶å®¹å™¨å¹¶å‘è®¿é—®çš„é˜€é—¨ï¼Œå¯ä»¥ä½œç”¨åœ¨ä¸åŒå®¹å™¨ä¸Šã€‚</p>
<h2 id="JVMä¸­çš„ç±»åŠ è½½æœºåˆ¶"><a href="#JVMä¸­çš„ç±»åŠ è½½æœºåˆ¶" class="headerlink" title="JVMä¸­çš„ç±»åŠ è½½æœºåˆ¶"></a>JVMä¸­çš„ç±»åŠ è½½æœºåˆ¶</h2><p><strong>ç±»åŠ è½½ï¼š</strong>ä¸»è¦æ˜¯å°†.classæ–‡ä»¶ä¸­çš„äºŒè¿›åˆ¶å­—èŠ‚è¯»å…¥åˆ°JVMä¸­</p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å› ä¸ºè¿™ä¸ªå®šä¹‰ï¼Œæ‰€ä»¥å¹¶æ²¡æœ‰è§„å®šä¸€å®šæ˜¯è¦ç£ç›˜åŠ è½½æ–‡ä»¶ï¼Œå¯ä»¥é€šè¿‡ç½‘ç»œï¼Œå†…å­˜ä»€ä¹ˆçš„åŠ è½½ã€‚åªè¦æ˜¯äºŒè¿›åˆ¶æµå­—èŠ‚æ•°æ®ï¼ŒJVMå°±å¯ä»¥åŠ è½½ã€‚</p>
<p><strong>ç±»åŠ è½½è¿‡ç¨‹ï¼š</strong></p>
<ol>
<li><p>é€šè¿‡ç±»çš„å…¨é™å®šåè·å–è¯¥ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµï¼›</p>
</li>
<li><p>å°†å­—èŠ‚æµæ‰€ä»£è¡¨çš„é™æ€ç»“æ„è½¬åŒ–ä¸ºæ–¹æ³•åŒºçš„è¿è¡Œæ—¶æ•°æ®ç»“æ„</p>
</li>
<li><p>åœ¨å†…å­˜ä¸­ç”Ÿæˆä¸€ä¸ªè¯¥ç±»çš„java.lang.Classå¯¹è±¡ï¼Œä½œä¸ºæ–¹æ³•åŒºè¿™ä¸ªç±»çš„å„ç§æ•°æ®çš„è®¿é—®å…¥å£</p>
</li>
</ol>
<p><strong>ç±»åŠ è½½å™¨</strong>ï¼š</p>
<p>JVMè®¾è®¡è€…æŠŠâ€œç±»åŠ è½½â€è¿™ä¸ªåŠ¨ä½œæ”¾åˆ°javaè™šæ‹Ÿæœºå¤–éƒ¨å»å®ç°ï¼Œä»¥ä¾¿è®©åº”ç”¨ç¨‹åºå†³å®šå¦‚ä½•è·å–æ‰€éœ€è¦çš„ç±»ã€‚å®ç°è¿™ä¸ªåŠ¨ä½œçš„ä»£ç æ¨¡å—æˆä¸ºâ€œç±»åŠ è½½å™¨â€</p>
<p><strong>ç±»çš„å”¯ä¸€æ€§ï¼š</strong></p>
<p>å¯¹äºä»»ä½•ä¸€ä¸ªç±»ï¼Œéƒ½éœ€è¦ç”±åŠ è½½å®ƒçš„ç±»åŠ è½½å™¨å’Œè¿™ä¸ªç±»æ¥ç¡®å®šå…¶åœ¨JVMä¸­çš„å”¯ä¸€æ€§ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸¤ä¸ªç±»æ¥æºäºåŒä¸€ä¸ªClassæ–‡ä»¶ï¼Œå¹¶ä¸”è¢«åŒä¸€ä¸ªç±»åŠ è½½å™¨åŠ è½½ï¼Œè¿™ä¸¤ä¸ªç±»æ‰ç›¸ç­‰ã€‚</p>
<p>æ³¨æ„ï¼šè¿™é‡Œæ‰€è°“çš„â€œç›¸ç­‰â€ï¼Œä¸€èˆ¬ä½¿ç”¨instanceofå…³é”®å­—åšåˆ¤æ–­ã€‚</p>
<p><strong>åŒäº²å§”æ´¾æ¨¡å‹ï¼š</strong></p>
<ul>
<li><p><strong>å®šä¹‰ï¼š</strong>åŒäº²å§”æ´¾æ¨¡å‹çš„å·¥ä½œè¿‡ç¨‹ä¸ºï¼šå¦‚æœä¸€ä¸ªç±»åŠ è½½å™¨æ”¶åˆ°äº†ç±»è¯·æ±‚ï¼Œå®ƒé¦–å…ˆä¸ä¼šè‡ªå·±å»å°è¯•åŠ è½½è¿™ä¸ªç±»ï¼Œè€Œæ˜¯æŠŠè¿™ä¸ªè¯·æ±‚å§”æ´¾ç»™çˆ¶åŠ è½½å™¨å»å®Œæˆï¼Œæ¯ä¸€å±‚éƒ½æ˜¯å¦‚æ­¤ï¼Œå› æ­¤æ‰€æœ‰ç±»åŠ è½½çš„è¯·æ±‚éƒ½ä¼šä¼ åˆ°å¯åŠ¨ç±»åŠ è½½å™¨ï¼Œåªæœ‰å½“çˆ¶åŠ è½½å™¨æ— æ³•å®Œæˆè¯¥è¯·æ±‚æ—¶ï¼Œå­åŠ è½½å™¨æ‰å»è‡ªå·±åŠ è½½ã€‚</p>
</li>
<li><p><strong>å®ç°æ–¹å¼ï¼š</strong>è¯¥æ¨¡å‹è¦æ±‚é™¤äº†é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨å¤–ï¼Œå…¶ä½™çš„ç±»åŠ è½½å™¨éƒ½åº”å½“æœ‰è‡ªå·±çš„çˆ¶ç±»åŠ è½½å™¨ã€‚å­ç±»åŠ è½½å™¨ä¸æ˜¯ä»¥ç»§æ‰¿çš„å…³ç³»æ¥å®ç°ï¼Œè€Œæ˜¯é€šè¿‡ç»„åˆå…³ç³»æ¥å¤ç”¨çˆ¶åŠ è½½å™¨çš„ä»£ç ã€‚</p>
</li>
<li><p><strong>æ„ä¹‰ï¼š</strong>å¥½å¤„åŒäº²å§”æ´¾æ¨¡å‹çš„å¥½å¤„å°±æ˜¯javaç±»éšç€å®ƒçš„ç±»åŠ è½½å™¨ä¸€èµ·å…·å¤‡äº†ä¸€ç§å¸¦æœ‰ä¼˜å…ˆçº§çš„å±‚æ¬¡å…³ç³»ã€‚ä¾‹å¦‚ï¼šObject,æ— è®ºé‚£ä¸ªç±»åŠ è½½å™¨å»åŠ è½½è¯¥ç±»ï¼Œæœ€ç»ˆéƒ½æ˜¯ç”±å¯åŠ¨ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½çš„ï¼Œå› æ­¤Objectç±»åœ¨ç¨‹åºçš„å„ç§ç±»åŠ è½½ç¯å¢ƒä¸­éƒ½æ˜¯ä¸€ä¸ªç±»ã€‚å¦‚æœä¸ç”¨æ”¹æ¨¡å‹ï¼Œé‚£ä¹ˆjava.lang.Objectç±»å­˜æ”¾åœ¨classpathä¸­ï¼Œé‚£ä¹ˆç³»ç»Ÿä¸­å°±ä¼šå‡ºç°å¤šä¸ªObjectç±»ï¼Œç¨‹åºå˜å¾—å¾ˆæ··ä¹±ã€‚</p>
</li>
</ul>
<h5 id="ç±»åŠ è½½å™¨çš„åˆ†ç±»ï¼š"><a href="#ç±»åŠ è½½å™¨çš„åˆ†ç±»ï¼š" class="headerlink" title="ç±»åŠ è½½å™¨çš„åˆ†ç±»ï¼š"></a>ç±»åŠ è½½å™¨çš„åˆ†ç±»ï¼š</h5><p>ä»è™šæ‹Ÿæœºçš„è§’åº¦æ¥è¯´ï¼Œæœ‰ä¸¤ç§ä¸åŒçš„ç±»åŠ è½½å™¨ï¼šä¸€ç§æ˜¯å¯åŠ¨ç±»åŠ è½½å™¨ï¼ˆBootstrap ClassLoaderï¼‰,è¯¥åŠ è½½å™¨ä½¿ç”¨C++è¯­è¨€å®ç°ï¼Œå±äºè™šæ‹Ÿæœºè‡ªèº«çš„ä¸€éƒ¨åˆ†ã€‚å¦ä¸€éƒ¨åˆ†å°±æ˜¯æ‰€æœ‰å…¶å®ƒçš„ç±»åŠ è½½å™¨ï¼Œè¿™äº›ç±»åŠ è½½å™¨æ˜¯ç”±Javaè¯­è¨€å®ç°ï¼Œç‹¬ç«‹äºJVMå¤–éƒ¨ï¼Œå¹¶ä¸”å…¨éƒ¨ç»§æ‰¿æŠ½è±¡ç±»java.lang.ClassLoader.</p>
<p>  ä»javaå¼€å‘äººå‘˜çš„è§’åº¦çœ‹ï¼Œå¤§éƒ¨åˆ†javaç¨‹åºä¼šç”¨åˆ°ä»¥ä¸‹ä¸‰ç§ç³»ç»Ÿæä¾›çš„ç±»åŠ è½½å™¨ï¼š</p>
<ol>
<li><p>å¯åŠ¨ç±»åŠ è½½å™¨ï¼ˆBootstrap ClassLoaderï¼‰:è´Ÿè´£åŠ è½½JAVA_HOME\libç›®å½•ä¸­å¹¶ä¸”èƒ½è¢«è™šæ‹Ÿæœºè¯†åˆ«çš„ç±»åº“åŠ è½½åˆ°JVMå†…å­˜ä¸­ï¼Œå¦‚æœåç§°ä¸ç¬¦åˆçš„ç±»åº“å³ä½¿åœ¨libç›®å½•ä¸­ä¹Ÿä¸ä¼šè¢«åŠ è½½ã€‚è¯¥ç±»åŠ è½½å™¨æ— æ³•è¢«javaç¨‹åºç›´æ¥å¼•ç”¨ã€‚</p>
</li>
<li><p>æ‰©å±•ç±»åŠ è½½å™¨(Extension ClassLoader):è¯¥åŠ è½½å™¨ä¸»è¦è´Ÿè´£åŠ è½½JAVA_HOME\lib\extç›®å½•ä¸­çš„ç±»åº“ï¼Œå¼€å‘è€…å¯ä»¥ä½¿ç”¨æ‰©å±•åŠ è½½å™¨ã€‚ </p>
</li>
<li><p>åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ï¼ˆApplication ClassLoaderï¼‰:è¯¥åˆ—åŠ è½½å™¨ä¹Ÿç§°ä¸ºç³»ç»ŸåŠ è½½å™¨ï¼Œå®ƒè´Ÿè´£åŠ è½½ç”¨æˆ·ç±»è·¯å¾„(Classpath)ä¸Šæ‰€æŒ‡å®šçš„ç±»åº“ï¼Œå¼€å‘è€…å¯ä»¥ç›´æ¥ä½¿ç”¨è¯¥ç±»åŠ è½½å™¨ï¼Œå¦‚æœåº”ç”¨ç¨‹åºä¸­æ²¡æœ‰è‡ªå®šä¹‰è¿‡è‡ªå·±çš„ç±»åŠ è½½å™¨ï¼Œä¸€èˆ¬æƒ…å†µä¸‹è¿™ä¸ªå°±æ˜¯ç¨‹åºä¸­é»˜è®¤çš„ç±»åŠ è½½å™¨ã€‚</p>
</li>
</ol>
<h2 id="tomcatç±»åŠ è½½çš„ç‰¹æ€§"><a href="#tomcatç±»åŠ è½½çš„ç‰¹æ€§" class="headerlink" title="tomcatç±»åŠ è½½çš„ç‰¹æ€§"></a>tomcatç±»åŠ è½½çš„ç‰¹æ€§</h2><p><strong>éš”ç¦»æ€§</strong>ï¼šWebåº”ç”¨ç±»åº“ç›¸äº’éš”ç¦»ï¼Œé¿å…ä¾èµ–åº“æˆ–è€…åº”ç”¨åŒ…ç›¸äº’å½±å“ï¼Œæ¯”å¦‚æœ‰ä¸¤ä¸ªWebåº”ç”¨ï¼Œä¸€ä¸ªé‡‡ç”¨äº†Spring 4ï¼Œä¸€ä¸ªé‡‡ç”¨äº†Spring 5ï¼Œå¦‚æœé‡‡ç”¨åŒä¸€ä¸ªç±»åŠ è½½å™¨ï¼ŒWebåº”ç”¨å°†ä¼šç”±äºjaråŒ…è¦†ç›–è€Œæ— æ³•å¯åŠ¨æˆåŠŸã€‚</p>
<p><strong>çµæ´»æ€§</strong>ï¼šWebåº”ç”¨ä¹‹é—´çš„ç±»åŠ è½½å™¨ç›¸äº’ç‹¬ç«‹ï¼Œå¦‚æœä¸€ä¸ªWebåº”ç”¨é‡æ–°éƒ¨ç½²æ—¶ï¼Œè¯¥åº”ç”¨çš„ç±»åŠ è½½å™¨é‡æ–°åŠ è½½ï¼Œä¸èƒ½å½±å“å…¶ä»–webåº”ç”¨ã€‚</p>
<p><strong>æ€§èƒ½</strong>ï¼šå¦‚æœåœ¨ä¸€ä¸ªTomcatéƒ¨ç½²å¤šä¸ªåº”ç”¨ï¼Œå¤šä¸ªåº”ç”¨ä¸­éƒ½æœ‰ç›¸åŒçš„ç±»åº“ä¾èµ–ã€‚é‚£ä¹ˆå¯ä»¥æŠŠè¿™ç›¸åŒçš„ç±»åº“è®©Commonç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½ã€‚</p>
<h2 id="tomcatä¸­çš„ç±»åŠ è½½å™¨"><a href="#tomcatä¸­çš„ç±»åŠ è½½å™¨" class="headerlink" title="tomcatä¸­çš„ç±»åŠ è½½å™¨"></a>tomcatä¸­çš„ç±»åŠ è½½å™¨</h2>{% asset_img pic5.png %}

<p>Tomcatæä¾›3ä¸ªåŸºç¡€ç±»åŠ è½½å™¨ï¼ˆcommonã€catalinaã€sharedï¼‰å’ŒWebåº”ç”¨ç±»åŠ è½½å™¨ã€‚</p>
<ul>
<li><strong>Common Loader</strong>ï¼šTomcatæœ€åŸºæœ¬çš„ç±»åŠ è½½å™¨ï¼ŒåŠ è½½<code>/common/*</code>è·¯å¾„ä¸­çš„classå¯ä»¥è¢«Tomcatå®¹å™¨æœ¬èº«ä»¥åŠå„ä¸ªWebappè®¿é—®ï¼›</li>
<li><strong>Catalina Loader</strong>ï¼šTomcatå®¹å™¨ç§æœ‰çš„ç±»åŠ è½½å™¨ï¼ŒåŠ è½½<code>/server/*</code>è·¯å¾„ä¸­çš„classå¯¹äºWebappä¸å¯è§ï¼›</li>
<li><strong>Shared Loader</strong>ï¼šå„ä¸ªWebappå…±äº«çš„ç±»åŠ è½½å™¨ï¼ŒåŠ è½½<code>/WebApp/WEB-INF/*</code>è·¯å¾„ä¸­çš„classå¯¹äºæ‰€æœ‰Webappå¯è§ï¼Œä½†æ˜¯å¯¹äºTomcatå®¹å™¨ä¸å¯è§ï¼›</li>
<li><strong>WebappClass Loader</strong>ï¼šå„ä¸ªWebappç§æœ‰çš„ç±»åŠ è½½å™¨ï¼ŒåŠ è½½è·¯å¾„ä¸­çš„classåªå¯¹å½“å‰Webappå¯è§ï¼›</li>
</ul>
<p>Tomcaté€šè¿‡Commonç±»åŠ è½½å™¨å®ç°äº†JaråŒ…åœ¨åº”ç”¨æœåŠ¡å™¨ä¸Webåº”ç”¨ä¹‹é—´çš„å…±äº«ï¼Œé€šè¿‡Sharedç±»åŠ è½½å™¨å®ç°äº†JaråŒ…åœ¨Webåº”ç”¨ä¹‹é—´çš„å…±äº«ï¼Œå†è¿‡Catalinaç±»åŠ è½½å™¨åŠ è½½æœåŠ¡å™¨ä¾èµ–çš„ç±»ã€‚</p>
<p>å½“åº”ç”¨éœ€è¦åˆ°æŸä¸ªç±»æ—¶ï¼Œåˆ™ä¼šæŒ‰ç…§ä¸‹é¢çš„é¡ºåºè¿›è¡Œç±»åŠ è½½</p>
<ol>
<li>ä½¿ç”¨BootStrap ClassLoaderåŠ è½½</li>
<li>ä½¿ç”¨systemç³»ç»Ÿç±»åŠ è½½å™¨åŠ è½½</li>
<li>ä½¿ç”¨Webapp ClassLoaderåœ¨WEB-INF/classesä¸­åŠ è½½</li>
<li>ä½¿ç”¨Webapp ClassLoaderåœ¨WEB-INF/libä¸­åŠ è½½</li>
<li>ä½¿ç”¨Common ClassLoaderåœ¨CATALINA_HOME/libä¸­åŠ è½½</li>
</ol>
<h3 id="ç±»åŠ è½½å™¨çš„åˆ›å»º"><a href="#ç±»åŠ è½½å™¨çš„åˆ›å»º" class="headerlink" title="ç±»åŠ è½½å™¨çš„åˆ›å»º"></a>ç±»åŠ è½½å™¨çš„åˆ›å»º</h3><p>3ä¸ªåŸºç¡€ç±»åŠ è½½å™¨çš„åŠ è½½è·¯å¾„åœ¨catalina.propertiesé…ç½®ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œ3ä¸ªåŸºç¡€ç±»åŠ è½½å™¨çš„å®ä¾‹éƒ½æ˜¯ä¸€ä¸ªã€‚</p>
<pre><code class="java">public void init() throws Exception {

    //ç±»åŠ è½½å™¨åˆå§‹åŒ–
    initClassLoaders();

    //è®¾ç½®çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼Œæ¥è§£å†³æœ‰å¯èƒ½çš„ClassNotFoundExceptioné—®é¢˜
    Thread.currentThread().setContextClassLoader(catalinaLoader);

    SecurityClassLoad.securityClassLoad(catalinaLoader);

    // åŠ è½½å¯åŠ¨ç±»Catalinaå¹¶è°ƒç”¨å…¶process()æ–¹æ³•
    if (log.isDebugEnabled())
        log.debug(&quot;Loading startup class&quot;);
    Class&lt;?&gt; startupClass = catalinaLoader.loadClass(&quot;org.apache.catalina.startup.Catalina&quot;);
    Object startupInstance = startupClass.getConstructor().newInstance();

    // è®¾ç½®å…±äº«ç±»åŠ è½½å™¨sharedLoader
    if (log.isDebugEnabled())
        log.debug(&quot;Setting startup class properties&quot;);
    String methodName = &quot;setParentClassLoader&quot;;
    Class&lt;?&gt; paramTypes[] = new Class[1];
    paramTypes[0] = Class.forName(&quot;java.lang.ClassLoader&quot;);
    Object paramValues[] = new Object[1];
    // æŠŠsharedåŠ è½½å™¨ä¼ é€’ç»™catalina
    paramValues[0] = sharedLoader;
    Method method =
        startupInstance.getClass().getMethod(methodName, paramTypes);
    method.invoke(startupInstance, paramValues);

    catalinaDaemon = startupInstance;
}</code></pre>
<h3 id="ç±»åŠ è½½å™¨åˆå§‹åŒ–"><a href="#ç±»åŠ è½½å™¨åˆå§‹åŒ–" class="headerlink" title="ç±»åŠ è½½å™¨åˆå§‹åŒ–"></a>ç±»åŠ è½½å™¨åˆå§‹åŒ–</h3><p>Bootstartpçš„initClassLoaders()æ–¹æ³•ä¼šåœ¨Boostrapçš„init()æ–¹æ³•ä¸­è°ƒç”¨ï¼Œåˆå§‹åŒ–ä¸‰ä¸ªç±»åŠ è½½å™¨ä»¥åŠç¡®å®šçˆ¶å­å…³ç³»ã€‚</p>
<pre><code class="java">//åˆå§‹åŒ–ä¸‰ä¸ªç±»åŠ è½½å™¨ä»¥åŠç¡®å®šçˆ¶å­å…³ç³»
private void initClassLoaders() {
    try {
        // commonLoaderçš„åŠ è½½è·¯å¾„ä¸ºcommon.loader
        commonLoader = createClassLoader(&quot;common&quot;, null);
        if (commonLoader == null) {
            // no config file, default to this loader - we might be in a &#39;single&#39; env.
            commonLoader = this.getClass().getClassLoader();
        }
        // åŠ è½½è·¯å¾„ä¸ºserver.loaderï¼Œé»˜è®¤ä¸ºç©ºï¼Œçˆ¶ç±»åŠ è½½å™¨ä¸ºcommonLoader
        catalinaLoader = createClassLoader(&quot;server&quot;, commonLoader);
        // åŠ è½½è·¯å¾„ä¸ºshared.loaderï¼Œé»˜è®¤ä¸ºç©ºï¼Œçˆ¶ç±»åŠ è½½å™¨ä¸ºcommonLoader
        sharedLoader = createClassLoader(&quot;shared&quot;, commonLoader);
    } catch (Throwable t) {
        handleThrowable(t);
        log.error(&quot;Class loader creation threw exception&quot;, t);
        System.exit(1);
    }
}</code></pre>
<p>initClassLoaders()æ–¹æ³•ä¼šè°ƒç”¨createClassLoader()æ–¹æ³•ä¼šæ ¹æ®catalina.propertiesä¸­çš„å†…å®¹åˆ›å»ºå¯¹åº”çš„ç±»åŠ è½½å™¨ï¼Œå¦‚æœä¸ºç©ºåˆ™è¿”å›ä¼ å…¥çš„çˆ¶åŠ è½½å™¨ã€‚</p>
<pre><code class="java">private ClassLoader createClassLoader(String name, ClassLoader parent)
    throws Exception {

    String value = CatalinaProperties.getProperty(name + &quot;.loader&quot;);
    if ((value == null) || (value.equals(&quot;&quot;)))
        return parent;

    value = replace(value);

    List&lt;Repository&gt; repositories = new ArrayList&lt;&gt;();

    String[] repositoryPaths = getPaths(value);

    for (String repository : repositoryPaths) {
        // Check for a JAR URL repository
        try {
            @SuppressWarnings(&quot;unused&quot;)
            URL url = new URL(repository);
            repositories.add(new Repository(repository, RepositoryType.URL));
            continue;
        } catch (MalformedURLException e) {
            // Ignore
        }

        // Local repository
        if (repository.endsWith(&quot;*.jar&quot;)) {
            repository = repository.substring
                (0, repository.length() - &quot;*.jar&quot;.length());
            repositories.add(new Repository(repository, RepositoryType.GLOB));
        } else if (repository.endsWith(&quot;.jar&quot;)) {
            repositories.add(new Repository(repository, RepositoryType.JAR));
        } else {
            repositories.add(new Repository(repository, RepositoryType.DIR));
        }
    }

    return ClassLoaderFactory.createClassLoader(repositories, parent);
}</code></pre>
<p>catalina.propertiesä¸­çš„å†…å®¹</p>
<pre><code class="properties">common.loader=&quot;${catalina.base}/lib&quot;,&quot;${catalina.base}/lib/*.jar&quot;,&quot;${catalina.home}/lib&quot;,&quot;${catalina.home}/lib/*.jar&quot;
server.loader=
shared.loader=</code></pre>
<p>æ‰€ä»¥é»˜è®¤æƒ…å†µè¿™ä¸‰ä¸ªç±»åŠ è½½å™¨æ˜¯åŒä¸€ä¸ªå®ä¾‹ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹é…ç½®åˆ›å»º3ä¸ªä¸åŒçš„ç±»åŠ è½½æœºåˆ¶ï¼Œä½¿å®ƒä»¬å„å¸å…¶èŒï¼Œå¦‚æœä¸å¸Œæœ›è¿™äº›åŒ…å¯¹Webåº”ç”¨å¯è§ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é…ç½®server.loaderï¼Œåˆ›å»ºç‹¬ç«‹çš„Catalinaç±»åŠ è½½å™¨ã€‚</p>
<h3 id="ç±»åŠ è½½å·¥å‚"><a href="#ç±»åŠ è½½å·¥å‚" class="headerlink" title="ç±»åŠ è½½å·¥å‚"></a>ç±»åŠ è½½å·¥å‚</h3><p>å› ä¸ºç±»åŠ è½½éœ€è¦åšå¾ˆå¤šäº‹æƒ…ï¼Œæ¯”å¦‚è¯»å–å­—èŠ‚æ•°ç»„ã€éªŒè¯ã€è§£æã€åˆå§‹åŒ–ç­‰ã€‚Javaæä¾›çš„URLClassLoaderç±»èƒ½å¤Ÿæ–¹ä¾¿çš„å°†Jarã€Classæˆ–è€…ç½‘ç»œèµ„æºåŠ è½½åˆ°å†…å­˜ä¸­ã€‚Tomcatä¸­ä½¿ç”¨ä¸€ä¸ªå·¥å‚ç±»ï¼ŒClassLoaderFactoryæŠŠåˆ›å»ºç±»åŠ è½½å™¨çš„ç»†èŠ‚è¿›è¡Œå°è£…ï¼Œå¯ä»¥é€šè¿‡å®ƒæ–¹ä¾¿çš„åˆ›å»ºè‡ªå®šä¹‰ç±»åŠ è½½å™¨ã€‚</p>
<p>ä¸Šè¿°createClassLoader()æ–¹æ³•ä¸­çš„<code>return ClassLoaderFactory.createClassLoader(repositories, parent);</code>æ–¹æ³•å°±æ˜¯ä½¿ç”¨ç±»åŠ è½½å·¥å‚æ¥åˆ›å»ºç±»åŠ è½½å™¨ã€‚</p>
<pre><code class="java">public static ClassLoader createClassLoader(List&lt;Repository&gt; repositories,
                                            final ClassLoader parent)
    throws Exception {

    if (log.isDebugEnabled())
        log.debug(&quot;Creating new class loader&quot;);

    // Construct the &quot;class path&quot; for this class loader
    Set&lt;URL&gt; set = new LinkedHashSet&lt;&gt;();

    if (repositories != null) {
        for (Repository repository : repositories)  {
            if (repository.getType() == RepositoryType.URL) {
                URL url = buildClassLoaderUrl(repository.getLocation());
                if (log.isDebugEnabled())
                    log.debug(&quot;  Including URL &quot; + url);
                set.add(url);
            } else if (repository.getType() == RepositoryType.DIR) {
                File directory = new File(repository.getLocation());
                directory = directory.getCanonicalFile();
                if (!validateFile(directory, RepositoryType.DIR)) {
                    continue;
                }
                URL url = buildClassLoaderUrl(directory);
                if (log.isDebugEnabled())
                    log.debug(&quot;  Including directory &quot; + url);
                set.add(url);
            } else if (repository.getType() == RepositoryType.JAR) {
                File file=new File(repository.getLocation());
                file = file.getCanonicalFile();
                if (!validateFile(file, RepositoryType.JAR)) {
                    continue;
                }
                URL url = buildClassLoaderUrl(file);
                if (log.isDebugEnabled())
                    log.debug(&quot;  Including jar file &quot; + url);
                set.add(url);
            } else if (repository.getType() == RepositoryType.GLOB) {
                File directory=new File(repository.getLocation());
                directory = directory.getCanonicalFile();
                if (!validateFile(directory, RepositoryType.GLOB)) {
                    continue;
                }
                if (log.isDebugEnabled())
                    log.debug(&quot;  Including directory glob &quot;
                        + directory.getAbsolutePath());
                String filenames[] = directory.list();
                if (filenames == null) {
                    continue;
                }
                for (int j = 0; j &lt; filenames.length; j++) {
                    String filename = filenames[j].toLowerCase(Locale.ENGLISH);
                    if (!filename.endsWith(&quot;.jar&quot;))
                        continue;
                    File file = new File(directory, filenames[j]);
                    file = file.getCanonicalFile();
                    if (!validateFile(file, RepositoryType.JAR)) {
                        continue;
                    }
                    if (log.isDebugEnabled())
                        log.debug(&quot;    Including glob jar file &quot;
                            + file.getAbsolutePath());
                    URL url = buildClassLoaderUrl(file);
                    set.add(url);
                }
            }
        }
    }

    // Construct the class loader itself
    final URL[] array = set.toArray(new URL[set.size()]);
    if (log.isDebugEnabled())
        for (int i = 0; i &lt; array.length; i++) {
            log.debug(&quot;  location &quot; + i + &quot; is &quot; + array[i]);
        }

    return AccessController.doPrivileged(
            new PrivilegedAction&lt;URLClassLoader&gt;() {
                @Override
                public URLClassLoader run() {
                    if (parent == null)
                        return new URLClassLoader(array);
                    else
                        return new URLClassLoader(array, parent);
                }
            });
}</code></pre>
<p>createClassLoader()æ–¹æ³•ä¼šä¾æ®RepositoryTypeæ¥æ‰§è¡Œä¸åŒçš„åˆ›å»ºæ–¹æ³•ã€‚</p>
<pre><code class="java">public enum RepositoryType {
    DIR, //è¡¨ç¤ºæ•´ä¸ªç›®å½•ä¸‹çš„èµ„æºï¼ŒåŒ…æ‹¬æ‰€æœ‰Classã€jaråŒ…ä»¥åŠå…¶ä»–ç±»å‹èµ„æº
    GLOB, //è¡¨ç¤ºæ•´ä¸ªç›®å½•ä¸‹çš„æ‰€æœ‰jaråŒ…èµ„æº
    JAR, //è¡¨ç¤ºå•ä¸ªjaråŒ…èµ„æº
    URL //è¡¨ç¤ºä»URLä¸Šè·å–jaråŒ…èµ„æº
}</code></pre>
<p>ä½¿ç”¨åŠ è½½å™¨å·¥å‚çš„å¥½å¤„</p>
<ol>
<li>ClassLoadFactoryæœ‰ä¸€ä¸ªå†…éƒ¨Repositoryï¼Œå®ƒå°±æ˜¯è¡¨ç¤ºèµ„æºçš„ç±»ï¼Œèµ„æºçš„ç±»å‹ç”¨ä¸€ä¸ªRepositoryTypeçš„æšä¸¾è¡¨ç¤ºã€‚</li>
<li>åœ¨æ£€æŸ¥jaråŒ…çš„æ—¶å€™ï¼Œå¦‚æœæ£€æŸ¥çš„URLåœ°å€æœ‰å¼‚å¸¸å°±å¿½ç•¥æ‰ï¼Œå¯ä»¥ç¡®ä¿éƒ¨åˆ†ç±»åŠ è½½æ­£ç¡®ã€‚</li>
</ol>
<h3 id="ç±»åŠ è½½å™¨ç»‘å®šåˆ°çº¿ç¨‹"><a href="#ç±»åŠ è½½å™¨ç»‘å®šåˆ°çº¿ç¨‹" class="headerlink" title="ç±»åŠ è½½å™¨ç»‘å®šåˆ°çº¿ç¨‹"></a>ç±»åŠ è½½å™¨ç»‘å®šåˆ°çº¿ç¨‹</h3><p>JVMæä¾›äº†java.lang.Threadç±»çš„setContextClassLoaderæ–¹æ³•æ¥ç»‘å®šä¸€ä¸ªçº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼ˆThread Context ClassLoaderï¼‰ï¼Œç”¨äºåœ¨è¿è¡Œæ—¶åŠ¨æ€è½½å…¥å…¶ä»–ç±»ï¼Œå¦‚æœåˆ›å»ºçº¿ç¨‹æ—¶æœªè®¾ç½®ï¼Œå°†ä¼šä»çˆ¶çº¿ç¨‹ä¸­ç»§æ‰¿ä¸€ä¸ªï¼Œæ‰€ä»¥å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œéƒ½æ˜¯ç³»ç»Ÿé»˜è®¤çš„ContextClassLoadã€‚</p>
<p>ä¸€èˆ¬åœ¨å®é™…çš„ç³»ç»Ÿä¸Šï¼Œä½¿ç”¨çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼Œå¯ä»¥è®¾ç½®ä¸åŒçš„åŠ è½½æ–¹å¼ï¼Œè¿™ä¸ªä¹Ÿæ˜¯Javaçµæ´»çš„ç±»åŠ è½½æ–¹å¼çš„ä½“ç°ï¼Œä¹Ÿå¯ä»¥å¾ˆè½»æ¾çš„æ‰“ç ´åŒäº²å§”æ´¾æ¨¡å¼ï¼ŒåŒæ—¶ä¹Ÿä¼šé¿å…ç±»åŠ è½½çš„å¼‚å¸¸ã€‚</p>
<p>tomcatä¹Ÿä½¿ç”¨äº†è¿™ç§æ–¹å¼ï¼Œæ¥è§£å†³Commons ClassLoaderéœ€è¦Webapp ClassLoaderä¸­çš„ç±»çš„æƒ…å†µã€‚WebappLoaderåªä¼šåŠ è½½è‡ªå·±ç›®å½•ä¸‹çš„classæ–‡ä»¶ï¼Œä¸ä¼šä¼ é€’ç»™çˆ¶å®¹å™¨ï¼Œæ‰€ä»¥tomcatå°†Webapp ClassLoaderä¸çº¿ç¨‹ç»‘å®šï¼Œä½¿ç”¨çº¿ç¨‹ä¸Šä¸‹æ–‡åŠ è½½å™¨ï¼Œå¯ä»¥è®©çˆ¶ç±»åŠ è½½å™¨è¯·æ±‚å­ç±»åŠ è½½å™¨å»å®Œæˆç±»åŠ è½½çš„åŠ¨ä½œï¼Œä¸å¾—ä¸è¯´ï¼Œè¿™æ˜¯ä¸ªå·§å¦™çš„è®¾è®¡ã€‚</p>
<h3 id="tomcatçš„çƒ­åŠ è½½"><a href="#tomcatçš„çƒ­åŠ è½½" class="headerlink" title="tomcatçš„çƒ­åŠ è½½"></a>tomcatçš„çƒ­åŠ è½½</h3><p>StandardContext.startInternal()æ–¹æ³•ä¸­è¿˜ä¼šè°ƒç”¨threadStart()æ–¹æ³•ï¼ŒthreadStart()æ–¹æ³•å°†åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œè¿™ä¸ªçº¿ç¨‹çš„whileå¾ªç¯ä¸­ï¼Œä¸æ–­çš„è°ƒç”¨æ–¹æ³•ï¼Œç„¶åè¿›è¡Œç¡çœ ï¼Œä»¥è¿™ç§ç±»ä¼¼äºå®šæ—¶å™¨çš„æ–¹å¼ï¼Œæ¥æ‰§è¡Œä»»åŠ¡ï¼Œå¦‚é‡æ–°åŠ è½½ç­‰ã€‚</p>
<pre><code class="java">protected void threadStart() {

    if (thread != null)
        return;
    if (backgroundProcessorDelay &lt;= 0)
        return;

    threadDone = false;
    String threadName = &quot;ContainerBackgroundProcessor[&quot; + toString() + &quot;]&quot;;
    thread = new Thread(new ContainerBackgroundProcessor(), threadName);
    thread.setDaemon(true);
    thread.start();

}</code></pre>
<p>threadStart()æ–¹æ³•è°ƒç”¨é“¾æ¯”è¾ƒé•¿ï¼Œè¿™é‡Œåªåˆ†æWebappLoaderçš„backgroudProcess()æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å°†å®Œæˆç±»çš„é‡æ–°åŠ è½½ã€‚</p>
<pre><code class="java">public void backgroundProcess() {
    if (reloadable &amp;&amp; modified()) {
        try {
            //è®¾ç½®çº¿ç¨‹ç±»åŠ è½½å™¨çš„ç±»åŠ è½½å™¨WebappClassLoader
            Thread.currentThread().setContextClassLoader
                (WebappLoader.class.getClassLoader());
            if (context != null) {
                //é‡æ–°åŠ è½½çš„æ–¹æ³•
                context.reload();
            }
        } finally {
            if (context != null &amp;&amp; context.getLoader() != null) {
                Thread.currentThread().setContextClassLoader
                    (context.getLoader().getClassLoader());
            }
        }
    }
}</code></pre>

            </div>
            <hr>
            <div>
              <p>
                
                  <span>
                <i class="iconfont icon-inbox"></i>
                    
                      <a class="hover-with-bg" href="/categories/tomcat/">tomcat</a>
                      &nbsp;
                    
                  </span>&nbsp;&nbsp;
                
                
                  <span>
                <i class="iconfont icon-tag"></i>
                    
                      <a class="hover-with-bg" href="/tags/tomcat/">tomcat</a>
                    
                  </span>
                
              </p>
              
                <p class="note note-warning">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://zh.wikipedia.org/wiki/Wikipedia:CC_BY-SA_3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC" target="_blank" rel="nofollow noopener noopener">CC BY-SA 3.0åè®®</a> ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</p>
              
              
                <div class="post-prevnext row">
                  <div class="post-prev col-6">
                    
                    
                      <a href="/2020/05/06/tomcat%E5%B5%8C%E5%85%A5%E5%BC%8F%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">
                        <i class="fa fa-chevron-left"></i>
                        <span class="hidden-mobile">tomcatåµŒå…¥å¼ä¸æ€§èƒ½ä¼˜åŒ–</span>
                        <span class="visible-mobile">ä¸Šä¸€ç¯‡</span>
                      </a>
                    
                  </div>
                  <div class="post-next col-6">
                    
                    
                      <a href="/2020/04/30/tomcat%E4%BD%93%E7%B3%BB%E6%9E%B6%E6%9E%84/">
                        <span class="hidden-mobile">tomcatä½“ç³»æ¶æ„</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="fa fa-chevron-right"></i>
                      </a>
                    
                  </div>
                </div>
              
            </div>

              
                <!-- Comments -->
                <div class="comments" id="comments">
                  
                  

                </div>
              
          </div>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc-start"></div>
<div id="toc">
  <p class="h5"><i class="far fa-list-alt"></i>&nbsp;ç›®å½•</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a class="z-depth-1" id="scroll-top-button" href="#" role="button">
      <i class="fa fa-chevron-up scroll-top-arrow" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><b>Hexo</b></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"> <b>Fluid</b></a>
    </div>
    
  <div>
    
      <!-- ä¸è’œå­ç»Ÿè®¡PV -->
      
      <span id="busuanzi_container_site_pv" style="display: none">
      æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv"></span> æ¬¡
    </span>
    
    
      <!-- ä¸è’œå­ç»Ÿè®¡UV -->
      
      <span id="busuanzi_container_site_uv" style="display: none">
      æ€»è®¿å®¢æ•° <span id="busuanzi_value_site_uv"></span> äºº
    </span>
    
  </div>


    

    
  </div>
</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/popper.js/1.16.1/umd/popper.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="https://cdn.staticfile.org/mdbootstrap/4.13.0/js/mdb.min.js" ></script>
<script  src="/js/main.js" ></script>


  <script  src="/js/lazyload.js" ></script>



  
  <script  src="https://cdn.staticfile.org/tocbot/4.10.0/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var navHeight = $('#navbar').height();
      var toc = $('#toc');
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;
      var tocLimMax = 2 * boardTop + boardCtn.height();

      $(window).scroll(function () {
        var tocLimMin = $('#toc-start').offset().top - navHeight;
        var scroH = document.body.scrollTop + document.documentElement.scrollTop;

        if (tocLimMin <= scroH && scroH <= tocLimMax) {
          toc.css({
            'display': 'block',
            'position': 'fixed',
            'top': navHeight,
          });
        } else if (scroH <= tocLimMin) {
          toc.css({
            'position': '',
            'top': '',
          });
        } else if (scroH > tocLimMax) {
          toc.css('display', 'none');
        }
      });
      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: '.post-content',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc > p').css('visibility', 'visible');
      }
      var offset = boardCtn.css('margin-right')
      $('#toc-ctn').css({
        'right': offset
      })
    });
  </script>





  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/js/clipboard-use.js" ></script>



  <script defer src="https://cdn.staticfile.org/smoothscroll/1.4.10/SmoothScroll.min.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




<!-- Plugins -->


  

  

  

  

  

  



  <script  src="https://cdn.staticfile.org/prettify/188.0.0/prettify.min.js" ></script>
  <script>
    $(document).ready(function () {
      $('pre').addClass('prettyprint  linenums');
      prettyPrint();
    })
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "tomcatæºç è§£æ&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      getSearchFile(path);
      this.onclick = null
    }
  </script>



  <script defer src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <script>
    $("#post img:not(.no-zoom img, img[no-zoom])").each(
      function () {
        var element = document.createElement("a");
        $(element).attr("data-fancybox", "images");
        $(element).attr("href", $(this).attr("src"));
        $(this).wrap(element);
      }
    );
  </script>





  
  
    <script type="text/javascript">
      //å®šä¹‰è·å–è¯è¯­ä¸‹æ ‡
      var a_idx = 0;
      jQuery(document).ready(function ($) {
        //ç‚¹å‡»bodyæ—¶è§¦å‘äº‹ä»¶
        $("body").click(function (e) {
          //éœ€è¦æ˜¾ç¤ºçš„è¯è¯­
          var a = new Array("å¯Œå¼º", "æ°‘ä¸»", "æ–‡æ˜", "å’Œè°", "è‡ªç”±", "å¹³ç­‰", "å…¬æ­£", "æ³•æ²»", "çˆ±å›½", "æ•¬ä¸š", "è¯šä¿¡", "å‹å–„");
          //è®¾ç½®è¯è¯­ç»™spanæ ‡ç­¾
          var $i = $("<span/>").text(a[a_idx]);
          //ä¸‹æ ‡ç­‰äºåŸæ¥ä¸‹æ ‡+1  ä½™ è¯è¯­æ€»æ•°
          a_idx = (a_idx + 1) % a.length;
          //è·å–é¼ æ ‡æŒ‡é’ˆçš„ä½ç½®ï¼Œåˆ†åˆ«ç›¸å¯¹äºæ–‡æ¡£çš„å·¦å’Œå³è¾¹ç¼˜ã€‚
          //è·å–xå’Œyçš„æŒ‡é’ˆåæ ‡
          var x = e.pageX, y = e.pageY;
          //åœ¨é¼ æ ‡çš„æŒ‡é’ˆçš„ä½ç½®ç»™$iå®šä¹‰çš„spanæ ‡ç­¾æ·»åŠ cssæ ·å¼
          $i.css({
            "z-index": 999,
            "top": y - 20,
            "left": x,
            "position": "absolute",
            "font-weight": "bold",
            "color": rand_color()
          });
          // éšæœºé¢œè‰²
          function rand_color() {
            return "rgb(" + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + ")"
          }
          //åœ¨bodyæ·»åŠ è¿™ä¸ªæ ‡ç­¾
          $("body").append($i);
          //animate() æ–¹æ³•æ‰§è¡Œ CSS å±æ€§é›†çš„è‡ªå®šä¹‰åŠ¨ç”»ã€‚
          //è¯¥æ–¹æ³•é€šè¿‡CSSæ ·å¼å°†å…ƒç´ ä»ä¸€ä¸ªçŠ¶æ€æ”¹å˜ä¸ºå¦ä¸€ä¸ªçŠ¶æ€ã€‚CSSå±æ€§å€¼æ˜¯é€æ¸æ”¹å˜çš„ï¼Œè¿™æ ·å°±å¯ä»¥åˆ›å»ºåŠ¨ç”»æ•ˆæœã€‚
          //è¯¦æƒ…è¯·çœ‹http://www.w3school.com.cn/jquery/effect_animate.asp
          $i.animate({
            //å°†åŸæ¥çš„ä½ç½®å‘ä¸Šç§»åŠ¨180
            "top": y - 180,
            "opacity": 0
            //1500åŠ¨ç”»çš„é€Ÿåº¦
          }, 1500, function () {
            //æ—¶é—´åˆ°äº†è‡ªåŠ¨åˆ é™¤
            $i.remove();
          });
        });
      })
      ;
    </script>
  








</body>
</html>
