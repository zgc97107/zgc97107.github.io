

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/blog/img/favicon.png">
  <link rel="icon" type="image/png" href="/blog/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="">
  <meta name="keywords" content="">
  <title>tomcatæºç è§£æ - ğŸğŸŠ&#39;s blog</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.5.3/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/blog/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.1.2/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />
  



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/blog/css/main.css" />

<!-- è‡ªå®šä¹‰æ ·å¼ä¿æŒåœ¨æœ€åº•éƒ¨ -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"zhaoguocheng.gitee.io","root":"/blog/","version":"1.8.5","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"copy_btn":true,"image_zoom":{"enable":true},"lazyload":{"enable":true,"onlypost":false},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/blog/js/utils.js" ></script>
  <script  src="/blog/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.2.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/blog/">&nbsp;<strong>Fluid</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/">
                <i class="iconfont icon-home-fill"></i>
                ä¸»é¡µ
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/archives/">
                <i class="iconfont icon-archive-fill"></i>
                å½’æ¡£
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/categories/">
                <i class="iconfont icon-category-fill"></i>
                åˆ†ç±»
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/tags/">
                <i class="iconfont icon-tags-fill"></i>
                æ ‡ç­¾
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/about/">
                <i class="iconfont icon-user-fill"></i>
                å…³äº
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax=true
         style="background: url('/blog/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="tomcatæºç è§£æ">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2020-04-30 18:26" pubdate>
        2020å¹´4æœˆ30æ—¥ æ™šä¸Š
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      7.1k å­—
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      94
       åˆ†é’Ÿ
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">tomcatæºç è§£æ</h1>
            
            <div class="markdown-body">
              <h2 id="tomcatæºç ç›®å½•"><a href="#tomcatæºç ç›®å½•" class="headerlink" title="tomcatæºç ç›®å½•"></a>tomcatæºç ç›®å½•</h2><ul>
<li><p>catalinaç›®å½•ï¼šcatalinaåŒ…å«æ‰€æœ‰çš„Servletå®¹å™¨å®ç°ï¼Œä»¥åŠæ¶‰åŠåˆ°å®‰å…¨ã€ä¼šè¯ã€é›†ç¾¤ã€éƒ¨ç½²ç®¡ç†Servletå®¹å™¨çš„å„ä¸ªæ–¹é¢ï¼ŒåŒæ—¶ï¼Œå®ƒè¿˜åŒ…å«äº†å¯åŠ¨å…¥å£ã€‚</p>
</li>
<li><p>coyoteç›®å½•ï¼šcoyoteæ˜¯Tomcaté“¾æ¥å™¨æ¡†æ¶çš„åç§°ï¼Œæ˜¯TomcatæœåŠ¡å™¨æä¾›çš„å®¢æˆ·ç«¯è®¿é—®çš„å¤–éƒ¨æ¥å£ï¼Œå®¢æˆ·ç«¯é€šè¿‡Coyoteä¸æœåŠ¡å™¨å»ºç«‹é“¾æ¥ã€å‘é€è¯·æ±‚å¹¶æ¥æ”¶å“åº”ã€‚</p>
</li>
<li><p>Elç›®å½•ï¼Œæä¾›javaè¡¨è¾¾å¼è¯­è¨€</p>
</li>
<li><p>Jasperæ¨¡å—æä¾›JSPå¼•æ“</p>
</li>
<li><p>Namingæ¨¡å—æä¾›JNDIçš„æœåŠ¡</p>
</li>
<li><p>Juliæä¾›æœåŠ¡å™¨æ—¥å¿—çš„æœåŠ¡</p>
</li>
<li><p>tomcatæä¾›å¤–éƒ¨è°ƒç”¨çš„æ¥å£api</p>
</li>
</ul>
<h2 id="tomcatç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†"><a href="#tomcatç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†" class="headerlink" title="tomcatç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†"></a>tomcatç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†</h2><p>tomcatçš„æ¶æ„è®¾è®¡æ˜¯æ¸…æ™°çš„ã€æ¨¡å—åŒ–ã€å®ƒæ‹¥æœ‰å¾ˆå¤šç»„ä»¶ï¼ŒåŠ å…¥åœ¨å¯åŠ¨Tomcatæ—¶ä¸€ä¸ªä¸€ä¸ªç»„ä»¶å¯åŠ¨ï¼Œå¾ˆå®¹æ˜“é—æ¼ç»„ä»¶ï¼ŒåŒæ—¶è¿˜ä¼šå¯¹åé¢çš„åŠ¨æ€ç»„ä»¶æ‹“å±•å¸¦æ¥éº»çƒ¦ã€‚å¦‚æœé‡‡ç”¨æˆ‘ä»¬ä¼ ç»Ÿçš„æ–¹å¼çš„è¯ï¼Œç»„ä»¶åœ¨å¯åŠ¨è¿‡ç¨‹ä¸­å¦‚æœå‘ç”Ÿå¼‚å¸¸ï¼Œä¼šå¾ˆéš¾ç®¡ç†ï¼Œæ¯”å¦‚ä½ çš„ä¸‹ä¸€ä¸ªç»„ä»¶è°ƒç”¨äº†start()æ–¹æ³•ï¼Œä½†æ˜¯å¦‚æœå®ƒçš„ä¸Šçº§ç»„ä»¶è¿˜æ²¡æœ‰start()ç”šè‡³è¿˜æ²¡æœ‰init()çš„è¯ï¼ŒTomcatçš„å¯åŠ¨ä¼šéå¸¸éš¾ç®¡ç†ï¼Œå› æ­¤ï¼ŒTomcatçš„è®¾è®¡è€…æå‡ºä¸€ä¸ªè§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ç”Ÿå‘½å‘¨æœŸç»Ÿä¸€æ¥å£Lifecycleå®šä¹‰ä¸€äº›çŠ¶æ€å¸¸é‡ï¼Œç„¶åå°†å¯åŠ¨ã€åœæ­¢ã€å…³é—­åŠæ‰€æœ‰ä¸ç”Ÿå‘½å‘¨æœŸç›¸å…³çš„æ–¹æ³•éƒ½ç»„ç»‡åˆ°ä¸€èµ·ï¼Œè¿™æ ·å°±å¯ä»¥å¾ˆæ–¹ä¾¿ç®¡ç†tomcatå„ä¸ªå®¹å™¨ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸã€‚</p>
<p>LifecycleBaseå®ç°äº†Lifecycleæ¥å£ï¼Œåœ¨init()æ–¹æ³•ä¸­åˆå§‹åŒ–ä¹‹å‰ä¼šè¿›è¡ŒçŠ¶æ€æ£€æŸ¥ï¼š</p>
<pre><code class="hljs java"><span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> LifecycleException </span>&#123;
    <span class="hljs-comment">//é˜²æ­¢ç»„ä»¶å¯åŠ¨æ—¶çŠ¶æ€ä¸å¯¹</span>
    <span class="hljs-keyword">if</span> (!state.equals(LifecycleState.NEW)) &#123;
        invalidTransition(Lifecycle.BEFORE_INIT_EVENT);
    &#125;

    <span class="hljs-keyword">try</span> &#123;
        <span class="hljs-comment">//è®¾ç½®åˆå§‹åŒ–çŠ¶æ€</span>
        setStateInternal(LifecycleState.INITIALIZING, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">false</span>);
        initInternal();
        <span class="hljs-comment">//è®¾ç½®åˆå§‹åŒ–å®Œæˆ</span>
        setStateInternal(LifecycleState.INITIALIZED, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">false</span>);
    &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;
        handleSubClassException(t, <span class="hljs-string">&quot;lifecycleBase.initFail&quot;</span>, toString());
    &#125;
&#125;</code></pre>

<p>init()æ–¹æ³•ä¸­ä¼šè°ƒç”¨å­ç±»çš„initInternal()æ–¹æ³•ï¼Œè¿™é‡Œä½¿ç”¨äº†æ¨¡ç‰ˆæ–¹æ³•è®¾è®¡æ¨¡å¼ï¼ŒLifecycleBaseä¸ºéª¨æ¶ç±»ï¼ŒinitInternal()çš„å…·ä½“å®ç°åœ¨å­ç±»ä¸­ï¼Œspringä¸­ä¹Ÿä½¿ç”¨äº†è¿™ç§è®¾è®¡æ¨¡å¼ã€‚</p>
<p>start()æ–¹æ³•ä¸­åŒæ ·ä¼šè¿›è¡Œç›¸åº”çš„åˆ¤æ–­ã€‚</p>
<pre><code class="hljs java"><span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title">start</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> LifecycleException </span>&#123;
    <span class="hljs-comment">// ç»Ÿä¸€è¿›è¡Œç”Ÿå‘½å‘¨æœŸçš„ç®¡ç†</span>
    <span class="hljs-keyword">if</span> (LifecycleState.STARTING_PREP.equals(state) || LifecycleState.STARTING.equals(state) ||
            LifecycleState.STARTED.equals(state)) &#123;
        <span class="hljs-keyword">if</span> (log.isDebugEnabled()) &#123;
            Exception e = <span class="hljs-keyword">new</span> LifecycleException();
            log.debug(sm.getString(<span class="hljs-string">&quot;lifecycleBase.alreadyStarted&quot;</span>, toString()), e);
        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (log.isInfoEnabled()) &#123;
            log.info(sm.getString(<span class="hljs-string">&quot;lifecycleBase.alreadyStarted&quot;</span>, toString()));
        &#125;
        <span class="hljs-keyword">return</span>;
    &#125;
    <span class="hljs-comment">// æ£€æŸ¥ç»„ä»¶ç”Ÿå‘½å‘¨æœŸçŠ¶æ€</span>
    <span class="hljs-keyword">if</span> (state.equals(LifecycleState.NEW)) &#123;
        init();
    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (state.equals(LifecycleState.FAILED)) &#123;
        stop();
    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!state.equals(LifecycleState.INITIALIZED) &amp;&amp;
            !state.equals(LifecycleState.STOPPED)) &#123;
        invalidTransition(Lifecycle.BEFORE_START_EVENT);
    &#125;

    <span class="hljs-keyword">try</span> &#123;
        <span class="hljs-comment">// è®¾ç½®ç»„ä»¶çŠ¶æ€</span>
        setStateInternal(LifecycleState.STARTING_PREP, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">false</span>);
        <span class="hljs-comment">// è°ƒç”¨å…·ä½“å®ç°ç±»çš„æ–¹æ³•</span>
        startInternal();
        <span class="hljs-comment">// ç»Ÿä¸€è¿›è¡Œç”Ÿå‘½å‘¨æœŸçš„ç®¡ç†</span>
        <span class="hljs-keyword">if</span> (state.equals(LifecycleState.FAILED)) &#123;
            <span class="hljs-comment">// å¤±è´¥ï¼Œè°ƒç”¨stop()æ–¹æ³•å®Œæˆæ¸…ç†</span>
            stop();
        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!state.equals(LifecycleState.STARTING)) &#123;
            <span class="hljs-comment">// ä¸æ˜¯å·²ç»åœ¨å¯åŠ¨çš„çŠ¶æ€</span>
            invalidTransition(Lifecycle.AFTER_START_EVENT);
        &#125; <span class="hljs-keyword">else</span> &#123;
            <span class="hljs-comment">// è®¾ç½®ç»„ä»¶çŠ¶æ€</span>
            setStateInternal(LifecycleState.STARTED, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">false</span>);
        &#125;
    &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;
        <span class="hljs-comment">// This is an &#x27;uncontrolled&#x27; failure so put the component into the</span>
        <span class="hljs-comment">// FAILED state and throw an exception.</span>
        handleSubClassException(t, <span class="hljs-string">&quot;lifecycleBase.startFail&quot;</span>, toString());
    &#125;
&#125;</code></pre>

<p>tomcatå†…éƒ¨æ¶æ„ä¸­å„ä¸ªæ ¸å¿ƒç»„ä»¶æœ‰åŒ…å«ä¸è¢«åŒ…å«å…³ç³»ï¼Œä¾‹å¦‚ï¼šServeråŒ…å«äº†Serviceï¼ŒServiceåˆåŒ…å«äº†Containerå’ŒConnectorï¼Œè¿™ä¸ªç»“æ„æœ‰ä¸€ç‚¹åƒæ•°æ®ç»“æ„ä¸­çš„æ ‘ï¼Œæ ‘çš„æ ¹ç»“ç‚¹æ²¡æœ‰çˆ¶èŠ‚ç‚¹ï¼Œå…¶ä»–èŠ‚ç‚¹æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªçˆ¶èŠ‚ç‚¹ï¼Œæ¯ä¸€ä¸ªçˆ¶èŠ‚ç‚¹æœ‰0è‡³å¤šä¸ªå­èŠ‚ç‚¹ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡çˆ¶å®¹å™¨å¯åŠ¨å®ƒçš„å­å®¹å™¨ï¼Œè¿™æ ·åªè¦å¯åŠ¨æ ¹å®¹å™¨ï¼Œå°±å¯ä»¥æŠŠå…¶ä»–æ‰€æœ‰çš„å®¹å™¨éƒ½å¯åŠ¨ï¼Œä»è€Œè¾¾åˆ°äº†ç»Ÿä¸€çš„å¯åŠ¨ï¼Œåœæ­¢ã€å…³é—­çš„æ•ˆæœã€‚</p>
<h2 id="tomcatç»„ä»¶åˆ†æ"><a href="#tomcatç»„ä»¶åˆ†æ" class="headerlink" title="tomcatç»„ä»¶åˆ†æ"></a>tomcatç»„ä»¶åˆ†æ</h2><h3 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h3><p>ç»§æ‰¿ç»“æ„ï¼š</p>
<img src="/blog/2020/04/30/tomcat%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/pic6.png" srcset="/blog/img/loading.gif" class>

<p>Serveræ˜¯tomcatæœ€é¡¶å±‚çš„å®¹å™¨ï¼Œä»£è¡¨æ•´ä¸ªæœåŠ¡å™¨ï¼ŒTomcatä¸­çš„æ ‡å‡†å®ç°ä¸ºStandardServerç±»ã€‚</p>
<h3 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h3><p>ç»§æ‰¿ç»“æ„ï¼š</p>
<img src="/blog/2020/04/30/tomcat%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/pic7.png" srcset="/blog/img/loading.gif" class>

<p>å…¶ä¸­LifecycleMBeanBaseç”¨äºç›‘ç£å¯¹è±¡çŠ¶æ€ã€‚</p>
<p>Serviceä¸­è¯·æ±‚ç›‘å¬å’Œè¯·æ±‚å¤„ç†åˆ†å¼€ä¸ºä¸¤ä¸ªæ¨¡å—ï¼š</p>
<img src="/blog/2020/04/30/tomcat%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/pic8.png" srcset="/blog/img/loading.gif" class>

<p>Connectorè´Ÿè´£è¯·æ±‚ç›‘å¬ï¼ŒContainerè´Ÿè´£è¯·æ±‚å¤„ç†ï¼Œä¸€ä¸ªServiceå¯ä»¥æœ‰å¤šä¸ªConnectorï¼Œä½†åªèƒ½æœ‰ä¸€ä¸ªContainerã€‚</p>
<h3 id="Connector"><a href="#Connector" class="headerlink" title="Connector"></a>Connector</h3><img src="/blog/2020/04/30/tomcat%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/pic8.png" srcset="/blog/img/loading.gif" class>

<p>Connectorä½¿ç”¨ProtocolHandleræ¥å¤„ç†è¯·æ±‚ï¼ŒProtocolHandleråŒ…å«ä¸‰ä¸ªéƒ¨ä»¶ï¼š</p>
<ul>
<li>Endpointï¼šç”¨æ¥å¤„ç†åº•å±‚çš„Scoketçš„ç½‘ç»œè¿æ¥ã€‚</li>
<li>Processorï¼šç”¨äºå°†Endpointæ¥æ”¶åˆ°çš„Socketå°è£…ä¸ºRequest</li>
<li>Adapterï¼šä½œä¸ºé€‚é…å™¨å°†Reqeustå°†ä¸ºServletRequestäº¤ç»™Containerè¿›è¡Œå…·ä½“çš„å¤„ç†ã€‚</li>
</ul>
<h3 id="Container"><a href="#Container" class="headerlink" title="Container"></a>Container</h3><img src="/blog/2020/04/30/tomcat%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/pic9.png" srcset="/blog/img/loading.gif" class>

<ul>
<li>Engineï¼šå¼•æ“ï¼Œåœ¨servler.xmlä¸­å®šä¹‰äº†ä¸€ä¸ªåä¸ºCatalinaçš„Englineï¼Œåªèƒ½æœ‰ä¸€ä¸ªã€‚</li>
<li>Hostï¼šç«™ç‚¹ã€è™šæ‹Ÿä¸»æœºï¼Œä¸€ä¸ªEnglineåŒ…å«å¤šä¸ªHostçš„è®¾è®¡ï¼Œä½¿å¾—ä¸€ä¸ªæœåŠ¡å™¨å®ä¾‹å¯ä»¥æ‰¿æ‹…å¤šä¸ªåŸŸåçš„æœåŠ¡ï¼Œæ˜¯å¾ˆçµæ´»çš„è®¾è®¡</li>
<li>Contextï¼šåº”ç”¨ï¼Œé»˜è®¤é…ç½®ä¸‹webappsä¸‹çš„æ¯ä¸ªç›®å½•éƒ½æ˜¯ä¸€ä¸ªåº”ç”¨ã€‚</li>
<li>Wrapperï¼šä¸€ä¸ªServletã€‚</li>
</ul>
<h2 id="tomcatå¯åŠ¨æµç¨‹"><a href="#tomcatå¯åŠ¨æµç¨‹" class="headerlink" title="tomcatå¯åŠ¨æµç¨‹"></a>tomcatå¯åŠ¨æµç¨‹</h2><p>tomcatç»„ä»¶çš„å¯åŠ¨æµç¨‹ï¼š</p>
<img src="/blog/2020/04/30/tomcat%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/pic1.png" srcset="/blog/img/loading.gif" class>

<h3 id="å…¥å£ç±»Bootstrap"><a href="#å…¥å£ç±»Bootstrap" class="headerlink" title="å…¥å£ç±»Bootstrap"></a>å…¥å£ç±»Bootstrap</h3><p>start.shä¼šæ‰§è¡Œcatalina.shï¼Œcatalina.shä¼šè°ƒç”¨Bootstrapç±»ä¸­çš„main()æ–¹æ³•ã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String args[])</span> </span>&#123;

    <span class="hljs-comment">//åˆå§‹åŒ–é˜¶æ®µ init()æ–¹æ³•</span>
    <span class="hljs-keyword">synchronized</span> (daemonLock) &#123;
        <span class="hljs-keyword">if</span> (daemon == <span class="hljs-keyword">null</span>) &#123;
            <span class="hljs-comment">// Don&#x27;t set daemon until init() has completed</span>
            Bootstrap bootstrap = <span class="hljs-keyword">new</span> Bootstrap();
            <span class="hljs-keyword">try</span> &#123;
                bootstrap.init();
            &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;
                handleThrowable(t);
                t.printStackTrace();
                <span class="hljs-keyword">return</span>;
            &#125;
            daemon = bootstrap;
        &#125; <span class="hljs-keyword">else</span> &#123;
            <span class="hljs-comment">// When running as a service the call to stop will be on a new</span>
            <span class="hljs-comment">// thread so make sure the correct class loader is used to</span>
            <span class="hljs-comment">// prevent a range of class not found exceptions.</span>
            Thread.currentThread().setContextClassLoader(daemon.catalinaLoader);
        &#125;
    &#125;

    <span class="hljs-comment">//è¿è¡Œé˜¶æ®µ start()</span>
    <span class="hljs-keyword">try</span> &#123;
        String command = <span class="hljs-string">&quot;start&quot;</span>;
        <span class="hljs-keyword">if</span> (args.length &gt; <span class="hljs-number">0</span>) &#123;
            command = args[args.length - <span class="hljs-number">1</span>];
        &#125;

        <span class="hljs-keyword">if</span> (command.equals(<span class="hljs-string">&quot;startd&quot;</span>)) &#123;
            args[args.length - <span class="hljs-number">1</span>] = <span class="hljs-string">&quot;start&quot;</span>;
            daemon.load(args);
            daemon.start();
        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (command.equals(<span class="hljs-string">&quot;stopd&quot;</span>)) &#123;
            args[args.length - <span class="hljs-number">1</span>] = <span class="hljs-string">&quot;stop&quot;</span>;
            daemon.stop();
        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (command.equals(<span class="hljs-string">&quot;start&quot;</span>)) &#123;
            daemon.setAwait(<span class="hljs-keyword">true</span>);
            daemon.load(args);
            daemon.start();
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">null</span> == daemon.getServer()) &#123;
                System.exit(<span class="hljs-number">1</span>);
            &#125;
        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (command.equals(<span class="hljs-string">&quot;stop&quot;</span>)) &#123;
            daemon.stopServer(args);
        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (command.equals(<span class="hljs-string">&quot;configtest&quot;</span>)) &#123;
            daemon.load(args);
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">null</span> == daemon.getServer()) &#123;
                System.exit(<span class="hljs-number">1</span>);
            &#125;
            System.exit(<span class="hljs-number">0</span>);
        &#125; <span class="hljs-keyword">else</span> &#123;
            log.warn(<span class="hljs-string">&quot;Bootstrap: command \&quot;&quot;</span> + command + <span class="hljs-string">&quot;\&quot; does not exist.&quot;</span>);
        &#125;
    &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;
        <span class="hljs-comment">// Unwrap the Exception for clearer error reporting</span>
        <span class="hljs-keyword">if</span> (t <span class="hljs-keyword">instanceof</span> InvocationTargetException &amp;&amp;
                t.getCause() != <span class="hljs-keyword">null</span>) &#123;
            t = t.getCause();
        &#125;
        handleThrowable(t);
        t.printStackTrace();
        System.exit(<span class="hljs-number">1</span>);
    &#125;
&#125;</code></pre>

<p>main()æ–¹æ³•é¦–å…ˆä¼šè°ƒç”¨init()æ–¹æ³•åŠstart()æ–¹æ³•ï¼Œinit()æ–¹æ³•ä¸­ä¼šé€šè¿‡åå°„åŠ è½½Catalinaã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;

    <span class="hljs-comment">//ç±»åŠ è½½å™¨åˆå§‹åŒ–</span>
    initClassLoaders();

    <span class="hljs-comment">//è®¾ç½®çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼Œæ¥è§£å†³æœ‰å¯èƒ½çš„ClassNotFoundExceptioné—®é¢˜</span>
    Thread.currentThread().setContextClassLoader(catalinaLoader);

    SecurityClassLoad.securityClassLoad(catalinaLoader);

    <span class="hljs-comment">// åŠ è½½å¯åŠ¨ç±»Catalinaå¹¶è°ƒç”¨å…¶process()æ–¹æ³•</span>
    <span class="hljs-keyword">if</span> (log.isDebugEnabled())
        log.debug(<span class="hljs-string">&quot;Loading startup class&quot;</span>);
    Class&lt;?&gt; startupClass = catalinaLoader.loadClass(<span class="hljs-string">&quot;org.apache.catalina.startup.Catalina&quot;</span>);
    Object startupInstance = startupClass.getConstructor().newInstance();

    <span class="hljs-comment">// è®¾ç½®å…±äº«ç±»åŠ è½½å™¨sharedLoader</span>
    <span class="hljs-keyword">if</span> (log.isDebugEnabled())
        log.debug(<span class="hljs-string">&quot;Setting startup class properties&quot;</span>);
    String methodName = <span class="hljs-string">&quot;setParentClassLoader&quot;</span>;
    Class&lt;?&gt; paramTypes[] = <span class="hljs-keyword">new</span> Class[<span class="hljs-number">1</span>];
    paramTypes[<span class="hljs-number">0</span>] = Class.forName(<span class="hljs-string">&quot;java.lang.ClassLoader&quot;</span>);
    Object paramValues[] = <span class="hljs-keyword">new</span> Object[<span class="hljs-number">1</span>];
    <span class="hljs-comment">// æŠŠsharedåŠ è½½å™¨ä¼ é€’ç»™catalina</span>
    paramValues[<span class="hljs-number">0</span>] = sharedLoader;
    Method method =
        startupInstance.getClass().getMethod(methodName, paramTypes);
    method.invoke(startupInstance, paramValues);

    catalinaDaemon = startupInstance;
&#125;</code></pre>

<p>start()æ–¹æ³•ä¸­ä¼šé€šè¿‡åå°„è°ƒç”¨Catalinaçš„startæ–¹æ³•ã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">start</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
    <span class="hljs-keyword">if</span> (catalinaDaemon == <span class="hljs-keyword">null</span>) &#123;
        init();
    &#125;

    Method method = catalinaDaemon.getClass().getMethod(<span class="hljs-string">&quot;start&quot;</span>, (Class [])<span class="hljs-keyword">null</span>);
    method.invoke(catalinaDaemon, (Object [])<span class="hljs-keyword">null</span>);
&#125;</code></pre>

<h3 id="Catalina"><a href="#Catalina" class="headerlink" title="Catalina"></a>Catalina</h3><p>Bootstrapçš„init()æ–¹æ³•ä¼šè°ƒç”¨åˆ°Catalinaçš„load()æ–¹æ³•ï¼Œload()æ–¹æ³•ä¸­ä¼šé€šè¿‡æ–‡ä»¶æµçš„æ–¹å¼åŠ è½½å„ç§æ–‡ä»¶åŠé…ç½®ä¿¡æ¯ï¼Œæœ€åè°ƒç”¨Serverçš„init()æ–¹æ³•ï¼ŒåŒæ ·çš„ï¼Œstart()æ–¹æ³•ä¸­ä¼šè°ƒç”¨Servlerçš„start()æ–¹æ³•ï¼Œè¿™é‡Œä¸åœ¨è¿›è¡Œè¯¦ç»†åˆ†æã€‚</p>
<h3 id="Server-1"><a href="#Server-1" class="headerlink" title="Server"></a>Server</h3><p>è¿™é‡Œä½¿ç”¨äº†æ¨¡ç‰ˆæ–¹æ³•è®¾è®¡æ¨¡å¼ï¼Œstart()æ–¹æ³•å°†è°ƒç”¨å­ç±»ä¸­çš„startInternal()æ–¹æ³•ã€‚StandardServerä¸­çš„startInternal()æ–¹æ³•ä¼šå¾ªç¯è°ƒç”¨æ‰€æœ‰çš„Serviceçš„start()æ–¹æ³•ï¼ŒåŒæ ·çš„initInternal()æ–¹æ³•ä¸­ä¹Ÿä¼šè°ƒç”¨æ‰€æœ‰Serviceçš„init()æ–¹æ³•ã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">startInternal</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> LifecycleException </span>&#123;

    fireLifecycleEvent(CONFIGURE_START_EVENT, <span class="hljs-keyword">null</span>);
    setState(LifecycleState.STARTING);

    globalNamingResources.start();

    <span class="hljs-comment">// Start our defined Services</span>
    <span class="hljs-keyword">synchronized</span> (servicesLock) &#123;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; services.length; i++) &#123;
            services[i].start();
        &#125;
    &#125;
&#125;</code></pre>

<h3 id="Service-1"><a href="#Service-1" class="headerlink" title="Service"></a>Service</h3><p>StandardServiceä¸­çš„startInternal()æ–¹æ³•ï¼Œè¯¥æ–¹æ³•é¦–å…ˆä¼šå¯åŠ¨å®¹å™¨ï¼Œç„¶åå¯åŠ¨çº¿ç¨‹æ‰§è¡Œå™¨ï¼Œè‡ªå®šä¹‰è¿æ¥å™¨ã€‚</p>
<pre><code class="hljs java"><span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">startInternal</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> LifecycleException </span>&#123;

    <span class="hljs-keyword">if</span>(log.isInfoEnabled())
        log.info(sm.getString(<span class="hljs-string">&quot;standardService.start.name&quot;</span>, <span class="hljs-keyword">this</span>.name));
    setState(LifecycleState.STARTING);

    <span class="hljs-comment">// é¦–å…ˆå¯åŠ¨çš„æ˜¯å®¹å™¨</span>
    <span class="hljs-keyword">if</span> (engine != <span class="hljs-keyword">null</span>) &#123;
        <span class="hljs-keyword">synchronized</span> (engine) &#123;
            engine.start();
        &#125;
    &#125;
    <span class="hljs-comment">// çº¿ç¨‹æ‰§è¡Œå™¨</span>
    <span class="hljs-keyword">synchronized</span> (executors) &#123;
        <span class="hljs-keyword">for</span> (Executor executor: executors) &#123;
            executor.start();
        &#125;
    &#125;

    mapperListener.start();

    <span class="hljs-comment">// å¯åŠ¨è‡ªå®šä¹‰çš„è¿æ¥å™¨</span>
    <span class="hljs-keyword">synchronized</span> (connectorsLock) &#123;
        <span class="hljs-keyword">for</span> (Connector connector: connectors) &#123;
            <span class="hljs-keyword">try</span> &#123;
                <span class="hljs-comment">// If it has already failed, don&#x27;t try and start it</span>
                <span class="hljs-keyword">if</span> (connector.getState() != LifecycleState.FAILED) &#123;
                    connector.start();
                &#125;
            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;
                log.error(sm.getString(
                        <span class="hljs-string">&quot;standardService.connector.startFailed&quot;</span>,
                        connector), e);
            &#125;
        &#125;
    &#125;
&#125;</code></pre>

<h2 id="tomcatçš„è¯·æ±‚å¤„ç†è¿‡ç¨‹"><a href="#tomcatçš„è¯·æ±‚å¤„ç†è¿‡ç¨‹" class="headerlink" title="tomcatçš„è¯·æ±‚å¤„ç†è¿‡ç¨‹"></a>tomcatçš„è¯·æ±‚å¤„ç†è¿‡ç¨‹</h2><ol>
<li>ç”¨æˆ·ç‚¹å‡»ç½‘é¡µå†…å®¹ï¼Œè¯·æ±‚è¢«å‘é€åˆ°æœ¬æœºç«¯å£8080ï¼Œè¢«åœ¨é‚£é‡Œç›‘å¬çš„Coyote HTTP/1.1 Connectorè·å¾—ã€‚</li>
<li>ConnectoræŠŠè¯¥è¯·æ±‚äº¤ç»™å®ƒæ‰€åœ¨çš„Serviceçš„Engineæ¥å¤„ç†ï¼Œå¹¶ç­‰å¾…Engineçš„å›åº”ã€‚</li>
<li>Engineè·å¾—è¯·æ±‚localhost/test/index.jspï¼ŒåŒ¹é…æ‰€æœ‰çš„è™šæ‹Ÿä¸»æœºHostã€‚</li>
<li>EngineåŒ¹é…åˆ°åä¸ºlocalhostçš„Hostï¼ˆå³ä½¿åŒ¹é…ä¸åˆ°ä¹ŸæŠŠè¯·æ±‚äº¤ç»™è¯¥Hostå¤„ç†ï¼Œå› ä¸ºè¯¥Hostè¢«å®šä¹‰ä¸ºè¯¥Engineçš„é»˜è®¤ä¸»æœºï¼‰ï¼Œåä¸ºlocalhostçš„Hostè·å¾—è¯·æ±‚/test/index.jspï¼ŒåŒ¹é…å®ƒæ‰€æ‹¥æœ‰çš„æ‰€æœ‰çš„Contextã€‚HoståŒ¹é…åˆ°è·¯å¾„ä¸º/testçš„Contextï¼ˆå¦‚æœåŒ¹é…ä¸åˆ°å°±æŠŠè¯¥è¯·æ±‚äº¤ç»™è·¯å¾„åä¸ºâ€œ â€çš„Contextå»å¤„ç†ï¼‰ã€‚</li>
<li>path=â€œ/testâ€çš„Contextè·å¾—è¯·æ±‚/index.jspï¼Œåœ¨å®ƒçš„mapping tableä¸­å¯»æ‰¾å‡ºå¯¹åº”çš„Servletã€‚ContextåŒ¹é…åˆ°URL PATTERNä¸º*.jspçš„Servlet,å¯¹åº”äºJspServletç±»ã€‚</li>
<li>æ„é€ HttpServletRequestå¯¹è±¡å’ŒHttpServletResponseå¯¹è±¡ï¼Œä½œä¸ºå‚æ•°è°ƒç”¨JspServletçš„doGet()æˆ–doPost()ã€‚æ‰§è¡Œä¸šåŠ¡é€»è¾‘ã€æ•°æ®å­˜å‚¨ç­‰ç¨‹åºã€‚</li>
<li>ContextæŠŠæ‰§è¡Œå®Œä¹‹åçš„HttpServletResponseå¯¹è±¡è¿”å›ç»™Hostã€‚</li>
<li>HostæŠŠHttpServletResponseå¯¹è±¡è¿”å›ç»™Engineã€‚</li>
<li>EngineæŠŠHttpServletResponseå¯¹è±¡è¿”å›Connectorã€‚</li>
<li>ConnectoræŠŠHttpServletResponseå¯¹è±¡è¿”å›ç»™å®¢æˆ·Browserã€‚</li>
</ol>
<h2 id="ç®¡é“æ¨¡å¼"><a href="#ç®¡é“æ¨¡å¼" class="headerlink" title="ç®¡é“æ¨¡å¼"></a>ç®¡é“æ¨¡å¼</h2><h3 id="ç®¡é“ä¸é˜€é—¨"><a href="#ç®¡é“ä¸é˜€é—¨" class="headerlink" title="ç®¡é“ä¸é˜€é—¨"></a>ç®¡é“ä¸é˜€é—¨</h3><p>åœ¨ä¸€ä¸ªæ¯”è¾ƒå¤æ‚çš„å¤§å‹ç³»ç»Ÿä¸­ï¼Œå¦‚æœä¸€ä¸ªå¯¹è±¡æˆ–æ•°æ®æµéœ€è¦è¿›è¡Œç¹æ‚çš„é€»è¾‘å¤„ç†ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©åœ¨ä¸€ä¸ªå¤§çš„ç»„ä»¶ä¸­ç›´æ¥å¤„ç†è¿™äº›ç¹æ‚çš„é€»è¾‘å¤„ç†ï¼Œè¿™ä¸ªæ–¹å¼è™½ç„¶è¾¾åˆ°ç›®çš„ï¼Œä½†æ˜¯æ‹“å±•æ€§å’Œå¯é‡ç”¨æ€§å·®ã€‚å› ä¸ºç‰µä¸€å‘è€ŒåŠ¨å…¨èº«ã€‚</p>
<p>ç®¡é“æ˜¯å°±åƒä¸€æ¡ç®¡é“æŠŠå¤šä¸ªå¯¹è±¡è¿æ¥èµ·æ¥ï¼Œæ•´ä½“çœ‹èµ·æ¥å°±åƒè‹¥å¹²ä¸ªé˜€é—¨åµŒå¥—åœ¨ç®¡é“ä¸­ï¼Œè€Œå¤„ç†é€»è¾‘æ”¾åœ¨é˜€é—¨ä¸Šã€‚å®ƒçš„ç»“æ„å’Œå®ç°æ˜¯éå¸¸å€¼å¾—æˆ‘ä»¬å­¦ä¹ å’Œå€Ÿé‰´çš„ã€‚</p>
<h3 id="ç®¡é“çš„å®ç°"><a href="#ç®¡é“çš„å®ç°" class="headerlink" title="ç®¡é“çš„å®ç°"></a>ç®¡é“çš„å®ç°</h3><p>é¦–å…ˆéœ€è¦å®šä¹‰é˜€é—¨æ¥å£ï¼Œé˜€é—¨æ¥å£ä¸­åŒ…å«ä¸‹ä¸€ä¸ªé˜€é—¨çš„å¼•ç”¨ï¼Œæ¯ä¸ªé˜€é—¨å®Œæˆè‡ªå·±çš„é€»è¾‘åå°†è°ƒç”¨ä¸‹ä¸€ä¸ªé˜€é—¨çš„æ–¹æ³•ï¼Œç›´åˆ°åŸºç¡€é˜€é—¨ï¼ŒåŸºç¡€é˜€é—¨çš„æ–¹æ³•ä¸­ä¸å†å¯¹ä¸‹ä¸€ä¸ªé˜€é—¨è¿›è¡Œè°ƒç”¨ã€‚ç®¡é“æ¥å£ä¸­ä¿å­˜æœ‰ç¬¬ä¸€ä¸ªé˜€é—¨åŠåŸºç¡€é˜€é—¨çš„å¼•ç”¨ï¼ŒåŸºç¡€é˜€é—¨çš„å°†ä½œä¸ºé˜€é—¨æ·»åŠ æ—¶çš„é¡ºåºæ¯”è¾ƒï¼Œç¬¬ä¸€ä¸ªé˜€é—¨å°†ç”¨äºç®¡é“è°ƒç”¨çš„å¼€å§‹ï¼Œç®¡é“è°ƒç”¨å¼€å§‹äºç¬¬ä¸€ä¸ªç®¡é“ï¼Œç»ˆæ­¢äºåŸºç¡€ç®¡é“ã€‚</p>
<p>ç®¡é“æ¥å£ï¼š</p>
<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Pipeline</span> </span>&#123;
    <span class="hljs-comment">//è·å–ç¬¬ä¸€ä¸ªé˜€é—¨</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Valve <span class="hljs-title">getFirst</span><span class="hljs-params">()</span></span>;
    <span class="hljs-function"><span class="hljs-keyword">public</span> Valve <span class="hljs-title">getBasic</span><span class="hljs-params">()</span></span>;
    <span class="hljs-comment">//è®¾ç½®é˜€é—¨</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setBasic</span><span class="hljs-params">(Valve valve)</span></span>;
    <span class="hljs-comment">//æ·»åŠ é˜€é—¨</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addVave</span><span class="hljs-params">(Valve valve)</span></span>;
&#125;</code></pre>

<p>é˜€é—¨æ¥å£</p>
<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Valve</span> </span>&#123;
    <span class="hljs-function"><span class="hljs-keyword">public</span> Valve <span class="hljs-title">getNext</span><span class="hljs-params">()</span></span>;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setNext</span><span class="hljs-params">(Valve valve)</span></span>;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">invoke</span><span class="hljs-params">(String handing)</span></span>;
&#125;</code></pre>

<p>ç®¡é“æ¥å£çš„å®ç°ï¼š</p>
<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StandardPipeline</span> <span class="hljs-keyword">implements</span>  <span class="hljs-title">Pipeline</span> </span>&#123;
    <span class="hljs-comment">//é˜€é—¨ï¼ˆéåŸºç¡€ï¼Œå®šä¹‰ä¸€ä¸ªfirstï¼‰</span>
    <span class="hljs-keyword">protected</span> Valve first = <span class="hljs-keyword">null</span>;
    <span class="hljs-comment">//åŸºç¡€é˜€é—¨</span>
    <span class="hljs-keyword">protected</span> Valve basic = <span class="hljs-keyword">null</span>;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Valve <span class="hljs-title">getBasic</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> basic;
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setBasic</span><span class="hljs-params">(Valve valve)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.basic=valve;
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Valve <span class="hljs-title">getFirst</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> first;
    &#125;

    <span class="hljs-comment">//æ·»åŠ é˜€é—¨ï¼Œé“¾å¼æ„å»ºé˜€é—¨çš„æ‰§è¡Œé¡ºåºï¼ˆå…ˆå®šåˆ¶ã€æœ€ååŸºç¡€é˜€é—¨ï¼‰</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addVave</span><span class="hljs-params">(Valve valve)</span> </span>&#123;
        <span class="hljs-keyword">if</span>(first == <span class="hljs-keyword">null</span>)&#123;
            first = valve;
            valve.setNext(basic);
        &#125;<span class="hljs-keyword">else</span>&#123;
            Valve current =first;
            <span class="hljs-keyword">while</span>(current !=<span class="hljs-keyword">null</span>)&#123;
                <span class="hljs-keyword">if</span>(current.getNext() == basic)&#123;
                    current.setNext(valve);
                    valve.setNext(basic);
                &#125;
                current = current.getNext();
            &#125;
        &#125;
    &#125;
&#125;</code></pre>

<p>åŸºç¡€é˜€é—¨</p>
<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StandardValve</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Valve</span> </span>&#123;
    <span class="hljs-keyword">protected</span>  Valve next =<span class="hljs-keyword">null</span>;
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Valve <span class="hljs-title">getNext</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> next;
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setNext</span><span class="hljs-params">(Valve valve)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.next =valve;
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">invoke</span><span class="hljs-params">(String request)</span> </span>&#123;
        System.out.println(<span class="hljs-string">&quot;åŸºç¡€é˜€é—¨å¤„ç†&quot;</span>);
    &#125;
&#125;</code></pre>

<p>ç¬¬ä¸€ä¸ªé˜€é—¨</p>
<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FirstValve</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Valve</span> </span>&#123;
    <span class="hljs-keyword">protected</span>  Valve next =<span class="hljs-keyword">null</span>;
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Valve <span class="hljs-title">getNext</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> next;
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setNext</span><span class="hljs-params">(Valve valve)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.next =valve;
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">invoke</span><span class="hljs-params">(String request)</span> </span>&#123;
        System.out.println(<span class="hljs-string">&quot;é˜€é—¨1å¤„ç†&quot;</span>);
        getNext().invoke(request);
    &#125;
&#125;</code></pre>

<p>ç¬¬äºŒä¸ªé˜€é—¨</p>
<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SecondValve</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Valve</span> </span>&#123;
    <span class="hljs-keyword">protected</span>  Valve next =<span class="hljs-keyword">null</span>;
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Valve <span class="hljs-title">getNext</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> next;
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setNext</span><span class="hljs-params">(Valve valve)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.next =valve;
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">invoke</span><span class="hljs-params">(String request)</span> </span>&#123;
        System.out.println(<span class="hljs-string">&quot;é˜€é—¨2å¤„ç†&quot;</span>);
        getNext().invoke(request);
    &#125;
&#125;</code></pre>

<p>æµ‹è¯•ç±»</p>
<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Demo</span> </span>&#123;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;
        String request =<span class="hljs-string">&quot;è¿™ä¸ªæ˜¯ä¸€ä¸ªServletè¯·æ±‚&quot;</span>;
        <span class="hljs-comment">//newå‡ºä¸€ä¸ªç®¡é“</span>
        StandardPipeline pipeline = <span class="hljs-keyword">new</span> StandardPipeline();
        <span class="hljs-comment">//ä¸‰ä¸ªé˜€é—¨(ä¸€ä¸ªåŸºç¡€ã€2ä¸ªå®šåˆ¶)</span>
        StandardValve standardValve = <span class="hljs-keyword">new</span> StandardValve();
        FirstValve firstValve = <span class="hljs-keyword">new</span> FirstValve();
        SecondValve secondValve = <span class="hljs-keyword">new</span> SecondValve();
        <span class="hljs-comment">//è®¾ç½®åŸºç¡€é˜€é—¨(å®šåˆ¶é˜€é—¨)</span>
        pipeline.setBasic(standardValve);
        <span class="hljs-comment">//è®¾ç½®éåŸºç¡€é˜€é—¨</span>
        pipeline.addVave(firstValve);
        pipeline.addVave(secondValve);
        <span class="hljs-comment">//è°ƒç”¨å¯¹è±¡ç®¡é“ä¸­çš„ç¬¬ä¸€ä¸ªé˜€é—¨</span>
        pipeline.getFirst().invoke(request);
    &#125;
&#125;</code></pre>

<h2 id="tomcatä¸­çš„ç®¡é“"><a href="#tomcatä¸­çš„ç®¡é“" class="headerlink" title="tomcatä¸­çš„ç®¡é“"></a>tomcatä¸­çš„ç®¡é“</h2><img src="/blog/2020/04/30/tomcat%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/pic3.png" srcset="/blog/img/loading.gif" class>

<p>å…¶ä¸­çš„Engineã€Hostã€Contextã€warpperåˆ†åˆ«å¯¹åº”StandardEngineValveã€StandardHostValveã€StandardContextValveã€StandardWrapperValveå››ç§é˜€é—¨ã€‚</p>
<h3 id="ç®¡é“å¤„ç†æµç¨‹"><a href="#ç®¡é“å¤„ç†æµç¨‹" class="headerlink" title="ç®¡é“å¤„ç†æµç¨‹"></a>ç®¡é“å¤„ç†æµç¨‹</h3><img src="/blog/2020/04/30/tomcat%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/pic4.png" srcset="/blog/img/loading.gif" class>

<p>æ¥æ”¶åˆ°è¯·æ±‚ååœ¨CoyoteAdapterçš„service()æ–¹æ³•ä¸­çš„<code>connector.getContainer().getPipeline().getFirst().invoke(request, response);</code>å°†è·å–ç®¡é“å¹¶å¼€å§‹é˜€é—¨çš„è°ƒç”¨è¿‡ç¨‹å¯¹reqeustã€responseè¿›è¡Œå¤„ç†ã€‚</p>
<p>StandardEngineValueç±»ä¸­çš„invoke()æ–¹æ³•ã€‚</p>
<pre><code class="hljs java"><span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">invoke</span><span class="hljs-params">(Request request, Response response)</span></span>
<span class="hljs-function">    <span class="hljs-keyword">throws</span> IOException, ServletException </span>&#123;

    <span class="hljs-comment">// æ‹¿åˆ°Englineä¸­åŒ…å«çš„host</span>
    Host host = request.getHost();
    <span class="hljs-keyword">if</span> (host == <span class="hljs-keyword">null</span>) &#123;
        response.sendError
            (HttpServletResponse.SC_BAD_REQUEST,
             sm.getString(<span class="hljs-string">&quot;standardEngine.noHost&quot;</span>,
                          request.getServerName()));
        <span class="hljs-keyword">return</span>;
    &#125;
    <span class="hljs-keyword">if</span> (request.isAsyncSupported()) &#123;
        request.setAsyncSupported(host.getPipeline().isAsyncSupported());
    &#125;

    <span class="hljs-comment">// å°†requestï¼Œresponseäº¤ç»™ä¸‹ä¸€ä¸ªé˜€é—¨</span>
    host.getPipeline().getFirst().invoke(request, response);

&#125;</code></pre>

<p>tomcatçš„Pipelineå¤„ç†æ˜¯è¿™æ ·çš„ï¼š</p>
<ol>
<li><p>åœ¨ç”Ÿäº§çº¿ä¸Šçš„ç¬¬ä¸€ä¸ªå·¥äººæ‹¿åˆ°ç”Ÿäº§åŸæ–™åï¼ŒäºŒè¯ä¸è¯´å°±äººç»™ä¸‹ä¸€ä¸ªå·¥äººï¼Œä¸‹ä¸€ä¸ªå·¥äººä¹Ÿæ˜¯ä¸€æ ·ç›´æ¥æ‰”ç»™ä¸‹ä¸€ä¸ªå·¥äººï¼Œç›´åˆ°æœ€åä¸€ä¸ªå·¥äººï¼Œè€Œæœ€åä¸€ä¸ªå·¥äººè¢«å®‰æ’ä¸ºä¸Šé¢æè¿‡çš„StandardValveï¼Œä»–è¦å®Œæˆçš„æ˜¯æŠŠç”Ÿäº§èµ„æ–™è¿ç»™è‡ªå·±æ‰€åœ¨åŒ…å«çš„containerçš„Pipelineä¸Šå»ã€‚â€¨</p>
</li>
<li><p>å››ä¸ªcontainerå°±ç›¸å½“äºæœ‰å››ä¸ªç”Ÿäº§çº¿ï¼ˆPipelineï¼‰ï¼Œå½“StandardWrapperValveæ‹¿åˆ°èµ„æºå¼€å§‹è°ƒç”¨servletï¼Œè¿”å›åï¼Œå†ä¸€æ­¥ä¸€æ­¥æŒ‰ç…§åˆšæ‰ä¸¢ç”Ÿäº§åŸæ–™æ˜¯çš„é¡ºåºçš„å€’åºä¸€æ¬¡æ‰§è¡Œã€‚</p>
</li>
</ol>
<h3 id="è‡ªå®šä¹‰tomcaté˜€é—¨"><a href="#è‡ªå®šä¹‰tomcaté˜€é—¨" class="headerlink" title="è‡ªå®šä¹‰tomcaté˜€é—¨"></a>è‡ªå®šä¹‰tomcaté˜€é—¨</h3><p>ç®¡é“æœºåˆ¶ç»™æˆ‘ä»¬å¸¦æ¥äº†æ›´å¥½çš„æ‹“å±•æ€§ï¼Œä¾‹å¦‚ï¼Œä½ è¦æ·»åŠ ä¸€ä¸ªé¢å¤–çš„é€»è¾‘å¤„ç†é˜€é—¨æ˜¯å¾ˆå®¹æ˜“çš„ã€‚è‡ªå®šä¹‰ä¸ªé˜€é—¨PrintIPValveï¼Œåªè¦ç»§æ‰¿ValveBaseå¹¶é‡å†™invokeæ–¹æ³•å³å¯ã€‚æ³¨æ„åœ¨invokeæ–¹æ³•ä¸­ä¸€å®šè¦æ‰§è¡Œè°ƒç”¨ä¸‹ä¸€ä¸ªé˜€é—¨çš„æ“ä½œï¼Œå¦åˆ™ä¼šå‡ºç°å¼‚å¸¸ã€‚</p>
<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PrintIPValve</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ValveBase</span></span>&#123;
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">invoke</span><span class="hljs-params">(Request request, Response response)</span> <span class="hljs-keyword">throws</span> IOException, ServletException </span>&#123;
        System.out.println(<span class="hljs-string">&quot;------è‡ªå®šä¹‰é˜€é—¨PrintIPValve:&quot;</span>+request.getRemoteAddr());
        getNext().invoke(request,response);
    &#125;
&#125;</code></pre>

<p>é…ç½®Tomcatçš„æ ¸å¿ƒé…ç½®æ–‡ä»¶server.xml,è¿™é‡ŒæŠŠé˜€é—¨é…ç½®åˆ°Engineå®¹å™¨ä¸‹ï¼Œä½œç”¨èŒƒå›´å°±æ˜¯æ•´ä¸ªå¼•æ“ï¼Œä¹Ÿå¯ä»¥æ ¹æ®ä½œç”¨èŒƒå›´é…ç½®åœ¨Hostæˆ–è€…æ˜¯Contextä¸‹</p>
<pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">Valve</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;org.apache.catalina.valves.PrintIPValve&quot;</span> /&gt;</span></code></pre>


<p>æºç ä¸­å¯ä»¥ç›´æ¥ç”Ÿæ•ˆï¼Œä½†æ˜¯å¦‚æœæ˜¯è¿è¡Œç‰ˆæœ¬ï¼Œå¯ä»¥å°†è¿™ä¸ªç±»å¯¼å‡ºæˆä¸€ä¸ªJaråŒ…æ”¾å…¥Tomcat/libç›®å½•ä¸‹ï¼Œä¹Ÿå¯ä»¥ç›´æ¥å°†.classæ–‡ä»¶æ‰“åŒ…è¿›catalina.jaråŒ…ä¸­ã€‚</p>
<h3 id="tomcatä¸­æä¾›å¸¸ç”¨çš„é˜€é—¨"><a href="#tomcatä¸­æä¾›å¸¸ç”¨çš„é˜€é—¨" class="headerlink" title="tomcatä¸­æä¾›å¸¸ç”¨çš„é˜€é—¨"></a>tomcatä¸­æä¾›å¸¸ç”¨çš„é˜€é—¨</h3><p>AccessLogValveï¼šè¯·æ±‚è®¿é—®æ—¥å¿—é˜€é—¨ï¼Œé€šè¿‡æ­¤é˜€é—¨å¯ä»¥è®°å½•æ‰€æœ‰å®¢æˆ·ç«¯çš„è®¿é—®æ—¥å¿—ï¼ŒåŒ…æ‹¬è¿œç¨‹ä¸»æœºIPï¼Œè¿œç¨‹ä¸»æœºåï¼Œè¯·æ±‚æ–¹æ³•ï¼Œè¯·æ±‚åè®®ï¼Œä¼šè¯IDï¼Œè¯·æ±‚æ—¶é—´ï¼Œå¤„ç†æ—¶é•¿ï¼Œæ•°æ®åŒ…å¤§å°ç­‰ã€‚å®ƒæä¾›ä»»æ„å‚æ•°åŒ–çš„é…ç½®ï¼Œå¯ä»¥é€šè¿‡ä»»æ„ç»„åˆæ¥å®šåˆ¶è®¿é—®æ—¥å¿—çš„æ ¼å¼ã€‚</p>
<p>JDBCAccessLogValveï¼šåŒæ ·æ˜¯è®°å½•è®¿é—®æ—¥å¿—çš„é˜€é—¨ï¼Œä½†æ˜¯å®ƒæœ‰åŠ©äºå°†è®¿é—®æ—¥å¿—é€šè¿‡JDBCæŒä¹…åŒ–åˆ°æ•°æ®åº“ä¸­ã€‚</p>
<p>ErrorReportValveï¼šè¿™æ˜¯ä¸€ä¸ªè®²é”™è¯¯ä»¥HTMLæ ¼å¼è¾“å‡ºçš„é˜€é—¨ã€‚</p>
<p>PersistentValveï¼šè¿™æ˜¯å¯¹æ¯ä¸€ä¸ªè¯·æ±‚çš„ä¼šè¯å®ç°æŒä¹…åŒ–çš„é˜€é—¨ã€‚</p>
<p>RemoteAddrValveï¼šè®¿é—®æ§åˆ¶é˜€é—¨ã€‚å¯ä»¥é€šè¿‡é…ç½®å†³å®šå“ªäº›IPå¯ä»¥è®¿é—®WEBåº”ç”¨ã€‚</p>
<p>RemoteHostValveï¼šè®¿é—®æ§åˆ¶é˜€é—¨ï¼Œé€šè¿‡é…ç½®è§‰å¾—å“ªäº›ä¸»æœºåå¯ä»¥è®¿é—®WEBåº”ç”¨ã€‚</p>
<p>RemoteIpValveï¼šé’ˆå¯¹ä»£ç†æˆ–è€…è´Ÿè½½å‡è¡¡å¤„ç†çš„ä¸€ä¸ªé˜€é—¨ï¼Œä¸€èˆ¬ç»è¿‡ä»£ç†æˆ–è€…è´Ÿè½½å‡è¡¡è½¬å‘çš„è¯·æ±‚éƒ½å°†è‡ªå·±çš„IPæ·»åŠ åˆ°è¯·æ±‚å¤´â€X-Forwarded-Forâ€ä¸­ï¼Œæ­¤æ—¶ï¼Œé€šè¿‡é˜€é—¨å¯ä»¥è·å–è®¿é—®è€…çœŸå®çš„IPã€‚</p>
<p>SemaphoreValveï¼šè¿™ä¸ªæ˜¯ä¸€ä¸ªæ§åˆ¶å®¹å™¨å¹¶å‘è®¿é—®çš„é˜€é—¨ï¼Œå¯ä»¥ä½œç”¨åœ¨ä¸åŒå®¹å™¨ä¸Šã€‚</p>
<h2 id="JVMä¸­çš„ç±»åŠ è½½æœºåˆ¶"><a href="#JVMä¸­çš„ç±»åŠ è½½æœºåˆ¶" class="headerlink" title="JVMä¸­çš„ç±»åŠ è½½æœºåˆ¶"></a>JVMä¸­çš„ç±»åŠ è½½æœºåˆ¶</h2><p><strong>ç±»åŠ è½½ï¼š</strong>ä¸»è¦æ˜¯å°†.classæ–‡ä»¶ä¸­çš„äºŒè¿›åˆ¶å­—èŠ‚è¯»å…¥åˆ°JVMä¸­</p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å› ä¸ºè¿™ä¸ªå®šä¹‰ï¼Œæ‰€ä»¥å¹¶æ²¡æœ‰è§„å®šä¸€å®šæ˜¯è¦ç£ç›˜åŠ è½½æ–‡ä»¶ï¼Œå¯ä»¥é€šè¿‡ç½‘ç»œï¼Œå†…å­˜ä»€ä¹ˆçš„åŠ è½½ã€‚åªè¦æ˜¯äºŒè¿›åˆ¶æµå­—èŠ‚æ•°æ®ï¼ŒJVMå°±å¯ä»¥åŠ è½½ã€‚</p>
<p><strong>ç±»åŠ è½½è¿‡ç¨‹ï¼š</strong></p>
<ol>
<li><p>é€šè¿‡ç±»çš„å…¨é™å®šåè·å–è¯¥ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµï¼›</p>
</li>
<li><p>å°†å­—èŠ‚æµæ‰€ä»£è¡¨çš„é™æ€ç»“æ„è½¬åŒ–ä¸ºæ–¹æ³•åŒºçš„è¿è¡Œæ—¶æ•°æ®ç»“æ„</p>
</li>
<li><p>åœ¨å†…å­˜ä¸­ç”Ÿæˆä¸€ä¸ªè¯¥ç±»çš„java.lang.Classå¯¹è±¡ï¼Œä½œä¸ºæ–¹æ³•åŒºè¿™ä¸ªç±»çš„å„ç§æ•°æ®çš„è®¿é—®å…¥å£</p>
</li>
</ol>
<p><strong>ç±»åŠ è½½å™¨</strong>ï¼š</p>
<p>JVMè®¾è®¡è€…æŠŠâ€œç±»åŠ è½½â€è¿™ä¸ªåŠ¨ä½œæ”¾åˆ°javaè™šæ‹Ÿæœºå¤–éƒ¨å»å®ç°ï¼Œä»¥ä¾¿è®©åº”ç”¨ç¨‹åºå†³å®šå¦‚ä½•è·å–æ‰€éœ€è¦çš„ç±»ã€‚å®ç°è¿™ä¸ªåŠ¨ä½œçš„ä»£ç æ¨¡å—æˆä¸ºâ€œç±»åŠ è½½å™¨â€</p>
<p><strong>ç±»çš„å”¯ä¸€æ€§ï¼š</strong></p>
<p>å¯¹äºä»»ä½•ä¸€ä¸ªç±»ï¼Œéƒ½éœ€è¦ç”±åŠ è½½å®ƒçš„ç±»åŠ è½½å™¨å’Œè¿™ä¸ªç±»æ¥ç¡®å®šå…¶åœ¨JVMä¸­çš„å”¯ä¸€æ€§ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸¤ä¸ªç±»æ¥æºäºåŒä¸€ä¸ªClassæ–‡ä»¶ï¼Œå¹¶ä¸”è¢«åŒä¸€ä¸ªç±»åŠ è½½å™¨åŠ è½½ï¼Œè¿™ä¸¤ä¸ªç±»æ‰ç›¸ç­‰ã€‚</p>
<p>æ³¨æ„ï¼šè¿™é‡Œæ‰€è°“çš„â€œç›¸ç­‰â€ï¼Œä¸€èˆ¬ä½¿ç”¨instanceofå…³é”®å­—åšåˆ¤æ–­ã€‚</p>
<p><strong>åŒäº²å§”æ´¾æ¨¡å‹ï¼š</strong></p>
<ul>
<li><p><strong>å®šä¹‰ï¼š</strong>åŒäº²å§”æ´¾æ¨¡å‹çš„å·¥ä½œè¿‡ç¨‹ä¸ºï¼šå¦‚æœä¸€ä¸ªç±»åŠ è½½å™¨æ”¶åˆ°äº†ç±»è¯·æ±‚ï¼Œå®ƒé¦–å…ˆä¸ä¼šè‡ªå·±å»å°è¯•åŠ è½½è¿™ä¸ªç±»ï¼Œè€Œæ˜¯æŠŠè¿™ä¸ªè¯·æ±‚å§”æ´¾ç»™çˆ¶åŠ è½½å™¨å»å®Œæˆï¼Œæ¯ä¸€å±‚éƒ½æ˜¯å¦‚æ­¤ï¼Œå› æ­¤æ‰€æœ‰ç±»åŠ è½½çš„è¯·æ±‚éƒ½ä¼šä¼ åˆ°å¯åŠ¨ç±»åŠ è½½å™¨ï¼Œåªæœ‰å½“çˆ¶åŠ è½½å™¨æ— æ³•å®Œæˆè¯¥è¯·æ±‚æ—¶ï¼Œå­åŠ è½½å™¨æ‰å»è‡ªå·±åŠ è½½ã€‚</p>
</li>
<li><p><strong>å®ç°æ–¹å¼ï¼š</strong>è¯¥æ¨¡å‹è¦æ±‚é™¤äº†é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨å¤–ï¼Œå…¶ä½™çš„ç±»åŠ è½½å™¨éƒ½åº”å½“æœ‰è‡ªå·±çš„çˆ¶ç±»åŠ è½½å™¨ã€‚å­ç±»åŠ è½½å™¨ä¸æ˜¯ä»¥ç»§æ‰¿çš„å…³ç³»æ¥å®ç°ï¼Œè€Œæ˜¯é€šè¿‡ç»„åˆå…³ç³»æ¥å¤ç”¨çˆ¶åŠ è½½å™¨çš„ä»£ç ã€‚</p>
</li>
<li><p><strong>æ„ä¹‰ï¼š</strong>å¥½å¤„åŒäº²å§”æ´¾æ¨¡å‹çš„å¥½å¤„å°±æ˜¯javaç±»éšç€å®ƒçš„ç±»åŠ è½½å™¨ä¸€èµ·å…·å¤‡äº†ä¸€ç§å¸¦æœ‰ä¼˜å…ˆçº§çš„å±‚æ¬¡å…³ç³»ã€‚ä¾‹å¦‚ï¼šObject,æ— è®ºé‚£ä¸ªç±»åŠ è½½å™¨å»åŠ è½½è¯¥ç±»ï¼Œæœ€ç»ˆéƒ½æ˜¯ç”±å¯åŠ¨ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½çš„ï¼Œå› æ­¤Objectç±»åœ¨ç¨‹åºçš„å„ç§ç±»åŠ è½½ç¯å¢ƒä¸­éƒ½æ˜¯ä¸€ä¸ªç±»ã€‚å¦‚æœä¸ç”¨æ”¹æ¨¡å‹ï¼Œé‚£ä¹ˆjava.lang.Objectç±»å­˜æ”¾åœ¨classpathä¸­ï¼Œé‚£ä¹ˆç³»ç»Ÿä¸­å°±ä¼šå‡ºç°å¤šä¸ªObjectç±»ï¼Œç¨‹åºå˜å¾—å¾ˆæ··ä¹±ã€‚</p>
</li>
</ul>
<h5 id="ç±»åŠ è½½å™¨çš„åˆ†ç±»ï¼š"><a href="#ç±»åŠ è½½å™¨çš„åˆ†ç±»ï¼š" class="headerlink" title="ç±»åŠ è½½å™¨çš„åˆ†ç±»ï¼š"></a>ç±»åŠ è½½å™¨çš„åˆ†ç±»ï¼š</h5><p>ä»è™šæ‹Ÿæœºçš„è§’åº¦æ¥è¯´ï¼Œæœ‰ä¸¤ç§ä¸åŒçš„ç±»åŠ è½½å™¨ï¼šä¸€ç§æ˜¯å¯åŠ¨ç±»åŠ è½½å™¨ï¼ˆBootstrap ClassLoaderï¼‰,è¯¥åŠ è½½å™¨ä½¿ç”¨C++è¯­è¨€å®ç°ï¼Œå±äºè™šæ‹Ÿæœºè‡ªèº«çš„ä¸€éƒ¨åˆ†ã€‚å¦ä¸€éƒ¨åˆ†å°±æ˜¯æ‰€æœ‰å…¶å®ƒçš„ç±»åŠ è½½å™¨ï¼Œè¿™äº›ç±»åŠ è½½å™¨æ˜¯ç”±Javaè¯­è¨€å®ç°ï¼Œç‹¬ç«‹äºJVMå¤–éƒ¨ï¼Œå¹¶ä¸”å…¨éƒ¨ç»§æ‰¿æŠ½è±¡ç±»java.lang.ClassLoader.</p>
<p>  ä»javaå¼€å‘äººå‘˜çš„è§’åº¦çœ‹ï¼Œå¤§éƒ¨åˆ†javaç¨‹åºä¼šç”¨åˆ°ä»¥ä¸‹ä¸‰ç§ç³»ç»Ÿæä¾›çš„ç±»åŠ è½½å™¨ï¼š</p>
<ol>
<li><p>å¯åŠ¨ç±»åŠ è½½å™¨ï¼ˆBootstrap ClassLoaderï¼‰:è´Ÿè´£åŠ è½½JAVA_HOME\libç›®å½•ä¸­å¹¶ä¸”èƒ½è¢«è™šæ‹Ÿæœºè¯†åˆ«çš„ç±»åº“åŠ è½½åˆ°JVMå†…å­˜ä¸­ï¼Œå¦‚æœåç§°ä¸ç¬¦åˆçš„ç±»åº“å³ä½¿åœ¨libç›®å½•ä¸­ä¹Ÿä¸ä¼šè¢«åŠ è½½ã€‚è¯¥ç±»åŠ è½½å™¨æ— æ³•è¢«javaç¨‹åºç›´æ¥å¼•ç”¨ã€‚</p>
</li>
<li><p>æ‰©å±•ç±»åŠ è½½å™¨(Extension ClassLoader):è¯¥åŠ è½½å™¨ä¸»è¦è´Ÿè´£åŠ è½½JAVA_HOME\lib\extç›®å½•ä¸­çš„ç±»åº“ï¼Œå¼€å‘è€…å¯ä»¥ä½¿ç”¨æ‰©å±•åŠ è½½å™¨ã€‚ </p>
</li>
<li><p>åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ï¼ˆApplication ClassLoaderï¼‰:è¯¥åˆ—åŠ è½½å™¨ä¹Ÿç§°ä¸ºç³»ç»ŸåŠ è½½å™¨ï¼Œå®ƒè´Ÿè´£åŠ è½½ç”¨æˆ·ç±»è·¯å¾„(Classpath)ä¸Šæ‰€æŒ‡å®šçš„ç±»åº“ï¼Œå¼€å‘è€…å¯ä»¥ç›´æ¥ä½¿ç”¨è¯¥ç±»åŠ è½½å™¨ï¼Œå¦‚æœåº”ç”¨ç¨‹åºä¸­æ²¡æœ‰è‡ªå®šä¹‰è¿‡è‡ªå·±çš„ç±»åŠ è½½å™¨ï¼Œä¸€èˆ¬æƒ…å†µä¸‹è¿™ä¸ªå°±æ˜¯ç¨‹åºä¸­é»˜è®¤çš„ç±»åŠ è½½å™¨ã€‚</p>
</li>
</ol>
<h2 id="tomcatç±»åŠ è½½çš„ç‰¹æ€§"><a href="#tomcatç±»åŠ è½½çš„ç‰¹æ€§" class="headerlink" title="tomcatç±»åŠ è½½çš„ç‰¹æ€§"></a>tomcatç±»åŠ è½½çš„ç‰¹æ€§</h2><p><strong>éš”ç¦»æ€§</strong>ï¼šWebåº”ç”¨ç±»åº“ç›¸äº’éš”ç¦»ï¼Œé¿å…ä¾èµ–åº“æˆ–è€…åº”ç”¨åŒ…ç›¸äº’å½±å“ï¼Œæ¯”å¦‚æœ‰ä¸¤ä¸ªWebåº”ç”¨ï¼Œä¸€ä¸ªé‡‡ç”¨äº†Spring 4ï¼Œä¸€ä¸ªé‡‡ç”¨äº†Spring 5ï¼Œå¦‚æœé‡‡ç”¨åŒä¸€ä¸ªç±»åŠ è½½å™¨ï¼ŒWebåº”ç”¨å°†ä¼šç”±äºjaråŒ…è¦†ç›–è€Œæ— æ³•å¯åŠ¨æˆåŠŸã€‚</p>
<p><strong>çµæ´»æ€§</strong>ï¼šWebåº”ç”¨ä¹‹é—´çš„ç±»åŠ è½½å™¨ç›¸äº’ç‹¬ç«‹ï¼Œå¦‚æœä¸€ä¸ªWebåº”ç”¨é‡æ–°éƒ¨ç½²æ—¶ï¼Œè¯¥åº”ç”¨çš„ç±»åŠ è½½å™¨é‡æ–°åŠ è½½ï¼Œä¸èƒ½å½±å“å…¶ä»–webåº”ç”¨ã€‚</p>
<p><strong>æ€§èƒ½</strong>ï¼šå¦‚æœåœ¨ä¸€ä¸ªTomcatéƒ¨ç½²å¤šä¸ªåº”ç”¨ï¼Œå¤šä¸ªåº”ç”¨ä¸­éƒ½æœ‰ç›¸åŒçš„ç±»åº“ä¾èµ–ã€‚é‚£ä¹ˆå¯ä»¥æŠŠè¿™ç›¸åŒçš„ç±»åº“è®©Commonç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½ã€‚</p>
<h2 id="tomcatä¸­çš„ç±»åŠ è½½å™¨"><a href="#tomcatä¸­çš„ç±»åŠ è½½å™¨" class="headerlink" title="tomcatä¸­çš„ç±»åŠ è½½å™¨"></a>tomcatä¸­çš„ç±»åŠ è½½å™¨</h2><img src="/blog/2020/04/30/tomcat%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/pic5.png" srcset="/blog/img/loading.gif" class>

<p>Tomcatæä¾›3ä¸ªåŸºç¡€ç±»åŠ è½½å™¨ï¼ˆcommonã€catalinaã€sharedï¼‰å’ŒWebåº”ç”¨ç±»åŠ è½½å™¨ã€‚</p>
<ul>
<li><strong>Common Loader</strong>ï¼šTomcatæœ€åŸºæœ¬çš„ç±»åŠ è½½å™¨ï¼ŒåŠ è½½<code>/common/*</code>è·¯å¾„ä¸­çš„classå¯ä»¥è¢«Tomcatå®¹å™¨æœ¬èº«ä»¥åŠå„ä¸ªWebappè®¿é—®ï¼›</li>
<li><strong>Catalina Loader</strong>ï¼šTomcatå®¹å™¨ç§æœ‰çš„ç±»åŠ è½½å™¨ï¼ŒåŠ è½½<code>/server/*</code>è·¯å¾„ä¸­çš„classå¯¹äºWebappä¸å¯è§ï¼›</li>
<li><strong>Shared Loader</strong>ï¼šå„ä¸ªWebappå…±äº«çš„ç±»åŠ è½½å™¨ï¼ŒåŠ è½½<code>/WebApp/WEB-INF/*</code>è·¯å¾„ä¸­çš„classå¯¹äºæ‰€æœ‰Webappå¯è§ï¼Œä½†æ˜¯å¯¹äºTomcatå®¹å™¨ä¸å¯è§ï¼›</li>
<li><strong>WebappClass Loader</strong>ï¼šå„ä¸ªWebappç§æœ‰çš„ç±»åŠ è½½å™¨ï¼ŒåŠ è½½è·¯å¾„ä¸­çš„classåªå¯¹å½“å‰Webappå¯è§ï¼›</li>
</ul>
<p>Tomcaté€šè¿‡Commonç±»åŠ è½½å™¨å®ç°äº†JaråŒ…åœ¨åº”ç”¨æœåŠ¡å™¨ä¸Webåº”ç”¨ä¹‹é—´çš„å…±äº«ï¼Œé€šè¿‡Sharedç±»åŠ è½½å™¨å®ç°äº†JaråŒ…åœ¨Webåº”ç”¨ä¹‹é—´çš„å…±äº«ï¼Œå†è¿‡Catalinaç±»åŠ è½½å™¨åŠ è½½æœåŠ¡å™¨ä¾èµ–çš„ç±»ã€‚</p>
<p>å½“åº”ç”¨éœ€è¦åˆ°æŸä¸ªç±»æ—¶ï¼Œåˆ™ä¼šæŒ‰ç…§ä¸‹é¢çš„é¡ºåºè¿›è¡Œç±»åŠ è½½</p>
<ol>
<li>ä½¿ç”¨BootStrap ClassLoaderåŠ è½½</li>
<li>ä½¿ç”¨systemç³»ç»Ÿç±»åŠ è½½å™¨åŠ è½½</li>
<li>ä½¿ç”¨Webapp ClassLoaderåœ¨WEB-INF/classesä¸­åŠ è½½</li>
<li>ä½¿ç”¨Webapp ClassLoaderåœ¨WEB-INF/libä¸­åŠ è½½</li>
<li>ä½¿ç”¨Common ClassLoaderåœ¨CATALINA_HOME/libä¸­åŠ è½½</li>
</ol>
<h3 id="ç±»åŠ è½½å™¨çš„åˆ›å»º"><a href="#ç±»åŠ è½½å™¨çš„åˆ›å»º" class="headerlink" title="ç±»åŠ è½½å™¨çš„åˆ›å»º"></a>ç±»åŠ è½½å™¨çš„åˆ›å»º</h3><p>3ä¸ªåŸºç¡€ç±»åŠ è½½å™¨çš„åŠ è½½è·¯å¾„åœ¨catalina.propertiesé…ç½®ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œ3ä¸ªåŸºç¡€ç±»åŠ è½½å™¨çš„å®ä¾‹éƒ½æ˜¯ä¸€ä¸ªã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;

    <span class="hljs-comment">//ç±»åŠ è½½å™¨åˆå§‹åŒ–</span>
    initClassLoaders();

    <span class="hljs-comment">//è®¾ç½®çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼Œæ¥è§£å†³æœ‰å¯èƒ½çš„ClassNotFoundExceptioné—®é¢˜</span>
    Thread.currentThread().setContextClassLoader(catalinaLoader);

    SecurityClassLoad.securityClassLoad(catalinaLoader);

    <span class="hljs-comment">// åŠ è½½å¯åŠ¨ç±»Catalinaå¹¶è°ƒç”¨å…¶process()æ–¹æ³•</span>
    <span class="hljs-keyword">if</span> (log.isDebugEnabled())
        log.debug(<span class="hljs-string">&quot;Loading startup class&quot;</span>);
    Class&lt;?&gt; startupClass = catalinaLoader.loadClass(<span class="hljs-string">&quot;org.apache.catalina.startup.Catalina&quot;</span>);
    Object startupInstance = startupClass.getConstructor().newInstance();

    <span class="hljs-comment">// è®¾ç½®å…±äº«ç±»åŠ è½½å™¨sharedLoader</span>
    <span class="hljs-keyword">if</span> (log.isDebugEnabled())
        log.debug(<span class="hljs-string">&quot;Setting startup class properties&quot;</span>);
    String methodName = <span class="hljs-string">&quot;setParentClassLoader&quot;</span>;
    Class&lt;?&gt; paramTypes[] = <span class="hljs-keyword">new</span> Class[<span class="hljs-number">1</span>];
    paramTypes[<span class="hljs-number">0</span>] = Class.forName(<span class="hljs-string">&quot;java.lang.ClassLoader&quot;</span>);
    Object paramValues[] = <span class="hljs-keyword">new</span> Object[<span class="hljs-number">1</span>];
    <span class="hljs-comment">// æŠŠsharedåŠ è½½å™¨ä¼ é€’ç»™catalina</span>
    paramValues[<span class="hljs-number">0</span>] = sharedLoader;
    Method method =
        startupInstance.getClass().getMethod(methodName, paramTypes);
    method.invoke(startupInstance, paramValues);

    catalinaDaemon = startupInstance;
&#125;</code></pre>

<h3 id="ç±»åŠ è½½å™¨åˆå§‹åŒ–"><a href="#ç±»åŠ è½½å™¨åˆå§‹åŒ–" class="headerlink" title="ç±»åŠ è½½å™¨åˆå§‹åŒ–"></a>ç±»åŠ è½½å™¨åˆå§‹åŒ–</h3><p>Bootstartpçš„initClassLoaders()æ–¹æ³•ä¼šåœ¨Boostrapçš„init()æ–¹æ³•ä¸­è°ƒç”¨ï¼Œåˆå§‹åŒ–ä¸‰ä¸ªç±»åŠ è½½å™¨ä»¥åŠç¡®å®šçˆ¶å­å…³ç³»ã€‚</p>
<pre><code class="hljs java"><span class="hljs-comment">//åˆå§‹åŒ–ä¸‰ä¸ªç±»åŠ è½½å™¨ä»¥åŠç¡®å®šçˆ¶å­å…³ç³»</span>
<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initClassLoaders</span><span class="hljs-params">()</span> </span>&#123;
    <span class="hljs-keyword">try</span> &#123;
        <span class="hljs-comment">// commonLoaderçš„åŠ è½½è·¯å¾„ä¸ºcommon.loader</span>
        commonLoader = createClassLoader(<span class="hljs-string">&quot;common&quot;</span>, <span class="hljs-keyword">null</span>);
        <span class="hljs-keyword">if</span> (commonLoader == <span class="hljs-keyword">null</span>) &#123;
            <span class="hljs-comment">// no config file, default to this loader - we might be in a &#x27;single&#x27; env.</span>
            commonLoader = <span class="hljs-keyword">this</span>.getClass().getClassLoader();
        &#125;
        <span class="hljs-comment">// åŠ è½½è·¯å¾„ä¸ºserver.loaderï¼Œé»˜è®¤ä¸ºç©ºï¼Œçˆ¶ç±»åŠ è½½å™¨ä¸ºcommonLoader</span>
        catalinaLoader = createClassLoader(<span class="hljs-string">&quot;server&quot;</span>, commonLoader);
        <span class="hljs-comment">// åŠ è½½è·¯å¾„ä¸ºshared.loaderï¼Œé»˜è®¤ä¸ºç©ºï¼Œçˆ¶ç±»åŠ è½½å™¨ä¸ºcommonLoader</span>
        sharedLoader = createClassLoader(<span class="hljs-string">&quot;shared&quot;</span>, commonLoader);
    &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;
        handleThrowable(t);
        log.error(<span class="hljs-string">&quot;Class loader creation threw exception&quot;</span>, t);
        System.exit(<span class="hljs-number">1</span>);
    &#125;
&#125;</code></pre>

<p>initClassLoaders()æ–¹æ³•ä¼šè°ƒç”¨createClassLoader()æ–¹æ³•ä¼šæ ¹æ®catalina.propertiesä¸­çš„å†…å®¹åˆ›å»ºå¯¹åº”çš„ç±»åŠ è½½å™¨ï¼Œå¦‚æœä¸ºç©ºåˆ™è¿”å›ä¼ å…¥çš„çˆ¶åŠ è½½å™¨ã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> ClassLoader <span class="hljs-title">createClassLoader</span><span class="hljs-params">(String name, ClassLoader parent)</span></span>
<span class="hljs-function">    <span class="hljs-keyword">throws</span> Exception </span>&#123;

    String value = CatalinaProperties.getProperty(name + <span class="hljs-string">&quot;.loader&quot;</span>);
    <span class="hljs-keyword">if</span> ((value == <span class="hljs-keyword">null</span>) || (value.equals(<span class="hljs-string">&quot;&quot;</span>)))
        <span class="hljs-keyword">return</span> parent;

    value = replace(value);

    List&lt;Repository&gt; repositories = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    String[] repositoryPaths = getPaths(value);

    <span class="hljs-keyword">for</span> (String repository : repositoryPaths) &#123;
        <span class="hljs-comment">// Check for a JAR URL repository</span>
        <span class="hljs-keyword">try</span> &#123;
            <span class="hljs-meta">@SuppressWarnings(&quot;unused&quot;)</span>
            URL url = <span class="hljs-keyword">new</span> URL(repository);
            repositories.add(<span class="hljs-keyword">new</span> Repository(repository, RepositoryType.URL));
            <span class="hljs-keyword">continue</span>;
        &#125; <span class="hljs-keyword">catch</span> (MalformedURLException e) &#123;
            <span class="hljs-comment">// Ignore</span>
        &#125;

        <span class="hljs-comment">// Local repository</span>
        <span class="hljs-keyword">if</span> (repository.endsWith(<span class="hljs-string">&quot;*.jar&quot;</span>)) &#123;
            repository = repository.substring
                (<span class="hljs-number">0</span>, repository.length() - <span class="hljs-string">&quot;*.jar&quot;</span>.length());
            repositories.add(<span class="hljs-keyword">new</span> Repository(repository, RepositoryType.GLOB));
        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (repository.endsWith(<span class="hljs-string">&quot;.jar&quot;</span>)) &#123;
            repositories.add(<span class="hljs-keyword">new</span> Repository(repository, RepositoryType.JAR));
        &#125; <span class="hljs-keyword">else</span> &#123;
            repositories.add(<span class="hljs-keyword">new</span> Repository(repository, RepositoryType.DIR));
        &#125;
    &#125;

    <span class="hljs-keyword">return</span> ClassLoaderFactory.createClassLoader(repositories, parent);
&#125;</code></pre>

<p>catalina.propertiesä¸­çš„å†…å®¹</p>
<pre><code class="hljs properties"><span class="hljs-meta">common.loader</span>=<span class="hljs-string">&quot;$&#123;catalina.base&#125;/lib&quot;,&quot;$&#123;catalina.base&#125;/lib/*.jar&quot;,&quot;$&#123;catalina.home&#125;/lib&quot;,&quot;$&#123;catalina.home&#125;/lib/*.jar&quot;</span>
<span class="hljs-meta">server.loader</span>=<span class="hljs-string"></span>
<span class="hljs-meta">shared.loader</span>=<span class="hljs-string"></span></code></pre>

<p>æ‰€ä»¥é»˜è®¤æƒ…å†µè¿™ä¸‰ä¸ªç±»åŠ è½½å™¨æ˜¯åŒä¸€ä¸ªå®ä¾‹ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹é…ç½®åˆ›å»º3ä¸ªä¸åŒçš„ç±»åŠ è½½æœºåˆ¶ï¼Œä½¿å®ƒä»¬å„å¸å…¶èŒï¼Œå¦‚æœä¸å¸Œæœ›è¿™äº›åŒ…å¯¹Webåº”ç”¨å¯è§ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é…ç½®server.loaderï¼Œåˆ›å»ºç‹¬ç«‹çš„Catalinaç±»åŠ è½½å™¨ã€‚</p>
<h3 id="ç±»åŠ è½½å·¥å‚"><a href="#ç±»åŠ è½½å·¥å‚" class="headerlink" title="ç±»åŠ è½½å·¥å‚"></a>ç±»åŠ è½½å·¥å‚</h3><p>å› ä¸ºç±»åŠ è½½éœ€è¦åšå¾ˆå¤šäº‹æƒ…ï¼Œæ¯”å¦‚è¯»å–å­—èŠ‚æ•°ç»„ã€éªŒè¯ã€è§£æã€åˆå§‹åŒ–ç­‰ã€‚Javaæä¾›çš„URLClassLoaderç±»èƒ½å¤Ÿæ–¹ä¾¿çš„å°†Jarã€Classæˆ–è€…ç½‘ç»œèµ„æºåŠ è½½åˆ°å†…å­˜ä¸­ã€‚Tomcatä¸­ä½¿ç”¨ä¸€ä¸ªå·¥å‚ç±»ï¼ŒClassLoaderFactoryæŠŠåˆ›å»ºç±»åŠ è½½å™¨çš„ç»†èŠ‚è¿›è¡Œå°è£…ï¼Œå¯ä»¥é€šè¿‡å®ƒæ–¹ä¾¿çš„åˆ›å»ºè‡ªå®šä¹‰ç±»åŠ è½½å™¨ã€‚</p>
<p>ä¸Šè¿°createClassLoader()æ–¹æ³•ä¸­çš„<code> return ClassLoaderFactory.createClassLoader(repositories, parent);</code>æ–¹æ³•å°±æ˜¯ä½¿ç”¨ç±»åŠ è½½å·¥å‚æ¥åˆ›å»ºç±»åŠ è½½å™¨ã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ClassLoader <span class="hljs-title">createClassLoader</span><span class="hljs-params">(List&lt;Repository&gt; repositories,</span></span>
<span class="hljs-function"><span class="hljs-params">                                            <span class="hljs-keyword">final</span> ClassLoader parent)</span></span>
<span class="hljs-function">    <span class="hljs-keyword">throws</span> Exception </span>&#123;

    <span class="hljs-keyword">if</span> (log.isDebugEnabled())
        log.debug(<span class="hljs-string">&quot;Creating new class loader&quot;</span>);

    <span class="hljs-comment">// Construct the &quot;class path&quot; for this class loader</span>
    Set&lt;URL&gt; set = <span class="hljs-keyword">new</span> LinkedHashSet&lt;&gt;();

    <span class="hljs-keyword">if</span> (repositories != <span class="hljs-keyword">null</span>) &#123;
        <span class="hljs-keyword">for</span> (Repository repository : repositories)  &#123;
            <span class="hljs-keyword">if</span> (repository.getType() == RepositoryType.URL) &#123;
                URL url = buildClassLoaderUrl(repository.getLocation());
                <span class="hljs-keyword">if</span> (log.isDebugEnabled())
                    log.debug(<span class="hljs-string">&quot;  Including URL &quot;</span> + url);
                set.add(url);
            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (repository.getType() == RepositoryType.DIR) &#123;
                File directory = <span class="hljs-keyword">new</span> File(repository.getLocation());
                directory = directory.getCanonicalFile();
                <span class="hljs-keyword">if</span> (!validateFile(directory, RepositoryType.DIR)) &#123;
                    <span class="hljs-keyword">continue</span>;
                &#125;
                URL url = buildClassLoaderUrl(directory);
                <span class="hljs-keyword">if</span> (log.isDebugEnabled())
                    log.debug(<span class="hljs-string">&quot;  Including directory &quot;</span> + url);
                set.add(url);
            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (repository.getType() == RepositoryType.JAR) &#123;
                File file=<span class="hljs-keyword">new</span> File(repository.getLocation());
                file = file.getCanonicalFile();
                <span class="hljs-keyword">if</span> (!validateFile(file, RepositoryType.JAR)) &#123;
                    <span class="hljs-keyword">continue</span>;
                &#125;
                URL url = buildClassLoaderUrl(file);
                <span class="hljs-keyword">if</span> (log.isDebugEnabled())
                    log.debug(<span class="hljs-string">&quot;  Including jar file &quot;</span> + url);
                set.add(url);
            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (repository.getType() == RepositoryType.GLOB) &#123;
                File directory=<span class="hljs-keyword">new</span> File(repository.getLocation());
                directory = directory.getCanonicalFile();
                <span class="hljs-keyword">if</span> (!validateFile(directory, RepositoryType.GLOB)) &#123;
                    <span class="hljs-keyword">continue</span>;
                &#125;
                <span class="hljs-keyword">if</span> (log.isDebugEnabled())
                    log.debug(<span class="hljs-string">&quot;  Including directory glob &quot;</span>
                        + directory.getAbsolutePath());
                String filenames[] = directory.list();
                <span class="hljs-keyword">if</span> (filenames == <span class="hljs-keyword">null</span>) &#123;
                    <span class="hljs-keyword">continue</span>;
                &#125;
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; filenames.length; j++) &#123;
                    String filename = filenames[j].toLowerCase(Locale.ENGLISH);
                    <span class="hljs-keyword">if</span> (!filename.endsWith(<span class="hljs-string">&quot;.jar&quot;</span>))
                        <span class="hljs-keyword">continue</span>;
                    File file = <span class="hljs-keyword">new</span> File(directory, filenames[j]);
                    file = file.getCanonicalFile();
                    <span class="hljs-keyword">if</span> (!validateFile(file, RepositoryType.JAR)) &#123;
                        <span class="hljs-keyword">continue</span>;
                    &#125;
                    <span class="hljs-keyword">if</span> (log.isDebugEnabled())
                        log.debug(<span class="hljs-string">&quot;    Including glob jar file &quot;</span>
                            + file.getAbsolutePath());
                    URL url = buildClassLoaderUrl(file);
                    set.add(url);
                &#125;
            &#125;
        &#125;
    &#125;

    <span class="hljs-comment">// Construct the class loader itself</span>
    <span class="hljs-keyword">final</span> URL[] array = set.toArray(<span class="hljs-keyword">new</span> URL[set.size()]);
    <span class="hljs-keyword">if</span> (log.isDebugEnabled())
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; array.length; i++) &#123;
            log.debug(<span class="hljs-string">&quot;  location &quot;</span> + i + <span class="hljs-string">&quot; is &quot;</span> + array[i]);
        &#125;

    <span class="hljs-keyword">return</span> AccessController.doPrivileged(
            <span class="hljs-keyword">new</span> PrivilegedAction&lt;URLClassLoader&gt;() &#123;
                <span class="hljs-meta">@Override</span>
                <span class="hljs-function"><span class="hljs-keyword">public</span> URLClassLoader <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;
                    <span class="hljs-keyword">if</span> (parent == <span class="hljs-keyword">null</span>)
                        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> URLClassLoader(array);
                    <span class="hljs-keyword">else</span>
                        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> URLClassLoader(array, parent);
                &#125;
            &#125;);
&#125;</code></pre>

<p>createClassLoader()æ–¹æ³•ä¼šä¾æ®RepositoryTypeæ¥æ‰§è¡Œä¸åŒçš„åˆ›å»ºæ–¹æ³•ã€‚</p>
<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">RepositoryType</span> </span>&#123;
    DIR, <span class="hljs-comment">//è¡¨ç¤ºæ•´ä¸ªç›®å½•ä¸‹çš„èµ„æºï¼ŒåŒ…æ‹¬æ‰€æœ‰Classã€jaråŒ…ä»¥åŠå…¶ä»–ç±»å‹èµ„æº</span>
    GLOB, <span class="hljs-comment">//è¡¨ç¤ºæ•´ä¸ªç›®å½•ä¸‹çš„æ‰€æœ‰jaråŒ…èµ„æº</span>
    JAR, <span class="hljs-comment">//è¡¨ç¤ºå•ä¸ªjaråŒ…èµ„æº</span>
    URL <span class="hljs-comment">//è¡¨ç¤ºä»URLä¸Šè·å–jaråŒ…èµ„æº</span>
&#125;</code></pre>

<p>ä½¿ç”¨åŠ è½½å™¨å·¥å‚çš„å¥½å¤„</p>
<ol>
<li>ClassLoadFactoryæœ‰ä¸€ä¸ªå†…éƒ¨Repositoryï¼Œå®ƒå°±æ˜¯è¡¨ç¤ºèµ„æºçš„ç±»ï¼Œèµ„æºçš„ç±»å‹ç”¨ä¸€ä¸ªRepositoryTypeçš„æšä¸¾è¡¨ç¤ºã€‚</li>
<li>åœ¨æ£€æŸ¥jaråŒ…çš„æ—¶å€™ï¼Œå¦‚æœæ£€æŸ¥çš„URLåœ°å€æœ‰å¼‚å¸¸å°±å¿½ç•¥æ‰ï¼Œå¯ä»¥ç¡®ä¿éƒ¨åˆ†ç±»åŠ è½½æ­£ç¡®ã€‚</li>
</ol>
<h3 id="ç±»åŠ è½½å™¨ç»‘å®šåˆ°çº¿ç¨‹"><a href="#ç±»åŠ è½½å™¨ç»‘å®šåˆ°çº¿ç¨‹" class="headerlink" title="ç±»åŠ è½½å™¨ç»‘å®šåˆ°çº¿ç¨‹"></a>ç±»åŠ è½½å™¨ç»‘å®šåˆ°çº¿ç¨‹</h3><p>JVMæä¾›äº†java.lang.Threadç±»çš„setContextClassLoaderæ–¹æ³•æ¥ç»‘å®šä¸€ä¸ªçº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼ˆThread Context ClassLoaderï¼‰ï¼Œç”¨äºåœ¨è¿è¡Œæ—¶åŠ¨æ€è½½å…¥å…¶ä»–ç±»ï¼Œå¦‚æœåˆ›å»ºçº¿ç¨‹æ—¶æœªè®¾ç½®ï¼Œå°†ä¼šä»çˆ¶çº¿ç¨‹ä¸­ç»§æ‰¿ä¸€ä¸ªï¼Œæ‰€ä»¥å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œéƒ½æ˜¯ç³»ç»Ÿé»˜è®¤çš„ContextClassLoadã€‚</p>
<p>ä¸€èˆ¬åœ¨å®é™…çš„ç³»ç»Ÿä¸Šï¼Œä½¿ç”¨çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼Œå¯ä»¥è®¾ç½®ä¸åŒçš„åŠ è½½æ–¹å¼ï¼Œè¿™ä¸ªä¹Ÿæ˜¯Javaçµæ´»çš„ç±»åŠ è½½æ–¹å¼çš„ä½“ç°ï¼Œä¹Ÿå¯ä»¥å¾ˆè½»æ¾çš„æ‰“ç ´åŒäº²å§”æ´¾æ¨¡å¼ï¼ŒåŒæ—¶ä¹Ÿä¼šé¿å…ç±»åŠ è½½çš„å¼‚å¸¸ã€‚</p>
<p>tomcatä¹Ÿä½¿ç”¨äº†è¿™ç§æ–¹å¼ï¼Œæ¥è§£å†³Commons ClassLoaderéœ€è¦Webapp ClassLoaderä¸­çš„ç±»çš„æƒ…å†µã€‚WebappLoaderåªä¼šåŠ è½½è‡ªå·±ç›®å½•ä¸‹çš„classæ–‡ä»¶ï¼Œä¸ä¼šä¼ é€’ç»™çˆ¶å®¹å™¨ï¼Œæ‰€ä»¥tomcatå°†Webapp ClassLoaderä¸çº¿ç¨‹ç»‘å®šï¼Œä½¿ç”¨çº¿ç¨‹ä¸Šä¸‹æ–‡åŠ è½½å™¨ï¼Œå¯ä»¥è®©çˆ¶ç±»åŠ è½½å™¨è¯·æ±‚å­ç±»åŠ è½½å™¨å»å®Œæˆç±»åŠ è½½çš„åŠ¨ä½œï¼Œä¸å¾—ä¸è¯´ï¼Œè¿™æ˜¯ä¸ªå·§å¦™çš„è®¾è®¡ã€‚</p>
<h3 id="tomcatçš„çƒ­åŠ è½½"><a href="#tomcatçš„çƒ­åŠ è½½" class="headerlink" title="tomcatçš„çƒ­åŠ è½½"></a>tomcatçš„çƒ­åŠ è½½</h3><p>StandardContext.startInternal()æ–¹æ³•ä¸­è¿˜ä¼šè°ƒç”¨threadStart()æ–¹æ³•ï¼ŒthreadStart()æ–¹æ³•å°†åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œè¿™ä¸ªçº¿ç¨‹çš„whileå¾ªç¯ä¸­ï¼Œä¸æ–­çš„è°ƒç”¨æ–¹æ³•ï¼Œç„¶åè¿›è¡Œç¡çœ ï¼Œä»¥è¿™ç§ç±»ä¼¼äºå®šæ—¶å™¨çš„æ–¹å¼ï¼Œæ¥æ‰§è¡Œä»»åŠ¡ï¼Œå¦‚é‡æ–°åŠ è½½ç­‰ã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">threadStart</span><span class="hljs-params">()</span> </span>&#123;

    <span class="hljs-keyword">if</span> (thread != <span class="hljs-keyword">null</span>)
        <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">if</span> (backgroundProcessorDelay &lt;= <span class="hljs-number">0</span>)
        <span class="hljs-keyword">return</span>;

    threadDone = <span class="hljs-keyword">false</span>;
    String threadName = <span class="hljs-string">&quot;ContainerBackgroundProcessor[&quot;</span> + toString() + <span class="hljs-string">&quot;]&quot;</span>;
    thread = <span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> ContainerBackgroundProcessor(), threadName);
    thread.setDaemon(<span class="hljs-keyword">true</span>);
    thread.start();

&#125;</code></pre>

<p>threadStart()æ–¹æ³•è°ƒç”¨é“¾æ¯”è¾ƒé•¿ï¼Œè¿™é‡Œåªåˆ†æWebappLoaderçš„backgroudProcess()æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å°†å®Œæˆç±»çš„é‡æ–°åŠ è½½ã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">backgroundProcess</span><span class="hljs-params">()</span> </span>&#123;
    <span class="hljs-keyword">if</span> (reloadable &amp;&amp; modified()) &#123;
        <span class="hljs-keyword">try</span> &#123;
            <span class="hljs-comment">//è®¾ç½®çº¿ç¨‹ç±»åŠ è½½å™¨çš„ç±»åŠ è½½å™¨WebappClassLoader</span>
            Thread.currentThread().setContextClassLoader
                (WebappLoader.class.getClassLoader());
            <span class="hljs-keyword">if</span> (context != <span class="hljs-keyword">null</span>) &#123;
                <span class="hljs-comment">//é‡æ–°åŠ è½½çš„æ–¹æ³•</span>
                context.reload();
            &#125;
        &#125; <span class="hljs-keyword">finally</span> &#123;
            <span class="hljs-keyword">if</span> (context != <span class="hljs-keyword">null</span> &amp;&amp; context.getLoader() != <span class="hljs-keyword">null</span>) &#123;
                Thread.currentThread().setContextClassLoader
                    (context.getLoader().getClassLoader());
            &#125;
        &#125;
    &#125;
&#125;</code></pre>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/blog/categories/tomcat/">tomcat</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/blog/tags/tomcat/">tomcat</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 åè®®</a> ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</p>
              
              
                <div class="post-prevnext row">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/blog/2020/05/06/tomcat%E5%B5%8C%E5%85%A5%E5%BC%8F%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">tomcatåµŒå…¥å¼ä¸æ€§èƒ½ä¼˜åŒ–</span>
                        <span class="visible-mobile">ä¸Šä¸€ç¯‡</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/blog/2020/04/30/tomcat%E4%BD%93%E7%B3%BB%E6%9E%B6%E6%9E%84/">
                        <span class="hidden-mobile">tomcatä½“ç³»æ¶æ„</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.staticfile.org/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":200})
    NProgress.start()
    document.addEventListener('DOMContentLoaded', function() {
      window.NProgress && window.NProgress.inc();
    })
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.staticfile.org/jquery/3.5.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.5.3/js/bootstrap.min.js" ></script>
<script  src="/blog/js/debouncer.js" ></script>
<script  src="/blog/js/events.js" ></script>
<script  src="/blog/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/blog/js/lazyload.js" ></script>
  



  



  <script  src="https://cdn.staticfile.org/tocbot/4.12.0/tocbot.min.js" ></script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>





  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/blog/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/blog/local-search.xml";
      var inputArea = document.querySelector("#local-search-input");
      inputArea.onclick = function () {
        searchFunc(path, 'local-search-input', 'local-search-result');
        this.onclick = null
      }
    })()
  </script>















<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ ä¿æŒåœ¨æœ€åº•éƒ¨ -->
<script  src="/blog/js/boot.js" ></script>



</body>
</html>
