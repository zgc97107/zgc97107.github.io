

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/blog/img/favicon.png">
  <link rel="icon" type="image/png" href="/blog/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="">
  <meta name="keywords" content="">
  <title>SpringMVCçš„è¯·æ±‚å“åº”åˆ†æ - ğŸğŸŠ&#39;s blog</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/blog/lib/hint/hint.min.css" />

  
    
    <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/github-gist.min.css" />
  

  


<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_6peoq002giu.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_pjno9b9zyxs.css">


<link  rel="stylesheet" href="/blog/css/main.css" />

<!-- è‡ªå®šä¹‰æ ·å¼ä¿æŒåœ¨æœ€åº•éƒ¨ -->


  <script  src="/blog/js/utils.js" ></script>
  <script  src="/blog/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 4.2.1"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/blog/">&nbsp;<strong>ğŸğŸŠ's blog</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/">
                <i class="iconfont icon-home-fill"></i>
                ä¸»é¡µ
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/archives/">
                <i class="iconfont icon-archive-fill"></i>
                å½’æ¡£
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/categories/">
                <i class="iconfont icon-category-fill"></i>
                åˆ†ç±»
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/tags/">
                <i class="iconfont icon-tags-fill"></i>
                æ ‡ç­¾
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/about/">
                <i class="iconfont icon-user-fill"></i>
                å…³äº
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax=true
         style="background: url('/blog/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container page-header text-center fade-in-up">
            <span class="h2" id="subtitle">
              
            </span>

            
              
  <div class="mt-3 post-meta">
    <i class="iconfont icon-date-fill" aria-hidden="true"></i>
    <time datetime="2020-04-21 14:50" pubdate>
      2020å¹´4æœˆ21æ—¥ ä¸‹åˆ
    </time>
  </div>


<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      3.4k å­—
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      53
       åˆ†é’Ÿ
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto" id="post">
            <!-- SEO header -->
            <h1 style="display: none">SpringMVCçš„è¯·æ±‚å“åº”åˆ†æ</h1>
            
            <div class="markdown-body" id="post-body">
              <h2 id="æ ¸å¿ƒæ–¹æ³•çš„å…¥å£"><a href="#æ ¸å¿ƒæ–¹æ³•çš„å…¥å£" class="headerlink" title="æ ¸å¿ƒæ–¹æ³•çš„å…¥å£"></a>æ ¸å¿ƒæ–¹æ³•çš„å…¥å£</h2><p>åœ¨servletè§„èŒƒä¸­ï¼Œå½“è¯·æ±‚åˆ°è¾¾servletæ—¶é¦–å…ˆä¼šè°ƒç”¨service()æ–¹æ³•ï¼Œæ­¤æ–¹æ³•ä¼šæ ¹æ®è¯·æ±‚çš„è¯·æ±‚å¤´è°ƒç”¨ä¸åŒçš„æ–¹æ³•ã€‚</p>
<p>DispatcherServletçˆ¶ç±»FrameworkServletä¸­çš„service()æ–¹æ³•æœ€ç»ˆéƒ½ä¼šè°ƒç”¨åˆ°processRequest()æ–¹æ³•ã€‚é€šè¿‡super.service()æ–¹å¼ä¼šè°ƒç”¨doPost()æˆ–è€…doGet()æ–¹æ³•ã€‚æœ¬ç±»ä¸­çš„doGet()ã€doPost()æ–¹æ³•ä¹Ÿä¼šè°ƒç”¨åˆ°processRequest()æ–¹æ³•ã€‚</p>
<pre><code class="hljs java">   <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">service</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span></span>
<span class="hljs-function">      <span class="hljs-keyword">throws</span> ServletException, IOException </span>&#123;

   HttpMethod httpMethod = HttpMethod.resolve(request.getMethod());
   <span class="hljs-keyword">if</span> (httpMethod == HttpMethod.PATCH || httpMethod == <span class="hljs-keyword">null</span>) &#123;
      processRequest(request, response);
   &#125;
   <span class="hljs-keyword">else</span> &#123;
      <span class="hljs-keyword">super</span>.service(request, response);
   &#125;
&#125;

	<span class="hljs-meta">@Override</span>
	<span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doGet</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span></span>
<span class="hljs-function">			<span class="hljs-keyword">throws</span> ServletException, IOException </span>&#123;

		processRequest(request, response);
	&#125;

	<span class="hljs-meta">@Override</span>
	<span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doPost</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span></span>
<span class="hljs-function">			<span class="hljs-keyword">throws</span> ServletException, IOException </span>&#123;

		processRequest(request, response);
	&#125;</code></pre>

<p>processRequest()æ–¹æ³•ï¼Œä¸»è¦é€»è¾‘ä¸ºè°ƒç”¨doService()æ–¹æ³•ã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">processRequest</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span></span>
<span class="hljs-function">      <span class="hljs-keyword">throws</span> ServletException, IOException </span>&#123;

   <span class="hljs-keyword">long</span> startTime = System.currentTimeMillis();
   Throwable failureCause = <span class="hljs-keyword">null</span>;

   LocaleContext previousLocaleContext = LocaleContextHolder.getLocaleContext();
   LocaleContext localeContext = buildLocaleContext(request);

   RequestAttributes previousAttributes = RequestContextHolder.getRequestAttributes();
   ServletRequestAttributes requestAttributes = buildRequestAttributes(request, response, previousAttributes);

   WebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request);
   asyncManager.registerCallableInterceptor(FrameworkServlet<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>(), <span class="hljs-title">new</span> <span class="hljs-title">RequestBindingInterceptor</span>())</span>;

   initContextHolders(request, localeContext, requestAttributes);

   <span class="hljs-keyword">try</span> &#123;
      doService(request, response);
   &#125;
   <span class="hljs-keyword">catch</span> (ServletException | IOException ex) &#123;
      failureCause = ex;
      <span class="hljs-keyword">throw</span> ex;
   &#125;
   <span class="hljs-keyword">catch</span> (Throwable ex) &#123;
      failureCause = ex;
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NestedServletException(<span class="hljs-string">"Request processing failed"</span>, ex);
   &#125;

   <span class="hljs-keyword">finally</span> &#123;
      resetContextHolders(request, previousLocaleContext, previousAttributes);
      <span class="hljs-keyword">if</span> (requestAttributes != <span class="hljs-keyword">null</span>) &#123;
         requestAttributes.requestCompleted();
      &#125;
      logResult(request, response, failureCause, asyncManager);
      publishRequestHandledEvent(request, response, startTime, failureCause);
   &#125;
&#125;</code></pre>

<p>doService()æ–¹æ³•ï¼Œè¯¥æ–¹æ³•åœ¨DispatcherServletä¸­å®ç°ï¼Œåœ¨è¿›è¡Œä¸€äº›å±æ€§çš„è®¾ç½®åå›åˆ°ç”¨åˆ°æ ¸å¿ƒæ–¹æ³•doDispatch()ã€‚</p>
<pre><code class="hljs java"><span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doService</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
   logRequest(request);

   <span class="hljs-comment">// Keep a snapshot of the request attributes in case of an include,</span>
   <span class="hljs-comment">// to be able to restore the original attributes after the include.</span>
   Map&lt;String, Object&gt; attributesSnapshot = <span class="hljs-keyword">null</span>;
   <span class="hljs-keyword">if</span> (WebUtils.isIncludeRequest(request)) &#123;
      attributesSnapshot = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();
      Enumeration&lt;?&gt; attrNames = request.getAttributeNames();
      <span class="hljs-keyword">while</span> (attrNames.hasMoreElements()) &#123;
         String attrName = (String) attrNames.nextElement();
         <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.cleanupAfterInclude || attrName.startsWith(DEFAULT_STRATEGIES_PREFIX)) &#123;
            attributesSnapshot.put(attrName, request.getAttribute(attrName));
         &#125;
      &#125;
   &#125;

   <span class="hljs-comment">// Make framework objects available to handlers and view objects.</span>
   request.setAttribute(WEB_APPLICATION_CONTEXT_ATTRIBUTE, getWebApplicationContext());
   request.setAttribute(LOCALE_RESOLVER_ATTRIBUTE, <span class="hljs-keyword">this</span>.localeResolver);
   request.setAttribute(THEME_RESOLVER_ATTRIBUTE, <span class="hljs-keyword">this</span>.themeResolver);
   request.setAttribute(THEME_SOURCE_ATTRIBUTE, getThemeSource());

   <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.flashMapManager != <span class="hljs-keyword">null</span>) &#123;
      FlashMap inputFlashMap = <span class="hljs-keyword">this</span>.flashMapManager.retrieveAndUpdate(request, response);
      <span class="hljs-keyword">if</span> (inputFlashMap != <span class="hljs-keyword">null</span>) &#123;
         request.setAttribute(INPUT_FLASH_MAP_ATTRIBUTE, Collections.unmodifiableMap(inputFlashMap));
      &#125;
      request.setAttribute(OUTPUT_FLASH_MAP_ATTRIBUTE, <span class="hljs-keyword">new</span> FlashMap());
      request.setAttribute(FLASH_MAP_MANAGER_ATTRIBUTE, <span class="hljs-keyword">this</span>.flashMapManager);
   &#125;

   <span class="hljs-keyword">try</span> &#123;
      <span class="hljs-comment">//è°ƒç”¨åˆ°æ ¸å¿ƒæµç¨‹</span>
      doDispatch(request, response);
   &#125;
   <span class="hljs-keyword">finally</span> &#123;
      <span class="hljs-keyword">if</span> (!WebAsyncUtils.getAsyncManager(request).isConcurrentHandlingStarted()) &#123;
         <span class="hljs-comment">// Restore the original attribute snapshot, in case of an include.</span>
         <span class="hljs-keyword">if</span> (attributesSnapshot != <span class="hljs-keyword">null</span>) &#123;
            restoreAttributesAfterInclude(request, attributesSnapshot);
         &#125;
      &#125;
   &#125;
&#125;</code></pre>

<h2 id="æ ¸å¿ƒæ–¹æ³•-doDispatch"><a href="#æ ¸å¿ƒæ–¹æ³•-doDispatch" class="headerlink" title="æ ¸å¿ƒæ–¹æ³•-doDispatch()"></a>æ ¸å¿ƒæ–¹æ³•-doDispatch()</h2><p>springmvcçš„è°ƒç”¨å…±åˆ†ä¸ƒä¸ªæ­¥éª¤</p>
<ol>
<li>é€šè¿‡getHandler()æ–¹æ³•è·å–åˆ°HandlerExecutionChainå¯¹è±¡ã€‚</li>
<li>è°ƒç”¨getHanlderAdapter()æ–¹æ³•æ ¹æ®HandlerExecutionChainå¯¹è±¡è·å–åˆ°HandlerAdapterå¯¹è±¡ã€‚</li>
<li>è°ƒç”¨applyPreHandle()æ–¹æ³•è¿›è¡Œå‰ç½®è¿‡æ»¤å™¨æ ¡éªŒï¼Œå¦‚æœä¸ºfalseç›´æ¥è¿”å›ã€‚</li>
<li>handle()æ–¹æ³•è¿›è¡Œå…·ä½“çš„ä¸šåŠ¡é€»è¾‘è°ƒç”¨ã€‚</li>
<li>è°ƒç”¨applyPostHandle()æ–¹æ³•æ‰§è¡Œä¸­ç½®è¿‡æ»¤å™¨æ–¹æ³•ã€‚</li>
<li>è°ƒç”¨processDispatchResult()è¿›è¡Œè§†å›¾æ¸²æŸ“ã€‚</li>
<li>è°ƒç”¨åç½®æ‹¦æˆªå™¨è¿›è¡Œæœ€åçš„æ”¶å°¾å·¥ä½œï¼Œä¸€èˆ¬æ˜¯èµ„æºé‡Šæ”¾ã€‚</li>
</ol>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doDispatch</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
   HttpServletRequest processedRequest = request;
   HandlerExecutionChain mappedHandler = <span class="hljs-keyword">null</span>;
   <span class="hljs-keyword">boolean</span> multipartRequestParsed = <span class="hljs-keyword">false</span>;

   <span class="hljs-comment">//å¼‚æ­¥ç®¡ç†</span>
   WebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request);

   <span class="hljs-keyword">try</span> &#123;
      ModelAndView mv = <span class="hljs-keyword">null</span>;
      Exception dispatchException = <span class="hljs-keyword">null</span>;

      <span class="hljs-keyword">try</span> &#123;
         <span class="hljs-comment">//æ–‡ä»¶ä¸Šä¼ </span>
         processedRequest = checkMultipart(request);
         multipartRequestParsed = (processedRequest != request);

         <span class="hljs-comment">//è¿™ä¸ªæ–¹æ³•å¾ˆé‡è¦ï¼Œé‡ç‚¹çœ‹</span>
         <span class="hljs-comment">// Determine handler for the current request.</span>
         mappedHandler = getHandler(processedRequest);
         <span class="hljs-keyword">if</span> (mappedHandler == <span class="hljs-keyword">null</span>) &#123;
            noHandlerFound(processedRequest, response);
            <span class="hljs-keyword">return</span>;
         &#125;

         <span class="hljs-comment">//è·å–è·ŸHandlerMethodåŒ¹é…çš„HandlerAdapterå¯¹è±¡</span>
         <span class="hljs-comment">// Determine handler adapter for the current request.</span>
         HandlerAdapter ha = getHandlerAdapter(mappedHandler.getHandler());

         <span class="hljs-comment">// Process last-modified header, if supported by the handler.</span>
         String method = request.getMethod();
         <span class="hljs-keyword">boolean</span> isGet = <span class="hljs-string">"GET"</span>.equals(method);
         <span class="hljs-keyword">if</span> (isGet || <span class="hljs-string">"HEAD"</span>.equals(method)) &#123;
            <span class="hljs-keyword">long</span> lastModified = ha.getLastModified(request, mappedHandler.getHandler());
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">new</span> ServletWebRequest(request, response).checkNotModified(lastModified) &amp;&amp; isGet) &#123;
               <span class="hljs-keyword">return</span>;
            &#125;
         &#125;

         <span class="hljs-comment">//å‰ç½®è¿‡æ»¤å™¨ï¼Œå¦‚æœä¸ºfalseåˆ™ç›´æ¥è¿”å›</span>
         <span class="hljs-keyword">if</span> (!mappedHandler.applyPreHandle(processedRequest, response)) &#123;
            <span class="hljs-keyword">return</span>;
         &#125;

         <span class="hljs-comment">//è°ƒç”¨åˆ°Controllerå…·ä½“æ–¹æ³•ï¼Œæ ¸å¿ƒæ–¹æ³•è°ƒç”¨ï¼Œé‡ç‚¹çœ‹çœ‹</span>
         <span class="hljs-comment">// Actually invoke the handler.</span>
         mv = ha.handle(processedRequest, response, mappedHandler.getHandler());

         <span class="hljs-keyword">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;
            <span class="hljs-keyword">return</span>;
         &#125;
        
         applyDefaultViewName(processedRequest, mv);
        <span class="hljs-comment">//ä¸­ç½®è¿‡æ»¤å™¨</span>
         mappedHandler.applyPostHandle(processedRequest, response, mv);
      &#125;
      <span class="hljs-keyword">catch</span> (Exception ex) &#123;
         dispatchException = ex;
      &#125;
      <span class="hljs-keyword">catch</span> (Throwable err) &#123;
         <span class="hljs-comment">// As of 4.3, we're processing Errors thrown from handler methods as well,</span>
         <span class="hljs-comment">// making them available for @ExceptionHandler methods and other scenarios.</span>
         dispatchException = <span class="hljs-keyword">new</span> NestedServletException(<span class="hljs-string">"Handler dispatch failed"</span>, err);
      &#125;
     <span class="hljs-comment">//è§†å›¾æ¸²æŸ“</span>
      processDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException);
   &#125;
   <span class="hljs-keyword">catch</span> (Exception ex) &#123;
      triggerAfterCompletion(processedRequest, response, mappedHandler, ex);
   &#125;
   <span class="hljs-keyword">catch</span> (Throwable err) &#123;
      triggerAfterCompletion(processedRequest, response, mappedHandler,
            <span class="hljs-keyword">new</span> NestedServletException(<span class="hljs-string">"Handler processing failed"</span>, err));
   &#125;
   <span class="hljs-keyword">finally</span> &#123;
      <span class="hljs-keyword">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;
         <span class="hljs-comment">// Instead of postHandle and afterCompletion</span>
         <span class="hljs-keyword">if</span> (mappedHandler != <span class="hljs-keyword">null</span>) &#123;
            mappedHandler.applyAfterConcurrentHandlingStarted(processedRequest, response);
         &#125;
      &#125;
      <span class="hljs-keyword">else</span> &#123;
         <span class="hljs-comment">// Clean up any resources used by a multipart request.</span>
         <span class="hljs-keyword">if</span> (multipartRequestParsed) &#123;
            cleanupMultipart(processedRequest);
         &#125;
      &#125;
   &#125;
&#125;</code></pre>

<h3 id="getHandler-æ–¹æ³•"><a href="#getHandler-æ–¹æ³•" class="headerlink" title="getHandler()æ–¹æ³•"></a>getHandler()æ–¹æ³•</h3><p>è¯¥æ–¹æ³•é¦–å…ˆä¼šé€šè¿‡getHandlerInternal()æ–¹æ³•è·å–åˆ°HandlerMethodå¯¹è±¡ï¼Œç„¶åè°ƒç”¨getHandlerExecutionChain()æ–¹æ³•åŒ¹é…æ‹¦æˆªå™¨å¹¶å°†åŒ¹é…åˆ°çš„æ‹¦æˆªå™¨è·ŸHandlerMethodå¯¹è±¡å°è£…ä¸ºHandlerExecutionChainå¯¹è±¡å¹¶è¿”å›ã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> HandlerExecutionChain <span class="hljs-title">getHandler</span><span class="hljs-params">(HttpServletRequest request)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
   <span class="hljs-comment">//æ ¹æ®è¯·æ±‚çš„uriæ‹¿åˆ°å¯¹åº”çš„HandlerMethodå¯¹è±¡</span>
   Object handler = getHandlerInternal(request);
   <span class="hljs-keyword">if</span> (handler == <span class="hljs-keyword">null</span>) &#123;
      handler = getDefaultHandler();
   &#125;
   <span class="hljs-keyword">if</span> (handler == <span class="hljs-keyword">null</span>) &#123;
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
   &#125;
   <span class="hljs-comment">// Bean name or resolved handler?</span>
   <span class="hljs-keyword">if</span> (handler <span class="hljs-keyword">instanceof</span> String) &#123;
      String handlerName = (String) handler;
      handler = obtainApplicationContext().getBean(handlerName);
   &#125;

   <span class="hljs-comment">//è·å–HandlerMethodå’Œè¿‡æ»¤å™¨é“¾çš„åŒ…è£…ç±»</span>
   HandlerExecutionChain executionChain = getHandlerExecutionChain(handler, request);

   <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;
      logger.trace(<span class="hljs-string">"Mapped to "</span> + handler);
   &#125;
   <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (logger.isDebugEnabled() &amp;&amp; !request.getDispatcherType().equals(DispatcherType.ASYNC)) &#123;
      logger.debug(<span class="hljs-string">"Mapped to "</span> + executionChain.getHandler());
   &#125;

   <span class="hljs-comment">//æ˜¯å¦æ˜¯è·¨åŸŸè¯·æ±‚,å°±æ˜¯æŸ¥çœ‹requestè¯·æ±‚å¤´ä¸­æ˜¯å¦æœ‰Originå±æ€§</span>
   <span class="hljs-keyword">if</span> (CorsUtils.isCorsRequest(request)) &#123;
      CorsConfiguration globalConfig = <span class="hljs-keyword">this</span>.corsConfigurationSource.getCorsConfiguration(request);
      CorsConfiguration handlerConfig = getCorsConfiguration(handler, request);
      CorsConfiguration config = (globalConfig != <span class="hljs-keyword">null</span> ? globalConfig.combine(handlerConfig) : handlerConfig);
      executionChain = getCorsHandlerExecutionChain(request, executionChain, config);
   &#125;

   <span class="hljs-keyword">return</span> executionChain;
&#125;</code></pre>

<h4 id="getHandlerInternal-æ–¹æ³•"><a href="#getHandlerInternal-æ–¹æ³•" class="headerlink" title="getHandlerInternal()æ–¹æ³•"></a>getHandlerInternal()æ–¹æ³•</h4><p>getHandlerInternal()æ–¹æ³•é¦–å…ˆä¼šä»è¯·æ±‚ä¸­è·å–uriï¼Œç„¶åè°ƒç”¨lookupHandlerMethod()æ–¹æ³•è·å–åˆ°HandlerMethodå¯¹è±¡ã€‚ç„¶åè°ƒç”¨createWithResolvedBean()æ–¹æ³•åˆ›å»ºHandlerMethodä¸­çš„beanã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> HandlerMethod <span class="hljs-title">getHandlerInternal</span><span class="hljs-params">(HttpServletRequest request)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
   <span class="hljs-comment">//ä»requestå¯¹è±¡ä¸­è·å–uriï¼Œ/common/query2</span>
   String lookupPath = getUrlPathHelper().getLookupPathForRequest(request);
   <span class="hljs-keyword">this</span>.mappingRegistry.acquireReadLock();
   <span class="hljs-keyword">try</span> &#123;
      <span class="hljs-comment">//æ ¹æ®uriä»æ˜ å°„å…³ç³»ä¸­æ‰¾åˆ°å¯¹åº”çš„HandlerMethodå¯¹è±¡</span>
      HandlerMethod handlerMethod = lookupHandlerMethod(lookupPath, request);
      <span class="hljs-comment">//æŠŠControllerç±»å®ä¾‹åŒ–</span>
      <span class="hljs-keyword">return</span> (handlerMethod != <span class="hljs-keyword">null</span> ? handlerMethod.createWithResolvedBean() : <span class="hljs-keyword">null</span>);
   &#125;
   <span class="hljs-keyword">finally</span> &#123;
      <span class="hljs-keyword">this</span>.mappingRegistry.releaseReadLock();
   &#125;
&#125;</code></pre>

<h5 id="lookupHandlerMethod-æ–¹æ³•"><a href="#lookupHandlerMethod-æ–¹æ³•" class="headerlink" title="lookupHandlerMethod()æ–¹æ³•"></a>lookupHandlerMethod()æ–¹æ³•</h5><p>è¯¥æ–¹æ³•ä¼šæ ¹æ®uriä»urlLookupä¸­è·å–åˆ°RequestMappingInfoçš„Listï¼Œç„¶åè°ƒç”¨addMatchingMappings()æ–¹æ³•æ ¹æ®requestçš„ä¿¡æ¯è·Ÿ@ReqeustMapingä¸­çš„ä¿¡æ¯å¯¹HandlerMethodè¿›è¡ŒåŒ¹é…ï¼Œæœ€åå°†åŒ¹é…åçš„RequestMappingInfoå¯¹è±¡å’ŒåŒ¹é…åˆ°çš„HandlerMethodå¯¹è±¡å°è£…åˆ°Matchå¯¹è±¡ä¸­ã€‚æœ€åè¿”å›HandlerMethodå¯¹è±¡ã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> HandlerMethod <span class="hljs-title">lookupHandlerMethod</span><span class="hljs-params">(String lookupPath, HttpServletRequest request)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
   List&lt;Match&gt; matches = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
   List&lt;T&gt; directPathMatches = <span class="hljs-keyword">this</span>.mappingRegistry.getMappingsByUrl(lookupPath);
   <span class="hljs-keyword">if</span> (directPathMatches != <span class="hljs-keyword">null</span>) &#123;
      addMatchingMappings(directPathMatches, matches, request);
   &#125;
   <span class="hljs-keyword">if</span> (matches.isEmpty()) &#123;
      <span class="hljs-comment">// No choice but to go through all mappings...</span>
      addMatchingMappings(<span class="hljs-keyword">this</span>.mappingRegistry.getMappings().keySet(), matches, request);
   &#125;

   <span class="hljs-keyword">if</span> (!matches.isEmpty()) &#123;
      Comparator&lt;Match&gt; comparator = <span class="hljs-keyword">new</span> MatchComparator(getMappingComparator(request));
      matches.sort(comparator);
      Match bestMatch = matches.get(<span class="hljs-number">0</span>);
      <span class="hljs-keyword">if</span> (matches.size() &gt; <span class="hljs-number">1</span>) &#123;
         <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;
            logger.trace(matches.size() + <span class="hljs-string">" matching mappings: "</span> + matches);
         &#125;
         <span class="hljs-keyword">if</span> (CorsUtils.isPreFlightRequest(request)) &#123;
            <span class="hljs-keyword">return</span> PREFLIGHT_AMBIGUOUS_MATCH;
         &#125;
         Match secondBestMatch = matches.get(<span class="hljs-number">1</span>);
         <span class="hljs-comment">//å¦‚æœä¸¤ä¸ªRequestMappinginfoä»€ä¹ˆéƒ½ç›¸åŒï¼ŒæŠ¥é”™</span>
         <span class="hljs-keyword">if</span> (comparator.compare(bestMatch, secondBestMatch) == <span class="hljs-number">0</span>) &#123;
            Method m1 = bestMatch.handlerMethod.getMethod();
            Method m2 = secondBestMatch.handlerMethod.getMethod();
            String uri = request.getRequestURI();
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(
                  <span class="hljs-string">"Ambiguous handler methods mapped for '"</span> + uri + <span class="hljs-string">"': &#123;"</span> + m1 + <span class="hljs-string">", "</span> + m2 + <span class="hljs-string">"&#125;"</span>);
         &#125;
      &#125;
      request.setAttribute(BEST_MATCHING_HANDLER_ATTRIBUTE, bestMatch.handlerMethod);
      handleMatch(bestMatch.mapping, lookupPath, request);
      <span class="hljs-keyword">return</span> bestMatch.handlerMethod;
   &#125;
   <span class="hljs-keyword">else</span> &#123;
      <span class="hljs-keyword">return</span> handleNoMatch(<span class="hljs-keyword">this</span>.mappingRegistry.getMappings().keySet(), lookupPath, request);
   &#125;
&#125;</code></pre>

<h5 id="createWithResolvedBean-æ–¹æ³•"><a href="#createWithResolvedBean-æ–¹æ³•" class="headerlink" title="createWithResolvedBean()æ–¹æ³•"></a>createWithResolvedBean()æ–¹æ³•</h5><p>æ³¨æ„ï¼šæ­¤æ–¹æ³•ä¼šé‡æ–°åˆ›å»ºä¸€ä¸ªHandlerMethodå¯¹è±¡è¿”å›ï¼ŒåŸæœ‰å¯¹è±¡ä¸ä¼šè¿›è¡Œä¿®æ”¹ã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> HandlerMethod <span class="hljs-title">createWithResolvedBean</span><span class="hljs-params">()</span> </span>&#123;
    Object handler = <span class="hljs-keyword">this</span>.bean;
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.bean <span class="hljs-keyword">instanceof</span> String) &#123;
        Assert.state(<span class="hljs-keyword">this</span>.beanFactory != <span class="hljs-keyword">null</span>, <span class="hljs-string">"Cannot resolve bean name without BeanFactory"</span>);
        String beanName = (String)<span class="hljs-keyword">this</span>.bean;
        handler = <span class="hljs-keyword">this</span>.beanFactory.getBean(beanName);
    &#125;

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> HandlerMethod(<span class="hljs-keyword">this</span>, handler);
&#125;</code></pre>

<h4 id="getHandlerExecutionChain-æ–¹æ³•"><a href="#getHandlerExecutionChain-æ–¹æ³•" class="headerlink" title="getHandlerExecutionChain()æ–¹æ³•"></a>getHandlerExecutionChain()æ–¹æ³•</h4><p>è¯¥æ–¹æ³•é¦–å…ˆä¼šå°†HandlerMethodå¯¹è±¡åŒ…è£…åˆ°HandlerExecutionChainå¯¹è±¡ä¸­ï¼Œç„¶åæ ¹æ®uriè·å–åˆ°åŒ¹é…çš„æ‹¦æˆªå™¨åŠ å…¥åˆ°HandlerExecutionChainå¯¹è±¡ä¸­ã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> HandlerExecutionChain <span class="hljs-title">getHandlerExecutionChain</span><span class="hljs-params">(Object handler, HttpServletRequest request)</span> </span>&#123;
   <span class="hljs-comment">//æŠŠHandlerMethodå¯¹è±¡åŒ…è£…åˆ°HandlerExecutionChainå¯¹è±¡ä¸­ï¼Œè¿™ä¸ªå¯¹è±¡ä¸­æœ‰è¿‡æ»¤å™¨å¯¹è±¡</span>
   HandlerExecutionChain chain = (handler <span class="hljs-keyword">instanceof</span> HandlerExecutionChain ?
         (HandlerExecutionChain) handler : <span class="hljs-keyword">new</span> HandlerExecutionChain(handler));

   <span class="hljs-comment">//è·å–uri</span>
   String lookupPath = <span class="hljs-keyword">this</span>.urlPathHelper.getLookupPathForRequest(request);

   <span class="hljs-comment">//æ˜¯å¦æœ‰è¿‡æ»¤å™¨</span>
   <span class="hljs-keyword">for</span> (HandlerInterceptor interceptor : <span class="hljs-keyword">this</span>.adaptedInterceptors) &#123;
      <span class="hljs-keyword">if</span> (interceptor <span class="hljs-keyword">instanceof</span> MappedInterceptor) &#123;
         MappedInterceptor mappedInterceptor = (MappedInterceptor) interceptor;
         <span class="hljs-keyword">if</span> (mappedInterceptor.matches(lookupPath, <span class="hljs-keyword">this</span>.pathMatcher)) &#123;
            chain.addInterceptor(mappedInterceptor.getInterceptor());
         &#125;
      &#125;
      <span class="hljs-keyword">else</span> &#123;
         chain.addInterceptor(interceptor);
      &#125;
   &#125;
   <span class="hljs-keyword">return</span> chain;
&#125;</code></pre>

<p>æ ¹æ®requestå¯¹è±¡è·å–handlerMappingå¯¹è±¡ï¼Œç„¶åæ ¹æ®handlerMappingå¯¹è±¡è·å–åŒ¹é…çš„HandlerAdapterå¯¹è±¡ï¼ŒpreHandleè¿‡æ»¤å™¨ï¼Œç„¶åhandleræ–¹æ³•ä¼šè°ƒç”¨åˆ°controllerä¸­çš„å…·ä½“æ–¹æ³•ï¼Œç„¶åä¸­ç½®postHandlerè¿‡æ»¤å™¨ï¼Œè¯•å›¾æ¸²æŸ“ï¼Œrendlerï¼ŒafterCompletionåç½®è¿‡æ»¤å™¨ã€‚</p>
<h3 id="getHandlerAdapter-æ–¹æ³•"><a href="#getHandlerAdapter-æ–¹æ³•" class="headerlink" title="getHandlerAdapter()æ–¹æ³•"></a>getHandlerAdapter()æ–¹æ³•</h3><p>ä¼šå¾ªç¯HandlerExecutionChainå¯¹è±¡ï¼Œæ‰¾åˆ°åˆé€‚çš„HandlerAdapterå¯¹è±¡ï¼Œè¿™é‡Œç”¨åˆ°äº†ç­–ç•¥æ¨¡å¼ã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> HandlerAdapter <span class="hljs-title">getHandlerAdapter</span><span class="hljs-params">(Object handler)</span> <span class="hljs-keyword">throws</span> ServletException </span>&#123;
   <span class="hljs-comment">//æ ¹æ®handlerMethodå¯¹è±¡ï¼Œæ‰¾åˆ°åˆé€‚çš„HandlerAdapterå¯¹è±¡ï¼Œè¿™é‡Œç”¨åˆ°äº†ç­–ç•¥æ¨¡å¼</span>
   <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.handlerAdapters != <span class="hljs-keyword">null</span>) &#123;
      <span class="hljs-keyword">for</span> (HandlerAdapter adapter : <span class="hljs-keyword">this</span>.handlerAdapters) &#123;
         <span class="hljs-keyword">if</span> (adapter.supports(handler)) &#123;
            <span class="hljs-keyword">return</span> adapter;
         &#125;
      &#125;
   &#125;
   <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ServletException(<span class="hljs-string">"No adapter for handler ["</span> + handler +
         <span class="hljs-string">"]: The DispatcherServlet configuration needs to include a HandlerAdapter that supports this handler"</span>);
&#125;</code></pre>

<h3 id="applyPreHandle-æ–¹æ³•"><a href="#applyPreHandle-æ–¹æ³•" class="headerlink" title="applyPreHandle()æ–¹æ³•"></a>applyPreHandle()æ–¹æ³•</h3><p>è¯¥æ–¹æ³•ä¼šè°ƒç”¨HandlerExecutionChainä¸­æ‰€æœ‰æ‹¦æˆªå™¨çš„preHandle()æ–¹æ³•ï¼Œå¦‚æœä¸ºfalseç›´æ¥è¿”å›ï¼Œè°ƒç”¨è¿‡ç¨‹ä¸­ä¼šä½¿ç”¨interceptorIndexè®°å½•æ‹¦æˆªå™¨çš„ä¸‹æ ‡ã€‚å¸¸ç”¨æ¥è¿›è¡Œä¸€äº›æƒé™æ ¡éªŒæ“ä½œã€‚</p>
<pre><code class="hljs reasonml">boolean apply<span class="hljs-constructor">PreHandle(HttpServletRequest <span class="hljs-params">request</span>, HttpServletResponse <span class="hljs-params">response</span>)</span> throws Exception &#123;
   HandlerInterceptor<span class="hljs-literal">[]</span> interceptors = get<span class="hljs-constructor">Interceptors()</span>;
   <span class="hljs-keyword">if</span> (!<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ObjectUtils</span>.</span></span>is<span class="hljs-constructor">Empty(<span class="hljs-params">interceptors</span>)</span>) &#123;
      for (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; interceptors.length; i++) &#123;
         HandlerInterceptor interceptor = interceptors<span class="hljs-literal">[<span class="hljs-identifier">i</span>]</span>;
         <span class="hljs-keyword">if</span> (!interceptor.pre<span class="hljs-constructor">Handle(<span class="hljs-params">request</span>, <span class="hljs-params">response</span>, <span class="hljs-params">this</span>.<span class="hljs-params">handler</span>)</span>) &#123;
            trigger<span class="hljs-constructor">AfterCompletion(<span class="hljs-params">request</span>, <span class="hljs-params">response</span>, <span class="hljs-params">null</span>)</span>;
            return <span class="hljs-literal">false</span>;
         &#125;
         this.interceptorIndex = i;
      &#125;
   &#125;
   return <span class="hljs-literal">true</span>;
&#125;</code></pre>

<h3 id="handle-æ–¹æ³•"><a href="#handle-æ–¹æ³•" class="headerlink" title="handle()æ–¹æ³•"></a>handle()æ–¹æ³•</h3><p>æœ€ç»ˆä¼šè°ƒç”¨åˆ°invokeHandlerMethod()æ–¹æ³•ï¼Œè¿™é‡Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨invokeAndHandle()æ–¹æ³•ã€‚ä½†è¦æ³¨æ„ï¼Œæœ¬æ–¹æ³•ä¸­æ¯æ¬¡åˆ›å»ºä¸€ä¸ªModelAndViewContainerå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡ç”¨äºå¯¹@ModelAttributeæ³¨è§£æ–¹æ³•çš„å¤„ç†ï¼Œå¹¶æŠŠæ–¹æ³•è¿”å›å€¼ä¼ å…¥åˆ°ModelAndViewContainerçš„Mapä¸­ï¼Œç”¨äºæ¥æ¥ä¸‹è¿›è¡Œçš„å‚æ•°åˆ—è¡¨è§£æã€‚æœ€åä¼šè°ƒç”¨åˆ°getModelAndView()æ–¹æ³•è·å–åˆ°ModelAndViewå¯¹è±¡å¹¶è¿”å›ã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> ModelAndView <span class="hljs-title">invokeHandlerMethod</span><span class="hljs-params">(HttpServletRequest request,</span></span>
<span class="hljs-function"><span class="hljs-params">      HttpServletResponse response, HandlerMethod handlerMethod)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;

   ServletWebRequest webRequest = <span class="hljs-keyword">new</span> ServletWebRequest(request, response);
   <span class="hljs-keyword">try</span> &#123;
      <span class="hljs-comment">//è·å–æ•°æ®ç»‘å®šå·¥å‚</span>
      WebDataBinderFactory binderFactory = getDataBinderFactory(handlerMethod);
      <span class="hljs-comment">//Modelå·¥å‚</span>
      ModelFactory modelFactory = getModelFactory(handlerMethod, binderFactory);

      <span class="hljs-comment">//å¯è°ƒç”¨çš„æ–¹æ³•å¯¹è±¡</span>
      ServletInvocableHandlerMethod invocableMethod = createInvocableHandlerMethod(handlerMethod);
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.argumentResolvers != <span class="hljs-keyword">null</span>) &#123;
         <span class="hljs-comment">//è®¾ç½®å‚æ•°è§£æå™¨</span>
         invocableMethod.setHandlerMethodArgumentResolvers(<span class="hljs-keyword">this</span>.argumentResolvers);
      &#125;
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.returnValueHandlers != <span class="hljs-keyword">null</span>) &#123;
         <span class="hljs-comment">//è®¾ç½®è¿”å›å€¼è§£æå™¨</span>
         invocableMethod.setHandlerMethodReturnValueHandlers(<span class="hljs-keyword">this</span>.returnValueHandlers);
      &#125;
      <span class="hljs-comment">//è®¾ç½®å‚æ•°ç»‘å®šå·¥å‚</span>
      invocableMethod.setDataBinderFactory(binderFactory);
      <span class="hljs-comment">//è®¾ç½®å‚æ•°åç§°è§£æç±»</span>
      invocableMethod.setParameterNameDiscoverer(<span class="hljs-keyword">this</span>.parameterNameDiscoverer);

      ModelAndViewContainer mavContainer = <span class="hljs-keyword">new</span> ModelAndViewContainer();
      mavContainer.addAllAttributes(RequestContextUtils.getInputFlashMap(request));
      <span class="hljs-comment">//è°ƒç”¨æœ‰@ModelAttributeæ³¨è§£çš„æ–¹æ³•</span>
      modelFactory.initModel(webRequest, mavContainer, invocableMethod);
      mavContainer.setIgnoreDefaultModelOnRedirect(<span class="hljs-keyword">this</span>.ignoreDefaultModelOnRedirect);

      AsyncWebRequest asyncWebRequest = WebAsyncUtils.createAsyncWebRequest(request, response);
      asyncWebRequest.setTimeout(<span class="hljs-keyword">this</span>.asyncRequestTimeout);

      <span class="hljs-comment">//å¼‚æ­¥å¤„ç†</span>
      WebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request);
      asyncManager.setTaskExecutor(<span class="hljs-keyword">this</span>.taskExecutor);
      asyncManager.setAsyncWebRequest(asyncWebRequest);
      asyncManager.registerCallableInterceptors(<span class="hljs-keyword">this</span>.callableInterceptors);
      asyncManager.registerDeferredResultInterceptors(<span class="hljs-keyword">this</span>.deferredResultInterceptors);

      <span class="hljs-keyword">if</span> (asyncManager.hasConcurrentResult()) &#123;
         Object result = asyncManager.getConcurrentResult();
         mavContainer = (ModelAndViewContainer) asyncManager.getConcurrentResultContext()[<span class="hljs-number">0</span>];
         asyncManager.clearConcurrentResult();
         LogFormatUtils.traceDebug(logger, traceOn -&gt; &#123;
            String formatted = LogFormatUtils.formatValue(result, !traceOn);
            <span class="hljs-keyword">return</span> <span class="hljs-string">"Resume with async result ["</span> + formatted + <span class="hljs-string">"]"</span>;
         &#125;);
         invocableMethod = invocableMethod.wrapConcurrentResult(result);
      &#125;

      <span class="hljs-comment">//Controlleræ–¹æ³•è°ƒç”¨ï¼Œé‡ç‚¹çœ‹çœ‹</span>
      invocableMethod.invokeAndHandle(webRequest, mavContainer);
      <span class="hljs-keyword">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;
         <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
      &#125;

      <span class="hljs-keyword">return</span> getModelAndView(mavContainer, modelFactory, webRequest);
   &#125;
   <span class="hljs-keyword">finally</span> &#123;
      webRequest.requestCompleted();
   &#125;
&#125;</code></pre>

<p>invokeAndHandle()æ–¹æ³•</p>
<p>è¯¥æ–¹æ³•ä¼šè°ƒç”¨invokeForRequest()æ–¹æ³•è·å–åˆ°è¿”å›å€¼ï¼Œç„¶åä½¿ç”¨handleReturnValue()æ–¹æ³•å¯¹è¿”å›å€¼è¿›è¡Œå¤„ç†ã€‚å¤„ç†æ–¹å¼ä¸å…¥å‚çš„å¤„ç†åŸºæœ¬ç›¸åŒã€‚å¦‚æœä¸ºè§†å›¾å°±ä¼šå°†viewNameè®¾ç½®åˆ°mavContainerå®¹å™¨ä¸­ï¼Œå¹¶å°†requestHandledå±æ€§è®¾ç½®ä¸ºtrueã€‚å¦‚æœè¿”å›å‚æ•°è¢«@ResponseBodyæ³¨è§£ä¿®é¥°ï¼Œå°±ä¸ä¼šè®¾ç½®requestHandledå€¼ï¼ŒrequestHandledé»˜è®¤å€¼ä¸ºfalseã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">invokeAndHandle</span><span class="hljs-params">(ServletWebRequest webRequest, ModelAndViewContainer mavContainer,</span></span>
<span class="hljs-function"><span class="hljs-params">      Object... providedArgs)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;

   <span class="hljs-comment">//å…·ä½“è°ƒç”¨é€»è¾‘ï¼Œé‡ç‚¹çœ‹</span>
   Object returnValue = invokeForRequest(webRequest, mavContainer, providedArgs);
   setResponseStatus(webRequest);

   <span class="hljs-keyword">if</span> (returnValue == <span class="hljs-keyword">null</span>) &#123;
      <span class="hljs-keyword">if</span> (isRequestNotModified(webRequest) || getResponseStatus() != <span class="hljs-keyword">null</span> || mavContainer.isRequestHandled()) &#123;
         mavContainer.setRequestHandled(<span class="hljs-keyword">true</span>);
         <span class="hljs-keyword">return</span>;
      &#125;
   &#125;
   <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (StringUtils.hasText(getResponseStatusReason())) &#123;
      mavContainer.setRequestHandled(<span class="hljs-keyword">true</span>);
      <span class="hljs-keyword">return</span>;
   &#125;

   mavContainer.setRequestHandled(<span class="hljs-keyword">false</span>);
   Assert.state(<span class="hljs-keyword">this</span>.returnValueHandlers != <span class="hljs-keyword">null</span>, <span class="hljs-string">"No return value handlers"</span>);
   <span class="hljs-keyword">try</span> &#123;
      <span class="hljs-keyword">this</span>.returnValueHandlers.handleReturnValue(
            returnValue, getReturnValueType(returnValue), mavContainer, webRequest);
   &#125;
   <span class="hljs-keyword">catch</span> (Exception ex) &#123;
      <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;
         logger.trace(formatErrorForReturnValue(returnValue), ex);
      &#125;
      <span class="hljs-keyword">throw</span> ex;
   &#125;
&#125;</code></pre>

<p>invokeForRequest()æ–¹æ³•</p>
<p>è¯¥æ–¹æ³•é¦–å…ˆé€šè¿‡getMethodArgumentValues()æ–¹æ³•è·å–å‚æ•°æ•°ç»„ï¼Œç„¶åä½¿ç”¨åå°„è°ƒç”¨å¹¶å°†è¿”å›å€¼è¿”å›ã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">invokeForRequest</span><span class="hljs-params">(NativeWebRequest request, @Nullable ModelAndViewContainer mavContainer,</span></span>
<span class="hljs-function"><span class="hljs-params">      Object... providedArgs)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;

   <span class="hljs-comment">//è·å–å‚æ•°æ•°ç»„,é‡ç‚¹çœ‹</span>
   Object[] args = getMethodArgumentValues(request, mavContainer, providedArgs);
   <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;
      logger.trace(<span class="hljs-string">"Arguments: "</span> + Arrays.toString(args));
   &#125;
   <span class="hljs-keyword">return</span> doInvoke(args);
&#125;</code></pre>

<p>getMethodArgumentValues()æ–¹æ³•</p>
<p>è¯¥æ–¹æ³•ä¼šå¾ªç¯å¤„ç†å‚æ•°ï¼Œé¦–å…ˆä¼šæ³•åˆ¤æ–­å‚æ•°æ˜¯å¦æœ‰å¯¹åº”çš„å¤„ç†ç±»ï¼Œåˆ¤æ–­æ–¹æ³•ä¸ºå¾ªç¯è°ƒç”¨æ‰€æœ‰çš„HandlerMethodArgumentResolverå¤„ç†ç±»å¹¶è°ƒç”¨supportsParameter()åˆ¤æ–­æ˜¯å¦æ”¯æŒå¤„ç†è¯¥å‚æ•°ã€‚ç„¶åè°ƒç”¨resolveArgument()æ–¹æ³•è·å–åˆ°å¯¹åº”çš„å¤„ç†ç±»ï¼Œå¹¶è°ƒç”¨resolveArgument()æ–¹æ³•å¯¹å‚æ•°è¿›è¡Œå¤„ç†å¹¶åŒ…è£…ä¸ºMethodParameterå¯¹è±¡ã€‚</p>
<pre><code class="hljs java"><span class="hljs-keyword">protected</span> Object[] getMethodArgumentValues(NativeWebRequest request, <span class="hljs-meta">@Nullable</span> ModelAndViewContainer mavContainer,
      Object... providedArgs) <span class="hljs-keyword">throws</span> Exception &#123;

   <span class="hljs-keyword">if</span> (ObjectUtils.isEmpty(getMethodParameters())) &#123;
      <span class="hljs-keyword">return</span> EMPTY_ARGS;
   &#125;
   <span class="hljs-comment">//å…¥å‚çš„åŒ…è£…ç±»ï¼Œé‡Œé¢åŒ…è£…äº†å‚æ•°ç±»å‹ï¼Œå‚æ•°åç§°ï¼Œå‚æ•°æ³¨è§£ç­‰ç­‰ä¿¡æ¯</span>
   MethodParameter[] parameters = getMethodParameters();
   Object[] args = <span class="hljs-keyword">new</span> Object[parameters.length];
   <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; parameters.length; i++) &#123;
      MethodParameter parameter = parameters[i];
      <span class="hljs-comment">//è®¾ç½®å‚æ•°åç§°è§£æå™¨</span>
      parameter.initParameterNameDiscovery(<span class="hljs-keyword">this</span>.parameterNameDiscoverer);
      args[i] = findProvidedArgument(parameter, providedArgs);
      <span class="hljs-keyword">if</span> (args[i] != <span class="hljs-keyword">null</span>) &#123;
         <span class="hljs-keyword">continue</span>;
      &#125;
      <span class="hljs-comment">//å…¸å‹çš„ç­–ç•¥æ¨¡å¼ï¼Œæ ¹æ®parameterèƒ½å¦æ‰¾åˆ°å¯¹åº”å‚æ•°çš„å¤„ç†ç±»ï¼Œèƒ½æ‰¾åˆ°å°±è¿”å›true</span>
      <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.resolvers.supportsParameter(parameter)) &#123;
         <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(formatArgumentError(parameter, <span class="hljs-string">"No suitable resolver"</span>));
      &#125;
      <span class="hljs-keyword">try</span> &#123;
         <span class="hljs-comment">//å…·ä½“å‚æ•°å€¼è§£æè¿‡ç¨‹,é‡ç‚¹çœ‹çœ‹</span>
         args[i] = <span class="hljs-keyword">this</span>.resolvers.resolveArgument(parameter, mavContainer, request, <span class="hljs-keyword">this</span>.dataBinderFactory);
      &#125;
      <span class="hljs-keyword">catch</span> (Exception ex) &#123;
         <span class="hljs-comment">// Leave stack trace for later, exception may actually be resolved and handled..</span>
         <span class="hljs-keyword">if</span> (logger.isDebugEnabled()) &#123;
            String error = ex.getMessage();
            <span class="hljs-keyword">if</span> (error != <span class="hljs-keyword">null</span> &amp;&amp; !error.contains(parameter.getExecutable().toGenericString())) &#123;
               logger.debug(formatArgumentError(parameter, error));
            &#125;
         &#125;
         <span class="hljs-keyword">throw</span> ex;
      &#125;
   &#125;
   <span class="hljs-keyword">return</span> args;
&#125;</code></pre>

<p>getModelAndView()æ–¹æ³•</p>
<p>è¯¥æ–¹æ³•é¦–å…ˆä¼šåˆ¤æ–­requestHandledå±æ€§ï¼Œå¦‚æœå±æ€§ä¸ºfalseå°±ç›´æ¥è¿”å›ã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> ModelAndView <span class="hljs-title">getModelAndView</span><span class="hljs-params">(ModelAndViewContainer mavContainer,</span></span>
<span class="hljs-function"><span class="hljs-params">      ModelFactory modelFactory, NativeWebRequest webRequest)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;

   modelFactory.updateModel(webRequest, mavContainer);
   <span class="hljs-keyword">if</span> (mavContainer.isRequestHandled()) &#123;
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
   &#125;
   ModelMap model = mavContainer.getModel();
   ModelAndView mav = <span class="hljs-keyword">new</span> ModelAndView(mavContainer.getViewName(), model, mavContainer.getStatus());
   <span class="hljs-keyword">if</span> (!mavContainer.isViewReference()) &#123;
      mav.setView((View) mavContainer.getView());
   &#125;
   <span class="hljs-keyword">if</span> (model <span class="hljs-keyword">instanceof</span> RedirectAttributes) &#123;
      Map&lt;String, ?&gt; flashAttributes = ((RedirectAttributes) model).getFlashAttributes();
      HttpServletRequest request = webRequest.getNativeRequest(HttpServletRequest<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
      <span class="hljs-keyword">if</span> (request != <span class="hljs-keyword">null</span>) &#123;
         RequestContextUtils.getOutputFlashMap(request).putAll(flashAttributes);
      &#125;
   &#125;
   <span class="hljs-keyword">return</span> mav;
&#125;</code></pre>

<h3 id="applyPostHandle-æ–¹æ³•"><a href="#applyPostHandle-æ–¹æ³•" class="headerlink" title="applyPostHandle()æ–¹æ³•"></a>applyPostHandle()æ–¹æ³•</h3><p>ä¸å‰ç½®è¿‡æ»¤å™¨çš„è°ƒç”¨æ–¹æ³•åŸºæœ¬ç›¸åŒï¼Œä¸åŒçš„æ˜¯ä»–ä¸éœ€è¦è¿›è¡Œåˆ¤æ–­ï¼Œä¸”ä¸å‰ç½®è¿‡æ»¤å™¨ä¸åŒçš„æ˜¯ï¼Œå®ƒçš„éå†æ—¶å€’åºéå†ã€‚æ³¨æ„ï¼šä¸­ç½®è¿‡æ»¤å™¨ä¸­æœ‰ModelAndViewå…¥å‚å¯ä»¥å¯¹å…¶è¿›è¡Œå¤„ç†ã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">applyPostHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, @Nullable ModelAndView mv)</span></span>
<span class="hljs-function">      <span class="hljs-keyword">throws</span> Exception </span>&#123;

   HandlerInterceptor[] interceptors = getInterceptors();
   <span class="hljs-keyword">if</span> (!ObjectUtils.isEmpty(interceptors)) &#123;
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = interceptors.length - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) &#123;
         HandlerInterceptor interceptor = interceptors[i];
         interceptor.postHandle(request, response, <span class="hljs-keyword">this</span>.handler, mv);
      &#125;
   &#125;
&#125;</code></pre>

<h3 id="processDispatchResult-æ–¹æ³•"><a href="#processDispatchResult-æ–¹æ³•" class="headerlink" title="processDispatchResult()æ–¹æ³•"></a>processDispatchResult()æ–¹æ³•</h3><p>è¯¥æ–¹æ³•æœ€ç»ˆä¼šè½å…¥renderMergedOutputModel()æ–¹æ³•ä¸­ï¼Œè¿™é‡Œåªç€é‡åˆ†æè¿™ä¸ªæ–¹æ³•ã€‚</p>
<p>æ³¨æ„ï¼Œå¦‚æœModelAndViewä¸ºç©ºå°±ä¼šä»¥æµçš„æ–¹å¼å“åº”jsonæ•°æ®ï¼Œä¸ä¼šè¿›å…¥è¿™ä¸ªæ–¹æ³•ã€‚é¦–å…ˆä¼šè°ƒç”¨exposeModelAsRequestAttributes()æ–¹æ³•ï¼Œå°†modelä¸­çš„å¯¹è±¡è®¾ç½®åˆ°requestä¸­ã€‚ç„¶åè·å–åˆ°è·³è½¬åœ°å€ï¼Œå°†åœ°å€è½¬ä¸ºRequestDispatcherå¯¹è±¡ï¼Œæœ€åè°ƒç”¨RequestDispatcher.forward()è¿›è¡Œè½¬å‘ã€‚</p>
<pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">renderMergedOutputModel</span><span class="hljs-params">(</span></span>
<span class="hljs-function"><span class="hljs-params">		Map&lt;String, Object&gt; model, HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
   <span class="hljs-comment">// æŠŠå“åº”æ•°æ®è®¾ç½®åˆ°reqeustå¯¹è±¡ä¸­</span>
	<span class="hljs-comment">// Expose the model object as request attributes.</span>
	exposeModelAsRequestAttributes(model, request);

	<span class="hljs-comment">// Expose helpers as request attributes, if any.</span>
	exposeHelpers(request);

   <span class="hljs-comment">//è·å–åˆ°è·³è½¬åœ°å€</span>
	<span class="hljs-comment">// Determine the path for the request dispatcher.</span>
	String dispatcherPath = prepareForRendering(request, response);

	<span class="hljs-comment">// Obtain a RequestDispatcher for the target resource (typically a JSP).</span>
	RequestDispatcher rd = getRequestDispatcher(request, dispatcherPath);
	<span class="hljs-keyword">if</span> (rd == <span class="hljs-keyword">null</span>) &#123;
		<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ServletException(<span class="hljs-string">"Could not get RequestDispatcher for ["</span> + getUrl() +
				<span class="hljs-string">"]: Check that the corresponding file exists within your web application archive!"</span>);
	&#125;

	<span class="hljs-comment">// If already included or response already committed, perform include, else forward.</span>
	<span class="hljs-keyword">if</span> (useInclude(request, response)) &#123;
		response.setContentType(getContentType());
		<span class="hljs-keyword">if</span> (logger.isDebugEnabled()) &#123;
			logger.debug(<span class="hljs-string">"Including ["</span> + getUrl() + <span class="hljs-string">"]"</span>);
		&#125;
		rd.include(request, response);
	&#125;

	<span class="hljs-keyword">else</span> &#123;
		<span class="hljs-comment">// Note: The forwarded resource is supposed to determine the content type itself.</span>
		<span class="hljs-keyword">if</span> (logger.isDebugEnabled()) &#123;
			logger.debug(<span class="hljs-string">"Forwarding to ["</span> + getUrl() + <span class="hljs-string">"]"</span>);
		&#125;
		rd.forward(request, response);
	&#125;
&#125;</code></pre>
            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/blog/categories/SpringMVC%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/">SpringMVCæºç è§£æ</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/blog/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/">æºç è§£æ</a>
                    
                      <a class="hover-with-bg" href="/blog/tags/spring/">spring</a>
                    
                      <a class="hover-with-bg" href="/blog/tags/springmvc/">springmvc</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" target="_blank" rel="nofollow noopener noopener">CC BY-SA 4.0 åè®®</a> ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</p>
              
              
                <div class="post-prevnext row">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/blog/2020/04/22/springboot-%E4%B8%8E%E5%90%84%E7%A7%8D%E7%BB%84%E4%BB%B6%E7%9A%84%E6%95%B4%E5%90%88/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Springbootå„ç§ç»„ä»¶çš„æ•´åˆ</span>
                        <span class="visible-mobile">ä¸Šä¸€ç¯‡</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/blog/2020/04/20/springmvc-%E5%88%9D%E5%A7%8B%E5%8C%96%E8%BF%87%E7%A8%8B/">
                        <span class="hidden-mobile">SpringMVCçš„åˆå§‹åŒ–è¿‡ç¨‹</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener">
        <span>Fluid</span></a>
    </div>
    
  <div class="statistics">
    
    

    
      
        <!-- ä¸è’œå­ç»Ÿè®¡PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            æ€»è®¿é—®é‡ 
            <span id="busuanzi_value_site_pv"></span>
             æ¬¡
          </span>
      
      
        <!-- ä¸è’œå­ç»Ÿè®¡UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            æ€»è®¿å®¢æ•° 
            <span id="busuanzi_value_site_uv"></span>
             äºº
          </span>
      
    
  </div>


    

    
  </div>
</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/blog/js/debouncer.js" ></script>
<script  src="/blog/js/main.js" ></script>

<!-- Plugins -->


  
    <script  src="/blog/js/lazyload.js" ></script>
  



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/blog/js/clipboard-use.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: '#post-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "SpringMVCçš„è¯·æ±‚å“åº”åˆ†æ&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/blog/js/local-search.js" ></script>
  <script>
    var path = "/blog/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>







  
  
    <script type="text/javascript">
      //å®šä¹‰è·å–è¯è¯­ä¸‹æ ‡
      var a_idx = 0;
      jQuery(document).ready(function ($) {
        //ç‚¹å‡»bodyæ—¶è§¦å‘äº‹ä»¶
        $("body").click(function (e) {
          //éœ€è¦æ˜¾ç¤ºçš„è¯è¯­
          var a = new Array("å¯Œå¼º", "æ°‘ä¸»", "æ–‡æ˜", "å’Œè°", "è‡ªç”±", "å¹³ç­‰", "å…¬æ­£", "æ³•æ²»", "çˆ±å›½", "æ•¬ä¸š", "è¯šä¿¡", "å‹å–„");
          //è®¾ç½®è¯è¯­ç»™spanæ ‡ç­¾
          var $i = $("<span/>").text(a[a_idx]);
          //ä¸‹æ ‡ç­‰äºåŸæ¥ä¸‹æ ‡+1  ä½™ è¯è¯­æ€»æ•°
          a_idx = (a_idx + 1) % a.length;
          //è·å–é¼ æ ‡æŒ‡é’ˆçš„ä½ç½®ï¼Œåˆ†åˆ«ç›¸å¯¹äºæ–‡æ¡£çš„å·¦å’Œå³è¾¹ç¼˜ã€‚
          //è·å–xå’Œyçš„æŒ‡é’ˆåæ ‡
          var x = e.pageX, y = e.pageY;
          //åœ¨é¼ æ ‡çš„æŒ‡é’ˆçš„ä½ç½®ç»™$iå®šä¹‰çš„spanæ ‡ç­¾æ·»åŠ cssæ ·å¼
          $i.css({
            "z-index": 999,
            "top": y - 20,
            "left": x,
            "position": "absolute",
            "font-weight": "bold",
            "color": rand_color()
          });
          // éšæœºé¢œè‰²
          function rand_color() {
            return "rgb(" + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + ")"
          }
          //åœ¨bodyæ·»åŠ è¿™ä¸ªæ ‡ç­¾
          $("body").append($i);
          //animate() æ–¹æ³•æ‰§è¡Œ CSS å±æ€§é›†çš„è‡ªå®šä¹‰åŠ¨ç”»ã€‚
          //è¯¥æ–¹æ³•é€šè¿‡CSSæ ·å¼å°†å…ƒç´ ä»ä¸€ä¸ªçŠ¶æ€æ”¹å˜ä¸ºå¦ä¸€ä¸ªçŠ¶æ€ã€‚CSSå±æ€§å€¼æ˜¯é€æ¸æ”¹å˜çš„ï¼Œè¿™æ ·å°±å¯ä»¥åˆ›å»ºåŠ¨ç”»æ•ˆæœã€‚
          //è¯¦æƒ…è¯·çœ‹http://www.w3school.com.cn/jquery/effect_animate.asp
          $i.animate({
            //å°†åŸæ¥çš„ä½ç½®å‘ä¸Šç§»åŠ¨180
            "top": y - 180,
            "opacity": 0
            //1500åŠ¨ç”»çš„é€Ÿåº¦
          }, 1500, function () {
            //æ—¶é—´åˆ°äº†è‡ªåŠ¨åˆ é™¤
            $i.remove();
          });
        });
      })
      ;
    </script>
  














</body>
</html>
