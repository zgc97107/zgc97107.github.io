

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/blog/img/favicon.png">
  <link rel="icon" type="image/png" href="/blog/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="">
  <meta name="keywords" content="">
  <title>Redisçš„é«˜å¯ç”¨ - ğŸğŸŠ&#39;s blog</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/blog/lib/hint/hint.min.css" />

  
    
    <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/github-gist.min.css" />
  

  


<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_6peoq002giu.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_pjno9b9zyxs.css">


<link  rel="stylesheet" href="/blog/css/main.css" />

<!-- è‡ªå®šä¹‰æ ·å¼ä¿æŒåœ¨æœ€åº•éƒ¨ -->


  <script  src="/blog/js/utils.js" ></script>
  <script  src="/blog/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 4.2.1"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/blog/">&nbsp;<strong>ğŸğŸŠ's blog</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/">
                <i class="iconfont icon-home-fill"></i>
                ä¸»é¡µ
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/archives/">
                <i class="iconfont icon-archive-fill"></i>
                å½’æ¡£
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/categories/">
                <i class="iconfont icon-category-fill"></i>
                åˆ†ç±»
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/tags/">
                <i class="iconfont icon-tags-fill"></i>
                æ ‡ç­¾
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/about/">
                <i class="iconfont icon-user-fill"></i>
                å…³äº
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax=true
         style="background: url('/blog/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container page-header text-center fade-in-up">
            <span class="h2" id="subtitle">
              
            </span>

            
              
  <div class="mt-3 post-meta">
    <i class="iconfont icon-date-fill" aria-hidden="true"></i>
    <time datetime="2020-08-22 22:06" pubdate>
      2020å¹´8æœˆ22æ—¥ æ™šä¸Š
    </time>
  </div>


<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      7.1k å­—
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      89
       åˆ†é’Ÿ
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto" id="post">
            <!-- SEO header -->
            <h1 style="display: none">Redisçš„é«˜å¯ç”¨</h1>
            
            <div class="markdown-body" id="post-body">
              <h3 id="Redisé›†ç¾¤é…ç½®"><a href="#Redisé›†ç¾¤é…ç½®" class="headerlink" title="Redisé›†ç¾¤é…ç½®"></a>Redisé›†ç¾¤é…ç½®</h3><p>ç°åœ¨å®‰è£…å¯¹åº”çš„åº”ç”¨è½¯ä»¶ä¸€èˆ¬éƒ½æ¨èä½¿ç”¨Dockerå®¹å™¨ï¼Œè¿™é‡Œä¹Ÿä¸ä¾‹å¤–ï¼Œç›´æ¥ä½¿ç”¨Dockerå®¹å™¨è¿›è¡Œå®‰è£…ï¼Œå®‰è£…å¤§æ¦‚è¦åˆ†è¿™å‡ ä¸ªæ­¥éª¤ï¼š </p>
<ol>
<li><p>åˆ›å»ºredisâ€cluster.tmplé…ç½®Redisä¿¡æ¯ã€ç«¯å£ã€æ˜¯å¦å¼€å¯é›†ç¾¤ç­‰ã€‘ </p>
</li>
<li><p>åˆ›å»ºredis.shé…ç½®éœ€è¦åˆ›å»ºçš„redisä¿¡æ¯ </p>
</li>
<li><p>æ·»åŠ ç½‘ç»œï¼Œredisé›†ç¾¤ä½¿ç”¨è¯¥ç½‘ç»œ </p>
</li>
<li><p>æ‰§è¡Œredis.shå®ç°åˆ›å»ºredis </p>
</li>
<li><p>æ‰§è¡Œredisâ€cliåˆ›å»ºé›†ç¾¤</p>
</li>
</ol>
<h4 id="é…ç½®Redisä¿¡æ¯"><a href="#é…ç½®Redisä¿¡æ¯" class="headerlink" title="é…ç½®Redisä¿¡æ¯"></a>é…ç½®Redisä¿¡æ¯</h4><p>åˆ›å»º redis-cluster.tmpl é…ç½®Redisä¿¡æ¯</p>
<pre><code class="hljs yaml"><span class="hljs-comment">#ç«¯å£</span>
<span class="hljs-string">port</span> <span class="hljs-string">$&#123;PORT&#125;</span>
<span class="hljs-comment">#éä¿æŠ¤æ¨¡å¼</span>
<span class="hljs-string">protected-mode</span> <span class="hljs-literal">no</span>
<span class="hljs-comment">#å¯ç”¨é›†ç¾¤æ¨¡å¼</span>
<span class="hljs-string">cluster-enabled</span> <span class="hljs-literal">yes</span>
<span class="hljs-string">cluster-config-file</span> <span class="hljs-string">nodes.conf</span>
<span class="hljs-comment">#è¶…æ—¶æ—¶é—´</span>
<span class="hljs-string">cluster-node-timeout</span> <span class="hljs-number">5000</span>
<span class="hljs-comment">#é›†ç¾¤å„èŠ‚ç‚¹IPåœ°å€</span>
<span class="hljs-string">cluster-announce-ip</span> <span class="hljs-string">$&#123;Native_IP&#125;</span>
<span class="hljs-comment">#é›†ç¾¤èŠ‚ç‚¹æ˜ å°„ç«¯å£</span>
<span class="hljs-string">cluster-announce-port</span> <span class="hljs-string">$&#123;PORT&#125;</span>
<span class="hljs-comment">#é›†ç¾¤æ€»çº¿ç«¯å£</span>
<span class="hljs-string">cluster-announce-bus-port</span> <span class="hljs-number">1</span><span class="hljs-string">$&#123;PORT&#125;</span>
<span class="hljs-comment">#å¼€å¯aofæŒä¹…åŒ–ç­–ç•¥</span>
<span class="hljs-string">appendonly</span> <span class="hljs-literal">yes</span>
<span class="hljs-comment">#åå°è¿è¡Œ</span>
<span class="hljs-comment">#daemonize yes </span>
<span class="hljs-comment">#è¿›ç¨‹å·å­˜å‚¨</span>
<span class="hljs-string">pidfile</span>  <span class="hljs-string">/var/run/redis_$&#123;PORT&#125;.pid</span>
<span class="hljs-comment">#é›†ç¾¤åŠ å¯†</span>
<span class="hljs-comment">#masterauth itheima </span>
<span class="hljs-comment">#requirepass itheima</span></code></pre>

<h4 id="Redisåˆ›å»ºé…ç½®"><a href="#Redisåˆ›å»ºé…ç½®" class="headerlink" title="Redisåˆ›å»ºé…ç½®"></a>Redisåˆ›å»ºé…ç½®</h4><p>åˆ›å»ºredis.shé…ç½®éœ€è¦åˆ›å»ºçš„Redisé›†ç¾¤</p>
<pre><code class="hljs sh"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment">#åœ¨/usr/local/server/redis-clusterä¸‹ç”Ÿæˆconfå’Œdataç›®æ ‡ï¼Œå¹¶ç”Ÿæˆé…ç½®ä¿¡æ¯</span>

<span class="hljs-comment">#è¾“å…¥ä¿¡æ¯</span>
<span class="hljs-built_in">read</span> -p <span class="hljs-string">"è¯·è¾“å…¥æœ¬æœºIPåœ°å€ï¼š"</span> Native_IP

<span class="hljs-comment"># åˆ›å»ºæ–‡ä»¶å¤¹</span>
mkdir -p /usr/<span class="hljs-built_in">local</span>/server/redis-cluster
<span class="hljs-comment"># ä¸‹è½½redisé…ç½®æ¨¡æ¿</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"æ­£åœ¨ä¸‹è½½redis-cluster.tmplé…ç½®æ¨¡æ¿"</span>;
wget -P /usr/<span class="hljs-built_in">local</span>/server/redis-cluster https://srv-file22.gofile.io/download/RoGvVk/redis-cluster.tmpl

<span class="hljs-built_in">echo</span> <span class="hljs-string">"æ­£åœ¨åˆ›å»ºredis-netç½‘ç»œ"</span>;
<span class="hljs-comment">#cåˆ›å»ºç½‘ç»œ</span>
docker network create redis-net

<span class="hljs-built_in">echo</span> <span class="hljs-string">"æ­£åœ¨åˆ›å»ºredisé…ç½®æ–‡ä»¶"</span>;
<span class="hljs-keyword">for</span> port <span class="hljs-keyword">in</span> `seq 7001 7006`; 
<span class="hljs-keyword">do</span> 
  mkdir -p /usr/<span class="hljs-built_in">local</span>/server/redis-cluster/<span class="hljs-variable">$&#123;port&#125;</span>/conf &amp;&amp; PORT=<span class="hljs-variable">$&#123;port&#125;</span> Native_IP=<span class="hljs-variable">$&#123;Native_IP&#125;</span>  envsubst &lt; /usr/<span class="hljs-built_in">local</span>/server/redis-cluster/redis-cluster.tmpl &gt; /usr/<span class="hljs-built_in">local</span>/server/redis-cluster/<span class="hljs-variable">$&#123;port&#125;</span>/conf/redis.conf &amp;&amp; mkdir -p /usr/<span class="hljs-built_in">local</span>/server/redis-cluster/<span class="hljs-variable">$&#123;port&#125;</span>/data;
<span class="hljs-keyword">done</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"æ­£åœ¨å¯åŠ¨rediså®¹å™¨"</span>;
<span class="hljs-comment">#åˆ›å»º6ä¸ªrediså®¹å™¨</span>
<span class="hljs-keyword">for</span> port <span class="hljs-keyword">in</span> `seq 7001 7006`;
<span class="hljs-keyword">do</span>
	docker run -d -it -p <span class="hljs-variable">$&#123;port&#125;</span>:<span class="hljs-variable">$&#123;port&#125;</span> -p 1<span class="hljs-variable">$&#123;port&#125;</span>:1<span class="hljs-variable">$&#123;port&#125;</span> -v /usr/<span class="hljs-built_in">local</span>/server/redis-cluster/<span class="hljs-variable">$&#123;port&#125;</span>/conf/redis.conf:/usr/<span class="hljs-built_in">local</span>/etc/redis/redis.conf -v /usr/<span class="hljs-built_in">local</span>/server/redis-cluster/<span class="hljs-variable">$&#123;port&#125;</span>/data:/data --privileged=<span class="hljs-literal">true</span> --restart always --name redis-<span class="hljs-variable">$&#123;port&#125;</span> --net redis-net --sysctl net.core.somaxconn=1024 redis redis-server /usr/<span class="hljs-built_in">local</span>/etc/redis/redis.conf;
<span class="hljs-keyword">done</span>
<span class="hljs-comment">#æŸ¥æ‰¾ip</span>
<span class="hljs-keyword">for</span> port <span class="hljs-keyword">in</span> `seq 7001 7006`;
<span class="hljs-keyword">do</span>
	<span class="hljs-built_in">echo</span>  -n <span class="hljs-string">"<span class="hljs-variable">$(docker inspect --format '&#123;&#123; (index .NetworkSettings.Networks "redis-net")</span>.IPAddress &#125;&#125;' "</span>redis-<span class="hljs-variable">$&#123;port&#125;</span><span class="hljs-string">")"</span>:<span class="hljs-variable">$&#123;port&#125;</span><span class="hljs-string">" "</span>;
<span class="hljs-keyword">done</span>
<span class="hljs-comment">#æ¢è¡Œ</span>
<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n"</span>
<span class="hljs-comment">#è¾“å…¥ä¿¡æ¯</span>
<span class="hljs-built_in">read</span> -p <span class="hljs-string">"è¯·æŠŠè¾“å…¥è¦å¯åŠ¨çš„dockerå®¹å™¨åç§°ï¼Œé»˜è®¤redis-7001ï¼š"</span> DOCKER_NAME
<span class="hljs-comment">#åˆ¤æ–­æ˜¯å¦ä¸ºç©º</span>
<span class="hljs-keyword">if</span> [ ! <span class="hljs-variable">$DOCKER_NAME</span> ]; 
	<span class="hljs-keyword">then</span> DOCKER_NAME=<span class="hljs-string">'redis-7001'</span>; 
<span class="hljs-keyword">fi</span>
<span class="hljs-comment">#è¿›å…¥å®¹å™¨</span>
docker <span class="hljs-built_in">exec</span> -it redis-7001 /bin/bash

<span class="hljs-comment"># åˆ é™¤å®¹å™¨</span>
<span class="hljs-comment">#docker rm -f $(docker ps -a |  grep "redis-*"  | awk '&#123;print $1&#125;')</span></code></pre>

<p>ç§»é™¤è„šæœ¬åˆ›å»º</p>
<p>åˆ›å»ºstop.shè„šæœ¬ï¼Œç”¨äºåœæ­¢Rediså®¹å™¨ï¼Œå¹¶ä¸”ç§»é™¤å¯¹åº”å®¹å™¨</p>
<pre><code class="hljs sh"><span class="hljs-meta">#!/bin/bash</span>
docker stop redis-7001 redis-7002 redis-7003 redis-7004 redis-7005 redis-7006
docker rm redis-7001 redis-7002 redis-7003 redis-7004 redis-7005 redis-7006
rm -rf 7001 7002 7003 7004 7005 7006</code></pre>

<p>è„šæœ¬æˆæƒï¼šç»™ redis.sh å’Œ stop.sh æ·»åŠ å¯æ‰§è¡Œæƒé™ï¼š</p>
<pre><code class="hljs sh">chmod +x redis.sh 
chmod +x stop.sh</code></pre>

<p>æ‰§è¡Œè„šæœ¬å¼€å§‹å®‰è£…RedisèŠ‚ç‚¹ï¼Œå¹¶è¿›å…¥åˆ° /usr/local/bin ç›®å½•ä¸‹æ‰§è¡Œ redis-cli åˆ›å»ºé›†ç¾¤å…³è”ï¼š</p>
<pre><code class="hljs sh">./redis.sh redis-cli \
--cluster create 172.18.0.2:7001 172.18.0.3:7002 172.18.0.4:7003 172.18.0.5:7004 172.18.0.6:7005 172.18.0.7:7006 \
--cluster-replicas 1</code></pre>

<p><strong>â€“cluster-replicas</strong> è¡¨ç¤ºæœ‰ä¸€ä¸ªä¸»æœ‰å‡ ä¸ªslaveã€‚</p>
<img src="/blog/2020/08/22/%E7%BC%93%E5%AD%98-Redis%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8/pic21.png" srcset="/blog/img/loading.gif" class>

<p>å®‰è£…å¥½äº†åï¼Œé“¾æ¥Redisæ•ˆæœå¦‚ä¸‹ï¼š</p>
<img src="/blog/2020/08/22/%E7%BC%93%E5%AD%98-Redis%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8/pic22.png" srcset="/blog/img/loading.gif" class>

<h3 id="ä¸»ä»å¤åˆ¶"><a href="#ä¸»ä»å¤åˆ¶" class="headerlink" title="ä¸»ä»å¤åˆ¶"></a>ä¸»ä»å¤åˆ¶</h3><h4 id="ä¸»ä»æ‹“æ‰‘"><a href="#ä¸»ä»æ‹“æ‰‘" class="headerlink" title="ä¸»ä»æ‹“æ‰‘"></a>ä¸»ä»æ‹“æ‰‘</h4><h5 id="ä¸€ä¸»ä¸€ä»"><a href="#ä¸€ä¸»ä¸€ä»" class="headerlink" title="ä¸€ä¸»ä¸€ä»"></a>ä¸€ä¸»ä¸€ä»</h5><img src="/blog/2020/08/22/%E7%BC%93%E5%AD%98-Redis%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8/pic1.png" srcset="/blog/img/loading.gif" class>

<p>ä¸»èŠ‚ç‚¹çš„å†™å…¥å‘½ä»¤ä¼šåŒæ­¥åˆ°ä»èŠ‚ç‚¹ï¼Œå½“éœ€è¦æŒä¹…åŒ–æ—¶ï¼Œå¯ä»¥åªåœ¨ä»èŠ‚ç‚¹å¼€å¯AOFã€‚</p>
<h5 id="ä¸€ä¸»å¤šä»"><a href="#ä¸€ä¸»å¤šä»" class="headerlink" title="ä¸€ä¸»å¤šä»"></a>ä¸€ä¸»å¤šä»</h5><img src="/blog/2020/08/22/%E7%BC%93%E5%AD%98-Redis%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8/pic2.png" srcset="/blog/img/loading.gif" class>

<p>é’ˆå¯¹è¯»è¾ƒå¤šçš„åœºæ™¯ï¼Œè¯»ç”±å¤šä¸ªä»èŠ‚ç‚¹æ¥åˆ†æ‹…ï¼Œä½†èŠ‚ç‚¹è¶Šå¤šï¼Œä¸»èŠ‚ç‚¹åŒæ­¥åˆ°å¤šèŠ‚ç‚¹çš„æ¬¡æ•°ä¹Ÿè¶Šå¤šï¼Œå½±å“å¸¦å®½ï¼Œä¹ŸåŠ é‡ä¸»èŠ‚ç‚¹çš„ç¨³å®šã€‚</p>
<h5 id="æ ‘çŠ¶ä¸»ä»"><a href="#æ ‘çŠ¶ä¸»ä»" class="headerlink" title="æ ‘çŠ¶ä¸»ä»"></a>æ ‘çŠ¶ä¸»ä»</h5><img src="/blog/2020/08/22/%E7%BC%93%E5%AD%98-Redis%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8/pic3.png" srcset="/blog/img/loading.gif" class>

<p>ç”¨æ¥è§£å†³ä¸€ä¸»å¤šä»ä¸»èŠ‚ç‚¹çš„æ¨é€å‹åŠ›ï¼Œä¸»èŠ‚ç‚¹åªæ¨é€ä¸€æ¬¡æ•°æ®åˆ°ä»èŠ‚ç‚¹Bï¼Œå†ç”±ä»èŠ‚ç‚¹Bæ¨é€åˆ°Cå’ŒDï¼Œå‡è½»ä¸»èŠ‚ç‚¹æ¨é€çš„å‹åŠ›</p>
<h4 id="å¤åˆ¶åŸç†"><a href="#å¤åˆ¶åŸç†" class="headerlink" title="å¤åˆ¶åŸç†"></a>å¤åˆ¶åŸç†</h4><img src="/blog/2020/08/22/%E7%BC%93%E5%AD%98-Redis%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8/pic4.png" srcset="/blog/img/loading.gif" class>

<ol>
<li><p>SlaveæœåŠ¡å¯åŠ¨ï¼Œä¸»åŠ¨è¿æ¥Masterï¼Œå¹¶å‘é€SYNCå‘½ä»¤ï¼Œè¯·æ±‚åˆå§‹åŒ–åŒæ­¥ï¼› </p>
</li>
<li><p>Masteræ”¶åˆ°SYNCåï¼Œæ‰§è¡ŒBGSAVEå‘½ä»¤ç”ŸæˆRDBæ–‡ä»¶ï¼Œå¹¶ç¼“å­˜è¯¥æ—¶é—´æ®µå†…çš„å†™å‘½ä»¤ï¼› </p>
</li>
<li><p>Masterå®ŒæˆRDBæ–‡ä»¶åï¼Œå°†å…¶å‘é€ç»™æ‰€æœ‰SlaveæœåŠ¡å™¨ï¼› </p>
</li>
<li><p>SlaveæœåŠ¡å™¨æ¥æ”¶åˆ°RDBæ–‡ä»¶åï¼Œåˆ é™¤å†…å­˜ä¸­æ—§çš„ç¼“å­˜æ•°æ®ï¼Œå¹¶è£…è½½RDBæ–‡ä»¶ï¼› </p>
</li>
<li><p>Masteråœ¨å‘é€å®ŒRDBåï¼Œå³åˆ»å‘æ‰€æœ‰SlaveæœåŠ¡å™¨å‘é€ç¼“å­˜ä¸­çš„å†™å‘½ä»¤ï¼› </p>
</li>
</ol>
<h4 id="æ•°æ®åŒæ­¥"><a href="#æ•°æ®åŒæ­¥" class="headerlink" title="æ•°æ®åŒæ­¥"></a>æ•°æ®åŒæ­¥</h4><p>redis 2.8ç‰ˆæœ¬ä»¥ä¸Šä½¿ç”¨psyncå‘½ä»¤å®ŒæˆåŒæ­¥ï¼Œå¤åˆ¶æ–¹å¼åˆ†ä¸ºå…¨é‡ä¸éƒ¨åˆ†å¤åˆ¶</p>
<ul>
<li><p>å…¨é‡å¤åˆ¶ï¼šä¸€èˆ¬ç”¨äºåˆæ¬¡å¤åˆ¶åœºæ™¯ï¼ˆç¬¬ä¸€æ¬¡å»ºç«‹SLAVEåå…¨é‡ï¼‰ã€‚</p>
</li>
<li><p>éƒ¨åˆ†å¤åˆ¶ï¼šç½‘ç»œå‡ºç°é—®é¢˜ï¼Œä»èŠ‚ç‚¹å†æ¬¡è¿ä¸»èŠ‚ç‚¹æ—¶ï¼Œä¸»èŠ‚ç‚¹è¡¥å‘ç¼ºå°‘çš„æ•°æ®ï¼Œæ¯æ¬¡æ•°æ®å¢åŠ åŒæ­¥ã€‚</p>
</li>
</ul>
<p>å¿ƒè·³ï¼šä¸»ä»æœ‰é•¿è¿æ¥å¿ƒè·³ï¼Œä¸»èŠ‚ç‚¹é»˜è®¤æ¯10Så‘ä»èŠ‚ç‚¹å‘pingå‘½ä»¤ï¼Œ<code>repl-ping-slave-period</code>å±æ€§å¯ä»¥æ§åˆ¶å‘é€é¢‘ç‡ã€‚</p>
<h4 id="é›†ç¾¤æ‰©å®¹æ”¶å®¹"><a href="#é›†ç¾¤æ‰©å®¹æ”¶å®¹" class="headerlink" title="é›†ç¾¤æ‰©å®¹æ”¶å®¹"></a>é›†ç¾¤æ‰©å®¹æ”¶å®¹</h4><p>ä¸Šé¢è™½ç„¶åˆ›å»ºäº†ä¸»ä»å¤åˆ¶ï¼Œä½†å¦‚æœæ‰‹åŠ¨ç»™èŠ‚ç‚¹æ·»åŠ ä¸€ä¸ªä»èŠ‚ç‚¹ï¼Œæœ‰å¯èƒ½æ·»åŠ ä»èŠ‚ç‚¹ï¼Œä¹Ÿæœ‰å¯èƒ½æ·»åŠ ä»èŠ‚ç‚¹ï¼Œè¿™æ˜¯æˆ‘ä»¬æƒ³è¦å¹²çš„ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ç»™é›†ç¾¤èŠ‚ç‚¹æ·»åŠ æŒ‡å®šçš„ä»èŠ‚ç‚¹ã€‚ </p>
<p>æˆ‘ä»¬å®‰è£… 7007 ã€ 7008 ã€ 7009 å‡ ä¸ªRedisèŠ‚ç‚¹ï¼Œç„¶åå°† 7007 å’Œ 7008 ä½œä¸ºä¸»èŠ‚ç‚¹ï¼Œæ·»åŠ åˆ°é›†ç¾¤ä¸­ï¼Œ 7009 ä½œä¸ºä»èŠ‚ç‚¹æ·»åŠ åˆ°é›†ç¾¤ä¸­ã€‚</p>
<table>
<thead>
<tr>
<th>RedisèŠ‚ç‚¹</th>
<th>IP</th>
<th>ç«¯å£</th>
</tr>
</thead>
<tbody><tr>
<td>redis-7007</td>
<td>172.18.0.8</td>
<td>7007</td>
</tr>
<tr>
<td>redis-7008</td>
<td>172.18.0.9</td>
<td>7008</td>
</tr>
<tr>
<td>redis-7009</td>
<td>172.18.0.10</td>
<td>7009</td>
</tr>
</tbody></table>
<p>åŸºäºDockerå®‰è£…Redisè¿™é‡Œç¼–å†™äº†ä¸€ä¸ªè„šæœ¬ï¼Œå®‰è£…è„šæœ¬ redis-port.sh å¦‚ä¸‹ï¼š</p>
<pre><code class="hljs sh"><span class="hljs-meta">#!/bin/bash </span>
<span class="hljs-comment">#åœ¨/usr/local/server/redisâ€clusterä¸‹ç”Ÿæˆconfå’Œdataç›®æ ‡ï¼Œå¹¶ç”Ÿæˆé…ç½®ä¿¡æ¯ </span>
<span class="hljs-comment">#æ¢è¡Œ</span>
<span class="hljs-built_in">echo</span> â€e <span class="hljs-string">"\n"</span> 
<span class="hljs-comment">#è¾“å…¥ä¿¡æ¯ </span>
<span class="hljs-built_in">read</span> â€p <span class="hljs-string">"è¯·è¾“å…¥å®¹å™¨ç«¯å£ï¼š"</span> DOCKER_PORT 

<span class="hljs-comment">#è¾“å…¥ç«¯å£èµ‹å€¼ </span>
port=<span class="hljs-variable">$DOCKER_PORT</span>; 

<span class="hljs-built_in">echo</span> â€e <span class="hljs-string">"<span class="hljs-variable">$port</span>"</span>

<span class="hljs-comment">#åˆ›å»ºé…ç½®æ–‡ä»¶ </span>
mkdir â€p ./<span class="hljs-variable">$&#123;port&#125;</span>/conf &amp;&amp; PORT=<span class="hljs-variable">$&#123;port&#125;</span> envsubst &lt; ./redisâ€cluster.tmpl &gt; ./<span class="hljs-variable">$&#123;port&#125;</span>/conf/redis.conf &amp;&amp; mkdir â€p ./<span class="hljs-variable">$&#123;port&#125;</span>/data; 
<span class="hljs-comment">#åˆ›å»ºrediså®¹å™¨ </span>
docker run â€d â€it â€p <span class="hljs-variable">$&#123;port&#125;</span>:<span class="hljs-variable">$&#123;port&#125;</span> â€p 1<span class="hljs-variable">$&#123;port&#125;</span>:1<span class="hljs-variable">$&#123;port&#125;</span> â€v /usr/<span class="hljs-built_in">local</span>/server/redisâ€ cluster/<span class="hljs-variable">$&#123;port&#125;</span>/conf/redis.conf:/usr/<span class="hljs-built_in">local</span>/etc/redis/redis.conf â€v /usr/<span class="hljs-built_in">local</span>/server/redisâ€ cluster/<span class="hljs-variable">$&#123;port&#125;</span>/data:/data â€â€privileged=<span class="hljs-literal">true</span> â€â€restart always â€â€name redisâ€<span class="hljs-variable">$&#123;port&#125;</span> â€â€net redisâ€ net â€â€sysctl net.core.somaxconn=1024 redis redisâ€server /usr/<span class="hljs-built_in">local</span>/etc/redis/redis.conf; 
<span class="hljs-comment">#æŸ¥æ‰¾ip</span>
<span class="hljs-built_in">echo</span> â€n <span class="hljs-string">"å¯åŠ¨<span class="hljs-variable">$(docker inspect â€â€format '&#123;&#123; (index .NetworkSettings.Networks "redisâ€ net")</span>.IPAddress &#125;&#125;' "</span>redisâ€<span class="hljs-variable">$&#123;port&#125;</span><span class="hljs-string">")"</span>:<span class="hljs-variable">$&#123;port&#125;</span><span class="hljs-string">" æˆåŠŸï¼"</span>;
<span class="hljs-built_in">echo</span> â€e <span class="hljs-string">"\n"</span></code></pre>

<p>æ‰§è¡Œ redis-port.sh è„šæœ¬ï¼Œå®ç° 7007,7008,7009 èŠ‚ç‚¹å®‰è£…ã€‚</p>
<p>æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ </p>
<p>ä¸»èŠ‚ç‚¹æŸ¥çœ‹ï¼š</p>
<p><code>./redisâ€cli â€p 7001 cluster nodes|grep master</code></p>
<img src="/blog/2020/08/22/%E7%BC%93%E5%AD%98-Redis%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8/pic23.png" srcset="/blog/img/loading.gif" class>

<p>ä¸»èŠ‚ç‚¹çŠ¶æ€ä¿¡æ¯å¦‚ä¸‹ï¼š </p>
<p>ä»èŠ‚ç‚¹æŸ¥çœ‹ï¼š </p>
<p><code>./redisâ€cli â€p 7001 cluster nodes|grep slave</code></p>
<p><img src="/blog/2020/08/22/%E7%BC%93%E5%AD%98-Redis%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8/pic24.png" srcset="/blog/img/loading.gif" class></p>
<p>ä»ä¸Šé¢ä¿¡æ¯æˆ‘ä»¬å¯ä»¥çœ‹å‡ºé›†ç¾¤å…³ç³»ï¼š</p>
<pre><code class="hljs angelscript">Masterï¼š<span class="hljs-number">7001</span> Slaveï¼š<span class="hljs-number">7005</span> 
Masterï¼š<span class="hljs-number">7002</span> Slaveï¼š<span class="hljs-number">7006</span> 
Masterï¼š<span class="hljs-number">7003</span> Slaveï¼š<span class="hljs-number">7004</span></code></pre>

<h5 id="æ·»åŠ é›†ç¾¤ä¸»èŠ‚ç‚¹"><a href="#æ·»åŠ é›†ç¾¤ä¸»èŠ‚ç‚¹" class="headerlink" title="æ·»åŠ é›†ç¾¤ä¸»èŠ‚ç‚¹"></a>æ·»åŠ é›†ç¾¤ä¸»èŠ‚ç‚¹</h5><p>æˆ‘ä»¬éœ€è¦ç»™é›†ç¾¤èŠ‚ç‚¹æ·»åŠ ä¸€ä¸ªä¸»èŠ‚ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦å°† 192.168.211.141:7007 èŠ‚ç‚¹æ·»åŠ åˆ° 192.168.211.141:7001 èŠ‚ç‚¹æ‰€åœ¨çš„é›†ç¾¤ä¸­ï¼Œå¹¶ä¸”æ·»åŠ åä½œä¸ºä¸»èŠ‚ç‚¹ï¼Œæ·»åŠ å‘½ä»¤è¡Œå¦‚ä¸‹ï¼š</p>
<p><code>./redisâ€cli â€â€cluster addâ€node 192.168.211.141:7007 192.168.211.141:7001</code></p>
<p>æ‰§è¡Œå‘½ä»¤åï¼Œæ•ˆæœå¦‚ä¸‹ï¼š </p>
<img src="/blog/2020/08/22/%E7%BC%93%E5%AD%98-Redis%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8/pic25.png" srcset="/blog/img/loading.gif" class>

<p>æ­¤æ—¶æˆ‘ä»¬å¯ä»¥è¿›å…¥åˆ°é›†ç¾¤èŠ‚ç‚¹ä¹‹ä¸€æŸ¥çœ‹æ­¤æ—¶çš„é›†ç¾¤çŠ¶æ€ï¼Œæˆ‘ä»¬è¿›å…¥åˆ° 7002 èŠ‚ç‚¹ä¸­è¾“å…¥ cluster node æŸ¥è¯¢ï¼Œæ“ä½œæ–¹æ³•å¦‚ä¸‹ï¼š</p>
<pre><code class="hljs sh">è¿›å…¥å®¹å™¨ 
docker <span class="hljs-built_in">exec</span> â€it redisâ€7002 /bin/bash 

è¿›å…¥åˆ°redisâ€cliè„šæœ¬ç›®å½• 
<span class="hljs-built_in">cd</span> /usr/<span class="hljs-built_in">local</span>/bin 

ç™»å½•7002èŠ‚ç‚¹ 
./redisâ€cli â€p 7002 â€c 

æŸ¥è¯¢é›†ç¾¤çŠ¶æ€ 
cluster nodes</code></pre>

<p>æ•ˆæœå¦‚ä¸‹</p>
<img src="/blog/2020/08/22/%E7%BC%93%E5%AD%98-Redis%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8/pic26.png" srcset="/blog/img/loading.gif" class>

<h5 id="å“ˆå¸Œæ§½åˆ†é…"><a href="#å“ˆå¸Œæ§½åˆ†é…" class="headerlink" title="å“ˆå¸Œæ§½åˆ†é…"></a>å“ˆå¸Œæ§½åˆ†é…</h5><img src="/blog/2020/08/22/%E7%BC%93%E5%AD%98-Redis%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8/pic27.png" srcset="/blog/img/loading.gif" class>

<p>ä»ä¸Šé¢çš„é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯æˆ‘ä»¬å¯ä»¥çœ‹å‡ºä¸€ä¸ªé—®é¢˜ï¼Œå…¶ä»–ä¸»èŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸²æ•°å­—èŒƒå›´ï¼Œè€Œåˆšæ‰æ·»åŠ çš„ 7007 èŠ‚ç‚¹æ²¡æœ‰è¿™æ®µæ•°å­—èŒƒå›´ï¼Œè¿™å’ŒRedisé›†ç¾¤åŸç†æœ‰å…³ç³»ï¼Œæˆ‘ä»¬æ¥è®²è§£ä¸€ä¸‹é›†ç¾¤çš„åŸç†ï¼Œç„¶åå®ç°æ–°å¢èŠ‚ç‚¹å“ˆå¸Œæ§½(è¿™æ®µæ•°å­—èŒƒå›´)çš„åˆ†é…ã€‚</p>
<img src="/blog/2020/08/22/%E7%BC%93%E5%AD%98-Redis%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8/pic28.png" srcset="/blog/img/loading.gif" class>

<p>Redis Cluster ç‰¹æ€§ä¹‹ä¸€æ˜¯å¼•å…¥äº†æ§½çš„æ¦‚å¿µã€‚ä¸€ä¸ªredisé›†ç¾¤åŒ…å« 16384 ä¸ªå“ˆå¸Œæ§½ã€‚ é›†ç¾¤æ—¶ï¼Œä¼šå°†16384ä¸ªå“ˆå¸Œæ§½åˆ†åˆ«åˆ†é…ç»™æ¯ä¸ªMasterèŠ‚ç‚¹ï¼Œæ¯ä¸ªMasterèŠ‚ç‚¹å 16384ä¸ªå“ˆå¸Œæ§½ä¸­çš„ä¸€éƒ¨åˆ†ã€‚æ‰§è¡ŒGET/SET/DELæ—¶ï¼Œéƒ½ä¼šæ ¹æ®keyè¿›è¡Œæ“ä½œï¼ŒRedisé€šè¿‡CRC16ç®—æ³•å¯¹keyè¿›è¡Œè®¡ç®—å¾—åˆ°è¯¥keyæ‰€å±RedisèŠ‚ç‚¹ã€‚ æ ¹æ®keyå»æŒ‡å®šRedisèŠ‚ç‚¹æ“ä½œæ•°æ®ã€‚</p>
<p>ä»åŸç†ä¸Šåˆ†æï¼Œå› ä¸ºä¹‹å‰ 7001,7002,7003 å·²ç»ç“œåˆ†äº†16384ä¸ªå“ˆå¸Œæ§½ï¼Œæ‰€ä»¥å†å¢åŠ ä¸€ä¸ªæ–°èŠ‚ç‚¹æ˜¯æ²¡æœ‰å‰©ä½™å“ˆå¸Œæ§½åˆ†é…çš„ï¼Œæ‰€ä»¥æ–°å¢çš„ 7007 èŠ‚ç‚¹æ²¡æœ‰åˆ†é…åˆ°å“ˆå¸Œæ§½ã€‚æˆ‘ä»¬åªèƒ½é‡æ–°åˆ†é…å“ˆå¸Œæ§½ï¼Œæ‰èƒ½è®©æ–°å¢èŠ‚ç‚¹åˆ†é…åˆ°ä¸€å®šçš„å“ˆå¸Œæ§½ï¼Œé‡æ–°åˆ†é…å“ˆå¸Œæ§½åï¼Œæˆ‘ä»¬è¿˜è¦è€ƒè™‘ä¹‹å‰å…¶ä»–RedisèŠ‚ç‚¹ä¸­çš„æ•°æ®è¿ç§»ã€‚  </p>
<p>é‡æ–°åˆ†é…<strong>Hash</strong>æ§½ </p>
<p>å°† 7001,7002,7003 ä¸­çš„ 100 ä¸ªå“ˆå¸Œæ§½æŒªç»™ 7007 ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š </p>
<pre><code class="hljs angelscript">./redisâ€cli â€â€cluster reshard <span class="hljs-number">192.168</span><span class="hljs-number">.211</span><span class="hljs-number">.141</span>:<span class="hljs-number">7001</span> \
â€â€clusterâ€<span class="hljs-keyword">from</span> c9687b2ebec8b99ee14fcbb885b5c3439c58827f,<span class="hljs-number">80</span>a69bb8af3737bce2913b2952b4456430a89eb3,<span class="hljs-number">612e4</span>af8eae484 <span class="hljs-number">26938</span>ce65d12a7d7376b0b37e3 \
â€â€clusterâ€to <span class="hljs-number">443096</span>af2ff8c1e89f1160faed4f6a02235822a7 \
â€â€clusterâ€slots <span class="hljs-number">100</span></code></pre>

<p>å°†èŠ‚ç‚¹c9687b2ebec8b99ee14fcbb885b5c3439c58827fã€80a69bb8af3737bce2913b2952b4456430a89eb3ã€612e4af8eae48426938ce65d12a7d7376b0b37e3ä¸­çš„100ä¸ªå“ˆå¸Œæ§½ç§»åŠ¨åˆ°443096af2ff8c1e89f1160faed4f6a02235822a7ä¸­</p>
<p>å‚æ•°è¯´æ˜ï¼š </p>
<pre><code class="hljs crmsh">â€â€clusterâ€fromï¼šè¡¨ç¤ºslotç›®å‰æ‰€åœ¨çš„èŠ‚ç‚¹çš„<span class="hljs-keyword">node</span> <span class="hljs-title">ID</span>ï¼Œå¤šä¸ªIDç”¨é€—å·åˆ†éš”
â€â€clusterâ€toï¼šè¡¨ç¤ºéœ€è¦æ–°åˆ†é…èŠ‚ç‚¹çš„<span class="hljs-keyword">node</span> <span class="hljs-title">ID</span>
â€â€clusterâ€slotsï¼šåˆ†é…çš„slotæ•°é‡</code></pre>

<p>å°†100ä¸ªå“ˆå¸Œæ§½æŒªç»™7007åï¼Œæˆ‘ä»¬æŸ¥è¯¢ä¸‹èŠ‚ç‚¹ä¿¡æ¯ï¼š</p>
<p><code>./redisâ€cli â€p 7001 cluster nodes|grep master</code></p>
<p>æ•ˆæœå¦‚ä¸‹ï¼š</p>
<img src="/blog/2020/08/22/%E7%BC%93%E5%AD%98-Redis%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8/pic29.png" srcset="/blog/img/loading.gif" class>

<h5 id="æ·»åŠ é›†ç¾¤ä»èŠ‚ç‚¹"><a href="#æ·»åŠ é›†ç¾¤ä»èŠ‚ç‚¹" class="headerlink" title="æ·»åŠ é›†ç¾¤ä»èŠ‚ç‚¹"></a>æ·»åŠ é›†ç¾¤ä»èŠ‚ç‚¹</h5><p>æˆ‘ä»¬éœ€è¦å¾€é›†ç¾¤ä¸­ç»™ 7007 èŠ‚ç‚¹æ·»åŠ ä¸€ä¸ªä»èŠ‚ç‚¹ 7008 ï¼Œæ·»åŠ ä»èŠ‚ç‚¹çš„ä¸»è¦ç›®çš„æ˜¯æé«˜é«˜å¯ç”¨ï¼Œé˜²æ­¢ä¸»èŠ‚ç‚¹å®•æœºåè¯¥èŠ‚ç‚¹æ— æ³•æä¾›æœåŠ¡ã€‚æ·»åŠ ä»èŠ‚ç‚¹å‘½ä»¤å¦‚ä¸‹ï¼š</p>
<pre><code class="hljs angelscript">./redisâ€cli â€â€cluster addâ€node <span class="hljs-number">192.168</span><span class="hljs-number">.211</span><span class="hljs-number">.141</span>:<span class="hljs-number">7008</span> <span class="hljs-number">192.168</span><span class="hljs-number">.211</span><span class="hljs-number">.141</span>:<span class="hljs-number">7007</span> \
â€â€clusterâ€slave â€â€clusterâ€masterâ€id <span class="hljs-number">443096</span>af2ff8c1e89f1160faed4f6a02235822a7</code></pre>

<p>å‘½ä»¤è¯´æ˜ï¼š </p>
<pre><code class="hljs angelscript">å°†<span class="hljs-number">192.168</span><span class="hljs-number">.211</span><span class="hljs-number">.141</span>:<span class="hljs-number">7008</span>èŠ‚ç‚¹æ·»åŠ åˆ°<span class="hljs-number">192.168</span><span class="hljs-number">.211</span><span class="hljs-number">.141</span>:<span class="hljs-number">7007</span>å¯¹åº”çš„é›†ç¾¤ä¸­ï¼Œå¹¶ä¸”åŠ å…¥çš„èŠ‚ç‚¹ä¸ºä»èŠ‚ç‚¹ï¼Œå¯¹åº”çš„ä¸»èŠ‚ç‚¹idæ˜¯<span class="hljs-number">443096</span>af2ff8c1e89f1160faed4f6a02235822a7</code></pre>

<p>å‚æ•°è¯´æ˜ï¼š </p>
<pre><code class="hljs crmsh">addâ€<span class="hljs-keyword">node</span><span class="hljs-title">: åé¢çš„åˆ†åˆ«è·Ÿç€æ–°åŠ å…¥çš„slave</span>å’Œ<span class="hljs-literal">slave</span>å¯¹åº”çš„<span class="hljs-keyword">master</span> <span class="hljs-title"></span>
<span class="hljs-title">cluster</span>â€<span class="hljs-literal">slave</span>ï¼šè¡¨ç¤ºåŠ å…¥çš„æ˜¯<span class="hljs-literal">slave</span>èŠ‚ç‚¹ 
â€â€clusterâ€<span class="hljs-literal">master</span>â€idï¼šè¡¨ç¤º<span class="hljs-literal">slave</span>å¯¹åº”çš„<span class="hljs-literal">master</span>çš„<span class="hljs-keyword">node</span> <span class="hljs-title">ID</span></code></pre>

<p>æ‰§è¡Œå‘½ä»¤åï¼Œæ•ˆæœå¦‚ä¸‹ï¼š</p>
<img src="/blog/2020/08/22/%E7%BC%93%E5%AD%98-Redis%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8/pic30.png" srcset="/blog/img/loading.gif" class>

<p>é›†ç¾¤ä¿¡æ¯æŸ¥çœ‹ï¼š </p>
<img src="/blog/2020/08/22/%E7%BC%93%E5%AD%98-Redis%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8/pic31.png" srcset="/blog/img/loading.gif" class>

<h5 id="ç¼©å®¹"><a href="#ç¼©å®¹" class="headerlink" title="ç¼©å®¹"></a>ç¼©å®¹</h5><p>åœ¨çœŸå®ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬ä¹Ÿä¼šè·Ÿç€æˆ‘ä»¬çš„ä¸šåŠ¡å’Œç¯å¢ƒæ‰§è¡Œç¼©å®¹å¤„ç†ï¼Œæ¯”å¦‚åŒåä¸€è¿‡åï¼Œæµé‡æ²¡æœ‰é‚£ä¹ˆå¤§äº†ï¼Œæˆ‘ä»¬å¾€å¾€ä¼šç¼©å®¹å¤„ç†ï¼ŒæœåŠ¡å™¨å¼€é”€ã€‚ </p>
<p>Rediså®ç°ç¼©å®¹ï¼Œéœ€è¦å“ˆå¸Œæ§½é‡æ–°åˆ†é…ï¼Œå°†éœ€è¦ç§»é™¤çš„èŠ‚ç‚¹æ‰€åˆ†é…çš„æ‰€æœ‰å“ˆå¸Œæ§½å€¼åˆ†é…ç»™å…¶ä»–éœ€è¦è¿è¡Œå·¥ä½œçš„èŠ‚ç‚¹ï¼Œè¿˜éœ€è¦ç§»é™¤è¯¥èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹ï¼Œç„¶åå†åˆ é™¤è¯¥èŠ‚ç‚¹ã€‚ </p>
<p>ç§»é™¤ä»èŠ‚ç‚¹</p>
<p>ç§»é™¤ 7007 çš„ä»èŠ‚ç‚¹ 7008 ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p>
<p><code>./redisâ€cli â€â€cluster delâ€node 192.168.211.141:7008 98be71d8d6eff6bd40947fa0441e5a821dce20ae</code></p>
<p>å‚æ•°è¯´æ˜ï¼š </p>
<p><code>delâ€node:åˆ é™¤èŠ‚ç‚¹ï¼Œåé¢è·Ÿç€slaveèŠ‚ç‚¹çš„ ip:port å’Œnode ID</code></p>
<p>åˆ é™¤åï¼Œæˆ‘ä»¬å†æ¥æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹ï¼Œæ­¤æ—¶å†æ— 7008èŠ‚ç‚¹</p>
<img src="/blog/2020/08/22/%E7%BC%93%E5%AD%98-Redis%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8/pic32.png" srcset="/blog/img/loading.gif" class>

<p>è¿ç§»<strong>Master</strong>çš„<strong>Slot</strong></p>
<p>æˆ‘ä»¬éœ€è¦å°† 7007 èŠ‚ç‚¹çš„å“ˆå¸Œæ§½è¿ç§»åˆ° 7001,7002,7003 èŠ‚ç‚¹ä¸Šï¼Œä»ç„¶ç”¨ä¸Šé¢ç”¨è¿‡çš„ redis-cli â€“cluster reshardè¯­æ³•ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š </p>
<p>ç¬¬1æ¬¡è¿ç§»ï¼š</p>
<pre><code class="hljs angelscript">./redisâ€cli â€â€cluster reshard <span class="hljs-number">192.168</span><span class="hljs-number">.211</span><span class="hljs-number">.141</span>:<span class="hljs-number">7007</span> â€\
â€clusterâ€<span class="hljs-keyword">from</span> <span class="hljs-number">443096</span>af2ff8c1e89f1160faed4f6a02235822a7 \
â€â€clusterâ€to <span class="hljs-number">80</span>a69bb8af3737bce2913b2952b4456430a89eb3 \
â€â€clusterâ€slots <span class="hljs-number">33</span> â€â€clusterâ€yes</code></pre>

<p>å‘½ä»¤è¯´æ˜ï¼š </p>
<p>å°†192.168.211.141:7007èŠ‚ç‚¹æ‰€åœ¨é›†ç¾¤ä¸­443096af2ff8c1e89f1160faed4f6a02235822a7èŠ‚ç‚¹çš„33ä¸ªå“ˆå¸Œæ§½è¿ç§»ç»™ 80a69bb8af3737bce2913b2952b4456430a89eb3èŠ‚ç‚¹ï¼Œä¸å›æ˜¾éœ€è¦è¿ç§»çš„slotï¼Œç›´æ¥è¿ç§»ã€‚</p>
<p>æ•ˆæœå¦‚ä¸‹ï¼š</p>
<img src="/blog/2020/08/22/%E7%BC%93%E5%AD%98-Redis%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8/pic33.png" srcset="/blog/img/loading.gif" class>

<p>æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹ï¼š </p>
<img src="/blog/2020/08/22/%E7%BC%93%E5%AD%98-Redis%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8/pic34.png" srcset="/blog/img/loading.gif" class>

<p>æˆ‘ä»¬å†æ¬¡è¿ç§»å…¶ä»–å“ˆå¸Œæ§½åˆ°å…¶ä»–èŠ‚ç‚¹ï¼Œå°†å‰©ä½™çš„å“ˆå¸Œæ§½è¿ç§»åˆ°7002å’Œ7003å»ã€‚ </p>
<p>ç¬¬2æ¬¡è¿ç§»ï¼š </p>
<pre><code class="hljs sh">./redisâ€cli â€â€cluster reshard 192.168.211.141:7007 \
â€â€clusterâ€from 443096af2ff8c1e89f1160faed4f6a02235822a7 \
â€â€clusterâ€to c9687b2ebec8b99ee14fcbb885b5c3439c58827f \
â€â€clusterâ€slots 34 â€â€clusterâ€yes</code></pre>

<p>ç¬¬3æ¬¡è¿ç§»ï¼š </p>
<pre><code class="hljs sh">./redisâ€cli â€â€cluster reshard 192.168.211.141:7007 \
â€â€clusterâ€from 443096af2ff8c1e89f1160faed4f6a02235822a7 \
â€â€clusterâ€to 612e4af8eae48426938ce65d12a7d7376b0b37e3 \
â€â€clusterâ€slots 33 â€â€clusterâ€yes</code></pre>

<p>é›†ç¾¤çŠ¶æ€æŸ¥è¯¢ï¼š </p>
<img src="/blog/2020/08/22/%E7%BC%93%E5%AD%98-Redis%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8/pic35.png" srcset="/blog/img/loading.gif" class>

<p>åˆ é™¤<strong>7007</strong>ä¸»èŠ‚ç‚¹</p>
<p>åˆ é™¤èŠ‚ç‚¹å‘½ä»¤å¦‚ä¸‹ï¼š </p>
<p><code>./redisâ€cli â€â€cluster delâ€node 192.168.211.141:7007 443096af2ff8c1e89f1160faed4f6a02235822a7</code></p>
<p>æ•ˆæœå¦‚ä¸‹ï¼š</p>
<img src="/blog/2020/08/22/%E7%BC%93%E5%AD%98-Redis%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8/pic36.png" srcset="/blog/img/loading.gif" class>

<p>é›†ç¾¤èŠ‚ç‚¹æŸ¥çœ‹ï¼š </p>
<img src="/blog/2020/08/22/%E7%BC%93%E5%AD%98-Redis%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8/pic37.png" srcset="/blog/img/loading.gif" class>

<h2 id="Redis-Sentinel"><a href="#Redis-Sentinel" class="headerlink" title="Redis Sentinel"></a>Redis Sentinel</h2><p>redisä¸»ä»å¤åˆ¶ç»“æ„ä¸»èŠ‚ç‚¹æ•…éšœæ—¶ï¼Œä»éœ€è¦äººå·¥é‡æ–°åœ¨ä»èŠ‚ç‚¹ä¸­æ‰§è¡Œ<code>slaveof no one</code>åå˜ä¸ºæ–°ä¸»èŠ‚ç‚¹ï¼Œå…¶ä»–çš„èŠ‚ç‚¹æˆä¸ºæ–°ä¸»èŠ‚ç‚¹çš„ä¸›èŠ‚ç‚¹ï¼Œå¹¶ä»æ–°èŠ‚ç‚¹å¤åˆ¶æ•°æ®ï¼Œç„¶åé€šçŸ¥æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºæ›´æ–°äº†ä¸»èŠ‚ç‚¹çš„åœ°å€ã€‚è¿™ç§å¤„ç†æ–¹å¼æ— æ³•å®ç°é«˜å¯ç”¨ï¼Œä½¿ç”¨å“¨å…µæœºåˆ¶å¯ä»¥åœ¨ä¸»èŠ‚ç‚¹å‡ºç°æ•…éšœæ—¶ï¼Œç”±Redis Sentinelè‡ªåŠ¨å®Œæˆæ•…éšœå‘ç°å’Œè½¬ç§»ï¼Œå¹¶é€šçŸ¥åº”ç”¨æ–¹ï¼Œå®ç°é«˜å¯ç”¨æ€§ã€‚</p>
<p>æ³¨æ„ï¼šåœ¨ä»£ç ä¸­è¿æ¥redisæ—¶ï¼Œéœ€è¦è¿æ¥å“¨å…µèŠ‚ç‚¹ï¼Œç”±å“¨å…µèŠ‚ç‚¹åŠ¨æ€çš„é€‰æ‹©redisä¸»èŠ‚ç‚¹ã€‚</p>
<h4 id="ç›‘æ§æœºåˆ¶"><a href="#ç›‘æ§æœºåˆ¶" class="headerlink" title="ç›‘æ§æœºåˆ¶"></a>ç›‘æ§æœºåˆ¶</h4><img src="/blog/2020/08/22/%E7%BC%93%E5%AD%98-Redis%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8/pic5.png" srcset="/blog/img/loading.gif" class>

<p>å“¨å…µçš„æ•°é‡ä¸€èˆ¬æ˜¯å¥‡æ•°ä¸ªï¼Œå½“èŠ‚ç‚¹å‡ºç°æ•…éšœæ˜¯ï¼Œé¦–å…ˆä½¿ç”¨Raftç®—æ³•å®ç°é€‰ä¸¾æœºåˆ¶ï¼Œé€‰å‡ºä¸€ä¸ªå“¨å…µèŠ‚ç‚¹æ¥å®Œæˆè½¬ç§»å’Œé€šçŸ¥ã€‚</p>
<p>å“¨å…µæœ‰ä¸‰ä¸ªå®šæ—¶ç›‘æ§ä»»åŠ¡å®Œæˆå¯¹å„èŠ‚ç‚¹çš„å‘ç°å’Œç›‘æ§ï¼š</p>
<ul>
<li><p>æ¯ä¸ªå“¨å…µèŠ‚ç‚¹æ¯10ç§’ä¼šå‘ä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹å‘é€infoå‘½ä»¤è·å–æœ€æ‹“æ‰‘ç»“æ„å›¾ï¼Œå“¨å…µé…ç½®æ—¶åªè¦é…ç½®å¯¹ä¸»èŠ‚ç‚¹çš„ç›‘æ§å³å¯ï¼Œé€šè¿‡å‘ä¸»èŠ‚ç‚¹å‘é€infoï¼Œè·å–ä»èŠ‚ç‚¹çš„ä¿¡æ¯ï¼Œå¹¶å½“æœ‰æ–°çš„ä»èŠ‚ç‚¹åŠ å…¥æ—¶å¯ä»¥é©¬ä¸Šæ„ŸçŸ¥åˆ°ã€‚</p>
<img src="/blog/2020/08/22/%E7%BC%93%E5%AD%98-Redis%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8/pic38.png" srcset="/blog/img/loading.gif" class>
</li>
<li><p>æ¯ä¸ªå“¨å…µèŠ‚ç‚¹æ¯éš”2ç§’ä¼šå‘redisæ•°æ®èŠ‚ç‚¹çš„ __sentinel__ï¼šhelloé¢‘é“ä¸Šå‘é€è¯¥å“¨å…µèŠ‚ç‚¹å¯¹äºä¸»èŠ‚ç‚¹çš„åˆ¤æ–­ä»¥åŠå½“å‰å“¨å…µèŠ‚ç‚¹çš„ä¿¡æ¯ï¼ŒåŒæ—¶æ¯ä¸ªå“¨å…µèŠ‚ç‚¹ä¹Ÿä¼šè®¢é˜…è¯¥é¢‘é“ï¼Œæ¥äº†è§£å…¶å®ƒå“¨å…µèŠ‚ç‚¹çš„ä¿¡æ¯åŠå¯¹ä¸»èŠ‚ç‚¹çš„åˆ¤æ–­ï¼Œå…¶å®å°±æ˜¯é€šè¿‡æ¶ˆæ¯publishå’Œsubscribeæ¥å®Œæˆçš„ã€‚è¯¥å®šæ—¶ä»»åŠ¡ä¸»è¦æœ‰2ä¸ªä½œç”¨ï¼š</p>
<ul>
<li>å‘ç°æ–°çš„SentinelèŠ‚ç‚¹ï¼šé€šè¿‡è®¢é˜…ä¸»èŠ‚ç‚¹çš„<strong>sentinel</strong>ï¼šhelloäº†è§£å…¶ä»–çš„SentinelèŠ‚ç‚¹ä¿¡æ¯ï¼Œå¦‚æœæ˜¯æ–°åŠ å…¥çš„SentinelèŠ‚ç‚¹ï¼Œå°†è¯¥SentinelèŠ‚ç‚¹ä¿¡æ¯ä¿å­˜èµ·æ¥ï¼Œå¹¶ä¸è¯¥SentinelèŠ‚ç‚¹åˆ›å»ºè¿æ¥ã€‚ </li>
<li>SentinelèŠ‚ç‚¹ä¹‹é—´äº¤æ¢ä¸»èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œä½œä¸ºåé¢å®¢è§‚ä¸‹çº¿ä»¥åŠé¢†å¯¼è€…é€‰ä¸¾çš„ä¾æ®ã€‚ </li>
</ul>
<img src="/blog/2020/08/22/%E7%BC%93%E5%AD%98-Redis%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8/pic39.png" srcset="/blog/img/loading.gif" class>
</li>
<li><p>æ¯éš”1ç§’æ¯ä¸ªå“¨å…µä¼šå‘ä¸»èŠ‚ç‚¹ã€ä»èŠ‚ç‚¹åŠå…¶ä½™å“¨å…µèŠ‚ç‚¹å‘é€ä¸€æ¬¡pingå‘½ä»¤åšä¸€æ¬¡å¿ƒè·³æ£€æµ‹ï¼Œæ¥ç¡®è®¤è¿™äº›èŠ‚ç‚¹å½“å‰æ˜¯å¦å¯è¾¾ï¼Œä»è€Œå®ç°æ£€æŸ¥æ¯ä¸ªèŠ‚ç‚¹çš„å¥åº·çŠ¶æ€ã€‚ </p>
<img src="/blog/2020/08/22/%E7%BC%93%E5%AD%98-Redis%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8/pic40.png" srcset="/blog/img/loading.gif" class>

</li>
</ul>
<p>ä¸»è§‚ä¸‹çº¿ï¼šå“¨å…µèŠ‚ç‚¹æ¯éš”1ç§’å¯¹ä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹ã€å…¶å®ƒå“¨å…µèŠ‚ç‚¹å‘é€pingåšå¿ƒè·³æ£€æµ‹ï¼Œå½“è¿™äº›å¿ƒè·³æ£€æµ‹æ—¶é—´è¶…è¿‡<code>down-after-milliseconds</code>æ—¶ï¼Œå“¨å…µèŠ‚ç‚¹åˆ™è®¤ä¸ºè¯¥èŠ‚ç‚¹æ•…éšœæˆ–ä¸‹çº¿ï¼Œä½†è¿™è¿™å¯èƒ½ä¼šå­˜åœ¨è¯¯åˆ¤ã€‚</p>
<p>å®¢è§‚ä¸‹çº¿ï¼šå½“ä¸»è§‚ä¸‹çº¿çš„èŠ‚ç‚¹æ˜¯ä¸»èŠ‚ç‚¹æ—¶ï¼Œæ­¤æ—¶è¯¥å“¨å…µèŠ‚ç‚¹ä¼šé€šè¿‡æŒ‡ä»¤<code>sentinelis-masterdown-by-addr</code>å¯»æ±‚å…¶å®ƒå“¨å…µèŠ‚ç‚¹å¯¹ä¸»èŠ‚ç‚¹çš„åˆ¤æ–­ï¼Œå½“è®¤ä¸ºè¯¥èŠ‚ç‚¹å‡ºç°æ•…éšœçš„å“¨å…µæ•°å½“è¶…è¿‡<code>quorum</code>ï¼ˆæ³•å®šäººæ•°ï¼‰ä¸ªæ•°æ—¶ï¼Œå°±æ˜¯å®¢è§‚ä¸‹çº¿ã€‚</p>
<h4 id="ä¸»è¦ä»»åŠ¡"><a href="#ä¸»è¦ä»»åŠ¡" class="headerlink" title="ä¸»è¦ä»»åŠ¡"></a>ä¸»è¦ä»»åŠ¡</h4><p>Redis Sentinelæ˜¯ç”¨äºç®¡ç†Redisé›†ç¾¤,ä¸»è¦æ‰§è¡Œå¦‚ä¸‹ä»»åŠ¡:</p>
<ol>
<li><p>ç›‘æ§(Monitoring) ï¼šSentinelä¼šä¸æ–­åœ°æ£€æŸ¥ä½ çš„ä¸»æœåŠ¡å™¨å’Œä»æœåŠ¡å™¨æ˜¯å¦è¿ä½œæ­£å¸¸; </p>
</li>
<li><p>æé†’(Notification) ï¼šå½“è¢«ç›‘æ§çš„æŸä¸ªRedisæœåŠ¡å™¨å‡ºç°é—®é¢˜æ—¶ï¼ŒSentinelå¯ä»¥é€šè¿‡APIå‘ç®¡ç†å‘˜æˆ–è€…å…¶ä»–åº”ç”¨ç¨‹åºå‘é€é€šçŸ¥; </p>
</li>
<li><p>è‡ªåŠ¨æ•…éšœè¿ç§»(Automatic failover) ï¼šå½“ä¸€ä¸ªä¸»æœåŠ¡å™¨ä¸èƒ½æ­£å¸¸å·¥ä½œæ—¶ï¼ŒSentinel ä¼šå¼€å§‹ä¸€æ¬¡è‡ªåŠ¨æ•…éšœè¿ç§»æ“ä½œï¼Œå®ƒä¼šå°†å¤±æ•ˆä¸»æœåŠ¡å™¨çš„å…¶ä¸­ä¸€ä¸ªä»æœåŠ¡å™¨å‡çº§ä¸ºæ–°çš„ä¸»æœåŠ¡å™¨ï¼Œå¹¶è®©å¤±æ•ˆä¸»æœåŠ¡å™¨çš„å…¶ä»–ä»æœåŠ¡å™¨æ”¹ä¸ºå¤åˆ¶æ–°çš„ä¸»æœåŠ¡å™¨ï¼›å½“å®¢æˆ·ç«¯è¯•å›¾è¿æ¥å¤±æ•ˆçš„ä¸»æœåŠ¡å™¨æ—¶ï¼Œé›†ç¾¤ä¹Ÿä¼šå‘å®¢æˆ·ç«¯è¿”å›æ–°ä¸»æœåŠ¡å™¨çš„åœ°å€,ä½¿å¾—é›†ç¾¤å¯ä»¥ä½¿ç”¨æ–°ä¸»æœåŠ¡å™¨ä»£æ›¿å¤±æ•ˆæœåŠ¡å™¨ã€‚</p>
</li>
</ol>
<h4 id="å“¨å…µé¢†å¯¼è€…é€‰ä¸¾æµç¨‹"><a href="#å“¨å…µé¢†å¯¼è€…é€‰ä¸¾æµç¨‹" class="headerlink" title="å“¨å…µé¢†å¯¼è€…é€‰ä¸¾æµç¨‹"></a>å“¨å…µé¢†å¯¼è€…é€‰ä¸¾æµç¨‹</h4><ol>
<li>æ¯ä¸ªåœ¨çº¿çš„å“¨å…µèŠ‚ç‚¹éƒ½å¯ä»¥æˆä¸ºé¢†å¯¼è€…ï¼Œå½“å®ƒå‘ç°ä¸»èŠ‚ç‚¹ä¸‹çº¿æ—¶ï¼Œä¼šå‘å…¶å®ƒå“¨å…µå‘<code>is-master-down-by-addr</code>å‘½ä»¤ï¼Œå¾æ±‚åˆ¤æ–­å¹¶è¦æ±‚å°†è‡ªå·±è®¾ç½®ä¸ºé¢†å¯¼è€…ï¼Œç”±é¢†å¯¼è€…å¤„ç†æ•…éšœè½¬ç§»ï¼›</li>
<li>å½“å…¶å®ƒå“¨å…µæ”¶åˆ°æ­¤å‘½ä»¤æ—¶ï¼Œå¯ä»¥åŒæ„æˆ–è€…æ‹’ç»å®ƒæˆä¸ºé¢†å¯¼è€…ï¼›</li>
<li>å¦‚æœå“¨å…µ3å‘ç°è‡ªå·±åœ¨é€‰ä¸¾çš„ç¥¨æ•°å¤§äºç­‰äºnum(sentinels)/2+1æ—¶ï¼Œå°†æˆä¸ºé¢†å¯¼è€…ï¼Œå¦‚æœæ²¡æœ‰è¶…è¿‡ï¼Œç»§ç»­é€‰ä¸¾ï¼›</li>
</ol>
<h4 id="æ•…éšœè½¬ç§»æœºåˆ¶"><a href="#æ•…éšœè½¬ç§»æœºåˆ¶" class="headerlink" title="æ•…éšœè½¬ç§»æœºåˆ¶"></a>æ•…éšœè½¬ç§»æœºåˆ¶</h4><ol>
<li>ç”±SentinelèŠ‚ç‚¹å®šæœŸç›‘æ§å‘ç°ä¸»èŠ‚ç‚¹æ˜¯å¦å‡ºç°äº†æ•…éšœï¼Œsentinelä¼šå‘masterå‘é€å¿ƒè·³PINGæ¥ç¡®è®¤masteræ˜¯å¦å­˜æ´»ï¼Œå¦‚æœmasteråœ¨ä¸€å®šæ—¶é—´èŒƒå›´å†…ä¸å›åº”PONGæˆ–è€…æ˜¯å›å¤äº†ä¸€ä¸ªé”™è¯¯æ¶ˆæ¯ï¼Œé‚£ä¹ˆè¿™ä¸ªsentinelä¼šä¸»è§‚åœ°ï¼ˆå•æ–¹é¢åœ°ï¼‰è®¤ä¸ºè¿™ä¸ªmasterå·²ç»ä¸å¯ç”¨äº†ã€‚</li>
<li>å½“ä¸»èŠ‚ç‚¹å‡ºç°æ•…éšœï¼Œæ­¤æ—¶3ä¸ªSentinelèŠ‚ç‚¹å…±åŒé€‰ä¸¾äº†Sentinel3èŠ‚ç‚¹ä¸ºé¢†å¯¼ï¼Œè´Ÿè½½å¤„ç†ä¸»èŠ‚ç‚¹çš„æ•…éšœè½¬ç§»ã€‚</li>
<li>ç”±Sentinel3é¢†å¯¼è€…èŠ‚ç‚¹æ‰§è¡Œæ•…éšœè½¬ç§»ï¼Œè¿‡ç¨‹å’Œä¸»ä»å¤åˆ¶ä¸€æ ·ï¼Œä½†æ˜¯è‡ªåŠ¨æ‰§è¡Œã€‚</li>
</ol>
<h4 id="æ•…éšœå¤„ç†æµç¨‹"><a href="#æ•…éšœå¤„ç†æµç¨‹" class="headerlink" title="æ•…éšœå¤„ç†æµç¨‹"></a>æ•…éšœå¤„ç†æµç¨‹</h4><img src="/blog/2020/08/22/%E7%BC%93%E5%AD%98-Redis%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8/pic6.png" srcset="/blog/img/loading.gif" class>

<ol>
<li>å°†slave-1è„±ç¦»åŸä»èŠ‚ç‚¹ï¼Œå‡çº§ä¸»èŠ‚ç‚¹ï¼Œ</li>
<li>å°†ä»èŠ‚ç‚¹slave-2æŒ‡å‘æ–°çš„ä¸»èŠ‚ç‚¹ã€‚</li>
<li>é€šçŸ¥å®¢æˆ·ç«¯ä¸»èŠ‚ç‚¹å·²æ›´æ¢ã€‚</li>
<li>å°†åŸä¸»èŠ‚ç‚¹ï¼ˆoldMasterï¼‰å˜æˆä»èŠ‚ç‚¹ï¼ŒæŒ‡å‘æ–°çš„ä¸»èŠ‚ç‚¹ã€‚</li>
</ol>
<img src="/blog/2020/08/22/%E7%BC%93%E5%AD%98-Redis%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8/pic7.png" srcset="/blog/img/loading.gif" class>

<h4 id="ä¸»èŠ‚ç‚¹çš„é€‰æ‹©æ–¹å¼"><a href="#ä¸»èŠ‚ç‚¹çš„é€‰æ‹©æ–¹å¼" class="headerlink" title="ä¸»èŠ‚ç‚¹çš„é€‰æ‹©æ–¹å¼"></a>ä¸»èŠ‚ç‚¹çš„é€‰æ‹©æ–¹å¼</h4><img src="/blog/2020/08/22/%E7%BC%93%E5%AD%98-Redis%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8/pic8.png" srcset="/blog/img/loading.gif" class>

<ol>
<li>è¿‡æ»¤æ‰ä¸å¥åº·çš„(ä¸‹çº¿æˆ–æ–­çº¿)ï¼Œæ²¡æœ‰å›å¤è¿‡å“¨å…µpingå“åº”çš„ä»èŠ‚ç‚¹</li>
<li>é€‰æ‹©slave-priorityä»èŠ‚ç‚¹ä¼˜å…ˆçº§æœ€é«˜ï¼ˆredis.confï¼‰</li>
<li>é€‰æ‹©å¤åˆ¶åç§»é‡æœ€å¤§ï¼ŒæŒ‡å¤åˆ¶æœ€å®Œæ•´çš„ä»èŠ‚ç‚¹</li>
</ol>
<h4 id="Sentinelæ­å»º"><a href="#Sentinelæ­å»º" class="headerlink" title="Sentinelæ­å»º"></a>Sentinelæ­å»º</h4><p>æˆ‘ä»¬è¿™é‡Œæ­å»º3ä¸ªå“¨å…µï¼Œé‡‡ç”¨Dockerçš„æ–¹å¼æ­å»ºã€‚ </p>
<table>
<thead>
<tr>
<th>èŠ‚ç‚¹</th>
<th>IP</th>
<th>ç«¯å£</th>
<th>ç›‘å¬èŠ‚ç‚¹</th>
</tr>
</thead>
<tbody><tr>
<td>Sentinel1</td>
<td>192.168.211.141</td>
<td>8001</td>
<td>7001,7002,7003</td>
</tr>
<tr>
<td>Sentinel2</td>
<td>192.168.211.141</td>
<td>8002</td>
<td>7001,7002,7003</td>
</tr>
<tr>
<td>Sentinel3</td>
<td>192.168.211.141</td>
<td>8003</td>
<td>7001,7002,7003</td>
</tr>
</tbody></table>
<p>æ–°å»ºæ–‡ä»¶å¤¹ sentinel1 , sentinel2 , sentinel3 ï¼Œå¹¶åœ¨æ¯ä¸ªæ–‡ä»¶å¤¹ä¸­åˆ›å»º conf , data ç›®å½•ï¼Œåˆ†åˆ«åœ¨æ¯ä¸ª conf ç›®å½•ä¸‹åˆ›å»º sentinel.conf æ–‡ä»¶,åœ¨ sentinelX ç›®å½•ä¸‹æ‰§è¡Œå®‰è£…å‘½ä»¤ã€‚ </p>
<p>sentinel1/sentinel.confé…ç½®ï¼š </p>
<pre><code class="hljs sh"><span class="hljs-comment">#ç«¯å£ </span>
port 8001 
<span class="hljs-comment"># é…å¥½masterå³å¯ï¼Œsentinelå¯é€šè¿‡masteræ‰¾åˆ°slave </span>
sentinel monitor redisâ€7001 192.168.211.141 7001 1 
sentinel monitor redisâ€7002 192.168.211.141 7002 1 
sentinel monitor redisâ€7003 192.168.211.141 7003 1 
<span class="hljs-comment"># é…ç½®masterçš„è®¿é—®å¯†ç ï¼Œå¦åˆ™masterä¸€ç›´æ˜¾ç¤ºsdown </span>
<span class="hljs-comment">#sentinel authâ€pass redisâ€7001 123456 </span>
<span class="hljs-comment">#sentinel authâ€pass redisâ€7002 123456 </span>
<span class="hljs-comment">#sentinel authâ€pass redisâ€7003 123456</span>
<span class="hljs-comment"># ä»¥ä¸‹é»˜è®¤å€¼å³å¯ï¼Œä¸éœ€è¦é…ç½® </span>
<span class="hljs-comment"># sentinel downâ€afterâ€milliseconds &#123;masterName&#125; &#123;time&#125; </span>
<span class="hljs-comment"># sentinel parallelâ€syncs &#123;masterName&#125; &#123;number&#125; </span>
<span class="hljs-comment"># sentinel failoverâ€timeout &#123;masterName&#125; &#123;time&#125;</span></code></pre>

<p>é…ç½®è¯´æ˜ï¼š </p>
<pre><code class="hljs crmsh">ã€sentinel <span class="hljs-literal">monitor</span> <span class="hljs-tag">&lt;masterâ€name&gt;</span> <span class="hljs-tag">&lt;ip&gt;</span> <span class="hljs-tag">&lt;redisâ€port&gt;</span> <span class="hljs-tag">&lt;quorum&gt;</span>ã€‘ 
å‘Šè¯‰sentinelå»ç›‘å¬åœ°å€ä¸ºip:portçš„ä¸€ä¸ª<span class="hljs-literal">master</span>ï¼Œè¿™é‡Œçš„<span class="hljs-literal">master</span>â€nameå¯ä»¥è‡ªå®šä¹‰ï¼Œquorumæ˜¯ä¸€ä¸ªæ•°å­—ï¼ŒæŒ‡æ˜å½“æœ‰å¤š å°‘ä¸ªsentinelè®¤ä¸ºä¸€ä¸ª<span class="hljs-literal">master</span>å¤±æ•ˆæ—¶ï¼Œ<span class="hljs-literal">master</span>æ‰ç®—çœŸæ­£å¤±æ•ˆã€‚<span class="hljs-literal">master</span>â€nameåªèƒ½åŒ…å«è‹±æ–‡å­—æ¯ï¼Œæ•°å­—ï¼Œå’Œâ€œ.â€_â€è¿™ä¸‰ä¸ª å­—ç¬¦éœ€è¦æ³¨æ„çš„æ˜¯<span class="hljs-literal">master</span>â€ip è¦å†™çœŸå®çš„ipåœ°å€è€Œä¸è¦ç”¨å›ç¯åœ°å€ï¼ˆ<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>ï¼‰ã€‚ 
ã€sentinel authâ€pass <span class="hljs-tag">&lt;masterâ€name&gt;</span> <span class="hljs-tag">&lt;password&gt;</span>ã€‘ è®¾ç½®è¿æ¥<span class="hljs-literal">master</span>å’Œ<span class="hljs-literal">slave</span>æ—¶çš„å¯†ç ï¼Œæ³¨æ„çš„æ˜¯sentinelä¸èƒ½åˆ†åˆ«ä¸º<span class="hljs-literal">master</span>å’Œ<span class="hljs-literal">slave</span>è®¾ç½®ä¸åŒçš„å¯†ç ï¼Œå› æ­¤<span class="hljs-literal">master</span>å’Œ <span class="hljs-literal">slave</span>çš„å¯†ç åº”è¯¥è®¾ç½®ç›¸åŒã€‚ 
é…ç½®ç¤ºä¾‹ï¼šsentinel authâ€pass itheima itheima</code></pre>

<p>sentinel2/sentinel.conf</p>
<pre><code class="hljs sh"><span class="hljs-comment">#ç«¯å£ </span>
port 8002
<span class="hljs-comment"># é…å¥½masterå³å¯ï¼Œsentinelå¯é€šè¿‡masteræ‰¾åˆ°slave </span>
sentinel monitor redisâ€7001 192.168.211.141 7001 1 
sentinel monitor redisâ€7002 192.168.211.141 7002 1 
sentinel monitor redisâ€7003 192.168.211.141 7003 1 
<span class="hljs-comment"># é…ç½®masterçš„è®¿é—®å¯†ç ï¼Œå¦åˆ™masterä¸€ç›´æ˜¾ç¤ºsdown </span>
<span class="hljs-comment">#sentinel authâ€pass redisâ€7001 123456 </span>
<span class="hljs-comment">#sentinel authâ€pass redisâ€7002 123456 </span>
<span class="hljs-comment">#sentinel authâ€pass redisâ€7003 123456</span>
<span class="hljs-comment"># ä»¥ä¸‹é»˜è®¤å€¼å³å¯ï¼Œä¸éœ€è¦é…ç½® </span>
<span class="hljs-comment"># sentinel downâ€afterâ€milliseconds &#123;masterName&#125; &#123;time&#125; </span>
<span class="hljs-comment"># sentinel parallelâ€syncs &#123;masterName&#125; &#123;number&#125; </span>
<span class="hljs-comment"># sentinel failoverâ€timeout &#123;masterName&#125; &#123;time&#125;</span></code></pre>

<p>sentinel3/sentinel.conf</p>
<pre><code class="hljs sh"><span class="hljs-comment">#ç«¯å£ </span>
port 8002
<span class="hljs-comment"># é…å¥½masterå³å¯ï¼Œsentinelå¯é€šè¿‡masteræ‰¾åˆ°slave </span>
sentinel monitor redisâ€7001 192.168.211.141 7001 1 
sentinel monitor redisâ€7002 192.168.211.141 7002 1 
sentinel monitor redisâ€7003 192.168.211.141 7003 1 
<span class="hljs-comment"># é…ç½®masterçš„è®¿é—®å¯†ç ï¼Œå¦åˆ™masterä¸€ç›´æ˜¾ç¤ºsdown </span>
<span class="hljs-comment">#sentinel authâ€pass redisâ€7001 123456 </span>
<span class="hljs-comment">#sentinel authâ€pass redisâ€7002 123456 </span>
<span class="hljs-comment">#sentinel authâ€pass redisâ€7003 123456</span>
<span class="hljs-comment"># ä»¥ä¸‹é»˜è®¤å€¼å³å¯ï¼Œä¸éœ€è¦é…ç½® </span>
<span class="hljs-comment"># sentinel downâ€afterâ€milliseconds &#123;masterName&#125; &#123;time&#125; </span>
<span class="hljs-comment"># sentinel parallelâ€syncs &#123;masterName&#125; &#123;number&#125; </span>
<span class="hljs-comment"># sentinel failoverâ€timeout &#123;masterName&#125; &#123;time&#125;</span></code></pre>

<p><strong>Docker</strong>å®‰è£…ï¼š </p>
<p>sentinel1</p>
<pre><code class="hljs sh">docker run â€d â€p 8001:8001 â€v <span class="hljs-variable">$PWD</span>/data:/data \
â€v <span class="hljs-variable">$PWD</span>/conf/sentinel.conf:/etc/redis/sentinel.conf \
â€â€network redisâ€net â€â€name sentinel1 \
â€â€privileged=<span class="hljs-literal">true</span> redis:6.0.5 redisâ€sentinel /etc/redis/sentinel.conf</code></pre>

<p>sentinel2</p>
<pre><code class="hljs sh">docker run â€d â€p 8002:8002 â€v <span class="hljs-variable">$PWD</span>/data:/data \
â€v <span class="hljs-variable">$PWD</span>/conf/sentinel.conf:/etc/redis/sentinel.conf \
â€â€network redisâ€net â€â€name sentinel2 \
â€â€privileged=<span class="hljs-literal">true</span> redis:6.0.5 redisâ€sentinel /etc/redis/sentinel.conf</code></pre>

<p>sentinel3</p>
<pre><code class="hljs sh">docker run â€d â€p 8003:8003 â€v <span class="hljs-variable">$PWD</span>/data:/data \
â€v <span class="hljs-variable">$PWD</span>/conf/sentinel.conf:/etc/redis/sentinel.conf \
â€â€network redisâ€net â€â€name sentinel3 \
â€â€privileged=<span class="hljs-literal">true</span> redis:6.0.5 redisâ€sentinel /etc/redis/sentinel.conf</code></pre>

<h4 id="Sentinelé›†ç¾¤è®²è§£"><a href="#Sentinelé›†ç¾¤è®²è§£" class="headerlink" title="Sentinelé›†ç¾¤è®²è§£"></a>Sentinelé›†ç¾¤è®²è§£</h4><p>Sentinel1å¯åŠ¨ä¿¡æ¯å¦‚ä¸‹ï¼š </p>
<img src="/blog/2020/08/22/%E7%BC%93%E5%AD%98-Redis%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8/pic41.png" srcset="/blog/img/loading.gif" class>

<p>ç™»å½•Sentinel1ï¼Œè¾“å…¥ info å‘½ä»¤ï¼ŒæŸ¥çœ‹é›†ç¾¤ä¿¡æ¯ï¼š</p>
<img src="/blog/2020/08/22/%E7%BC%93%E5%AD%98-Redis%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8/pic42.png" srcset="/blog/img/loading.gif" class>

<p>å…³é—­ redis-7001 ï¼Œæ­¤æ—¶ä¼šå…ˆè¿›è¡Œä¸€æ¬¡+sdownï¼Œå†è¿›è¡Œä¸€æ¬¡+odownï¼Œä¹Ÿå°±æ˜¯å½“å‰Sentinelå…ˆè‡ªå·±åˆ¤æ–­è¯¥Rediså®•æœºäº†ï¼Œæ­¤æ—¶æ»¡è¶³å®•æœºåé¦ˆæ•°é‡ä¸º1ï¼Œå› æ­¤æœ‰æ‰§è¡Œäº†å®¢è§‚å®•æœºæç¤º+odownï¼Œæ•ˆæœå¦‚ä¸‹ï¼š </p>
<img src="/blog/2020/08/22/%E7%BC%93%E5%AD%98-Redis%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8/pic43.png" srcset="/blog/img/loading.gif" class>

<p>æ­¤æ—¶å†è¾“å…¥ info å¯ä»¥çœ‹åˆ°å¦‚ä¸‹ä¿¡æ¯ï¼Œ7001èŠ‚ç‚¹å·²ç»å®•æœº,èŠ‚ç‚¹è®¿é—®åœ°å€å˜æˆäº†7005ã€‚ </p>
<img src="/blog/2020/08/22/%E7%BC%93%E5%AD%98-Redis%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8/pic44.png" srcset="/blog/img/loading.gif" class>

<p>æˆ‘ä»¬é“¾æ¥Redisé›†ç¾¤ï¼Œæ‰§è¡Œæ•°æ®æ·»åŠ ï¼Œçœ‹7001æ‰€åœ¨å“ˆå¸Œæ§½çš„keyèƒ½å¦æ·»åŠ ã€‚</p>
<img src="/blog/2020/08/22/%E7%BC%93%E5%AD%98-Redis%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8/pic45.png" srcset="/blog/img/loading.gif" class>

<p>é›†ç¾¤çŠ¶æ€æŸ¥çœ‹ </p>
<img src="/blog/2020/08/22/%E7%BC%93%E5%AD%98-Redis%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8/pic46.png" srcset="/blog/img/loading.gif" class>

<p>å¯åŠ¨ redis-7001 ï¼Œå†æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ï¼Œæ­¤æ—¶ redis-7001 æ˜¯ redis-7005 çš„ä»èŠ‚ç‚¹ã€‚ </p>
<img src="/blog/2020/08/22/%E7%BC%93%E5%AD%98-Redis%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8/pic47.png" srcset="/blog/img/loading.gif" class>

<p>æ­¤æ—¶å“¨å…µè¿™è¾¹ä¼šå‡ºç°å¦‚ä¸‹æ—¥å¿—ï¼Œè¡¨ç¤º7001èŠ‚ç‚¹å®¢è§‚ä¸Šå®•æœºæ¬¡æ•°-1ï¼Œå¹¶ä¸”å°†è¯¥èŠ‚ç‚¹æ·»åŠ ä¸º7005çš„ä»èŠ‚ç‚¹ï¼š </p>
<img src="/blog/2020/08/22/%E7%BC%93%E5%AD%98-Redis%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8/pic48.png" srcset="/blog/img/loading.gif" class>

<p>æ—¥å¿—è§£è¯»</p>
<pre><code class="hljs sql">+<span class="hljs-keyword">reset</span>â€<span class="hljs-keyword">master</span> &lt;<span class="hljs-keyword">instance</span> details&gt; ï¼šä¸»æœåŠ¡å™¨å·²è¢«é‡ç½®ã€‚
+<span class="hljs-keyword">slave</span> &lt;<span class="hljs-keyword">instance</span> details&gt; ï¼šä¸€ä¸ªæ–°çš„ä»æœåŠ¡å™¨å·²ç»è¢« Sentinel è¯†åˆ«å¹¶å…³è”ã€‚
+<span class="hljs-keyword">failover</span>â€stateâ€reconfâ€slaves &lt;<span class="hljs-keyword">instance</span> details&gt; ï¼šæ•…éšœè½¬ç§»çŠ¶æ€åˆ‡æ¢åˆ°äº† reconfâ€slaves çŠ¶æ€ã€‚ 
+<span class="hljs-keyword">failover</span>â€detected &lt;<span class="hljs-keyword">instance</span> details&gt; ï¼šå¦ä¸€ä¸ª Sentinel å¼€å§‹äº†ä¸€æ¬¡æ•…éšœè½¬ç§»æ“ä½œï¼Œæˆ–è€…ä¸€ä¸ªä»æœåŠ¡å™¨è½¬æ¢ æˆäº†ä¸»æœåŠ¡å™¨ã€‚ 
+<span class="hljs-keyword">slave</span>â€reconfâ€sent &lt;<span class="hljs-keyword">instance</span> details&gt; ï¼šé¢†å¤´ï¼ˆleaderï¼‰çš„ Sentinel å‘å®ä¾‹å‘é€äº† SLAVEOF å‘½ä»¤ï¼Œä¸ºå®ä¾‹ è®¾ç½®æ–°çš„ä¸»æœåŠ¡å™¨ã€‚ 
+<span class="hljs-keyword">slave</span>â€reconfâ€inprog &lt;<span class="hljs-keyword">instance</span> details&gt; ï¼šå®ä¾‹æ­£åœ¨å°†è‡ªå·±è®¾ç½®ä¸ºæŒ‡å®šä¸»æœåŠ¡å™¨çš„ä»æœåŠ¡å™¨ï¼Œä½†ç›¸åº”çš„åŒæ­¥è¿‡ç¨‹ ä»æœªå®Œæˆã€‚ 
+<span class="hljs-keyword">slave</span>â€reconfâ€done &lt;<span class="hljs-keyword">instance</span> details&gt; ï¼šä»æœåŠ¡å™¨å·²ç»æˆåŠŸå®Œæˆå¯¹æ–°ä¸»æœåŠ¡å™¨çš„åŒæ­¥ã€‚ 
â€dupâ€sentinel &lt;<span class="hljs-keyword">instance</span> details&gt; ï¼šå¯¹ç»™å®šä¸»æœåŠ¡å™¨è¿›è¡Œç›‘è§†çš„ä¸€ä¸ªæˆ–å¤šä¸ª Sentinel å·²ç»å› ä¸ºé‡å¤å‡ºç°è€Œè¢«ç§» é™¤ â€”â€” å½“ Sentinel å®ä¾‹é‡å¯çš„æ—¶å€™ï¼Œå°±ä¼šå‡ºç°è¿™ç§æƒ…å†µã€‚ 
+sentinel &lt;<span class="hljs-keyword">instance</span> details&gt; ï¼šä¸€ä¸ªç›‘è§†ç»™å®šä¸»æœåŠ¡å™¨çš„æ–° Sentinel å·²ç»è¢«è¯†åˆ«å¹¶æ·»åŠ ã€‚ 
+sdown &lt;<span class="hljs-keyword">instance</span> details&gt; ï¼šç»™å®šçš„å®ä¾‹ç°åœ¨å¤„äºä¸»è§‚ä¸‹çº¿çŠ¶æ€ã€‚ 
â€sdown &lt;<span class="hljs-keyword">instance</span> details&gt; ï¼šç»™å®šçš„å®ä¾‹å·²ç»ä¸å†å¤„äºä¸»è§‚ä¸‹çº¿çŠ¶æ€ã€‚ 
+odown &lt;<span class="hljs-keyword">instance</span> details&gt; ï¼šç»™å®šçš„å®ä¾‹ç°åœ¨å¤„äºå®¢è§‚ä¸‹çº¿çŠ¶æ€ã€‚ 
â€odown &lt;<span class="hljs-keyword">instance</span> details&gt; ï¼šç»™å®šçš„å®ä¾‹å·²ç»ä¸å†å¤„äºå®¢è§‚ä¸‹çº¿çŠ¶æ€ã€‚ 
+<span class="hljs-keyword">new</span>â€epoch &lt;<span class="hljs-keyword">instance</span> details&gt; ï¼šå½“å‰çš„çºªå…ƒï¼ˆepochï¼‰å·²ç»è¢«æ›´æ–°ã€‚ 
+tryâ€<span class="hljs-keyword">failover</span> &lt;<span class="hljs-keyword">instance</span> details&gt; ï¼šä¸€ä¸ªæ–°çš„æ•…éšœè¿ç§»æ“ä½œæ­£åœ¨æ‰§è¡Œä¸­ï¼Œç­‰å¾…è¢«å¤§å¤šæ•° Sentinel é€‰ä¸­ ï¼ˆwaiting <span class="hljs-keyword">to</span> be elected <span class="hljs-keyword">by</span> the majorityï¼‰ã€‚ 
+electedâ€leader &lt;<span class="hljs-keyword">instance</span> details&gt; ï¼šèµ¢å¾—æŒ‡å®šçºªå…ƒçš„é€‰ä¸¾ï¼Œå¯ä»¥è¿›è¡Œæ•…éšœè¿ç§»æ“ä½œäº†ã€‚ 
+<span class="hljs-keyword">failover</span>â€stateâ€<span class="hljs-keyword">select</span>â€<span class="hljs-keyword">slave</span> &lt;<span class="hljs-keyword">instance</span> details&gt; ï¼šæ•…éšœè½¬ç§»æ“ä½œç°åœ¨å¤„äº <span class="hljs-keyword">select</span>â€<span class="hljs-keyword">slave</span> çŠ¶æ€ â€”â€” Sentinel æ­£åœ¨å¯»æ‰¾å¯ä»¥å‡çº§ä¸ºä¸»æœåŠ¡å™¨çš„ä»æœåŠ¡å™¨ã€‚ 
<span class="hljs-keyword">no</span>â€goodâ€<span class="hljs-keyword">slave</span> &lt;<span class="hljs-keyword">instance</span> details&gt; ï¼šSentinel æ“ä½œæœªèƒ½æ‰¾åˆ°é€‚åˆè¿›è¡Œå‡çº§çš„ä»æœåŠ¡å™¨ã€‚Sentinel ä¼šåœ¨ä¸€æ®µæ—¶ é—´ä¹‹åå†æ¬¡å°è¯•å¯»æ‰¾åˆé€‚çš„ä»æœåŠ¡å™¨æ¥è¿›è¡Œå‡çº§ï¼Œåˆæˆ–è€…ç›´æ¥æ”¾å¼ƒæ‰§è¡Œæ•…éšœè½¬ç§»æ“ä½œã€‚ 
selectedâ€<span class="hljs-keyword">slave</span> &lt;<span class="hljs-keyword">instance</span> details&gt; ï¼šSentinel é¡ºåˆ©æ‰¾åˆ°é€‚åˆè¿›è¡Œå‡çº§çš„ä»æœåŠ¡å™¨ã€‚ 
<span class="hljs-keyword">failover</span>â€stateâ€sendâ€slaveofâ€noone &lt;<span class="hljs-keyword">instance</span> details&gt; ï¼šSentinel æ­£åœ¨å°†æŒ‡å®šçš„ä»æœåŠ¡å™¨å‡çº§ä¸ºä¸»æœåŠ¡ å™¨ï¼Œç­‰å¾…å‡çº§åŠŸèƒ½å®Œæˆã€‚ 
<span class="hljs-keyword">failover</span>â€<span class="hljs-keyword">end</span>â€<span class="hljs-keyword">for</span>â€<span class="hljs-keyword">timeout</span> &lt;<span class="hljs-keyword">instance</span> details&gt; ï¼šæ•…éšœè½¬ç§»å› ä¸ºè¶…æ—¶è€Œä¸­æ­¢ï¼Œä¸è¿‡æœ€ç»ˆæ‰€æœ‰ä»æœåŠ¡å™¨éƒ½ä¼šå¼€å§‹å¤ åˆ¶æ–°çš„ä¸»æœåŠ¡å™¨ï¼ˆslaves will eventually be configured <span class="hljs-keyword">to</span> <span class="hljs-keyword">replicate</span> <span class="hljs-keyword">with</span> the <span class="hljs-keyword">new</span> <span class="hljs-keyword">master</span> anywayï¼‰ã€‚
<span class="hljs-keyword">failover</span>â€<span class="hljs-keyword">end</span> &lt;<span class="hljs-keyword">instance</span> details&gt; ï¼šæ•…éšœè½¬ç§»æ“ä½œé¡ºåˆ©å®Œæˆã€‚æ‰€æœ‰ä»æœåŠ¡å™¨éƒ½å¼€å§‹å¤åˆ¶æ–°çš„ä¸»æœåŠ¡å™¨äº†ã€‚ 
+<span class="hljs-keyword">switch</span>â€<span class="hljs-keyword">master</span> &lt;<span class="hljs-keyword">master</span> <span class="hljs-keyword">name</span>&gt; &lt;oldip&gt; &lt;oldport&gt; &lt;newip&gt; &lt;newport&gt; ï¼šé…ç½®å˜æ›´ï¼Œä¸»æœåŠ¡å™¨çš„ IP å’Œåœ°å€å·² ç»æ”¹å˜ã€‚ è¿™æ˜¯ç»å¤§å¤šæ•°å¤–éƒ¨ç”¨æˆ·éƒ½å…³å¿ƒçš„ä¿¡æ¯ã€‚ 
+tilt ï¼šè¿›å…¥ tilt æ¨¡å¼ã€‚ 
â€tilt ï¼šé€€å‡º tilt æ¨¡å¼ã€‚</code></pre>

<p>é¡¹ç›®ä¸­é“¾æ¥Redisé›†ç¾¤æˆ–è€…Rediså“¨å…µï¼Œåªéœ€è¦é…ç½®ä¸€ä¸‹ application.ymlå³å¯ ï¼š </p>
<pre><code class="hljs yaml"><span class="hljs-attr">spring:</span> 
	<span class="hljs-comment">#Redis </span>
	<span class="hljs-attr">redis:</span> 
		<span class="hljs-comment">#timeout: 50000 </span>
		<span class="hljs-attr">sentinel:</span> 
			<span class="hljs-attr">nodes:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.211</span><span class="hljs-number">.141</span><span class="hljs-string">:8001,192.168.211.141:8002,192.168.211.141:8003</span> 
			<span class="hljs-comment">#cluster:</span>
      <span class="hljs-comment"># nodes: 192.168.211.141:7001,192.168.211.141:7002,192.168.211.141:7003,192.168.211.141:7004,192.168.211. 141:7005,192.168.211.141:7006</span></code></pre>

<h3 id="Redis-Cluster"><a href="#Redis-Cluster" class="headerlink" title="Redis Cluster"></a>Redis Cluster</h3><p>RedisClusteræ˜¯Redisçš„åˆ†å¸ƒå¼è§£å†³æ–¹æ¡ˆï¼Œåœ¨3.0ç‰ˆæœ¬åæ¨å‡ºçš„æ–¹æ¡ˆï¼Œæœ‰æ•ˆåœ°è§£å†³äº†Redisåˆ†å¸ƒå¼çš„éœ€æ±‚ï¼Œå½“é‡åˆ°å•æœºå†…å­˜ã€å¹¶å‘ç­‰ç“¶é¢ˆæ—¶ï¼Œå¯ä½¿ç”¨æ­¤æ–¹æ¡ˆæ¥è§£å†³è¿™äº›é—®é¢˜ã€‚</p>
<h4 id="åˆ†å¸ƒå¼æ•°æ®åº“æ¦‚å¿µ"><a href="#åˆ†å¸ƒå¼æ•°æ®åº“æ¦‚å¿µ" class="headerlink" title="åˆ†å¸ƒå¼æ•°æ®åº“æ¦‚å¿µ"></a>åˆ†å¸ƒå¼æ•°æ®åº“æ¦‚å¿µ</h4><p>åˆ†å¸ƒå¼æ•°æ®åº“æŠŠæ•´ä¸ªæ•°æ®æŒ‰åˆ†åŒºè§„åˆ™æ˜ å°„åˆ°å¤šä¸ªèŠ‚ç‚¹ï¼Œå³æŠŠæ•°æ®åˆ’åˆ†åˆ°å¤šä¸ªèŠ‚ç‚¹ä¸Šï¼Œæ¯ä¸ªèŠ‚ç‚¹è´Ÿè´£æ•´ä½“æ•°æ®çš„ä¸€ä¸ªå­é›†ã€‚</p>
<p>æ¯”å¦‚æˆ‘ä»¬åº“æœ‰900æ¡ç”¨æˆ·æ•°æ®ï¼Œæœ‰3ä¸ªredisèŠ‚ç‚¹ï¼Œå°†900æ¡åˆ†æˆ3ä»½ï¼Œåˆ†åˆ«å­˜å…¥åˆ°3ä¸ªredisèŠ‚ç‚¹</p>
<img src="/blog/2020/08/22/%E7%BC%93%E5%AD%98-Redis%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8/pic10.png" srcset="/blog/img/loading.gif" class>

<h4 id="åˆ†åŒºè§„åˆ™"><a href="#åˆ†åŒºè§„åˆ™" class="headerlink" title="åˆ†åŒºè§„åˆ™"></a>åˆ†åŒºè§„åˆ™</h4><p>å¸¸è§çš„åˆ†åŒºè§„åˆ™å“ˆå¸Œåˆ†åŒºå’Œé¡ºåºåˆ†åŒºï¼Œredisé›†ç¾¤ä½¿ç”¨äº†å“ˆå¸Œåˆ†åŒºï¼Œé¡ºåºåˆ†åŒºæš‚ç”¨ä¸åˆ°ï¼Œä¸åšå…·ä½“è¯´æ˜ã€‚</p>
<p>RedisClusteré‡‡ç”¨äº†å“ˆå¸Œåˆ†åŒºçš„â€œè™šæ‹Ÿæ§½åˆ†åŒºâ€æ–¹å¼ï¼ˆå“ˆå¸Œåˆ†åŒºåˆ†èŠ‚ç‚¹å–ä½™ã€ä¸€è‡´æ€§å“ˆå¸Œåˆ†åŒºå’Œè™šæ‹Ÿæ§½åˆ†åŒºï¼‰ã€‚</p>
<h4 id="è™šæ‹Ÿæ§½åˆ†åŒº"><a href="#è™šæ‹Ÿæ§½åˆ†åŒº" class="headerlink" title="è™šæ‹Ÿæ§½åˆ†åŒº"></a>è™šæ‹Ÿæ§½åˆ†åŒº</h4><p>æ§½ï¼šslot</p>
<p>RedisClusteré‡‡ç”¨æ­¤åˆ†åŒºï¼Œæ‰€æœ‰çš„é”®æ ¹æ®å“ˆå¸Œå‡½æ•°(CRC16[key]&amp;16383)æ˜ å°„åˆ°0ï¼16383æ§½å†…ï¼Œå…±16384ä¸ªæ§½ä½ï¼Œæ¯ä¸ªèŠ‚ç‚¹ç»´æŠ¤éƒ¨åˆ†æ§½åŠæ§½æ‰€æ˜ å°„çš„é”®å€¼æ•°æ®</p>
<p>å“ˆå¸Œå‡½æ•°: Hash()=CRC16[key]&amp;16383</p>
<img src="/blog/2020/08/22/%E7%BC%93%E5%AD%98-Redis%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8/pic11.png" srcset="/blog/img/loading.gif" class>

<h4 id="æ§½ã€é”®ã€æ•°æ®å…³ç³»"><a href="#æ§½ã€é”®ã€æ•°æ®å…³ç³»" class="headerlink" title="æ§½ã€é”®ã€æ•°æ®å…³ç³»"></a>æ§½ã€é”®ã€æ•°æ®å…³ç³»</h4><img src="/blog/2020/08/22/%E7%BC%93%E5%AD%98-Redis%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8/pic12.png" srcset="/blog/img/loading.gif" class>

<h4 id="RedisClusterçš„ç¼ºé™·"><a href="#RedisClusterçš„ç¼ºé™·" class="headerlink" title="RedisClusterçš„ç¼ºé™·"></a>RedisClusterçš„ç¼ºé™·</h4><ul>
<li><p>é”®çš„æ‰¹é‡æ“ä½œæ”¯æŒæœ‰é™ï¼Œæ¯”å¦‚mset, mgetï¼Œå¦‚æœå¤šä¸ªé”®æ˜ å°„åœ¨ä¸åŒçš„æ§½å°±ä¼šå‡ºé”™ã€‚</p>
</li>
<li><p>é”®äº‹åŠ¡æ”¯æŒæœ‰é™ï¼Œå½“å¤šä¸ªé”®åˆ†å¸ƒåœ¨ä¸åŒèŠ‚ç‚¹æ—¶æ— æ³•ä½¿ç”¨äº‹åŠ¡ï¼ŒåŒä¸€èŠ‚ç‚¹æ˜¯æ”¯æŒäº‹åŠ¡</p>
</li>
<li><p>é”®æ˜¯æ•°æ®åˆ†åŒºçš„æœ€å°ç²’åº¦ï¼Œä¸èƒ½å°†ä¸€ä¸ªå¾ˆå¤§çš„é”®å€¼å¯¹æ˜ å°„åˆ°ä¸åŒçš„èŠ‚ç‚¹</p>
</li>
<li><p>ä¸æ”¯æŒå¤šæ•°æ®åº“ï¼Œæ ‡å·ä¸º0çš„æ•°æ®åº“ã€‚</p>
</li>
<li><p>å¤åˆ¶ç»“æ„åªæ”¯æŒå•å±‚ç»“æ„ï¼Œä¸æ”¯æŒæ ‘å‹ç»“æ„ã€‚</p>
</li>
</ul>
<h4 id="é›†ç¾¤èŠ‚ç‚¹ä¹‹é—´çš„é€šä¿¡"><a href="#é›†ç¾¤èŠ‚ç‚¹ä¹‹é—´çš„é€šä¿¡" class="headerlink" title="é›†ç¾¤èŠ‚ç‚¹ä¹‹é—´çš„é€šä¿¡"></a>é›†ç¾¤èŠ‚ç‚¹ä¹‹é—´çš„é€šä¿¡</h4><img src="/blog/2020/08/22/%E7%BC%93%E5%AD%98-Redis%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8/pic13.png" srcset="/blog/img/loading.gif" class>

<p>èŠ‚ç‚¹ä¹‹é—´é‡‡ç”¨Gossipåè®®è¿›è¡Œé€šä¿¡ï¼ŒèŠ‚ç‚¹å½¼æ­¤ä¹‹é—´ä¸æ–­é€šä¿¡äº¤æ¢æ¶ˆæ¯ï¼Œå½“ä¸»ä»è§’è‰²å˜åŒ–æˆ–æ–°å¢èŠ‚ç‚¹ï¼Œå½¼æ­¤é€šè¿‡ping/pongè¿›è¡Œé€šä¿¡çŸ¥é“å…¨éƒ¨èŠ‚ç‚¹çš„æœ€æ–°çŠ¶æ€å¹¶è¾¾åˆ°é›†ç¾¤åŒæ­¥</p>
<p>Gossipåè®®çš„ä¸»è¦èŒè´£å°±æ˜¯ä¿¡æ¯äº¤æ¢ï¼Œä¿¡æ¯äº¤æ¢çš„è½½ä½“å°±æ˜¯èŠ‚ç‚¹ä¹‹é—´å½¼æ­¤å‘é€çš„Gossipæ¶ˆæ¯ï¼Œå¸¸ç”¨çš„Gossipæ¶ˆæ¯æœ‰pingæ¶ˆæ¯ã€pongæ¶ˆæ¯ã€meetæ¶ˆæ¯ã€failæ¶ˆæ¯</p>
<ul>
<li><p>meetæ¶ˆæ¯ï¼šç”¨äºé€šçŸ¥æ–°èŠ‚ç‚¹åŠ å…¥ï¼Œæ¶ˆæ¯å‘é€è€…é€šçŸ¥æ¥æ”¶è€…åŠ å…¥åˆ°å½“å‰é›†ç¾¤ï¼Œmeetæ¶ˆæ¯é€šä¿¡å®Œåï¼Œæ¥æ”¶èŠ‚ç‚¹ä¼šåŠ å…¥åˆ°é›†ç¾¤ä¸­ï¼Œå¹¶è¿›è¡Œå‘¨æœŸæ€§ping pongäº¤æ¢</p>
</li>
<li><p>pingæ¶ˆæ¯ï¼šé›†ç¾¤å†…äº¤æ¢æœ€é¢‘ç¹çš„æ¶ˆæ¯ï¼Œé›†ç¾¤å†…æ¯ä¸ªèŠ‚ç‚¹æ¯ç§’å‘å…¶å®ƒèŠ‚ç‚¹å‘pingæ¶ˆæ¯ï¼Œç”¨äºæ£€æµ‹èŠ‚ç‚¹æ˜¯åœ¨åœ¨çº¿å’ŒçŠ¶æ€ä¿¡æ¯ï¼Œpingæ¶ˆæ¯å‘é€å°è£…è‡ªèº«èŠ‚ç‚¹å’Œå…¶ä»–èŠ‚ç‚¹çš„çŠ¶æ€æ•°æ®ï¼›</p>
</li>
<li><p>pongæ¶ˆæ¯ï¼Œå½“æ¥æ”¶åˆ°ping meetæ¶ˆæ¯æ—¶ï¼Œä½œä¸ºå“åº”æ¶ˆæ¯è¿”å›ç»™å‘é€æ–¹ï¼Œç”¨æ¥ç¡®è®¤æ­£å¸¸é€šä¿¡ï¼Œpongæ¶ˆæ¯ä¹Ÿå°é—­äº†è‡ªèº«çŠ¶æ€æ•°æ®ï¼›</p>
</li>
<li><p>failæ¶ˆæ¯ï¼šå½“èŠ‚ç‚¹åˆ¤å®šé›†ç¾¤å†…çš„å¦ä¸€èŠ‚ç‚¹ä¸‹çº¿æ—¶ï¼Œä¼šå‘é›†ç¾¤å†…å¹¿æ’­ä¸€ä¸ªfailæ¶ˆæ¯</p>
</li>
</ul>
<img src="/blog/2020/08/22/%E7%BC%93%E5%AD%98-Redis%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8/pic14.png" srcset="/blog/img/loading.gif" class>

<p>ä»¥ä¸Šçš„æ‰€æœ‰æ¶ˆæ¯æ ¼å¼ä¸ºï¼šæ¶ˆæ¯å¤´ã€æ¶ˆæ¯ä½“ï¼Œæ¶ˆæ¯å¤´åŒ…å«å‘é€èŠ‚ç‚¹è‡ªèº«çŠ¶æ€æ•°æ®ï¼ˆæ¯”å¦‚èŠ‚ç‚¹IDã€æ§½æ˜ å°„ã€èŠ‚ç‚¹è§’è‰²ã€æ˜¯å¦ä¸‹çº¿ç­‰ï¼‰ï¼Œæ¥æ”¶èŠ‚ç‚¹æ ¹æ®æ¶ˆæ¯å¤´å¯ä»¥è·å–åˆ°å‘é€èŠ‚ç‚¹çš„ç›¸å…³æ•°æ®ã€‚</p>
<img src="/blog/2020/08/22/%E7%BC%93%E5%AD%98-Redis%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8/pic15.png" srcset="/blog/img/loading.gif" class>

<p>Gossipåè®®ä¿¡æ¯çš„äº¤æ¢æœºåˆ¶å…·æœ‰å¤©ç„¶çš„åˆ†å¸ƒå¼ç‰¹æ€§ï¼Œä½†ping pongå‘é€çš„é¢‘ç‡å¾ˆé«˜ã€‚</p>
<img src="/blog/2020/08/22/%E7%BC%93%E5%AD%98-Redis%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8/pic16.png" srcset="/blog/img/loading.gif" class>

<h5 id="å‘½ä»¤é‡å®šå‘"><a href="#å‘½ä»¤é‡å®šå‘" class="headerlink" title="å‘½ä»¤é‡å®šå‘"></a>å‘½ä»¤é‡å®šå‘</h5><img src="/blog/2020/08/22/%E7%BC%93%E5%AD%98-Redis%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8/pic17.png" srcset="/blog/img/loading.gif" class>

<h5 id="ä¸»è§‚ä¸‹çº¿æµç¨‹"><a href="#ä¸»è§‚ä¸‹çº¿æµç¨‹" class="headerlink" title="ä¸»è§‚ä¸‹çº¿æµç¨‹"></a>ä¸»è§‚ä¸‹çº¿æµç¨‹</h5><img src="/blog/2020/08/22/%E7%BC%93%E5%AD%98-Redis%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8/pic18.png" srcset="/blog/img/loading.gif" class>

<h5 id="å®¢è§‚ä¸‹çº¿æµç¨‹"><a href="#å®¢è§‚ä¸‹çº¿æµç¨‹" class="headerlink" title="å®¢è§‚ä¸‹çº¿æµç¨‹"></a>å®¢è§‚ä¸‹çº¿æµç¨‹</h5><p>èŠ‚ç‚¹çœŸæ­£çš„ä¸‹çº¿ï¼Œé›†ç¾¤å†…å¤šä¸ªèŠ‚ç‚¹éƒ½è®¤ä¸ºè¯¥èŠ‚ç‚¹ä¸å¯ç”¨ï¼Œè¾¾æˆå…±è¯†ï¼Œå°†å®ƒä¸‹çº¿ï¼Œå¦‚æœä¸‹çº¿çš„èŠ‚ç‚¹ä¸ºä¸»èŠ‚ç‚¹ï¼Œè¿˜è¦å¯¹å®ƒè¿›è¡Œæ•…éšœè½¬ç§»</p>
<img src="/blog/2020/08/22/%E7%BC%93%E5%AD%98-Redis%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8/pic19.png" srcset="/blog/img/loading.gif" class>

<h5 id="æ•…éšœæ¢å¤"><a href="#æ•…éšœæ¢å¤" class="headerlink" title="æ•…éšœæ¢å¤"></a>æ•…éšœæ¢å¤</h5><p>æ•…éšœä¸»èŠ‚ç‚¹ä¸‹çº¿åï¼Œå¦‚æœä¸‹çº¿èŠ‚ç‚¹çš„æ˜¯ä¸»èŠ‚ç‚¹ï¼Œåˆ™éœ€è¦åœ¨å®ƒçš„ä»èŠ‚ç‚¹ä¸­é€‰ä¸€ä¸ªæ›¿æ¢å®ƒï¼Œä¿è¯é›†ç¾¤çš„é«˜å¯ç”¨</p>
<img src="/blog/2020/08/22/%E7%BC%93%E5%AD%98-Redis%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8/pic20.png" srcset="/blog/img/loading.gif" class>


            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/blog/categories/%E7%BC%93%E5%AD%98/">ç¼“å­˜</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/blog/tags/redis%E9%9B%86%E7%BE%A4/">redisé›†ç¾¤</a>
                    
                      <a class="hover-with-bg" href="/blog/tags/redis%E9%AB%98%E5%8F%AF%E7%94%A8/">redisé«˜å¯ç”¨</a>
                    
                      <a class="hover-with-bg" href="/blog/tags/redis%E4%B8%BB%E4%BB%8E/">redisä¸»ä»</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" target="_blank" rel="nofollow noopener noopener">CC BY-SA 4.0 åè®®</a> ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</p>
              
              
                <div class="post-prevnext row">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/blog/2020/08/22/%E7%BC%93%E5%AD%98-Redis%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D/">
                        <span class="hidden-mobile">redisçš„åŸºæœ¬ä»‹ç»</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener">
        <span>Fluid</span></a>
    </div>
    
  <div class="statistics">
    
    

    
      
        <!-- ä¸è’œå­ç»Ÿè®¡PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            æ€»è®¿é—®é‡ 
            <span id="busuanzi_value_site_pv"></span>
             æ¬¡
          </span>
      
      
        <!-- ä¸è’œå­ç»Ÿè®¡UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            æ€»è®¿å®¢æ•° 
            <span id="busuanzi_value_site_uv"></span>
             äºº
          </span>
      
    
  </div>


    

    
  </div>
</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/blog/js/debouncer.js" ></script>
<script  src="/blog/js/main.js" ></script>

<!-- Plugins -->


  
    <script  src="/blog/js/lazyload.js" ></script>
  



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/blog/js/clipboard-use.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: '#post-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "Redisçš„é«˜å¯ç”¨&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/blog/js/local-search.js" ></script>
  <script>
    var path = "/blog/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>







  
  
    <script type="text/javascript">
      //å®šä¹‰è·å–è¯è¯­ä¸‹æ ‡
      var a_idx = 0;
      jQuery(document).ready(function ($) {
        //ç‚¹å‡»bodyæ—¶è§¦å‘äº‹ä»¶
        $("body").click(function (e) {
          //éœ€è¦æ˜¾ç¤ºçš„è¯è¯­
          var a = new Array("å¯Œå¼º", "æ°‘ä¸»", "æ–‡æ˜", "å’Œè°", "è‡ªç”±", "å¹³ç­‰", "å…¬æ­£", "æ³•æ²»", "çˆ±å›½", "æ•¬ä¸š", "è¯šä¿¡", "å‹å–„");
          //è®¾ç½®è¯è¯­ç»™spanæ ‡ç­¾
          var $i = $("<span/>").text(a[a_idx]);
          //ä¸‹æ ‡ç­‰äºåŸæ¥ä¸‹æ ‡+1  ä½™ è¯è¯­æ€»æ•°
          a_idx = (a_idx + 1) % a.length;
          //è·å–é¼ æ ‡æŒ‡é’ˆçš„ä½ç½®ï¼Œåˆ†åˆ«ç›¸å¯¹äºæ–‡æ¡£çš„å·¦å’Œå³è¾¹ç¼˜ã€‚
          //è·å–xå’Œyçš„æŒ‡é’ˆåæ ‡
          var x = e.pageX, y = e.pageY;
          //åœ¨é¼ æ ‡çš„æŒ‡é’ˆçš„ä½ç½®ç»™$iå®šä¹‰çš„spanæ ‡ç­¾æ·»åŠ cssæ ·å¼
          $i.css({
            "z-index": 999,
            "top": y - 20,
            "left": x,
            "position": "absolute",
            "font-weight": "bold",
            "color": rand_color()
          });
          // éšæœºé¢œè‰²
          function rand_color() {
            return "rgb(" + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + ")"
          }
          //åœ¨bodyæ·»åŠ è¿™ä¸ªæ ‡ç­¾
          $("body").append($i);
          //animate() æ–¹æ³•æ‰§è¡Œ CSS å±æ€§é›†çš„è‡ªå®šä¹‰åŠ¨ç”»ã€‚
          //è¯¥æ–¹æ³•é€šè¿‡CSSæ ·å¼å°†å…ƒç´ ä»ä¸€ä¸ªçŠ¶æ€æ”¹å˜ä¸ºå¦ä¸€ä¸ªçŠ¶æ€ã€‚CSSå±æ€§å€¼æ˜¯é€æ¸æ”¹å˜çš„ï¼Œè¿™æ ·å°±å¯ä»¥åˆ›å»ºåŠ¨ç”»æ•ˆæœã€‚
          //è¯¦æƒ…è¯·çœ‹http://www.w3school.com.cn/jquery/effect_animate.asp
          $i.animate({
            //å°†åŸæ¥çš„ä½ç½®å‘ä¸Šç§»åŠ¨180
            "top": y - 180,
            "opacity": 0
            //1500åŠ¨ç”»çš„é€Ÿåº¦
          }, 1500, function () {
            //æ—¶é—´åˆ°äº†è‡ªåŠ¨åˆ é™¤
            $i.remove();
          });
        });
      })
      ;
    </script>
  














</body>
</html>
