<!DOCTYPE html>
<html lang="zh-CN">





<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/blog/img/apple-touch-icon.png">
  <link rel="icon" type="image/png" href="/blog/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="">
  <meta name="keywords" content="">
  <title>Nettyè§£æ - ğŸğŸŠ&#39;s blog</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/5.12.1/css/all.min.css" />
<link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />
<link  rel="stylesheet" href="https://cdn.staticfile.org/mdbootstrap/4.13.0/css/mdb.min.css" />
<link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/3.0.1/github-markdown.min.css" />

<link rel="stylesheet" href="//at.alicdn.com/t/font_1067060_qzomjdt8bmp.css">



  <link  rel="stylesheet" href="/blog/lib/prettify/tomorrow-night-eighties.min.css" />

<link  rel="stylesheet" href="/blog/css/main.css" />


  <link defer rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />


<!-- è‡ªå®šä¹‰æ ·å¼ä¿æŒåœ¨æœ€åº•éƒ¨ -->


<meta name="generator" content="Hexo 4.2.1"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/blog/">&nbsp;<strong>ğŸğŸŠ's blog</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/blog/">é¦–é¡µ</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/blog/archives/">å½’æ¡£</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/blog/categories/">åˆ†ç±»</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/blog/tags/">æ ‡ç­¾</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/blog/about">å…³äº</a>
          </li>
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="view intro-2" id="background" parallax=true
         style="background: url('/blog/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask rgba-black-light flex-center">
          <div class="container text-center white-text fadeInUp">
            <span class="h2" id="subtitle">
              
            </span>

            
              
                <p class="mt-3 post-meta">
                  <i class="fas fa-calendar-alt" aria-hidden="true"></i>
                  æ˜ŸæœŸäº”, å…«æœˆ 7æ—¥ 2020, 5:04 ä¸‹åˆ
                </p>
              

              <p class="mt-1">
                
                  
                  <span class="post-meta">
                    <i class="far fa-chart-bar"></i>
                    6.3k å­—
                  </span>
                

                
                  
                  <span class="post-meta">
                      <i class="far fa-clock"></i>
                      25 åˆ†é’Ÿ
                  </span>
                

                
                  <!-- ä¸è’œå­ç»Ÿè®¡æ–‡ç« PV -->
                  
                  <span id="busuanzi_container_page_pv" class="post-meta" style="display: none">
                    <i class="far fa-eye" aria-hidden="true"></i>
                    <span id="busuanzi_value_page_pv"></span> æ¬¡
                  </span>
                
              </p>
            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5 z-depth-3" id="board">
          <div class="post-content mx-auto" id="post">
            
              <p
                class="note note-warning">æœ¬æ–‡æœ€åæ›´æ–°äºï¼šæ˜ŸæœŸäº”, å…«æœˆ 7æ—¥ 2020, 6:33 æ™šä¸Š</p>
            
            <div class="markdown-body">
              <h3 id="Javaä¸­çš„IOæ¨¡å‹"><a href="#Javaä¸­çš„IOæ¨¡å‹" class="headerlink" title="Javaä¸­çš„IOæ¨¡å‹"></a>Javaä¸­çš„IOæ¨¡å‹</h3><p>åœ¨JDK1.4ä¹‹å‰ï¼ŒåŸºäºJavaæ‰€æœ‰çš„socketé€šä¿¡éƒ½é‡‡â½¤äº†åŒæ­¥é˜»å¡æ¨¡å‹ï¼ˆBIOï¼‰ï¼Œè¿™ç§æ¨¡å‹æ€§èƒ½ä½ä¸‹ï¼Œå½“æ—¶â¼¤å‹çš„æœåŠ¡å‡é‡‡â½¤Cæˆ–C++å¼€å‘ï¼Œå› ä¸ºå®ƒä»¬å¯ä»¥ç›´æ¥ä½¿â½¤æ“ä½œç³»ç»Ÿæä¾›çš„å¼‚æ­¥IOæˆ–è€…AIOï¼Œä½¿å¾—æ€§èƒ½å¾—åˆ°â¼¤å¹…æå‡ã€‚</p>
<p>2002å¹´ï¼ŒJDK1.4å‘å¸ƒï¼Œæ–°å¢äº†java.nioåŒ…ï¼Œæä¾›äº†è®¸å¤šå¼‚æ­¥IOå¼€å‘çš„APIå’Œç±»åº“ã€‚æ–°å¢çš„NIOï¼Œæâ¼¤çš„ä¿ƒè¿›äº†åŸºäºJavaçš„å¼‚æ­¥â¾®é˜»å¡çš„å‘å±•å’Œåº”â½¤ã€‚</p>
<p>2011å¹´ï¼ŒJDK7å‘å¸ƒï¼Œå°†åŸæœ‰çš„NIOè¿›â¾äº†å‡çº§ï¼Œç§°ä¸ºNIO2.0ï¼Œå…¶ä¸­ä¹Ÿå¯¹AIOè¿›â¾äº†â½€æŒã€‚</p>
<h4 id="BIOæ¨¡å‹"><a href="#BIOæ¨¡å‹" class="headerlink" title="BIOæ¨¡å‹"></a>BIOæ¨¡å‹</h4><p>javaä¸­çš„BIOæ˜¯blocking I/Oçš„ç®€ç§°ï¼Œå®ƒæ˜¯åŒæ­¥é˜»å¡å‹IOï¼Œå…¶ç›¸å…³çš„ç±»å’Œæ¥â¼åœ¨java.ioä¸‹ã€‚BIOæ¨¡å‹ç®€å•æ¥è®²ï¼Œå°±æ˜¯æœåŠ¡ç«¯ä¸ºæ¯â¼€ä¸ªè¯·æ±‚éƒ½åˆ†é…â¼€ä¸ªçº¿ç¨‹è¿›â¾å¤„ç†ï¼Œå¦‚ä¸‹ï¼š</p>
<img src="/blog/2020/08/07/netty-Netty%E8%A7%A3%E6%9E%90/pic1.png" srcset="/blog/img/loading.gif" class>

<p>ç¤ºä¾‹</p>
<pre><code class="java">package org.example.bio;

import java.io.InputStream;
import java.net.ServerSocket;
import java.net.Socket;
import java.nio.charset.StandardCharsets;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;

public class BIOServer {
    public static void main(String[] args) throws Exception {
        ServerSocket serverSocket = new ServerSocket(6666);
        ExecutorService executorService = Executors.newCachedThreadPool();
        while (true) {
            System.out.println(&quot;ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥ã€‚ã€‚ã€‚ã€‚&quot;);
            Socket socket = serverSocket.accept(); //é˜»å¡
            executorService.execute(() -&gt; {
                try {
                    InputStream inputStream = socket.getInputStream(); //é˜»å¡
                    byte[] bytes = new byte[1024];
                    while (true) {
                        int length = inputStream.read(bytes);
                        if (length == -1) {
                            break;
                        }
                        System.out.println(new String(bytes, 0, length, StandardCharsets.UTF_8));
                    }
                } catch (Exception e) {
                    e.printStackTrace();
                }
            });
        }
    }
}</code></pre>
<p>è¿™ç§æ¨¡å¼å­˜åœ¨çš„é—®é¢˜ï¼š</p>
<ul>
<li>å®¢æˆ·ç«¯çš„å¹¶å‘æ•°ä¸åç«¯çš„çº¿ç¨‹æ•°æˆ1:1çš„â½ä¾‹ï¼Œçº¿ç¨‹çš„åˆ›å»ºã€é”€æ¯æ˜¯â¾®å¸¸æ¶ˆè€—ç³»ç»Ÿèµ„æºçš„ï¼Œéšç€å¹¶å‘é‡å¢â¼¤ï¼ŒæœåŠ¡ç«¯æ€§èƒ½å°†æ˜¾è‘—ä¸‹é™ï¼Œç”šâ¾„ä¼šå‘â½£çº¿ç¨‹å †æ ˆæº¢å‡ºç­‰é”™è¯¯ã€‚</li>
<li>å½“è¿æ¥åˆ›å»ºåï¼Œå¦‚æœè¯¥çº¿ç¨‹æ²¡æœ‰æ“ä½œæ—¶ï¼Œä¼šè¿›â¾é˜»å¡æ“ä½œï¼Œè¿™æ ·æâ¼¤çš„æµªè´¹äº†æœåŠ¡å™¨èµ„æºã€‚</li>
</ul>
<h4 id="NIOæ¨¡å‹"><a href="#NIOæ¨¡å‹" class="headerlink" title="NIOæ¨¡å‹"></a>NIOæ¨¡å‹</h4><p>NIOï¼Œç§°ä¹‹ä¸ºNew IO æˆ–æ˜¯ non-block IO ï¼ˆâ¾®é˜»å¡IOï¼‰ï¼Œè¿™ä¸¤ç§è¯´æ³•éƒ½å¯ä»¥ï¼Œå…¶å®ç§°ä¹‹ä¸ºâ¾®é˜»å¡IOæ›´æ°å½“â¼€äº›ã€‚</p>
<p>NIOç›¸å…³çš„ä»£ç éƒ½æ”¾åœ¨äº†java.nioåŒ…ä¸‹ï¼Œå…¶ä¸‰â¼¤æ ¸â¼¼ç»„ä»¶ï¼š<strong>Buffer</strong>ï¼ˆç¼“å†²åŒºï¼‰ã€<strong>Channel</strong>ï¼ˆé€šé“ï¼‰ã€<strong>Selector</strong>ï¼ˆé€‰æ‹©å™¨<strong>/</strong>å¤šè·¯å¤â½¤å™¨ï¼‰</p>
<ul>
<li><p>Buffer</p>
<p>åœ¨NIOä¸­ï¼Œæ‰€æœ‰çš„è¯»å†™æ“ä½œéƒ½æ˜¯åŸºäºç¼“å†²åŒºå®Œæˆçš„ï¼Œåº•å±‚æ˜¯é€šè¿‡æ•°ç»„å®ç°çš„ï¼Œå¸¸â½¤çš„ç¼“å†²åŒºæ˜¯ByteBufferï¼Œæ¯â¼€ç§javaåŸºæœ¬ç±»å‹éƒ½æœ‰å¯¹åº”çš„ç¼“å†²åŒºå¯¹è±¡ï¼ˆé™¤äº†Booleanç±»å‹ï¼‰ï¼Œå¦‚ï¼šCharBufferã€IntBufferã€LongBufferç­‰ã€‚</p>
</li>
<li><p>Channel</p>
<p>åœ¨BIOä¸­æ˜¯åŸºäºStreamå®ç°ï¼Œâ½½åœ¨NIOä¸­æ˜¯åŸºäºé€šé“å®ç°ï¼Œä¸æµä¸åŒçš„æ˜¯ï¼Œé€šé“æ˜¯åŒå‘çš„ï¼Œæ—¢å¯ä»¥è¯»ä¹Ÿå¯ä»¥å†™ã€‚</p>
</li>
<li><p>Selector</p>
<p>Selectoræ˜¯å¤šè·¯å¤â½¤å™¨ï¼Œå®ƒä¼šä¸æ–­çš„è½®è¯¢æ³¨å†Œåœ¨å…¶ä¸Šçš„Channelï¼Œå¦‚æœæŸä¸ªChannelä¸Šå‘â½£è¯»æˆ–å†™äº‹ä»¶ï¼Œè¿™ä¸ªChannelå°±å¤„äºå°±ç»ªçŠ¶æ€ï¼Œä¼šè¢«Selectorè½®è¯¢å‡ºæ¥ï¼Œç„¶åé€šè¿‡SelectionKeyè·å–å°±ç»ªChannelçš„é›†åˆï¼Œè¿›â¾IOçš„è¯»å†™æ“ä½œã€‚</p>
</li>
</ul>
<img src="/blog/2020/08/07/netty-Netty%E8%A7%A3%E6%9E%90/pic2.png" srcset="/blog/img/loading.gif" class>

<p>å¯ä»¥çœ‹å‡ºï¼ŒNIOæ¨¡å‹è¦ä¼˜äºBIOæ¨¡å‹ï¼Œä¸»è¦æ˜¯ï¼š</p>
<ul>
<li><p>é€šè¿‡å¤šè·¯å¤â½¤å™¨å°±å¯ä»¥å®ç°â¼€ä¸ªçº¿ç¨‹å¤„ç†å¤šä¸ªé€šé“ï¼Œé¿å…äº†å¤šçº¿ç¨‹ä¹‹é—´çš„ä¸Šä¸‹â½‚åˆ‡æ¢å¯¼è‡´ç³»ç»Ÿå¼€é”€è¿‡â¼¤ã€‚</p>
</li>
<li><p>NIOâ½†éœ€ä¸ºæ¯â¼€ä¸ªè¿æ¥å¼€â¼€ä¸ªçº¿ç¨‹å¤„ç†ï¼Œå¹¶ä¸”åªæœ‰é€šé“çœŸæ­£æœ‰æœ‰äº‹ä»¶æ—¶ï¼Œæ‰è¿›â¾è¯»å†™æ“ä½œï¼Œè¿™æ ·â¼¤â¼¤çš„å‡å°‘äº†ç³»ç»Ÿå¼€é”€ã€‚</p>
</li>
</ul>
<p>ç¤ºä¾‹ä»£ç ï¼š</p>
<pre><code class="java">import java.net.InetSocketAddress;
import java.net.ServerSocket;
import java.nio.ByteBuffer;
import java.nio.channels.SelectionKey;
import java.nio.channels.Selector;
import java.nio.channels.ServerSocketChannel;
import java.nio.channels.SocketChannel;
import java.util.Iterator;
import java.util.Set;

public class SelectorDemo {
    /**
     * æ³¨å†Œäº‹ä»¶
     * @return
     */
    private Selector getSelector() throws Exception {
        //è·å–selectorå¯¹è±¡
        Selector selector = Selector.open();
        ServerSocketChannel serverSocketChannel = ServerSocketChannel.open();
        serverSocketChannel.configureBlocking(false); //â¾®é˜»å¡
        //è·å–é€šé“å¹¶ä¸”ç»‘å®šç«¯â¼
        ServerSocket socket = serverSocketChannel.socket();
        socket.bind(new InetSocketAddress(6677));
        //æ³¨å†Œæ„Ÿå…´è¶£çš„äº‹ä»¶
        serverSocketChannel.register(selector, SelectionKey.OP_ACCEPT);
        return selector;
    }

    public void listen() throws Exception {
        Selector selector = this.getSelector();
        while (true) {
            selector.select(); //è¯¥â½…æ³•ä¼šé˜»å¡ï¼Œç›´åˆ°â¾„å°‘æœ‰â¼€ä¸ªäº‹ä»¶çš„å‘â½£
            Set&lt;SelectionKey&gt; selectionKeys = selector.selectedKeys();
            Iterator&lt;SelectionKey&gt; iterator = selectionKeys.iterator();
            while (iterator.hasNext()) {
                SelectionKey selectionKey = iterator.next();
                process(selectionKey, selector);
                iterator.remove();
            }
        }
    }

    private void process(SelectionKey key, Selector selector) throws Exception {
        if (key.isAcceptable()) { //æ–°è¿æ¥è¯·æ±‚
            ServerSocketChannel server = (ServerSocketChannel) key.channel();
            SocketChannel channel = server.accept();
            channel.configureBlocking(false); //â¾®é˜»å¡
            channel.register(selector, SelectionKey.OP_READ);
        } else if (key.isReadable()) { //è¯»æ•°æ®
            SocketChannel channel = (SocketChannel) key.channel();
            ByteBuffer byteBuffer = ByteBuffer.allocate(1024);
            channel.read(byteBuffer);
            System.out.println(&quot;form å®¢æˆ·ç«¯ &quot; + new String(byteBuffer.array(),
                    0, byteBuffer.position()));
        }
    }

    public static void main(String[] args) throws Exception {
        new SelectorDemo().listen();
    }
}</code></pre>
<h4 id="AIOæ¨¡å‹"><a href="#AIOæ¨¡å‹" class="headerlink" title="AIOæ¨¡å‹"></a>AIOæ¨¡å‹</h4><p>åœ¨NIOä¸­ï¼ŒSelectorå¤šè·¯å¤â½¤å™¨åœ¨åšè½®è¯¢æ—¶ï¼Œå¦‚æœæ²¡æœ‰äº‹ä»¶å‘â½£ï¼Œä¹Ÿä¼šè¿›â¾é˜»å¡ï¼Œå¦‚ä½•èƒ½æŠŠè¿™ä¸ªé˜»å¡ä¹Ÿä¼˜åŒ–æ‰å‘¢ï¼Ÿé‚£ä¹ˆAIOå°±åœ¨è¿™æ ·çš„èƒŒæ™¯ä¸‹è¯â½£äº†ã€‚</p>
<p>AIOæ˜¯asynchronous I/Oçš„ç®€ç§°ï¼Œæ˜¯å¼‚æ­¥IOï¼Œè¯¥å¼‚æ­¥IOæ˜¯éœ€è¦ä¾èµ–äºæ“ä½œç³»ç»Ÿåº•å±‚çš„å¼‚æ­¥IOå®ç°ã€‚</p>
<p>AIOçš„åŸºæœ¬æµç¨‹æ˜¯ï¼šâ½¤æˆ·çº¿ç¨‹é€šè¿‡ç³»ç»Ÿè°ƒâ½¤ï¼Œå‘ŠçŸ¥kernelå†…æ ¸å¯åŠ¨æŸä¸ªIOæ“ä½œï¼Œâ½¤æˆ·çº¿ç¨‹è¿”å›ã€‚kernelå†…æ ¸åœ¨æ•´ä¸ªIOæ“ä½œï¼ˆåŒ…æ‹¬æ•°æ®å‡†å¤‡ã€æ•°æ®å¤åˆ¶ï¼‰å®Œæˆåï¼Œé€šçŸ¥â½¤æˆ·ç¨‹åºï¼Œâ½¤æˆ·æ‰§â¾åç»­çš„ä¸šåŠ¡æ“ä½œã€‚</p>
<blockquote>
<p>kernelçš„æ•°æ®å‡†å¤‡</p>
<p>å°†æ•°æ®ä»â½¹ç»œç‰©ç†è®¾å¤‡ï¼ˆâ½¹å¡ï¼‰è¯»å–åˆ°å†…æ ¸ç¼“å†²åŒºã€‚</p>
<p>kernelçš„æ•°æ®å¤åˆ¶</p>
<p>å°†æ•°æ®ä»å†…æ ¸ç¼“å†²åŒºæ‹·â»‰åˆ°â½¤æˆ·ç¨‹åºç©ºé—´çš„ç¼“å†²åŒºã€‚</p>
</blockquote>
<img src="/blog/2020/08/07/netty-Netty%E8%A7%A3%E6%9E%90/pic3.png" srcset="/blog/img/loading.gif" class>

<p>â½¬å‰AIOæ¨¡å‹å­˜åœ¨çš„ä¸â¾œï¼š</p>
<ul>
<li><p>éœ€è¦å®Œæˆäº‹ä»¶çš„æ³¨å†Œä¸ä¼ é€’ï¼Œè¿™â¾¥è¾¹éœ€è¦åº•å±‚æ“ä½œç³»ç»Ÿæä¾›â¼¤é‡çš„â½€æŒï¼Œå»åšâ¼¤é‡çš„â¼¯ä½œã€‚</p>
</li>
<li><p>Windows ç³»ç»Ÿä¸‹é€šè¿‡ IOCP å®ç°äº†çœŸæ­£çš„å¼‚æ­¥ I/Oã€‚ä½†æ˜¯ï¼Œå°±â½¬å‰çš„ä¸šç•Œå½¢å¼æ¥è¯´ï¼ŒWindows ç³»ç»Ÿï¼Œå¾ˆå°‘ä½œä¸ºç™¾ä¸‡çº§ä»¥ä¸Šæˆ–è€…è¯´â¾¼å¹¶å‘åº”â½¤çš„æœåŠ¡å™¨æ“ä½œç³»ç»Ÿæ¥ä½¿â½¤ã€‚</p>
</li>
<li><p>â½½åœ¨ Linux ç³»ç»Ÿä¸‹ï¼Œå¼‚æ­¥IOæ¨¡å‹åœ¨2.6ç‰ˆæœ¬æ‰å¼•â¼Šï¼Œâ½¬å‰å¹¶ä¸å®Œå–„ã€‚æ‰€ä»¥ï¼Œè¿™ä¹Ÿæ˜¯åœ¨ Linux ä¸‹ï¼Œå®ç°â¾¼å¹¶å‘â½¹ç»œç¼–ç¨‹æ—¶éƒ½æ˜¯ä»¥ NIO å¤šè·¯å¤â½¤æ¨¡å‹æ¨¡å¼ä¸ºä¸»ã€‚</p>
</li>
</ul>
<h3 id="Reactorçº¿ç¨‹æ¨¡å‹"><a href="#Reactorçº¿ç¨‹æ¨¡å‹" class="headerlink" title="Reactorçº¿ç¨‹æ¨¡å‹"></a>Reactorçº¿ç¨‹æ¨¡å‹</h3><p>Reactorçº¿ç¨‹æ¨¡å‹ä¸æ˜¯Javaä¸“å±ï¼Œä¹Ÿä¸æ˜¯Nettyä¸“å±ï¼Œå®ƒå…¶å®æ˜¯â¼€ç§å¹¶å‘ç¼–ç¨‹æ¨¡å‹ï¼Œæ˜¯â¼€ç§æ€æƒ³ï¼Œå…·æœ‰æŒ‡å¯¼æ„ä¹‰ã€‚â½å¦‚ï¼ŒNettyå°±æ˜¯ç»“åˆäº†NIOçš„ç‰¹ç‚¹ï¼Œåº”â½¤äº†Reactorçº¿ç¨‹æ¨¡å‹æ‰€å®ç°çš„ã€‚</p>
<p>Reactoræ¨¡å‹ä¸­å®šä¹‰çš„ä¸‰ç§â»†â¾Šï¼š</p>
<ul>
<li><p>Reactorï¼šè´Ÿè´£ç›‘å¬å’Œåˆ†é…äº‹ä»¶ï¼Œå°†I/Oäº‹ä»¶åˆ†æ´¾ç»™å¯¹åº”çš„Handlerã€‚æ–°çš„äº‹ä»¶åŒ…å«è¿æ¥å»ºâ½´å°±ç»ªã€è¯»å°±ç»ªã€å†™å°±ç»ªç­‰ã€‚</p>
</li>
<li><p>Acceptorï¼šå¤„ç†å®¢æˆ·ç«¯æ–°è¿æ¥ï¼Œå¹¶åˆ†æ´¾è¯·æ±‚åˆ°å¤„ç†å™¨é“¾ä¸­ã€‚</p>
</li>
<li><p>Handlerï¼šå°†â¾ƒèº«ä¸äº‹ä»¶ç»‘å®šï¼Œæ‰§â¾â¾®é˜»å¡è¯»/å†™ä»»åŠ¡ï¼Œå®Œæˆchannelçš„è¯»â¼Šï¼Œå®Œæˆå¤„ç†ä¸šåŠ¡é€»è¾‘åï¼Œè´Ÿè´£å°†ç»“æœå†™å‡ºchannelã€‚</p>
</li>
</ul>
<p>å¸¸â»…çš„Reactorçº¿ç¨‹æ¨¡å‹æœ‰ä¸‰ç§ï¼Œå¦‚ä¸‹ï¼š</p>
<ul>
<li><p>Reactorå•çº¿ç¨‹æ¨¡å‹ </p>
</li>
<li><p>Reactorå¤šçº¿ç¨‹æ¨¡å‹</p>
</li>
<li><p>ä¸»ä»Reactorå¤šçº¿ç¨‹æ¨¡å‹</p>
</li>
</ul>
<h4 id="å•Reactorå•çº¿ç¨‹æ¨¡å‹"><a href="#å•Reactorå•çº¿ç¨‹æ¨¡å‹" class="headerlink" title="å•Reactorå•çº¿ç¨‹æ¨¡å‹"></a>å•Reactorå•çº¿ç¨‹æ¨¡å‹</h4><img src="/blog/2020/08/07/netty-Netty%E8%A7%A3%E6%9E%90/pic4.png" srcset="/blog/img/loading.gif" class>

<ul>
<li><p>Reactorå……å½“å¤šè·¯å¤â½¤å™¨â»†â¾Šï¼Œç›‘å¬å¤šè·¯è¿æ¥çš„è¯·æ±‚ï¼Œç”±å•çº¿ç¨‹å®Œæˆ</p>
</li>
<li><p>Reactoræ”¶åˆ°å®¢æˆ·ç«¯å‘æ¥çš„è¯·æ±‚æ—¶ï¼Œå¦‚æœæ˜¯æ–°å»ºè¿æ¥é€šè¿‡Acceptorå®Œæˆï¼Œå…¶ä»–çš„è¯·æ±‚ç”±Handlerå®Œæˆã€‚</p>
</li>
<li><p>Handlerå®Œæˆä¸šåŠ¡é€»è¾‘çš„å¤„ç†ï¼ŒåŸºæœ¬çš„æµç¨‹æ˜¯ï¼šRead â€“&gt; ä¸šåŠ¡å¤„ç† â€“&gt; Send ã€‚</p>
</li>
</ul>
<p>è¿™ç§æ¨¡å‹çš„ä¼˜ç¼ºç‚¹ï¼š</p>
<ul>
<li><p>ä¼˜ç‚¹</p>
<ul>
<li>ç»“æ„ç®€å•ï¼Œç”±å•çº¿ç¨‹å®Œæˆï¼Œæ²¡æœ‰å¤šçº¿ç¨‹ã€è¿›ç¨‹é€šä¿¡ç­‰é—®é¢˜ã€‚</li>
<li>é€‚åˆâ½¤åœ¨â¼€äº›ä¸šåŠ¡é€»è¾‘â½è¾ƒç®€å•ã€å¯¹äºæ€§èƒ½è¦æ±‚ä¸â¾¼çš„åº”â½¤åœºæ™¯ã€‚</li>
</ul>
</li>
<li><p>ç¼ºç‚¹</p>
<ul>
<li>ç”±äºæ˜¯å•çº¿ç¨‹æ“ä½œï¼Œä¸èƒ½å……åˆ†å‘æŒ¥å¤šæ ¸CPUçš„æ€§èƒ½ã€‚</li>
<li>å½“Reactorçº¿ç¨‹è´Ÿè½½è¿‡é‡ä¹‹åï¼Œå¤„ç†é€Ÿåº¦å°†å˜æ…¢ï¼Œè¿™ä¼šå¯¼è‡´â¼¤é‡å®¢æˆ·ç«¯è¿æ¥è¶…æ—¶ï¼Œè¶…æ—¶ä¹‹åå¾€å¾€ä¼šè¿›â¾é‡å‘ï¼Œè¿™æ›´åŠ é‡Reactorçº¿ç¨‹çš„è´Ÿè½½ï¼Œæœ€ç»ˆä¼šå¯¼è‡´â¼¤é‡æ¶ˆæ¯ç§¯å‹å’Œå¤„ç†è¶…æ—¶ï¼Œæˆä¸ºç³»ç»Ÿçš„æ€§èƒ½ç“¶é¢ˆã€‚</li>
<li>å¯é æ€§å·®ï¼Œå¦‚æœè¯¥çº¿ç¨‹è¿›â¼Šæ­»å¾ªç¯æˆ–æ„å¤–ç»ˆâ½Œï¼Œå°±ä¼šå¯¼è‡´æ•´ä¸ªé€šä¿¡ç³»ç»Ÿä¸å¯â½¤ï¼Œå®¹æ˜“é€ æˆå•ç‚¹æ•…éšœã€‚</li>
</ul>
</li>
</ul>
<h4 id="å•Reactorå¤šçº¿ç¨‹æ¨¡å‹"><a href="#å•Reactorå¤šçº¿ç¨‹æ¨¡å‹" class="headerlink" title="å•Reactorå¤šçº¿ç¨‹æ¨¡å‹"></a>å•Reactorå¤šçº¿ç¨‹æ¨¡å‹</h4><img src="/blog/2020/08/07/netty-Netty%E8%A7%A3%E6%9E%90/pic5.png" srcset="/blog/img/loading.gif" class>

<p>è¯´æ˜ï¼š</p>
<ul>
<li><p>åœ¨Reactorå¤šçº¿ç¨‹æ¨¡å‹ç›¸â½è¾ƒå•çº¿ç¨‹æ¨¡å‹â½½â¾”ï¼Œä¸åŒç‚¹åœ¨äºï¼ŒHandlerä¸ä¼šå¤„ç†ä¸šåŠ¡é€»è¾‘ï¼Œåªæ˜¯è´Ÿè´£å“åº”â½¤æˆ·è¯·æ±‚ï¼ŒçœŸæ­£çš„ä¸šåŠ¡é€»è¾‘ï¼Œåœ¨å¦å¤–çš„çº¿ç¨‹ä¸­å®Œæˆã€‚</p>
</li>
<li><p>è¿™æ ·å¯ä»¥é™ä½Reactorçš„æ€§èƒ½å¼€é”€ï¼Œå……åˆ†åˆ©â½¤CPUèµ„æºï¼Œä»â½½æ›´ä¸“æ³¨çš„åšäº‹ä»¶åˆ†å‘â¼¯ä½œäº†ï¼Œæå‡æ•´ä¸ªåº”â½¤çš„ååã€‚</p>
</li>
</ul>
<p>ä½†æ˜¯è¿™ä¸ªæ¨¡å‹å­˜åœ¨çš„é—®é¢˜ï¼š</p>
<ul>
<li><p>å¤šçº¿ç¨‹æ•°æ®å…±äº«å’Œè®¿é—®â½è¾ƒå¤æ‚ã€‚å¦‚æœâ¼¦çº¿ç¨‹å®Œæˆä¸šåŠ¡å¤„ç†åï¼ŒæŠŠç»“æœä¼ é€’ç»™ä¸»çº¿ç¨‹Reactorè¿›â¾å‘é€ï¼Œå°±ä¼šæ¶‰åŠå…±äº«æ•°æ®çš„äº’æ–¥å’Œä¿æŠ¤æœºåˆ¶ã€‚</p>
</li>
<li><p>Reactoræ‰¿æ‹…æ‰€æœ‰äº‹ä»¶çš„ç›‘å¬å’Œå“åº”ï¼Œåªåœ¨ä¸»çº¿ç¨‹ä¸­è¿â¾ï¼Œå¯èƒ½ä¼šå­˜åœ¨æ€§èƒ½é—®é¢˜ã€‚ä¾‹å¦‚å¹¶å‘ç™¾ä¸‡å®¢æˆ·ç«¯è¿æ¥ï¼Œæˆ–è€…æœåŠ¡ç«¯éœ€è¦å¯¹å®¢æˆ·ç«¯æ¡â¼¿è¿›â¾å®‰å…¨è®¤è¯ï¼Œä½†æ˜¯è®¤è¯æœ¬èº«â¾®å¸¸æŸè€—æ€§èƒ½ã€‚</p>
</li>
</ul>
<p>ä¸ºäº†è§£å†³æ€§èƒ½é—®é¢˜ï¼Œäº§â½£äº†ç¬¬ä¸‰ç§ä¸»ä»Reactorå¤šçº¿ç¨‹æ¨¡å‹ã€‚</p>
<h4 id="ä¸»ä»Reactorå¤šçº¿ç¨‹æ¨¡å‹"><a href="#ä¸»ä»Reactorå¤šçº¿ç¨‹æ¨¡å‹" class="headerlink" title="ä¸»ä»Reactorå¤šçº¿ç¨‹æ¨¡å‹"></a>ä¸»ä»Reactorå¤šçº¿ç¨‹æ¨¡å‹</h4><img src="/blog/2020/08/07/netty-Netty%E8%A7%A3%E6%9E%90/pic6.png" srcset="/blog/img/loading.gif" class>

<p>åœ¨ä¸»ä»æ¨¡å‹ä¸­ï¼Œå°†Reactoråˆ†æˆ2éƒ¨åˆ†ï¼š</p>
<ul>
<li><p>MainReactorè´Ÿè´£ç›‘å¬server socketï¼Œâ½¤æ¥å¤„ç†â½¹ç»œIOè¿æ¥å»ºâ½´æ“ä½œï¼Œå°†å»ºâ½´çš„socketChannelæŒ‡å®šæ³¨å†Œç»™SubReactorã€‚</p>
</li>
<li><p>SubReactorä¸»è¦å®Œæˆå’Œå»ºâ½´èµ·æ¥çš„socketçš„æ•°æ®äº¤äº’å’Œäº‹ä»¶ä¸šåŠ¡å¤„ç†æ“ä½œã€‚</p>
</li>
</ul>
<p>è¯¥æ¨¡å‹çš„ä¼˜ç‚¹ï¼š</p>
<ul>
<li><p>å“åº”å¿«ï¼Œä¸å¿…ä¸ºå•ä¸ªåŒæ­¥äº‹ä»¶æ‰€é˜»å¡ï¼Œè™½ç„¶Reactoræœ¬èº«ä¾ç„¶æ˜¯åŒæ­¥çš„ã€‚</p>
</li>
<li><p>å¯æ‰©å±•æ€§å¼ºï¼Œå¯ä»¥â½…ä¾¿åœ°é€šè¿‡å¢åŠ SubReactorå®ä¾‹ä¸ªæ•°æ¥å……åˆ†åˆ©â½¤CPUèµ„æºã€‚</p>
</li>
<li><p>å¯å¤â½¤æ€§â¾¼ï¼ŒReactoræ¨¡å‹æœ¬èº«ä¸å…·ä½“äº‹ä»¶å¤„ç†é€»è¾‘â½†å…³ï¼Œå…·æœ‰å¾ˆâ¾¼çš„å¤â½¤æ€§ã€‚</p>
</li>
</ul>
<h4 id="Nettyæ¨¡å‹"><a href="#Nettyæ¨¡å‹" class="headerlink" title="Nettyæ¨¡å‹"></a>Nettyæ¨¡å‹</h4><p>Nettyæ¨¡å‹æ˜¯åŸºäºReactoræ¨¡å‹å®ç°çš„ï¼Œå¯¹äºä»¥ä¸Šä¸‰ç§æ¨¡å‹éƒ½æœ‰â¾®å¸¸å¥½çš„â½€æŒï¼Œä¹Ÿâ¾®å¸¸çš„çµæ´»ï¼Œâ¼€èˆ¬æƒ…å†µï¼Œåœ¨æœåŠ¡ç«¯ä¼šé‡‡â½¤ä¸»ä»æ¶æ„æ¨¡å‹ï¼ŒåŸºæœ¬ç¤ºæ„å›¾å¦‚ä¸‹ï¼š</p>
<img src="/blog/2020/08/07/netty-Netty%E8%A7%A3%E6%9E%90/pic7.png" srcset="/blog/img/loading.gif" class>

<p>è¯´æ˜ï¼š</p>
<ul>
<li><p>åœ¨Nettyæ¨¡å‹ä¸­ï¼Œè´Ÿè´£å¤„ç†æ–°è¿æ¥äº‹ä»¶çš„æ˜¯BossGroupï¼Œè´Ÿè´£å¤„ç†å…¶ä»–äº‹ä»¶çš„æ˜¯WorkGroupã€‚Groupå°±æ˜¯çº¿ç¨‹æ± çš„æ¦‚å¿µã€‚</p>
</li>
<li><p>NioEventLoopè¡¨ç¤ºâ¼€ä¸ªä¸æ–­å¾ªç¯çš„æ‰§â¾å¤„ç†ä»»åŠ¡çš„çº¿ç¨‹ï¼Œâ½¤äºç›‘å¬ç»‘å®šåœ¨å…¶ä¸Šçš„è¯»/å†™äº‹ä»¶ã€‚</p>
</li>
<li><p>é€šè¿‡Pipelineï¼ˆç®¡é“ï¼‰æ‰§â¾ä¸šåŠ¡é€»è¾‘çš„å¤„ç†ï¼ŒPipelineä¸­ä¼šæœ‰å¤šä¸ªChannelHandlerï¼ŒçœŸæ­£çš„ä¸šåŠ¡é€»è¾‘æ˜¯åœ¨ChannelHandlerä¸­å®Œæˆçš„ã€‚</p>
</li>
</ul>
<h3 id="Nettyæ ¸â¼¼ç»„ä»¶"><a href="#Nettyæ ¸â¼¼ç»„ä»¶" class="headerlink" title="Nettyæ ¸â¼¼ç»„ä»¶"></a>Nettyæ ¸â¼¼ç»„ä»¶</h3><h4 id="Channel"><a href="#Channel" class="headerlink" title="Channel"></a>Channel</h4><p>Channelå¯ä»¥ç†è§£ä¸ºæ˜¯socketè¿æ¥ï¼Œåœ¨å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯è¿æ¥çš„æ—¶å€™å°±ä¼šå»ºâ½´â¼€ä¸ªChannelï¼Œå®ƒè´Ÿè´£åŸºæœ¬çš„IOæ“ä½œï¼Œâ½å¦‚ï¼šbind()ã€connect()ï¼Œread()ï¼Œwrite() ç­‰ã€‚</p>
<p>Netty çš„ Channel æ¥â¼æ‰€æä¾›çš„ APIï¼Œâ¼¤â¼¤åœ°é™ä½äº†ç›´æ¥ä½¿â½¤ Socket ç±»çš„å¤æ‚æ€§ã€‚</p>
<p>ä¸åŒåè®®ã€ä¸åŒçš„é˜»å¡ç±»å‹çš„è¿æ¥éƒ½æœ‰ä¸åŒçš„ Channel ç±»å‹ä¸ä¹‹å¯¹åº”ï¼Œå¸¸â½¤çš„ Channel ç±»å‹:</p>
<ul>
<li><p>NioSocketChannelï¼ŒNIOçš„å®¢æˆ·ç«¯ TCP Socket è¿æ¥ã€‚</p>
</li>
<li><p>NioServerSocketChannelï¼ŒNIOçš„æœåŠ¡å™¨ç«¯ TCP Socket è¿æ¥ã€‚</p>
</li>
<li><p>NioDatagramChannelï¼ŒUDP è¿æ¥ã€‚</p>
</li>
<li><p>NioSctpChannelï¼Œå®¢æˆ·ç«¯ Sctp è¿æ¥ã€‚</p>
</li>
<li><p>NioSctpServerChannelï¼ŒSctp æœåŠ¡å™¨ç«¯è¿æ¥ï¼Œè¿™äº›é€šé“æ¶µç›–äº† UDP å’Œ TCP â½¹ç»œ IO ä»¥åŠâ½‚ä»¶IOã€‚</p>
</li>
</ul>
<h4 id="EventLoopã€EventLoopGroup"><a href="#EventLoopã€EventLoopGroup" class="headerlink" title="EventLoopã€EventLoopGroup"></a>EventLoopã€EventLoopGroup</h4><p>æœ‰äº† Channel è¿æ¥æœåŠ¡ï¼Œè¿æ¥ä¹‹é—´å¯ä»¥æ¶ˆæ¯æµåŠ¨ã€‚å¦‚æœæœåŠ¡å™¨å‘å‡ºçš„æ¶ˆæ¯ç§°ä½œâ€œå‡ºç«™â€æ¶ˆæ¯ï¼ŒæœåŠ¡å™¨æ¥å—çš„æ¶ˆæ¯ç§°ä½œâ€œâ¼Šç«™â€æ¶ˆæ¯ã€‚é‚£ä¹ˆæ¶ˆæ¯çš„â€œå‡ºç«™â€/â€œâ¼Šç«™â€å°±ä¼šäº§â½£äº‹ä»¶ï¼ˆEventï¼‰ã€‚</p>
<p>ä¾‹å¦‚ï¼šè¿æ¥å·²æ¿€æ´»ï¼›æ•°æ®è¯»å–ï¼›â½¤æˆ·äº‹ä»¶ï¼›å¼‚å¸¸äº‹ä»¶ï¼›æ‰“å¼€é“¾æ¥ï¼›å…³é—­é“¾æ¥ç­‰ç­‰ã€‚</p>
<p>æœ‰äº†äº‹ä»¶ï¼Œå°±éœ€è¦â¼€ä¸ªæœºåˆ¶å»ç›‘æ§å’Œåè°ƒäº‹ä»¶ï¼Œè¿™ä¸ªæœºåˆ¶ï¼ˆç»„ä»¶ï¼‰å°±æ˜¯EventLoopã€‚ </p>
<p>åœ¨ Netty ä¸­æ¯ä¸ª Channel éƒ½ä¼šè¢«åˆ†é…åˆ°â¼€ä¸ª EventLoopã€‚â¼€ä¸ª EventLoop å¯ä»¥æœåŠ¡äºå¤šä¸ª Channelã€‚æ¯ä¸ª EventLoop ä¼šå â½¤â¼€ä¸ª Threadï¼ŒåŒæ—¶è¿™ä¸ª Thread ä¼šå¤„ç† EventLoop ä¸Šâ¾¯å‘â½£çš„æ‰€æœ‰ IO æ“ä½œå’Œäº‹ä»¶ã€‚</p>
<img src="/blog/2020/08/07/netty-Netty%E8%A7%A3%E6%9E%90/pic8.png" srcset="/blog/img/loading.gif" class>

<p>EventLoopGroup æ˜¯â½¤æ¥â½£æˆ EventLoop çš„ï¼Œåœ¨å‰â¾¯çš„ä¾‹â¼¦ä¸­ï¼Œç¬¬â¼€â¾ä»£ç å°±æ˜¯ new NioEventLoopGroup();</p>
<pre><code class="java">// ä¸»çº¿ç¨‹ï¼Œä¸å¤„ç†ä»»ä½•ä¸šåŠ¡é€»è¾‘ï¼Œåªæ˜¯æ¥æ”¶å®¢æˆ·çš„è¿æ¥è¯·æ±‚
EventLoopGroup boss = new NioEventLoopGroup(1);
// â¼¯ä½œçº¿ç¨‹ï¼Œçº¿ç¨‹æ•°é»˜è®¤æ˜¯ï¼šcpu*2
EventLoopGroup worker = new NioEventLoopGroup();</code></pre>
<p>å¦‚æœæ²¡æœ‰æŒ‡å®šçº¿ç¨‹æ•°â¼¤â¼©ï¼Œé»˜è®¤çº¿ç¨‹æ•°ä¸ºï¼šcpuæ ¸æ•°*2ï¼Œæºç å¦‚ä¸‹ï¼š</p>
<pre><code class="java">static {
    DEFAULT_EVENT_LOOP_THREADS = Math.max(1, SystemPropertyUtil.getInt(
        &quot;io.netty.eventLoopThreads&quot;, NettyRuntime.availableProcessors()* 2)); //å¯â½¤cpuæ ¸æ•° * 2
    if (logger.isDebugEnabled()) {
        logger.debug(&quot;-Dio.netty.eventLoopThreads: {}&quot;,
            DEFAULT_EVENT_LOOP_THREADS);
     }
}</code></pre>
<p>å…³ç³»ä¸ºï¼š</p>
<ul>
<li><p>â¼€ä¸ª EventLoopGroup åŒ…å«â¼€ä¸ªæˆ–è€…å¤šä¸ª EventLoop;</p>
</li>
<li><p>â¼€ä¸ª EventLoop åœ¨å®ƒçš„â½£å‘½å‘¨æœŸå†…åªå’Œâ¼€ä¸ª Thread ç»‘å®š;</p>
</li>
<li><p>æ‰€æœ‰ç”± EventLoop å¤„ç†çš„ I/O äº‹ä»¶éƒ½å°†åœ¨å®ƒä¸“æœ‰çš„ Thread ä¸Šè¢«å¤„ç†;</p>
</li>
<li><p>â¼€ä¸ª Channel åœ¨å®ƒçš„â½£å‘½å‘¨æœŸå†…åªæ³¨å†Œäºâ¼€ä¸ª EventLoop;</p>
</li>
<li><p>â¼€ä¸ª EventLoop å¯èƒ½ä¼šè¢«åˆ†é…ç»™â¼€ä¸ªæˆ–å¤šä¸ª Channelã€‚</p>
</li>
</ul>
<h4 id="ChannelHandler"><a href="#ChannelHandler" class="headerlink" title="ChannelHandler"></a>ChannelHandler</h4><p>ChannelHandlerå¯¹ä½¿â½¤è€…â½½â¾”ï¼Œå¯ä»¥è¯´æ˜¯æœ€é‡è¦çš„ç»„ä»¶äº†ï¼Œå› ä¸ºå¯¹äºæ•°æ®çš„â¼Šç«™å’Œå‡ºç«™çš„ä¸šåŠ¡é€»è¾‘çš„ç¼–å†™éƒ½æ˜¯åœ¨ChannelHandlerä¸­å®Œæˆçš„ã€‚</p>
<p>åœ¨å‰â¾¯çš„ä¾‹â¼¦ä¸­ï¼ŒMyChannelHandlerå°±æ˜¯å®ç°äº†channelReadâ½…æ³•ï¼Œè·å–åˆ°å®¢æˆ·ç«¯ä¼ æ¥çš„æ•°æ®ã€‚</p>
<p>å¯¹äºæ•°æ®çš„å‡ºç«™å’Œâ¼Šç«™ï¼Œæœ‰ç€ä¸åŒçš„ChannelHandlerç±»å‹ä¸ä¹‹å¯¹åº”ï¼š</p>
<ul>
<li><p>ChannelInboundHandler â¼Šç«™äº‹ä»¶å¤„ç†å™¨</p>
</li>
<li><p>ChannelOutBoundHandler å‡ºç«™äº‹ä»¶å¤„ç†å™¨</p>
</li>
</ul>
<p>æ¥â¼ç»§æ‰¿å…³ç³»å¦‚ä¸‹ï¼š</p>
<img src="/blog/2020/08/07/netty-Netty%E8%A7%A3%E6%9E%90/pic9.png" srcset="/blog/img/loading.gif" class>

<p>ChannelHandlerAdapteræä¾›äº†â¼€äº›â½…æ³•çš„é»˜è®¤å®ç°ï¼Œå¯å‡å°‘â½¤æˆ·å¯¹äºChannelHandlerçš„ç¼–å†™ã€‚</p>
<blockquote>
<p>ChannelInboundHandlerAdapter ä¸ SimpleChannelInboundHandlerçš„åŒºåˆ«ï¼š</p>
<ul>
<li><p>åœ¨æœåŠ¡ç«¯ç¼–å†™ChannelHandleræ—¶ç»§æ‰¿çš„æ˜¯ChannelInboundHandlerAdapter</p>
</li>
<li><p>åœ¨å®¢æˆ·ç«¯ç¼–å†™ChannelHandleræ—¶ç»§æ‰¿çš„æ˜¯SimpleChannelInboundHandler</p>
</li>
<li><p>ä¸¤è€…çš„åŒºåˆ«åœ¨äºï¼Œå‰è€…ä¸ä¼šé‡Šæ”¾æ¶ˆæ¯æ•°æ®çš„å¼•â½¤ï¼Œâ½½åè€…ä¼šé‡Šæ”¾æ¶ˆæ¯æ•°æ®çš„å¼•â½¤ã€‚</p>
</li>
</ul>
</blockquote>
<img src="/blog/2020/08/07/netty-Netty%E8%A7%A3%E6%9E%90/pic10.png" srcset="/blog/img/loading.gif" class>

<h4 id="ChannelPipeline"><a href="#ChannelPipeline" class="headerlink" title="ChannelPipeline"></a>ChannelPipeline</h4><p>åœ¨Channelçš„æ•°æ®ä¼ é€’è¿‡ç¨‹ä¸­ï¼Œå¯¹åº”ç€æœ‰å¾ˆå¤šçš„ä¸šåŠ¡é€»è¾‘éœ€è¦å¤„ç†ï¼Œâ½å¦‚ï¼šç¼–ç è§£ç å¤„ç†ã€è¯»å†™æ“ä½œç­‰ï¼Œé‚£ä¹ˆå¯¹äºæ¯ç§ä¸šåŠ¡é€»è¾‘å®ç°éƒ½éœ€è¦æœ‰ä¸ªChannelHandlerå®Œæˆï¼Œä¹Ÿå°±æ„å‘³ç€ï¼Œâ¼€ä¸ªChannelå¯¹åº”ç€å¤šä¸ªChannelHandlerï¼Œå¤šä¸ªChannelHandlerå¦‚ä½•å»ç®¡ç†å®ƒä»¬ï¼Œå®ƒä»¬çš„æ‰§â¾é¡ºåºâ¼œè¯¥æ˜¯æ€ä¹ˆæ ·çš„ï¼Œè¿™å°±éœ€è¦ChannelPipelineè¿›â¾ç®¡ç†äº†ã€‚</p>
<p>â¼€ä¸ªChannelåŒ…å«äº†â¼€ä¸ªChannelPipelineï¼Œâ½½ChannelPipelineä¸­ç»´æŠ¤äº†â¼€ä¸ªChannelHandlerçš„åˆ—è¡¨ã€‚</p>
<p>ChannelHandlerä¸Channelå’ŒChannelPipelineä¹‹é—´çš„æ˜ å°„å…³ç³»ï¼Œç”±ChannelHandlerContextè¿›â¾ç»´æŠ¤ã€‚</p>
<p>å®ƒä»¬å…³ç³»å¦‚ä¸‹ï¼š</p>
<img src="/blog/2020/08/07/netty-Netty%E8%A7%A3%E6%9E%90/pic11.png" srcset="/blog/img/loading.gif" class>

<p>ChannelHandleræŒ‰ç…§åŠ â¼Šçš„é¡ºåºä¼šç»„æˆâ¼€ä¸ªåŒå‘é“¾è¡¨ï¼Œâ¼Šç«™äº‹ä»¶ä»é“¾è¡¨çš„headå¾€åä¼ é€’åˆ°æœ€åâ¼€ä¸ªChannelHandlerï¼Œå‡ºç«™äº‹ä»¶ä»é“¾è¡¨çš„tailå‘å‰ä¼ é€’ï¼Œç›´åˆ°æœ€åâ¼€ä¸ªChannelHandlerï¼Œä¸¤ç§ç±»å‹çš„ChannelHandlerç›¸äº’ä¸ä¼šå½±å“ã€‚</p>
<h4 id="Bootstrap"><a href="#Bootstrap" class="headerlink" title="Bootstrap"></a>Bootstrap</h4><p>Bootstrapæ˜¯å¼•å¯¼çš„æ„æ€ï¼Œå®ƒçš„ä½œâ½¤æ˜¯é…ç½®æ•´ä¸ªNettyç¨‹åºï¼Œå°†å„ä¸ªç»„ä»¶éƒ½ä¸²èµ·æ¥ï¼Œæœ€åç»‘å®šç«¯â¼ã€å¯åŠ¨NettyæœåŠ¡ã€‚</p>
<p>Nettyä¸­æä¾›äº†2ç§ç±»å‹çš„å¼•å¯¼ç±»ï¼Œâ¼€ç§â½¤äºå®¢æˆ·ç«¯(Bootstrap)ï¼Œâ½½å¦â¼€ç§(ServerBootstrap)â½¤äºæœåŠ¡å™¨ã€‚</p>
<p>å®ƒä»¬çš„åŒºåˆ«åœ¨äºï¼š</p>
<ul>
<li>ServerBootstrap å°†ç»‘å®šåˆ°â¼€ä¸ªç«¯â¼ï¼Œå› ä¸ºæœåŠ¡å™¨å¿…é¡»è¦ç›‘å¬è¿æ¥ï¼Œâ½½ Bootstrap åˆ™æ˜¯ç”±æƒ³è¦è¿æ¥åˆ°è¿œç¨‹èŠ‚ç‚¹çš„å®¢æˆ·ç«¯åº”â½¤ç¨‹åºæ‰€ä½¿â½¤çš„ã€‚</li>
<li>å¼•å¯¼â¼€ä¸ªå®¢æˆ·ç«¯åªéœ€è¦â¼€ä¸ªEventLoopGroupï¼Œä½†æ˜¯â¼€ä¸ªServerBootstrapåˆ™éœ€è¦ä¸¤ä¸ªã€‚<ul>
<li>å› ä¸ºæœåŠ¡å™¨éœ€è¦ä¸¤ç»„ä¸åŒçš„ Channel</li>
<li>ç¬¬â¼€ç»„å°†åªåŒ…å«â¼€ä¸ª ServerChannelï¼Œä»£è¡¨æœåŠ¡å™¨â¾ƒèº«çš„å·²ç»‘å®šåˆ°æŸä¸ªæœ¬åœ°ç«¯â¼çš„æ­£åœ¨ç›‘å¬çš„å¥—æ¥å­—ã€‚</li>
<li>ç¬¬â¼†ç»„å°†åŒ…å«æ‰€æœ‰å·²åˆ›å»ºçš„â½¤æ¥å¤„ç†ä¼ â¼Šå®¢æˆ·ç«¯è¿æ¥ã€‚</li>
</ul>
</li>
</ul>
<img src="/blog/2020/08/07/netty-Netty%E8%A7%A3%E6%9E%90/pic12.png" srcset="/blog/img/loading.gif" class>

<p>ä¸ServerChannelç›¸å…³è”çš„EventLoopGroup å°†åˆ†é…â¼€ä¸ªè´Ÿè´£ä¸ºä¼ â¼Šè¿æ¥è¯·æ±‚åˆ›å»º Channel çš„ EventLoopã€‚â¼€æ—¦è¿æ¥è¢«æ¥å—ï¼Œç¬¬â¼†ä¸ª EventLoopGroup å°±ä¼šç»™å®ƒçš„ Channel åˆ†é…â¼€ä¸ª EventLoopã€‚</p>
<h4 id="Future"><a href="#Future" class="headerlink" title="Future"></a>Future</h4><p>Futureæä¾›äº†â¼€ç§åœ¨æ“ä½œå®Œæˆæ—¶é€šçŸ¥åº”â½¤ç¨‹åºçš„â½…å¼ã€‚è¿™ä¸ªå¯¹è±¡å¯ä»¥çœ‹ä½œæ˜¯â¼€ä¸ªå¼‚æ­¥æ“ä½œçš„ç»“æœçš„å ä½ç¬¦ï¼Œå®ƒå°†åœ¨æœªæ¥çš„æŸä¸ªæ—¶åˆ»å®Œæˆï¼Œå¹¶æä¾›å¯¹å…¶ç»“æœçš„è®¿é—®ã€‚</p>
<p>JDK é¢„ç½®äº† interface java.util.concurrent.Futureï¼Œä½†æ˜¯å…¶æ‰€æä¾›çš„å®ç°ï¼Œåªå…è®¸â¼¿åŠ¨æ£€æŸ¥å¯¹åº”çš„æ“ä½œæ˜¯å¦å·²ç»å®Œæˆï¼Œæˆ–è€…â¼€ç›´é˜»å¡ç›´åˆ°å®ƒå®Œæˆã€‚è¿™æ˜¯â¾®å¸¸ç¹ççš„ï¼Œæ‰€ä»¥ Netty æä¾›äº†å®ƒâ¾ƒâ¼°çš„å®ç°â€”â€”ChannelFutureï¼Œâ½¤äºåœ¨æ‰§â¾å¼‚æ­¥æ“ä½œçš„æ—¶å€™ä½¿â½¤ã€‚</p>
<ul>
<li><p>ChannelFutureæä¾›äº†â¼ç§é¢å¤–çš„â½…æ³•ï¼Œè¿™äº›â½…æ³•ä½¿å¾—æˆ‘ä»¬èƒ½å¤Ÿæ³¨å†Œâ¼€ä¸ªæˆ–è€…å¤šä¸ªChannelFutureListenerå®ä¾‹ã€‚</p>
</li>
<li><p>ç›‘å¬å™¨çš„å›è°ƒâ½…æ³•operationComplete()ï¼Œå°†ä¼šåœ¨å¯¹åº”çš„ æ“ä½œå®Œæˆæ—¶è¢«è°ƒâ½¤ ã€‚ç„¶åç›‘å¬å™¨å¯ä»¥åˆ¤æ–­è¯¥æ“ä½œæ˜¯æˆåŠŸåœ°å®Œæˆäº†è¿˜æ˜¯å‡ºé”™äº†ã€‚</p>
</li>
<li><p>æ¯ä¸ª Netty çš„å‡ºç«™ I/O æ“ä½œéƒ½å°†è¿”å›â¼€ä¸ª ChannelFutureï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒä»¬éƒ½ä¸ä¼šé˜»å¡ã€‚ æ‰€ä»¥è¯´ï¼ŒNettyå®Œå…¨æ˜¯å¼‚æ­¥å’Œäº‹ä»¶é©±åŠ¨çš„ã€‚</p>
</li>
</ul>
<img src="/blog/2020/08/07/netty-Netty%E8%A7%A3%E6%9E%90/pic13.png" srcset="/blog/img/loading.gif" class>

<p>ä¸Šå›¾æ˜¯ serverBootstrap.bind(port) â½…æ³•åº•å±‚çš„é€»è¾‘å®ç°ã€‚</p>
<h4 id="å…³ç³»å›¾"><a href="#å…³ç³»å›¾" class="headerlink" title="å…³ç³»å›¾"></a>å…³ç³»å›¾</h4><img src="/blog/2020/08/07/netty-Netty%E8%A7%A3%E6%9E%90/pic14.png" srcset="/blog/img/loading.gif" class>

<h3 id="è¯¦è§£ByteBuf"><a href="#è¯¦è§£ByteBuf" class="headerlink" title="è¯¦è§£ByteBuf"></a>è¯¦è§£ByteBuf</h3><h4 id="â¼¯ä½œåŸç†"><a href="#â¼¯ä½œåŸç†" class="headerlink" title="â¼¯ä½œåŸç†"></a>â¼¯ä½œåŸç†</h4><p>Java NIO æä¾›äº†ByteBuffer ä½œä¸ºå®ƒ çš„å­—èŠ‚å®¹å™¨ï¼Œä½†æ˜¯è¿™ä¸ªç±»ä½¿â½¤èµ·æ¥è¿‡äºå¤æ‚ï¼Œâ½½ä¸”ä¹Ÿæœ‰äº›ç¹çã€‚Netty çš„ ByteBuffer æ›¿ä»£å“æ˜¯ ByteBufï¼Œâ¼€ä¸ªå¼ºâ¼¤çš„å®ç°ï¼Œæ—¢è§£å†³äº†JDK API çš„å±€é™æ€§ï¼Œ â¼œä¸ºâ½¹ç»œåº”â½¤ç¨‹åºçš„å¼€å‘è€…æä¾›äº†æ›´å¥½çš„APIã€‚</p>
<p>ä»ç»“æ„ä¸Šæ¥è¯´ï¼ŒByteBuf ç”±â¼€ä¸²å­—èŠ‚æ•°ç»„æ„æˆã€‚æ•°ç»„ä¸­æ¯ä¸ªå­—èŠ‚â½¤æ¥å­˜æ”¾ä¿¡æ¯ã€‚</p>
<p>ByteBuf æä¾›äº†ä¸¤ä¸ªç´¢å¼•ï¼Œâ¼€ä¸ªâ½¤äºè¯»å–æ•°æ®ï¼Œâ¼€ä¸ªâ½¤äºå†™â¼Šæ•°æ®ã€‚è¿™ä¸¤ä¸ªç´¢å¼•é€šè¿‡åœ¨å­—èŠ‚æ•°ç»„ä¸­ç§»åŠ¨ï¼Œæ¥å®šä½éœ€è¦è¯»æˆ–è€…å†™ä¿¡æ¯çš„ä½ç½®ã€‚</p>
<p>å½“ä» ByteBuf è¯»å–æ—¶ï¼Œå®ƒçš„ readerIndexï¼ˆè¯»ç´¢å¼•ï¼‰å°†ä¼šæ ¹æ®è¯»å–çš„å­—èŠ‚æ•°é€’å¢ã€‚</p>
<p>åŒæ ·ï¼Œå½“å†™ ByteBuf æ—¶ï¼Œå®ƒçš„ writerIndexï¼ˆå†™ç´¢å¼•ï¼‰ ä¹Ÿä¼šæ ¹æ®å†™â¼Šçš„å­—èŠ‚æ•°è¿›â¾é€’å¢ã€‚</p>
<pre><code class="sh">+-------------------+------------------+------------------+
| discardable bytes | readable bytes | writable bytes |
| | (CONTENT) | |
+-------------------+------------------+------------------+
| | | |
0 &lt;= readerIndex &lt;= writerIndex &lt;= capacity
#discardable bytes -- å¯ä¸¢å¼ƒçš„å­—èŠ‚ç©ºé—´
#readable bytes -- å¯è¯»çš„å­—èŠ‚ç©ºé—´
#writable bytes --å¯å†™çš„å­—èŠ‚ç©ºé—´
#capacity -- æœ€â¼¤çš„å®¹é‡</code></pre>
<p>å¦‚æœ readerIndex è¶…è¿‡äº† writerIndex çš„æ—¶å€™ï¼ŒNetty ä¼šæŠ›å‡º IndexOutOf-BoundsException å¼‚å¸¸ã€‚</p>
<h4 id="åŸºæœ¬ä½¿ç”¨"><a href="#åŸºæœ¬ä½¿ç”¨" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h4><h5 id="è¯»å–æ“ä½œ"><a href="#è¯»å–æ“ä½œ" class="headerlink" title="è¯»å–æ“ä½œ"></a>è¯»å–æ“ä½œ</h5><pre><code class="java">package cn.itcast.myrpc.test;

import io.netty.buffer.ByteBuf;
import io.netty.buffer.Unpooled;
import io.netty.util.CharsetUtil;

public class TestByteBuf01 {
    public static void main(String[] args) {
        //æ„é€ 
        ByteBuf byteBuf = Unpooled.copiedBuffer(&quot;hello world&quot;,
                CharsetUtil.UTF_8);
        System.out.println(&quot;byteBufçš„å®¹é‡ä¸ºï¼š&quot; + byteBuf.capacity());
        System.out.println(&quot;byteBufçš„å¯è¯»å®¹é‡ä¸ºï¼š&quot; + byteBuf.readableBytes());
        System.out.println(&quot;byteBufçš„å¯å†™å®¹é‡ä¸ºï¼š&quot; + byteBuf.writableBytes());
        while (byteBuf.isReadable()) { //â½…æ³•â¼€ï¼šå†…éƒ¨é€šè¿‡ç§»åŠ¨readerIndexè¿›â¾è¯»å–
            System.out.println((char) byteBuf.readByte());
        }
        //â½…æ³•â¼†ï¼šé€šè¿‡ä¸‹æ ‡ç›´æ¥è¯»å–
        for (int i = 0; i &lt; byteBuf.readableBytes(); i++) {
            System.out.println((char) byteBuf.getByte(i));
        }
        //â½…æ³•ä¸‰ï¼šè½¬åŒ–ä¸ºbyte[]è¿›â¾è¯»å–
        byte[] bytes = byteBuf.array();
        for (byte b : bytes) {
            System.out.println((char) b);
        }
    }
}</code></pre>
<h5 id="å†™å…¥æ“ä½œ"><a href="#å†™å…¥æ“ä½œ" class="headerlink" title="å†™å…¥æ“ä½œ"></a>å†™å…¥æ“ä½œ</h5><pre><code class="java">package cn.itcast.myrpc.test;

import io.netty.buffer.ByteBuf;
import io.netty.buffer.Unpooled;
import io.netty.util.CharsetUtil;

public class TestByteBuf02 {
    public static void main(String[] args) {
        //æ„é€ ç©ºçš„å­—èŠ‚ç¼“å†²åŒºï¼Œåˆå§‹â¼¤â¼©ä¸º10ï¼Œæœ€â¼¤ä¸º20
        ByteBuf byteBuf = Unpooled.buffer(10, 20);
        System.out.println(&quot;byteBufçš„å®¹é‡ä¸ºï¼š&quot; + byteBuf.capacity());
        System.out.println(&quot;byteBufçš„å¯è¯»å®¹é‡ä¸ºï¼š&quot; + byteBuf.readableBytes());
        System.out.println(&quot;byteBufçš„å¯å†™å®¹é‡ä¸ºï¼š&quot; + byteBuf.writableBytes());
        for (int i = 0; i &lt; 5; i++) {
            byteBuf.writeInt(i); //å†™â¼Šintç±»å‹ï¼Œâ¼€ä¸ªintå 4ä¸ªå­—èŠ‚
        }
        System.out.println(&quot;ok&quot;);
        System.out.println(&quot;byteBufçš„å®¹é‡ä¸ºï¼š&quot; + byteBuf.capacity());
        System.out.println(&quot;byteBufçš„å¯è¯»å®¹é‡ä¸ºï¼š&quot; + byteBuf.readableBytes());
        System.out.println(&quot;byteBufçš„å¯å†™å®¹é‡ä¸ºï¼š&quot; + byteBuf.writableBytes());
        while (byteBuf.isReadable()) {
            System.out.println(byteBuf.readInt());
        }
    }
}</code></pre>
<h5 id="ä¸¢å¼ƒå·²è¯»å­—èŠ‚"><a href="#ä¸¢å¼ƒå·²è¯»å­—èŠ‚" class="headerlink" title="ä¸¢å¼ƒå·²è¯»å­—èŠ‚"></a>ä¸¢å¼ƒå·²è¯»å­—èŠ‚</h5><pre><code class="sh">#é€šè¿‡discardReadBytes()â½…å¯ä»¥å°†å·²ç»è¯»å–çš„æ•°æ®è¿›â¾ä¸¢å¼ƒå¤„ç†ï¼Œå°±å¯ä»¥å›æ”¶å·²ç»è¯»å–çš„å­—èŠ‚ç©ºé—´
BEFORE discardReadBytes()
+-------------------+------------------+------------------+
| discardable bytes | readable bytes | writable bytes |
+-------------------+------------------+------------------+
| | | |
0 &lt;= readerIndex &lt;= writerIndex &lt;= capacity
AFTER discardReadBytes()
+------------------+--------------------------------------+
| readable bytes | writable bytes (got more space) |
+------------------+--------------------------------------+
| | |
readerIndex (0) &lt;= writerIndex (decreased)</code></pre>
<pre><code class="java">package cn.itcast.myrpc.test;

import io.netty.buffer.ByteBuf;
import io.netty.buffer.Unpooled;
import io.netty.util.CharsetUtil;

public class TestByteBuf03 {
    public static void main(String[] args) {
        ByteBuf byteBuf = Unpooled.copiedBuffer(&quot;hello world&quot;,
                CharsetUtil.UTF_8);
        System.out.println(&quot;byteBufçš„å®¹é‡ä¸ºï¼š&quot; + byteBuf.capacity());
        System.out.println(&quot;byteBufçš„å¯è¯»å®¹é‡ä¸ºï¼š&quot; + byteBuf.readableBytes());
        System.out.println(&quot;byteBufçš„å¯å†™å®¹é‡ä¸ºï¼š&quot; + byteBuf.writableBytes());
        while (byteBuf.isReadable()) {
            System.out.println((char) byteBuf.readByte());
        }
        byteBuf.discardReadBytes(); //ä¸¢å¼ƒå·²è¯»çš„å­—èŠ‚ç©ºé—´
        System.out.println(&quot;byteBufçš„å®¹é‡ä¸ºï¼š&quot; + byteBuf.capacity());
        System.out.println(&quot;byteBufçš„å¯è¯»å®¹é‡ä¸ºï¼š&quot; + byteBuf.readableBytes());
        System.out.println(&quot;byteBufçš„å¯å†™å®¹é‡ä¸ºï¼š&quot; + byteBuf.writableBytes());
    }
}</code></pre>
<h5 id="clear"><a href="#clear" class="headerlink" title="clear()"></a>clear()</h5><pre><code class="sh">#é€šè¿‡clear() é‡ç½®readerIndex ã€ writerIndex ä¸º0ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé‡ç½®å¹¶æ²¡æœ‰åˆ é™¤çœŸæ­£çš„å†…å®¹
BEFORE clear()
+-------------------+------------------+------------------+
| discardable bytes | readable bytes | writable bytes |
+-------------------+------------------+------------------+
| | | |
0 &lt;= readerIndex &lt;= writerIndex &lt;= capacity
AFTER clear()
+---------------------------------------------------------+
| writable bytes (got more space) |
+---------------------------------------------------------+
| |
0 = readerIndex = writerIndex &lt;= capacity</code></pre>
<pre><code class="java">package cn.itcast.myrpc.test;

import io.netty.buffer.ByteBuf;
import io.netty.buffer.Unpooled;
import io.netty.util.CharsetUtil;

public class TestByteBuf04 {
    public static void main(String[] args) {
        ByteBuf byteBuf = Unpooled.copiedBuffer(&quot;hello world&quot;,
                CharsetUtil.UTF_8);
        System.out.println(&quot;byteBufçš„å®¹é‡ä¸ºï¼š&quot; + byteBuf.capacity());
        System.out.println(&quot;byteBufçš„å¯è¯»å®¹é‡ä¸ºï¼š&quot; + byteBuf.readableBytes());
        System.out.println(&quot;byteBufçš„å¯å†™å®¹é‡ä¸ºï¼š&quot; + byteBuf.writableBytes());
        byteBuf.clear(); //é‡ç½®readerIndex ã€ writerIndex ä¸º0
        System.out.println(&quot;byteBufçš„å®¹é‡ä¸ºï¼š&quot; + byteBuf.capacity());
        System.out.println(&quot;byteBufçš„å¯è¯»å®¹é‡ä¸ºï¼š&quot; + byteBuf.readableBytes());
        System.out.println(&quot;byteBufçš„å¯å†™å®¹é‡ä¸ºï¼š&quot; + byteBuf.writableBytes());
    }
}</code></pre>
<h4 id="ByteBuf-ä½¿â½¤æ¨¡å¼"><a href="#ByteBuf-ä½¿â½¤æ¨¡å¼" class="headerlink" title="ByteBuf ä½¿â½¤æ¨¡å¼"></a>ByteBuf ä½¿â½¤æ¨¡å¼</h4><p>æ ¹æ®å­˜æ”¾ç¼“å†²åŒºçš„ä¸åŒåˆ†ä¸ºä¸‰ç±»ï¼š</p>
<ul>
<li><p>å †ç¼“å†²åŒºï¼ˆ<strong>HeapByteBuf</strong>ï¼‰ï¼Œå†…å­˜çš„åˆ†é…å’Œå›æ”¶é€Ÿåº¦â½è¾ƒå¿«ï¼Œå¯ä»¥è¢«JVMâ¾ƒåŠ¨å›æ”¶ï¼Œç¼ºç‚¹æ˜¯ï¼Œå¦‚æœè¿›â¾socketçš„IOè¯»å†™ï¼Œéœ€è¦é¢å¤–åšâ¼€æ¬¡å†…å­˜å¤åˆ¶ï¼Œå°†å †å†…å­˜å¯¹åº”çš„ç¼“å†²åŒºå¤åˆ¶åˆ°å†…æ ¸Channelä¸­ï¼Œæ€§èƒ½ä¼šæœ‰â¼€å®šç¨‹åº¦çš„ä¸‹é™ã€‚</p>
<p>ç”±äºåœ¨å †ä¸Šè¢« JVM ç®¡ç†ï¼Œåœ¨ä¸è¢«ä½¿â½¤æ—¶å¯ä»¥å¿«é€Ÿé‡Šæ”¾ã€‚å¯ä»¥é€šè¿‡ ByteBuf.array() æ¥è·å– byte[] æ•°æ®ã€‚</p>
</li>
<li><p>ç›´æ¥ç¼“å†²åŒºï¼ˆ<strong>DirectByteBuf</strong>ï¼‰ï¼Œâ¾®å †å†…å­˜ï¼Œå®ƒåœ¨å¯¹å¤–è¿›â¾å†…å­˜åˆ†é…ï¼Œç›¸â½å †å†…å­˜ï¼Œå®ƒçš„åˆ†é…å’Œå›æ”¶é€Ÿåº¦ä¼šæ…¢â¼€äº›ï¼Œä½†æ˜¯å°†å®ƒå†™â¼Šæˆ–ä»Socket Channelä¸­è¯»å–æ—¶ï¼Œç”±äºå‡å°‘äº†â¼€æ¬¡å†…å­˜æ‹·â»‰ï¼Œé€Ÿåº¦â½å †å†…å­˜å—ã€‚</p>
</li>
<li><p>å¤åˆç¼“å†²åŒºï¼Œé¡¾åæ€ä¹‰å°±æ˜¯å°†ä¸Šè¿°ä¸¤ç±»ç¼“å†²åŒºèšåˆåœ¨â¼€èµ·ã€‚Netty æä¾›äº†â¼€ä¸ª CompsiteByteBufï¼Œå¯ä»¥å°†å †ç¼“å†²åŒºå’Œç›´æ¥ç¼“å†²åŒºçš„æ•°æ®æ”¾åœ¨â¼€èµ·ï¼Œè®©ä½¿â½¤æ›´åŠ â½…ä¾¿ã€‚</p>
</li>
</ul>
<pre><code class="java">//é»˜è®¤ä½¿â½¤çš„æ˜¯DirectByteBufï¼Œå¦‚æœéœ€è¦ä½¿â½¤HeapByteBufæ¨¡å¼ï¼Œåˆ™éœ€è¦è¿›â¾ç³»ç»Ÿå‚æ•°çš„è®¾ç½®
System.setProperty(&quot;io.netty.noUnsafe&quot;, &quot;true&quot;); //nettyä¸­IOæ“ä½œéƒ½æ˜¯åŸºäºUnsafeå®Œ
æˆçš„
//ByteBuf çš„åˆ†é…è¦è®¾ç½®ä¸ºâ¾®æ± åŒ–ï¼Œå¦åˆ™ä¸èƒ½åˆ‡æ¢åˆ°å †ç¼“å†²å™¨æ¨¡å¼
serverBootstrap.childOption(ChannelOption.ALLOCATOR,
UnpooledByteBufAllocator.DEFAULT);</code></pre>
<h4 id="ByteBuf-çš„åˆ†é…"><a href="#ByteBuf-çš„åˆ†é…" class="headerlink" title="ByteBuf çš„åˆ†é…"></a>ByteBuf çš„åˆ†é…</h4><p>Netty æä¾›äº†ä¸¤ç§ ByteBufAllocator çš„å®ç°ï¼Œåˆ†åˆ«æ˜¯ï¼š</p>
<ul>
<li><p><strong>PooledByteBufAllocator</strong>ï¼Œå®ç°äº† ByteBuf çš„å¯¹è±¡çš„æ± åŒ–ï¼Œæâ¾¼æ€§èƒ½å‡å°‘å¹¶æœ€â¼¤é™åº¦åœ°å‡å°‘å†…å­˜ç¢â½šã€‚</p>
</li>
<li><p><strong>UnpooledByteBufAllocator</strong>ï¼Œæ²¡æœ‰å®ç°å¯¹è±¡çš„æ± åŒ–ï¼Œæ¯æ¬¡ä¼šâ½£æˆæ–°çš„å¯¹è±¡å®ä¾‹ã€‚</p>
</li>
</ul>
<pre><code class="java">//é€šè¿‡ChannelHandlerContextè·å–ByteBufAllocatorå®ä¾‹
ctx.alloc();
//é€šè¿‡channelä¹Ÿå¯ä»¥è·å–
channel.alloc();
//Nettyé»˜è®¤ä½¿â½¤äº†PooledByteBufAllocator
//å¯ä»¥åœ¨å¼•å¯¼ç±»ä¸­è®¾ç½®â¾®æ± åŒ–æ¨¡å¼
serverBootstrap.childOption(ChannelOption.ALLOCATOR,
UnpooledByteBufAllocator.DEFAULT);
//æˆ–é€šè¿‡ç³»ç»Ÿå‚æ•°è®¾ç½®
System.setProperty(&quot;io.netty.allocator.type&quot;, &quot;pooled&quot;);
System.setProperty(&quot;io.netty.allocator.type&quot;, &quot;unpooled&quot;);</code></pre>
<h4 id="ByteBuf-çš„é‡Šæ”¾"><a href="#ByteBuf-çš„é‡Šæ”¾" class="headerlink" title="ByteBuf çš„é‡Šæ”¾"></a>ByteBuf çš„é‡Šæ”¾</h4><p>ByteBufå¦‚æœé‡‡â½¤çš„æ˜¯å †ç¼“å†²åŒºæ¨¡å¼çš„è¯ï¼Œå¯ä»¥ç”±GCå›æ”¶ï¼Œä½†æ˜¯å¦‚æœé‡‡â½¤çš„æ˜¯ç›´æ¥ç¼“å†²åŒºï¼Œå°±ä¸å—GCçš„ç®¡ç†ï¼Œå°±å¾—â¼¿åŠ¨é‡Šæ”¾ï¼Œå¦åˆ™ä¼šå‘â½£å†…å­˜æ³„éœ²ã€‚</p>
<p>å…³äºByteBufçš„é‡Šæ”¾ï¼Œåˆ†ä¸ºâ¼¿åŠ¨é‡Šæ”¾ä¸â¾ƒåŠ¨é‡Šæ”¾ã€‚</p>
<h5 id="â¼¿åŠ¨é‡Šæ”¾"><a href="#â¼¿åŠ¨é‡Šæ”¾" class="headerlink" title="â¼¿åŠ¨é‡Šæ”¾"></a>â¼¿åŠ¨é‡Šæ”¾</h5><p>â¼¿åŠ¨é‡Šæ”¾ï¼Œå°±æ˜¯åœ¨ä½¿â½¤å®Œæˆåï¼Œè°ƒâ½¤ReferenceCountUtil.release(byteBuf); è¿›â¾é‡Šæ”¾ã€‚</p>
<p>é€šè¿‡releaseâ½…æ³•å‡å» byteBuf çš„ä½¿â½¤è®¡æ•°ï¼ŒNetty ä¼šâ¾ƒåŠ¨å›æ”¶ byteBuf ã€‚</p>
<p>ç¤ºä¾‹ï¼š</p>
<pre><code class="java">    /**
     * è·å–å®¢æˆ·ç«¯å‘æ¥çš„æ•°æ®
     *
     * @param ctx
     * @param msg
     * @throws Exception
     */
    @Override
    public void channelRead(ChannelHandlerContext ctx, Object msg) throws
            Exception {
        ByteBuf byteBuf = (ByteBuf) msg;
        String msgStr = byteBuf.toString(CharsetUtil.UTF_8);
        System.out.println(&quot;å®¢æˆ·ç«¯å‘æ¥æ•°æ®ï¼š&quot; + msgStr);
        //é‡Šæ”¾èµ„æº
        ReferenceCountUtil.release(byteBuf);
    }</code></pre>
<p>â¼¿åŠ¨é‡Šæ”¾å¯ä»¥è¾¾åˆ°â½¬çš„ï¼Œä½†æ˜¯è¿™ç§â½…å¼ä¼šâ½è¾ƒç¹çï¼Œå¦‚æœâ¼€æ—¦å¿˜è®°é‡Šæ”¾å°±å¯èƒ½ä¼šé€ æˆå†…å­˜æ³„éœ²ã€‚</p>
<h5 id="â¾ƒåŠ¨é‡Šæ”¾"><a href="#â¾ƒåŠ¨é‡Šæ”¾" class="headerlink" title="â¾ƒåŠ¨é‡Šæ”¾"></a>â¾ƒåŠ¨é‡Šæ”¾</h5><p>â¾ƒåŠ¨é‡Šæ”¾æœ‰ä¸‰ç§â½…å¼ï¼Œåˆ†åˆ«æ˜¯ï¼šâ¼Šç«™çš„TailHandlerã€ç»§æ‰¿SimpleChannelInboundHandlerã€HeadHandlerçš„å‡ºç«™é‡Šæ”¾ã€‚</p>
<p><strong>TailHandler</strong></p>
<p>Nettyçš„ChannelPiplelineçš„æµâ½”çº¿çš„æœ«ç«¯æ˜¯TailHandlerï¼Œé»˜è®¤æƒ…å†µä¸‹å¦‚æœæ¯ä¸ªâ¼Šç«™å¤„ç†å™¨Handleréƒ½æŠŠæ¶ˆæ¯å¾€ä¸‹ä¼ ï¼ŒTailHandlerä¼šé‡Šæ”¾æ‰ReferenceCountedç±»å‹çš„æ¶ˆæ¯ã€‚</p>
<pre><code class="java">    /**
     * è·å–å®¢æˆ·ç«¯å‘æ¥çš„æ•°æ®
     *
     * @param ctx
     * @param msg
     * @throws Exception
     */
    @Override
    public void channelRead(ChannelHandlerContext ctx, Object msg) throws
            Exception {
        ByteBuf byteBuf = (ByteBuf) msg;
        String msgStr = byteBuf.toString(CharsetUtil.UTF_8);
        System.out.println(&quot;å®¢æˆ·ç«¯å‘æ¥æ•°æ®ï¼š&quot; + msgStr);
        //å‘å®¢æˆ·ç«¯å‘é€æ•°æ®
        ctx.writeAndFlush(Unpooled.copiedBuffer(&quot;ok&quot;, CharsetUtil.UTF_8));
        ctx.fireChannelRead(msg); //å°†ByteBufå‘ä¸‹ä¼ é€’
    }</code></pre>
<p>åœ¨DefaultChannelPipelineä¸­çš„TailContextå†…éƒ¨ç±»ä¼šåœ¨æœ€åæ‰§â¾ï¼š</p>
<pre><code class="java">    @Override
    public void channelRead(ChannelHandlerContext ctx, Object msg) {
        onUnhandledInboundMessage(ctx, msg);
    }

    //æœ€åä¼šæ‰§â¾
    protected void onUnhandledInboundMessage(Object msg) {
        try {
            logger.debug(
                    &quot;Discarded inbound message {} that reached at the tail of the
                    pipeline.&quot; +
                    &quot;Please check your pipeline configuration.&quot;, msg);
        } finally {
            ReferenceCountUtil.release(msg); //é‡Šæ”¾èµ„æº
        }
    }</code></pre>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæ²¡æœ‰è¿›â¾å‘ä¸‹ä¼ é€’ï¼Œé‚£ä¹ˆåœ¨TailHandlerä¸­æ˜¯ä¸ä¼šè¿›â¾é‡Šæ”¾æ“ä½œçš„ã€‚</p>
<p><strong>SimpleChannelInboundHandler</strong></p>
<p>å½“ChannelHandlerç»§æ‰¿äº†SimpleChannelInboundHandleråï¼Œåœ¨SimpleChannelInboundHandlerçš„channelRead()â½…æ³•ä¸­ï¼Œå°†ä¼šè¿›â¾èµ„æºçš„é‡Šæ”¾ï¼Œæˆ‘ä»¬çš„ä¸šåŠ¡ä»£ç ä¹Ÿéœ€è¦å†™â¼Šåˆ°channelRead0()ä¸­ã€‚</p>
<pre><code class="java">    //SimpleChannelInboundHandlerä¸­çš„channelRead()
    @Override
    public void channelRead(ChannelHandlerContext ctx, Object msg) throws
            Exception {
        boolean release = true;
        try {
            if (acceptInboundMessage(msg)) {
                @SuppressWarnings(&quot;unchecked&quot;) I imsg = (I) msg;
                channelRead0(ctx, imsg);
            } else {
                release = false;
                ctx.fireChannelRead(msg);
            }
        } finally {
            if (autoRelease &amp;&amp; release) {
                ReferenceCountUtil.release(msg); //åœ¨è¿™â¾¥é‡Šæ”¾
            }
        }
    }</code></pre>
<p>ä½¿ç”¨</p>
<pre><code class="java">package cn.itcast.myrpc.client.handler;

import io.netty.buffer.ByteBuf;
import io.netty.buffer.Unpooled;
import io.netty.channel.ChannelHandlerContext;
import io.netty.channel.SimpleChannelInboundHandler;
import io.netty.util.CharsetUtil;

public class MyClientHandler extends SimpleChannelInboundHandler&lt;ByteBuf&gt; {
    @Override
    protected void channelRead0(ChannelHandlerContext ctx, ByteBuf msg) throws
            Exception {
        System.out.println(&quot;æ¥æ”¶åˆ°æœåŠ¡ç«¯çš„æ¶ˆæ¯ï¼š&quot; +
                msg.toString(CharsetUtil.UTF_8));
    }

    @Override
    public void channelActive(ChannelHandlerContext ctx) throws Exception {
        // å‘æœåŠ¡ç«¯å‘é€æ•°æ®
        String msg = &quot;hello&quot;;
        ctx.writeAndFlush(Unpooled.copiedBuffer(msg, CharsetUtil.UTF_8));
    }

    @Override
    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause)
            throws Exception {
        cause.printStackTrace();
        ctx.close();
    }
}</code></pre>
<p><strong>HeadHandler</strong></p>
<p>å‡ºç«™å¤„ç†æµç¨‹ä¸­ï¼Œç”³è¯·åˆ†é…åˆ°çš„ ByteBufï¼Œé€šè¿‡ HeadHandler å®Œæˆâ¾ƒåŠ¨é‡Šæ”¾ã€‚</p>
<p>å‡ºç«™å¤„ç†â½¤åˆ°çš„ Bytebuf ç¼“å†²åŒºï¼Œâ¼€èˆ¬æ˜¯è¦å‘é€çš„æ¶ˆæ¯ï¼Œé€šå¸¸ç”±åº”â½¤æ‰€ç”³è¯·ã€‚åœ¨å‡ºç«™æµç¨‹å¼€å§‹çš„æ—¶å€™ï¼Œé€šè¿‡è°ƒâ½¤ ctx.writeAndFlush(msg)ï¼ŒBytebuf ç¼“å†²åŒºå¼€å§‹è¿›â¼Šå‡ºç«™å¤„ç†çš„ pipeline æµâ½”çº¿ ã€‚</p>
<p>åœ¨æ¯â¼€ä¸ªå‡ºç«™Handlerä¸­çš„å¤„ç†å®Œæˆåï¼Œæœ€åæ¶ˆæ¯ä¼šæ¥åˆ°å‡ºç«™çš„æœ€åâ¼€æ£’ HeadHandlerï¼Œå†ç»è¿‡â¼€è½®å¤æ‚çš„è°ƒâ½¤ï¼Œåœ¨flushå®Œæˆåç»ˆå°†è¢«releaseæ‰ã€‚</p>
<p>ç¤ºä¾‹ï¼š</p>
<pre><code class="java">package cn.itcast.myrpc.client.handler;

import io.netty.buffer.ByteBuf;
import io.netty.buffer.Unpooled;
import io.netty.channel.ChannelHandlerContext;
import io.netty.channel.SimpleChannelInboundHandler;
import io.netty.util.CharsetUtil;

public class MyClientHandler extends SimpleChannelInboundHandler&lt;ByteBuf&gt; {
    @Override
    protected void channelRead0(ChannelHandlerContext ctx, ByteBuf msg) throws
            Exception {
        System.out.println(&quot;æ¥æ”¶åˆ°æœåŠ¡ç«¯çš„æ¶ˆæ¯ï¼š&quot; +
                msg.toString(CharsetUtil.UTF_8));
    }

    @Override
    public void channelActive(ChannelHandlerContext ctx) throws Exception {
        // å‘æœåŠ¡ç«¯å‘é€æ•°æ®
        String msg = &quot;hello&quot;;
        ctx.writeAndFlush(Unpooled.copiedBuffer(msg, CharsetUtil.UTF_8));
    }

    @Override
    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause)
            throws Exception {
        cause.printStackTrace();
        ctx.close();
    }
}</code></pre>
<p>æ‰§â¾â½…æ³•è°ƒâ½¤é“¾ï¼š</p>
<img src="/blog/2020/08/07/netty-Netty%E8%A7%A3%E6%9E%90/pic15.png" srcset="/blog/img/loading.gif" class>

<h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><ul>
<li><p>â¼Šç«™å¤„ç†æµç¨‹ä¸­ï¼Œå¦‚æœå¯¹åŸæ¶ˆæ¯ä¸åšå¤„ç†ï¼Œè°ƒâ½¤ ctx.fireChannelRead(msg) æŠŠåŸæ¶ˆæ¯å¾€ä¸‹ä¼ ï¼Œç”±æµâ½”çº¿æœ€åâ¼€æ£’ TailHandler å®Œæˆâ¾ƒåŠ¨é‡Šæ”¾ã€‚</p>
</li>
<li><p>å¦‚æœæˆªæ–­äº†â¼Šç«™å¤„ç†æµâ½”çº¿ï¼Œåˆ™å¯ä»¥ç»§æ‰¿ SimpleChannelInboundHandler ï¼Œå®Œæˆâ¼Šç«™ByteBuf â¾ƒåŠ¨é‡Šæ”¾ã€‚</p>
</li>
<li><p>å‡ºç«™å¤„ç†è¿‡ç¨‹ä¸­ï¼Œç”³è¯·åˆ†é…åˆ°çš„ ByteBufï¼Œé€šè¿‡ HeadHandler å®Œæˆâ¾ƒåŠ¨é‡Šæ”¾ã€‚</p>
</li>
<li><p>â¼Šç«™å¤„ç†ä¸­ï¼Œå¦‚æœå°†åŸæ¶ˆæ¯è½¬åŒ–ä¸ºæ–°çš„æ¶ˆæ¯å¹¶è°ƒâ½¤ ctx.fireChannelRead(newMsg)å¾€ä¸‹ä¼ ï¼Œé‚£å¿…é¡»æŠŠåŸæ¶ˆæ¯releaseæ‰;</p>
</li>
<li><p>â¼Šç«™å¤„ç†ä¸­ï¼Œå¦‚æœå·²ç»ä¸å†è°ƒâ½¤ ctx.fireChannelRead(msg) ä¼ é€’ä»»ä½•æ¶ˆæ¯ï¼Œä¹Ÿæ²¡æœ‰ç»§æ‰¿SimpleChannelInboundHandler å®Œæˆâ¾ƒåŠ¨é‡Šæ”¾ï¼Œé‚£æ›´è¦æŠŠåŸæ¶ˆæ¯releaseæ‰;</p>
</li>
</ul>

            </div>
            <hr>
            <div>
              <p>
                
                  <span>
                <i class="iconfont icon-inbox"></i>
                    
                      <a class="hover-with-bg" href="/blog/categories/Netty/">Netty</a>
                      &nbsp;
                    
                  </span>&nbsp;&nbsp;
                
                
                  <span>
                <i class="iconfont icon-tag"></i>
                    
                      <a class="hover-with-bg" href="/blog/tags/netty/">netty</a>
                    
                  </span>
                
              </p>
              
                <p class="note note-warning">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://zh.wikipedia.org/wiki/Wikipedia:CC_BY-SA_3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC" target="_blank" rel="nofollow noopener noopener">CC BY-SA 3.0åè®®</a> ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</p>
              
              
                <div class="post-prevnext row">
                  <div class="post-prev col-6">
                    
                    
                      <a href="/blog/2020/08/09/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/">
                        <i class="fa fa-chevron-left"></i>
                        <span class="hidden-mobile">ç½‘ç»œç¼–ç¨‹</span>
                        <span class="visible-mobile">ä¸Šä¸€ç¯‡</span>
                      </a>
                    
                  </div>
                  <div class="post-next col-6">
                    
                    
                      <a href="/blog/2020/08/07/netty-Netty%E5%85%A5%E9%97%A8/">
                        <span class="hidden-mobile">Nettyå…¥é—¨</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="fa fa-chevron-right"></i>
                      </a>
                    
                  </div>
                </div>
              
            </div>

              
                <!-- Comments -->
                <div class="comments" id="comments">
                  
                  

                </div>
              
          </div>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc-start"></div>
<div id="toc">
  <p class="h5"><i class="far fa-list-alt"></i>&nbsp;ç›®å½•</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a class="z-depth-1" id="scroll-top-button" href="#" role="button">
      <i class="fa fa-chevron-up scroll-top-arrow" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><b>Hexo</b></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"> <b>Fluid</b></a>
    </div>
    
  <div>
    
      <!-- ä¸è’œå­ç»Ÿè®¡PV -->
      
      <span id="busuanzi_container_site_pv" style="display: none">
      æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv"></span> æ¬¡
    </span>
    
    
      <!-- ä¸è’œå­ç»Ÿè®¡UV -->
      
      <span id="busuanzi_container_site_uv" style="display: none">
      æ€»è®¿å®¢æ•° <span id="busuanzi_value_site_uv"></span> äºº
    </span>
    
  </div>


    

    
  </div>
</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/popper.js/1.16.1/umd/popper.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="https://cdn.staticfile.org/mdbootstrap/4.13.0/js/mdb.min.js" ></script>
<script  src="/blog/js/main.js" ></script>


  <script  src="/blog/js/lazyload.js" ></script>



  
  <script  src="https://cdn.staticfile.org/tocbot/4.10.0/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var navHeight = $('#navbar').height();
      var toc = $('#toc');
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;
      var tocLimMax = 2 * boardTop + boardCtn.height();

      $(window).scroll(function () {
        var tocLimMin = $('#toc-start').offset().top - navHeight;
        var scroH = document.body.scrollTop + document.documentElement.scrollTop;

        if (tocLimMin <= scroH && scroH <= tocLimMax) {
          toc.css({
            'display': 'block',
            'position': 'fixed',
            'top': navHeight,
          });
        } else if (scroH <= tocLimMin) {
          toc.css({
            'position': '',
            'top': '',
          });
        } else if (scroH > tocLimMax) {
          toc.css('display', 'none');
        }
      });
      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: '.post-content',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc > p').css('visibility', 'visible');
      }
      var offset = boardCtn.css('margin-right')
      $('#toc-ctn').css({
        'right': offset
      })
    });
  </script>





  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/blog/js/clipboard-use.js" ></script>



  <script defer src="https://cdn.staticfile.org/smoothscroll/1.4.10/SmoothScroll.min.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




<!-- Plugins -->


  

  

  

  

  

  



  <script  src="https://cdn.staticfile.org/prettify/188.0.0/prettify.min.js" ></script>
  <script>
    $(document).ready(function () {
      $('pre').addClass('prettyprint  linenums');
      prettyPrint();
    })
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "Nettyè§£æ&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/blog/js/local-search.js" ></script>
  <script>
    var path = "/blog/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      getSearchFile(path);
      this.onclick = null
    }
  </script>



  <script defer src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <script>
    $("#post img:not(.no-zoom img, img[no-zoom])").each(
      function () {
        var element = document.createElement("a");
        $(element).attr("data-fancybox", "images");
        $(element).attr("href", $(this).attr("src"));
        $(this).wrap(element);
      }
    );
  </script>





  
  
    <script type="text/javascript">
      //å®šä¹‰è·å–è¯è¯­ä¸‹æ ‡
      var a_idx = 0;
      jQuery(document).ready(function ($) {
        //ç‚¹å‡»bodyæ—¶è§¦å‘äº‹ä»¶
        $("body").click(function (e) {
          //éœ€è¦æ˜¾ç¤ºçš„è¯è¯­
          var a = new Array("å¯Œå¼º", "æ°‘ä¸»", "æ–‡æ˜", "å’Œè°", "è‡ªç”±", "å¹³ç­‰", "å…¬æ­£", "æ³•æ²»", "çˆ±å›½", "æ•¬ä¸š", "è¯šä¿¡", "å‹å–„");
          //è®¾ç½®è¯è¯­ç»™spanæ ‡ç­¾
          var $i = $("<span/>").text(a[a_idx]);
          //ä¸‹æ ‡ç­‰äºåŸæ¥ä¸‹æ ‡+1  ä½™ è¯è¯­æ€»æ•°
          a_idx = (a_idx + 1) % a.length;
          //è·å–é¼ æ ‡æŒ‡é’ˆçš„ä½ç½®ï¼Œåˆ†åˆ«ç›¸å¯¹äºæ–‡æ¡£çš„å·¦å’Œå³è¾¹ç¼˜ã€‚
          //è·å–xå’Œyçš„æŒ‡é’ˆåæ ‡
          var x = e.pageX, y = e.pageY;
          //åœ¨é¼ æ ‡çš„æŒ‡é’ˆçš„ä½ç½®ç»™$iå®šä¹‰çš„spanæ ‡ç­¾æ·»åŠ cssæ ·å¼
          $i.css({
            "z-index": 999,
            "top": y - 20,
            "left": x,
            "position": "absolute",
            "font-weight": "bold",
            "color": rand_color()
          });
          // éšæœºé¢œè‰²
          function rand_color() {
            return "rgb(" + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + ")"
          }
          //åœ¨bodyæ·»åŠ è¿™ä¸ªæ ‡ç­¾
          $("body").append($i);
          //animate() æ–¹æ³•æ‰§è¡Œ CSS å±æ€§é›†çš„è‡ªå®šä¹‰åŠ¨ç”»ã€‚
          //è¯¥æ–¹æ³•é€šè¿‡CSSæ ·å¼å°†å…ƒç´ ä»ä¸€ä¸ªçŠ¶æ€æ”¹å˜ä¸ºå¦ä¸€ä¸ªçŠ¶æ€ã€‚CSSå±æ€§å€¼æ˜¯é€æ¸æ”¹å˜çš„ï¼Œè¿™æ ·å°±å¯ä»¥åˆ›å»ºåŠ¨ç”»æ•ˆæœã€‚
          //è¯¦æƒ…è¯·çœ‹http://www.w3school.com.cn/jquery/effect_animate.asp
          $i.animate({
            //å°†åŸæ¥çš„ä½ç½®å‘ä¸Šç§»åŠ¨180
            "top": y - 180,
            "opacity": 0
            //1500åŠ¨ç”»çš„é€Ÿåº¦
          }, 1500, function () {
            //æ—¶é—´åˆ°äº†è‡ªåŠ¨åˆ é™¤
            $i.remove();
          });
        });
      })
      ;
    </script>
  








</body>
</html>
