

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/blog/img/favicon.png">
  <link rel="icon" type="image/png" href="/blog/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="">
  <meta name="keywords" content="">
  <title>Istioå…¥é—¨ - ğŸğŸŠ&#39;s blog</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.5.3/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/blog/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.1.2/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />
  



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/blog/css/main.css" />

<!-- è‡ªå®šä¹‰æ ·å¼ä¿æŒåœ¨æœ€åº•éƒ¨ -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"zhaoguocheng.gitee.io","root":"/blog/","version":"1.8.5","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"copy_btn":true,"image_zoom":{"enable":true},"lazyload":{"enable":true,"onlypost":false},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/blog/js/utils.js" ></script>
  <script  src="/blog/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.2.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/blog/">&nbsp;<strong>Fluid</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/">
                <i class="iconfont icon-home-fill"></i>
                ä¸»é¡µ
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/archives/">
                <i class="iconfont icon-archive-fill"></i>
                å½’æ¡£
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/categories/">
                <i class="iconfont icon-category-fill"></i>
                åˆ†ç±»
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/tags/">
                <i class="iconfont icon-tags-fill"></i>
                æ ‡ç­¾
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/about/">
                <i class="iconfont icon-user-fill"></i>
                å…³äº
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax=true
         style="background: url('/blog/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="Istioå…¥é—¨">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2020-10-01 17:19" pubdate>
        2020å¹´10æœˆ1æ—¥ ä¸‹åˆ
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      3.6k å­—
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      47
       åˆ†é’Ÿ
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Istioå…¥é—¨</h1>
            
            <div class="markdown-body">
              <h3 id="Istioç®€ä»‹"><a href="#Istioç®€ä»‹" class="headerlink" title="Istioç®€ä»‹"></a>Istioç®€ä»‹</h3><h4 id="istioæ¶æ„"><a href="#istioæ¶æ„" class="headerlink" title="istioæ¶æ„"></a>istioæ¶æ„</h4><img src="/blog/2020/10/01/ServiceMesh-Istio%E5%85%A5%E9%97%A8/pic1.png" srcset="/blog/img/loading.gif" class>

<p>å®é™…ä¸ŠIstio å°±æ˜¯ Service Mesh æ¶æ„çš„â¼€ç§å®ç°ï¼ŒæœåŠ¡ä¹‹é—´çš„é€šä¿¡ï¼ˆâ½å¦‚è¿™â¾¥çš„ Service A è®¿é—® Service Bï¼‰ä¼šé€šè¿‡ä»£ç†ï¼ˆé»˜è®¤æ˜¯ Envoyï¼‰æ¥è¿›â¾ã€‚</p>
<p>â½½ä¸”ä¸­é—´çš„â½¹ç»œåè®®â½€æŒ HTTP/1.1ï¼ŒHTTP/2ï¼ŒgRPC æˆ–è€… TCPï¼Œå¯ä»¥è¯´è¦†ç›–äº†ä¸»æµçš„é€šä¿¡åè®®ã€‚ä»£ç†è¿™â¼€å±‚ï¼Œç§°ä¹‹ä¸ºæ•°æ®å¹³â¾¯ã€‚</p>
<p>æ§åˆ¶å¹³â¾¯åšäº†è¿›â¼€æ­¥çš„ç»†åˆ†ï¼Œåˆ†æˆäº† Pilotã€Citadel å’Œ Galleyï¼Œå®ƒä»¬çš„å„â¾ƒåŠŸèƒ½å¦‚ä¸‹ï¼š</p>
<ul>
<li><p>Pilotï¼šä¸º Envoy æä¾›äº†æœåŠ¡å‘ç°ï¼Œæµé‡ç®¡ç†å’Œæ™ºèƒ½è·¯ç”±ï¼ˆAB æµ‹è¯•ã€â¾¦ä¸é›€å‘å¸ƒç­‰ï¼‰ï¼Œä»¥åŠé”™è¯¯å¤„ç†ï¼ˆè¶…æ—¶ã€é‡è¯•ã€ç†”æ–­ï¼‰åŠŸèƒ½ã€‚</p>
</li>
<li><p>Citadelï¼šä¸ºæœåŠ¡ä¹‹é—´æä¾›è®¤è¯å’Œè¯ä¹¦ç®¡ç†ï¼Œå¯ä»¥è®©æœåŠ¡â¾ƒåŠ¨å‡çº§æˆ TLS åè®®ã€‚</p>
</li>
<li><p>Galleyï¼šGalley æ˜¯ Istio çš„é…ç½®éªŒè¯ã€æå–ã€å¤„ç†å’Œåˆ†å‘ç»„ä»¶ã€‚å®ƒè´Ÿè´£å°†å…¶ä½™çš„ Istio ç»„ä»¶ä¸ä»åº•å±‚å¹³å°ï¼ˆä¾‹å¦‚ Kubernetesï¼‰è·å–â½¤æˆ·é…ç½®çš„ç»†èŠ‚éš”ç¦»å¼€æ¥ã€‚</p>
</li>
</ul>
<p>æ•°æ®å¹³â¾¯ä¼šå’Œæ§åˆ¶å¹³â¾¯é€šä¿¡ï¼Œâ¼€â½…â¾¯å¯ä»¥è·å–éœ€è¦çš„æœåŠ¡ä¹‹é—´çš„ä¿¡æ¯ï¼Œå¦â¼€â½…â¾¯ä¹Ÿå¯ä»¥æ±‡æŠ¥æœåŠ¡è°ƒâ½¤çš„Metrics æ•°æ®ã€‚</p>
<h4 id="istio"><a href="#istio" class="headerlink" title="istio"></a>istio</h4><p>é€šè¿‡è´Ÿè½½å‡è¡¡ã€æœåŠ¡é—´çš„èº«ä»½éªŒè¯ã€ç›‘æ§ç­‰â½…æ³•ï¼ŒIstio å¯ä»¥è½»æ¾åœ°åˆ›å»ºâ¼€ä¸ªå·²ç»éƒ¨ç½²äº†æœåŠ¡çš„â½¹ç»œï¼Œâ½½æœåŠ¡çš„ä»£ç åªéœ€å¾ˆå°‘æ›´æ”¹ç”šâ¾„â½†éœ€æ›´æ”¹ã€‚é€šè¿‡åœ¨æ•´ä¸ªç¯å¢ƒä¸­éƒ¨ç½²â¼€ä¸ªç‰¹æ®Šçš„ sidecar ä»£ç†ä¸ºæœåŠ¡æ·»åŠ Istio çš„â½€æŒï¼Œâ½½ä»£ç†ä¼šæ‹¦æˆªå¾®æœåŠ¡ä¹‹é—´çš„æ‰€æœ‰â½¹ç»œé€šä¿¡ï¼Œç„¶åä½¿â½¤å…¶æ§åˆ¶å¹³â¾¯çš„åŠŸèƒ½æ¥é…ç½®å’Œç®¡ç†Istioï¼Œè¿™åŒ…æ‹¬ï¼š</p>
<ul>
<li><p>ä¸º HTTPã€gRPCã€WebSocket å’Œ TCP æµé‡â¾ƒåŠ¨è´Ÿè½½å‡è¡¡ã€‚</p>
</li>
<li><p>é€šè¿‡ä¸°å¯Œçš„è·¯ç”±è§„åˆ™ã€é‡è¯•ã€æ•…éšœè½¬ç§»å’Œæ•…éšœæ³¨â¼Šå¯¹æµé‡â¾ä¸ºè¿›â¾ç»†ç²’åº¦æ§åˆ¶ã€‚</p>
</li>
<li><p>å¯æ’æ‹”çš„ç­–ç•¥å±‚å’Œé…ç½® APIï¼Œâ½€æŒè®¿é—®æ§åˆ¶ã€é€Ÿç‡é™åˆ¶å’Œé…é¢ã€‚</p>
</li>
<li><p>é›†ç¾¤å†…ï¼ˆåŒ…æ‹¬é›†ç¾¤çš„â¼Šâ¼å’Œå‡ºâ¼ï¼‰æ‰€æœ‰æµé‡çš„â¾ƒåŠ¨åŒ–åº¦é‡ã€â½‡å¿—è®°å½•å’Œè¿½è¸ªã€‚</p>
</li>
<li><p>åœ¨å…·æœ‰å¼ºâ¼¤çš„åŸºäºèº«ä»½éªŒè¯å’Œæˆæƒçš„é›†ç¾¤ä¸­å®ç°å®‰å…¨çš„æœåŠ¡é—´é€šä¿¡ã€‚</p>
</li>
</ul>
<p>Istio ä¸ºå¯æ‰©å±•æ€§â½½è®¾è®¡ï¼Œå¯ä»¥æ»¡â¾œä¸åŒçš„éƒ¨ç½²éœ€æ±‚ã€‚</p>
<h4 id="æ ¸â¼¼ç‰¹æ€§"><a href="#æ ¸â¼¼ç‰¹æ€§" class="headerlink" title="æ ¸â¼¼ç‰¹æ€§"></a>æ ¸â¼¼ç‰¹æ€§</h4><p>Istio ä»¥ç»Ÿâ¼€çš„â½…å¼æä¾›äº†è®¸å¤šè·¨æœåŠ¡â½¹ç»œçš„å…³é”®åŠŸèƒ½ã€‚</p>
<h5 id="æµé‡ç®¡ç†"><a href="#æµé‡ç®¡ç†" class="headerlink" title="æµé‡ç®¡ç†"></a>æµé‡ç®¡ç†</h5><p>Istio ç®€å•çš„è§„åˆ™é…ç½®å’Œæµé‡è·¯ç”±å…è®¸æ‚¨æ§åˆ¶æœåŠ¡ä¹‹é—´çš„æµé‡å’Œ API è°ƒâ½¤è¿‡ç¨‹ã€‚</p>
<p>Istio ç®€åŒ–äº†æœåŠ¡çº§å±æ€§ï¼ˆå¦‚ç†”æ–­å™¨ã€è¶…æ—¶å’Œé‡è¯•ï¼‰çš„é…ç½®ï¼Œå¹¶ä¸”è®©å®ƒè½»â½½æ˜“ä¸¾çš„æ‰§â¾é‡è¦çš„ä»»åŠ¡ï¼ˆå¦‚A/B æµ‹è¯•ã€â¾¦ä¸é›€å‘å¸ƒå’ŒæŒ‰æµé‡ç™¾åˆ†â½åˆ’åˆ†çš„åˆ†é˜¶æ®µå‘å¸ƒï¼‰ã€‚</p>
<p>æœ‰äº†æ›´å¥½çš„å¯¹æµé‡çš„å¯è§†æ€§å’Œå¼€ç®±å³â½¤çš„æ•…éšœæ¢å¤ç‰¹æ€§ï¼Œå°±å¯ä»¥åœ¨é—®é¢˜äº§â½£ä¹‹å‰æ•è·å®ƒä»¬ï¼Œâ½†è®ºâ¾¯å¯¹ä»€ä¹ˆæƒ…å†µéƒ½å¯ä»¥ä½¿è°ƒâ½¤æ›´å¯é ï¼Œâ½¹ç»œæ›´å¥å£®ã€‚</p>
<h5 id="å®‰å…¨"><a href="#å®‰å…¨" class="headerlink" title="å®‰å…¨"></a>å®‰å…¨</h5><p>Istio çš„å®‰å…¨ç‰¹æ€§è§£æ”¾äº†å¼€å‘â¼ˆå‘˜ï¼Œä½¿å…¶åªéœ€è¦ä¸“æ³¨äºåº”â½¤ç¨‹åºçº§åˆ«çš„å®‰å…¨ã€‚</p>
<p>Istio æä¾›äº†åº•å±‚çš„å®‰å…¨é€šä¿¡é€šé“ï¼Œå¹¶ä¸ºâ¼¤è§„æ¨¡çš„æœåŠ¡é€šä¿¡ç®¡ç†è®¤è¯ã€æˆæƒå’ŒåŠ å¯†ã€‚æœ‰äº† Istioï¼ŒæœåŠ¡é€šä¿¡åœ¨é»˜è®¤æƒ…å†µä¸‹å°±æ˜¯å—ä¿æŠ¤çš„ï¼Œå¯ä»¥è®©æ‚¨åœ¨è·¨ä¸åŒåè®®å’Œè¿â¾æ—¶çš„æƒ…å†µä¸‹å®æ–½â¼€è‡´çš„ç­–ç•¥â€”â€”â½½æ‰€æœ‰è¿™äº›éƒ½åªéœ€è¦å¾ˆå°‘ç”šâ¾„ä¸éœ€è¦ä¿®æ”¹åº”â½¤ç¨‹åºã€‚</p>
<p>Istio æ˜¯ç‹¬â½´äºå¹³å°çš„ï¼Œå¯ä»¥ä¸ Kubernetesï¼ˆæˆ–åŸºç¡€è®¾æ–½ï¼‰çš„â½¹ç»œç­–ç•¥â¼€èµ·ä½¿â½¤ã€‚ä½†å®ƒæ›´å¼ºâ¼¤ï¼Œèƒ½å¤Ÿåœ¨â½¹ç»œå’Œåº”â½¤å±‚â¾¯ä¿æŠ¤podåˆ° pod æˆ–è€…æœåŠ¡åˆ°æœåŠ¡ä¹‹é—´çš„é€šä¿¡ã€‚</p>
<h5 id="å¯è§‚å¯Ÿæ€§"><a href="#å¯è§‚å¯Ÿæ€§" class="headerlink" title="å¯è§‚å¯Ÿæ€§"></a>å¯è§‚å¯Ÿæ€§</h5><p>Istio å¥å£®çš„è¿½è¸ªã€ç›‘æ§å’Œâ½‡å¿—ç‰¹æ€§è®©æ‚¨èƒ½å¤Ÿæ·±â¼Šçš„äº†è§£æœåŠ¡â½¹æ ¼éƒ¨ç½²ã€‚</p>
<p>é€šè¿‡ Istio çš„ç›‘æ§èƒ½â¼’ï¼Œå¯ä»¥çœŸæ­£çš„äº†è§£åˆ°æœåŠ¡çš„æ€§èƒ½æ˜¯å¦‚ä½•å½±å“ä¸Šæ¸¸å’Œä¸‹æ¸¸çš„ï¼›â½½å®ƒçš„å®šåˆ¶Dashboard æä¾›äº†å¯¹æ‰€æœ‰æœåŠ¡æ€§èƒ½çš„å¯è§†åŒ–èƒ½â¼’ï¼Œå¹¶è®©æ‚¨çœ‹åˆ°å®ƒå¦‚ä½•å½±å“å…¶ä»–è¿›ç¨‹ã€‚</p>
<p>Istio çš„ Mixer ç»„ä»¶è´Ÿè´£ç­–ç•¥æ§åˆ¶å’Œé¥æµ‹æ•°æ®æ”¶é›†ã€‚å®ƒæä¾›äº†åç«¯æŠ½è±¡å’Œä¸­ä»‹ï¼Œå°†â¼€éƒ¨åˆ† Istio ä¸åç«¯çš„åŸºç¡€è®¾æ–½å®ç°ç»†èŠ‚éš”ç¦»å¼€æ¥ï¼Œå¹¶ä¸ºè¿ç»´â¼ˆå‘˜æä¾›äº†å¯¹â½¹æ ¼ä¸åç«¯åŸºç¡€å®æ–½ä¹‹é—´äº¤äº’çš„ç»†ç²’åº¦æ§åˆ¶ã€‚</p>
<p>æ‰€æœ‰è¿™äº›ç‰¹æ€§éƒ½ä½¿æ‚¨èƒ½å¤Ÿæ›´æœ‰æ•ˆåœ°è®¾ç½®ã€ç›‘æ§å’ŒåŠ å¼ºæœåŠ¡çš„ SLOã€‚å½“ç„¶ï¼Œåº•çº¿æ˜¯æ‚¨å¯ä»¥å¿«é€Ÿæœ‰æ•ˆåœ°æ£€æµ‹åˆ°å¹¶ä¿®å¤å‡ºç°çš„é—®é¢˜ã€‚</p>
<h4 id="å¹³å°â½€æŒ"><a href="#å¹³å°â½€æŒ" class="headerlink" title="å¹³å°â½€æŒ"></a>å¹³å°â½€æŒ</h4><p>Istio ç‹¬â½´äºå¹³å°ï¼Œè¢«è®¾è®¡ä¸ºå¯ä»¥åœ¨å„ç§ç¯å¢ƒä¸­è¿â¾ï¼ŒåŒ…æ‹¬è·¨äº‘ã€å†…éƒ¨ç¯å¢ƒã€Kubernetesã€Mesos ç­‰ã€‚æ‚¨å¯ä»¥åœ¨ Kubernetes æˆ–æ˜¯è£…æœ‰ Consul çš„ Nomad ç¯å¢ƒä¸Šéƒ¨ç½² Istioã€‚Istio â½¬å‰â½€æŒï¼š</p>
<ul>
<li><p>Kubernetes ä¸Šçš„æœåŠ¡éƒ¨ç½²</p>
</li>
<li><p>åŸºäº Consul çš„æœåŠ¡æ³¨å†Œ</p>
</li>
<li><p>æœåŠ¡è¿â¾åœ¨ç‹¬â½´çš„è™šæ‹Ÿæœºä¸Š</p>
</li>
</ul>
<h3 id="Istioå¿«é€Ÿâ¼Šâ»”"><a href="#Istioå¿«é€Ÿâ¼Šâ»”" class="headerlink" title="Istioå¿«é€Ÿâ¼Šâ»”"></a>Istioå¿«é€Ÿâ¼Šâ»”</h3><p>å°†Istioè¿›â¾éƒ¨ç½²å®‰è£…ï¼Œæ¥ä½“éªŒä¸‹å®ƒçš„é­…â¼’ã€‚</p>
<h4 id="ä¸‹è½½-Istio"><a href="#ä¸‹è½½-Istio" class="headerlink" title="ä¸‹è½½ Istio"></a>ä¸‹è½½ Istio</h4><p>ä¸‹è½½ Istioï¼Œä¸‹è½½å†…å®¹å°†åŒ…å«ï¼šå®‰è£…â½‚ä»¶ã€ç¤ºä¾‹å’Œ istioctl å‘½ä»¤â¾â¼¯å…·ã€‚</p>
<p>è®¿é—® Istio release â»šâ¾¯ä¸‹è½½ä¸æ‚¨æ“ä½œç³»ç»Ÿå¯¹åº”çš„å®‰è£…â½‚ä»¶ã€‚åœ¨ macOS æˆ– Linux ç³»ç»Ÿä¸­ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤ä¸‹è½½æœ€æ–°ç‰ˆæœ¬çš„ Istioï¼š</p>
<pre><code class="hljs sh">$ curl -L https://istio.io/downloadIstio | sh -</code></pre>

<p>åˆ‡æ¢åˆ° Istio åŒ…æ‰€åœ¨â½¬å½•ä¸‹ã€‚ä¾‹å¦‚ï¼šIstio åŒ…åä¸º istio-1.6.5 ï¼Œåˆ™ï¼š</p>
<pre><code class="hljs sh">$ <span class="hljs-built_in">cd</span> istio-1.6.5</code></pre>

<p>å®‰è£…â½¬å½•åŒ…å«å¦‚ä¸‹å†…å®¹ï¼š</p>
<ul>
<li><p>samples/ â½¬å½•ä¸‹ï¼Œæœ‰ç¤ºä¾‹åº”â½¤ç¨‹åº</p>
</li>
<li><p>bin/ â½¬å½•ä¸‹ï¼ŒåŒ…å« istioctl çš„å®¢æˆ·ç«¯â½‚ä»¶ã€‚ istioctl â¼¯å…·â½¤äºâ¼¿åŠ¨æ³¨â¼Š Envoy sidecar ä»£ç†ã€‚</p>
</li>
</ul>
<p>å°† istioctl å®¢æˆ·ç«¯è·¯å¾„å¢åŠ åˆ° path ç¯å¢ƒå˜é‡ä¸­ï¼ŒmacOS æˆ– Linux ç³»ç»Ÿçš„å¢åŠ â½…å¼å¦‚ä¸‹ï¼š</p>
<pre><code class="hljs sh">$ <span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$PWD</span>/bin:<span class="hljs-variable">$PATH</span></code></pre>

<p>å®‰è£… bash â¾ƒåŠ¨è¡¥å…¨â½‚ä»¶</p>
<p>å¦‚æœæ‚¨ä½¿â½¤ bashï¼Œistioctl â¾ƒåŠ¨è¡¥å…¨çš„â½‚ä»¶ä½äº tools â½¬å½•ã€‚é€šè¿‡å¤åˆ¶ istioctl.bash â½‚ä»¶åˆ°æ‚¨çš„ homeâ½¬å½•ï¼Œç„¶åæ·»åŠ ä¸‹â¾å†…å®¹åˆ°æ‚¨çš„ .bashrc â½‚ä»¶æ‰§â¾ istioctl tab è¡¥å…¨â½‚ä»¶ï¼š</p>
<pre><code class="hljs sh"><span class="hljs-built_in">source</span> ~/istioctl.bash</code></pre>

<p>å¦‚æœ istioctl è¡¥å…¨â½‚ä»¶å·²ç»æ­£ç¡®å®‰è£…ï¼Œåœ¨æ‚¨è¾“â¼Š istioctl å‘½ä»¤æ—¶é€šè¿‡æŒ‰ Tab é”®ï¼Œå®ƒä¼šè¿”å›â¼€ç»„æ¨èå‘½ä»¤ä¾›æ‚¨é€‰æ‹©ï¼š</p>
<pre><code class="hljs sh">$ istioctl proxy-&lt;TAB&gt;
proxy-config proxy-status</code></pre>

<h3 id="å®‰è£…-Istio"><a href="#å®‰è£…-Istio" class="headerlink" title="å®‰è£… Istio"></a>å®‰è£… Istio</h3><p>è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤åœ¨æ‚¨æ‰€é€‰çš„å¹³å°ä¸Šä½¿â½¤ demo é…ç½®â½‚ä»¶å®‰è£… Istioã€‚</p>
<p>å®‰è£… demo é…ç½®</p>
<pre><code class="hljs sh">$ istioctl manifest apply --<span class="hljs-built_in">set</span> profile=demo</code></pre>

<p>ä¸ºäº†éªŒè¯æ˜¯å¦å®‰è£…æˆåŠŸï¼Œéœ€è¦å…ˆç¡®ä¿ä»¥ä¸‹ Kubernetes æœåŠ¡æ­£ç¡®éƒ¨ç½²ï¼Œç„¶åéªŒè¯é™¤ <code>jaeger-agent</code> æœåŠ¡å¤–çš„å…¶ä»–æœåŠ¡ï¼Œæ˜¯å¦å‡æœ‰æ­£ç¡®çš„ <code>CLUSTER-IP</code>ï¼š</p>
<pre><code class="hljs sh">$ kubectl get svc -n istio-system
NAME                     TYPE           CLUSTER-IP       EXTERNAL-IP     PORT(S)                                                                                                                                      AGE
grafana                  ClusterIP      172.21.211.123   &lt;none&gt;          3000/TCP                                                                                                                                     2m
istio-citadel            ClusterIP      172.21.177.222   &lt;none&gt;          8060/TCP,15014/TCP                                                                                                                           2m
istio-egressgateway      ClusterIP      172.21.113.24    &lt;none&gt;          80/TCP,443/TCP,15443/TCP                                                                                                                     2m
istio-galley             ClusterIP      172.21.132.247   &lt;none&gt;          443/TCP,15014/TCP,9901/TCP                                                                                                                   2m
istio-ingressgateway     LoadBalancer   172.21.144.254   52.116.22.242   15020:31831/TCP,80:31380/TCP,443:31390/TCP,31400:31400/TCP,15029:30318/TCP,15030:32645/TCP,15031:31933/TCP,15032:31188/TCP,15443:30838/TCP   2m
istio-pilot              ClusterIP      172.21.105.205   &lt;none&gt;          15010/TCP,15011/TCP,8080/TCP,15014/TCP                                                                                                       2m
istio-policy             ClusterIP      172.21.14.236    &lt;none&gt;          9091/TCP,15004/TCP,15014/TCP                                                                                                                 2m
istio-sidecar-injector   ClusterIP      172.21.155.47    &lt;none&gt;          443/TCP,15014/TCP                                                                                                                            2m
istio-telemetry          ClusterIP      172.21.196.79    &lt;none&gt;          9091/TCP,15004/TCP,15014/TCP,42422/TCP                                                                                                       2m
jaeger-agent             ClusterIP      None             &lt;none&gt;          5775/UDP,6831/UDP,6832/UDP                                                                                                                   2m
jaeger-collector         ClusterIP      172.21.135.51    &lt;none&gt;          14267/TCP,14268/TCP                                                                                                                          2m
jaeger-query             ClusterIP      172.21.26.187    &lt;none&gt;          16686/TCP                                                                                                                                    2m
kiali                    ClusterIP      172.21.155.201   &lt;none&gt;          20001/TCP                                                                                                                                    2m
prometheus               ClusterIP      172.21.63.159    &lt;none&gt;          9090/TCP                                                                                                                                     2m
tracing                  ClusterIP      172.21.2.245     &lt;none&gt;          80/TCP                                                                                                                                       2m
zipkin                   ClusterIP      172.21.182.245   &lt;none&gt;          9411/TCP                                                                                                                                     2m</code></pre>

<blockquote>
<p>å¦‚æœé›†ç¾¤è¿è¡Œåœ¨ä¸€ä¸ªä¸æ”¯æŒå¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨çš„ç¯å¢ƒä¸­ï¼ˆä¾‹å¦‚ï¼šminikubeï¼‰ï¼Œ<code>istio-ingressgateway</code> çš„ <code>EXTERNAL-IP</code> å°†æ˜¾ç¤ºä¸º <code>&lt;pending&gt;</code> çŠ¶æ€ã€‚è¯·ä½¿ç”¨æœåŠ¡çš„ <code>NodePort</code> æˆ– ç«¯å£è½¬å‘æ¥è®¿é—®ç½‘å…³ã€‚</p>
</blockquote>
<p>è¯·ç¡®ä¿å…³è”çš„ Kubernetes pod å·²ç»éƒ¨ç½²ï¼Œå¹¶ä¸” <code>STATUS</code> ä¸º <code>Running</code>ï¼š</p>
<pre><code class="hljs sh">$ kubectl get pods -n istio-system
NAME                                                           READY   STATUS      RESTARTS   AGE
grafana-f8467cc6-rbjlg                                         1/1     Running     0          1m
istio-citadel-78df5b548f-g5cpw                                 1/1     Running     0          1m
istio-egressgateway-78569df5c4-zwtb5                           1/1     Running     0          1m
istio-galley-74d5f764fc-q7nrk                                  1/1     Running     0          1m
istio-ingressgateway-7ddcfd665c-dmtqz                          1/1     Running     0          1m
istio-pilot-f479bbf5c-qwr28                                    1/1     Running     0          1m
istio-policy-6fccc5c868-xhblv                                  1/1     Running     2          1m
istio-sidecar-injector-78499d85b8-x44m6                        1/1     Running     0          1m
istio-telemetry-78b96c6cb6-ldm9q                               1/1     Running     2          1m
istio-tracing-69b5f778b7-s2zvw                                 1/1     Running     0          1m
kiali-99f7467dc-6rvwp                                          1/1     Running     0          1m
prometheus-67cdb66cbb-9w2hm                                    1/1     Running     0          1m</code></pre>

<h3 id="Bookinfoç¤ºä¾‹"><a href="#Bookinfoç¤ºä¾‹" class="headerlink" title="Bookinfoç¤ºä¾‹"></a>Bookinfoç¤ºä¾‹</h3><h4 id="å¯åŠ¨åº”ç”¨æœåŠ¡"><a href="#å¯åŠ¨åº”ç”¨æœåŠ¡" class="headerlink" title="å¯åŠ¨åº”ç”¨æœåŠ¡"></a>å¯åŠ¨åº”ç”¨æœåŠ¡</h4><ol>
<li><p>è¿›å…¥ Istio å®‰è£…ç›®å½•ã€‚</p>
</li>
<li><p>Istio é»˜è®¤è‡ªåŠ¨æ³¨å…¥ Sidecar. è¯·ä¸º <code>default</code> å‘½åç©ºé—´æ‰“ä¸Šæ ‡ç­¾ <code>istio-injection=enabled</code>ï¼š</p>
<pre><code class="hljs routeros">$ kubectl label namespace<span class="hljs-built_in"> default </span><span class="hljs-attribute">istio-injection</span>=enabled</code></pre>
</li>
<li><p>ä½¿ç”¨ <code>kubectl</code> éƒ¨ç½²åº”ç”¨ï¼š</p>
<pre><code class="hljs awk">$ kubectl apply -f samples<span class="hljs-regexp">/bookinfo/</span>platform<span class="hljs-regexp">/kube/</span>bookinfo.yaml</code></pre>

<p>å¦‚æœæ‚¨åœ¨å®‰è£…è¿‡ç¨‹ä¸­ç¦ç”¨äº† Sidecar è‡ªåŠ¨æ³¨å…¥åŠŸèƒ½è€Œé€‰æ‹©æ‰‹åŠ¨æ³¨å…¥ Sidecarï¼Œè¯·åœ¨éƒ¨ç½²åº”ç”¨ä¹‹å‰ä½¿ç”¨ <code>istioctl kube-inject</code> å‘½ä»¤ä¿®æ”¹ <code>bookinfo.yaml</code> æ–‡ä»¶ã€‚</p>
<pre><code class="hljs gradle">$ kubectl apply -f &lt;(istioctl kube-<span class="hljs-keyword">inject</span> -f samples<span class="hljs-regexp">/bookinfo/</span>platform<span class="hljs-regexp">/kube/</span>bookinfo.yaml)</code></pre>

<p>ä¸Šé¢çš„å‘½ä»¤ä¼šå¯åŠ¨å…¨éƒ¨çš„å››ä¸ªæœåŠ¡ï¼Œå…¶ä¸­ä¹ŸåŒ…æ‹¬äº† reviews æœåŠ¡çš„ä¸‰ä¸ªç‰ˆæœ¬ï¼ˆv1ã€v2 ä»¥åŠ v3ï¼‰ã€‚</p>
<blockquote>
<p>åœ¨å®é™…éƒ¨ç½²ä¸­ï¼Œå¾®æœåŠ¡ç‰ˆæœ¬çš„å¯åŠ¨è¿‡ç¨‹éœ€è¦æŒç»­ä¸€æ®µæ—¶é—´ï¼Œå¹¶ä¸æ˜¯åŒæ—¶å®Œæˆçš„ã€‚</p>
</blockquote>
</li>
<li><p>ç¡®è®¤æ‰€æœ‰çš„æœåŠ¡å’Œ Pod éƒ½å·²ç»æ­£ç¡®çš„å®šä¹‰å’Œå¯åŠ¨ï¼š</p>
<pre><code class="hljs sh">$ kubectl get services
NAME                       CLUSTER-IP   EXTERNAL-IP   PORT(S)              AGE
details                    10.0.0.31    &lt;none&gt;        9080/TCP             6m
kubernetes                 10.0.0.1     &lt;none&gt;        443/TCP              7d
productpage                10.0.0.120   &lt;none&gt;        9080/TCP             6m
ratings                    10.0.0.15    &lt;none&gt;        9080/TCP             6m
reviews                    10.0.0.170   &lt;none&gt;        9080/TCP             6m</code></pre>

<p>è¿˜æœ‰ï¼š</p>
<pre><code class="hljs sh">$ kubectl get pods
NAME                                        READY     STATUS    RESTARTS   AGE
details-v1-1520924117-48z17                 2/2       Running   0          6m
productpage-v1-560495357-jk1lz              2/2       Running   0          6m
ratings-v1-734492171-rnr5l                  2/2       Running   0          6m
reviews-v1-874083890-f0qf0                  2/2       Running   0          6m
reviews-v2-1343845940-b34q5                 2/2       Running   0          6m
reviews-v3-1813607990-8ch52                 2/2       Running   0          6m</code></pre>
</li>
<li><p>è¦ç¡®è®¤ Bookinfo åº”ç”¨æ˜¯å¦æ­£åœ¨è¿è¡Œï¼Œè¯·åœ¨æŸä¸ª Pod ä¸­ç”¨ <code>curl</code> å‘½ä»¤å¯¹åº”ç”¨å‘é€è¯·æ±‚ï¼Œä¾‹å¦‚ <code>ratings</code>ï¼š</p>
<pre><code class="hljs sh">$ kubectl <span class="hljs-built_in">exec</span> -it $(kubectl get pod -l app=ratings -o jsonpath=<span class="hljs-string">&#x27;&#123;.items[0].metadata.name&#125;&#x27;</span>) -c ratings -- curl productpage:9080/productpage | grep -o <span class="hljs-string">&quot;&lt;title&gt;.*&lt;/title&gt;&quot;</span>
&lt;title&gt;Simple Bookstore App&lt;/title&gt;</code></pre>

</li>
</ol>
<h4 id="ç¡®å®š-Ingress-çš„-IP"><a href="#ç¡®å®š-Ingress-çš„-IP" class="headerlink" title="ç¡®å®š Ingress çš„ IP"></a>ç¡®å®š Ingress çš„ IP</h4><p>ç°åœ¨ Bookinfo æœåŠ¡å¯åŠ¨å¹¶è¿è¡Œä¸­ï¼Œæ‚¨éœ€è¦ä½¿åº”ç”¨ç¨‹åºå¯ä»¥ä»å¤–éƒ¨è®¿é—® Kubernetes é›†ç¾¤ï¼Œä¾‹å¦‚ä½¿ç”¨æµè§ˆå™¨ã€‚å¯ä»¥ç”¨ Istio Gateway æ¥å®ç°è¿™ä¸ªç›®æ ‡ã€‚</p>
<ol>
<li><p>ä¸ºåº”ç”¨ç¨‹åºå®šä¹‰ Ingress ç½‘å…³ï¼š</p>
<pre><code class="hljs shell"><span class="hljs-meta">$</span><span class="bash"> kubectl apply -f samples/bookinfo/networking/bookinfo-gateway.yaml</span></code></pre>
</li>
<li><p>ç¡®è®¤ç½‘å…³åˆ›å»ºå®Œæˆï¼š</p>
<pre><code class="hljs shell"><span class="hljs-meta">$</span><span class="bash"> kubectl get gateway</span>
NAME               AGE
bookinfo-gateway   32s</code></pre>
</li>
<li><p>è®¾ç½®è®¿é—®ç½‘å…³çš„ <code>INGRESS_HOST</code> å’Œ <code>INGRESS_PORT</code> å˜é‡ã€‚ç¡®è®¤å¹¶è®¾ç½®ã€‚</p>
<pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">è®¾ç½® ingress ç«¯å£</span>
export INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath=&#x27;&#123;.spec.ports[?(@.name==&quot;http2&quot;)].nodePort&#125;&#x27;)
export SECURE_INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath=&#x27;&#123;.spec.ports[?(@.name==&quot;https&quot;)].nodePort&#125;&#x27;)

<span class="hljs-meta">#</span><span class="bash">è®¾ç½® ingress IP</span>
export INGRESS_HOST=$(kubectl get po -l istio=ingressgateway -n istio-system -o jsonpath=&#x27;&#123;.items[0].status.hostIP&#125;&#x27;)</code></pre>
</li>
<li><p>è®¾ç½® <code>GATEWAY_URL</code>ï¼š</p>
<pre><code class="hljs shell">export GATEWAY_URL=$INGRESS_HOST:$INGRESS_PORT</code></pre>

</li>
</ol>
<p>å¯ä»¥ç”¨æµè§ˆå™¨æ‰“å¼€ç½‘å€ <code>http://$GATEWAY_URL/productpage</code>ï¼Œæ¥æµè§ˆåº”ç”¨çš„ Web é¡µé¢ã€‚å¦‚æœåˆ·æ–°å‡ æ¬¡åº”ç”¨çš„é¡µé¢ï¼Œå°±ä¼šçœ‹åˆ° <code>productpage</code> é¡µé¢ä¸­ä¼šéšæœºå±•ç¤º <code>reviews</code> æœåŠ¡çš„ä¸åŒç‰ˆæœ¬çš„æ•ˆæœï¼ˆçº¢è‰²ã€é»‘è‰²çš„æ˜Ÿå½¢æˆ–è€…æ²¡æœ‰æ˜¾ç¤ºï¼‰ã€‚<code>reviews</code> æœåŠ¡å‡ºç°è¿™ç§æƒ…å†µæ˜¯å› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰ä½¿ç”¨ Istio æ¥æ§åˆ¶ç‰ˆæœ¬çš„è·¯ç”±ã€‚</p>
<h4 id="åº”ç”¨é»˜è®¤ç›®æ ‡è§„åˆ™"><a href="#åº”ç”¨é»˜è®¤ç›®æ ‡è§„åˆ™" class="headerlink" title="åº”ç”¨é»˜è®¤ç›®æ ‡è§„åˆ™"></a>åº”ç”¨é»˜è®¤ç›®æ ‡è§„åˆ™</h4><p>åœ¨ä½¿ç”¨ Istio æ§åˆ¶ Bookinfo ç‰ˆæœ¬è·¯ç”±ä¹‹å‰ï¼Œæ‚¨éœ€è¦åœ¨ç›®æ ‡è§„åˆ™ä¸­å®šä¹‰å¥½å¯ç”¨çš„ç‰ˆæœ¬ï¼Œå‘½åä¸º <em>subsets</em> ã€‚</p>
<pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">è®¾ç½®</span>
kubectl apply -f samples/bookinfo/networking/destination-rule-all.yaml

<span class="hljs-meta">#</span><span class="bash">æŸ¥è¯¢</span>
kubectl get destinationrules -o yaml</code></pre>

<p>è‡³æ­¤ï¼ŒIstio å®Œæˆäº†å…¨éƒ¨çš„æ¥ç®¡ï¼Œç¬¬ä¸€ä¸ªç¤ºä¾‹éƒ¨ç½²å®Œæˆã€‚</p>
<h3 id="ä½“éªŒIstio"><a href="#ä½“éªŒIstio" class="headerlink" title="ä½“éªŒIstio"></a>ä½“éªŒIstio</h3><h4 id="æŒ‰ç…§ç‰ˆæœ¬è·¯ç”±"><a href="#æŒ‰ç…§ç‰ˆæœ¬è·¯ç”±" class="headerlink" title="æŒ‰ç…§ç‰ˆæœ¬è·¯ç”±"></a>æŒ‰ç…§ç‰ˆæœ¬è·¯ç”±</h4><p>reviewsæœ‰ä¸‰ä¸ªç‰ˆæœ¬ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œä¼šè¿›è¡Œè½®è¯¢ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çœ‹åˆ°çš„ï¼Œæ¯ä¸€æ¬¡åˆ·æ–°éƒ½ä¼šæœ‰ä¸åŒçš„æ•ˆæœã€‚</p>
<p>å¦‚æœï¼Œæˆ‘ä»¬éœ€è¦å°†è¯·æ±‚å…¨éƒ¨åˆ‡æ¢åˆ°æŸä¸€ä¸ªç‰ˆæœ¬ï¼Œéœ€è¦Istioæ˜¯éå¸¸ç®€å•çš„ï¼Œåªéœ€è¦æ·»åŠ è™šæ‹ŸæœåŠ¡å³å¯ã€‚</p>
<p>ç¤ºä¾‹ï¼š</p>
<pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">virtual-service-all-v1.yamlæ˜¯å®˜æ–¹æä¾›çš„ç¤ºä¾‹æ–‡ä»¶</span>

kubectl apply -f samples/bookinfo/networking/virtual-service-all-v1.yaml</code></pre>

<p>å…¶å†…å®¹å¦‚ä¸‹ï¼š</p>
<pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">networking.istio.io/v1alpha3</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">VirtualService</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">productpage</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">hosts:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">productpage</span>
  <span class="hljs-attr">http:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">route:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">destination:</span>
        <span class="hljs-attr">host:</span> <span class="hljs-string">productpage</span>
        <span class="hljs-attr">subset:</span> <span class="hljs-string">v1</span>
<span class="hljs-meta">---</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">networking.istio.io/v1alpha3</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">VirtualService</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">reviews</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">hosts:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">reviews</span>
  <span class="hljs-attr">http:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">route:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">destination:</span>
        <span class="hljs-attr">host:</span> <span class="hljs-string">reviews</span>
        <span class="hljs-attr">subset:</span> <span class="hljs-string">v1</span>  <span class="hljs-comment">#åœ¨è¿™é‡ŒæŒ‡å®šäº†æ‰€æœ‰çš„httpè¯·æ±‚éƒ½é€šè¿‡v1å®Œæˆï¼Œè€Œv1åœ¨é»˜è®¤çš„è§„åˆ™ä¸­æœ‰å®šä¹‰</span>
<span class="hljs-meta">---</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">networking.istio.io/v1alpha3</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">VirtualService</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">ratings</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">hosts:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">ratings</span>
  <span class="hljs-attr">http:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">route:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">destination:</span>
        <span class="hljs-attr">host:</span> <span class="hljs-string">ratings</span>
        <span class="hljs-attr">subset:</span> <span class="hljs-string">v1</span>
<span class="hljs-meta">---</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">networking.istio.io/v1alpha3</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">VirtualService</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">details</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">hosts:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">details</span>
  <span class="hljs-attr">http:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">route:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">destination:</span>
        <span class="hljs-attr">host:</span> <span class="hljs-string">details</span>
        <span class="hljs-attr">subset:</span> <span class="hljs-string">v1</span>
<span class="hljs-meta">---</span></code></pre>

<p>ç»è¿‡æµ‹è¯•ï¼Œå‘ç°reviewsä¸å†åˆ‡æ¢æ ·å¼ã€‚</p>
<p>è¿˜å¯ä»¥å°†éƒ¨åˆ†æµé‡è½¬ç§»åˆ°v3ç‰ˆæœ¬ï¼ŒåŸºäºæ­¤å¯ä»¥å®ç°ç°åº¦å‘å¸ƒã€A/Bæµ‹è¯•ç­‰ï¼š</p>
<pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">å°†50%çš„æµç¨‹è½¬ç§»åˆ°v3</span>
kubectl apply -f samples/bookinfo/networking/virtual-service-reviews-50-v3.yaml</code></pre>

<p>å†…å®¹å¦‚ä¸‹ï¼š</p>
<pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">networking.istio.io/v1alpha3</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">VirtualService</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">reviews</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">hosts:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">reviews</span>
  <span class="hljs-attr">http:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">route:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">destination:</span>
        <span class="hljs-attr">host:</span> <span class="hljs-string">reviews</span>
        <span class="hljs-attr">subset:</span> <span class="hljs-string">v1</span>
      <span class="hljs-attr">weight:</span> <span class="hljs-number">50</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">destination:</span>
        <span class="hljs-attr">host:</span> <span class="hljs-string">reviews</span>
        <span class="hljs-attr">subset:</span> <span class="hljs-string">v3</span>
      <span class="hljs-attr">weight:</span> <span class="hljs-number">50</span>
</code></pre>

<p>åˆ·æ–°æµè§ˆå™¨ä¸­çš„ /productpage é¡µé¢ï¼Œå¤§çº¦æœ‰ 50% çš„å‡ ç‡ä¼šçœ‹åˆ°é¡µé¢ä¸­å‡ºå¸¦ çº¢è‰² æ˜Ÿçº§çš„è¯„ä»·å†…å®¹ã€‚è¿™æ˜¯å› ä¸º v3 ç‰ˆæœ¬çš„ reviews è®¿é—®äº†å¸¦æ˜Ÿçº§è¯„çº§çš„ ratings æœåŠ¡ï¼Œä½† v1 ç‰ˆæœ¬å´æ²¡æœ‰ã€‚</p>
<p>å¦‚æœè®¤ä¸º reviews:v3 å¾®æœåŠ¡å·²ç»ç¨³å®šï¼Œå¯ä»¥é€šè¿‡åº”ç”¨æ­¤ virtual service è§„åˆ™å°† 100% çš„æµé‡è·¯ç”±åˆ° reviews:v3ï¼š</p>
<pre><code class="hljs shell">kubectl apply -f samples/bookinfo/networking/virtual-service-reviews-v3.yaml</code></pre>

<p>è¿™æ ·ï¼Œæ‰€æœ‰çš„è¯·æ±‚éƒ½è½¬å‘åˆ°äº†v3äº†ã€‚</p>
<p>å¦‚æœéœ€è¦åˆ é™¤è™šæ‹Ÿç½‘ç»œï¼Œå¯ä»¥æ‰§è¡Œï¼š</p>
<pre><code class="hljs shell">kubectl delete -f samples/bookinfo/networking/virtual-service-all-v1.yaml</code></pre>

<h4 id="æŒ‰ç…§ä¸åŒç”¨æˆ·èº«ä»½è·¯ç”±"><a href="#æŒ‰ç…§ä¸åŒç”¨æˆ·èº«ä»½è·¯ç”±" class="headerlink" title="æŒ‰ç…§ä¸åŒç”¨æˆ·èº«ä»½è·¯ç”±"></a>æŒ‰ç…§ä¸åŒç”¨æˆ·èº«ä»½è·¯ç”±</h4><p>æ¥ä¸‹æ¥ï¼Œæ‚¨å°†æ›´æ”¹è·¯ç”±é…ç½®ï¼Œä»¥ä¾¿å°†æ¥è‡ªç‰¹å®šç”¨æˆ·çš„æ‰€æœ‰æµé‡è·¯ç”±åˆ°ç‰¹å®šæœåŠ¡ç‰ˆæœ¬ã€‚åœ¨è¿™ï¼Œæ¥è‡ªåä¸º Jason çš„ç”¨æˆ·çš„æ‰€æœ‰æµé‡å°†è¢«è·¯ç”±åˆ°æœåŠ¡ <code>reviews:v2</code>ã€‚</p>
<p>è¯·æ³¨æ„ï¼ŒIstio å¯¹ç”¨æˆ·èº«ä»½æ²¡æœ‰ä»»ä½•ç‰¹æ®Šçš„å†…ç½®æœºåˆ¶ã€‚äº‹å®ä¸Šï¼Œ<code>productpage</code> æœåŠ¡åœ¨æ‰€æœ‰åˆ° <code>reviews</code> æœåŠ¡çš„ HTTP è¯·æ±‚ä¸­éƒ½å¢åŠ äº†ä¸€ä¸ªè‡ªå®šä¹‰çš„ <code>end-user</code> è¯·æ±‚å¤´ï¼Œä»è€Œè¾¾åˆ°äº†æœ¬ä¾‹å­çš„æ•ˆæœã€‚</p>
<p>è¯·è®°ä½ï¼Œ<code>reviews:v2</code> æ˜¯åŒ…å«æ˜Ÿçº§è¯„åˆ†åŠŸèƒ½çš„ç‰ˆæœ¬ã€‚</p>
<ol>
<li><p>è¿è¡Œä»¥ä¸‹å‘½ä»¤ä»¥å¯ç”¨åŸºäºç”¨æˆ·çš„è·¯ç”±ï¼š</p>
<pre><code class="hljs shell"><span class="hljs-meta">$</span><span class="bash"> kubectl apply -f samples/bookinfo/networking/virtual-service-reviews-test-v2.yaml</span></code></pre>
</li>
<li><p>ç¡®è®¤è§„åˆ™å·²åˆ›å»ºï¼š</p>
<pre><code class="hljs yaml"><span class="hljs-string">$</span> <span class="hljs-string">kubectl</span> <span class="hljs-string">get</span> <span class="hljs-string">virtualservice</span> <span class="hljs-string">reviews</span> <span class="hljs-string">-o</span> <span class="hljs-string">yaml</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">networking.istio.io/v1alpha3</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">VirtualService</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">reviews</span>
  <span class="hljs-string">...</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">hosts:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">reviews</span>
  <span class="hljs-attr">http:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">match:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">headers:</span>
        <span class="hljs-attr">end-user:</span>
          <span class="hljs-attr">exact:</span> <span class="hljs-string">jason</span>
    <span class="hljs-attr">route:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">destination:</span>
        <span class="hljs-attr">host:</span> <span class="hljs-string">reviews</span>
        <span class="hljs-attr">subset:</span> <span class="hljs-string">v2</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">route:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">destination:</span>
        <span class="hljs-attr">host:</span> <span class="hljs-string">reviews</span>
        <span class="hljs-attr">subset:</span> <span class="hljs-string">v1</span></code></pre>
</li>
<li><p>åœ¨ Bookinfo åº”ç”¨ç¨‹åºçš„ <code>/productpage</code> ä¸Šï¼Œä»¥ç”¨æˆ· <code>jason</code> èº«ä»½ç™»å½•ã€‚</p>
<p>åˆ·æ–°æµè§ˆå™¨ã€‚ä½ çœ‹åˆ°äº†ä»€ä¹ˆï¼Ÿæ˜Ÿçº§è¯„åˆ†æ˜¾ç¤ºåœ¨æ¯ä¸ªè¯„è®ºæ—è¾¹ã€‚</p>
</li>
<li><p>ä»¥å…¶ä»–ç”¨æˆ·èº«ä»½ç™»å½•ï¼ˆé€‰æ‹©æ‚¨æƒ³è¦çš„ä»»ä½•åç§°ï¼‰ã€‚</p>
<p>åˆ·æ–°æµè§ˆå™¨ã€‚ç°åœ¨æ˜Ÿæ˜Ÿæ¶ˆå¤±äº†ã€‚è¿™æ˜¯å› ä¸ºé™¤äº† Jason ä¹‹å¤–ï¼Œæ‰€æœ‰ç”¨æˆ·çš„æµé‡éƒ½è¢«è·¯ç”±åˆ° <code>reviews:v1</code>ã€‚</p>
</li>
</ol>
<p>æ‚¨å·²æˆåŠŸé…ç½® Istio ä»¥æ ¹æ®ç”¨æˆ·èº«ä»½è·¯ç”±æµé‡ã€‚</p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/blog/categories/%E6%9C%8D%E5%8A%A1%E7%BD%91%E6%A0%BC/">æœåŠ¡ç½‘æ ¼</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/blog/tags/Istio%E5%85%A5%E9%97%A8/">Istioå…¥é—¨</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 åè®®</a> ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</p>
              
              
                <div class="post-prevnext row">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/blog/2020/10/15/%E4%B8%9A%E5%8A%A1-%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E8%AE%BE%E8%AE%A1/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">é…ç½®ä¸­å¿ƒè®¾è®¡</span>
                        <span class="visible-mobile">ä¸Šä¸€ç¯‡</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/blog/2020/09/27/ServiceMesh-%E7%AE%80%E4%BB%8B/">
                        <span class="hidden-mobile">ServiceMeshç®€ä»‹</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.staticfile.org/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":200})
    NProgress.start()
    document.addEventListener('DOMContentLoaded', function() {
      window.NProgress && window.NProgress.inc();
    })
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.staticfile.org/jquery/3.5.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.5.3/js/bootstrap.min.js" ></script>
<script  src="/blog/js/debouncer.js" ></script>
<script  src="/blog/js/events.js" ></script>
<script  src="/blog/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/blog/js/lazyload.js" ></script>
  



  



  <script  src="https://cdn.staticfile.org/tocbot/4.12.0/tocbot.min.js" ></script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>





  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/blog/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/blog/local-search.xml";
      var inputArea = document.querySelector("#local-search-input");
      inputArea.onclick = function () {
        searchFunc(path, 'local-search-input', 'local-search-result');
        this.onclick = null
      }
    })()
  </script>















<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ ä¿æŒåœ¨æœ€åº•éƒ¨ -->
<script  src="/blog/js/boot.js" ></script>



</body>
</html>
