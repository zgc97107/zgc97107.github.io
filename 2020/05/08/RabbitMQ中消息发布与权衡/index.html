<!DOCTYPE html>
<html lang="zh-CN">





<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="">
  <meta name="keywords" content="">
  <title>RabbitMQä¸­æ¶ˆæ¯å‘å¸ƒä¸æƒè¡¡ - ğŸğŸŠ&#39;s blog</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/5.12.1/css/all.min.css" />
<link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />
<link  rel="stylesheet" href="https://cdn.staticfile.org/mdbootstrap/4.13.0/css/mdb.min.css" />
<link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/3.0.1/github-markdown.min.css" />

<link rel="stylesheet" href="//at.alicdn.com/t/font_1067060_qzomjdt8bmp.css">



  <link  rel="stylesheet" href="/lib/prettify/tomorrow-night-eighties.min.css" />

<link  rel="stylesheet" href="/css/main.css" />


  <link defer rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />


<!-- è‡ªå®šä¹‰æ ·å¼ä¿æŒåœ¨æœ€åº•éƒ¨ -->


<meta name="generator" content="Hexo 4.2.1"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>ğŸğŸŠ's blog</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/">é¦–é¡µ</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/archives/">å½’æ¡£</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/categories/">åˆ†ç±»</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/tags/">æ ‡ç­¾</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/about">å…³äº</a>
          </li>
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="view intro-2" id="background" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask rgba-black-light flex-center">
          <div class="container text-center white-text fadeInUp">
            <span class="h2" id="subtitle">
              
            </span>

            
              
                <p class="mt-3 post-meta">
                  <i class="fas fa-calendar-alt" aria-hidden="true"></i>
                  æ˜ŸæœŸäº”, äº”æœˆ 8æ—¥ 2020, 3:17 ä¸‹åˆ
                </p>
              

              <p class="mt-1">
                
                  
                  <span class="post-meta">
                    <i class="far fa-chart-bar"></i>
                    7k å­—
                  </span>
                

                
                  
                  <span class="post-meta">
                      <i class="far fa-clock"></i>
                      32 åˆ†é’Ÿ
                  </span>
                

                
                  <!-- ä¸è’œå­ç»Ÿè®¡æ–‡ç« PV -->
                  
                  <span id="busuanzi_container_page_pv" class="post-meta" style="display: none">
                    <i class="far fa-eye" aria-hidden="true"></i>
                    <span id="busuanzi_value_page_pv"></span> æ¬¡
                  </span>
                
              </p>
            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5 z-depth-3" id="board">
          <div class="post-content mx-auto" id="post">
            
              <p
                class="note note-warning">æœ¬æ–‡æœ€åæ›´æ–°äºï¼šæ˜ŸæœŸæ—¥, äº”æœˆ 10æ—¥ 2020, 9:19 æ™šä¸Š</p>
            
            <div class="markdown-body">
              <h2 id="ä½¿ç”¨Javaå®¢æˆ·ç«¯è¿›è¡Œæ¶ˆæ¯é€šä¿¡"><a href="#ä½¿ç”¨Javaå®¢æˆ·ç«¯è¿›è¡Œæ¶ˆæ¯é€šä¿¡" class="headerlink" title="ä½¿ç”¨Javaå®¢æˆ·ç«¯è¿›è¡Œæ¶ˆæ¯é€šä¿¡"></a>ä½¿ç”¨Javaå®¢æˆ·ç«¯è¿›è¡Œæ¶ˆæ¯é€šä¿¡</h2><p>å®¢æˆ·ç«¯éœ€è¦amqp-client-5.0.0.jarå’Œslf4j-api-1.6.1.jar</p>
<p>å»ºè®®ä½¿ç”¨Mavenï¼š</p>
<pre><code class="xml">&lt;dependency&gt;
 &lt;groupId&gt;com.rabbitmq&lt;/groupId&gt;
 &lt;artifactId&gt;amqp-client&lt;/artifactId&gt;
 &lt;version&gt;5.0.0&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
<p>æ³¨æ„ï¼š5ç³»åˆ—çš„ç‰ˆæœ¬æœ€å¥½ä½¿ç”¨JDK8åŠä»¥ä¸Šï¼Œ ä½äºJDK8å¯ä»¥ä½¿ç”¨4.x(å…·ä½“çš„ç‰ˆæœ¬å·åˆ°Mavençš„ä¸­å¤®ä»“åº“æŸ¥)çš„ç‰ˆæœ¬ã€‚</p>
<h3 id="Directäº¤æ¢å™¨"><a href="#Directäº¤æ¢å™¨" class="headerlink" title="Directäº¤æ¢å™¨"></a>Directäº¤æ¢å™¨</h3><img src="/2020/05/08/RabbitMQ%E4%B8%AD%E6%B6%88%E6%81%AF%E5%8F%91%E5%B8%83%E4%B8%8E%E6%9D%83%E8%A1%A1/pic3.png" srcset="/img/loading.gif" class>

<h4 id="ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„ä¸€èˆ¬ç”¨æ³•"><a href="#ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„ä¸€èˆ¬ç”¨æ³•" class="headerlink" title="ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„ä¸€èˆ¬ç”¨æ³•"></a>ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„ä¸€èˆ¬ç”¨æ³•</h4><p>åˆ›å»ºæ¶ˆæ¯ç”Ÿäº§è€…</p>
<pre><code class="java">public class DirectProducer {

    /**
     * äº¤æ¢å™¨åç§°
     */
    public final static String EXCHANGE_NAME = &quot;direct_logs&quot;;

    /**
     * è·¯ç”±é”®
     */
    public final static String[] ROUTE_KEYS ={&quot;route_key_1&quot;,&quot;route_key_2&quot;,&quot;route_key_3&quot;};

    public static void main(String[] args)
            throws IOException, TimeoutException {
        //åˆ›å»ºè¿æ¥ã€è¿æ¥åˆ°RabbitMQ
        ConnectionFactory connectionFactory= new ConnectionFactory();
        //è®¾ç½®ä¸‹è¿æ¥å·¥å‚çš„è¿æ¥åœ°å€(ä½¿ç”¨é»˜è®¤ç«¯å£5672)
        connectionFactory.setHost(&quot;localhost&quot;);
        //åˆ›å»ºè¿æ¥
        Connection connection =connectionFactory.newConnection();
        //åˆ›å»ºä¿¡é“
        Channel channel =connection.createChannel();

        //åœ¨ä¿¡é“ä¸­è®¾ç½®äº¤æ¢å™¨
        channel.exchangeDeclare(EXCHANGE_NAME,BuiltinExchangeType.DIRECT);

        for (int i=0;i&lt;6;i++){
            String routeKey = ROUTE_KEYS[i%3];
            String msg = &quot;Hello,RabbitMQ&quot;+(i+1);
            //å‘å¸ƒæ¶ˆæ¯
            channel.basicPublish(EXCHANGE_NAME,routeKey,null,msg.getBytes());
            System.out.println(&quot;Sent:&quot;+routeKey+&quot;:&quot;+msg);
        }
        channel.close();
        connection.close();
    }
}</code></pre>
<p>åˆ›å»ºæ¶ˆè´¹è€…</p>
<pre><code class="java">public class NormalConsumer {

    public static void main(String[] argv) throws IOException, TimeoutException {
        //åˆ›å»ºè¿æ¥ã€è¿æ¥åˆ°RabbitMQ
        ConnectionFactory connectionFactory = new ConnectionFactory();
        //è®¾ç½®ä¸‹è¿æ¥å·¥å‚çš„è¿æ¥åœ°å€(ä½¿ç”¨é»˜è®¤ç«¯å£5672)
        connectionFactory.setHost(&quot;localhost&quot;);
        //åˆ›å»ºè¿æ¥
        Connection connection = connectionFactory.newConnection();
        //åˆ›å»ºä¿¡é“
        Channel channel = connection.createChannel();

        //åœ¨ä¿¡é“ä¸­è®¾ç½®äº¤æ¢å™¨
        channel.exchangeDeclare(DirectProducer.EXCHANGE_NAME, BuiltinExchangeType.DIRECT);

        //ç”³æ˜é˜Ÿåˆ—
        String queueName = &quot;queue_1&quot;;
        channel.queueDeclare(queueName, false, false, false, null);

        //ç»‘å®šï¼šå°†é˜Ÿåˆ—ä¸äº¤æ¢å™¨é€šè¿‡è·¯ç”±é”®ç»‘å®š
        String routeKey = DirectProducer.ROUTE_KEYS[0];
        channel.queueBind(queueName, DirectProducer.EXCHANGE_NAME, routeKey);
        System.out.println(&quot;waiting for message ......&quot;);

        //ç”³æ˜ä¸€ä¸ªæ¶ˆè´¹è€…
        final Consumer consumer = new DefaultConsumer(channel) {
            @Override
            public void handleDelivery(String s, Envelope envelope, AMQP.BasicProperties basicProperties, byte[] bytes) throws IOException {
                String message = new String(bytes, &quot;UTF-8&quot;);
                System.out.println(&quot;Received[&quot; + envelope.getRoutingKey() + &quot;]&quot; + message);
            }
        };

        //æ¶ˆæ¯è€…æ­£å¼å¼€å§‹åœ¨æŒ‡å®šé˜Ÿåˆ—ä¸Šæ¶ˆè´¹ã€‚
        //ç¬¬äºŒä¸ªå‚æ•°æ˜¯è‡ªåŠ¨ç¡®è®¤å‚æ•°ï¼Œå¦‚æœæ˜¯trueåˆ™æ˜¯è‡ªåŠ¨ç¡®è®¤
        channel.basicConsume(queueName, true, consumer);
    }

}</code></pre>
<p>é€šè¿‡æµ‹è¯•å‘ç°ï¼Œä½¿ç”¨DirectProducerä½œä¸ºç”Ÿäº§è€…ï¼ŒNormalConsumerä½œä¸ºæ¶ˆè´¹è€…ï¼Œæ¶ˆè´¹è€…ç»‘å®šä¸€ä¸ªé˜Ÿåˆ—ï¼Œæ—¶åªæ¥æ”¶è¯¥é˜Ÿåˆ—ç»‘å®šçš„è·¯ç”±é”®çš„æ¶ˆæ¯ã€‚</p>
<h4 id="é˜Ÿåˆ—å’Œäº¤æ¢å™¨çš„å¤šé‡ç»‘å®š"><a href="#é˜Ÿåˆ—å’Œäº¤æ¢å™¨çš„å¤šé‡ç»‘å®š" class="headerlink" title="é˜Ÿåˆ—å’Œäº¤æ¢å™¨çš„å¤šé‡ç»‘å®š"></a>é˜Ÿåˆ—å’Œäº¤æ¢å™¨çš„å¤šé‡ç»‘å®š</h4><h5 id="ä¸€ä¸ªé˜Ÿåˆ—ç»‘å®šå¤šä¸ªè·¯ç”±é”®"><a href="#ä¸€ä¸ªé˜Ÿåˆ—ç»‘å®šå¤šä¸ªè·¯ç”±é”®" class="headerlink" title="ä¸€ä¸ªé˜Ÿåˆ—ç»‘å®šå¤šä¸ªè·¯ç”±é”®"></a>ä¸€ä¸ªé˜Ÿåˆ—ç»‘å®šå¤šä¸ªè·¯ç”±é”®</h5><p>è¿™æ—¶é˜Ÿåˆ—å¯ä»¥æ¥æ”¶åˆ°ç»‘å®šçš„æ‰€æœ‰è·¯ç”±é”®çš„æ¶ˆæ¯ã€‚</p>
<pre><code class="java">public class MultiBindConsumer {

    public static void main(String[] argv) throws IOException,
            InterruptedException, TimeoutException {
        //è¿æ¥å·¥å‚
        ConnectionFactory factory = new ConnectionFactory();
        //è¿æ¥rabbitMqçš„åœ°å€
        factory.setHost(&quot;127.0.0.1&quot;);

        // æ‰“å¼€è¿æ¥å’Œåˆ›å»ºé¢‘é“ï¼Œä¸å‘é€ç«¯ä¸€æ ·
        Connection connection = factory.newConnection();
        //åˆ›å»ºä¸€ä¸ªä¿¡é“
        final Channel channel = connection.createChannel();
        //åœ¨ä¿¡é“ä¸­è®¾ç½®äº¤æ¢å™¨
        channel.exchangeDeclare(DirectProducer.EXCHANGE_NAME, BuiltinExchangeType.DIRECT);

        //å£°æ˜ä¸€ä¸ªéšæœºé˜Ÿåˆ—
        String queueName = channel.queueDeclare().getQueue();
        //é˜Ÿåˆ—ç»‘å®šåˆ°äº¤æ¢å™¨ä¸Šæ—¶ï¼Œæ˜¯å…è®¸ç»‘å®šå¤šä¸ªè·¯ç”±é”®çš„ï¼Œä¹Ÿå°±æ˜¯å¤šé‡ç»‘å®š
        for (String routekey : DirectProducer.ROUTE_KEYS) {
            channel.queueBind(queueName, DirectProducer.EXCHANGE_NAME, routekey);
        }
        System.out.println(&quot; [*] Waiting for messages:&quot;);

        // åˆ›å»ºé˜Ÿåˆ—æ¶ˆè´¹è€…
        final Consumer consumerA = new DefaultConsumer(channel) {
            @Override
            public void handleDelivery(String consumerTag,
                                       Envelope envelope,
                                       AMQP.BasicProperties
                                               properties,
                                       byte[] body)
                    throws IOException {
                String message = new String(body, &quot;UTF-8&quot;);
                System.out.println(&quot; Received &quot;
                        + envelope.getRoutingKey() + &quot;:&#39;&quot; + message
                        + &quot;&#39;&quot;);
            }
        };
        channel.basicConsume(queueName, true, consumerA);
    }
}</code></pre>
<h5 id="ä¸€ä¸ªè¿æ¥å¤šä¸ªä¿¡é“"><a href="#ä¸€ä¸ªè¿æ¥å¤šä¸ªä¿¡é“" class="headerlink" title="ä¸€ä¸ªè¿æ¥å¤šä¸ªä¿¡é“"></a>ä¸€ä¸ªè¿æ¥å¤šä¸ªä¿¡é“</h5><p>å®ç°æ–¹æ³•ä¸ºä½¿ç”¨å¤šçº¿ç¨‹åˆ›å»ºä¿¡é“ï¼Œç„¶åç”Ÿæˆéšæœºçš„é˜Ÿåˆ—å¹¶ç»‘å®šåˆ°ä¿¡é“ã€‚è¿™æ—¶æ‰€æœ‰é˜Ÿåˆ—éƒ½å¯ä»¥æ¥æ”¶åˆ°å…¨éƒ¨çš„æ¶ˆæ¯ã€‚</p>
<pre><code class="java">public class MultiChannelConsumer {

    private static class ConsumerWorker implements Runnable {
        final Connection connection;

        public ConsumerWorker(Connection connection) {
            this.connection = connection;
        }

        public void run() {
            try {
                //åˆ›å»ºä¸€ä¸ªä¿¡é“ï¼Œæ„å‘³ç€æ¯ä¸ªçº¿ç¨‹å•ç‹¬ä¸€ä¸ªä¿¡é“
                Channel channel = connection.createChannel();
                channel.exchangeDeclare(DirectProducer.EXCHANGE_NAME, BuiltinExchangeType.DIRECT);
                // å£°æ˜ä¸€ä¸ªéšæœºé˜Ÿåˆ—
                String queueName = channel.queueDeclare().getQueue();
                //æ¶ˆè´¹è€…åå­—ï¼Œæ‰“å°è¾“å‡ºç”¨
                final String consumerName = Thread.currentThread().getName() + &quot;-all&quot;;
                for (String routekey : DirectProducer.ROUTE_KEYS) {
                    channel.queueBind(queueName, DirectProducer.EXCHANGE_NAME,
                            routekey);
                }
                System.out.println(&quot;[&quot; + consumerName + &quot;] Waiting for messages:&quot;);
                final Consumer consumerA = new DefaultConsumer(channel) {
                    @Override
                    public void handleDelivery(String consumerTag,
                                               Envelope envelope,
                                               AMQP.BasicProperties
                                                       properties,
                                               byte[] body)
                            throws IOException {
                        String message =
                                new String(body, &quot;UTF-8&quot;);
                        System.out.println(consumerName
                                + &quot; Received &quot; + envelope.getRoutingKey()
                                + &quot;:&#39;&quot; + message + &quot;&#39;&quot;);
                    }
                };
                channel.basicConsume(queueName, true, consumerA);
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }

    public static void main(String[] argv) throws TimeoutException, IOException {
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost(&quot;localhost&quot;);
        Connection connection = factory.newConnection();
        for (int i = 0; i &lt; 2; i++) {
            //å°†è¿æ¥ä½œä¸ºå‚æ•°ï¼Œä¼ é€’ç»™æ¯ä¸ªçº¿ç¨‹
            Thread worker = new Thread(new ConsumerWorker(connection));
            worker.start();
        }
    }
}</code></pre>
<h5 id="ä¸€ä¸ªé˜Ÿåˆ—å¤šä¸ªæ¶ˆè´¹è€…"><a href="#ä¸€ä¸ªé˜Ÿåˆ—å¤šä¸ªæ¶ˆè´¹è€…" class="headerlink" title="ä¸€ä¸ªé˜Ÿåˆ—å¤šä¸ªæ¶ˆè´¹è€…"></a>ä¸€ä¸ªé˜Ÿåˆ—å¤šä¸ªæ¶ˆè´¹è€…</h5><p>ä¹Ÿæ˜¯åˆ©ç”¨å¤šçº¿ç¨‹ï¼Œåªä¸è¿‡è¿™æ˜¯åˆ›å»ºæŒ‡å®šåç§°çš„é˜Ÿåˆ—ï¼Œå¦‚æœé˜Ÿåˆ—å·²å­˜åœ¨ä¸ä¼šé‡å¤ç»‘å®šã€‚è¿™æ—¶ä¼šè½®è¯¢å°†é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯åˆ†å‘ç»™æ¶ˆè´¹è€…ï¼Œæ‰€æœ‰æ¶ˆè´¹è€…å…±äº«è¿™ä¸ªé˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ã€‚</p>
<pre><code class="java">public class MultiConsumerOneQueue {

    private static class ConsumerWorker implements Runnable {
        final Connection connection;
        final String queueName;

        public ConsumerWorker(Connection connection, String queueName) {
            this.connection = connection;
            this.queueName = queueName;
        }

        public void run() {
            try {
                final Channel channel = connection.createChannel();
                channel.exchangeDeclare(DirectProducer.EXCHANGE_NAME, BuiltinExchangeType.DIRECT);
                //å£°æ˜ä¸€ä¸ªé˜Ÿåˆ—,rabbitmqï¼Œå¦‚æœé˜Ÿåˆ—å·²å­˜åœ¨ï¼Œä¸ä¼šé‡å¤åˆ›å»º
                channel.queueDeclare(queueName, false, false, false, null);
                final String consumerName = Thread.currentThread().getName();
                for (String routekey : DirectProducer.ROUTE_KEYS) {
                    channel.queueBind(queueName, DirectProducer.EXCHANGE_NAME,
                            routekey);
                }
                System.out.println(&quot; [&quot; + consumerName + &quot;] Waiting for messages:&quot;);
                final Consumer consumerA = new DefaultConsumer(channel) {
                    @Override
                    public void handleDelivery(String consumerTag,
                                               Envelope envelope,
                                               AMQP.BasicProperties
                                                       properties,
                                               byte[] body)
                            throws IOException {
                        String message =
                                new String(body, &quot;UTF-8&quot;);
                        System.out.println(consumerName
                                + &quot; Received &quot; + envelope.getRoutingKey()
                                + &quot;:&#39;&quot; + message + &quot;&#39;&quot;);
                    }
                };
                channel.basicConsume(queueName, true, consumerA);
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }

    public static void main(String[] argv) throws IOException, TimeoutException {
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost(&quot;127.0.0.1&quot;);
        Connection connection = factory.newConnection();
        String queueName = &quot;focusAll&quot;;
        for (int i = 0; i &lt; 3; i++) {
            //å°†è¿æ¥åŠé˜Ÿåˆ—åä½œä¸ºå‚æ•°ï¼Œä¼ é€’ç»™æ¯ä¸ªçº¿ç¨‹
            Thread worker = new Thread(new ConsumerWorker(connection, queueName));
            worker.start();
        }
    }
}</code></pre>
<h3 id="Fanoutäº¤æ¢å™¨"><a href="#Fanoutäº¤æ¢å™¨" class="headerlink" title="Fanoutäº¤æ¢å™¨"></a>Fanoutäº¤æ¢å™¨</h3><img src="/2020/05/08/RabbitMQ%E4%B8%AD%E6%B6%88%E6%81%AF%E5%8F%91%E5%B8%83%E4%B8%8E%E6%9D%83%E8%A1%A1/pic2.png" srcset="/img/loading.gif" class>

<p>åˆ›å»ºç”Ÿäº§è€…</p>
<pre><code class="java">public class FanoutProducer {

    public final static String EXCHANGE_NAME = &quot;fanout_logs&quot;;

    public final static String[] ROUTE_KEYS = {&quot;route_key_1&quot;, &quot;route_key_2&quot;, &quot;route_key_3&quot;};

    public static void main(String[] args) throws IOException, TimeoutException {
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost(&quot;127.0.0.1&quot;);
        Connection connection = factory.newConnection();
        Channel channel = connection.createChannel();
        channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.FANOUT);

        for (int i = 0; i &lt; 3; i++) {
            String routekey = ROUTE_KEYS[i % 3];
            String message = &quot;Hello World_&quot; + (i + 1);
            channel.basicPublish(EXCHANGE_NAME, routekey,
                    null, message.getBytes());
            System.out.println(&quot; [x] Sent &#39;&quot; + routekey + &quot;&#39;:&#39;&quot;
                    + message + &quot;&#39;&quot;);
        }
        channel.close();
        connection.close();
    }
}</code></pre>
<p>åˆ›å»ºæ¶ˆè´¹è€…1ï¼Œæ³¨æ„ï¼Œæ­¤æ—¶æ¶ˆè´¹è€…ä¸å—è·¯ç”±é”®çš„å½±å“ï¼Œå°±ç®—ä¸ç»‘å®šç”Ÿäº§è€…çš„è·¯ç”±é”®ä»ç„¶å¯ä»¥æ¥æ”¶åˆ°æ¶ˆæ¯ã€‚</p>
<pre><code class="java">public class Consumer1 {

    public static void main(String[] argv) throws IOException, TimeoutException {
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost(&quot;127.0.0.1&quot;);
        Connection connection = factory.newConnection();
        final Channel channel = connection.createChannel();
        channel.exchangeDeclare(FanoutProducer.EXCHANGE_NAME,
                BuiltinExchangeType.FANOUT);
        String queueName = channel.queueDeclare().getQueue();
        for (String routekey : FanoutProducer.ROUTE_KEYS) {
            channel.queueBind(queueName, FanoutProducer.EXCHANGE_NAME,
                    routekey);
        }
        System.out.println(&quot; [&quot; + queueName + &quot;] Waiting for messages:&quot;);
        final Consumer consumerA = new DefaultConsumer(channel) {
            @Override
            public void handleDelivery(String consumerTag, Envelope envelope,
                                       AMQP.BasicProperties properties, byte[] body)
                    throws IOException {
                String message = new String(body, &quot;UTF-8&quot;);
                System.out.println(&quot;Received &quot; + envelope.getRoutingKey() + &quot;&#39;:&#39;&quot; + message + &quot;&#39;&quot;);
            }
        };
        channel.basicConsume(queueName, true, consumerA);
    }
}</code></pre>
<p>æ¶ˆè´¹è€…2ï¼Œæ³¨æ„è¿™æ—¶ç»‘å®šçš„æ˜¯ä¸€ä¸ªä¸å­˜åœ¨çš„è·¯ç”±é”®ï¼Œå¹¿æ’­äº¤æ¢å™¨ä¸ä¼šå—è·¯ç”±é”®å½±å“ï¼Œæ­¤æ—¶æ¶ˆè´¹è€…2ä»ç„¶å¯ä»¥æ¥æ”¶åˆ°æ‰€æœ‰æ¶ˆæ¯ã€‚</p>
<pre><code class="java">public class Consumer2 {

    public static void main(String[] argv) throws IOException, TimeoutException {
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost(&quot;127.0.0.1&quot;);
        Connection connection = factory.newConnection();
        final Channel channel = connection.createChannel();
        channel.exchangeDeclare(FanoutProducer.EXCHANGE_NAME,
                BuiltinExchangeType.FANOUT);
        String queueName = channel.queueDeclare().getQueue();
        //è®¾ç½®ä¸€ä¸ªä¸å­˜åœ¨çš„è·¯ç”±é”®
        String routekey=&quot;xxx&quot;;
        channel.queueBind(queueName, FanoutProducer.EXCHANGE_NAME, routekey);
        System.out.println(&quot; [*] Waiting for messages......&quot;);
        final Consumer consumerB = new DefaultConsumer(channel) {
            @Override
            public void handleDelivery(String consumerTag,
                                       Envelope envelope,
                                       AMQP.BasicProperties properties,
                                       byte[] body)
                    throws IOException {
                String message = new String(body, &quot;UTF-8&quot;);
                System.out.println( &quot;Received [&quot;+ envelope.getRoutingKey()
                        + &quot;] &quot;+message);
            }
        };
        channel.basicConsume(queueName, true, consumerB);
    }
}</code></pre>
<h3 id="Topicäº¤æ¢å™¨"><a href="#Topicäº¤æ¢å™¨" class="headerlink" title="Topicäº¤æ¢å™¨"></a>Topicäº¤æ¢å™¨</h3><img src="/2020/05/08/RabbitMQ%E4%B8%AD%E6%B6%88%E6%81%AF%E5%8F%91%E5%B8%83%E4%B8%8E%E6%9D%83%E8%A1%A1/pic4.png" srcset="/img/loading.gif" class>

<p>åˆ›å»ºç”Ÿäº§è€…</p>
<pre><code class="java">public class TopicProducer {

    public final static String EXCHANGE_NAME = &quot;topic_course&quot;;

    public static void main(String[] args)
            throws IOException, TimeoutException {
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost(&quot;127.0.0.1&quot;);
        Connection connection = factory.newConnection();
        Channel channel = connection.createChannel();
        //åˆ›å»ºä¸»é¢˜
        channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.TOPIC);
        String[] types = {&quot;TYPE_A&quot;, &quot;TYPE_B&quot;, &quot;TYPE_C&quot;};
        for (int i = 0; i &lt; 3; i++) {
            String[] modules = {&quot;moduleA&quot;, &quot;moduleB&quot;, &quot;moduleC&quot;};
            for (int j = 0; j &lt; 3; j++) {
                String[] status = {&quot;0&quot;, &quot;1&quot;, &quot;2&quot;};
                for (int k = 0; k &lt; 3; k++) {
                    // å‘é€çš„æ¶ˆæ¯
                    String message = &quot;Hello Topic_[&quot; + i + &quot;,&quot; + j + &quot;,&quot; + k + &quot;]&quot;;
                    String routeKey = types[i % 3] + &quot;.&quot; + modules[j % 3]
                            + &quot;.&quot; + status[k % 3];
                    channel.basicPublish(EXCHANGE_NAME, routeKey,
                            null, message.getBytes());
                    System.out.println(&quot; [x] Sent &#39;&quot; + routeKey + &quot;:&#39;&quot;
                            + message + &quot;&#39;&quot;);
                }
            }
        }
        channel.close();
        connection.close();
    }
}</code></pre>
<p>åˆ›å»º<code>#</code>ç±»å‹çš„æ¶ˆè´¹è€…ï¼Œè¯¥æ¶ˆè´¹è€…å°†è®¢é˜…æ‰€æœ‰æ¶ˆæ¯</p>
<pre><code class="java">public class AllConsumer {

    public static void main(String[] argv) throws IOException, TimeoutException {
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost(&quot;127.0.0.1&quot;);
        Connection connection = factory.newConnection();
        final Channel channel = connection.createChannel();
        channel.exchangeDeclare(TopicProducer.EXCHANGE_NAME,
                BuiltinExchangeType.TOPIC);
        String queueName = channel.queueDeclare().getQueue();
        //ç»‘å®š
        channel.queueBind(queueName,TopicProducer.EXCHANGE_NAME, &quot;#&quot;);
        System.out.println(&quot; [*] Waiting for messages:&quot;);
        final Consumer consumerA = new DefaultConsumer(channel) {
            @Override
            public void handleDelivery(String consumerTag,
                                       Envelope envelope,
                                       AMQP.BasicProperties properties,
                                       byte[] body)
                    throws IOException {
                String message = new String(body, &quot;UTF-8&quot;);
                System.out.println(&quot; AllConsumer Received &quot;
                        + envelope.getRoutingKey()
                        + &quot;&#39;:&#39;&quot; + message + &quot;&#39;&quot;);
            }
        };
        channel.basicConsume(queueName, true, consumerA);
    }
}</code></pre>
<p>åˆ›å»º<code>TYPE_A.#</code>ç±»å‹çš„æ¶ˆè´¹è€…ï¼Œè¯¥æ¶ˆè´¹è€…å°†æ¥æ”¶æ‰€æœ‰ç¬¬ä¸€ä½ä¸º<code>TYPE_A</code>çš„æ¶ˆæ¯ã€‚</p>
<pre><code class="java">public class TypeConsumer {

    public static void main(String[] argv) throws IOException, TimeoutException {
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost(&quot;127.0.0.1&quot;);
        Connection connection = factory.newConnection();
        final Channel channel = connection.createChannel();
        channel.exchangeDeclare(TopicProducer.EXCHANGE_NAME,
                BuiltinExchangeType.TOPIC);
        String queueName = channel.queueDeclare().getQueue();
        channel.queueBind(queueName, TopicProducer.EXCHANGE_NAME,
                &quot;TYPE_A.#&quot;);
        System.out.println(&quot; [*] Waiting for messages:&quot;);
        final Consumer consumerA = new DefaultConsumer(channel) {
            @Override
            public void handleDelivery(String consumerTag,
                                       Envelope envelope,
                                       AMQP.BasicProperties properties,
                                       byte[] body)
                    throws IOException {
                String message = new String(body, &quot;UTF-8&quot;);
                System.out.println(&quot; AllConsumer Received &quot;
                        + envelope.getRoutingKey()
                        + &quot;&#39;:&#39;&quot; + message + &quot;&#39;&quot;);
            }
        };
        channel.basicConsume(queueName, true, consumerA);
    }
}</code></pre>
<p>åˆ›å»º<code>*.moduleA.*</code>ç±»å‹çš„æ¶ˆè´¹è€…ï¼Œè¯¥æ¶ˆè´¹è€…å°†æ¥æ”¶æ‰€æœ‰ç¬¬äºŒä½ä¸º<code>moduleA</code>çš„æ¶ˆæ¯</p>
<pre><code class="java">public class ModuleConsumer {

    public static void main(String[] argv) throws IOException, TimeoutException {
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost(&quot;127.0.0.1&quot;);
        Connection connection = factory.newConnection();
        final Channel channel = connection.createChannel();

        channel.exchangeDeclare(TopicProducer.EXCHANGE_NAME,
                BuiltinExchangeType.TOPIC);
        String queueName = channel.queueDeclare().getQueue();
        channel.queueBind(queueName, TopicProducer.EXCHANGE_NAME, &quot;*.moduleA.*&quot;);
        System.out.println(&quot; [*] Waiting for messages:&quot;);
        final Consumer consumerA = new DefaultConsumer(channel) {
            @Override
            public void handleDelivery(String consumerTag,
                                       Envelope envelope,
                                       AMQP.BasicProperties properties,
                                       byte[] body)
                    throws IOException {
                String message = new String(body, &quot;UTF-8&quot;);
                System.out.println(&quot; AllConsumer Received &quot;
                        + envelope.getRoutingKey()
                        + &quot;&#39;:&#39;&quot; + message + &quot;&#39;&quot;);
            }
        };
        channel.basicConsume(queueName, true, consumerA);
    }
}</code></pre>
<p>åŒæ ·ï¼Œè¿˜å¯ä»¥åˆ›å»º<code>#.0</code>ã€<code>*.moduleA.1</code>ã€<code>TYPE_B.moduleC.2</code>ç­‰ç±»å‹çš„æ¶ˆè´¹è€…ï¼Œæ¥åŒ¹é…å¯¹åº”çš„æ¶ˆæ¯ã€‚</p>
<h2 id="æ¶ˆæ¯å‘å¸ƒæ—¶çš„æƒè¡¡"><a href="#æ¶ˆæ¯å‘å¸ƒæ—¶çš„æƒè¡¡" class="headerlink" title="æ¶ˆæ¯å‘å¸ƒæ—¶çš„æƒè¡¡"></a>æ¶ˆæ¯å‘å¸ƒæ—¶çš„æƒè¡¡</h2><p>ä¸åšä»»ä½•é…ç½®çš„æƒ…å†µä¸‹ï¼Œç”Ÿäº§è€…æ˜¯ä¸çŸ¥é“æ¶ˆæ¯æ˜¯å¦çœŸæ­£åˆ°è¾¾äº†RabbitMQï¼Œä¹Ÿå°±æ˜¯è¯´æ¶ˆæ¯å‘å¸ƒæ“ä½œä¸è¿”å›ä»»ä½•ä¿¡æ¯ç»™ç”Ÿäº§è€…ï¼Œé€šå¸¸æœ‰ä»¥ä¸‹å‡ ç§æ–¹å¼æ¥ä¿è¯æ¶ˆæ¯çš„å¯é æ€§ã€‚</p>
<img src="/2020/05/08/RabbitMQ%E4%B8%AD%E6%B6%88%E6%81%AF%E5%8F%91%E5%B8%83%E4%B8%8E%E6%9D%83%E8%A1%A1/pic1.png" srcset="/img/loading.gif" class>

<p>åœ¨RabbitMQä¸­ï¼Œæœ‰ä¸åŒçš„æŠ•é€’æœºåˆ¶ï¼ˆç”Ÿäº§è€…ï¼‰ï¼Œä½†æ˜¯æ¯ä¸€ç§æœºåˆ¶éƒ½å¯¹æ€§èƒ½æœ‰ä¸€å®šçš„å½±å“ã€‚ä¸€èˆ¬æ¥è®²é€Ÿåº¦å¿«çš„å¯é æ€§ä½ï¼Œå¯é æ€§å¥½çš„æ€§èƒ½å·®ï¼Œå…·ä½“æ€ä¹ˆä½¿ç”¨éœ€è¦æ ¹æ®åº”ç”¨ç¨‹åºæ¥å®šï¼Œæ‰€ä»¥è¯´æ²¡æœ‰æœ€å¥½çš„æ–¹å¼ï¼Œåªæœ‰æœ€åˆé€‚çš„æ–¹å¼ã€‚</p>
<p>åœ¨RabbitMQä¸­å®é™…é¡¹ç›®ä¸­ï¼Œç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…éƒ½æ˜¯å®¢æˆ·ç«¯ï¼Œå®ƒä»¬éƒ½å¯ä»¥å®Œæˆäº¤æ¢å™¨ã€é˜Ÿåˆ—å’Œç»‘å®šå…³ç³»çš„ç”³æ˜ï¼Œä½†æ˜¯åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œé€šå¸¸åœ¨ç”Ÿäº§è€…ä»£ç ä¸­ç”³æ˜äº¤æ¢å™¨ï¼Œåœ¨æ¶ˆè´¹è€…ä»£ç ä¸­ç”³æ˜é˜Ÿåˆ—å’Œç»‘å®šå…³ç³»ã€‚ä½†ç”Ÿäº§è€…å‘å¸ƒæ¶ˆæ¯æ—¶ä¸ä¸€å®šéå¾—éœ€è¦æ¶ˆè´¹è€…ï¼Œå¯¹äºRabbitMQæ¥è¯´ï¼Œå¦‚æœæ˜¯å•çº¯çš„ç”Ÿäº§è€…å°±åªéœ€è¦ç”Ÿäº§è€…å®¢æˆ·ç«¯ç”³æ˜äº¤æ¢å™¨ã€é˜Ÿåˆ—ã€ç¡®å®šç»‘å®šå…³ç³»ï¼Œå°±å¯ä»¥å°†æ¶ˆæ¯å‘é€è‡³RabbitMQã€‚</p>
<h3 id="æ— ä¿éšœ"><a href="#æ— ä¿éšœ" class="headerlink" title="æ— ä¿éšœ"></a>æ— ä¿éšœ</h3><p>åœ¨æ¼”ç¤ºå„ç§äº¤æ¢å™¨ä¸­ä½¿ç”¨çš„å°±æ˜¯æ— ä¿éšœçš„æ–¹å¼ï¼Œé€šè¿‡basicPublishå‘å¸ƒä½ çš„æ¶ˆæ¯å¹¶ä½¿ç”¨æ­£ç¡®çš„äº¤æ¢å™¨å’Œè·¯ç”±ä¿¡æ¯ï¼Œä½ çš„æ¶ˆæ¯ä¼šè¢«æ¥æ”¶å¹¶å‘é€åˆ°åˆé€‚çš„é˜Ÿåˆ—ä¸­ã€‚ä½†æ˜¯å¦‚æœæœ‰ç½‘ç»œé—®é¢˜ï¼Œæˆ–è€…æ¶ˆæ¯ä¸å¯è·¯ç”±ï¼Œæˆ–è€…RabbitMQè‡ªèº«æœ‰é—®é¢˜çš„è¯ï¼Œè¿™ç§æ–¹å¼å°±æœ‰é£é™©ã€‚æ‰€ä»¥æ— ä¿è¯çš„æ¶ˆæ¯å‘é€ä¸€èˆ¬æƒ…å†µä¸‹ä¸æ¨èã€‚</p>
<h3 id="å¤±è´¥ç¡®è®¤"><a href="#å¤±è´¥ç¡®è®¤" class="headerlink" title="å¤±è´¥ç¡®è®¤"></a>å¤±è´¥ç¡®è®¤</h3><p>åœ¨å‘é€æ¶ˆæ¯æ—¶è®¾ç½®mandatoryæ ‡å¿—ï¼Œå‘Šè¯‰RabbitMQï¼Œå¦‚æœæ¶ˆæ¯ä¸å¯è·¯ç”±ï¼Œåº”è¯¥å°†æ¶ˆæ¯è¿”å›ç»™å‘é€è€…ï¼Œå¹¶é€šçŸ¥å¤±è´¥ã€‚å¯ä»¥è¿™æ ·è®¤ä¸ºï¼Œå¼€å¯mandatoryæ˜¯å¼€å¯æ•…éšœæ£€æµ‹æ¨¡å¼ã€‚<br>ä½†æ˜¯å®ƒåªä¼šè®©RabbitMQå‘ä½ é€šçŸ¥å¤±è´¥ï¼Œè€Œä¸ä¼šé€šçŸ¥æˆåŠŸã€‚å¦‚æœæ¶ˆæ¯æ­£ç¡®è·¯ç”±åˆ°é˜Ÿåˆ—ï¼Œåˆ™å‘å¸ƒè€…ä¸ä¼šæ”¶åˆ°ä»»ä½•é€šçŸ¥ã€‚å¸¦æ¥çš„é—®é¢˜æ˜¯æ— æ³•ç¡®ä¿å‘å¸ƒæ¶ˆæ¯ä¸€å®šæ˜¯æˆåŠŸçš„ï¼Œå› ä¸ºé€šçŸ¥å¤±è´¥çš„æ¶ˆæ¯å¯èƒ½ä¼šä¸¢å¤±ã€‚</p>
<p>å…·ä½“ä½¿ç”¨ï¼š</p>
<pre><code class="java">public class DirectProducer {

    public final static String EXCHANGE_NAME = &quot;direct_logs&quot;;

    public final static String[] ROUTE_KEYS = {&quot;route_key_1&quot;, &quot;route_key_2&quot;, &quot;route_key_3&quot;};

    public static void main(String[] args)
            throws IOException, TimeoutException, InterruptedException {
        ConnectionFactory connectionFactory = new ConnectionFactory();
        connectionFactory.setHost(&quot;localhost&quot;);
        Connection connection = connectionFactory.newConnection();
        Channel channel = connection.createChannel();
        channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.DIRECT);

        //æ¶ˆæ¯å‘é€å¤±è´¥æ—¶å›è°ƒ
        channel.addReturnListener(new ReturnListener() {
            public void handleReturn(int replyCode, String replyText, String exchange, String routeKey, AMQP.BasicProperties basicProperties, byte[] bytes) throws IOException {
                String string = new String(bytes);
                System.out.println(&quot;å›è°ƒå†…å®¹ï¼šreplyCodeï¼š&quot; + replyCode);
                System.out.println(&quot;å›è°ƒå†…å®¹ï¼šreplyTextï¼š&quot; + replyText);
                System.out.println(&quot;å›è°ƒå†…å®¹ï¼šexchangeï¼š&quot; + exchange);
                System.out.println(&quot;å›è°ƒå†…å®¹ï¼šrouteKeyï¼š&quot; + routeKey);
                System.out.println(&quot;å›è°ƒå†…å®¹ï¼šcontentï¼š&quot; + string);
            }
        });

        //è¿æ¥å…³é—­æ—¶çš„å›è°ƒ
        connection.addShutdownListener(new ShutdownListener() {
            public void shutdownCompleted(ShutdownSignalException e) {

            }
        });

        //ä¿¡é“å…³é—­æ—¶çš„å›æ‰
        channel.addShutdownListener(new ShutdownListener() {
            public void shutdownCompleted(ShutdownSignalException e) {

            }
        });
        for (int i = 0; i &lt; 6; i++) {
            String routeKey = ROUTE_KEYS[i % 3];
            String msg = &quot;Hello,RabbitMQ&quot; + (i + 1);
            //å‘å¸ƒæ¶ˆæ¯ ç¬¬ä¸‰ä¸ªå‚æ•°ä¸ºtrueè¡¨ç¤ºå¼€å¯å¤±è´¥é€šçŸ¥
            channel.basicPublish(EXCHANGE_NAME, routeKey, true, null, msg.getBytes());
            System.out.println(&quot;Sent:&quot; + routeKey + &quot;:&quot; + msg);
            TimeUnit.MICROSECONDS.sleep(200);
        }
        channel.close();
        connection.close();
    }
}</code></pre>
<h3 id="äº‹åŠ¡"><a href="#äº‹åŠ¡" class="headerlink" title="äº‹åŠ¡"></a>äº‹åŠ¡</h3><p>äº‹åŠ¡çš„å®ç°ä¸»è¦æ˜¯å¯¹ä¿¡é“ï¼ˆChannelï¼‰çš„è®¾ç½®ï¼Œä¸»è¦çš„æ–¹æ³•æœ‰ä¸‰ä¸ª:</p>
<ol>
<li>channel.txSelect()å£°æ˜å¯åŠ¨äº‹åŠ¡æ¨¡å¼;</li>
<li>channel.txComment()æäº¤äº‹åŠ¡;</li>
<li>channel.txRollback()å›æ»šäº‹åŠ¡;</li>
</ol>
<p>åœ¨å‘é€æ¶ˆæ¯ä¹‹å‰ï¼Œéœ€è¦å£°æ˜channelä¸ºäº‹åŠ¡æ¨¡å¼ï¼Œæäº¤æˆ–è€…å›æ»šäº‹åŠ¡å³å¯ã€‚ å¼€å¯äº‹åŠ¡åï¼Œå®¢æˆ·ç«¯å’ŒRabbitMQä¹‹é—´çš„é€šè®¯äº¤äº’æµç¨‹:</p>
<ul>
<li>å®¢æˆ·ç«¯å‘é€ç»™æœåŠ¡å™¨ Tx.Select(å¼€å¯äº‹åŠ¡æ¨¡å¼)</li>
<li>æœåŠ¡å™¨ç«¯è¿”å› Tx.Select-Ok(å¼€å¯äº‹åŠ¡æ¨¡å¼ ok) ï‚· æ¨é€æ¶ˆæ¯</li>
<li>å®¢æˆ·ç«¯å‘é€ç»™äº‹åŠ¡æäº¤ Tx.Commit</li>
</ul>
<p>æœåŠ¡å™¨ç«¯è¿”å› Tx.Commit-Ok<br>ä»¥ä¸Šå°±å®Œæˆäº†äº‹åŠ¡çš„äº¤äº’æµç¨‹ï¼Œå¦‚æœå…¶ä¸­ä»»æ„ä¸€ä¸ªç¯èŠ‚å‡ºç°é—®é¢˜ï¼Œå°±ä¼šæŠ›å‡º IoExceptionï¼Œè¿™æ ·ç”¨æˆ·å°±å¯ä»¥æ‹¦æˆªå¼‚å¸¸è¿›è¡Œäº‹åŠ¡å›æ»šï¼Œæˆ–å†³å®šè¦ä¸è¦é‡å¤æ¶ˆæ¯ã€‚</p>
<p>ä½†æ˜¯äº‹åŠ¡æœºåˆ¶æœ¬èº«ä¹Ÿä¼šå¸¦æ¥é—®é¢˜ï¼š</p>
<ol>
<li><p>ä¸¥é‡çš„æ€§èƒ½é—®é¢˜ï¼ŒåŠ å…¥äº‹åŠ¡åå°†ä¼šå¯¼è‡´2-10å€çš„æ€§èƒ½ä¸‹é™ã€‚</p>
</li>
<li><p>ä½¿åº”ç”¨ç¨‹åºäº§ç”ŸåŒæ­¥ã€‚</p>
</li>
</ol>
<p>å…·ä½“ä½¿ç”¨ï¼š</p>
<pre><code class="java">public class ProducerTransaction {
    public final static String EXCHANGE_NAME = &quot;producer_transaction&quot;;
    public static void main(String[] args)
            throws IOException, TimeoutException, InterruptedException {
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost(&quot;127.0.0.1&quot;);
        Connection connection = factory.newConnection();
        Channel channel = connection.createChannel();
        channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.DIRECT);
        String[] routekeys={&quot;keys1&quot;,&quot;keys2&quot;,&quot;keys3&quot;};
        //å¼€å¯äº‹åŠ¡
        channel.txSelect();
        try {
            for(int i=0;i&lt;3;i++){
                String routekey = routekeys[i%3];
                String message = &quot;Hello World_&quot;+(i+1)
                        +(&quot;_&quot;+System.currentTimeMillis());
                channel.basicPublish(EXCHANGE_NAME, routekey, true,
                        null, message.getBytes());
                System.out.println(&quot;----------------------------------&quot;);
                System.out.println(&quot; Sent Message: [&quot; + routekey +&quot;]:&#39;&quot;
                        + message + &quot;&#39;&quot;);
                Thread.sleep(200);
            }
            //äº‹åŠ¡æäº¤
            channel.txCommit();
        } catch (IOException e) {
            e.printStackTrace();
            //äº‹åŠ¡å›æ»š
            channel.txRollback();
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        channel.close();
        connection.close();
    }
}</code></pre>
<h3 id="å‘å¸ƒè€…ç¡®è®¤"><a href="#å‘å¸ƒè€…ç¡®è®¤" class="headerlink" title="å‘å¸ƒè€…ç¡®è®¤"></a>å‘å¸ƒè€…ç¡®è®¤</h3><p>åŸºäºäº‹åŠ¡çš„æ€§èƒ½é—®é¢˜ï¼ŒRabbitMQå›¢é˜Ÿä¸ºæˆ‘ä»¬æ‹¿å‡ºäº†æ›´å¥½çš„æ–¹æ¡ˆï¼Œå³é‡‡ç”¨å‘é€æ–¹ç¡®è®¤æ¨¡å¼ï¼Œè¯¥æ¨¡å¼æ¯”äº‹åŠ¡æ›´è½»é‡ï¼Œæ€§èƒ½å½±å“å‡ ä¹å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚</p>
<p>åŸç†ï¼šç”Ÿäº§è€…å°†ä¿¡é“è®¾ç½®æˆconfirmæ¨¡å¼ï¼Œä¸€æ—¦ä¿¡é“è¿›å…¥confirmæ¨¡å¼ï¼Œæ‰€æœ‰åœ¨è¯¥ä¿¡é“ä¸Šé¢å‘å¸ƒçš„æ¶ˆæ¯éƒ½å°†ä¼šè¢«æŒ‡æ´¾ä¸€ä¸ªå”¯ä¸€çš„IDï¼ˆä»1å¼€å§‹ï¼‰ï¼Œç”±è¿™ä¸ªidåœ¨ç”Ÿäº§è€…å’ŒRabbitMQä¹‹é—´è¿›è¡Œæ¶ˆæ¯çš„ç¡®è®¤ã€‚</p>
<p>ä¸å¯è·¯ç”±çš„æ¶ˆæ¯ï¼Œå½“äº¤æ¢å™¨å‘ç°æ¶ˆæ¯ä¸èƒ½è·¯ç”±åˆ°ä»»ä½•é˜Ÿåˆ—ï¼Œä¼šè¿›è¡Œå¤±è´¥ç¡®è®¤æ“ä½œï¼Œè¡¨ç¤ºæ”¶åˆ°äº†æ¶ˆæ¯ã€‚å¦‚æœå‘é€æ–¹è®¾ç½®äº†mandatoryæ¨¡å¼ï¼Œåˆ™ä¼šè°ƒç”¨addReturnListener()æ–¹æ³•è®¾ç½®çš„ç›‘å¬å™¨ã€‚</p>
<p>å¯è·¯ç”±çš„æ¶ˆæ¯ï¼Œè¦ç­‰åˆ°æ¶ˆæ¯è¢«æŠ•é€’åˆ°æ‰€æœ‰åŒ¹é…çš„é˜Ÿåˆ—ä¹‹åï¼Œbrokerä¼šå‘é€ä¸€ä¸ªç¡®è®¤ç»™ç”Ÿäº§è€…ï¼ˆåŒ…å«æ¶ˆæ¯çš„å”¯ä¸€IDï¼‰ï¼Œå¦‚æœæ¶ˆæ¯å’Œé˜Ÿåˆ—æ˜¯å¯æŒä¹…åŒ–çš„ï¼Œé‚£ä¹ˆç¡®è®¤æ¶ˆæ¯ä¼šåœ¨å°†æ¶ˆæ¯å†™å…¥ç£ç›˜ä¹‹åå‘å‡ºï¼Œbrokerå›ä¼ ç»™ç”Ÿäº§è€…çš„ç¡®è®¤æ¶ˆæ¯ä¸­çš„delivery-tagåŸŸåŒ…å«äº†ç¡®è®¤æ¶ˆæ¯çš„åºåˆ—å·ã€‚</p>
<img src="/2020/05/08/RabbitMQ%E4%B8%AD%E6%B6%88%E6%81%AF%E5%8F%91%E5%B8%83%E4%B8%8E%E6%9D%83%E8%A1%A1/pic5.png" srcset="/img/loading.gif" class>

<p>confirmæ¨¡å¼æœ€å¤§çš„å¥½å¤„åœ¨äºä»–å¯ä»¥æ˜¯å¼‚æ­¥çš„ï¼Œæ¶ˆæ¯å‘é€å®Œæˆåç”Ÿäº§è€…å¯ä»¥åœ¨ç­‰ä¿¡é“è¿”å›æ—¶ï¼Œç»§ç»­å‘é€ä¸‹ä¸€æ¡æ¶ˆæ¯ï¼Œå½“æ¶ˆæ¯æœ€ç»ˆå¾—åˆ°ç¡®è®¤ä¹‹åï¼Œç”Ÿäº§è€…å¯ä»¥é€šè¿‡å›è°ƒæ–¹æ³•æ¥å¤„ç†è¯¥ç¡®è®¤æ¶ˆæ¯ï¼Œå¦‚æœRabbitMQå› ä¸ºè‡ªèº«å†…éƒ¨é”™è¯¯å¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ï¼Œå°±ä¼šå‘é€ä¸€æ¡nackæ¶ˆæ¯ï¼Œç”Ÿäº§è€…åº”ç”¨ç¨‹åºåŒæ ·å¯ä»¥åœ¨å›è°ƒæ–¹æ³•ä¸­å¤„ç†è¯¥nackæ¶ˆæ¯å†³å®šä¸‹ä¸€æ­¥çš„æ“ä½œã€‚ </p>
<p>Confirmçš„ä¸‰ç§å®ç°æ–¹å¼ï¼š</p>
<ul>
<li><p>channel.waitForConfirms()æ™®é€šå‘é€æ–¹ç¡®è®¤æ¨¡å¼ï¼Œæ¶ˆæ¯åˆ°è¾¾äº¤æ¢å™¨å°±ä¼šè¿”å›trueã€‚</p>
<pre><code class="java">public class ProducerConfirm {

    public final static String EXCHANGE_NAME = &quot;producer_confirm&quot;;
    private final static String ROUTE_KEY = &quot;test&quot;;

    public static void main(String[] args) throws IOException, TimeoutException, InterruptedException {
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost(&quot;127.0.0.1&quot;);
        Connection connection = factory.newConnection();
        Channel channel = connection.createChannel();
        channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.DIRECT);
        channel.addReturnListener(new ReturnListener() {
            public void handleReturn(int replyCode, String replyText,
                                     String exchange, String routingKey,
                                     AMQP.BasicProperties properties,
                                     byte[] body)
                    throws IOException {
                String message = new String(body);
                System.out.println(&quot;RabbitMqè¿”å›çš„replyCode:  &quot; + replyCode);
                System.out.println(&quot;RabbitMqè¿”å›çš„replyText:  &quot; + replyText);
                System.out.println(&quot;RabbitMqè¿”å›çš„exchange:  &quot; + exchange);
                System.out.println(&quot;RabbitMqè¿”å›çš„routingKey:  &quot; + routingKey);
                System.out.println(&quot;RabbitMqè¿”å›çš„message:  &quot; + message);
            }
        });
        // å¯ç”¨å‘é€è€…ç¡®è®¤æ¨¡å¼
        channel.confirmSelect();
        for (int i = 0; i &lt; 2; i++) {
            String message = &quot;Hello World_&quot; + (i + 1);
            channel.basicPublish(EXCHANGE_NAME, ROUTE_KEY, true, null, message.getBytes());
            System.out.println(&quot; Sent Message: [&quot; + ROUTE_KEY + &quot;]:&#39;&quot; + message + &quot;&#39;&quot;);
            //ç¡®è®¤æ˜¯å¦æˆåŠŸ(trueæˆåŠŸ)
            if (channel.waitForConfirms()) {
                System.out.println(&quot;send success&quot;);
            } else {
                System.out.println(&quot;send failure&quot;);
            }
        }
        channel.close();
        connection.close();
    }
}</code></pre>
</li>
<li><p>channel.waitForConfirmsOrDie()æ‰¹é‡ç¡®è®¤æ¨¡å¼ï¼Œä½¿ç”¨åŒæ­¥æ–¹å¼ç­‰æ‰€æœ‰çš„æ¶ˆæ¯å‘é€ä¹‹åæ‰ä¼šæ‰§è¡Œåé¢ä»£ç ï¼Œåªè¦æœ‰ä¸€ä¸ªæ¶ˆæ¯æœªåˆ°è¾¾äº¤æ¢å™¨å°±ä¼š æŠ›å‡ºIOExceptionå¼‚å¸¸ã€‚</p>
<pre><code class="java">public class ProducerBatchConfirm {

    public final static String EXCHANGE_NAME = &quot;producer_wait_confirm&quot;;
    private final static String ROUTE_KEY = &quot;test&quot;;

    public static void main(String[] args) throws IOException, TimeoutException, InterruptedException {
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost(&quot;127.0.0.1&quot;);
        Connection connection = factory.newConnection();
        Channel channel = connection.createChannel();
        channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.DIRECT);
        channel.addReturnListener(new ReturnListener() {
            public void handleReturn(int replyCode, String replyText,
                                     String exchange, String routingKey,
                                     AMQP.BasicProperties properties,
                                     byte[] body)
                    throws IOException {
                String message = new String(body);
                System.out.println(&quot;RabbitMqè¿”å›çš„replyCode:  &quot; + replyCode);
                System.out.println(&quot;RabbitMqè¿”å›çš„replyText:  &quot; + replyText);
                System.out.println(&quot;RabbitMqè¿”å›çš„exchange:  &quot; + exchange);
                System.out.println(&quot;RabbitMqè¿”å›çš„routingKey:  &quot; + routingKey);
                System.out.println(&quot;RabbitMqè¿”å›çš„message:  &quot; + message);
            }
        });
        // å¯ç”¨å‘é€è€…ç¡®è®¤æ¨¡å¼
        channel.confirmSelect();
        for (int i = 0; i &lt; 10; i++) {
            String message = &quot;Hello World_&quot; + (i + 1);
            channel.basicPublish(EXCHANGE_NAME, ROUTE_KEY, true, null, message.getBytes());
            System.out.println(&quot; Sent Message: [&quot; + ROUTE_KEY + &quot;]:&#39;&quot; + message + &quot;&#39;&quot;);
        }
        // æ‰¹é‡ç¡®è®¤ï¼Œå¦‚æœå¤±è´¥ä¼šæŠ›å‡ºå¼‚å¸¸
        channel.waitForConfirmsOrDie();
        channel.close();
        connection.close();
    }
}</code></pre>
</li>
<li><p>channel.addConfirmListener()å¼‚æ­¥ç›‘å¬å‘é€æ–¹ç¡®è®¤æ¨¡å¼ã€‚</p>
<pre><code class="java">public class ProducerConfirmAsync {

    public final static String EXCHANGE_NAME = &quot;producer_async_confirm&quot;;

    public static void main(String[] args) throws IOException, TimeoutException, InterruptedException {
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost(&quot;127.0.0.1&quot;);
        Connection connection = factory.newConnection();
        Channel channel = connection.createChannel();
        channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.DIRECT);
        // å¯ç”¨å‘é€è€…ç¡®è®¤æ¨¡å¼
        channel.confirmSelect();
        // æ·»åŠ å‘é€è€…ç¡®è®¤ç›‘å¬å™¨
        channel.addConfirmListener(new ConfirmListener() {
            public void handleAck(long deliveryTag, boolean multiple)
                    throws IOException {
                System.out.println(&quot;send_ACK:&quot;+deliveryTag+&quot;,multiple:&quot;+multiple);
            }
            public void handleNack(long deliveryTag, boolean multiple)
                    throws IOException {
                System.out.println(&quot;Error----send_NACK:&quot;+deliveryTag+&quot;,multiple:&quot;+multiple);
            }
        });

        channel.addReturnListener(new ReturnListener() {
            public void handleReturn(int replyCode, String replyText,
                                     String exchange, String routingKey,
                                     AMQP.BasicProperties properties,
                                     byte[] body)
                    throws IOException {
                String message = new String(body);
                System.out.println(&quot;RabbitMQè·¯ç”±å¤±è´¥:  &quot;+routingKey+&quot;.&quot;+message);
            }
        });
        String[] routekeys={&quot;test&quot;,&quot;test2&quot;};
        for(int i=0;i&lt;20;i++){
            String routekey = routekeys[i%2];
            String message = &quot;Hello World_&quot;+(i+1)+(&quot;_&quot;+System.currentTimeMillis());
            channel.basicPublish(EXCHANGE_NAME, routekey, true,
                    MessageProperties.PERSISTENT_BASIC, message.getBytes());
        }
    }
}</code></pre>
</li>
</ul>
<h3 id="å¤‡ç”¨äº¤æ¢å™¨"><a href="#å¤‡ç”¨äº¤æ¢å™¨" class="headerlink" title="å¤‡ç”¨äº¤æ¢å™¨"></a>å¤‡ç”¨äº¤æ¢å™¨</h3><p>åœ¨ç¬¬ä¸€æ¬¡å£°æ˜äº¤æ¢å™¨æ—¶è¢«æŒ‡å®šï¼Œç”¨æ¥æä¾›ä¸€ç§é¢„å…ˆå­˜åœ¨çš„äº¤æ¢å™¨ï¼Œå¦‚æœä¸»äº¤æ¢å™¨æ— æ³•è·¯ç”±æ¶ˆæ¯ï¼Œé‚£ä¹ˆæ¶ˆæ¯å°†è¢«è·¯ç”±åˆ°è¿™ä¸ªæ–°çš„å¤‡ç”¨äº¤æ¢å™¨ã€‚è¿™æ—¶RabbitMQä¹Ÿä¸ä¼šå‘å‘å¸ƒè€…å‘é€å¤±è´¥é€šçŸ¥ï¼Œå› ä¸ºæ¶ˆæ¯å·²ç»å‘é€è‡³å¤‡ç”¨äº¤æ¢å™¨ï¼Œè¡¨ç¤ºæ¶ˆæ¯å·²ç»è¢«è·¯ç”±äº†ã€‚æ³¨æ„ï¼Œå¤‡ç”¨äº¤æ¢å™¨å°±æ˜¯æ™®é€šçš„äº¤æ¢å™¨ï¼Œæ²¡æœ‰ä»»ä½•ç‰¹æ®Šçš„åœ°æ–¹ã€‚</p>
<p>ä½¿ç”¨å¤‡ç”¨äº¤æ¢å™¨ï¼Œå‘å¾€å¸¸ä¸€æ ·ï¼Œå£°æ˜Queueå’Œå¤‡ç”¨äº¤æ¢å™¨ï¼ŒæŠŠQueueç»‘å®šåˆ°å¤‡ç”¨äº¤æ¢å™¨ä¸Šã€‚ç„¶ååœ¨å£°æ˜ä¸»äº¤æ¢å™¨æ—¶ï¼Œé€šè¿‡äº¤æ¢å™¨çš„å‚æ•°ï¼Œalternate-exchangeï¼Œå°†å¤‡ç”¨äº¤æ¢å™¨è®¾ç½®ç»™ä¸»äº¤æ¢å™¨ã€‚å»ºè®®å¤‡ç”¨äº¤æ¢å™¨è®¾ç½®ä¸ºfaoutç±»å‹ï¼ŒQueueç»‘å®šæ—¶çš„è·¯ç”±é”®è®¾ç½®ä¸ºâ€œ#â€ã€‚</p>
<img src="/2020/05/08/RabbitMQ%E4%B8%AD%E6%B6%88%E6%81%AF%E5%8F%91%E5%B8%83%E4%B8%8E%E6%9D%83%E8%A1%A1/pic6.png" srcset="/img/loading.gif" class>

<pre><code class="java">public class BackupExProducer {

    public final static String EXCHANGE_NAME = &quot;main-exchange&quot;;
    public final static String BAK_EXCHANGE_NAME = &quot;ae&quot;;

    public static void main(String[] args)
            throws IOException, TimeoutException {
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost(&quot;127.0.0.1&quot;);
        Connection connection = factory.newConnection();
        Channel channel = connection.createChannel();
        Map&lt;String,Object&gt; argsMap = new HashMap&lt;String,Object&gt;();
        argsMap.put(&quot;alternate-exchange&quot;,BAK_EXCHANGE_NAME);
        //ä¸»äº¤æ¢å™¨
        channel.exchangeDeclare(EXCHANGE_NAME,&quot;direct&quot;,
                false,false,argsMap);
        //å¤‡ç”¨äº¤æ¢å™¨
        channel.exchangeDeclare(BAK_EXCHANGE_NAME,BuiltinExchangeType.FANOUT,
                true,false,null);
        String[] routekeys={&quot;test1&quot;,&quot;test2&quot;,&quot;test3&quot;};
        for(int i=0;i&lt;3;i++){
            String routekey = routekeys[i%3];
            String message = &quot;Hello World_&quot;+(i+1);
            channel.basicPublish(EXCHANGE_NAME, routekey,
                    null, message.getBytes());
            System.out.println(&quot; [x] Sent &#39;&quot; + routekey +&quot;&#39;:&#39;&quot;
                    + message + &quot;&#39;&quot;);
        }
        channel.close();
        connection.close();
    }

}</code></pre>
<p>ä¸»äº¤æ¢å™¨ç»‘å®šæ¶ˆè´¹è€…</p>
<pre><code class="java">public class MainConsumer {
    public static void main(String[] argv)
            throws IOException, TimeoutException {
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost(&quot;127.0.0.1&quot;);
        Connection connection = factory.newConnection();
        final Channel channel = connection.createChannel();
        String queueName = &quot;backupexchange&quot;;
        channel.queueDeclare(queueName,
                false,false,
                false,null);
        //åªç»‘å®štest1è·¯ç”±é”®
        String routekey=&quot;test1&quot;;
        channel.queueBind(queueName,
                BackupExProducer.EXCHANGE_NAME, routekey);
        System.out.println(&quot; [*] Waiting for messages......&quot;);
        final Consumer consumerB = new DefaultConsumer(channel) {
            @Override
            public void handleDelivery(String consumerTag,
                                       Envelope envelope,
                                       AMQP.BasicProperties properties,
                                       byte[] body)
                    throws IOException {
                String message = new String(body, &quot;UTF-8&quot;);
                System.out.println( &quot;Received [&quot;
                        + envelope.getRoutingKey() + &quot;] &quot;+message);
            }
        };
        channel.basicConsume(queueName, true, consumerB);
    }
}</code></pre>
<p>å‰¯äº¤æ¢å™¨ç»‘å®šæ¶ˆè´¹è€…</p>
<pre><code class="java">public class BackupExConsumer {
    public static void main(String[] argv)
            throws IOException, TimeoutException {
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost(&quot;127.0.0.1&quot;);
        Connection connection = factory.newConnection();
        final Channel channel = connection.createChannel();
        channel.exchangeDeclare(BackupExProducer.BAK_EXCHANGE_NAME,
                BuiltinExchangeType.FANOUT,
                true, false, null);
        String queueName = &quot;fetchother&quot;;
        channel.queueDeclare(queueName,
                false,false,
                false,null);
        channel.queueBind(queueName,
                BackupExProducer.BAK_EXCHANGE_NAME, &quot;#&quot;);
        System.out.println(&quot; [*] Waiting for messages......&quot;);
        final Consumer consumerB = new DefaultConsumer(channel) {
            @Override
            public void handleDelivery(String consumerTag,
                                       Envelope envelope,
                                       AMQP.BasicProperties properties,
                                       byte[] body)
                    throws IOException {
                String message = new String(body, &quot;UTF-8&quot;);
                System.out.println( &quot;Received [&quot;
                        + envelope.getRoutingKey() + &quot;] &quot;+message);
            }
        };
        channel.basicConsume(queueName, true, consumerB);
    }
}</code></pre>
<h2 id="æ¶ˆæ¯æ¶ˆè´¹æ—¶çš„æƒè¡¡"><a href="#æ¶ˆæ¯æ¶ˆè´¹æ—¶çš„æƒè¡¡" class="headerlink" title="æ¶ˆæ¯æ¶ˆè´¹æ—¶çš„æƒè¡¡"></a>æ¶ˆæ¯æ¶ˆè´¹æ—¶çš„æƒè¡¡</h2><h3 id="æ¶ˆè´¹çš„è·å–æ–¹å¼"><a href="#æ¶ˆè´¹çš„è·å–æ–¹å¼" class="headerlink" title="æ¶ˆè´¹çš„è·å–æ–¹å¼"></a>æ¶ˆè´¹çš„è·å–æ–¹å¼</h3><ul>
<li><p>æ‹‰å–Getï¼Œæ¶ˆè´¹è€…ä¸»åŠ¨ä»é˜Ÿåˆ—ä¸­æ‹‰å–æ¶ˆæ¯ã€‚</p>
<img src="/2020/05/08/RabbitMQ%E4%B8%AD%E6%B6%88%E6%81%AF%E5%8F%91%E5%B8%83%E4%B8%8E%E6%9D%83%E8%A1%A1/pic7.png" srcset="/img/loading.gif" class>

<pre><code class="java">public class GetMessageConsumer {
    public static void main(String[] argv)
            throws IOException, TimeoutException, InterruptedException {
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost(&quot;127.0.0.1&quot;);
        Connection connection = factory.newConnection();
        final Channel channel = connection.createChannel();
        channel.exchangeDeclare(GetMessageProducer.EXCHANGE_NAME,
                &quot;direct&quot;);
        String queueName = &quot;focuserror&quot;;
        channel.queueDeclare(queueName,
                false,false,
                false,null);
        String routekey=&quot;test&quot;;
        channel.queueBind(queueName,
                GetMessageProducer.EXCHANGE_NAME, routekey);
        System.out.println(&quot; [*] Waiting for messages......&quot;);
        //æ— é™å¾ªç¯æ‹‰å–
        while(true){
            //ä»æŒ‡å®šé˜Ÿåˆ—ä¸­æ‹‰å–ä¸€æ¡æ¶ˆæ¯ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºæ˜¯å¦è‡ªåŠ¨ç¡®è®¤
            GetResponse getResponse = channel.basicGet(queueName, false);
            if(null!=getResponse){
                System.out.println(&quot;received[&quot;
                        +getResponse.getEnvelope().getRoutingKey()+&quot;]&quot;
                        +new String(getResponse.getBody()));
            }
            //æ¶ˆæ¯æ‰‹åŠ¨ç¡®è®¤ï¼Œç¡®è®¤åæ¶ˆæ¯ä¼šä»é˜Ÿåˆ—ä¸­ç§»é™¤
            channel.basicAck(0,true);
            Thread.sleep(1000);
        }
    }
}</code></pre>
</li>
<li><p>æ¨é€Consumeï¼ŒrabbitMQå°†é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ä¸»åŠ¨æ¨é€ç»™æ¶ˆè´¹è€…ï¼Œä¹‹å‰çš„æ¶ˆè´¹è€…ç¤ºä¾‹éƒ½æ˜¯ä½¿ç”¨è¿™ç§æ–¹å¼ã€‚</p>
<img src="/2020/05/08/RabbitMQ%E4%B8%AD%E6%B6%88%E6%81%AF%E5%8F%91%E5%B8%83%E4%B8%8E%E6%9D%83%E8%A1%A1/pic7.png" srcset="/img/loading.gif" class>

</li>
</ul>
<h3 id="æ¶ˆæ¯çš„ç¡®è®¤"><a href="#æ¶ˆæ¯çš„ç¡®è®¤" class="headerlink" title="æ¶ˆæ¯çš„ç¡®è®¤"></a>æ¶ˆæ¯çš„ç¡®è®¤</h3><ul>
<li><p>è‡ªåŠ¨ç¡®è®¤ï¼šåœ¨ä½¿ç”¨<code>channel.basicConsume(queueName,false,consumer);</code>å£°æ˜é˜Ÿåˆ—æ—¶ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºautoAckï¼Œå½“autoAck=trueæ—¶ï¼Œä¸€æ—¦æ¶ˆè´¹è€…æ¥æ”¶åˆ°äº†æ¶ˆæ¯ï¼Œå°±è§†ä¸ºè‡ªåŠ¨ç¡®è®¤äº†æ¶ˆæ¯ã€‚å¦‚æœä¹‹åçš„å¤„ç†è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œä¹Ÿä¸ä¼šå½±å“æ¶ˆæ¯çš„ç¡®è®¤ã€‚æ‰€ä»¥å¾ˆå¤šæ—¶å€™ï¼Œéœ€è¦åœ¨æ¶ˆæ¯å¤„ç†æˆåŠŸåå†ç¡®è®¤æ¶ˆæ¯ï¼Œè¿™æ—¶å°±éœ€è¦æ‰‹åŠ¨ç¡®è®¤ã€‚</p>
</li>
<li><p>æ‰‹åŠ¨ç¡®è®¤ï¼šå½“autoAck=falseæ—¶ï¼ŒRabbitMQä¼šç­‰å¾…æ¶ˆè´¹è€…æ˜¾å¼å‘å›ackä¿¡å·åæ‰ä»å†…å­˜å’Œç£ç›˜ä¸­ï¼ˆå¦‚æœæ˜¯æŒä¹…åŒ–æ¶ˆæ¯çš„è¯ï¼Œæ¶ˆæ¯ä¼šè¢«ä¿å­˜åˆ°ç£ç›˜ä¸­ï¼‰ä¸­ç§»å»æ¶ˆæ¯ã€‚é‡‡ç”¨æ¶ˆæ¯ç¡®è®¤æœºåˆ¶åï¼Œåªè¦ä»¤autoAck=falseï¼Œæ¶ˆè´¹è€…å°±æœ‰è¶³å¤Ÿçš„æ—¶é—´å¤„ç†æ¶ˆæ¯ï¼Œä¸ç”¨æ‹…å¿ƒå¤„ç†æ¶ˆæ¯è¿‡ç¨‹ä¸­æ¶ˆè´¹è€…è¿›ç¨‹æŒ‚æ‰åæ¶ˆæ¯ä¸¢å¤±çš„é—®é¢˜ï¼Œå› ä¸ºRabbitMQä¼šä¸€ç›´æŒæœ‰æ¶ˆæ¯ç›´åˆ°æ¶ˆè´¹è€…æ˜¾å¼è°ƒç”¨basicAckä¸ºæ­¢ã€‚</p>
<p>å½“autoAck=falseæ—¶ï¼Œå¯¹äºRabbitMQæœåŠ¡å™¨ç«¯è€Œè¨€ï¼Œé˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯åˆ†æˆäº†ä¸¤éƒ¨åˆ†ï¼šä¸€éƒ¨åˆ†æ˜¯ç­‰å¾…æŠ•é€’ç»™æ¶ˆè´¹è€…çš„æ¶ˆæ¯ï¼Œä¸€éƒ¨åˆ†æ˜¯å·²ç»æŠ•é€’ç»™æ¶ˆè´¹è€…ä½†æ˜¯è¿˜æ²¡æœ‰æ”¶åˆ°æ¶ˆè´¹è€…ackä¿¡å·çš„æ¶ˆæ¯ã€‚å¦‚æœæœåŠ¡å™¨ç«¯ä¸€ç›´æ²¡æœ‰æ”¶åˆ°æ¶ˆè´¹è€…çš„ackä¿¡å·ï¼Œå¹¶ä¸”æ¶ˆè´¹æ­¤æ¶ˆæ¯çš„æ¶ˆè´¹è€…å·²ç»æ–­å¼€è¿æ¥ï¼Œåˆ™æœåŠ¡å™¨ç«¯ä¼šå®‰æ’è¯¥æ¶ˆæ¯é‡æ–°è¿›å…¥é˜Ÿåˆ—ï¼Œç­‰å¾…æŠ•é€’ç»™ä¸‹ä¸€ä¸ªæ¶ˆè´¹è€…ï¼ˆä¹Ÿå¯èƒ½è¿˜æ˜¯åŸæ¥çš„é‚£ä¸ªæ¶ˆè´¹è€…ï¼‰ã€‚</p>
</li>
</ul>
<h3 id="Qosé¢„å–æ¨¡å¼"><a href="#Qosé¢„å–æ¨¡å¼" class="headerlink" title="Qosé¢„å–æ¨¡å¼"></a>Qosé¢„å–æ¨¡å¼</h3><p>åœ¨ç¡®è®¤æ¶ˆæ¯è¢«æ¥æ”¶ä¹‹å‰ï¼Œæ¶ˆè´¹è€…å¯ä»¥é¢„å…ˆè¦æ±‚æ¥æ”¶ä¸€å®šæ•°é‡çš„æ¶ˆæ¯ï¼Œåœ¨å¤„ç†å®Œä¸€å®šæ•°é‡çš„æ¶ˆæ¯åï¼Œå¯ä»¥è¿›è¡Œæ‰¹é‡ç¡®è®¤ã€‚å¦‚æœæ¶ˆè´¹è€…åº”ç”¨ç¨‹åºåœ¨ç¡®è®¤æ¶ˆæ¯ä¹‹å‰å´©æºƒï¼Œåˆ™æ‰€æœ‰æœªç¡®è®¤çš„æ¶ˆæ¯å°†è¢«é‡æ–°å‘é€ç»™å…¶ä»–æ¶ˆè´¹è€…ã€‚è¿™ç§æœºåˆ¶ä¸€æ–¹é¢å¯ä»¥å®ç°é™é€Ÿï¼ˆå°†æ¶ˆæ¯æš‚å­˜åˆ°RabbitMQå†…å­˜ä¸­ï¼‰çš„ä½œç”¨ï¼Œä¸€æ–¹é¢å¯ä»¥ä¿è¯æ¶ˆæ¯ç¡®è®¤è´¨é‡ã€‚</p>
<p>æ³¨æ„ï¼šæ¶ˆè´¹ç¡®è®¤æ¨¡å¼å¿…é¡»æ˜¯éè‡ªåŠ¨ç¡®è®¤æœºåˆ¶ï¼Œè¿™ä¸ªæ˜¯ä½¿ç”¨baseQosçš„å‰ææ¡ä»¶ï¼Œå¦åˆ™ä¼šQosä¸ç”Ÿæ•ˆï¼Œç„¶åè®¾ç½®basicQosçš„å€¼ã€‚å¦å¤–ï¼Œè¿˜å¯ä»¥åŸºäºconsumeå’Œchannelçš„ç²’åº¦è¿›è¡Œè®¾ç½®ï¼ˆglobalï¼‰ã€‚</p>
<h4 id="æ‰¹é‡ç¡®è®¤"><a href="#æ‰¹é‡ç¡®è®¤" class="headerlink" title="æ‰¹é‡ç¡®è®¤"></a>æ‰¹é‡ç¡®è®¤</h4><pre><code class="java">public class BatchQosConsumer {
    public static void main(String[] argv)
            throws IOException, TimeoutException {
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost(&quot;127.0.0.1&quot;);
        Connection connection = factory.newConnection();
        final Channel channel = connection.createChannel();
        channel.exchangeDeclare(DirectProducer.EXCHANGE_NAME,
                &quot;direct&quot;);
        String queueName = &quot;focuserror&quot;;
        channel.queueDeclare(queueName, false, false,
                false, null);
        String routekey = &quot;error&quot;;
        channel.queueBind(queueName, DirectProducer.EXCHANGE_NAME, routekey);
        System.out.println(&quot;waiting for message........&quot;);
        final Consumer consumer = new DefaultConsumer(channel) {
            private int meesageCount = 0;
            @Override
            public void handleDelivery(String consumerTag,
                                       Envelope envelope,
                                       AMQP.BasicProperties properties,
                                       byte[] body) throws IOException {
                String message = new String(body, &quot;UTF-8&quot;);
                System.out.println(&quot;æ‰¹é‡æ¶ˆè´¹è€…---Received[&quot; + envelope.getRoutingKey()
                        + &quot;]&quot; + message);
                meesageCount++;
                //æ‰¹é‡ç¡®è®¤50ä¸€æ‰¹
                if (meesageCount % 50 == 0) {
                    this.getChannel().basicAck(envelope.getDeliveryTag(), true);
                    System.out.println(&quot;æ‰¹é‡æ¶ˆæ¯è´¹è¿›è¡Œæ¶ˆæ¯çš„ç¡®è®¤------------&quot;);
                }
                //å¦‚æœæ˜¯æœ€åä¸€æ¡æ¶ˆæ¯ï¼Œåˆ™æŠŠå‰©ä½™çš„æ¶ˆæ¯éƒ½è¿›è¡Œç¡®è®¤
                if (message.equals(&quot;stop&quot;)) { 
                    this.getChannel().basicAck(envelope.getDeliveryTag(), true);
                    System.out.println(&quot;æ‰¹é‡æ¶ˆè´¹è€…è¿›è¡Œæœ€åä¸šåŠ¡æ¶ˆæ¯çš„ç¡®è®¤---------&quot;);
                }
            }
        };
        //150æ¡é¢„å–
        channel.basicQos(500, true);
        channel.basicConsume(queueName, false, consumer);
    }
}</code></pre>
<h4 id="å•æ¡ç¡®è®¤"><a href="#å•æ¡ç¡®è®¤" class="headerlink" title="å•æ¡ç¡®è®¤"></a>å•æ¡ç¡®è®¤</h4><pre><code class="java">public class QosConsumerMain {
    public static void main(String[] argv)
            throws IOException, TimeoutException {
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost(&quot;127.0.0.1&quot;);
        Connection connection = factory.newConnection();
        final Channel channel = connection.createChannel();
        channel.exchangeDeclare(DirectProducer.EXCHANGE_NAME,
                &quot;direct&quot;);
        String queueName = &quot;focuserror&quot;;
        channel.queueDeclare(queueName,false,false,
                false,null);
        String routekey = &quot;test&quot;;
        channel.queueBind(queueName,DirectProducer.EXCHANGE_NAME,routekey);
        System.out.println(&quot;waiting for message........&quot;);
        final Consumer consumer = new DefaultConsumer(channel){
            @Override
            public void handleDelivery(String consumerTag,
                                       Envelope envelope,
                                       AMQP.BasicProperties properties,
                                       byte[] body) throws IOException {
                String message = new String(body, &quot;UTF-8&quot;);
                System.out.println(&quot;Received[&quot;+envelope.getRoutingKey()
                        +&quot;]&quot;+message);
                //TODO å•æ¡ç¡®è®¤
                channel.basicAck(envelope.getDeliveryTag(),false);
            }
        };
        //150æ¡é¢„å–
        channel.basicQos(500,true);
        channel.basicConsume(queueName,false,consumer);
    }
}</code></pre>
<h4 id="basicQos-æ–¹æ³•å‚æ•°è¯¦ç»†è§£é‡Š"><a href="#basicQos-æ–¹æ³•å‚æ•°è¯¦ç»†è§£é‡Š" class="headerlink" title="basicQos()æ–¹æ³•å‚æ•°è¯¦ç»†è§£é‡Š"></a>basicQos()æ–¹æ³•å‚æ•°è¯¦ç»†è§£é‡Š</h4><ul>
<li>prefetchSizeï¼šæœ€å¤šä¼ è¾“å†…å®¹çš„å¤§å°é™åˆ¶ï¼Œ0ä¸ºä¸é™åˆ¶ï¼Œä½†æ®è¯´prefetchSizeå‚æ•°ï¼Œrabbitmqæ²¡æœ‰å®ç°ã€‚</li>
<li>prefetchCountï¼šè¡¨ç¤ºä¸è¦åŒæ—¶ç»™ä¸€ä¸ªæ¶ˆè´¹è€…æ¨é€å¤šäºNä¸ªæ¶ˆæ¯ï¼Œå³ä¸€æ—¦æœ‰Nä¸ªæ¶ˆæ¯è¿˜æ²¡æœ‰ackï¼Œåˆ™è¯¥consumerå°†é˜»å¡æ‰ï¼Œç›´åˆ°æœ‰æ¶ˆæ¯ackã€‚</li>
<li>globalï¼šbooleanç±»å‹è¡¨ç¤ºæ˜¯å¦å°†ä¸Šé¢è®¾ç½®åº”ç”¨äºchannelï¼Œå³ä¸Šé¢çš„é™åˆ¶æ˜¯channelçº§åˆ«çš„è¿˜æ˜¯consumerçº§åˆ«ã€‚</li>
</ul>
<p>å¦‚æœåŒæ—¶å¯¹channelå’Œæ¶ˆè´¹è€…è¿›è¡Œè®¾ç½®ï¼Œå¦‚</p>
<pre><code class="java">channel.basicQos(10,false);
channel.basicQos(15,true);</code></pre>
<p>AMQPè§„èŒƒä¸­æ²¡æœ‰è§£é‡Šå¦‚æœä½¿ç”¨ä¸åŒçš„å…¨å±€å€¼ï¼Œå¤šæ¬¡è°ƒç”¨basic.qosä¼šå‘ç”Ÿä»€ä¹ˆã€‚RabbitMQè®¤ä¸ºä¸¤ä¸ªé¢„å–é™åˆ¶åº”è¯¥å½¼æ­¤ç‹¬ç«‹åœ°å¼ºåˆ¶æ‰§è¡Œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ•´ä¸ªé€šé“åŠ èµ·æ¥æœ€å¤šå…è®¸15æ¡æœªç¡®è®¤çš„æ¶ˆæ¯ï¼Œæ¯ä¸ªæ¶ˆè´¹è€…åˆ™æœ€å¤šæœ‰10æ¡æ¶ˆæ¯ã€‚æ¶ˆè´¹è€…åªæœ‰åœ¨æœªè¾¾åˆ°æœªç¡®è®¤æ¶ˆæ¯é™åˆ¶æ—¶æ‰ä¼šæ”¶åˆ°æ–°æ¶ˆæ¯ã€‚</p>
<h3 id="æ¶ˆè´¹è€…ä¸­çš„äº‹åŠ¡"><a href="#æ¶ˆè´¹è€…ä¸­çš„äº‹åŠ¡" class="headerlink" title="æ¶ˆè´¹è€…ä¸­çš„äº‹åŠ¡"></a>æ¶ˆè´¹è€…ä¸­çš„äº‹åŠ¡</h3><p>ä½¿ç”¨æ–¹æ³•å’Œç”Ÿäº§è€…ä¸€è‡´ã€‚å‡è®¾æ¶ˆè´¹è€…æ¨¡å¼ä¸­ä½¿ç”¨äº†äº‹åŠ¡ï¼Œå¹¶ä¸”åœ¨æ¶ˆæ¯ç¡®è®¤ä¹‹åè¿›è¡Œäº†äº‹åŠ¡å›æ»šï¼Œç»“æœä¼šåˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š</p>
<ol>
<li><p>autoAck=falseæ‰‹åŠ¨åº”å¯¹çš„æ—¶å€™æ˜¯æ”¯æŒäº‹åŠ¡çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å³ä½¿ä½ å·²ç»æ‰‹åŠ¨ç¡®è®¤äº†æ¶ˆæ¯å·²ç»æ”¶åˆ°äº†ï¼Œä½† RabbitMQå¯¹æ¶ˆæ¯çš„ç¡®è®¤ä¼šç­‰äº‹åŠ¡çš„è¿”å›ç»“æœï¼Œæœ€ç»ˆå†³å®šæ˜¯ç§»é™¤æ¶ˆæ¯è¿˜æ˜¯é‡æ–°æ”¾å›é˜Ÿåˆ—ã€‚å¦‚æœä½ æ‰‹åŠ¨ç¡®è®¤ä¹‹ååˆå›æ»šäº†äº‹åŠ¡ï¼Œé‚£ä¹ˆæ­¤æ¡æ¶ˆæ¯ä¼šé‡æ–°æ”¾å›é˜Ÿåˆ—ã€‚</p>
</li>
<li><p>autoAck=trueå¦‚æœè‡ªåŠ¨ç¡®è®¤ä¸ºtrueçš„æƒ…å†µæ˜¯ä¸æ”¯æŒäº‹åŠ¡çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä½ å³ä½¿åœ¨æ”¶åˆ°æ¶ˆæ¯ä¹‹ååœ¨å›æ»šäº‹åŠ¡ä¹Ÿæ˜¯äºäº‹æ— è¡¥çš„ï¼Œé˜Ÿåˆ—å·²ç»æŠŠæ¶ˆæ¯ç§»é™¤äº†ã€‚</p>
</li>
</ol>

            </div>
            <hr>
            <div>
              <p>
                
                  <span>
                <i class="iconfont icon-inbox"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/">æ¶ˆæ¯ä¸­é—´ä»¶</a>
                      &nbsp;
                    
                  </span>&nbsp;&nbsp;
                
                
                  <span>
                <i class="iconfont icon-tag"></i>
                    
                      <a class="hover-with-bg" href="/tags/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/">æ¶ˆæ¯ä¸­é—´ä»¶</a>
                    
                      <a class="hover-with-bg" href="/tags/RabbitMQ/">RabbitMQ</a>
                    
                  </span>
                
              </p>
              
                <p class="note note-warning">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://zh.wikipedia.org/wiki/Wikipedia:CC_BY-SA_3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC" target="_blank" rel="nofollow noopener noopener">CC BY-SA 3.0åè®®</a> ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</p>
              
              
                <div class="post-prevnext row">
                  <div class="post-prev col-6">
                    
                    
                      <a href="/2020/05/09/RabbitMQ%E7%9A%84%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/">
                        <i class="fa fa-chevron-left"></i>
                        <span class="hidden-mobile">RabbitMQçš„é«˜çº§ç‰¹æ€§</span>
                        <span class="visible-mobile">ä¸Šä¸€ç¯‡</span>
                      </a>
                    
                  </div>
                  <div class="post-next col-6">
                    
                    
                      <a href="/2020/05/07/RabbitMQ%E4%B8%8EAMQP%E5%8D%8F%E8%AE%AE/">
                        <span class="hidden-mobile">RabbitMQä¸AMQP</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="fa fa-chevron-right"></i>
                      </a>
                    
                  </div>
                </div>
              
            </div>

              
                <!-- Comments -->
                <div class="comments" id="comments">
                  
                  

                </div>
              
          </div>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc-start"></div>
<div id="toc">
  <p class="h5"><i class="far fa-list-alt"></i>&nbsp;ç›®å½•</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a class="z-depth-1" id="scroll-top-button" href="#" role="button">
      <i class="fa fa-chevron-up scroll-top-arrow" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><b>Hexo</b></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"> <b>Fluid</b></a>
    </div>
    
  <div>
    
      <!-- ä¸è’œå­ç»Ÿè®¡PV -->
      
      <span id="busuanzi_container_site_pv" style="display: none">
      æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv"></span> æ¬¡
    </span>
    
    
      <!-- ä¸è’œå­ç»Ÿè®¡UV -->
      
      <span id="busuanzi_container_site_uv" style="display: none">
      æ€»è®¿å®¢æ•° <span id="busuanzi_value_site_uv"></span> äºº
    </span>
    
  </div>


    

    
  </div>
</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/popper.js/1.16.1/umd/popper.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="https://cdn.staticfile.org/mdbootstrap/4.13.0/js/mdb.min.js" ></script>
<script  src="/js/main.js" ></script>


  <script  src="/js/lazyload.js" ></script>



  
  <script  src="https://cdn.staticfile.org/tocbot/4.10.0/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var navHeight = $('#navbar').height();
      var toc = $('#toc');
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;
      var tocLimMax = 2 * boardTop + boardCtn.height();

      $(window).scroll(function () {
        var tocLimMin = $('#toc-start').offset().top - navHeight;
        var scroH = document.body.scrollTop + document.documentElement.scrollTop;

        if (tocLimMin <= scroH && scroH <= tocLimMax) {
          toc.css({
            'display': 'block',
            'position': 'fixed',
            'top': navHeight,
          });
        } else if (scroH <= tocLimMin) {
          toc.css({
            'position': '',
            'top': '',
          });
        } else if (scroH > tocLimMax) {
          toc.css('display', 'none');
        }
      });
      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: '.post-content',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc > p').css('visibility', 'visible');
      }
      var offset = boardCtn.css('margin-right')
      $('#toc-ctn').css({
        'right': offset
      })
    });
  </script>





  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/js/clipboard-use.js" ></script>



  <script defer src="https://cdn.staticfile.org/smoothscroll/1.4.10/SmoothScroll.min.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




<!-- Plugins -->


  

  

  

  

  

  



  <script  src="https://cdn.staticfile.org/prettify/188.0.0/prettify.min.js" ></script>
  <script>
    $(document).ready(function () {
      $('pre').addClass('prettyprint  linenums');
      prettyPrint();
    })
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "RabbitMQä¸­æ¶ˆæ¯å‘å¸ƒä¸æƒè¡¡&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      getSearchFile(path);
      this.onclick = null
    }
  </script>



  <script defer src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <script>
    $("#post img:not(.no-zoom img, img[no-zoom])").each(
      function () {
        var element = document.createElement("a");
        $(element).attr("data-fancybox", "images");
        $(element).attr("href", $(this).attr("src"));
        $(this).wrap(element);
      }
    );
  </script>





  
  
    <script type="text/javascript">
      //å®šä¹‰è·å–è¯è¯­ä¸‹æ ‡
      var a_idx = 0;
      jQuery(document).ready(function ($) {
        //ç‚¹å‡»bodyæ—¶è§¦å‘äº‹ä»¶
        $("body").click(function (e) {
          //éœ€è¦æ˜¾ç¤ºçš„è¯è¯­
          var a = new Array("å¯Œå¼º", "æ°‘ä¸»", "æ–‡æ˜", "å’Œè°", "è‡ªç”±", "å¹³ç­‰", "å…¬æ­£", "æ³•æ²»", "çˆ±å›½", "æ•¬ä¸š", "è¯šä¿¡", "å‹å–„");
          //è®¾ç½®è¯è¯­ç»™spanæ ‡ç­¾
          var $i = $("<span/>").text(a[a_idx]);
          //ä¸‹æ ‡ç­‰äºåŸæ¥ä¸‹æ ‡+1  ä½™ è¯è¯­æ€»æ•°
          a_idx = (a_idx + 1) % a.length;
          //è·å–é¼ æ ‡æŒ‡é’ˆçš„ä½ç½®ï¼Œåˆ†åˆ«ç›¸å¯¹äºæ–‡æ¡£çš„å·¦å’Œå³è¾¹ç¼˜ã€‚
          //è·å–xå’Œyçš„æŒ‡é’ˆåæ ‡
          var x = e.pageX, y = e.pageY;
          //åœ¨é¼ æ ‡çš„æŒ‡é’ˆçš„ä½ç½®ç»™$iå®šä¹‰çš„spanæ ‡ç­¾æ·»åŠ cssæ ·å¼
          $i.css({
            "z-index": 999,
            "top": y - 20,
            "left": x,
            "position": "absolute",
            "font-weight": "bold",
            "color": rand_color()
          });
          // éšæœºé¢œè‰²
          function rand_color() {
            return "rgb(" + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + ")"
          }
          //åœ¨bodyæ·»åŠ è¿™ä¸ªæ ‡ç­¾
          $("body").append($i);
          //animate() æ–¹æ³•æ‰§è¡Œ CSS å±æ€§é›†çš„è‡ªå®šä¹‰åŠ¨ç”»ã€‚
          //è¯¥æ–¹æ³•é€šè¿‡CSSæ ·å¼å°†å…ƒç´ ä»ä¸€ä¸ªçŠ¶æ€æ”¹å˜ä¸ºå¦ä¸€ä¸ªçŠ¶æ€ã€‚CSSå±æ€§å€¼æ˜¯é€æ¸æ”¹å˜çš„ï¼Œè¿™æ ·å°±å¯ä»¥åˆ›å»ºåŠ¨ç”»æ•ˆæœã€‚
          //è¯¦æƒ…è¯·çœ‹http://www.w3school.com.cn/jquery/effect_animate.asp
          $i.animate({
            //å°†åŸæ¥çš„ä½ç½®å‘ä¸Šç§»åŠ¨180
            "top": y - 180,
            "opacity": 0
            //1500åŠ¨ç”»çš„é€Ÿåº¦
          }, 1500, function () {
            //æ—¶é—´åˆ°äº†è‡ªåŠ¨åˆ é™¤
            $i.remove();
          });
        });
      })
      ;
    </script>
  








</body>
</html>
