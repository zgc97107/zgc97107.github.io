

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/blog/img/favicon.png">
  <link rel="icon" type="image/png" href="/blog/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="">
  <meta name="keywords" content="">
  <title>RabbitMQä¸­æ¶ˆæ¯å‘å¸ƒä¸æƒè¡¡ - ğŸğŸŠ&#39;s blog</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/blog/lib/hint/hint.min.css" />

  
    
    <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/github-gist.min.css" />
  

  


<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_6peoq002giu.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_pjno9b9zyxs.css">


<link  rel="stylesheet" href="/blog/css/main.css" />

<!-- è‡ªå®šä¹‰æ ·å¼ä¿æŒåœ¨æœ€åº•éƒ¨ -->


  <script  src="/blog/js/utils.js" ></script>
  <script  src="/blog/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 4.2.1"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/blog/">&nbsp;<strong>ğŸğŸŠ's blog</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/">
                <i class="iconfont icon-home-fill"></i>
                ä¸»é¡µ
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/archives/">
                <i class="iconfont icon-archive-fill"></i>
                å½’æ¡£
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/categories/">
                <i class="iconfont icon-category-fill"></i>
                åˆ†ç±»
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/tags/">
                <i class="iconfont icon-tags-fill"></i>
                æ ‡ç­¾
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/about/">
                <i class="iconfont icon-user-fill"></i>
                å…³äº
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax=true
         style="background: url('/blog/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container page-header text-center fade-in-up">
            <span class="h2" id="subtitle">
              
            </span>

            
              
  <div class="mt-3 post-meta">
    <i class="iconfont icon-date-fill" aria-hidden="true"></i>
    <time datetime="2020-05-08 15:17" pubdate>
      2020å¹´5æœˆ8æ—¥ ä¸‹åˆ
    </time>
  </div>


<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      6.8k å­—
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      98
       åˆ†é’Ÿ
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto" id="post">
            <!-- SEO header -->
            <h1 style="display: none">RabbitMQä¸­æ¶ˆæ¯å‘å¸ƒä¸æƒè¡¡</h1>
            
            <div class="markdown-body" id="post-body">
              <h2 id="ä½¿ç”¨Javaå®¢æˆ·ç«¯è¿›è¡Œæ¶ˆæ¯é€šä¿¡"><a href="#ä½¿ç”¨Javaå®¢æˆ·ç«¯è¿›è¡Œæ¶ˆæ¯é€šä¿¡" class="headerlink" title="ä½¿ç”¨Javaå®¢æˆ·ç«¯è¿›è¡Œæ¶ˆæ¯é€šä¿¡"></a>ä½¿ç”¨Javaå®¢æˆ·ç«¯è¿›è¡Œæ¶ˆæ¯é€šä¿¡</h2><p>å®¢æˆ·ç«¯éœ€è¦amqp-client-5.0.0.jarå’Œslf4j-api-1.6.1.jar</p>
<p>å»ºè®®ä½¿ç”¨Mavenï¼š</p>
<pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.rabbitmq<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>amqp-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></code></pre>

<p>æ³¨æ„ï¼š5ç³»åˆ—çš„ç‰ˆæœ¬æœ€å¥½ä½¿ç”¨JDK8åŠä»¥ä¸Šï¼Œ ä½äºJDK8å¯ä»¥ä½¿ç”¨4.x(å…·ä½“çš„ç‰ˆæœ¬å·åˆ°Mavençš„ä¸­å¤®ä»“åº“æŸ¥)çš„ç‰ˆæœ¬ã€‚</p>
<h3 id="Directäº¤æ¢å™¨"><a href="#Directäº¤æ¢å™¨" class="headerlink" title="Directäº¤æ¢å™¨"></a>Directäº¤æ¢å™¨</h3><img src="/blog/2020/05/08/RabbitMQ%E4%B8%AD%E6%B6%88%E6%81%AF%E5%8F%91%E5%B8%83%E4%B8%8E%E6%9D%83%E8%A1%A1/pic3.png" srcset="/blog/img/loading.gif" class>

<h4 id="ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„ä¸€èˆ¬ç”¨æ³•"><a href="#ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„ä¸€èˆ¬ç”¨æ³•" class="headerlink" title="ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„ä¸€èˆ¬ç”¨æ³•"></a>ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„ä¸€èˆ¬ç”¨æ³•</h4><p>åˆ›å»ºæ¶ˆæ¯ç”Ÿäº§è€…</p>
<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DirectProducer</span> </span>&#123;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * äº¤æ¢å™¨åç§°</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> String EXCHANGE_NAME = <span class="hljs-string">"direct_logs"</span>;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * è·¯ç”±é”®</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> String[] ROUTE_KEYS =&#123;<span class="hljs-string">"route_key_1"</span>,<span class="hljs-string">"route_key_2"</span>,<span class="hljs-string">"route_key_3"</span>&#125;;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span></span>
<span class="hljs-function">            <span class="hljs-keyword">throws</span> IOException, TimeoutException </span>&#123;
        <span class="hljs-comment">//åˆ›å»ºè¿æ¥ã€è¿æ¥åˆ°RabbitMQ</span>
        ConnectionFactory connectionFactory= <span class="hljs-keyword">new</span> ConnectionFactory();
        <span class="hljs-comment">//è®¾ç½®ä¸‹è¿æ¥å·¥å‚çš„è¿æ¥åœ°å€(ä½¿ç”¨é»˜è®¤ç«¯å£5672)</span>
        connectionFactory.setHost(<span class="hljs-string">"localhost"</span>);
        <span class="hljs-comment">//åˆ›å»ºè¿æ¥</span>
        Connection connection =connectionFactory.newConnection();
        <span class="hljs-comment">//åˆ›å»ºä¿¡é“</span>
        Channel channel =connection.createChannel();

        <span class="hljs-comment">//åœ¨ä¿¡é“ä¸­è®¾ç½®äº¤æ¢å™¨</span>
        channel.exchangeDeclare(EXCHANGE_NAME,BuiltinExchangeType.DIRECT);

        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">6</span>;i++)&#123;
            String routeKey = ROUTE_KEYS[i%<span class="hljs-number">3</span>];
            String msg = <span class="hljs-string">"Hello,RabbitMQ"</span>+(i+<span class="hljs-number">1</span>);
            <span class="hljs-comment">//å‘å¸ƒæ¶ˆæ¯</span>
            channel.basicPublish(EXCHANGE_NAME,routeKey,<span class="hljs-keyword">null</span>,msg.getBytes());
            System.out.println(<span class="hljs-string">"Sent:"</span>+routeKey+<span class="hljs-string">":"</span>+msg);
        &#125;
        channel.close();
        connection.close();
    &#125;
&#125;</code></pre>

<p>åˆ›å»ºæ¶ˆè´¹è€…</p>
<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NormalConsumer</span> </span>&#123;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] argv)</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException </span>&#123;
        <span class="hljs-comment">//åˆ›å»ºè¿æ¥ã€è¿æ¥åˆ°RabbitMQ</span>
        ConnectionFactory connectionFactory = <span class="hljs-keyword">new</span> ConnectionFactory();
        <span class="hljs-comment">//è®¾ç½®ä¸‹è¿æ¥å·¥å‚çš„è¿æ¥åœ°å€(ä½¿ç”¨é»˜è®¤ç«¯å£5672)</span>
        connectionFactory.setHost(<span class="hljs-string">"localhost"</span>);
        <span class="hljs-comment">//åˆ›å»ºè¿æ¥</span>
        Connection connection = connectionFactory.newConnection();
        <span class="hljs-comment">//åˆ›å»ºä¿¡é“</span>
        Channel channel = connection.createChannel();

        <span class="hljs-comment">//åœ¨ä¿¡é“ä¸­è®¾ç½®äº¤æ¢å™¨</span>
        channel.exchangeDeclare(DirectProducer.EXCHANGE_NAME, BuiltinExchangeType.DIRECT);

        <span class="hljs-comment">//ç”³æ˜é˜Ÿåˆ—</span>
        String queueName = <span class="hljs-string">"queue_1"</span>;
        channel.queueDeclare(queueName, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>);

        <span class="hljs-comment">//ç»‘å®šï¼šå°†é˜Ÿåˆ—ä¸äº¤æ¢å™¨é€šè¿‡è·¯ç”±é”®ç»‘å®š</span>
        String routeKey = DirectProducer.ROUTE_KEYS[<span class="hljs-number">0</span>];
        channel.queueBind(queueName, DirectProducer.EXCHANGE_NAME, routeKey);
        System.out.println(<span class="hljs-string">"waiting for message ......"</span>);

        <span class="hljs-comment">//ç”³æ˜ä¸€ä¸ªæ¶ˆè´¹è€…</span>
        <span class="hljs-keyword">final</span> Consumer consumer = <span class="hljs-keyword">new</span> DefaultConsumer(channel) &#123;
            <span class="hljs-meta">@Override</span>
            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleDelivery</span><span class="hljs-params">(String s, Envelope envelope, AMQP.BasicProperties basicProperties, <span class="hljs-keyword">byte</span>[] bytes)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;
                String message = <span class="hljs-keyword">new</span> String(bytes, <span class="hljs-string">"UTF-8"</span>);
                System.out.println(<span class="hljs-string">"Received["</span> + envelope.getRoutingKey() + <span class="hljs-string">"]"</span> + message);
            &#125;
        &#125;;

        <span class="hljs-comment">//æ¶ˆæ¯è€…æ­£å¼å¼€å§‹åœ¨æŒ‡å®šé˜Ÿåˆ—ä¸Šæ¶ˆè´¹ã€‚</span>
        <span class="hljs-comment">//ç¬¬äºŒä¸ªå‚æ•°æ˜¯è‡ªåŠ¨ç¡®è®¤å‚æ•°ï¼Œå¦‚æœæ˜¯trueåˆ™æ˜¯è‡ªåŠ¨ç¡®è®¤</span>
        channel.basicConsume(queueName, <span class="hljs-keyword">true</span>, consumer);
    &#125;

&#125;</code></pre>

<p>é€šè¿‡æµ‹è¯•å‘ç°ï¼Œä½¿ç”¨DirectProducerä½œä¸ºç”Ÿäº§è€…ï¼ŒNormalConsumerä½œä¸ºæ¶ˆè´¹è€…ï¼Œæ¶ˆè´¹è€…ç»‘å®šä¸€ä¸ªé˜Ÿåˆ—ï¼Œæ—¶åªæ¥æ”¶è¯¥é˜Ÿåˆ—ç»‘å®šçš„è·¯ç”±é”®çš„æ¶ˆæ¯ã€‚</p>
<h4 id="é˜Ÿåˆ—å’Œäº¤æ¢å™¨çš„å¤šé‡ç»‘å®š"><a href="#é˜Ÿåˆ—å’Œäº¤æ¢å™¨çš„å¤šé‡ç»‘å®š" class="headerlink" title="é˜Ÿåˆ—å’Œäº¤æ¢å™¨çš„å¤šé‡ç»‘å®š"></a>é˜Ÿåˆ—å’Œäº¤æ¢å™¨çš„å¤šé‡ç»‘å®š</h4><h5 id="ä¸€ä¸ªé˜Ÿåˆ—ç»‘å®šå¤šä¸ªè·¯ç”±é”®"><a href="#ä¸€ä¸ªé˜Ÿåˆ—ç»‘å®šå¤šä¸ªè·¯ç”±é”®" class="headerlink" title="ä¸€ä¸ªé˜Ÿåˆ—ç»‘å®šå¤šä¸ªè·¯ç”±é”®"></a>ä¸€ä¸ªé˜Ÿåˆ—ç»‘å®šå¤šä¸ªè·¯ç”±é”®</h5><p>è¿™æ—¶é˜Ÿåˆ—å¯ä»¥æ¥æ”¶åˆ°ç»‘å®šçš„æ‰€æœ‰è·¯ç”±é”®çš„æ¶ˆæ¯ã€‚</p>
<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MultiBindConsumer</span> </span>&#123;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] argv)</span> <span class="hljs-keyword">throws</span> IOException,</span>
<span class="hljs-function">            InterruptedException, TimeoutException </span>&#123;
        <span class="hljs-comment">//è¿æ¥å·¥å‚</span>
        ConnectionFactory factory = <span class="hljs-keyword">new</span> ConnectionFactory();
        <span class="hljs-comment">//è¿æ¥rabbitMqçš„åœ°å€</span>
        factory.setHost(<span class="hljs-string">"127.0.0.1"</span>);

        <span class="hljs-comment">// æ‰“å¼€è¿æ¥å’Œåˆ›å»ºé¢‘é“ï¼Œä¸å‘é€ç«¯ä¸€æ ·</span>
        Connection connection = factory.newConnection();
        <span class="hljs-comment">//åˆ›å»ºä¸€ä¸ªä¿¡é“</span>
        <span class="hljs-keyword">final</span> Channel channel = connection.createChannel();
        <span class="hljs-comment">//åœ¨ä¿¡é“ä¸­è®¾ç½®äº¤æ¢å™¨</span>
        channel.exchangeDeclare(DirectProducer.EXCHANGE_NAME, BuiltinExchangeType.DIRECT);

        <span class="hljs-comment">//å£°æ˜ä¸€ä¸ªéšæœºé˜Ÿåˆ—</span>
        String queueName = channel.queueDeclare().getQueue();
        <span class="hljs-comment">//é˜Ÿåˆ—ç»‘å®šåˆ°äº¤æ¢å™¨ä¸Šæ—¶ï¼Œæ˜¯å…è®¸ç»‘å®šå¤šä¸ªè·¯ç”±é”®çš„ï¼Œä¹Ÿå°±æ˜¯å¤šé‡ç»‘å®š</span>
        <span class="hljs-keyword">for</span> (String routekey : DirectProducer.ROUTE_KEYS) &#123;
            channel.queueBind(queueName, DirectProducer.EXCHANGE_NAME, routekey);
        &#125;
        System.out.println(<span class="hljs-string">" [*] Waiting for messages:"</span>);

        <span class="hljs-comment">// åˆ›å»ºé˜Ÿåˆ—æ¶ˆè´¹è€…</span>
        <span class="hljs-keyword">final</span> Consumer consumerA = <span class="hljs-keyword">new</span> DefaultConsumer(channel) &#123;
            <span class="hljs-meta">@Override</span>
            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleDelivery</span><span class="hljs-params">(String consumerTag,</span></span>
<span class="hljs-function"><span class="hljs-params">                                       Envelope envelope,</span></span>
<span class="hljs-function"><span class="hljs-params">                                       AMQP.BasicProperties</span></span>
<span class="hljs-function"><span class="hljs-params">                                               properties,</span></span>
<span class="hljs-function"><span class="hljs-params">                                       <span class="hljs-keyword">byte</span>[] body)</span></span>
<span class="hljs-function">                    <span class="hljs-keyword">throws</span> IOException </span>&#123;
                String message = <span class="hljs-keyword">new</span> String(body, <span class="hljs-string">"UTF-8"</span>);
                System.out.println(<span class="hljs-string">" Received "</span>
                        + envelope.getRoutingKey() + <span class="hljs-string">":'"</span> + message
                        + <span class="hljs-string">"'"</span>);
            &#125;
        &#125;;
        channel.basicConsume(queueName, <span class="hljs-keyword">true</span>, consumerA);
    &#125;
&#125;</code></pre>

<h5 id="ä¸€ä¸ªè¿æ¥å¤šä¸ªä¿¡é“"><a href="#ä¸€ä¸ªè¿æ¥å¤šä¸ªä¿¡é“" class="headerlink" title="ä¸€ä¸ªè¿æ¥å¤šä¸ªä¿¡é“"></a>ä¸€ä¸ªè¿æ¥å¤šä¸ªä¿¡é“</h5><p>å®ç°æ–¹æ³•ä¸ºä½¿ç”¨å¤šçº¿ç¨‹åˆ›å»ºä¿¡é“ï¼Œç„¶åç”Ÿæˆéšæœºçš„é˜Ÿåˆ—å¹¶ç»‘å®šåˆ°ä¿¡é“ã€‚è¿™æ—¶æ‰€æœ‰é˜Ÿåˆ—éƒ½å¯ä»¥æ¥æ”¶åˆ°å…¨éƒ¨çš„æ¶ˆæ¯ã€‚</p>
<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MultiChannelConsumer</span> </span>&#123;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConsumerWorker</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Runnable</span> </span>&#123;
        <span class="hljs-keyword">final</span> Connection connection;

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ConsumerWorker</span><span class="hljs-params">(Connection connection)</span> </span>&#123;
            <span class="hljs-keyword">this</span>.connection = connection;
        &#125;

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;
            <span class="hljs-keyword">try</span> &#123;
                <span class="hljs-comment">//åˆ›å»ºä¸€ä¸ªä¿¡é“ï¼Œæ„å‘³ç€æ¯ä¸ªçº¿ç¨‹å•ç‹¬ä¸€ä¸ªä¿¡é“</span>
                Channel channel = connection.createChannel();
                channel.exchangeDeclare(DirectProducer.EXCHANGE_NAME, BuiltinExchangeType.DIRECT);
                <span class="hljs-comment">// å£°æ˜ä¸€ä¸ªéšæœºé˜Ÿåˆ—</span>
                String queueName = channel.queueDeclare().getQueue();
                <span class="hljs-comment">//æ¶ˆè´¹è€…åå­—ï¼Œæ‰“å°è¾“å‡ºç”¨</span>
                <span class="hljs-keyword">final</span> String consumerName = Thread.currentThread().getName() + <span class="hljs-string">"-all"</span>;
                <span class="hljs-keyword">for</span> (String routekey : DirectProducer.ROUTE_KEYS) &#123;
                    channel.queueBind(queueName, DirectProducer.EXCHANGE_NAME,
                            routekey);
                &#125;
                System.out.println(<span class="hljs-string">"["</span> + consumerName + <span class="hljs-string">"] Waiting for messages:"</span>);
                <span class="hljs-keyword">final</span> Consumer consumerA = <span class="hljs-keyword">new</span> DefaultConsumer(channel) &#123;
                    <span class="hljs-meta">@Override</span>
                    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleDelivery</span><span class="hljs-params">(String consumerTag,</span></span>
<span class="hljs-function"><span class="hljs-params">                                               Envelope envelope,</span></span>
<span class="hljs-function"><span class="hljs-params">                                               AMQP.BasicProperties</span></span>
<span class="hljs-function"><span class="hljs-params">                                                       properties,</span></span>
<span class="hljs-function"><span class="hljs-params">                                               <span class="hljs-keyword">byte</span>[] body)</span></span>
<span class="hljs-function">                            <span class="hljs-keyword">throws</span> IOException </span>&#123;
                        String message =
                                <span class="hljs-keyword">new</span> String(body, <span class="hljs-string">"UTF-8"</span>);
                        System.out.println(consumerName
                                + <span class="hljs-string">" Received "</span> + envelope.getRoutingKey()
                                + <span class="hljs-string">":'"</span> + message + <span class="hljs-string">"'"</span>);
                    &#125;
                &#125;;
                channel.basicConsume(queueName, <span class="hljs-keyword">true</span>, consumerA);
            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;
                e.printStackTrace();
            &#125;
        &#125;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] argv)</span> <span class="hljs-keyword">throws</span> TimeoutException, IOException </span>&#123;
        ConnectionFactory factory = <span class="hljs-keyword">new</span> ConnectionFactory();
        factory.setHost(<span class="hljs-string">"localhost"</span>);
        Connection connection = factory.newConnection();
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">2</span>; i++) &#123;
            <span class="hljs-comment">//å°†è¿æ¥ä½œä¸ºå‚æ•°ï¼Œä¼ é€’ç»™æ¯ä¸ªçº¿ç¨‹</span>
            Thread worker = <span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> ConsumerWorker(connection));
            worker.start();
        &#125;
    &#125;
&#125;</code></pre>

<h5 id="ä¸€ä¸ªé˜Ÿåˆ—å¤šä¸ªæ¶ˆè´¹è€…"><a href="#ä¸€ä¸ªé˜Ÿåˆ—å¤šä¸ªæ¶ˆè´¹è€…" class="headerlink" title="ä¸€ä¸ªé˜Ÿåˆ—å¤šä¸ªæ¶ˆè´¹è€…"></a>ä¸€ä¸ªé˜Ÿåˆ—å¤šä¸ªæ¶ˆè´¹è€…</h5><p>ä¹Ÿæ˜¯åˆ©ç”¨å¤šçº¿ç¨‹ï¼Œåªä¸è¿‡è¿™æ˜¯åˆ›å»ºæŒ‡å®šåç§°çš„é˜Ÿåˆ—ï¼Œå¦‚æœé˜Ÿåˆ—å·²å­˜åœ¨ä¸ä¼šé‡å¤ç»‘å®šã€‚è¿™æ—¶ä¼šè½®è¯¢å°†é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯åˆ†å‘ç»™æ¶ˆè´¹è€…ï¼Œæ‰€æœ‰æ¶ˆè´¹è€…å…±äº«è¿™ä¸ªé˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ã€‚</p>
<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MultiConsumerOneQueue</span> </span>&#123;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConsumerWorker</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Runnable</span> </span>&#123;
        <span class="hljs-keyword">final</span> Connection connection;
        <span class="hljs-keyword">final</span> String queueName;

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ConsumerWorker</span><span class="hljs-params">(Connection connection, String queueName)</span> </span>&#123;
            <span class="hljs-keyword">this</span>.connection = connection;
            <span class="hljs-keyword">this</span>.queueName = queueName;
        &#125;

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;
            <span class="hljs-keyword">try</span> &#123;
                <span class="hljs-keyword">final</span> Channel channel = connection.createChannel();
                channel.exchangeDeclare(DirectProducer.EXCHANGE_NAME, BuiltinExchangeType.DIRECT);
                <span class="hljs-comment">//å£°æ˜ä¸€ä¸ªé˜Ÿåˆ—,rabbitmqï¼Œå¦‚æœé˜Ÿåˆ—å·²å­˜åœ¨ï¼Œä¸ä¼šé‡å¤åˆ›å»º</span>
                channel.queueDeclare(queueName, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>);
                <span class="hljs-keyword">final</span> String consumerName = Thread.currentThread().getName();
                <span class="hljs-keyword">for</span> (String routekey : DirectProducer.ROUTE_KEYS) &#123;
                    channel.queueBind(queueName, DirectProducer.EXCHANGE_NAME,
                            routekey);
                &#125;
                System.out.println(<span class="hljs-string">" ["</span> + consumerName + <span class="hljs-string">"] Waiting for messages:"</span>);
                <span class="hljs-keyword">final</span> Consumer consumerA = <span class="hljs-keyword">new</span> DefaultConsumer(channel) &#123;
                    <span class="hljs-meta">@Override</span>
                    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleDelivery</span><span class="hljs-params">(String consumerTag,</span></span>
<span class="hljs-function"><span class="hljs-params">                                               Envelope envelope,</span></span>
<span class="hljs-function"><span class="hljs-params">                                               AMQP.BasicProperties</span></span>
<span class="hljs-function"><span class="hljs-params">                                                       properties,</span></span>
<span class="hljs-function"><span class="hljs-params">                                               <span class="hljs-keyword">byte</span>[] body)</span></span>
<span class="hljs-function">                            <span class="hljs-keyword">throws</span> IOException </span>&#123;
                        String message =
                                <span class="hljs-keyword">new</span> String(body, <span class="hljs-string">"UTF-8"</span>);
                        System.out.println(consumerName
                                + <span class="hljs-string">" Received "</span> + envelope.getRoutingKey()
                                + <span class="hljs-string">":'"</span> + message + <span class="hljs-string">"'"</span>);
                    &#125;
                &#125;;
                channel.basicConsume(queueName, <span class="hljs-keyword">true</span>, consumerA);
            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;
                e.printStackTrace();
            &#125;
        &#125;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] argv)</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException </span>&#123;
        ConnectionFactory factory = <span class="hljs-keyword">new</span> ConnectionFactory();
        factory.setHost(<span class="hljs-string">"127.0.0.1"</span>);
        Connection connection = factory.newConnection();
        String queueName = <span class="hljs-string">"focusAll"</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) &#123;
            <span class="hljs-comment">//å°†è¿æ¥åŠé˜Ÿåˆ—åä½œä¸ºå‚æ•°ï¼Œä¼ é€’ç»™æ¯ä¸ªçº¿ç¨‹</span>
            Thread worker = <span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> ConsumerWorker(connection, queueName));
            worker.start();
        &#125;
    &#125;
&#125;</code></pre>

<h3 id="Fanoutäº¤æ¢å™¨"><a href="#Fanoutäº¤æ¢å™¨" class="headerlink" title="Fanoutäº¤æ¢å™¨"></a>Fanoutäº¤æ¢å™¨</h3><img src="/blog/2020/05/08/RabbitMQ%E4%B8%AD%E6%B6%88%E6%81%AF%E5%8F%91%E5%B8%83%E4%B8%8E%E6%9D%83%E8%A1%A1/pic2.png" srcset="/blog/img/loading.gif" class>

<p>åˆ›å»ºç”Ÿäº§è€…</p>
<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FanoutProducer</span> </span>&#123;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> String EXCHANGE_NAME = <span class="hljs-string">"fanout_logs"</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> String[] ROUTE_KEYS = &#123;<span class="hljs-string">"route_key_1"</span>, <span class="hljs-string">"route_key_2"</span>, <span class="hljs-string">"route_key_3"</span>&#125;;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException </span>&#123;
        ConnectionFactory factory = <span class="hljs-keyword">new</span> ConnectionFactory();
        factory.setHost(<span class="hljs-string">"127.0.0.1"</span>);
        Connection connection = factory.newConnection();
        Channel channel = connection.createChannel();
        channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.FANOUT);

        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) &#123;
            String routekey = ROUTE_KEYS[i % <span class="hljs-number">3</span>];
            String message = <span class="hljs-string">"Hello World_"</span> + (i + <span class="hljs-number">1</span>);
            channel.basicPublish(EXCHANGE_NAME, routekey,
                    <span class="hljs-keyword">null</span>, message.getBytes());
            System.out.println(<span class="hljs-string">" [x] Sent '"</span> + routekey + <span class="hljs-string">"':'"</span>
                    + message + <span class="hljs-string">"'"</span>);
        &#125;
        channel.close();
        connection.close();
    &#125;
&#125;</code></pre>

<p>åˆ›å»ºæ¶ˆè´¹è€…1ï¼Œæ³¨æ„ï¼Œæ­¤æ—¶æ¶ˆè´¹è€…ä¸å—è·¯ç”±é”®çš„å½±å“ï¼Œå°±ç®—ä¸ç»‘å®šç”Ÿäº§è€…çš„è·¯ç”±é”®ä»ç„¶å¯ä»¥æ¥æ”¶åˆ°æ¶ˆæ¯ã€‚</p>
<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Consumer1</span> </span>&#123;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] argv)</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException </span>&#123;
        ConnectionFactory factory = <span class="hljs-keyword">new</span> ConnectionFactory();
        factory.setHost(<span class="hljs-string">"127.0.0.1"</span>);
        Connection connection = factory.newConnection();
        <span class="hljs-keyword">final</span> Channel channel = connection.createChannel();
        channel.exchangeDeclare(FanoutProducer.EXCHANGE_NAME,
                BuiltinExchangeType.FANOUT);
        String queueName = channel.queueDeclare().getQueue();
        <span class="hljs-keyword">for</span> (String routekey : FanoutProducer.ROUTE_KEYS) &#123;
            channel.queueBind(queueName, FanoutProducer.EXCHANGE_NAME,
                    routekey);
        &#125;
        System.out.println(<span class="hljs-string">" ["</span> + queueName + <span class="hljs-string">"] Waiting for messages:"</span>);
        <span class="hljs-keyword">final</span> Consumer consumerA = <span class="hljs-keyword">new</span> DefaultConsumer(channel) &#123;
            <span class="hljs-meta">@Override</span>
            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleDelivery</span><span class="hljs-params">(String consumerTag, Envelope envelope,</span></span>
<span class="hljs-function"><span class="hljs-params">                                       AMQP.BasicProperties properties, <span class="hljs-keyword">byte</span>[] body)</span></span>
<span class="hljs-function">                    <span class="hljs-keyword">throws</span> IOException </span>&#123;
                String message = <span class="hljs-keyword">new</span> String(body, <span class="hljs-string">"UTF-8"</span>);
                System.out.println(<span class="hljs-string">"Received "</span> + envelope.getRoutingKey() + <span class="hljs-string">"':'"</span> + message + <span class="hljs-string">"'"</span>);
            &#125;
        &#125;;
        channel.basicConsume(queueName, <span class="hljs-keyword">true</span>, consumerA);
    &#125;
&#125;</code></pre>

<p>æ¶ˆè´¹è€…2ï¼Œæ³¨æ„è¿™æ—¶ç»‘å®šçš„æ˜¯ä¸€ä¸ªä¸å­˜åœ¨çš„è·¯ç”±é”®ï¼Œå¹¿æ’­äº¤æ¢å™¨ä¸ä¼šå—è·¯ç”±é”®å½±å“ï¼Œæ­¤æ—¶æ¶ˆè´¹è€…2ä»ç„¶å¯ä»¥æ¥æ”¶åˆ°æ‰€æœ‰æ¶ˆæ¯ã€‚</p>
<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Consumer2</span> </span>&#123;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] argv)</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException </span>&#123;
        ConnectionFactory factory = <span class="hljs-keyword">new</span> ConnectionFactory();
        factory.setHost(<span class="hljs-string">"127.0.0.1"</span>);
        Connection connection = factory.newConnection();
        <span class="hljs-keyword">final</span> Channel channel = connection.createChannel();
        channel.exchangeDeclare(FanoutProducer.EXCHANGE_NAME,
                BuiltinExchangeType.FANOUT);
        String queueName = channel.queueDeclare().getQueue();
        <span class="hljs-comment">//è®¾ç½®ä¸€ä¸ªä¸å­˜åœ¨çš„è·¯ç”±é”®</span>
        String routekey=<span class="hljs-string">"xxx"</span>;
        channel.queueBind(queueName, FanoutProducer.EXCHANGE_NAME, routekey);
        System.out.println(<span class="hljs-string">" [*] Waiting for messages......"</span>);
        <span class="hljs-keyword">final</span> Consumer consumerB = <span class="hljs-keyword">new</span> DefaultConsumer(channel) &#123;
            <span class="hljs-meta">@Override</span>
            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleDelivery</span><span class="hljs-params">(String consumerTag,</span></span>
<span class="hljs-function"><span class="hljs-params">                                       Envelope envelope,</span></span>
<span class="hljs-function"><span class="hljs-params">                                       AMQP.BasicProperties properties,</span></span>
<span class="hljs-function"><span class="hljs-params">                                       <span class="hljs-keyword">byte</span>[] body)</span></span>
<span class="hljs-function">                    <span class="hljs-keyword">throws</span> IOException </span>&#123;
                String message = <span class="hljs-keyword">new</span> String(body, <span class="hljs-string">"UTF-8"</span>);
                System.out.println( <span class="hljs-string">"Received ["</span>+ envelope.getRoutingKey()
                        + <span class="hljs-string">"] "</span>+message);
            &#125;
        &#125;;
        channel.basicConsume(queueName, <span class="hljs-keyword">true</span>, consumerB);
    &#125;
&#125;</code></pre>

<h3 id="Topicäº¤æ¢å™¨"><a href="#Topicäº¤æ¢å™¨" class="headerlink" title="Topicäº¤æ¢å™¨"></a>Topicäº¤æ¢å™¨</h3><img src="/blog/2020/05/08/RabbitMQ%E4%B8%AD%E6%B6%88%E6%81%AF%E5%8F%91%E5%B8%83%E4%B8%8E%E6%9D%83%E8%A1%A1/pic4.png" srcset="/blog/img/loading.gif" class>

<p>åˆ›å»ºç”Ÿäº§è€…</p>
<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TopicProducer</span> </span>&#123;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> String EXCHANGE_NAME = <span class="hljs-string">"topic_course"</span>;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span></span>
<span class="hljs-function">            <span class="hljs-keyword">throws</span> IOException, TimeoutException </span>&#123;
        ConnectionFactory factory = <span class="hljs-keyword">new</span> ConnectionFactory();
        factory.setHost(<span class="hljs-string">"127.0.0.1"</span>);
        Connection connection = factory.newConnection();
        Channel channel = connection.createChannel();
        <span class="hljs-comment">//åˆ›å»ºä¸»é¢˜</span>
        channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.TOPIC);
        String[] types = &#123;<span class="hljs-string">"TYPE_A"</span>, <span class="hljs-string">"TYPE_B"</span>, <span class="hljs-string">"TYPE_C"</span>&#125;;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) &#123;
            String[] modules = &#123;<span class="hljs-string">"moduleA"</span>, <span class="hljs-string">"moduleB"</span>, <span class="hljs-string">"moduleC"</span>&#125;;
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">3</span>; j++) &#123;
                String[] status = &#123;<span class="hljs-string">"0"</span>, <span class="hljs-string">"1"</span>, <span class="hljs-string">"2"</span>&#125;;
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> k = <span class="hljs-number">0</span>; k &lt; <span class="hljs-number">3</span>; k++) &#123;
                    <span class="hljs-comment">// å‘é€çš„æ¶ˆæ¯</span>
                    String message = <span class="hljs-string">"Hello Topic_["</span> + i + <span class="hljs-string">","</span> + j + <span class="hljs-string">","</span> + k + <span class="hljs-string">"]"</span>;
                    String routeKey = types[i % <span class="hljs-number">3</span>] + <span class="hljs-string">"."</span> + modules[j % <span class="hljs-number">3</span>]
                            + <span class="hljs-string">"."</span> + status[k % <span class="hljs-number">3</span>];
                    channel.basicPublish(EXCHANGE_NAME, routeKey,
                            <span class="hljs-keyword">null</span>, message.getBytes());
                    System.out.println(<span class="hljs-string">" [x] Sent '"</span> + routeKey + <span class="hljs-string">":'"</span>
                            + message + <span class="hljs-string">"'"</span>);
                &#125;
            &#125;
        &#125;
        channel.close();
        connection.close();
    &#125;
&#125;</code></pre>

<p>åˆ›å»º<code>#</code>ç±»å‹çš„æ¶ˆè´¹è€…ï¼Œè¯¥æ¶ˆè´¹è€…å°†è®¢é˜…æ‰€æœ‰æ¶ˆæ¯</p>
<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AllConsumer</span> </span>&#123;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] argv)</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException </span>&#123;
        ConnectionFactory factory = <span class="hljs-keyword">new</span> ConnectionFactory();
        factory.setHost(<span class="hljs-string">"127.0.0.1"</span>);
        Connection connection = factory.newConnection();
        <span class="hljs-keyword">final</span> Channel channel = connection.createChannel();
        channel.exchangeDeclare(TopicProducer.EXCHANGE_NAME,
                BuiltinExchangeType.TOPIC);
        String queueName = channel.queueDeclare().getQueue();
        <span class="hljs-comment">//ç»‘å®š</span>
        channel.queueBind(queueName,TopicProducer.EXCHANGE_NAME, <span class="hljs-string">"#"</span>);
        System.out.println(<span class="hljs-string">" [*] Waiting for messages:"</span>);
        <span class="hljs-keyword">final</span> Consumer consumerA = <span class="hljs-keyword">new</span> DefaultConsumer(channel) &#123;
            <span class="hljs-meta">@Override</span>
            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleDelivery</span><span class="hljs-params">(String consumerTag,</span></span>
<span class="hljs-function"><span class="hljs-params">                                       Envelope envelope,</span></span>
<span class="hljs-function"><span class="hljs-params">                                       AMQP.BasicProperties properties,</span></span>
<span class="hljs-function"><span class="hljs-params">                                       <span class="hljs-keyword">byte</span>[] body)</span></span>
<span class="hljs-function">                    <span class="hljs-keyword">throws</span> IOException </span>&#123;
                String message = <span class="hljs-keyword">new</span> String(body, <span class="hljs-string">"UTF-8"</span>);
                System.out.println(<span class="hljs-string">" AllConsumer Received "</span>
                        + envelope.getRoutingKey()
                        + <span class="hljs-string">"':'"</span> + message + <span class="hljs-string">"'"</span>);
            &#125;
        &#125;;
        channel.basicConsume(queueName, <span class="hljs-keyword">true</span>, consumerA);
    &#125;
&#125;</code></pre>

<p>åˆ›å»º<code>TYPE_A.#</code>ç±»å‹çš„æ¶ˆè´¹è€…ï¼Œè¯¥æ¶ˆè´¹è€…å°†æ¥æ”¶æ‰€æœ‰ç¬¬ä¸€ä½ä¸º<code>TYPE_A</code>çš„æ¶ˆæ¯ã€‚</p>
<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TypeConsumer</span> </span>&#123;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] argv)</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException </span>&#123;
        ConnectionFactory factory = <span class="hljs-keyword">new</span> ConnectionFactory();
        factory.setHost(<span class="hljs-string">"127.0.0.1"</span>);
        Connection connection = factory.newConnection();
        <span class="hljs-keyword">final</span> Channel channel = connection.createChannel();
        channel.exchangeDeclare(TopicProducer.EXCHANGE_NAME,
                BuiltinExchangeType.TOPIC);
        String queueName = channel.queueDeclare().getQueue();
        channel.queueBind(queueName, TopicProducer.EXCHANGE_NAME,
                <span class="hljs-string">"TYPE_A.#"</span>);
        System.out.println(<span class="hljs-string">" [*] Waiting for messages:"</span>);
        <span class="hljs-keyword">final</span> Consumer consumerA = <span class="hljs-keyword">new</span> DefaultConsumer(channel) &#123;
            <span class="hljs-meta">@Override</span>
            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleDelivery</span><span class="hljs-params">(String consumerTag,</span></span>
<span class="hljs-function"><span class="hljs-params">                                       Envelope envelope,</span></span>
<span class="hljs-function"><span class="hljs-params">                                       AMQP.BasicProperties properties,</span></span>
<span class="hljs-function"><span class="hljs-params">                                       <span class="hljs-keyword">byte</span>[] body)</span></span>
<span class="hljs-function">                    <span class="hljs-keyword">throws</span> IOException </span>&#123;
                String message = <span class="hljs-keyword">new</span> String(body, <span class="hljs-string">"UTF-8"</span>);
                System.out.println(<span class="hljs-string">" AllConsumer Received "</span>
                        + envelope.getRoutingKey()
                        + <span class="hljs-string">"':'"</span> + message + <span class="hljs-string">"'"</span>);
            &#125;
        &#125;;
        channel.basicConsume(queueName, <span class="hljs-keyword">true</span>, consumerA);
    &#125;
&#125;</code></pre>

<p>åˆ›å»º<code>*.moduleA.*</code>ç±»å‹çš„æ¶ˆè´¹è€…ï¼Œè¯¥æ¶ˆè´¹è€…å°†æ¥æ”¶æ‰€æœ‰ç¬¬äºŒä½ä¸º<code>moduleA</code>çš„æ¶ˆæ¯</p>
<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ModuleConsumer</span> </span>&#123;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] argv)</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException </span>&#123;
        ConnectionFactory factory = <span class="hljs-keyword">new</span> ConnectionFactory();
        factory.setHost(<span class="hljs-string">"127.0.0.1"</span>);
        Connection connection = factory.newConnection();
        <span class="hljs-keyword">final</span> Channel channel = connection.createChannel();

        channel.exchangeDeclare(TopicProducer.EXCHANGE_NAME,
                BuiltinExchangeType.TOPIC);
        String queueName = channel.queueDeclare().getQueue();
        channel.queueBind(queueName, TopicProducer.EXCHANGE_NAME, <span class="hljs-string">"*.moduleA.*"</span>);
        System.out.println(<span class="hljs-string">" [*] Waiting for messages:"</span>);
        <span class="hljs-keyword">final</span> Consumer consumerA = <span class="hljs-keyword">new</span> DefaultConsumer(channel) &#123;
            <span class="hljs-meta">@Override</span>
            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleDelivery</span><span class="hljs-params">(String consumerTag,</span></span>
<span class="hljs-function"><span class="hljs-params">                                       Envelope envelope,</span></span>
<span class="hljs-function"><span class="hljs-params">                                       AMQP.BasicProperties properties,</span></span>
<span class="hljs-function"><span class="hljs-params">                                       <span class="hljs-keyword">byte</span>[] body)</span></span>
<span class="hljs-function">                    <span class="hljs-keyword">throws</span> IOException </span>&#123;
                String message = <span class="hljs-keyword">new</span> String(body, <span class="hljs-string">"UTF-8"</span>);
                System.out.println(<span class="hljs-string">" AllConsumer Received "</span>
                        + envelope.getRoutingKey()
                        + <span class="hljs-string">"':'"</span> + message + <span class="hljs-string">"'"</span>);
            &#125;
        &#125;;
        channel.basicConsume(queueName, <span class="hljs-keyword">true</span>, consumerA);
    &#125;
&#125;</code></pre>

<p>åŒæ ·ï¼Œè¿˜å¯ä»¥åˆ›å»º<code>#.0</code>ã€<code>*.moduleA.1</code>ã€<code>TYPE_B.moduleC.2</code>ç­‰ç±»å‹çš„æ¶ˆè´¹è€…ï¼Œæ¥åŒ¹é…å¯¹åº”çš„æ¶ˆæ¯ã€‚</p>
<h2 id="æ¶ˆæ¯å‘å¸ƒæ—¶çš„æƒè¡¡"><a href="#æ¶ˆæ¯å‘å¸ƒæ—¶çš„æƒè¡¡" class="headerlink" title="æ¶ˆæ¯å‘å¸ƒæ—¶çš„æƒè¡¡"></a>æ¶ˆæ¯å‘å¸ƒæ—¶çš„æƒè¡¡</h2><p>ä¸åšä»»ä½•é…ç½®çš„æƒ…å†µä¸‹ï¼Œç”Ÿäº§è€…æ˜¯ä¸çŸ¥é“æ¶ˆæ¯æ˜¯å¦çœŸæ­£åˆ°è¾¾äº†RabbitMQï¼Œä¹Ÿå°±æ˜¯è¯´æ¶ˆæ¯å‘å¸ƒæ“ä½œä¸è¿”å›ä»»ä½•ä¿¡æ¯ç»™ç”Ÿäº§è€…ï¼Œé€šå¸¸æœ‰ä»¥ä¸‹å‡ ç§æ–¹å¼æ¥ä¿è¯æ¶ˆæ¯çš„å¯é æ€§ã€‚</p>
<img src="/blog/2020/05/08/RabbitMQ%E4%B8%AD%E6%B6%88%E6%81%AF%E5%8F%91%E5%B8%83%E4%B8%8E%E6%9D%83%E8%A1%A1/pic1.png" srcset="/blog/img/loading.gif" class>

<p>åœ¨RabbitMQä¸­ï¼Œæœ‰ä¸åŒçš„æŠ•é€’æœºåˆ¶ï¼ˆç”Ÿäº§è€…ï¼‰ï¼Œä½†æ˜¯æ¯ä¸€ç§æœºåˆ¶éƒ½å¯¹æ€§èƒ½æœ‰ä¸€å®šçš„å½±å“ã€‚ä¸€èˆ¬æ¥è®²é€Ÿåº¦å¿«çš„å¯é æ€§ä½ï¼Œå¯é æ€§å¥½çš„æ€§èƒ½å·®ï¼Œå…·ä½“æ€ä¹ˆä½¿ç”¨éœ€è¦æ ¹æ®åº”ç”¨ç¨‹åºæ¥å®šï¼Œæ‰€ä»¥è¯´æ²¡æœ‰æœ€å¥½çš„æ–¹å¼ï¼Œåªæœ‰æœ€åˆé€‚çš„æ–¹å¼ã€‚</p>
<p>åœ¨RabbitMQä¸­å®é™…é¡¹ç›®ä¸­ï¼Œç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…éƒ½æ˜¯å®¢æˆ·ç«¯ï¼Œå®ƒä»¬éƒ½å¯ä»¥å®Œæˆäº¤æ¢å™¨ã€é˜Ÿåˆ—å’Œç»‘å®šå…³ç³»çš„ç”³æ˜ï¼Œä½†æ˜¯åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œé€šå¸¸åœ¨ç”Ÿäº§è€…ä»£ç ä¸­ç”³æ˜äº¤æ¢å™¨ï¼Œåœ¨æ¶ˆè´¹è€…ä»£ç ä¸­ç”³æ˜é˜Ÿåˆ—å’Œç»‘å®šå…³ç³»ã€‚ä½†ç”Ÿäº§è€…å‘å¸ƒæ¶ˆæ¯æ—¶ä¸ä¸€å®šéå¾—éœ€è¦æ¶ˆè´¹è€…ï¼Œå¯¹äºRabbitMQæ¥è¯´ï¼Œå¦‚æœæ˜¯å•çº¯çš„ç”Ÿäº§è€…å°±åªéœ€è¦ç”Ÿäº§è€…å®¢æˆ·ç«¯ç”³æ˜äº¤æ¢å™¨ã€é˜Ÿåˆ—ã€ç¡®å®šç»‘å®šå…³ç³»ï¼Œå°±å¯ä»¥å°†æ¶ˆæ¯å‘é€è‡³RabbitMQã€‚</p>
<h3 id="æ— ä¿éšœ"><a href="#æ— ä¿éšœ" class="headerlink" title="æ— ä¿éšœ"></a>æ— ä¿éšœ</h3><p>åœ¨æ¼”ç¤ºå„ç§äº¤æ¢å™¨ä¸­ä½¿ç”¨çš„å°±æ˜¯æ— ä¿éšœçš„æ–¹å¼ï¼Œé€šè¿‡basicPublishå‘å¸ƒä½ çš„æ¶ˆæ¯å¹¶ä½¿ç”¨æ­£ç¡®çš„äº¤æ¢å™¨å’Œè·¯ç”±ä¿¡æ¯ï¼Œä½ çš„æ¶ˆæ¯ä¼šè¢«æ¥æ”¶å¹¶å‘é€åˆ°åˆé€‚çš„é˜Ÿåˆ—ä¸­ã€‚ä½†æ˜¯å¦‚æœæœ‰ç½‘ç»œé—®é¢˜ï¼Œæˆ–è€…æ¶ˆæ¯ä¸å¯è·¯ç”±ï¼Œæˆ–è€…RabbitMQè‡ªèº«æœ‰é—®é¢˜çš„è¯ï¼Œè¿™ç§æ–¹å¼å°±æœ‰é£é™©ã€‚æ‰€ä»¥æ— ä¿è¯çš„æ¶ˆæ¯å‘é€ä¸€èˆ¬æƒ…å†µä¸‹ä¸æ¨èã€‚</p>
<h3 id="å¤±è´¥ç¡®è®¤"><a href="#å¤±è´¥ç¡®è®¤" class="headerlink" title="å¤±è´¥ç¡®è®¤"></a>å¤±è´¥ç¡®è®¤</h3><p>åœ¨å‘é€æ¶ˆæ¯æ—¶è®¾ç½®mandatoryæ ‡å¿—ï¼Œå‘Šè¯‰RabbitMQï¼Œå¦‚æœæ¶ˆæ¯ä¸å¯è·¯ç”±ï¼Œåº”è¯¥å°†æ¶ˆæ¯è¿”å›ç»™å‘é€è€…ï¼Œå¹¶é€šçŸ¥å¤±è´¥ã€‚å¯ä»¥è¿™æ ·è®¤ä¸ºï¼Œå¼€å¯mandatoryæ˜¯å¼€å¯æ•…éšœæ£€æµ‹æ¨¡å¼ã€‚<br>ä½†æ˜¯å®ƒåªä¼šè®©RabbitMQå‘ä½ é€šçŸ¥å¤±è´¥ï¼Œè€Œä¸ä¼šé€šçŸ¥æˆåŠŸã€‚å¦‚æœæ¶ˆæ¯æ­£ç¡®è·¯ç”±åˆ°é˜Ÿåˆ—ï¼Œåˆ™å‘å¸ƒè€…ä¸ä¼šæ”¶åˆ°ä»»ä½•é€šçŸ¥ã€‚å¸¦æ¥çš„é—®é¢˜æ˜¯æ— æ³•ç¡®ä¿å‘å¸ƒæ¶ˆæ¯ä¸€å®šæ˜¯æˆåŠŸçš„ï¼Œå› ä¸ºé€šçŸ¥å¤±è´¥çš„æ¶ˆæ¯å¯èƒ½ä¼šä¸¢å¤±ã€‚</p>
<p>å…·ä½“ä½¿ç”¨ï¼š</p>
<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DirectProducer</span> </span>&#123;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> String EXCHANGE_NAME = <span class="hljs-string">"direct_logs"</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> String[] ROUTE_KEYS = &#123;<span class="hljs-string">"route_key_1"</span>, <span class="hljs-string">"route_key_2"</span>, <span class="hljs-string">"route_key_3"</span>&#125;;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span></span>
<span class="hljs-function">            <span class="hljs-keyword">throws</span> IOException, TimeoutException, InterruptedException </span>&#123;
        ConnectionFactory connectionFactory = <span class="hljs-keyword">new</span> ConnectionFactory();
        connectionFactory.setHost(<span class="hljs-string">"localhost"</span>);
        Connection connection = connectionFactory.newConnection();
        Channel channel = connection.createChannel();
        channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.DIRECT);
      
        <span class="hljs-comment">//æ¶ˆæ¯å‘é€å¤±è´¥æ—¶å›è°ƒ</span>
        channel.addReturnListener(<span class="hljs-keyword">new</span> ReturnListener() &#123;
            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleReturn</span><span class="hljs-params">(<span class="hljs-keyword">int</span> replyCode, String replyText, String exchange, String routeKey, AMQP.BasicProperties basicProperties, <span class="hljs-keyword">byte</span>[] bytes)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;
                String string = <span class="hljs-keyword">new</span> String(bytes);
                System.out.println(<span class="hljs-string">"å›è°ƒå†…å®¹ï¼šreplyCodeï¼š"</span> + replyCode);
                System.out.println(<span class="hljs-string">"å›è°ƒå†…å®¹ï¼šreplyTextï¼š"</span> + replyText);
                System.out.println(<span class="hljs-string">"å›è°ƒå†…å®¹ï¼šexchangeï¼š"</span> + exchange);
                System.out.println(<span class="hljs-string">"å›è°ƒå†…å®¹ï¼šrouteKeyï¼š"</span> + routeKey);
                System.out.println(<span class="hljs-string">"å›è°ƒå†…å®¹ï¼šcontentï¼š"</span> + string);
            &#125;
        &#125;);
      
        <span class="hljs-comment">//è¿æ¥å…³é—­æ—¶çš„å›è°ƒ</span>
        connection.addShutdownListener(<span class="hljs-keyword">new</span> ShutdownListener() &#123;
            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">shutdownCompleted</span><span class="hljs-params">(ShutdownSignalException e)</span> </span>&#123;

            &#125;
        &#125;);
        
        <span class="hljs-comment">//ä¿¡é“å…³é—­æ—¶çš„å›æ‰</span>
        channel.addShutdownListener(<span class="hljs-keyword">new</span> ShutdownListener() &#123;
            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">shutdownCompleted</span><span class="hljs-params">(ShutdownSignalException e)</span> </span>&#123;

            &#125;
        &#125;);
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">6</span>; i++) &#123;
            String routeKey = ROUTE_KEYS[i % <span class="hljs-number">3</span>];
            String msg = <span class="hljs-string">"Hello,RabbitMQ"</span> + (i + <span class="hljs-number">1</span>);
            <span class="hljs-comment">//å‘å¸ƒæ¶ˆæ¯ ç¬¬ä¸‰ä¸ªå‚æ•°ä¸ºtrueè¡¨ç¤ºå¼€å¯å¤±è´¥é€šçŸ¥</span>
            channel.basicPublish(EXCHANGE_NAME, routeKey, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">null</span>, msg.getBytes());
            System.out.println(<span class="hljs-string">"Sent:"</span> + routeKey + <span class="hljs-string">":"</span> + msg);
            TimeUnit.MICROSECONDS.sleep(<span class="hljs-number">200</span>);
        &#125;
        channel.close();
        connection.close();
    &#125;
&#125;</code></pre>

<h3 id="äº‹åŠ¡"><a href="#äº‹åŠ¡" class="headerlink" title="äº‹åŠ¡"></a>äº‹åŠ¡</h3><p>äº‹åŠ¡çš„å®ç°ä¸»è¦æ˜¯å¯¹ä¿¡é“ï¼ˆChannelï¼‰çš„è®¾ç½®ï¼Œä¸»è¦çš„æ–¹æ³•æœ‰ä¸‰ä¸ª:</p>
<ol>
<li>channel.txSelect()å£°æ˜å¯åŠ¨äº‹åŠ¡æ¨¡å¼;</li>
<li>channel.txComment()æäº¤äº‹åŠ¡;</li>
<li>channel.txRollback()å›æ»šäº‹åŠ¡;</li>
</ol>
<p>åœ¨å‘é€æ¶ˆæ¯ä¹‹å‰ï¼Œéœ€è¦å£°æ˜channelä¸ºäº‹åŠ¡æ¨¡å¼ï¼Œæäº¤æˆ–è€…å›æ»šäº‹åŠ¡å³å¯ã€‚ å¼€å¯äº‹åŠ¡åï¼Œå®¢æˆ·ç«¯å’ŒRabbitMQä¹‹é—´çš„é€šè®¯äº¤äº’æµç¨‹:</p>
<ul>
<li>å®¢æˆ·ç«¯å‘é€ç»™æœåŠ¡å™¨ Tx.Select(å¼€å¯äº‹åŠ¡æ¨¡å¼)</li>
<li>æœåŠ¡å™¨ç«¯è¿”å› Tx.Select-Ok(å¼€å¯äº‹åŠ¡æ¨¡å¼ ok) ï‚· æ¨é€æ¶ˆæ¯</li>
<li>å®¢æˆ·ç«¯å‘é€ç»™äº‹åŠ¡æäº¤ Tx.Commit</li>
</ul>
<p>æœåŠ¡å™¨ç«¯è¿”å› Tx.Commit-Ok<br>ä»¥ä¸Šå°±å®Œæˆäº†äº‹åŠ¡çš„äº¤äº’æµç¨‹ï¼Œå¦‚æœå…¶ä¸­ä»»æ„ä¸€ä¸ªç¯èŠ‚å‡ºç°é—®é¢˜ï¼Œå°±ä¼šæŠ›å‡º IoExceptionï¼Œè¿™æ ·ç”¨æˆ·å°±å¯ä»¥æ‹¦æˆªå¼‚å¸¸è¿›è¡Œäº‹åŠ¡å›æ»šï¼Œæˆ–å†³å®šè¦ä¸è¦é‡å¤æ¶ˆæ¯ã€‚</p>
<p>ä½†æ˜¯äº‹åŠ¡æœºåˆ¶æœ¬èº«ä¹Ÿä¼šå¸¦æ¥é—®é¢˜ï¼š</p>
<ol>
<li><p>ä¸¥é‡çš„æ€§èƒ½é—®é¢˜ï¼ŒåŠ å…¥äº‹åŠ¡åå°†ä¼šå¯¼è‡´2-10å€çš„æ€§èƒ½ä¸‹é™ã€‚</p>
</li>
<li><p>ä½¿åº”ç”¨ç¨‹åºäº§ç”ŸåŒæ­¥ã€‚</p>
</li>
</ol>
<p>å…·ä½“ä½¿ç”¨ï¼š</p>
<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProducerTransaction</span> </span>&#123;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> String EXCHANGE_NAME = <span class="hljs-string">"producer_transaction"</span>;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span></span>
<span class="hljs-function">            <span class="hljs-keyword">throws</span> IOException, TimeoutException, InterruptedException </span>&#123;
        ConnectionFactory factory = <span class="hljs-keyword">new</span> ConnectionFactory();
        factory.setHost(<span class="hljs-string">"127.0.0.1"</span>);
        Connection connection = factory.newConnection();
        Channel channel = connection.createChannel();
        channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.DIRECT);
        String[] routekeys=&#123;<span class="hljs-string">"keys1"</span>,<span class="hljs-string">"keys2"</span>,<span class="hljs-string">"keys3"</span>&#125;;
        <span class="hljs-comment">//å¼€å¯äº‹åŠ¡</span>
        channel.txSelect();
        <span class="hljs-keyword">try</span> &#123;
            <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">3</span>;i++)&#123;
                String routekey = routekeys[i%<span class="hljs-number">3</span>];
                String message = <span class="hljs-string">"Hello World_"</span>+(i+<span class="hljs-number">1</span>)
                        +(<span class="hljs-string">"_"</span>+System.currentTimeMillis());
                channel.basicPublish(EXCHANGE_NAME, routekey, <span class="hljs-keyword">true</span>,
                        <span class="hljs-keyword">null</span>, message.getBytes());
                System.out.println(<span class="hljs-string">"----------------------------------"</span>);
                System.out.println(<span class="hljs-string">" Sent Message: ["</span> + routekey +<span class="hljs-string">"]:'"</span>
                        + message + <span class="hljs-string">"'"</span>);
                Thread.sleep(<span class="hljs-number">200</span>);
            &#125;
            <span class="hljs-comment">//äº‹åŠ¡æäº¤</span>
            channel.txCommit();
        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;
            e.printStackTrace();
            <span class="hljs-comment">//äº‹åŠ¡å›æ»š</span>
            channel.txRollback();
        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;
            e.printStackTrace();
        &#125;
        channel.close();
        connection.close();
    &#125;
&#125;</code></pre>

<h3 id="å‘å¸ƒè€…ç¡®è®¤"><a href="#å‘å¸ƒè€…ç¡®è®¤" class="headerlink" title="å‘å¸ƒè€…ç¡®è®¤"></a>å‘å¸ƒè€…ç¡®è®¤</h3><p>åŸºäºäº‹åŠ¡çš„æ€§èƒ½é—®é¢˜ï¼ŒRabbitMQå›¢é˜Ÿä¸ºæˆ‘ä»¬æ‹¿å‡ºäº†æ›´å¥½çš„æ–¹æ¡ˆï¼Œå³é‡‡ç”¨å‘é€æ–¹ç¡®è®¤æ¨¡å¼ï¼Œè¯¥æ¨¡å¼æ¯”äº‹åŠ¡æ›´è½»é‡ï¼Œæ€§èƒ½å½±å“å‡ ä¹å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚</p>
<p>åŸç†ï¼šç”Ÿäº§è€…å°†ä¿¡é“è®¾ç½®æˆconfirmæ¨¡å¼ï¼Œä¸€æ—¦ä¿¡é“è¿›å…¥confirmæ¨¡å¼ï¼Œæ‰€æœ‰åœ¨è¯¥ä¿¡é“ä¸Šé¢å‘å¸ƒçš„æ¶ˆæ¯éƒ½å°†ä¼šè¢«æŒ‡æ´¾ä¸€ä¸ªå”¯ä¸€çš„IDï¼ˆä»1å¼€å§‹ï¼‰ï¼Œç”±è¿™ä¸ªidåœ¨ç”Ÿäº§è€…å’ŒRabbitMQä¹‹é—´è¿›è¡Œæ¶ˆæ¯çš„ç¡®è®¤ã€‚</p>
<p>ä¸å¯è·¯ç”±çš„æ¶ˆæ¯ï¼Œå½“äº¤æ¢å™¨å‘ç°æ¶ˆæ¯ä¸èƒ½è·¯ç”±åˆ°ä»»ä½•é˜Ÿåˆ—ï¼Œä¼šè¿›è¡Œå¤±è´¥ç¡®è®¤æ“ä½œï¼Œè¡¨ç¤ºæ”¶åˆ°äº†æ¶ˆæ¯ã€‚å¦‚æœå‘é€æ–¹è®¾ç½®äº†mandatoryæ¨¡å¼ï¼Œåˆ™ä¼šè°ƒç”¨addReturnListener()æ–¹æ³•è®¾ç½®çš„ç›‘å¬å™¨ã€‚</p>
<p>å¯è·¯ç”±çš„æ¶ˆæ¯ï¼Œè¦ç­‰åˆ°æ¶ˆæ¯è¢«æŠ•é€’åˆ°æ‰€æœ‰åŒ¹é…çš„é˜Ÿåˆ—ä¹‹åï¼Œbrokerä¼šå‘é€ä¸€ä¸ªç¡®è®¤ç»™ç”Ÿäº§è€…ï¼ˆåŒ…å«æ¶ˆæ¯çš„å”¯ä¸€IDï¼‰ï¼Œå¦‚æœæ¶ˆæ¯å’Œé˜Ÿåˆ—æ˜¯å¯æŒä¹…åŒ–çš„ï¼Œé‚£ä¹ˆç¡®è®¤æ¶ˆæ¯ä¼šåœ¨å°†æ¶ˆæ¯å†™å…¥ç£ç›˜ä¹‹åå‘å‡ºï¼Œbrokerå›ä¼ ç»™ç”Ÿäº§è€…çš„ç¡®è®¤æ¶ˆæ¯ä¸­çš„delivery-tagåŸŸåŒ…å«äº†ç¡®è®¤æ¶ˆæ¯çš„åºåˆ—å·ã€‚</p>
<img src="/blog/2020/05/08/RabbitMQ%E4%B8%AD%E6%B6%88%E6%81%AF%E5%8F%91%E5%B8%83%E4%B8%8E%E6%9D%83%E8%A1%A1/pic5.png" srcset="/blog/img/loading.gif" class>

<p>confirmæ¨¡å¼æœ€å¤§çš„å¥½å¤„åœ¨äºä»–å¯ä»¥æ˜¯å¼‚æ­¥çš„ï¼Œæ¶ˆæ¯å‘é€å®Œæˆåç”Ÿäº§è€…å¯ä»¥åœ¨ç­‰ä¿¡é“è¿”å›æ—¶ï¼Œç»§ç»­å‘é€ä¸‹ä¸€æ¡æ¶ˆæ¯ï¼Œå½“æ¶ˆæ¯æœ€ç»ˆå¾—åˆ°ç¡®è®¤ä¹‹åï¼Œç”Ÿäº§è€…å¯ä»¥é€šè¿‡å›è°ƒæ–¹æ³•æ¥å¤„ç†è¯¥ç¡®è®¤æ¶ˆæ¯ï¼Œå¦‚æœRabbitMQå› ä¸ºè‡ªèº«å†…éƒ¨é”™è¯¯å¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ï¼Œå°±ä¼šå‘é€ä¸€æ¡nackæ¶ˆæ¯ï¼Œç”Ÿäº§è€…åº”ç”¨ç¨‹åºåŒæ ·å¯ä»¥åœ¨å›è°ƒæ–¹æ³•ä¸­å¤„ç†è¯¥nackæ¶ˆæ¯å†³å®šä¸‹ä¸€æ­¥çš„æ“ä½œã€‚ </p>
<p>Confirmçš„ä¸‰ç§å®ç°æ–¹å¼ï¼š</p>
<ul>
<li><p>channel.waitForConfirms()æ™®é€šå‘é€æ–¹ç¡®è®¤æ¨¡å¼ï¼Œæ¶ˆæ¯åˆ°è¾¾äº¤æ¢å™¨å°±ä¼šè¿”å›trueã€‚</p>
<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProducerConfirm</span> </span>&#123;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> String EXCHANGE_NAME = <span class="hljs-string">"producer_confirm"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> String ROUTE_KEY = <span class="hljs-string">"test"</span>;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException, InterruptedException </span>&#123;
        ConnectionFactory factory = <span class="hljs-keyword">new</span> ConnectionFactory();
        factory.setHost(<span class="hljs-string">"127.0.0.1"</span>);
        Connection connection = factory.newConnection();
        Channel channel = connection.createChannel();
        channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.DIRECT);
        channel.addReturnListener(<span class="hljs-keyword">new</span> ReturnListener() &#123;
            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleReturn</span><span class="hljs-params">(<span class="hljs-keyword">int</span> replyCode, String replyText,</span></span>
<span class="hljs-function"><span class="hljs-params">                                     String exchange, String routingKey,</span></span>
<span class="hljs-function"><span class="hljs-params">                                     AMQP.BasicProperties properties,</span></span>
<span class="hljs-function"><span class="hljs-params">                                     <span class="hljs-keyword">byte</span>[] body)</span></span>
<span class="hljs-function">                    <span class="hljs-keyword">throws</span> IOException </span>&#123;
                String message = <span class="hljs-keyword">new</span> String(body);
                System.out.println(<span class="hljs-string">"RabbitMqè¿”å›çš„replyCode:  "</span> + replyCode);
                System.out.println(<span class="hljs-string">"RabbitMqè¿”å›çš„replyText:  "</span> + replyText);
                System.out.println(<span class="hljs-string">"RabbitMqè¿”å›çš„exchange:  "</span> + exchange);
                System.out.println(<span class="hljs-string">"RabbitMqè¿”å›çš„routingKey:  "</span> + routingKey);
                System.out.println(<span class="hljs-string">"RabbitMqè¿”å›çš„message:  "</span> + message);
            &#125;
        &#125;);
        <span class="hljs-comment">// å¯ç”¨å‘é€è€…ç¡®è®¤æ¨¡å¼</span>
        channel.confirmSelect();
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">2</span>; i++) &#123;
            String message = <span class="hljs-string">"Hello World_"</span> + (i + <span class="hljs-number">1</span>);
            channel.basicPublish(EXCHANGE_NAME, ROUTE_KEY, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">null</span>, message.getBytes());
            System.out.println(<span class="hljs-string">" Sent Message: ["</span> + ROUTE_KEY + <span class="hljs-string">"]:'"</span> + message + <span class="hljs-string">"'"</span>);
            <span class="hljs-comment">//ç¡®è®¤æ˜¯å¦æˆåŠŸ(trueæˆåŠŸ)</span>
            <span class="hljs-keyword">if</span> (channel.waitForConfirms()) &#123;
                System.out.println(<span class="hljs-string">"send success"</span>);
            &#125; <span class="hljs-keyword">else</span> &#123;
                System.out.println(<span class="hljs-string">"send failure"</span>);
            &#125;
        &#125;
        channel.close();
        connection.close();
    &#125;
&#125;</code></pre>
</li>
<li><p>channel.waitForConfirmsOrDie()æ‰¹é‡ç¡®è®¤æ¨¡å¼ï¼Œä½¿ç”¨åŒæ­¥æ–¹å¼ç­‰æ‰€æœ‰çš„æ¶ˆæ¯å‘é€ä¹‹åæ‰ä¼šæ‰§è¡Œåé¢ä»£ç ï¼Œåªè¦æœ‰ä¸€ä¸ªæ¶ˆæ¯æœªåˆ°è¾¾äº¤æ¢å™¨å°±ä¼š æŠ›å‡ºIOExceptionå¼‚å¸¸ã€‚</p>
<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProducerBatchConfirm</span> </span>&#123;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> String EXCHANGE_NAME = <span class="hljs-string">"producer_wait_confirm"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> String ROUTE_KEY = <span class="hljs-string">"test"</span>;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException, InterruptedException </span>&#123;
        ConnectionFactory factory = <span class="hljs-keyword">new</span> ConnectionFactory();
        factory.setHost(<span class="hljs-string">"127.0.0.1"</span>);
        Connection connection = factory.newConnection();
        Channel channel = connection.createChannel();
        channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.DIRECT);
        channel.addReturnListener(<span class="hljs-keyword">new</span> ReturnListener() &#123;
            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleReturn</span><span class="hljs-params">(<span class="hljs-keyword">int</span> replyCode, String replyText,</span></span>
<span class="hljs-function"><span class="hljs-params">                                     String exchange, String routingKey,</span></span>
<span class="hljs-function"><span class="hljs-params">                                     AMQP.BasicProperties properties,</span></span>
<span class="hljs-function"><span class="hljs-params">                                     <span class="hljs-keyword">byte</span>[] body)</span></span>
<span class="hljs-function">                    <span class="hljs-keyword">throws</span> IOException </span>&#123;
                String message = <span class="hljs-keyword">new</span> String(body);
                System.out.println(<span class="hljs-string">"RabbitMqè¿”å›çš„replyCode:  "</span> + replyCode);
                System.out.println(<span class="hljs-string">"RabbitMqè¿”å›çš„replyText:  "</span> + replyText);
                System.out.println(<span class="hljs-string">"RabbitMqè¿”å›çš„exchange:  "</span> + exchange);
                System.out.println(<span class="hljs-string">"RabbitMqè¿”å›çš„routingKey:  "</span> + routingKey);
                System.out.println(<span class="hljs-string">"RabbitMqè¿”å›çš„message:  "</span> + message);
            &#125;
        &#125;);
        <span class="hljs-comment">// å¯ç”¨å‘é€è€…ç¡®è®¤æ¨¡å¼</span>
        channel.confirmSelect();
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;
            String message = <span class="hljs-string">"Hello World_"</span> + (i + <span class="hljs-number">1</span>);
            channel.basicPublish(EXCHANGE_NAME, ROUTE_KEY, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">null</span>, message.getBytes());
            System.out.println(<span class="hljs-string">" Sent Message: ["</span> + ROUTE_KEY + <span class="hljs-string">"]:'"</span> + message + <span class="hljs-string">"'"</span>);
        &#125;
        <span class="hljs-comment">// æ‰¹é‡ç¡®è®¤ï¼Œå¦‚æœå¤±è´¥ä¼šæŠ›å‡ºå¼‚å¸¸</span>
        channel.waitForConfirmsOrDie();
        channel.close();
        connection.close();
    &#125;
&#125;</code></pre>
</li>
<li><p>channel.addConfirmListener()å¼‚æ­¥ç›‘å¬å‘é€æ–¹ç¡®è®¤æ¨¡å¼ã€‚</p>
<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProducerConfirmAsync</span> </span>&#123;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> String EXCHANGE_NAME = <span class="hljs-string">"producer_async_confirm"</span>;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException, InterruptedException </span>&#123;
        ConnectionFactory factory = <span class="hljs-keyword">new</span> ConnectionFactory();
        factory.setHost(<span class="hljs-string">"127.0.0.1"</span>);
        Connection connection = factory.newConnection();
        Channel channel = connection.createChannel();
        channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.DIRECT);
        <span class="hljs-comment">// å¯ç”¨å‘é€è€…ç¡®è®¤æ¨¡å¼</span>
        channel.confirmSelect();
        <span class="hljs-comment">// æ·»åŠ å‘é€è€…ç¡®è®¤ç›‘å¬å™¨</span>
        channel.addConfirmListener(<span class="hljs-keyword">new</span> ConfirmListener() &#123;
            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleAck</span><span class="hljs-params">(<span class="hljs-keyword">long</span> deliveryTag, <span class="hljs-keyword">boolean</span> multiple)</span></span>
<span class="hljs-function">                    <span class="hljs-keyword">throws</span> IOException </span>&#123;
                System.out.println(<span class="hljs-string">"send_ACK:"</span>+deliveryTag+<span class="hljs-string">",multiple:"</span>+multiple);
            &#125;
            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleNack</span><span class="hljs-params">(<span class="hljs-keyword">long</span> deliveryTag, <span class="hljs-keyword">boolean</span> multiple)</span></span>
<span class="hljs-function">                    <span class="hljs-keyword">throws</span> IOException </span>&#123;
                System.out.println(<span class="hljs-string">"Error----send_NACK:"</span>+deliveryTag+<span class="hljs-string">",multiple:"</span>+multiple);
            &#125;
        &#125;);
      
        channel.addReturnListener(<span class="hljs-keyword">new</span> ReturnListener() &#123;
            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleReturn</span><span class="hljs-params">(<span class="hljs-keyword">int</span> replyCode, String replyText,</span></span>
<span class="hljs-function"><span class="hljs-params">                                     String exchange, String routingKey,</span></span>
<span class="hljs-function"><span class="hljs-params">                                     AMQP.BasicProperties properties,</span></span>
<span class="hljs-function"><span class="hljs-params">                                     <span class="hljs-keyword">byte</span>[] body)</span></span>
<span class="hljs-function">                    <span class="hljs-keyword">throws</span> IOException </span>&#123;
                String message = <span class="hljs-keyword">new</span> String(body);
                System.out.println(<span class="hljs-string">"RabbitMQè·¯ç”±å¤±è´¥:  "</span>+routingKey+<span class="hljs-string">"."</span>+message);
            &#125;
        &#125;);
        String[] routekeys=&#123;<span class="hljs-string">"test"</span>,<span class="hljs-string">"test2"</span>&#125;;
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">20</span>;i++)&#123;
            String routekey = routekeys[i%<span class="hljs-number">2</span>];
            String message = <span class="hljs-string">"Hello World_"</span>+(i+<span class="hljs-number">1</span>)+(<span class="hljs-string">"_"</span>+System.currentTimeMillis());
            channel.basicPublish(EXCHANGE_NAME, routekey, <span class="hljs-keyword">true</span>,
                    MessageProperties.PERSISTENT_BASIC, message.getBytes());
        &#125;
    &#125;
&#125;</code></pre>

</li>
</ul>
<h3 id="å¤‡ç”¨äº¤æ¢å™¨"><a href="#å¤‡ç”¨äº¤æ¢å™¨" class="headerlink" title="å¤‡ç”¨äº¤æ¢å™¨"></a>å¤‡ç”¨äº¤æ¢å™¨</h3><p>åœ¨ç¬¬ä¸€æ¬¡å£°æ˜äº¤æ¢å™¨æ—¶è¢«æŒ‡å®šï¼Œç”¨æ¥æä¾›ä¸€ç§é¢„å…ˆå­˜åœ¨çš„äº¤æ¢å™¨ï¼Œå¦‚æœä¸»äº¤æ¢å™¨æ— æ³•è·¯ç”±æ¶ˆæ¯ï¼Œé‚£ä¹ˆæ¶ˆæ¯å°†è¢«è·¯ç”±åˆ°è¿™ä¸ªæ–°çš„å¤‡ç”¨äº¤æ¢å™¨ã€‚è¿™æ—¶RabbitMQä¹Ÿä¸ä¼šå‘å‘å¸ƒè€…å‘é€å¤±è´¥é€šçŸ¥ï¼Œå› ä¸ºæ¶ˆæ¯å·²ç»å‘é€è‡³å¤‡ç”¨äº¤æ¢å™¨ï¼Œè¡¨ç¤ºæ¶ˆæ¯å·²ç»è¢«è·¯ç”±äº†ã€‚æ³¨æ„ï¼Œå¤‡ç”¨äº¤æ¢å™¨å°±æ˜¯æ™®é€šçš„äº¤æ¢å™¨ï¼Œæ²¡æœ‰ä»»ä½•ç‰¹æ®Šçš„åœ°æ–¹ã€‚</p>
<p>ä½¿ç”¨å¤‡ç”¨äº¤æ¢å™¨ï¼Œå‘å¾€å¸¸ä¸€æ ·ï¼Œå£°æ˜Queueå’Œå¤‡ç”¨äº¤æ¢å™¨ï¼ŒæŠŠQueueç»‘å®šåˆ°å¤‡ç”¨äº¤æ¢å™¨ä¸Šã€‚ç„¶ååœ¨å£°æ˜ä¸»äº¤æ¢å™¨æ—¶ï¼Œé€šè¿‡äº¤æ¢å™¨çš„å‚æ•°ï¼Œalternate-exchangeï¼Œå°†å¤‡ç”¨äº¤æ¢å™¨è®¾ç½®ç»™ä¸»äº¤æ¢å™¨ã€‚å»ºè®®å¤‡ç”¨äº¤æ¢å™¨è®¾ç½®ä¸ºfaoutç±»å‹ï¼ŒQueueç»‘å®šæ—¶çš„è·¯ç”±é”®è®¾ç½®ä¸ºâ€œ#â€ã€‚</p>
<img src="/blog/2020/05/08/RabbitMQ%E4%B8%AD%E6%B6%88%E6%81%AF%E5%8F%91%E5%B8%83%E4%B8%8E%E6%9D%83%E8%A1%A1/pic6.png" srcset="/blog/img/loading.gif" class>

<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BackupExProducer</span> </span>&#123;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> String EXCHANGE_NAME = <span class="hljs-string">"main-exchange"</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> String BAK_EXCHANGE_NAME = <span class="hljs-string">"ae"</span>;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span></span>
<span class="hljs-function">            <span class="hljs-keyword">throws</span> IOException, TimeoutException </span>&#123;
        ConnectionFactory factory = <span class="hljs-keyword">new</span> ConnectionFactory();
        factory.setHost(<span class="hljs-string">"127.0.0.1"</span>);
        Connection connection = factory.newConnection();
        Channel channel = connection.createChannel();
        Map&lt;String,Object&gt; argsMap = <span class="hljs-keyword">new</span> HashMap&lt;String,Object&gt;();
        argsMap.put(<span class="hljs-string">"alternate-exchange"</span>,BAK_EXCHANGE_NAME);
        <span class="hljs-comment">//ä¸»äº¤æ¢å™¨</span>
        channel.exchangeDeclare(EXCHANGE_NAME,<span class="hljs-string">"direct"</span>,
                <span class="hljs-keyword">false</span>,<span class="hljs-keyword">false</span>,argsMap);
        <span class="hljs-comment">//å¤‡ç”¨äº¤æ¢å™¨</span>
        channel.exchangeDeclare(BAK_EXCHANGE_NAME,BuiltinExchangeType.FANOUT,
                <span class="hljs-keyword">true</span>,<span class="hljs-keyword">false</span>,<span class="hljs-keyword">null</span>);
        String[] routekeys=&#123;<span class="hljs-string">"test1"</span>,<span class="hljs-string">"test2"</span>,<span class="hljs-string">"test3"</span>&#125;;
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">3</span>;i++)&#123;
            String routekey = routekeys[i%<span class="hljs-number">3</span>];
            String message = <span class="hljs-string">"Hello World_"</span>+(i+<span class="hljs-number">1</span>);
            channel.basicPublish(EXCHANGE_NAME, routekey,
                    <span class="hljs-keyword">null</span>, message.getBytes());
            System.out.println(<span class="hljs-string">" [x] Sent '"</span> + routekey +<span class="hljs-string">"':'"</span>
                    + message + <span class="hljs-string">"'"</span>);
        &#125;
        channel.close();
        connection.close();
    &#125;

&#125;</code></pre>

<p>ä¸»äº¤æ¢å™¨ç»‘å®šæ¶ˆè´¹è€…</p>
<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MainConsumer</span> </span>&#123;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] argv)</span></span>
<span class="hljs-function">            <span class="hljs-keyword">throws</span> IOException, TimeoutException </span>&#123;
        ConnectionFactory factory = <span class="hljs-keyword">new</span> ConnectionFactory();
        factory.setHost(<span class="hljs-string">"127.0.0.1"</span>);
        Connection connection = factory.newConnection();
        <span class="hljs-keyword">final</span> Channel channel = connection.createChannel();
        String queueName = <span class="hljs-string">"backupexchange"</span>;
        channel.queueDeclare(queueName,
                <span class="hljs-keyword">false</span>,<span class="hljs-keyword">false</span>,
                <span class="hljs-keyword">false</span>,<span class="hljs-keyword">null</span>);
        <span class="hljs-comment">//åªç»‘å®štest1è·¯ç”±é”®</span>
        String routekey=<span class="hljs-string">"test1"</span>;
        channel.queueBind(queueName,
                BackupExProducer.EXCHANGE_NAME, routekey);
        System.out.println(<span class="hljs-string">" [*] Waiting for messages......"</span>);
        <span class="hljs-keyword">final</span> Consumer consumerB = <span class="hljs-keyword">new</span> DefaultConsumer(channel) &#123;
            <span class="hljs-meta">@Override</span>
            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleDelivery</span><span class="hljs-params">(String consumerTag,</span></span>
<span class="hljs-function"><span class="hljs-params">                                       Envelope envelope,</span></span>
<span class="hljs-function"><span class="hljs-params">                                       AMQP.BasicProperties properties,</span></span>
<span class="hljs-function"><span class="hljs-params">                                       <span class="hljs-keyword">byte</span>[] body)</span></span>
<span class="hljs-function">                    <span class="hljs-keyword">throws</span> IOException </span>&#123;
                String message = <span class="hljs-keyword">new</span> String(body, <span class="hljs-string">"UTF-8"</span>);
                System.out.println( <span class="hljs-string">"Received ["</span>
                        + envelope.getRoutingKey() + <span class="hljs-string">"] "</span>+message);
            &#125;
        &#125;;
        channel.basicConsume(queueName, <span class="hljs-keyword">true</span>, consumerB);
    &#125;
&#125;</code></pre>

<p>å‰¯äº¤æ¢å™¨ç»‘å®šæ¶ˆè´¹è€…</p>
<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BackupExConsumer</span> </span>&#123;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] argv)</span></span>
<span class="hljs-function">            <span class="hljs-keyword">throws</span> IOException, TimeoutException </span>&#123;
        ConnectionFactory factory = <span class="hljs-keyword">new</span> ConnectionFactory();
        factory.setHost(<span class="hljs-string">"127.0.0.1"</span>);
        Connection connection = factory.newConnection();
        <span class="hljs-keyword">final</span> Channel channel = connection.createChannel();
        channel.exchangeDeclare(BackupExProducer.BAK_EXCHANGE_NAME,
                BuiltinExchangeType.FANOUT,
                <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>);
        String queueName = <span class="hljs-string">"fetchother"</span>;
        channel.queueDeclare(queueName,
                <span class="hljs-keyword">false</span>,<span class="hljs-keyword">false</span>,
                <span class="hljs-keyword">false</span>,<span class="hljs-keyword">null</span>);
        channel.queueBind(queueName,
                BackupExProducer.BAK_EXCHANGE_NAME, <span class="hljs-string">"#"</span>);
        System.out.println(<span class="hljs-string">" [*] Waiting for messages......"</span>);
        <span class="hljs-keyword">final</span> Consumer consumerB = <span class="hljs-keyword">new</span> DefaultConsumer(channel) &#123;
            <span class="hljs-meta">@Override</span>
            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleDelivery</span><span class="hljs-params">(String consumerTag,</span></span>
<span class="hljs-function"><span class="hljs-params">                                       Envelope envelope,</span></span>
<span class="hljs-function"><span class="hljs-params">                                       AMQP.BasicProperties properties,</span></span>
<span class="hljs-function"><span class="hljs-params">                                       <span class="hljs-keyword">byte</span>[] body)</span></span>
<span class="hljs-function">                    <span class="hljs-keyword">throws</span> IOException </span>&#123;
                String message = <span class="hljs-keyword">new</span> String(body, <span class="hljs-string">"UTF-8"</span>);
                System.out.println( <span class="hljs-string">"Received ["</span>
                        + envelope.getRoutingKey() + <span class="hljs-string">"] "</span>+message);
            &#125;
        &#125;;
        channel.basicConsume(queueName, <span class="hljs-keyword">true</span>, consumerB);
    &#125;
&#125;</code></pre>

<h2 id="æ¶ˆæ¯æ¶ˆè´¹æ—¶çš„æƒè¡¡"><a href="#æ¶ˆæ¯æ¶ˆè´¹æ—¶çš„æƒè¡¡" class="headerlink" title="æ¶ˆæ¯æ¶ˆè´¹æ—¶çš„æƒè¡¡"></a>æ¶ˆæ¯æ¶ˆè´¹æ—¶çš„æƒè¡¡</h2><h3 id="æ¶ˆè´¹çš„è·å–æ–¹å¼"><a href="#æ¶ˆè´¹çš„è·å–æ–¹å¼" class="headerlink" title="æ¶ˆè´¹çš„è·å–æ–¹å¼"></a>æ¶ˆè´¹çš„è·å–æ–¹å¼</h3><ul>
<li><p>æ‹‰å–Getï¼Œæ¶ˆè´¹è€…ä¸»åŠ¨ä»é˜Ÿåˆ—ä¸­æ‹‰å–æ¶ˆæ¯ã€‚</p>
<img src="/blog/2020/05/08/RabbitMQ%E4%B8%AD%E6%B6%88%E6%81%AF%E5%8F%91%E5%B8%83%E4%B8%8E%E6%9D%83%E8%A1%A1/pic7.png" srcset="/blog/img/loading.gif" class>

<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GetMessageConsumer</span> </span>&#123;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] argv)</span></span>
<span class="hljs-function">            <span class="hljs-keyword">throws</span> IOException, TimeoutException, InterruptedException </span>&#123;
        ConnectionFactory factory = <span class="hljs-keyword">new</span> ConnectionFactory();
        factory.setHost(<span class="hljs-string">"127.0.0.1"</span>);
        Connection connection = factory.newConnection();
        <span class="hljs-keyword">final</span> Channel channel = connection.createChannel();
        channel.exchangeDeclare(GetMessageProducer.EXCHANGE_NAME,
                <span class="hljs-string">"direct"</span>);
        String queueName = <span class="hljs-string">"focuserror"</span>;
        channel.queueDeclare(queueName,
                <span class="hljs-keyword">false</span>,<span class="hljs-keyword">false</span>,
                <span class="hljs-keyword">false</span>,<span class="hljs-keyword">null</span>);
        String routekey=<span class="hljs-string">"test"</span>;
        channel.queueBind(queueName,
                GetMessageProducer.EXCHANGE_NAME, routekey);
        System.out.println(<span class="hljs-string">" [*] Waiting for messages......"</span>);
        <span class="hljs-comment">//æ— é™å¾ªç¯æ‹‰å–</span>
        <span class="hljs-keyword">while</span>(<span class="hljs-keyword">true</span>)&#123;
            <span class="hljs-comment">//ä»æŒ‡å®šé˜Ÿåˆ—ä¸­æ‹‰å–ä¸€æ¡æ¶ˆæ¯ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºæ˜¯å¦è‡ªåŠ¨ç¡®è®¤</span>
            GetResponse getResponse = channel.basicGet(queueName, <span class="hljs-keyword">false</span>);
            <span class="hljs-keyword">if</span>(<span class="hljs-keyword">null</span>!=getResponse)&#123;
                System.out.println(<span class="hljs-string">"received["</span>
                        +getResponse.getEnvelope().getRoutingKey()+<span class="hljs-string">"]"</span>
                        +<span class="hljs-keyword">new</span> String(getResponse.getBody()));
            &#125;
            <span class="hljs-comment">//æ¶ˆæ¯æ‰‹åŠ¨ç¡®è®¤ï¼Œç¡®è®¤åæ¶ˆæ¯ä¼šä»é˜Ÿåˆ—ä¸­ç§»é™¤</span>
            channel.basicAck(<span class="hljs-number">0</span>,<span class="hljs-keyword">true</span>);
            Thread.sleep(<span class="hljs-number">1000</span>);
        &#125;
    &#125;
&#125;</code></pre>
</li>
<li><p>æ¨é€Consumeï¼ŒrabbitMQå°†é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ä¸»åŠ¨æ¨é€ç»™æ¶ˆè´¹è€…ï¼Œä¹‹å‰çš„æ¶ˆè´¹è€…ç¤ºä¾‹éƒ½æ˜¯ä½¿ç”¨è¿™ç§æ–¹å¼ã€‚</p>
<img src="/blog/2020/05/08/RabbitMQ%E4%B8%AD%E6%B6%88%E6%81%AF%E5%8F%91%E5%B8%83%E4%B8%8E%E6%9D%83%E8%A1%A1/pic7.png" srcset="/blog/img/loading.gif" class>

</li>
</ul>
<h3 id="æ¶ˆæ¯çš„ç¡®è®¤"><a href="#æ¶ˆæ¯çš„ç¡®è®¤" class="headerlink" title="æ¶ˆæ¯çš„ç¡®è®¤"></a>æ¶ˆæ¯çš„ç¡®è®¤</h3><ul>
<li><p>è‡ªåŠ¨ç¡®è®¤ï¼šåœ¨ä½¿ç”¨<code>channel.basicConsume(queueName,false,consumer);</code>å£°æ˜é˜Ÿåˆ—æ—¶ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºautoAckï¼Œå½“autoAck=trueæ—¶ï¼Œä¸€æ—¦æ¶ˆè´¹è€…æ¥æ”¶åˆ°äº†æ¶ˆæ¯ï¼Œå°±è§†ä¸ºè‡ªåŠ¨ç¡®è®¤äº†æ¶ˆæ¯ã€‚å¦‚æœä¹‹åçš„å¤„ç†è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œä¹Ÿä¸ä¼šå½±å“æ¶ˆæ¯çš„ç¡®è®¤ã€‚æ‰€ä»¥å¾ˆå¤šæ—¶å€™ï¼Œéœ€è¦åœ¨æ¶ˆæ¯å¤„ç†æˆåŠŸåå†ç¡®è®¤æ¶ˆæ¯ï¼Œè¿™æ—¶å°±éœ€è¦æ‰‹åŠ¨ç¡®è®¤ã€‚</p>
</li>
<li><p>æ‰‹åŠ¨ç¡®è®¤ï¼šå½“autoAck=falseæ—¶ï¼ŒRabbitMQä¼šç­‰å¾…æ¶ˆè´¹è€…æ˜¾å¼å‘å›ackä¿¡å·åæ‰ä»å†…å­˜å’Œç£ç›˜ä¸­ï¼ˆå¦‚æœæ˜¯æŒä¹…åŒ–æ¶ˆæ¯çš„è¯ï¼Œæ¶ˆæ¯ä¼šè¢«ä¿å­˜åˆ°ç£ç›˜ä¸­ï¼‰ä¸­ç§»å»æ¶ˆæ¯ã€‚é‡‡ç”¨æ¶ˆæ¯ç¡®è®¤æœºåˆ¶åï¼Œåªè¦ä»¤autoAck=falseï¼Œæ¶ˆè´¹è€…å°±æœ‰è¶³å¤Ÿçš„æ—¶é—´å¤„ç†æ¶ˆæ¯ï¼Œä¸ç”¨æ‹…å¿ƒå¤„ç†æ¶ˆæ¯è¿‡ç¨‹ä¸­æ¶ˆè´¹è€…è¿›ç¨‹æŒ‚æ‰åæ¶ˆæ¯ä¸¢å¤±çš„é—®é¢˜ï¼Œå› ä¸ºRabbitMQä¼šä¸€ç›´æŒæœ‰æ¶ˆæ¯ç›´åˆ°æ¶ˆè´¹è€…æ˜¾å¼è°ƒç”¨basicAckä¸ºæ­¢ã€‚</p>
<p>å½“autoAck=falseæ—¶ï¼Œå¯¹äºRabbitMQæœåŠ¡å™¨ç«¯è€Œè¨€ï¼Œé˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯åˆ†æˆäº†ä¸¤éƒ¨åˆ†ï¼šä¸€éƒ¨åˆ†æ˜¯ç­‰å¾…æŠ•é€’ç»™æ¶ˆè´¹è€…çš„æ¶ˆæ¯ï¼Œä¸€éƒ¨åˆ†æ˜¯å·²ç»æŠ•é€’ç»™æ¶ˆè´¹è€…ä½†æ˜¯è¿˜æ²¡æœ‰æ”¶åˆ°æ¶ˆè´¹è€…ackä¿¡å·çš„æ¶ˆæ¯ã€‚å¦‚æœæœåŠ¡å™¨ç«¯ä¸€ç›´æ²¡æœ‰æ”¶åˆ°æ¶ˆè´¹è€…çš„ackä¿¡å·ï¼Œå¹¶ä¸”æ¶ˆè´¹æ­¤æ¶ˆæ¯çš„æ¶ˆè´¹è€…å·²ç»æ–­å¼€è¿æ¥ï¼Œåˆ™æœåŠ¡å™¨ç«¯ä¼šå®‰æ’è¯¥æ¶ˆæ¯é‡æ–°è¿›å…¥é˜Ÿåˆ—ï¼Œç­‰å¾…æŠ•é€’ç»™ä¸‹ä¸€ä¸ªæ¶ˆè´¹è€…ï¼ˆä¹Ÿå¯èƒ½è¿˜æ˜¯åŸæ¥çš„é‚£ä¸ªæ¶ˆè´¹è€…ï¼‰ã€‚</p>
</li>
</ul>
<h3 id="Qosé¢„å–æ¨¡å¼"><a href="#Qosé¢„å–æ¨¡å¼" class="headerlink" title="Qosé¢„å–æ¨¡å¼"></a>Qosé¢„å–æ¨¡å¼</h3><p>åœ¨ç¡®è®¤æ¶ˆæ¯è¢«æ¥æ”¶ä¹‹å‰ï¼Œæ¶ˆè´¹è€…å¯ä»¥é¢„å…ˆè¦æ±‚æ¥æ”¶ä¸€å®šæ•°é‡çš„æ¶ˆæ¯ï¼Œåœ¨å¤„ç†å®Œä¸€å®šæ•°é‡çš„æ¶ˆæ¯åï¼Œå¯ä»¥è¿›è¡Œæ‰¹é‡ç¡®è®¤ã€‚å¦‚æœæ¶ˆè´¹è€…åº”ç”¨ç¨‹åºåœ¨ç¡®è®¤æ¶ˆæ¯ä¹‹å‰å´©æºƒï¼Œåˆ™æ‰€æœ‰æœªç¡®è®¤çš„æ¶ˆæ¯å°†è¢«é‡æ–°å‘é€ç»™å…¶ä»–æ¶ˆè´¹è€…ã€‚è¿™ç§æœºåˆ¶ä¸€æ–¹é¢å¯ä»¥å®ç°é™é€Ÿï¼ˆå°†æ¶ˆæ¯æš‚å­˜åˆ°RabbitMQå†…å­˜ä¸­ï¼‰çš„ä½œç”¨ï¼Œä¸€æ–¹é¢å¯ä»¥ä¿è¯æ¶ˆæ¯ç¡®è®¤è´¨é‡ã€‚</p>
<p>æ³¨æ„ï¼šæ¶ˆè´¹ç¡®è®¤æ¨¡å¼å¿…é¡»æ˜¯éè‡ªåŠ¨ç¡®è®¤æœºåˆ¶ï¼Œè¿™ä¸ªæ˜¯ä½¿ç”¨baseQosçš„å‰ææ¡ä»¶ï¼Œå¦åˆ™ä¼šQosä¸ç”Ÿæ•ˆï¼Œç„¶åè®¾ç½®basicQosçš„å€¼ã€‚å¦å¤–ï¼Œè¿˜å¯ä»¥åŸºäºconsumeå’Œchannelçš„ç²’åº¦è¿›è¡Œè®¾ç½®ï¼ˆglobalï¼‰ã€‚</p>
<h4 id="æ‰¹é‡ç¡®è®¤"><a href="#æ‰¹é‡ç¡®è®¤" class="headerlink" title="æ‰¹é‡ç¡®è®¤"></a>æ‰¹é‡ç¡®è®¤</h4><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BatchQosConsumer</span> </span>&#123;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] argv)</span></span>
<span class="hljs-function">            <span class="hljs-keyword">throws</span> IOException, TimeoutException </span>&#123;
        ConnectionFactory factory = <span class="hljs-keyword">new</span> ConnectionFactory();
        factory.setHost(<span class="hljs-string">"127.0.0.1"</span>);
        Connection connection = factory.newConnection();
        <span class="hljs-keyword">final</span> Channel channel = connection.createChannel();
        channel.exchangeDeclare(DirectProducer.EXCHANGE_NAME,
                <span class="hljs-string">"direct"</span>);
        String queueName = <span class="hljs-string">"focuserror"</span>;
        channel.queueDeclare(queueName, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>,
                <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>);
        String routekey = <span class="hljs-string">"error"</span>;
        channel.queueBind(queueName, DirectProducer.EXCHANGE_NAME, routekey);
        System.out.println(<span class="hljs-string">"waiting for message........"</span>);
        <span class="hljs-keyword">final</span> Consumer consumer = <span class="hljs-keyword">new</span> DefaultConsumer(channel) &#123;
            <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> meesageCount = <span class="hljs-number">0</span>;
            <span class="hljs-meta">@Override</span>
            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleDelivery</span><span class="hljs-params">(String consumerTag,</span></span>
<span class="hljs-function"><span class="hljs-params">                                       Envelope envelope,</span></span>
<span class="hljs-function"><span class="hljs-params">                                       AMQP.BasicProperties properties,</span></span>
<span class="hljs-function"><span class="hljs-params">                                       <span class="hljs-keyword">byte</span>[] body)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;
                String message = <span class="hljs-keyword">new</span> String(body, <span class="hljs-string">"UTF-8"</span>);
                System.out.println(<span class="hljs-string">"æ‰¹é‡æ¶ˆè´¹è€…---Received["</span> + envelope.getRoutingKey()
                        + <span class="hljs-string">"]"</span> + message);
                meesageCount++;
                <span class="hljs-comment">//æ‰¹é‡ç¡®è®¤50ä¸€æ‰¹</span>
                <span class="hljs-keyword">if</span> (meesageCount % <span class="hljs-number">50</span> == <span class="hljs-number">0</span>) &#123;
                    <span class="hljs-keyword">this</span>.getChannel().basicAck(envelope.getDeliveryTag(), <span class="hljs-keyword">true</span>);
                    System.out.println(<span class="hljs-string">"æ‰¹é‡æ¶ˆæ¯è´¹è¿›è¡Œæ¶ˆæ¯çš„ç¡®è®¤------------"</span>);
                &#125;
                <span class="hljs-comment">//å¦‚æœæ˜¯æœ€åä¸€æ¡æ¶ˆæ¯ï¼Œåˆ™æŠŠå‰©ä½™çš„æ¶ˆæ¯éƒ½è¿›è¡Œç¡®è®¤</span>
                <span class="hljs-keyword">if</span> (message.equals(<span class="hljs-string">"stop"</span>)) &#123; 
                    <span class="hljs-keyword">this</span>.getChannel().basicAck(envelope.getDeliveryTag(), <span class="hljs-keyword">true</span>);
                    System.out.println(<span class="hljs-string">"æ‰¹é‡æ¶ˆè´¹è€…è¿›è¡Œæœ€åä¸šåŠ¡æ¶ˆæ¯çš„ç¡®è®¤---------"</span>);
                &#125;
            &#125;
        &#125;;
        <span class="hljs-comment">//150æ¡é¢„å–</span>
        channel.basicQos(<span class="hljs-number">500</span>, <span class="hljs-keyword">true</span>);
        channel.basicConsume(queueName, <span class="hljs-keyword">false</span>, consumer);
    &#125;
&#125;</code></pre>

<h4 id="å•æ¡ç¡®è®¤"><a href="#å•æ¡ç¡®è®¤" class="headerlink" title="å•æ¡ç¡®è®¤"></a>å•æ¡ç¡®è®¤</h4><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">QosConsumerMain</span> </span>&#123;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] argv)</span></span>
<span class="hljs-function">            <span class="hljs-keyword">throws</span> IOException, TimeoutException </span>&#123;
        ConnectionFactory factory = <span class="hljs-keyword">new</span> ConnectionFactory();
        factory.setHost(<span class="hljs-string">"127.0.0.1"</span>);
        Connection connection = factory.newConnection();
        <span class="hljs-keyword">final</span> Channel channel = connection.createChannel();
        channel.exchangeDeclare(DirectProducer.EXCHANGE_NAME,
                <span class="hljs-string">"direct"</span>);
        String queueName = <span class="hljs-string">"focuserror"</span>;
        channel.queueDeclare(queueName,<span class="hljs-keyword">false</span>,<span class="hljs-keyword">false</span>,
                <span class="hljs-keyword">false</span>,<span class="hljs-keyword">null</span>);
        String routekey = <span class="hljs-string">"test"</span>;
        channel.queueBind(queueName,DirectProducer.EXCHANGE_NAME,routekey);
        System.out.println(<span class="hljs-string">"waiting for message........"</span>);
        <span class="hljs-keyword">final</span> Consumer consumer = <span class="hljs-keyword">new</span> DefaultConsumer(channel)&#123;
            <span class="hljs-meta">@Override</span>
            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleDelivery</span><span class="hljs-params">(String consumerTag,</span></span>
<span class="hljs-function"><span class="hljs-params">                                       Envelope envelope,</span></span>
<span class="hljs-function"><span class="hljs-params">                                       AMQP.BasicProperties properties,</span></span>
<span class="hljs-function"><span class="hljs-params">                                       <span class="hljs-keyword">byte</span>[] body)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;
                String message = <span class="hljs-keyword">new</span> String(body, <span class="hljs-string">"UTF-8"</span>);
                System.out.println(<span class="hljs-string">"Received["</span>+envelope.getRoutingKey()
                        +<span class="hljs-string">"]"</span>+message);
                <span class="hljs-comment">//TODO å•æ¡ç¡®è®¤</span>
                channel.basicAck(envelope.getDeliveryTag(),<span class="hljs-keyword">false</span>);
            &#125;
        &#125;;
        <span class="hljs-comment">//150æ¡é¢„å–</span>
        channel.basicQos(<span class="hljs-number">500</span>,<span class="hljs-keyword">true</span>);
        channel.basicConsume(queueName,<span class="hljs-keyword">false</span>,consumer);
    &#125;
&#125;</code></pre>

<h4 id="basicQos-æ–¹æ³•å‚æ•°è¯¦ç»†è§£é‡Š"><a href="#basicQos-æ–¹æ³•å‚æ•°è¯¦ç»†è§£é‡Š" class="headerlink" title="basicQos()æ–¹æ³•å‚æ•°è¯¦ç»†è§£é‡Š"></a>basicQos()æ–¹æ³•å‚æ•°è¯¦ç»†è§£é‡Š</h4><ul>
<li>prefetchSizeï¼šæœ€å¤šä¼ è¾“å†…å®¹çš„å¤§å°é™åˆ¶ï¼Œ0ä¸ºä¸é™åˆ¶ï¼Œä½†æ®è¯´prefetchSizeå‚æ•°ï¼Œrabbitmqæ²¡æœ‰å®ç°ã€‚</li>
<li>prefetchCountï¼šè¡¨ç¤ºä¸è¦åŒæ—¶ç»™ä¸€ä¸ªæ¶ˆè´¹è€…æ¨é€å¤šäºNä¸ªæ¶ˆæ¯ï¼Œå³ä¸€æ—¦æœ‰Nä¸ªæ¶ˆæ¯è¿˜æ²¡æœ‰ackï¼Œåˆ™è¯¥consumerå°†é˜»å¡æ‰ï¼Œç›´åˆ°æœ‰æ¶ˆæ¯ackã€‚</li>
<li>globalï¼šbooleanç±»å‹è¡¨ç¤ºæ˜¯å¦å°†ä¸Šé¢è®¾ç½®åº”ç”¨äºchannelï¼Œå³ä¸Šé¢çš„é™åˆ¶æ˜¯channelçº§åˆ«çš„è¿˜æ˜¯consumerçº§åˆ«ã€‚</li>
</ul>
<p>å¦‚æœåŒæ—¶å¯¹channelå’Œæ¶ˆè´¹è€…è¿›è¡Œè®¾ç½®ï¼Œå¦‚</p>
<pre><code class="hljs java">channel.basicQos(<span class="hljs-number">10</span>,<span class="hljs-keyword">false</span>);
channel.basicQos(<span class="hljs-number">15</span>,<span class="hljs-keyword">true</span>);</code></pre>

<p>AMQPè§„èŒƒä¸­æ²¡æœ‰è§£é‡Šå¦‚æœä½¿ç”¨ä¸åŒçš„å…¨å±€å€¼ï¼Œå¤šæ¬¡è°ƒç”¨basic.qosä¼šå‘ç”Ÿä»€ä¹ˆã€‚RabbitMQè®¤ä¸ºä¸¤ä¸ªé¢„å–é™åˆ¶åº”è¯¥å½¼æ­¤ç‹¬ç«‹åœ°å¼ºåˆ¶æ‰§è¡Œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ•´ä¸ªé€šé“åŠ èµ·æ¥æœ€å¤šå…è®¸15æ¡æœªç¡®è®¤çš„æ¶ˆæ¯ï¼Œæ¯ä¸ªæ¶ˆè´¹è€…åˆ™æœ€å¤šæœ‰10æ¡æ¶ˆæ¯ã€‚æ¶ˆè´¹è€…åªæœ‰åœ¨æœªè¾¾åˆ°æœªç¡®è®¤æ¶ˆæ¯é™åˆ¶æ—¶æ‰ä¼šæ”¶åˆ°æ–°æ¶ˆæ¯ã€‚</p>
<h3 id="æ¶ˆè´¹è€…ä¸­çš„äº‹åŠ¡"><a href="#æ¶ˆè´¹è€…ä¸­çš„äº‹åŠ¡" class="headerlink" title="æ¶ˆè´¹è€…ä¸­çš„äº‹åŠ¡"></a>æ¶ˆè´¹è€…ä¸­çš„äº‹åŠ¡</h3><p>ä½¿ç”¨æ–¹æ³•å’Œç”Ÿäº§è€…ä¸€è‡´ã€‚å‡è®¾æ¶ˆè´¹è€…æ¨¡å¼ä¸­ä½¿ç”¨äº†äº‹åŠ¡ï¼Œå¹¶ä¸”åœ¨æ¶ˆæ¯ç¡®è®¤ä¹‹åè¿›è¡Œäº†äº‹åŠ¡å›æ»šï¼Œç»“æœä¼šåˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š</p>
<ol>
<li><p>autoAck=falseæ‰‹åŠ¨åº”å¯¹çš„æ—¶å€™æ˜¯æ”¯æŒäº‹åŠ¡çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å³ä½¿ä½ å·²ç»æ‰‹åŠ¨ç¡®è®¤äº†æ¶ˆæ¯å·²ç»æ”¶åˆ°äº†ï¼Œä½† RabbitMQå¯¹æ¶ˆæ¯çš„ç¡®è®¤ä¼šç­‰äº‹åŠ¡çš„è¿”å›ç»“æœï¼Œæœ€ç»ˆå†³å®šæ˜¯ç§»é™¤æ¶ˆæ¯è¿˜æ˜¯é‡æ–°æ”¾å›é˜Ÿåˆ—ã€‚å¦‚æœä½ æ‰‹åŠ¨ç¡®è®¤ä¹‹ååˆå›æ»šäº†äº‹åŠ¡ï¼Œé‚£ä¹ˆæ­¤æ¡æ¶ˆæ¯ä¼šé‡æ–°æ”¾å›é˜Ÿåˆ—ã€‚</p>
</li>
<li><p>autoAck=trueå¦‚æœè‡ªåŠ¨ç¡®è®¤ä¸ºtrueçš„æƒ…å†µæ˜¯ä¸æ”¯æŒäº‹åŠ¡çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä½ å³ä½¿åœ¨æ”¶åˆ°æ¶ˆæ¯ä¹‹ååœ¨å›æ»šäº‹åŠ¡ä¹Ÿæ˜¯äºäº‹æ— è¡¥çš„ï¼Œé˜Ÿåˆ—å·²ç»æŠŠæ¶ˆæ¯ç§»é™¤äº†ã€‚</p>
</li>
</ol>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/blog/categories/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/">æ¶ˆæ¯ä¸­é—´ä»¶</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/blog/tags/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/">æ¶ˆæ¯ä¸­é—´ä»¶</a>
                    
                      <a class="hover-with-bg" href="/blog/tags/RabbitMQ/">RabbitMQ</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" target="_blank" rel="nofollow noopener noopener">CC BY-SA 4.0 åè®®</a> ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</p>
              
              
                <div class="post-prevnext row">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/blog/2020/05/09/RabbitMQ%E7%9A%84%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">RabbitMQçš„é«˜çº§ç‰¹æ€§</span>
                        <span class="visible-mobile">ä¸Šä¸€ç¯‡</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/blog/2020/05/07/RabbitMQ%E4%B8%8EAMQP%E5%8D%8F%E8%AE%AE/">
                        <span class="hidden-mobile">RabbitMQä¸AMQP</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener">
        <span>Fluid</span></a>
    </div>
    
  <div class="statistics">
    
    

    
      
        <!-- ä¸è’œå­ç»Ÿè®¡PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            æ€»è®¿é—®é‡ 
            <span id="busuanzi_value_site_pv"></span>
             æ¬¡
          </span>
      
      
        <!-- ä¸è’œå­ç»Ÿè®¡UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            æ€»è®¿å®¢æ•° 
            <span id="busuanzi_value_site_uv"></span>
             äºº
          </span>
      
    
  </div>


    

    
  </div>
</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/blog/js/debouncer.js" ></script>
<script  src="/blog/js/main.js" ></script>

<!-- Plugins -->


  
    <script  src="/blog/js/lazyload.js" ></script>
  



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/blog/js/clipboard-use.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: '#post-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "RabbitMQä¸­æ¶ˆæ¯å‘å¸ƒä¸æƒè¡¡&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/blog/js/local-search.js" ></script>
  <script>
    var path = "/blog/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>







  
  
    <script type="text/javascript">
      //å®šä¹‰è·å–è¯è¯­ä¸‹æ ‡
      var a_idx = 0;
      jQuery(document).ready(function ($) {
        //ç‚¹å‡»bodyæ—¶è§¦å‘äº‹ä»¶
        $("body").click(function (e) {
          //éœ€è¦æ˜¾ç¤ºçš„è¯è¯­
          var a = new Array("å¯Œå¼º", "æ°‘ä¸»", "æ–‡æ˜", "å’Œè°", "è‡ªç”±", "å¹³ç­‰", "å…¬æ­£", "æ³•æ²»", "çˆ±å›½", "æ•¬ä¸š", "è¯šä¿¡", "å‹å–„");
          //è®¾ç½®è¯è¯­ç»™spanæ ‡ç­¾
          var $i = $("<span/>").text(a[a_idx]);
          //ä¸‹æ ‡ç­‰äºåŸæ¥ä¸‹æ ‡+1  ä½™ è¯è¯­æ€»æ•°
          a_idx = (a_idx + 1) % a.length;
          //è·å–é¼ æ ‡æŒ‡é’ˆçš„ä½ç½®ï¼Œåˆ†åˆ«ç›¸å¯¹äºæ–‡æ¡£çš„å·¦å’Œå³è¾¹ç¼˜ã€‚
          //è·å–xå’Œyçš„æŒ‡é’ˆåæ ‡
          var x = e.pageX, y = e.pageY;
          //åœ¨é¼ æ ‡çš„æŒ‡é’ˆçš„ä½ç½®ç»™$iå®šä¹‰çš„spanæ ‡ç­¾æ·»åŠ cssæ ·å¼
          $i.css({
            "z-index": 999,
            "top": y - 20,
            "left": x,
            "position": "absolute",
            "font-weight": "bold",
            "color": rand_color()
          });
          // éšæœºé¢œè‰²
          function rand_color() {
            return "rgb(" + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + ")"
          }
          //åœ¨bodyæ·»åŠ è¿™ä¸ªæ ‡ç­¾
          $("body").append($i);
          //animate() æ–¹æ³•æ‰§è¡Œ CSS å±æ€§é›†çš„è‡ªå®šä¹‰åŠ¨ç”»ã€‚
          //è¯¥æ–¹æ³•é€šè¿‡CSSæ ·å¼å°†å…ƒç´ ä»ä¸€ä¸ªçŠ¶æ€æ”¹å˜ä¸ºå¦ä¸€ä¸ªçŠ¶æ€ã€‚CSSå±æ€§å€¼æ˜¯é€æ¸æ”¹å˜çš„ï¼Œè¿™æ ·å°±å¯ä»¥åˆ›å»ºåŠ¨ç”»æ•ˆæœã€‚
          //è¯¦æƒ…è¯·çœ‹http://www.w3school.com.cn/jquery/effect_animate.asp
          $i.animate({
            //å°†åŸæ¥çš„ä½ç½®å‘ä¸Šç§»åŠ¨180
            "top": y - 180,
            "opacity": 0
            //1500åŠ¨ç”»çš„é€Ÿåº¦
          }, 1500, function () {
            //æ—¶é—´åˆ°äº†è‡ªåŠ¨åˆ é™¤
            $i.remove();
          });
        });
      })
      ;
    </script>
  














</body>
</html>
