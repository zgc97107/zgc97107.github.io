

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/blog/img/favicon.png">
  <link rel="icon" type="image/png" href="/blog/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="">
  <meta name="keywords" content="">
  <title>AQSè¯¦è§£ - ğŸğŸŠ&#39;s blog</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.5.3/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/blog/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.1.2/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />
  



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/blog/css/main.css" />

<!-- è‡ªå®šä¹‰æ ·å¼ä¿æŒåœ¨æœ€åº•éƒ¨ -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"zhaoguocheng.gitee.io","root":"/blog/","version":"1.8.5","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"copy_btn":true,"image_zoom":{"enable":true},"lazyload":{"enable":true,"onlypost":false},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/blog/js/utils.js" ></script>
  <script  src="/blog/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.2.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/blog/">&nbsp;<strong>Fluid</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/">
                <i class="iconfont icon-home-fill"></i>
                ä¸»é¡µ
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/archives/">
                <i class="iconfont icon-archive-fill"></i>
                å½’æ¡£
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/categories/">
                <i class="iconfont icon-category-fill"></i>
                åˆ†ç±»
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/tags/">
                <i class="iconfont icon-tags-fill"></i>
                æ ‡ç­¾
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/about/">
                <i class="iconfont icon-user-fill"></i>
                å…³äº
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax=true
         style="background: url('/blog/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="AQSè¯¦è§£">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2020-07-30 11:08" pubdate>
        2020å¹´7æœˆ30æ—¥ ä¸Šåˆ
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      10.5k å­—
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      121
       åˆ†é’Ÿ
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">AQSè¯¦è§£</h1>
            
            <div class="markdown-body">
              <h3 id="AQSä½¿ç”¨æ–¹å¼"><a href="#AQSä½¿ç”¨æ–¹å¼" class="headerlink" title="AQSä½¿ç”¨æ–¹å¼"></a>AQSä½¿ç”¨æ–¹å¼</h3><p>AQSåœ¨ä¹‹å‰é”çš„ç¬”è®°ä¸­å·²ç»åšäº†ç®€è¦ä»‹ç»ï¼Œæœ¬ç¯‡ç€é‡åˆ†æå…¶å®ç°æ–¹å¼ã€‚</p>
<p>AQSçš„ä¸»è¦ä½¿ç”¨æ–¹å¼æ˜¯ç»§æ‰¿ï¼Œå­ç±»é€šè¿‡ç»§æ‰¿AQSå¹¶å®ç°å®ƒçš„æŠ½è±¡æ–¹æ³•æ¥ç®¡ç†åŒæ­¥çŠ¶æ€ï¼Œåœ¨AQSé‡Œç”±ä¸€ä¸ªintå‹çš„stateæ¥ä»£è¡¨è¿™ä¸ªçŠ¶æ€ï¼Œåœ¨æŠ½è±¡æ–¹æ³•çš„å®ç°è¿‡ç¨‹ä¸­å…ä¸äº†è¦å¯¹åŒæ­¥çŠ¶æ€è¿›è¡Œæ›´æ”¹ï¼Œè¿™æ—¶å°±éœ€è¦ä½¿ç”¨åŒæ­¥å™¨æä¾›çš„3ä¸ªæ–¹æ³•ï¼ˆgetState()ã€setState(int newState)å’ŒcompareAndSetState(int expect,int update)ï¼‰æ¥è¿›è¡Œæ“ä½œï¼Œå› ä¸ºå®ƒä»¬èƒ½å¤Ÿä¿è¯çŠ¶æ€çš„æ”¹å˜æ˜¯å®‰å…¨çš„ã€‚</p>
<p>AQSè‡ªèº«æ²¡æœ‰å®ç°ä»»ä½•åŒæ­¥æ¥å£ï¼Œå®ƒä»…ä»…æ˜¯å®šä¹‰äº†è‹¥å¹²åŒæ­¥çŠ¶æ€è·å–å’Œé‡Šæ”¾çš„æ–¹æ³•æ¥ä¾›è‡ªå®šä¹‰åŒæ­¥ç»„ä»¶ä½¿ç”¨ï¼ŒåŒæ­¥å™¨æ—¢å¯ä»¥æ”¯æŒç‹¬å å¼åœ°è·å–åŒæ­¥çŠ¶æ€ï¼Œä¹Ÿå¯ä»¥æ”¯æŒå…±äº«å¼åœ°è·å–åŒæ­¥çŠ¶æ€ï¼Œè¿™æ ·å°±å¯ä»¥æ–¹ä¾¿å®ç°ä¸åŒç±»å‹çš„åŒæ­¥ç»„ä»¶ï¼ˆReentrantLockã€ReentrantReadWriteLockå’ŒCountDownLatchç­‰ï¼‰ã€‚</p>
<p>åŒæ­¥å™¨æ˜¯å®ç°é”ï¼ˆä¹Ÿå¯ä»¥æ˜¯ä»»æ„åŒæ­¥ç»„ä»¶ï¼‰çš„å…³é”®ï¼Œåœ¨é”çš„å®ç°ä¸­èšåˆåŒæ­¥å™¨ã€‚å¯ä»¥è¿™æ ·ç†è§£äºŒè€…ä¹‹é—´çš„å…³ç³»ï¼šé”æ˜¯é¢å‘ä½¿ç”¨è€…çš„ï¼Œå®ƒå®šä¹‰äº†ä½¿ç”¨è€…ä¸é”äº¤äº’çš„æ¥å£ï¼ˆæ¯”å¦‚å¯ä»¥å…è®¸ä¸¤ä¸ªçº¿ç¨‹å¹¶è¡Œè®¿é—®ï¼‰ï¼Œéšè—äº†å®ç°ç»†èŠ‚ï¼›åŒæ­¥å™¨é¢å‘çš„æ˜¯é”çš„å®ç°è€…ï¼Œå®ƒç®€åŒ–äº†é”çš„å®ç°æ–¹å¼ï¼Œå±è”½äº†åŒæ­¥çŠ¶æ€ç®¡ç†ã€çº¿ç¨‹çš„æ’é˜Ÿã€ç­‰å¾…ä¸å”¤é†’ç­‰åº•å±‚æ“ä½œã€‚é”å’ŒåŒæ­¥å™¨å¾ˆå¥½åœ°éš”ç¦»äº†ä½¿ç”¨è€…å’Œå®ç°è€…æ‰€éœ€å…³æ³¨çš„é¢†åŸŸã€‚</p>
<p>å®ç°è€…éœ€è¦ç»§æ‰¿åŒæ­¥å™¨å¹¶é‡å†™æŒ‡å®šçš„æ–¹æ³•ï¼Œéšåå°†åŒæ­¥å™¨ç»„åˆåœ¨è‡ªå®šä¹‰åŒæ­¥ç»„ä»¶çš„å®ç°ä¸­ï¼Œå¹¶è°ƒç”¨åŒæ­¥å™¨æä¾›çš„æ¨¡æ¿æ–¹æ³•ï¼Œè€Œè¿™äº›æ¨¡æ¿æ–¹æ³•å°†ä¼šè°ƒç”¨ä½¿ç”¨è€…é‡å†™çš„æ–¹æ³•ã€‚</p>
<h3 id="AQSä¸­çš„æ–¹æ³•"><a href="#AQSä¸­çš„æ–¹æ³•" class="headerlink" title="AQSä¸­çš„æ–¹æ³•"></a>AQSä¸­çš„æ–¹æ³•</h3><h4 id="æ¨¡æ¿æ–¹æ³•"><a href="#æ¨¡æ¿æ–¹æ³•" class="headerlink" title="æ¨¡æ¿æ–¹æ³•"></a>æ¨¡æ¿æ–¹æ³•</h4><p>å®ç°è‡ªå®šä¹‰åŒæ­¥ç»„ä»¶æ—¶ï¼Œå°†ä¼šè°ƒç”¨åŒæ­¥å™¨æä¾›çš„æ¨¡æ¿æ–¹æ³•ï¼Œ</p>
<table>
<thead>
<tr>
<th align="left">æ–¹æ³•åç§°</th>
<th align="left">æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="left">void acquire(int arg)</td>
<td align="left">ç‹¬å å¼è·å–åŒæ­¥çŠ¶æ€ï¼Œå¦‚æœå½“å‰çº¿ç¨‹è·å–åŒæ­¥çŠ¶æ€æˆåŠŸï¼Œåˆ™ç”±è¯¥æ–¹æ³•è¿”å›ï¼Œå¦åˆ™ï¼Œå°†ä¼šè¿›äººåŒæ­¥é˜Ÿåˆ—ç­‰å¾…ï¼Œè¯¥æ–¹æ³•å°†ä¼šè°ƒç”¨é‡å†™çš„tryAcquire(int  arg)æ–¹æ³•</td>
</tr>
<tr>
<td align="left">void acquireInterruptibly(int arg)</td>
<td align="left">ä¸acquire(int arg)ç›¸åŒï¼Œä½†æ˜¯è¯¥æ–¹æ³•å“åº”ä¸­æ–­ï¼Œå½“å‰çº¿ç¨‹æœªè·å–åˆ°åŒæ­¥çŠ¶æ€è€Œè¿›å…¥åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œå¦‚æœå½“å‰çº¿ç¨‹è¢«ä¸­æ–­ï¼Œåˆ™è¯¥æ–¹æ³•ä¼šæŠ›å‡ºInterruptedExceptionå¹¶è¿”å›</td>
</tr>
<tr>
<td align="left">boolean tryAcquireNanos(int arg,long nanos)</td>
<td align="left">åœ¨acquireInterruptibly(int arg)åŸºç¡€ä¸Šå¢åŠ äº†è¶…æ—¶é™åˆ¶ï¼Œå¦‚æœå½“å‰çº¿ç¨‹åœ¨è¶…æ—¶æ—¶é—´å†…æ²¡æœ‰è·å–åˆ°åŒæ­¥çŠ¶æ€ï¼Œé‚£ä¹ˆå°†ä¼šè¿”å›false.å¦‚æœè·å–åˆ°äº†è¿”å›true</td>
</tr>
<tr>
<td align="left">void acquireShared(int arg)</td>
<td align="left">å…±äº«å¼çš„è·å–åŒæ­¥çŠ¶æ€ï¼Œå¦‚æœå½“å‰çº¿ç¨‹æœªè·å–åˆ°åŒæ­¥çŠ¶æ€,å°†ä¼šè¿›äººåŒæ­¥é˜Ÿåˆ—ç­‰å¾…ï¼Œä¸ç‹¬å å¼è·å–çš„ä¸»è¦åŒºåˆ«æ˜¯åœ¨åŒä¸€æ—¶åˆ»å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹è·å–åˆ°åŒæ­¥çŠ¶æ€</td>
</tr>
<tr>
<td align="left">void acquireSharedInteruptibly(int arg)</td>
<td align="left">ä¸acquireShared(int arg)ç›¸åŒï¼Œè¯¥æ–¹æ³•å“åº”ä¸­æ–­</td>
</tr>
<tr>
<td align="left">boolean tryAcquireSharedNanos(int arg, long nanos)</td>
<td align="left">åœ¨acquireSharedInterruptibly(int arg)åŸºç¡€ä¸Šå¢åŠ äº†è¶…æ—¶é™åˆ¶</td>
</tr>
<tr>
<td align="left">boolean release(int arg)</td>
<td align="left">ç‹¬å å¼çš„é‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼Œè¯¥æ–¹æ³•ä¼šåœ¨é‡Šæ”¾åŒæ­¥çŠ¶æ€ä¹‹åï¼Œå°†åŒæ­¥é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªèŠ‚ç‚¹åŒ…å«çš„çº¿ç¨‹å”¤é†’</td>
</tr>
<tr>
<td align="left">boolean releaseShared(int arg)</td>
<td align="left">å…±äº«å¼çš„é‡Šæ”¾åŒæ­¥çŠ¶æ€</td>
</tr>
<tr>
<td align="left">Collection&lt; Thread&gt; getQueuedThreads()</td>
<td align="left">è·å–ç­‰å¾…åœ¨åŒæ­¥é˜Ÿåˆ—ä¸Šçš„çº¿ç¨‹é›†åˆ</td>
</tr>
</tbody></table>
<p>è¿™äº›æ¨¡æ¿æ–¹æ³•åŒæ­¥å™¨æä¾›çš„æ¨¡æ¿æ–¹æ³•åŸºæœ¬ä¸Šåˆ†ä¸º3ç±»ï¼šç‹¬å å¼è·å–ä¸é‡Šæ”¾åŒæ­¥çŠ¶æ€ã€å…±äº«å¼è·å–ä¸é‡Šæ”¾ã€åŒæ­¥çŠ¶æ€å’ŒæŸ¥è¯¢åŒæ­¥é˜Ÿåˆ—ä¸­çš„ç­‰å¾…çº¿ç¨‹æƒ…å†µã€‚</p>
<h4 id="å¯é‡å†™çš„æ–¹æ³•"><a href="#å¯é‡å†™çš„æ–¹æ³•" class="headerlink" title="å¯é‡å†™çš„æ–¹æ³•"></a>å¯é‡å†™çš„æ–¹æ³•</h4><table>
<thead>
<tr>
<th align="left">æ–¹æ³•åç§°</th>
<th align="left">æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="left">protected boolean tryAcquire(int arg)</td>
<td align="left">ç‹¬å å¼è·å–åŒæ­¥çŠ¶æ€ï¼Œå®ç°è¯¥æ–¹æ³•éœ€è¦æŸ¥è¯¢å½“å‰çŠ¶æ€å¹¶åˆ¤æ–­åŒæ­¥çŠ¶æ€æ˜¯å¦ç¬¦åˆé¢„æœŸï¼Œç„¶åå†è¿›è¡ŒCASè®¾ç½®åŒæ­¥çŠ¶æ€</td>
</tr>
<tr>
<td align="left">protected boolean tryRelease(int arg)</td>
<td align="left">ç‹¬å å¼é‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼Œç­‰å¾…è·å–åŒæ­¥çŠ¶æ€çš„çº¿ç¨‹å°†æœ‰æœºä¼šè·å–åŒæ­¥çŠ¶æ€</td>
</tr>
<tr>
<td align="left">protected int tryAcquireShared(int arg)</td>
<td align="left">å…±äº«å¼è·å–åŒæ­¥çŠ¶æ€ï¼Œè¿”å›å¤§äºç­‰äº0çš„å€¼ï¼Œè¡¨ç¤ºè·å–æˆåŠŸï¼Œåä¹‹ï¼Œè·å–å¤±è´¥</td>
</tr>
<tr>
<td align="left">protected boolean tryReleaseShared(int arg)</td>
<td align="left">å…±äº«å¼é‡Šæ”¾åŒæ­¥çŠ¶æ€</td>
</tr>
<tr>
<td align="left">protected boolean isHeldExclusively()</td>
<td align="left">å½“å‰åŒæ­¥å™¨æ˜¯å¦åœ¨ç‹¬å æ¨¡å¼ä¸‹è¢«çº¿ç¨‹å ç”¨ï¼Œä¸€èˆ¬è¯¥æ–¹æ³•è¡¨ç¤ºæ˜¯å¦è¢«å½“å‰çº¿ç¨‹æ‰€ç‹¬å </td>
</tr>
</tbody></table>
<h4 id="è®¿é—®æˆ–ä¿®æ”¹åŒæ­¥çŠ¶æ€çš„æ–¹æ³•"><a href="#è®¿é—®æˆ–ä¿®æ”¹åŒæ­¥çŠ¶æ€çš„æ–¹æ³•" class="headerlink" title="è®¿é—®æˆ–ä¿®æ”¹åŒæ­¥çŠ¶æ€çš„æ–¹æ³•"></a>è®¿é—®æˆ–ä¿®æ”¹åŒæ­¥çŠ¶æ€çš„æ–¹æ³•</h4><p>é‡å†™åŒæ­¥å™¨æŒ‡å®šçš„æ–¹æ³•æ—¶ï¼Œéœ€è¦ä½¿ç”¨åŒæ­¥å™¨æä¾›çš„å¦‚ä¸‹3ä¸ªæ–¹æ³•æ¥è®¿é—®æˆ–ä¿®æ”¹åŒæ­¥çŠ¶æ€ã€‚</p>
<ul>
<li><p>getState()ï¼šè·å–å½“å‰åŒæ­¥çŠ¶æ€ã€‚</p>
</li>
<li><p>setState(int newState)ï¼šè®¾ç½®å½“å‰åŒæ­¥çŠ¶æ€ã€‚</p>
</li>
<li><p>compareAndSetState(int expect,int update)ï¼šä½¿ç”¨CASè®¾ç½®å½“å‰çŠ¶æ€ï¼Œè¯¥æ–¹æ³•èƒ½å¤Ÿä¿è¯çŠ¶æ€è®¾ç½®çš„åŸå­æ€§ã€‚ </p>
</li>
</ul>
<h3 id="AQSä¸­çš„æ•°æ®ç»“æ„"><a href="#AQSä¸­çš„æ•°æ®ç»“æ„" class="headerlink" title="AQSä¸­çš„æ•°æ®ç»“æ„"></a>AQSä¸­çš„æ•°æ®ç»“æ„</h3><img src="/blog/2020/07/30/JUC-AQS%E8%AF%A6%E8%A7%A3/pic8.png" srcset="/blog/img/loading.gif" class>

<h4 id="èŠ‚ç‚¹Node"><a href="#èŠ‚ç‚¹Node" class="headerlink" title="èŠ‚ç‚¹Node"></a>èŠ‚ç‚¹Node</h4><p>AQSå…¶å®æ˜¯CLHé˜Ÿåˆ—é”çš„ä¸€ç§å˜ä½“å®ç°ï¼Œæ‰€ä»¥å¿…ç„¶è¦æœ‰ä¸€ä¸ªèŠ‚ç‚¹çš„æ•°æ®ç»“æ„æ¥ä¿å­˜æˆ‘ä»¬å‰é¢æ‰€è¯´çš„CLHä¸­çš„å„ç§åŸŸï¼Œæ¯”å¦‚å‰é©±èŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹çš„çŠ¶æ€ç­‰ï¼Œè¿™ä¸ªæ•°æ®ç»“æ„å°±æ˜¯AQSä¸­çš„å†…éƒ¨ç±»Nodeã€‚Nodeä¸­ä¿å­˜çš„ä¿¡æ¯æœ‰ï¼š</p>
<ul>
<li><p>å‰é©±å’Œåç»§çº¿ç¨‹</p>
</li>
<li><p>çº¿ç¨‹ä¿¡æ¯</p>
</li>
<li><p>é˜Ÿåˆ—ä¸­çº¿ç¨‹çŠ¶æ€</p>
</li>
</ul>
<h4 id="Nodeç±»çš„è®¾è®¡"><a href="#Nodeç±»çš„è®¾è®¡" class="headerlink" title="Nodeç±»çš„è®¾è®¡"></a>Nodeç±»çš„è®¾è®¡</h4><img src="/blog/2020/07/30/JUC-AQS%E8%AF%A6%E8%A7%A3/pic7.png" srcset="/blog/img/loading.gif" class>

<p>çº¿ç¨‹çš„2ç§ç­‰å¾…æ¨¡å¼ï¼š</p>
<ul>
<li><p><strong>SHARED</strong>ï¼šè¡¨ç¤ºçº¿ç¨‹ä»¥å…±äº«çš„æ¨¡å¼ç­‰å¾…é”ï¼ˆå¦‚ReadLockï¼‰</p>
</li>
<li><p><strong>EXCLUSIVE</strong>ï¼šè¡¨ç¤ºçº¿ç¨‹ä»¥äº’æ–¥çš„æ¨¡å¼ç­‰å¾…é”ï¼ˆå¦‚ReetrantLockï¼‰</p>
</li>
</ul>
<p>çº¿ç¨‹åœ¨é˜Ÿåˆ—ä¸­çš„çŠ¶æ€æšä¸¾ï¼š</p>
<ul>
<li><p><strong>CANCELLED</strong>ï¼šå€¼ä¸º1ï¼Œè¡¨ç¤ºçº¿ç¨‹å·²ç»å–æ¶ˆè·å–é”çš„è¯·æ±‚</p>
</li>
<li><p><strong>SIGNAL</strong>ï¼šå€¼ä¸º-1ï¼Œè¡¨ç¤ºè¯¥çº¿ç¨‹å·²ç»å‡†å¤‡å°±ç»ªï¼Œç­‰å¾…è·å–é”</p>
</li>
<li><p><strong>CONDITION</strong>ï¼šå€¼ä¸º-2ï¼Œè¡¨ç¤ºçº¿ç¨‹ç­‰å¾…æŸä¸€ä¸ªæ¡ä»¶ï¼ˆConditionï¼‰è¢«æ»¡è¶³</p>
</li>
<li><p><strong>PROPAGATE</strong>ï¼šå€¼ä¸º-3ï¼Œè¡¨ç¤ºä¸‹ä¸€ä¸ªçš„acquireSharedå€¼åº”è¯¥è¢«æ— æ¡ä»¶çš„ä¼ æ’­ä¸‹å»ï¼Œåœ¨çº¿ç¨‹å¤„äºSHAREDæ¨¡å¼æ—¶æ‰ä¼šè¢«ç”¨åˆ°ã€‚</p>
</li>
</ul>
<p>æˆå‘˜å˜é‡ï¼š</p>
<ul>
<li><p><strong>waitStatus</strong>ï¼šè¯¥intå˜é‡è¡¨ç¤ºçº¿ç¨‹åœ¨é˜Ÿåˆ—ä¸­çš„çŠ¶æ€ï¼Œå…¶å€¼å°±æ˜¯ä¸Šè¿°æåˆ°çš„çŠ¶æ€ï¼šCANCELLEDã€SIGNALã€CONDITIONã€PROPAGATE</p>
</li>
<li><p><strong>prev</strong>ï¼šè¯¥å˜é‡ç±»å‹ä¸ºNodeå¯¹è±¡ï¼Œè¡¨ç¤ºè¯¥èŠ‚ç‚¹çš„å‰ä¸€ä¸ªNodeèŠ‚ç‚¹ï¼ˆå‰é©±ï¼‰</p>
</li>
<li><p><strong>next</strong>ï¼šè¯¥å˜é‡ç±»å‹ä¸ºNodeå¯¹è±¡ï¼Œè¡¨ç¤ºè¯¥èŠ‚ç‚¹çš„åä¸€ä¸ªNodeèŠ‚ç‚¹ï¼ˆåç»§ï¼‰</p>
</li>
<li><p><strong>thread</strong>ï¼šè¯¥å˜é‡ç±»å‹ä¸ºThreadå¯¹è±¡ï¼Œè¡¨ç¤ºè¯¥èŠ‚ç‚¹çš„ä»£è¡¨çš„çº¿ç¨‹</p>
</li>
<li><p><strong>nextWaiter</strong>ï¼šè¯¥å˜é‡ç±»å‹ä¸ºNodeå¯¹è±¡ï¼Œè¡¨ç¤ºç­‰å¾…conditionæ¡ä»¶çš„NodeèŠ‚ç‚¹</p>
</li>
</ul>
<p>å½“å‰çº¿ç¨‹è·å–åŒæ­¥çŠ¶æ€å¤±è´¥æ—¶ï¼ŒåŒæ­¥å™¨ä¼šå°†å½“å‰çº¿ç¨‹ä»¥åŠç­‰å¾…çŠ¶æ€ç­‰ä¿¡æ¯æ„é€ æˆä¸ºä¸€ä¸ªèŠ‚ç‚¹ï¼ˆNodeï¼‰å¹¶å°†å…¶åŠ å…¥åŒæ­¥é˜Ÿåˆ—ï¼ŒåŒæ—¶ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œå½“åŒæ­¥çŠ¶æ€é‡Šæ”¾æ—¶ï¼Œä¼šæŠŠé¦–èŠ‚ç‚¹ä¸­çš„çº¿ç¨‹å”¤é†’ï¼Œä½¿å…¶å†æ¬¡å°è¯•è·å–åŒæ­¥çŠ¶æ€ã€‚åŒæ­¥é˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹ï¼ˆNodeï¼‰ç”¨æ¥ä¿å­˜è·å–åŒæ­¥çŠ¶æ€å¤±è´¥çš„çº¿ç¨‹å¼•ç”¨ã€ç­‰å¾…çŠ¶æ€ä»¥åŠå‰é©±å’Œåç»§èŠ‚ç‚¹ã€‚</p>
<h4 id="headå’Œtail"><a href="#headå’Œtail" class="headerlink" title="headå’Œtail"></a>headå’Œtail</h4><p>AQSè¿˜æ‹¥æœ‰é¦–èŠ‚ç‚¹ï¼ˆheadï¼‰å’Œå°¾èŠ‚ç‚¹ï¼ˆtailï¼‰ä¸¤ä¸ªå¼•ç”¨ï¼Œä¸€ä¸ªæŒ‡å‘é˜Ÿåˆ—å¤´èŠ‚ç‚¹ï¼Œè€Œå¦ä¸€ä¸ªæŒ‡å‘é˜Ÿåˆ—å°¾èŠ‚ç‚¹ã€‚</p>
<p>æ³¨æ„ ï¼šå› ä¸ºé¦–èŠ‚ç‚¹headæ˜¯ä¸ä¿å­˜çº¿ç¨‹ä¿¡æ¯çš„èŠ‚ç‚¹ï¼Œä»…ä»…æ˜¯å› ä¸ºæ•°æ®ç»“æ„è®¾è®¡ä¸Šçš„éœ€è¦ï¼Œåœ¨æ•°æ®ç»“æ„ä¸Šï¼Œè¿™ç§åšæ³•å¾€å¾€å«åšâ€œç©ºå¤´èŠ‚ç‚¹é“¾è¡¨â€ï¼Œå¯¹åº”çš„å°±æœ‰â€œéç©ºå¤´ç»“ç‚¹é“¾è¡¨â€ã€‚</p>
<h4 id="èŠ‚ç‚¹åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­çš„å¢åŠ å’Œç§»å‡º"><a href="#èŠ‚ç‚¹åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­çš„å¢åŠ å’Œç§»å‡º" class="headerlink" title="èŠ‚ç‚¹åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­çš„å¢åŠ å’Œç§»å‡º"></a>èŠ‚ç‚¹åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­çš„å¢åŠ å’Œç§»å‡º</h4><h5 id="èŠ‚ç‚¹åŠ å…¥åˆ°åŒæ­¥é˜Ÿåˆ—"><a href="#èŠ‚ç‚¹åŠ å…¥åˆ°åŒæ­¥é˜Ÿåˆ—" class="headerlink" title="èŠ‚ç‚¹åŠ å…¥åˆ°åŒæ­¥é˜Ÿåˆ—"></a>èŠ‚ç‚¹åŠ å…¥åˆ°åŒæ­¥é˜Ÿåˆ—</h5><p>å½“ä¸€ä¸ªçº¿ç¨‹æˆåŠŸåœ°è·å–äº†åŒæ­¥çŠ¶æ€ï¼ˆæˆ–è€…é”ï¼‰ï¼Œå…¶ä»–çº¿ç¨‹å°†æ— æ³•è·å–åˆ°åŒæ­¥çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯è·å–åŒæ­¥çŠ¶æ€å¤±è´¥ï¼ŒAQSä¼šé€šè¿‡addWaiter()æ–¹æ³•å°†è¿™ä¸ªçº¿ç¨‹ä»¥åŠç­‰å¾…çŠ¶æ€ç­‰ä¿¡æ¯æ„é€ æˆä¸ºä¸€ä¸ªèŠ‚ç‚¹ï¼ˆNodeï¼‰å¹¶å°†å…¶åŠ å…¥åŒæ­¥é˜Ÿåˆ—çš„å°¾éƒ¨ã€‚è€Œè¿™ä¸ªåŠ å…¥é˜Ÿåˆ—çš„è¿‡ç¨‹å¿…é¡»è¦ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œå› æ­¤åŒæ­¥å™¨æä¾›äº†ä¸€ä¸ªåŸºäºCASçš„è®¾ç½®å°¾èŠ‚ç‚¹çš„æ–¹æ³•ï¼šcompareAndSetTail(Node expect,Nodeupdate)ï¼ŒAQSå®ƒéœ€è¦ä¼ é€’å½“å‰çº¿ç¨‹â€œè®¤ä¸ºâ€çš„å°¾èŠ‚ç‚¹å’Œå½“å‰èŠ‚ç‚¹ï¼Œåªæœ‰è®¾ç½®æˆåŠŸåï¼Œå½“å‰èŠ‚ç‚¹æ‰æ­£å¼ä¸ä¹‹å‰çš„å°¾èŠ‚ç‚¹å»ºç«‹å…³è”ã€‚</p>
<img src="/blog/2020/07/30/JUC-AQS%E8%AF%A6%E8%A7%A3/pic9.png" srcset="/blog/img/loading.gif" class>

<h5 id="é¦–èŠ‚ç‚¹çš„å˜åŒ–"><a href="#é¦–èŠ‚ç‚¹çš„å˜åŒ–" class="headerlink" title="é¦–èŠ‚ç‚¹çš„å˜åŒ–"></a>é¦–èŠ‚ç‚¹çš„å˜åŒ–</h5><p>é¦–èŠ‚ç‚¹æ˜¯è·å–åŒæ­¥çŠ¶æ€æˆåŠŸçš„èŠ‚ç‚¹ï¼Œé¦–èŠ‚ç‚¹çš„çº¿ç¨‹åœ¨é‡Šæ”¾åŒæ­¥çŠ¶æ€æ—¶ï¼Œå°†ä¼šå”¤é†’åç»§èŠ‚ç‚¹ï¼Œè€Œåç»§èŠ‚ç‚¹å°†ä¼šåœ¨è·å–åŒæ­¥çŠ¶æ€æˆåŠŸæ—¶å°†è‡ªå·±è®¾ç½®ä¸ºé¦–èŠ‚ç‚¹ã€‚è®¾ç½®é¦–èŠ‚ç‚¹æ˜¯é€šè¿‡è·å–åŒæ­¥çŠ¶æ€æˆåŠŸçš„çº¿ç¨‹æ¥å®Œæˆçš„ï¼Œç”±äºåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤ŸæˆåŠŸè·å–åˆ°åŒæ­¥çŠ¶æ€ï¼Œå› æ­¤è®¾ç½®å¤´èŠ‚ç‚¹çš„æ–¹æ³•å¹¶ä¸éœ€è¦ä½¿ç”¨CASæ¥ä¿è¯ï¼Œå®ƒåªéœ€è¦å°†é¦–èŠ‚ç‚¹è®¾ç½®æˆä¸ºåŸé¦–èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹å¹¶æ–­å¼€åŸé¦–èŠ‚ç‚¹çš„nextå¼•ç”¨å³å¯ã€‚</p>
<img src="/blog/2020/07/30/JUC-AQS%E8%AF%A6%E8%A7%A3/pic10.png" srcset="/blog/img/loading.gif" class>

<h5 id="ç‹¬å å¼åŒæ­¥çŠ¶æ€è·å–ä¸é‡Šæ”¾"><a href="#ç‹¬å å¼åŒæ­¥çŠ¶æ€è·å–ä¸é‡Šæ”¾" class="headerlink" title="ç‹¬å å¼åŒæ­¥çŠ¶æ€è·å–ä¸é‡Šæ”¾"></a>ç‹¬å å¼åŒæ­¥çŠ¶æ€è·å–ä¸é‡Šæ”¾</h5><img src="/blog/2020/07/30/JUC-AQS%E8%AF%A6%E8%A7%A3/pic11.png" srcset="/blog/img/loading.gif" class>

<h6 id="è·å–"><a href="#è·å–" class="headerlink" title="è·å–"></a>è·å–</h6><p>é€šè¿‡è°ƒç”¨åŒæ­¥å™¨çš„acquire(int arg)æ–¹æ³•å¯ä»¥è·å–åŒæ­¥çŠ¶æ€ï¼Œä¸»è¦å®Œæˆäº†åŒæ­¥çŠ¶æ€è·å–ã€èŠ‚ç‚¹æ„é€ ã€åŠ å…¥åŒæ­¥é˜Ÿåˆ—ä»¥åŠåœ¨åŒæ­¥é˜Ÿåˆ—ä¸­è‡ªæ—‹ç­‰å¾…çš„ç›¸å…³å·¥ä½œï¼Œå…¶ä¸»è¦é€»è¾‘æ˜¯ï¼š</p>
<p>é¦–å…ˆè°ƒç”¨è‡ªå®šä¹‰åŒæ­¥å™¨å®ç°çš„tryAcquire(int arg)æ–¹æ³•ï¼Œè¯¥æ–¹æ³•éœ€è¦ä¿è¯çº¿ç¨‹å®‰å…¨çš„è·å–åŒæ­¥çŠ¶æ€ã€‚</p>
<p>å¦‚æœåŒæ­¥çŠ¶æ€è·å–å¤±è´¥ï¼ˆtryAcquireè¿”å›falseï¼‰ï¼Œåˆ™æ„é€ åŒæ­¥èŠ‚ç‚¹ï¼ˆç‹¬å å¼Node.EXCLUSIVEï¼ŒåŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æˆåŠŸè·å–åŒæ­¥çŠ¶æ€ï¼‰å¹¶é€šè¿‡addWaiter(Node node)æ–¹æ³•å°†è¯¥èŠ‚ç‚¹åŠ å…¥åˆ°åŒæ­¥é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œåœ¨addWaiter()æ–¹æ³•ä¸­ä¼šå°è¯•é€šè¿‡compareAndSetTail()æ–¹æ³•è®¾ç½®é¦–å°¾èŠ‚ç‚¹å…³ç³»ï¼Œå¦‚æœè®¾ç½®ä¸æˆåŠŸæ‰ä¼šè¿›å…¥enq()æ–¹æ³•å¾ªç¯å°è¯•è®¾ç½®èŠ‚ç‚¹å…³ç³»ã€‚</p>
<p>æœ€åè°ƒç”¨acquireQueued(Node node,int arg)æ–¹æ³•ï¼Œä½¿å¾—è¯¥èŠ‚ç‚¹ä»¥â€œæ­»å¾ªç¯â€çš„æ–¹å¼è·å–åŒæ­¥çŠ¶æ€ã€‚å¦‚æœè·å–ä¸åˆ°åˆ™é˜»å¡èŠ‚ç‚¹ä¸­çš„çº¿ç¨‹ï¼Œè€Œè¢«é˜»å¡çº¿ç¨‹çš„å”¤é†’ä¸»è¦ä¾é å‰é©±èŠ‚ç‚¹çš„å‡ºé˜Ÿæˆ–é˜»å¡çº¿ç¨‹è¢«ä¸­æ–­æ¥å®ç°ã€‚</p>
<p>addWaiter(Node node)æ–¹æ³•ä¸­</p>
<img src="/blog/2020/07/30/JUC-AQS%E8%AF%A6%E8%A7%A3/pic12.png" srcset="/blog/img/loading.gif" class>

<p>å°†å½“å‰çº¿ç¨‹åŒ…è£…æˆNodeåï¼Œé˜Ÿåˆ—ä¸ä¸ºç©ºçš„æƒ…å†µä¸‹ï¼Œå…ˆå°è¯•æŠŠå½“å‰èŠ‚ç‚¹åŠ å…¥é˜Ÿåˆ—å¹¶æˆä¸ºå°¾èŠ‚ç‚¹ï¼Œå¦‚æœä¸æˆåŠŸæˆ–è€…é˜Ÿåˆ—ä¸ºç©ºè¿›å…¥enq(final Node node)æ–¹æ³•ã€‚</p>
<img src="/blog/2020/07/30/JUC-AQS%E8%AF%A6%E8%A7%A3/pic13.png" srcset="/blog/img/loading.gif" class>

<p>åœ¨enq(final Node node)æ–¹æ³•ä¸­ï¼ŒåŒæ­¥å™¨é€šè¿‡â€œæ­»å¾ªç¯â€æ¥ä¿è¯èŠ‚ç‚¹çš„æ­£ç¡®æ·»åŠ ï¼Œè¿™ä¸ªæ­»å¾ªç¯ä¸­ï¼Œåšäº†ä¸¤ä»¶äº‹ï¼Œç¬¬ä¸€ä»¶ï¼Œå¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œåˆå§‹åŒ–é˜Ÿåˆ—ï¼Œnewå‡ºä¸€ä¸ªç©ºèŠ‚ç‚¹ï¼Œå¹¶è®©<strong>é¦–èŠ‚ç‚¹</strong>ï¼ˆheadï¼‰å’Œ<strong>å°¾èŠ‚ç‚¹</strong>ï¼ˆtailï¼‰ä¸¤ä¸ªå¼•ç”¨éƒ½æŒ‡å‘è¿™ä¸ªç©ºèŠ‚ç‚¹ï¼›ç¬¬äºŒä»¶äº‹ï¼ŒæŠŠå½“å‰èŠ‚ç‚¹åŠ å…¥é˜Ÿåˆ—ã€‚</p>
<p>åœ¨â€œæ­»å¾ªç¯â€ä¸­åªæœ‰é€šè¿‡CASå°†èŠ‚ç‚¹è®¾ç½®æˆä¸ºå°¾èŠ‚ç‚¹ä¹‹åï¼Œå½“å‰çº¿ç¨‹æ‰èƒ½ä»è¯¥æ–¹æ³•è¿”å›ï¼Œå¦åˆ™ï¼Œå½“å‰çº¿ç¨‹ä¸æ–­åœ°å°è¯•è®¾ç½®ã€‚</p>
<p>èŠ‚ç‚¹è¿›å…¥åŒæ­¥é˜Ÿåˆ—ä¹‹åï¼Œè§‚å¯ŸacquireQueued(Node node,int arg)æ–¹æ³•</p>
<img src="/blog/2020/07/30/JUC-AQS%E8%AF%A6%E8%A7%A3/pic14.png" srcset="/blog/img/loading.gif" class>

<p>å…¶å®å°±æ˜¯ä¸€ä¸ªè‡ªæ—‹çš„è¿‡ç¨‹ï¼Œæ¯ä¸ªèŠ‚ç‚¹ï¼ˆæˆ–è€…è¯´æ¯ä¸ªçº¿ç¨‹ï¼‰éƒ½åœ¨è‡ªçœåœ°è§‚å¯Ÿï¼Œå½“æ¡ä»¶æ»¡è¶³ï¼Œè·å–åˆ°äº†åŒæ­¥çŠ¶æ€ï¼Œå°±å¯ä»¥ä»è¿™ä¸ªè‡ªæ—‹è¿‡ç¨‹ä¸­é€€å‡ºï¼Œå¦åˆ™ä¾æ—§ç•™åœ¨è¿™ä¸ªè‡ªæ—‹è¿‡ç¨‹ä¸­ï¼ˆå¹¶ä¼šé˜»å¡èŠ‚ç‚¹çš„çº¿ç¨‹ï¼‰ã€‚</p>
<p>åœ¨acquireQueued(final Node node,int arg)æ–¹æ³•ä¸­ï¼Œå½“å‰çº¿ç¨‹åœ¨â€œæ­»å¾ªç¯â€ä¸­å°è¯•è·å–åŒæ­¥çŠ¶æ€ï¼Œè€Œåªæœ‰å‰é©±èŠ‚ç‚¹æ˜¯å¤´èŠ‚ç‚¹æ‰èƒ½å¤Ÿå°è¯•è·å–åŒæ­¥çŠ¶æ€ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆï¼ŸåŸå› æœ‰ä¸¤ä¸ªã€‚</p>
<p>ç¬¬ä¸€ï¼Œå¤´èŠ‚ç‚¹æ˜¯æˆåŠŸè·å–åˆ°åŒæ­¥çŠ¶æ€çš„èŠ‚ç‚¹ï¼Œè€Œå¤´èŠ‚ç‚¹çš„çº¿ç¨‹é‡Šæ”¾äº†åŒæ­¥çŠ¶æ€ä¹‹åï¼Œå°†ä¼šå”¤é†’å…¶åç»§èŠ‚ç‚¹ï¼Œåç»§èŠ‚ç‚¹çš„çº¿ç¨‹è¢«å”¤é†’åéœ€è¦æ£€æŸ¥è‡ªå·±çš„å‰é©±èŠ‚ç‚¹æ˜¯å¦æ˜¯å¤´èŠ‚ç‚¹ã€‚</p>
<p>ç¬¬äºŒï¼Œç»´æŠ¤åŒæ­¥é˜Ÿåˆ—çš„FIFOåŸåˆ™ã€‚</p>
<p>å½“å‰çº¿ç¨‹è·å–åˆ°åŒæ­¥çŠ¶æ€åï¼Œè®©<strong>é¦–èŠ‚ç‚¹</strong>ï¼ˆheadï¼‰è¿™ä¸ªå¼•ç”¨æŒ‡å‘è‡ªå·±æ‰€åœ¨èŠ‚ç‚¹ã€‚å½“åŒæ­¥çŠ¶æ€è·å–æˆåŠŸåï¼Œå½“å‰çº¿ç¨‹å°±ä»acquireæ–¹æ³•è¿”å›äº†ã€‚å¦‚æœåŒæ­¥å™¨å®ç°çš„æ˜¯é”ï¼Œé‚£å°±ä»£è¡¨å½“å‰çº¿ç¨‹è·å¾—äº†é”ã€‚</p>
<h6 id="é‡Šæ”¾"><a href="#é‡Šæ”¾" class="headerlink" title="é‡Šæ”¾"></a>é‡Šæ”¾</h6><p>å½“å‰çº¿ç¨‹è·å–åŒæ­¥çŠ¶æ€å¹¶æ‰§è¡Œäº†ç›¸åº”é€»è¾‘ä¹‹åï¼Œå°±éœ€è¦é‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼Œä½¿å¾—åç»­èŠ‚ç‚¹èƒ½å¤Ÿç»§ç»­è·å–åŒæ­¥çŠ¶æ€ã€‚é€šè¿‡è°ƒç”¨åŒæ­¥å™¨çš„release(int arg)æ–¹æ³•å¯ä»¥é‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼Œè¯¥æ–¹æ³•åœ¨é‡Šæ”¾äº†åŒæ­¥çŠ¶æ€ä¹‹åï¼Œä¼šå”¤é†’å…¶åç»§èŠ‚ç‚¹ï¼ˆè¿›è€Œä½¿åç»§èŠ‚ç‚¹é‡æ–°å°è¯•è·å–åŒæ­¥çŠ¶æ€ï¼‰ã€‚</p>
<img src="/blog/2020/07/30/JUC-AQS%E8%AF%A6%E8%A7%A3/pic15.png" srcset="/blog/img/loading.gif" class>

<p>è¯¥æ–¹æ³•æ‰§è¡Œæ—¶ï¼Œä¼šå”¤é†’<strong>é¦–èŠ‚ç‚¹</strong>ï¼ˆheadï¼‰æ‰€æŒ‡å‘èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹çº¿ç¨‹ï¼ŒunparkSuccessor(Node node)æ–¹æ³•ä½¿ç”¨LockSupportæ¥å”¤é†’å¤„äºç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹ã€‚</p>
<p>è€Œåœ¨unparkSuccessorä¸­ï¼Œ </p>
<img src="/blog/2020/07/30/JUC-AQS%E8%AF%A6%E8%A7%A3/pic16.png" srcset="/blog/img/loading.gif" class>

<p>è¿™æ®µä»£ç çš„æ„æ€ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè¢«å”¤é†’çš„æ˜¯headæŒ‡å‘èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹çº¿ç¨‹ï¼Œå¦‚æœè¿™ä¸ªåç»§èŠ‚ç‚¹å¤„äºè¢«cancelçŠ¶æ€ï¼Œï¼ˆæˆ‘æ¨æµ‹å¼€å‘è€…çš„æ€è·¯è¿™æ ·çš„ï¼šåç»§èŠ‚ç‚¹å¤„äºè¢«cancelçŠ¶æ€ï¼Œæ„å‘³ç€å½“é”ç«äº‰æ¿€çƒˆæ—¶ï¼Œé˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ç­‰äº†å¾ˆä¹…ï¼ˆä¸€ç›´è¢«è¿˜æœªåŠ å…¥é˜Ÿåˆ—çš„èŠ‚ç‚¹æŠ¢èµ°é”ï¼‰ï¼ŒåŒ…æ‹¬åç»­çš„èŠ‚ç‚¹cancelçš„å‡ ç‡éƒ½æ¯”è¾ƒå¤§ï¼Œæ‰€ä»¥ï¼‰å…ˆä»å°¾å¼€å§‹éå†ï¼Œæ‰¾åˆ°æœ€å‰é¢ä¸”æ²¡æœ‰è¢«cancelçš„èŠ‚ç‚¹ã€‚</p>
<h6 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h6><p>åœ¨è·å–åŒæ­¥çŠ¶æ€æ—¶ï¼ŒåŒæ­¥å™¨ç»´æŠ¤ä¸€ä¸ªåŒæ­¥é˜Ÿåˆ—ï¼Œè·å–çŠ¶æ€å¤±è´¥çš„çº¿ç¨‹éƒ½ä¼šè¢«åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­å¹¶åœ¨é˜Ÿåˆ—ä¸­è¿›è¡Œè‡ªæ—‹ï¼›ç§»å‡ºé˜Ÿåˆ—ï¼ˆæˆ–åœæ­¢è‡ªæ—‹ï¼‰çš„æ¡ä»¶æ˜¯å‰é©±èŠ‚ç‚¹ä¸ºå¤´èŠ‚ç‚¹ä¸”æˆåŠŸè·å–äº†åŒæ­¥çŠ¶æ€ã€‚åœ¨é‡Šæ”¾åŒæ­¥çŠ¶æ€æ—¶ï¼ŒåŒæ­¥å™¨è°ƒç”¨tryRelease(int arg)æ–¹æ³•é‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼Œç„¶åå”¤é†’headæŒ‡å‘èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ã€‚</p>
<h5 id="å…±äº«å¼åŒæ­¥çŠ¶æ€è·å–ä¸é‡Šæ”¾"><a href="#å…±äº«å¼åŒæ­¥çŠ¶æ€è·å–ä¸é‡Šæ”¾" class="headerlink" title="å…±äº«å¼åŒæ­¥çŠ¶æ€è·å–ä¸é‡Šæ”¾"></a>å…±äº«å¼åŒæ­¥çŠ¶æ€è·å–ä¸é‡Šæ”¾</h5><p>å…±äº«å¼è·å–ä¸ç‹¬å å¼è·å–æœ€ä¸»è¦çš„åŒºåˆ«åœ¨äºåŒä¸€æ—¶åˆ»èƒ½å¦æœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶è·å–åˆ°åŒæ­¥çŠ¶æ€ã€‚ä»¥è¯»å†™ä¸ºä¾‹ï¼Œå¦‚æœä¸€ä¸ªç¨‹åºåœ¨è¿›è¡Œè¯»æ“ä½œï¼Œé‚£ä¹ˆè¿™ä¸€æ—¶åˆ»å†™æ“ä½œå‡è¢«é˜»å¡ï¼Œè€Œè¯»æ“ä½œèƒ½å¤ŸåŒæ—¶è¿›è¡Œã€‚å†™æ“ä½œè¦æ±‚å¯¹èµ„æºçš„ç‹¬å å¼è®¿é—®ï¼Œè€Œè¯»æ“ä½œå¯ä»¥æ˜¯å…±äº«å¼è®¿é—®ã€‚</p>
<p>åœ¨acquireShared(int arg)æ–¹æ³•ä¸­ï¼ŒåŒæ­¥å™¨è°ƒç”¨tryAcquireShared(int arg)æ–¹æ³•å°è¯•è·å–åŒæ­¥çŠ¶æ€ï¼ŒtryAcquireShared(int arg)æ–¹æ³•è¿”å›å€¼ä¸ºintç±»å‹ï¼Œå½“è¿”å›å€¼å¤§äºç­‰äº0æ—¶ï¼Œè¡¨ç¤ºèƒ½å¤Ÿè·å–åˆ°åŒæ­¥çŠ¶æ€ã€‚å› æ­¤ï¼Œåœ¨å…±äº«å¼è·å–çš„è‡ªæ—‹è¿‡ç¨‹ä¸­ï¼ŒæˆåŠŸè·å–åˆ°åŒæ­¥çŠ¶æ€å¹¶é€€å‡ºè‡ªæ—‹çš„æ¡ä»¶å°±æ˜¯tryAcquireShared(int arg)æ–¹æ³•è¿”å›å€¼å¤§äºç­‰äº0ã€‚å¯ä»¥çœ‹åˆ°ï¼Œåœ¨doAcquireShared(int arg)æ–¹æ³•çš„è‡ªæ—‹è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå½“å‰èŠ‚ç‚¹çš„å‰é©±ä¸ºå¤´èŠ‚ç‚¹æ—¶ï¼Œå°è¯•è·å–åŒæ­¥çŠ¶æ€ï¼Œå¦‚æœè¿”å›å€¼å¤§äºç­‰äº0ï¼Œè¡¨ç¤ºè¯¥æ¬¡è·å–åŒæ­¥çŠ¶æ€æˆåŠŸå¹¶ä»è‡ªæ—‹è¿‡ç¨‹ä¸­é€€å‡ºã€‚</p>
<p>è¯¥æ–¹æ³•åœ¨é‡Šæ”¾åŒæ­¥çŠ¶æ€ä¹‹åï¼Œå°†ä¼šå”¤é†’åç»­å¤„äºç­‰å¾…çŠ¶æ€çš„èŠ‚ç‚¹ã€‚å¯¹äºèƒ½å¤Ÿæ”¯æŒå¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®çš„å¹¶å‘ç»„ä»¶ï¼ˆæ¯”å¦‚Semaphoreï¼‰ï¼Œå®ƒå’Œç‹¬å å¼ä¸»è¦åŒºåˆ«åœ¨äºtryReleaseShared(int arg)æ–¹æ³•å¿…é¡»ç¡®ä¿åŒæ­¥çŠ¶æ€ï¼ˆæˆ–è€…èµ„æºæ•°ï¼‰çº¿ç¨‹å®‰å…¨é‡Šæ”¾ï¼Œä¸€èˆ¬æ˜¯é€šè¿‡å¾ªç¯å’ŒCASæ¥ä¿è¯çš„ï¼Œå› ä¸ºé‡Šæ”¾åŒæ­¥çŠ¶æ€çš„æ“ä½œä¼šåŒæ—¶æ¥è‡ªå¤šä¸ªçº¿ç¨‹ã€‚</p>
<h5 id="å…±äº«å¼çš„åŒæ­¥å·¥å…·ç±»"><a href="#å…±äº«å¼çš„åŒæ­¥å·¥å…·ç±»" class="headerlink" title="å…±äº«å¼çš„åŒæ­¥å·¥å…·ç±»"></a>å…±äº«å¼çš„åŒæ­¥å·¥å…·ç±»</h5><p>è®¾è®¡ä¸€ä¸ªåŒæ­¥å·¥å…·ï¼šè¯¥å·¥å…·åœ¨åŒä¸€æ—¶åˆ»ï¼Œåªå…è®¸è‡³å¤š3ä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®ï¼Œè¶…è¿‡3ä¸ªçº¿ç¨‹çš„è®¿é—®å°†è¢«é˜»å¡ã€‚</p>
<p>é¦–å…ˆï¼Œç¡®å®šè®¿é—®æ¨¡å¼ã€‚TrinityLockèƒ½å¤Ÿåœ¨åŒä¸€æ—¶åˆ»æ”¯æŒå¤šä¸ªçº¿ç¨‹çš„è®¿é—®ï¼Œè¿™æ˜¾ç„¶æ˜¯å…±äº«å¼è®¿é—®ï¼Œå› æ­¤ï¼Œéœ€è¦ä½¿ç”¨åŒæ­¥å™¨æä¾›çš„acquireShared(int args)æ–¹æ³•ç­‰å’ŒSharedç›¸å…³çš„æ–¹æ³•ï¼Œè¿™å°±è¦æ±‚TwinsLockå¿…é¡»é‡å†™tryAcquireShared(int args)æ–¹æ³•å’ŒtryReleaseShared(int args)æ–¹æ³•ï¼Œè¿™æ ·æ‰èƒ½ä¿è¯åŒæ­¥å™¨çš„å…±äº«å¼åŒæ­¥çŠ¶æ€çš„è·å–ä¸é‡Šæ”¾æ–¹æ³•å¾—ä»¥æ‰§è¡Œã€‚</p>
<p>å…¶æ¬¡ï¼Œå®šä¹‰èµ„æºæ•°ã€‚TrinityLockåœ¨åŒä¸€æ—¶åˆ»å…è®¸è‡³å¤šä¸‰ä¸ªçº¿ç¨‹çš„åŒæ—¶è®¿é—®ï¼Œè¡¨æ˜åŒæ­¥èµ„æºæ•°ä¸º3ï¼Œè¿™æ ·å¯ä»¥è®¾ç½®åˆå§‹çŠ¶æ€statusä¸º3ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œè·å–ï¼Œstatuså‡1ï¼Œè¯¥çº¿ç¨‹é‡Šæ”¾ï¼Œåˆ™statusåŠ 1ï¼ŒçŠ¶æ€çš„åˆæ³•èŒƒå›´ä¸º0ã€1å’Œ2,3ï¼Œå…¶ä¸­0è¡¨ç¤ºå½“å‰å·²ç»æœ‰3ä¸ªçº¿ç¨‹è·å–äº†åŒæ­¥èµ„æºï¼Œæ­¤æ—¶å†æœ‰å…¶ä»–çº¿ç¨‹å¯¹åŒæ­¥çŠ¶æ€è¿›è¡Œè·å–ï¼Œè¯¥çº¿ç¨‹åªèƒ½è¢«é˜»å¡ã€‚åœ¨åŒæ­¥çŠ¶æ€å˜æ›´æ—¶ï¼Œéœ€è¦ä½¿ç”¨compareAndSet(int expect,int update)æ–¹æ³•åšåŸå­æ€§ä¿éšœã€‚</p>
<p>æœ€åï¼Œç»„åˆè‡ªå®šä¹‰åŒæ­¥å™¨ã€‚å‰é¢çš„ç« èŠ‚æåˆ°ï¼Œè‡ªå®šä¹‰åŒæ­¥ç»„ä»¶é€šè¿‡ç»„åˆè‡ªå®šä¹‰åŒæ­¥å™¨æ¥å®ŒæˆåŒæ­¥åŠŸèƒ½ï¼Œä¸€èˆ¬æƒ…å†µä¸‹è‡ªå®šä¹‰åŒæ­¥å™¨ä¼šè¢«å®šä¹‰ä¸ºè‡ªå®šä¹‰åŒæ­¥ç»„ä»¶çš„å†…éƒ¨ç±»ã€‚</p>
<pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment"> *ç±»è¯´æ˜ï¼šå…±äº«åŒæ­¥å·¥å…·ç±»</span>
<span class="hljs-comment"> */</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TrinityLock</span>  <span class="hljs-keyword">implements</span> <span class="hljs-title">Lock</span> </span>&#123;

    <span class="hljs-comment">//ä¸ºnè¡¨ç¤ºå…è®¸nä¸ªçº¿ç¨‹åŒæ—¶è·å¾—é”</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Sync sync = <span class="hljs-keyword">new</span> Sync(<span class="hljs-number">4</span>);

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Sync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractQueuedSynchronizer</span> </span>&#123;
        <span class="hljs-comment">//private static final long serialVersionUID = -7889272986162341211L;</span>

        Sync(<span class="hljs-keyword">int</span> count) &#123;
            <span class="hljs-keyword">if</span> (count &lt;= <span class="hljs-number">0</span>) &#123;
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">&quot;count must large than zero.&quot;</span>);
            &#125;
            setState(count);
        &#125;

        <span class="hljs-comment">/**</span>
<span class="hljs-comment">         *</span>
<span class="hljs-comment">         * <span class="hljs-doctag">@param</span> reduceCount  æ‰£å‡ä¸ªæ•°</span>
<span class="hljs-comment">         * <span class="hljs-doctag">@return</span>  è¿”å›å°äº0ï¼Œè¡¨ç¤ºå½“å‰çº¿ç¨‹è·å¾—åŒæ­¥çŠ¶æ€å¤±è´¥</span>
<span class="hljs-comment">         * å¤§äº0ï¼Œè¡¨ç¤ºå½“å‰çº¿ç¨‹è·å¾—åŒæ­¥çŠ¶æ€æˆåŠŸ</span>
<span class="hljs-comment">         */</span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">tryAcquireShared</span><span class="hljs-params">(<span class="hljs-keyword">int</span> reduceCount)</span> </span>&#123;
            <span class="hljs-keyword">for</span> (;;) &#123;
                <span class="hljs-keyword">int</span> current = getState();
                <span class="hljs-keyword">int</span> newCount = current - reduceCount;
                <span class="hljs-keyword">if</span> (newCount &lt; <span class="hljs-number">0</span> || compareAndSetState(current, newCount)) &#123;
                    <span class="hljs-keyword">return</span> newCount;
                &#125;
            &#125;
        &#125;

        <span class="hljs-comment">/**</span>
<span class="hljs-comment">         *</span>
<span class="hljs-comment">         * <span class="hljs-doctag">@param</span> returnCount å½’è¿˜ä¸ªæ•°</span>
<span class="hljs-comment">         * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment">         */</span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">tryReleaseShared</span><span class="hljs-params">(<span class="hljs-keyword">int</span> returnCount)</span> </span>&#123;
            <span class="hljs-keyword">for</span> (;;) &#123;
                <span class="hljs-keyword">int</span> current = getState();
                <span class="hljs-keyword">int</span> newCount = current + returnCount;
                <span class="hljs-keyword">if</span> (compareAndSetState(current, newCount)) &#123;
                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
                &#125;
            &#125;
        &#125;

        <span class="hljs-function"><span class="hljs-keyword">final</span> ConditionObject <span class="hljs-title">newCondition</span><span class="hljs-params">()</span> </span>&#123;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ConditionObject();
        &#125;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">lock</span><span class="hljs-params">()</span> </span>&#123;
        sync.acquireShared(<span class="hljs-number">1</span>);
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">unlock</span><span class="hljs-params">()</span> </span>&#123;
        sync.releaseShared(<span class="hljs-number">1</span>);
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">lockInterruptibly</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;
        sync.acquireSharedInterruptibly(<span class="hljs-number">1</span>);
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">tryLock</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> sync.tryAcquireShared(<span class="hljs-number">1</span>) &gt;= <span class="hljs-number">0</span>;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">tryLock</span><span class="hljs-params">(<span class="hljs-keyword">long</span> time, TimeUnit unit)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;
        <span class="hljs-keyword">return</span> sync.tryAcquireSharedNanos(<span class="hljs-number">1</span>, unit.toNanos(time));
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Condition <span class="hljs-title">newCondition</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> sync.newCondition();
    &#125;
&#125;</code></pre>

<h3 id="AQSçš„å®ç°"><a href="#AQSçš„å®ç°" class="headerlink" title="AQSçš„å®ç°"></a>AQSçš„å®ç°</h3><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SelfLock</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Lock</span> </span>&#123;
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * é™æ€å†…éƒ¨ç±»ï¼Œè‡ªå®šä¹‰åŒæ­¥å™¨</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Sync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractQueuedSynchronizer</span> </span>&#123;
        <span class="hljs-comment">//private static final long serialVersionUID = -4387327721959839431L;</span>

        <span class="hljs-comment">/**</span>
<span class="hljs-comment">         * æ˜¯å¦å¤„äºå ç”¨çŠ¶æ€</span>
<span class="hljs-comment">         */</span>
        <span class="hljs-meta">@Override</span>
        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isHeldExclusively</span><span class="hljs-params">()</span> </span>&#123;
            <span class="hljs-keyword">return</span> getState() == <span class="hljs-number">1</span>;
        &#125;

        <span class="hljs-comment">/**</span>
<span class="hljs-comment">         * è·å¾—é”</span>
<span class="hljs-comment">         */</span>
        <span class="hljs-meta">@Override</span>
        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">tryAcquire</span><span class="hljs-params">(<span class="hljs-keyword">int</span> arg)</span> </span>&#123;
            <span class="hljs-keyword">if</span> (compareAndSetState(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)) &#123;
                setExclusiveOwnerThread(Thread.currentThread());
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
            &#125;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
        &#125;

        <span class="hljs-comment">/**</span>
<span class="hljs-comment">         * é‡Šæ”¾é”</span>
<span class="hljs-comment">         */</span>
        <span class="hljs-meta">@Override</span>
        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">tryRelease</span><span class="hljs-params">(<span class="hljs-keyword">int</span> arg)</span> </span>&#123;
            <span class="hljs-keyword">if</span> (getState() == <span class="hljs-number">0</span>) &#123;
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalMonitorStateException();
            &#125;
            setExclusiveOwnerThread(<span class="hljs-keyword">null</span>);
            setState(<span class="hljs-number">0</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
        &#125;

        <span class="hljs-comment">/**</span>
<span class="hljs-comment">         * è¿”å›ä¸€ä¸ªConditionï¼Œæ¯ä¸ªconditionéƒ½åŒ…å«äº†ä¸€ä¸ªconditioné˜Ÿåˆ—</span>
<span class="hljs-comment">         */</span>
        <span class="hljs-function">Condition <span class="hljs-title">newCondition</span><span class="hljs-params">()</span> </span>&#123;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ConditionObject();
        &#125;
    &#125;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * ä»…éœ€è¦å°†æ“ä½œä»£ç†åˆ°Syncä¸Šå³å¯</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Sync sync = <span class="hljs-keyword">new</span> Sync();

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">lock</span><span class="hljs-params">()</span> </span>&#123;
        System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot; ready get lock&quot;</span>);
        sync.acquire(<span class="hljs-number">1</span>);
        System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot; already got lock&quot;</span>);
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">tryLock</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> sync.tryAcquire(<span class="hljs-number">1</span>);
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">unlock</span><span class="hljs-params">()</span> </span>&#123;
        System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot; ready release lock&quot;</span>);
        sync.release(<span class="hljs-number">1</span>);
        System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot; already released lock&quot;</span>);
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Condition <span class="hljs-title">newCondition</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> sync.newCondition();
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isLocked</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> sync.isHeldExclusively();
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">hasQueuedThreads</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> sync.hasQueuedThreads();
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">lockInterruptibly</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;
        sync.acquireInterruptibly(<span class="hljs-number">1</span>);
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">tryLock</span><span class="hljs-params">(<span class="hljs-keyword">long</span> timeout, TimeUnit unit)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;
        <span class="hljs-keyword">return</span> sync.tryAcquireNanos(<span class="hljs-number">1</span>, unit.toNanos(timeout));
    &#125;
&#125;</code></pre>

<p><strong>æµ‹è¯•ç±»</strong></p>
<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestMyLock</span> </span>&#123;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">final</span> Lock lock = <span class="hljs-keyword">new</span> SelfLock();
        <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Worker</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Thread</span> </span>&#123;
         <span class="hljs-meta">@Override</span>
            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;
                lock.lock();
                System.out.println(Thread.currentThread().getName());
                <span class="hljs-keyword">try</span> &#123;
                    SleepTools.second(<span class="hljs-number">1</span>);
                &#125; <span class="hljs-keyword">finally</span> &#123;
                    lock.unlock();
                &#125;
            &#125;
        &#125;
        <span class="hljs-comment">// å¯åŠ¨4ä¸ªå­çº¿ç¨‹</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; i++) &#123;
            Worker w = <span class="hljs-keyword">new</span> Worker();
            <span class="hljs-comment">//w.setDaemon(true);</span>
            w.start();
        &#125;
        <span class="hljs-comment">// ä¸»çº¿ç¨‹æ¯éš”1ç§’æ¢è¡Œ</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;
           SleepTools.second(<span class="hljs-number">1</span>);
            <span class="hljs-comment">//System.out.println();</span>
        &#125;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;
        TestMyLock testMyLock = <span class="hljs-keyword">new</span> TestMyLock();
        testMyLock.test();
    &#125;
&#125;</code></pre>

<h3 id="Conditionåˆ†æ"><a href="#Conditionåˆ†æ" class="headerlink" title="Conditionåˆ†æ"></a>Conditionåˆ†æ</h3><p>ä»»æ„ä¸€ä¸ªJavaå¯¹è±¡ï¼Œéƒ½æ‹¥æœ‰ä¸€ç»„ç›‘è§†å™¨æ–¹æ³•ï¼ˆå®šä¹‰åœ¨java.lang.Objectä¸Šï¼‰ï¼Œä¸»è¦åŒ…æ‹¬wait()ã€wait(long timeout)ã€notify()ä»¥åŠnotifyAll()æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•ä¸synchronizedåŒæ­¥å…³é”®å­—é…åˆï¼Œå¯ä»¥å®ç°ç­‰å¾…/é€šçŸ¥æ¨¡å¼ã€‚Conditionæ¥å£ä¹Ÿæä¾›äº†ç±»ä¼¼Objectçš„ç›‘è§†å™¨æ–¹æ³•await()ï¼Œsignal()ï¼Œä»¥ä¾¿ä¸Locké…åˆå¯ä»¥å®ç°ç­‰å¾…/é€šçŸ¥æ¨¡å¼ã€‚</p>
<h4 id="ç”¨Lockå’ŒConditionå®ç°ç­‰å¾…é€šçŸ¥"><a href="#ç”¨Lockå’ŒConditionå®ç°ç­‰å¾…é€šçŸ¥" class="headerlink" title="ç”¨Lockå’ŒConditionå®ç°ç­‰å¾…é€šçŸ¥"></a>ç”¨Lockå’ŒConditionå®ç°ç­‰å¾…é€šçŸ¥</h4><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment"> * ç±»è¯´æ˜ï¼š</span>
<span class="hljs-comment"> */</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ExpressCond</span> </span>&#123;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> String CITY = <span class="hljs-string">&quot;ShangHai&quot;</span>;
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * å¿«é€’è¿è¾“é‡Œç¨‹æ•°</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> km;
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * å¿«é€’åˆ°è¾¾åœ°ç‚¹</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-keyword">private</span> String site;
    <span class="hljs-keyword">private</span> Lock kmLock = <span class="hljs-keyword">new</span> ReentrantLock();
    <span class="hljs-keyword">private</span> Lock siteLock = <span class="hljs-keyword">new</span> ReentrantLock();
    <span class="hljs-keyword">private</span> Condition kmCondition = kmLock.newCondition();
    <span class="hljs-keyword">private</span> Condition siteCondition = siteLock.newCondition();

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ExpressCond</span><span class="hljs-params">(<span class="hljs-keyword">int</span> km, String site)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.km = km;
        <span class="hljs-keyword">this</span>.site = site;
    &#125;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * å˜åŒ–å…¬é‡Œæ•°ï¼Œç„¶åé€šçŸ¥å¤„äºwaitçŠ¶æ€å¹¶éœ€è¦å¤„ç†å…¬é‡Œæ•°çš„çº¿ç¨‹è¿›è¡Œä¸šåŠ¡å¤„ç†</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">changeKm</span><span class="hljs-params">()</span> </span>&#123;
        kmLock.lock();
        <span class="hljs-keyword">try</span> &#123;
            <span class="hljs-keyword">this</span>.km = <span class="hljs-number">101</span>;
            kmCondition.signal();
        &#125; <span class="hljs-keyword">finally</span> &#123;
            kmLock.unlock();
        &#125;
    &#125;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * å˜åŒ–åœ°ç‚¹ï¼Œç„¶åé€šçŸ¥å¤„äºwaitçŠ¶æ€å¹¶éœ€è¦å¤„ç†åœ°ç‚¹çš„çº¿ç¨‹è¿›è¡Œä¸šåŠ¡å¤„ç†</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">changeSite</span><span class="hljs-params">()</span> </span>&#123;
        siteLock.lock();
        <span class="hljs-keyword">try</span> &#123;
            <span class="hljs-keyword">this</span>.site = <span class="hljs-string">&quot;BeiJing&quot;</span>;
            siteCondition.signal();
        &#125; <span class="hljs-keyword">finally</span> &#123;
            siteLock.unlock();
        &#125;
    &#125;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * å½“å¿«é€’çš„é‡Œç¨‹æ•°å¤§äº100æ—¶æ›´æ–°æ•°æ®åº“</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">waitKm</span><span class="hljs-params">()</span> </span>&#123;
        kmLock.lock();
        <span class="hljs-keyword">try</span> &#123;
            <span class="hljs-keyword">while</span> (<span class="hljs-keyword">this</span>.km &lt; <span class="hljs-number">100</span>) &#123;
                <span class="hljs-keyword">try</span> &#123;
                    kmCondition.await();
                    System.out.println(<span class="hljs-string">&quot;check Site thread[&quot;</span> + Thread.currentThread().getId()
                            + <span class="hljs-string">&quot;] is be notified&quot;</span>);
                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;
                    e.printStackTrace();
                &#125;
            &#125;
        &#125; <span class="hljs-keyword">finally</span> &#123;
            kmLock.unlock();
        &#125;
        System.out.println(<span class="hljs-string">&quot;the Km is &quot;</span> + <span class="hljs-keyword">this</span>.km + <span class="hljs-string">&quot;,I will change db&quot;</span>);
    &#125;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * å½“å¿«é€’åˆ°è¾¾ç›®çš„åœ°æ—¶é€šçŸ¥ç”¨æˆ·</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">waitSite</span><span class="hljs-params">()</span> </span>&#123;
        siteLock.lock();
        <span class="hljs-keyword">try</span> &#123;
            <span class="hljs-keyword">while</span> (<span class="hljs-keyword">this</span>.site.equals(CITY)) &#123;
                <span class="hljs-keyword">try</span> &#123;
                    siteCondition.await();<span class="hljs-comment">//å½“å‰çº¿ç¨‹è¿›è¡Œç­‰å¾…</span>
                    System.out.println(<span class="hljs-string">&quot;check Site thread[&quot;</span> + Thread.currentThread().getName()
                            + <span class="hljs-string">&quot;] is be notify&quot;</span>);
                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;
                    e.printStackTrace();
                &#125;
            &#125;
        &#125; <span class="hljs-keyword">finally</span> &#123;
            siteLock.unlock();
        &#125;
        System.out.println(<span class="hljs-string">&quot;the site is &quot;</span> + <span class="hljs-keyword">this</span>.site + <span class="hljs-string">&quot;,I will call user&quot;</span>);
    &#125;
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ExpressCond express = <span class="hljs-keyword">new</span> ExpressCond(<span class="hljs-number">0</span>, ExpressCond.CITY);

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * æ£€æŸ¥é‡Œç¨‹æ•°å˜åŒ–çš„çº¿ç¨‹,ä¸æ»¡è¶³æ¡ä»¶ï¼Œçº¿ç¨‹ä¸€ç›´ç­‰å¾…</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CheckKm</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Thread</span> </span>&#123;
        <span class="hljs-meta">@Override</span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;
            express.waitKm();
        &#125;
    &#125;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * æ£€æŸ¥åœ°ç‚¹å˜åŒ–çš„çº¿ç¨‹,ä¸æ»¡è¶³æ¡ä»¶ï¼Œçº¿ç¨‹ä¸€ç›´ç­‰å¾…</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CheckSite</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Thread</span> </span>&#123;
        <span class="hljs-meta">@Override</span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;
            express.waitSite();
        &#125;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) &#123;
            <span class="hljs-keyword">new</span> ExpressCond.CheckSite().start();
        &#125;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) &#123;
            <span class="hljs-keyword">new</span> ExpressCond.CheckKm().start();
        &#125;

        Thread.sleep(<span class="hljs-number">1000</span>);
        express.changeKm();<span class="hljs-comment">//å¿«é€’é‡Œç¨‹å˜åŒ–</span>
    &#125;
&#125;</code></pre>

<h4 id="Conditionçš„æ•°æ®ç»“æ„"><a href="#Conditionçš„æ•°æ®ç»“æ„" class="headerlink" title="Conditionçš„æ•°æ®ç»“æ„"></a>Conditionçš„æ•°æ®ç»“æ„</h4><p>ç­‰å¾…é˜Ÿåˆ—æ˜¯ä¸€ä¸ªFIFOçš„é˜Ÿåˆ—ï¼Œåœ¨é˜Ÿåˆ—ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½åŒ…å«äº†ä¸€ä¸ªçº¿ç¨‹å¼•ç”¨ï¼Œè¯¥çº¿ç¨‹å°±æ˜¯åœ¨Conditionå¯¹è±¡ä¸Šç­‰å¾…çš„çº¿ç¨‹ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹è°ƒç”¨äº†Condition.await()æ–¹æ³•ï¼Œé‚£ä¹ˆè¯¥çº¿ç¨‹å°†ä¼šé‡Šæ”¾é”ã€æ„é€ æˆèŠ‚ç‚¹åŠ å…¥ç­‰å¾…é˜Ÿåˆ—å¹¶è¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚äº‹å®ä¸Šï¼ŒèŠ‚ç‚¹çš„å®šä¹‰å¤ç”¨äº†åŒæ­¥å™¨ä¸­èŠ‚ç‚¹çš„å®šä¹‰ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒåŒæ­¥é˜Ÿåˆ—å’Œç­‰å¾…é˜Ÿåˆ—ä¸­èŠ‚ç‚¹ç±»å‹éƒ½æ˜¯åŒæ­¥å™¨çš„é™æ€å†…éƒ¨ç±»ã€‚</p>
<img src="/blog/2020/07/30/JUC-AQS%E8%AF%A6%E8%A7%A3/pic17.png" srcset="/blog/img/loading.gif" class>

<p>ä¸€ä¸ªConditionåŒ…å«ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—ï¼ŒConditionæ‹¥æœ‰é¦–èŠ‚ç‚¹ï¼ˆfirstWaiterï¼‰å’Œå°¾èŠ‚ç‚¹ï¼ˆlastWaiterï¼‰ã€‚å½“å‰çº¿ç¨‹è°ƒç”¨Condition.await()æ–¹æ³•ï¼Œå°†ä¼šä»¥å½“å‰çº¿ç¨‹æ„é€ èŠ‚ç‚¹ï¼Œå¹¶å°†èŠ‚ç‚¹ä»å°¾éƒ¨åŠ å…¥ç­‰å¾…é˜Ÿåˆ—ã€‚Conditionæ‹¥æœ‰é¦–å°¾èŠ‚ç‚¹çš„å¼•ç”¨ï¼Œè€Œæ–°å¢èŠ‚ç‚¹åªéœ€è¦å°†åŸæœ‰çš„å°¾èŠ‚ç‚¹nextWaiteræŒ‡å‘å®ƒï¼Œå¹¶ä¸”æ›´æ–°å°¾èŠ‚ç‚¹å³å¯ã€‚ä¸Šè¿°èŠ‚ç‚¹å¼•ç”¨æ›´æ–°çš„è¿‡ç¨‹å¹¶æ²¡æœ‰ä½¿ç”¨CASä¿è¯ï¼ŒåŸå› åœ¨äºè°ƒç”¨await()æ–¹æ³•çš„çº¿ç¨‹å¿…å®šæ˜¯è·å–äº†é”çš„çº¿ç¨‹ï¼Œä¹Ÿå°±æ˜¯è¯´è¯¥è¿‡ç¨‹æ˜¯ç”±é”æ¥ä¿è¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p>
<p>Lockï¼ˆæ›´ç¡®åˆ‡åœ°è¯´æ˜¯åŒæ­¥å™¨ï¼‰æ‹¥æœ‰ä¸€ä¸ªåŒæ­¥é˜Ÿåˆ—å’Œå¤šä¸ªç­‰å¾…é˜Ÿåˆ—ã€‚</p>
<img src="/blog/2020/07/30/JUC-AQS%E8%AF%A6%E8%A7%A3/pic18.png" srcset="/blog/img/loading.gif" class>

<p>è°ƒç”¨Conditionçš„await()æ–¹æ³•ï¼ˆæˆ–è€…ä»¥awaitå¼€å¤´çš„æ–¹æ³•ï¼‰ï¼Œä¼šä½¿å½“å‰çº¿ç¨‹è¿›å…¥ç­‰å¾…é˜Ÿåˆ—å¹¶é‡Šæ”¾é”ï¼ŒåŒæ—¶çº¿ç¨‹çŠ¶æ€å˜ä¸ºç­‰å¾…çŠ¶æ€ã€‚å½“ä»await()æ–¹æ³•è¿”å›æ—¶ï¼Œå½“å‰çº¿ç¨‹ä¸€å®šè·å–äº†Conditionç›¸å…³è”çš„é”ã€‚</p>
<p>å¦‚æœä»é˜Ÿåˆ—ï¼ˆåŒæ­¥é˜Ÿåˆ—å’Œç­‰å¾…é˜Ÿåˆ—ï¼‰çš„è§’åº¦çœ‹await()æ–¹æ³•ï¼Œå½“è°ƒç”¨await()æ–¹æ³•æ—¶ï¼Œç›¸å½“äºåŒæ­¥é˜Ÿåˆ—çš„é¦–èŠ‚ç‚¹ï¼ˆè·å–äº†é”çš„èŠ‚ç‚¹ï¼‰ç§»åŠ¨åˆ°Conditionçš„ç­‰å¾…é˜Ÿåˆ—ä¸­ã€‚è°ƒç”¨è¯¥æ–¹æ³•çš„çº¿ç¨‹æˆåŠŸè·å–äº†é”çš„çº¿ç¨‹ï¼Œä¹Ÿå°±æ˜¯åŒæ­¥é˜Ÿåˆ—ä¸­çš„é¦–èŠ‚ç‚¹ï¼Œè¯¥æ–¹æ³•ä¼šå°†å½“å‰çº¿ç¨‹æ„é€ æˆèŠ‚ç‚¹å¹¶åŠ å…¥ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œç„¶åé‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼Œå”¤é†’åŒæ­¥é˜Ÿåˆ—ä¸­çš„åç»§èŠ‚ç‚¹ï¼Œç„¶åå½“å‰çº¿ç¨‹ä¼šè¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚å½“ç­‰å¾…é˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹è¢«å”¤é†’ï¼Œåˆ™å”¤é†’èŠ‚ç‚¹çš„çº¿ç¨‹å¼€å§‹å°è¯•è·å–åŒæ­¥çŠ¶æ€ã€‚å¦‚æœä¸æ˜¯é€šè¿‡å…¶ä»–çº¿ç¨‹è°ƒç”¨Condition.signal()æ–¹æ³•å”¤é†’ï¼Œè€Œæ˜¯å¯¹ç­‰å¾…çº¿ç¨‹è¿›è¡Œä¸­æ–­ï¼Œåˆ™ä¼šæŠ›å‡ºInterruptedExceptionã€‚</p>
<img src="/blog/2020/07/30/JUC-AQS%E8%AF%A6%E8%A7%A3/pic19.png" srcset="/blog/img/loading.gif" class>

<p>å¦‚å›¾æ‰€ç¤ºï¼ŒåŒæ­¥é˜Ÿåˆ—çš„é¦–èŠ‚ç‚¹å¹¶ä¸ä¼šç›´æ¥åŠ å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œè€Œæ˜¯é€šè¿‡addConditionWaiter()æ–¹æ³•æŠŠå½“å‰çº¿ç¨‹æ„é€ æˆä¸€ä¸ªæ–°çš„èŠ‚ç‚¹å¹¶å°†å…¶åŠ å…¥ç­‰å¾…é˜Ÿåˆ—ä¸­ã€‚</p>
<img src="/blog/2020/07/30/JUC-AQS%E8%AF%A6%E8%A7%A3/pic20.png" srcset="/blog/img/loading.gif" class>

<p>è°ƒç”¨Conditionçš„signal()æ–¹æ³•ï¼Œå°†ä¼šå”¤é†’åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­ç­‰å¾…æ—¶é—´æœ€é•¿çš„èŠ‚ç‚¹ï¼ˆé¦–èŠ‚ç‚¹ï¼‰ï¼Œåœ¨å”¤é†’èŠ‚ç‚¹ä¹‹å‰ï¼Œä¼šå°†èŠ‚ç‚¹ç§»åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ã€‚</p>
<p>è°ƒç”¨è¯¥æ–¹æ³•çš„å‰ç½®æ¡ä»¶æ˜¯å½“å‰çº¿ç¨‹å¿…é¡»è·å–äº†é”ï¼Œå¯ä»¥çœ‹åˆ°signal()æ–¹æ³•è¿›è¡Œäº†isHeldExclusively()æ£€æŸ¥ï¼Œä¹Ÿå°±æ˜¯å½“å‰çº¿ç¨‹å¿…é¡»æ˜¯è·å–äº†é”çš„çº¿ç¨‹ã€‚æ¥ç€è·å–ç­‰å¾…é˜Ÿåˆ—çš„é¦–èŠ‚ç‚¹ï¼Œå°†å…¶ç§»åŠ¨åˆ°åŒæ­¥é˜Ÿåˆ—å¹¶ä½¿ç”¨LockSupportå”¤é†’èŠ‚ç‚¹ä¸­çš„çº¿ç¨‹ã€‚</p>
<p>é€šè¿‡è°ƒç”¨åŒæ­¥å™¨çš„enq(Node node)æ–¹æ³•ï¼Œç­‰å¾…é˜Ÿåˆ—ä¸­çš„å¤´èŠ‚ç‚¹çº¿ç¨‹å®‰å…¨åœ°ç§»åŠ¨åˆ°åŒæ­¥é˜Ÿåˆ—ã€‚å½“èŠ‚ç‚¹ç§»åŠ¨åˆ°åŒæ­¥é˜Ÿåˆ—åï¼Œå½“å‰çº¿ç¨‹å†ä½¿ç”¨LockSupportå”¤é†’è¯¥èŠ‚ç‚¹çš„çº¿ç¨‹ã€‚</p>
<p>è¢«å”¤é†’åçš„çº¿ç¨‹ï¼Œå°†ä»await()æ–¹æ³•ä¸­çš„whileå¾ªç¯ä¸­é€€å‡ºï¼ˆisOnSyncQueue(Node node)æ–¹æ³•è¿”å›trueï¼ŒèŠ‚ç‚¹å·²ç»åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­ï¼‰ï¼Œè¿›è€Œè°ƒç”¨åŒæ­¥å™¨çš„acquireQueued()æ–¹æ³•åŠ å…¥åˆ°è·å–åŒæ­¥çŠ¶æ€çš„ç«äº‰ä¸­ã€‚</p>
<p>æˆåŠŸè·å–åŒæ­¥çŠ¶æ€ï¼ˆæˆ–è€…è¯´é”ï¼‰ä¹‹åï¼Œè¢«å”¤é†’çš„çº¿ç¨‹å°†ä»å…ˆå‰è°ƒç”¨çš„await()æ–¹æ³•è¿”å›ï¼Œæ­¤æ—¶è¯¥çº¿ç¨‹å·²ç»æˆåŠŸåœ°è·å–äº†é”ã€‚</p>
<p>Conditionçš„signalAll()æ–¹æ³•ï¼Œç›¸å½“äºå¯¹ç­‰å¾…é˜Ÿåˆ—ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹å‡æ‰§è¡Œä¸€æ¬¡signal()æ–¹æ³•ï¼Œæ•ˆæœå°±æ˜¯å°†ç­‰å¾…é˜Ÿåˆ—ä¸­æ‰€æœ‰èŠ‚ç‚¹å…¨éƒ¨ç§»åŠ¨åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œå¹¶å”¤é†’æ¯ä¸ªèŠ‚ç‚¹çš„çº¿ç¨‹ã€‚</p>
<h3 id="JDKä¸­åŸºäºAQSçš„Lock"><a href="#JDKä¸­åŸºäºAQSçš„Lock" class="headerlink" title="JDKä¸­åŸºäºAQSçš„Lock"></a>JDKä¸­åŸºäºAQSçš„Lock</h3><h4 id="ReentrantLock"><a href="#ReentrantLock" class="headerlink" title="ReentrantLock"></a>ReentrantLock</h4><h5 id="é”çš„å¯é‡å…¥"><a href="#é”çš„å¯é‡å…¥" class="headerlink" title="é”çš„å¯é‡å…¥"></a>é”çš„å¯é‡å…¥</h5><p>é‡è¿›å…¥æ˜¯æŒ‡ä»»æ„çº¿ç¨‹åœ¨è·å–åˆ°é”ä¹‹åèƒ½å¤Ÿå†æ¬¡è·å–è¯¥é”è€Œä¸ä¼šè¢«é”æ‰€é˜»å¡ï¼Œè¯¥ç‰¹æ€§çš„å®ç°éœ€è¦è§£å†³ä»¥ä¸‹ä¸¤ä¸ªé—®é¢˜ã€‚</p>
<ol>
<li><p>çº¿ç¨‹å†æ¬¡è·å–é”ã€‚é”éœ€è¦å»è¯†åˆ«è·å–é”çš„çº¿ç¨‹æ˜¯å¦ä¸ºå½“å‰å æ®é”çš„çº¿ç¨‹ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™å†æ¬¡æˆåŠŸè·å–ã€‚</p>
</li>
<li><p>é”çš„æœ€ç»ˆé‡Šæ”¾ã€‚çº¿ç¨‹é‡å¤næ¬¡è·å–äº†é”ï¼Œéšååœ¨ç¬¬næ¬¡é‡Šæ”¾è¯¥é”åï¼Œå…¶ä»–çº¿ç¨‹èƒ½å¤Ÿè·å–åˆ°è¯¥é”ã€‚é”çš„æœ€ç»ˆé‡Šæ”¾è¦æ±‚é”å¯¹äºè·å–è¿›è¡Œè®¡æ•°è‡ªå¢ï¼Œè®¡æ•°è¡¨ç¤ºå½“å‰é”è¢«é‡å¤è·å–çš„æ¬¡æ•°ï¼Œè€Œé”è¢«é‡Šæ”¾æ—¶ï¼Œè®¡æ•°è‡ªå‡ï¼Œå½“è®¡æ•°ç­‰äº0æ—¶è¡¨ç¤ºé”å·²ç»æˆåŠŸé‡Šæ”¾ã€‚</p>
</li>
</ol>
<p>nonfairTryAcquireæ–¹æ³•å¢åŠ äº†å†æ¬¡è·å–åŒæ­¥çŠ¶æ€çš„å¤„ç†é€»è¾‘ï¼šé€šè¿‡åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦ä¸ºè·å–é”çš„çº¿ç¨‹æ¥å†³å®šè·å–æ“ä½œæ˜¯å¦æˆåŠŸï¼Œå¦‚æœæ˜¯è·å–é”çš„çº¿ç¨‹å†æ¬¡è¯·æ±‚ï¼Œåˆ™å°†åŒæ­¥çŠ¶æ€å€¼è¿›è¡Œå¢åŠ å¹¶è¿”å›trueï¼Œè¡¨ç¤ºè·å–åŒæ­¥çŠ¶æ€æˆåŠŸã€‚åŒæ­¥çŠ¶æ€è¡¨ç¤ºé”è¢«ä¸€ä¸ªçº¿ç¨‹é‡å¤è·å–çš„æ¬¡æ•°ã€‚</p>
<p>å¦‚æœè¯¥é”è¢«è·å–äº†næ¬¡ï¼Œé‚£ä¹ˆå‰(n-1)æ¬¡tryRelease(int releases)æ–¹æ³•å¿…é¡»è¿”å›falseï¼Œè€Œåªæœ‰åŒæ­¥çŠ¶æ€å®Œå…¨é‡Šæ”¾äº†ï¼Œæ‰èƒ½è¿”å›trueã€‚å¯ä»¥çœ‹åˆ°ï¼Œè¯¥æ–¹æ³•å°†åŒæ­¥çŠ¶æ€æ˜¯å¦ä¸º0ä½œä¸ºæœ€ç»ˆé‡Šæ”¾çš„æ¡ä»¶ï¼Œå½“åŒæ­¥çŠ¶æ€ä¸º0æ—¶ï¼Œå°†å æœ‰çº¿ç¨‹è®¾ç½®ä¸ºnullï¼Œå¹¶è¿”å›trueï¼Œè¡¨ç¤ºé‡Šæ”¾æˆåŠŸã€‚</p>
<h5 id="å…¬å¹³å’Œéå…¬å¹³é”"><a href="#å…¬å¹³å’Œéå…¬å¹³é”" class="headerlink" title="å…¬å¹³å’Œéå…¬å¹³é”"></a>å…¬å¹³å’Œéå…¬å¹³é”</h5><p>å…ˆå¯¹é”è¿›è¡Œè·å–çš„çº¿ç¨‹å³ç­‰å¾…æ—¶é—´æœ€é•¿çš„çº¿ç¨‹ä¸€å®šå…ˆè·å–åˆ°é”ï¼Œé‚£ä¹ˆè¿™ä¸ªé”æ˜¯å…¬å¹³çš„ï¼Œä¹Ÿå¯ä»¥è¯´é”è·å–æ˜¯é¡ºåºçš„ï¼Œåä¹‹å°±æ˜¯ä¸å…¬å¹³çš„ã€‚ ReentrantLockæä¾›äº†ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œèƒ½å¤Ÿæ§åˆ¶é”æ˜¯å¦æ˜¯å…¬å¹³çš„ï¼Œsynchronizedæ˜¯éå…¬å¹³é”ã€‚äº‹å®ä¸Šï¼Œå…¬å¹³çš„é”æœºåˆ¶å¾€å¾€æ²¡æœ‰éå…¬å¹³çš„æ•ˆç‡é«˜ã€‚  </p>
<p>çº¿ç¨‹è¢«å”¤é†’çš„ä¸Šä¸‹æ–‡åˆ‡æ¢æ—¶é—´å‘¨æœŸåœ¨5000-10000ä¹‹é—´ï¼Œåœ¨æ¿€çƒˆç«äº‰çš„æƒ…å†µä¸‹ï¼Œéå…¬å¹³é”çš„æ€§èƒ½é«˜äºå…¬å¹³é”çš„æ€§èƒ½çš„ä¸€ä¸ªåŸå› æ˜¯ï¼šåœ¨æ¢å¤ä¸€ä¸ªè¢«æŒ‚èµ·çš„çº¿ç¨‹ä¸è¯¥çº¿ç¨‹çœŸæ­£å¼€å§‹è¿è¡Œä¹‹é—´å­˜åœ¨ç€ä¸¥é‡çš„å»¶è¿Ÿã€‚å‡è®¾çº¿ç¨‹AæŒæœ‰ä¸€ä¸ªé”ï¼Œå¹¶ä¸”çº¿ç¨‹Bè¯·æ±‚è¿™ä¸ªé”ã€‚ç”±äºè¿™ä¸ªé”å·²è¢«çº¿ç¨‹AæŒæœ‰ï¼Œå› æ­¤Bå°†è¢«æŒ‚èµ·ã€‚å½“Aé‡Šæ”¾é”æ—¶ï¼ŒBå°†è¢«å”¤é†’ï¼ŒBå®Œå…¨å”¤é†’åä¼šå†æ¬¡å°è¯•è·å–é”ã€‚ä¸æ­¤åŒæ—¶ï¼Œå¦‚æœCä¹Ÿè¯·æ±‚è¿™ä¸ªé”ï¼Œé‚£ä¹ˆCå¾ˆå¯èƒ½ä¼šåœ¨Bè¢«å®Œå…¨å”¤é†’ä¹‹å‰è·å¾—ã€ä½¿ç”¨ä»¥åŠé‡Šæ”¾è¿™ä¸ªé”ã€‚è¿™æ ·çš„æƒ…å†µæ˜¯ä¸€ç§â€œåŒèµ¢â€çš„å±€é¢ï¼šBè·å¾—é”çš„æ—¶åˆ»å¹¶æ²¡æœ‰æ¨è¿Ÿï¼ŒCæ›´æ—©åœ°è·å¾—äº†é”ï¼Œå¹¶ä¸”ååé‡ä¹Ÿè·å¾—äº†æé«˜ã€‚</p>
<p>ReentrantLockçš„æ„é€ å‡½æ•°ä¸­ï¼Œé»˜è®¤çš„æ— å‚æ„é€ å‡½æ•°å°†ä¼šæŠŠSyncå¯¹è±¡åˆ›å»ºä¸ºNonfairSyncå¯¹è±¡ï¼Œè¿™æ˜¯ä¸€ä¸ªéå…¬å¹³é”ï¼›è€Œå¦ä¸€ä¸ªæ„é€ å‡½æ•°ReentrantLock(boolean fair)ä¼ å…¥å‚æ•°ä¸ºtrueæ—¶å°†ä¼šæŠŠSyncå¯¹è±¡åˆ›å»ºä¸ºå…¬å¹³é”FairSyncã€‚</p>
<p>å…¬å¹³é”çš„tryAcquire()æ–¹æ³•ä¸éå…¬å¹³é”çš„nonfairTryAcquire(int acquires)ç›¸æ¯”ï¼Œå”¯ä¸€ä¸åŒçš„ä½ç½®ä¸ºåˆ¤æ–­æ¡ä»¶å¤šäº†hasQueuedPredecessors()æ–¹æ³•ï¼Œå³åŠ å…¥äº†åŒæ­¥é˜Ÿåˆ—ä¸­å½“å‰èŠ‚ç‚¹æ˜¯å¦æœ‰å‰é©±èŠ‚ç‚¹çš„åˆ¤æ–­ï¼Œå¦‚æœè¯¥æ–¹æ³•è¿”å›trueï¼Œåˆ™è¡¨ç¤ºæœ‰çº¿ç¨‹æ¯”å½“å‰çº¿ç¨‹æ›´æ—©åœ°è¯·æ±‚è·å–é”ï¼Œå› æ­¤éœ€è¦ç­‰å¾…å‰é©±çº¿ç¨‹è·å–å¹¶é‡Šæ”¾é”ä¹‹åæ‰èƒ½ç»§ç»­è·å–é”ï¼Œè€Œéå…¬å¹³é”åªè¦CASè®¾ç½®åŒæ­¥çŠ¶æ€æˆåŠŸï¼Œåˆ™è¡¨ç¤ºå½“å‰çº¿ç¨‹è·å–äº†é”ã€‚</p>
<h5 id="æ”¹é€ ä¹‹å‰çš„ç‹¬å é”ä¸ºå¯é‡å…¥"><a href="#æ”¹é€ ä¹‹å‰çš„ç‹¬å é”ä¸ºå¯é‡å…¥" class="headerlink" title="æ”¹é€ ä¹‹å‰çš„ç‹¬å é”ä¸ºå¯é‡å…¥"></a>æ”¹é€ ä¹‹å‰çš„ç‹¬å é”ä¸ºå¯é‡å…¥</h5><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment"> *ç±»è¯´æ˜ï¼šå®ç°æˆ‘ä»¬è‡ªå·±ç‹¬å é”,å¯é‡å…¥</span>
<span class="hljs-comment"> */</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ReenterSelfLock</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Lock</span> </span>&#123;
    <span class="hljs-comment">// é™æ€å†…éƒ¨ç±»ï¼Œè‡ªå®šä¹‰åŒæ­¥å™¨</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Sync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractQueuedSynchronizer</span> </span>&#123;

        <span class="hljs-comment">// æ˜¯å¦å¤„äºå ç”¨çŠ¶æ€</span>
        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isHeldExclusively</span><span class="hljs-params">()</span> </span>&#123;
            <span class="hljs-keyword">return</span> getState() &gt; <span class="hljs-number">0</span>;
        &#125;

        <span class="hljs-comment">// å½“çŠ¶æ€ä¸º0çš„æ—¶å€™è·å–é”</span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">tryAcquire</span><span class="hljs-params">(<span class="hljs-keyword">int</span> acquires)</span> </span>&#123;
            <span class="hljs-keyword">if</span> (compareAndSetState(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)) &#123;
                setExclusiveOwnerThread(Thread.currentThread());
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
            &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(getExclusiveOwnerThread()==Thread.currentThread())&#123;
                setState(getState()+<span class="hljs-number">1</span>);
                <span class="hljs-keyword">return</span>  <span class="hljs-keyword">true</span>;
            &#125;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
        &#125;

        <span class="hljs-comment">// é‡Šæ”¾é”ï¼Œå°†çŠ¶æ€è®¾ç½®ä¸º0</span>
        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">tryRelease</span><span class="hljs-params">(<span class="hljs-keyword">int</span> releases)</span> </span>&#123;
            <span class="hljs-keyword">if</span>(getExclusiveOwnerThread()!=Thread.currentThread())&#123;
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalMonitorStateException();
            &#125;
            <span class="hljs-keyword">if</span> (getState() == <span class="hljs-number">0</span>)
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalMonitorStateException();

            setState(getState()-<span class="hljs-number">1</span>);
            <span class="hljs-keyword">if</span>(getState()==<span class="hljs-number">0</span>)&#123;
                setExclusiveOwnerThread(<span class="hljs-keyword">null</span>);
            &#125;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
        &#125;

        <span class="hljs-comment">// è¿”å›ä¸€ä¸ªConditionï¼Œæ¯ä¸ªconditionéƒ½åŒ…å«äº†ä¸€ä¸ªconditioné˜Ÿåˆ—</span>
        <span class="hljs-function">Condition <span class="hljs-title">newCondition</span><span class="hljs-params">()</span> </span>&#123;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ConditionObject();
        &#125;
    &#125;

    <span class="hljs-comment">// ä»…éœ€è¦å°†æ“ä½œä»£ç†åˆ°Syncä¸Šå³å¯</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Sync sync = <span class="hljs-keyword">new</span> Sync();

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">lock</span><span class="hljs-params">()</span> </span>&#123;
       System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot; ready get lock&quot;</span>);
        sync.acquire(<span class="hljs-number">1</span>);
        System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot; already got lock&quot;</span>);
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">tryLock</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> sync.tryAcquire(<span class="hljs-number">1</span>);
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">unlock</span><span class="hljs-params">()</span> </span>&#123;
       System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot; ready release lock&quot;</span>);
        sync.release(<span class="hljs-number">1</span>);
        System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot; already released lock&quot;</span>);
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> Condition <span class="hljs-title">newCondition</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> sync.newCondition();
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isLocked</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> sync.isHeldExclusively();
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">hasQueuedThreads</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> sync.hasQueuedThreads();
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">lockInterruptibly</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;
        sync.acquireInterruptibly(<span class="hljs-number">1</span>);
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">tryLock</span><span class="hljs-params">(<span class="hljs-keyword">long</span> timeout, TimeUnit unit)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;
        <span class="hljs-keyword">return</span> sync.tryAcquireNanos(<span class="hljs-number">1</span>, unit.toNanos(timeout));
    &#125;
&#125;</code></pre>

<p>æµ‹è¯•ç±»</p>
<pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment"> *ç±»è¯´æ˜ï¼š</span>
<span class="hljs-comment"> */</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestReenterSelfLock</span> </span>&#123;

    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Lock lock = <span class="hljs-keyword">new</span> ReenterSelfLock();

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">reenter</span><span class="hljs-params">(<span class="hljs-keyword">int</span> x)</span></span>&#123;
        lock.lock();
        <span class="hljs-keyword">try</span> &#123;
            System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot;:é€’å½’å±‚çº§:&quot;</span>+x);
            <span class="hljs-keyword">int</span> y = x - <span class="hljs-number">1</span>;
            <span class="hljs-keyword">if</span> (y==<span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;
            <span class="hljs-keyword">else</span>&#123;
                reenter(y);
            &#125;
        &#125; <span class="hljs-keyword">finally</span> &#123;
            lock.unlock();
        &#125;

    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Worker</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Thread</span> </span>&#123;
			<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;
                System.out.println(Thread.currentThread().getName());
                SleepTools.second(<span class="hljs-number">1</span>);
                reenter(<span class="hljs-number">3</span>);
            &#125;
        &#125;
        <span class="hljs-comment">// å¯åŠ¨3ä¸ªå­çº¿ç¨‹</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) &#123;
            Worker w = <span class="hljs-keyword">new</span> Worker();
            w.start();
        &#125;
        <span class="hljs-comment">// ä¸»çº¿ç¨‹æ¯éš”1ç§’æ¢è¡Œ</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) &#123;
        	SleepTools.second(<span class="hljs-number">1</span>);
        &#125;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;
        TestReenterSelfLock testMyLock = <span class="hljs-keyword">new</span> TestReenterSelfLock();
        testMyLock.test();
    &#125;
&#125;</code></pre>

<h4 id="ReentrantReadWriteLock"><a href="#ReentrantReadWriteLock" class="headerlink" title="ReentrantReadWriteLock"></a>ReentrantReadWriteLock</h4><p>ä¹‹å‰æåˆ°é”ï¼ˆå¦‚synchronizedå’ŒReentrantLockï¼‰åŸºæœ¬éƒ½æ˜¯æ’ä»–é”å³ç‹¬å é”ï¼Œè¿™äº›é”åœ¨åŒä¸€æ—¶åˆ»åªå…è®¸ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œè®¿é—®ï¼Œè€Œè¯»å†™é”åœ¨åŒä¸€æ—¶åˆ»å¯ä»¥å…è®¸å¤šä¸ªè¯»çº¿ç¨‹è®¿é—®ï¼Œä½†æ˜¯åœ¨å†™çº¿ç¨‹è®¿é—®æ—¶ï¼Œæ‰€æœ‰çš„è¯»çº¿ç¨‹å’Œå…¶ä»–å†™çº¿ç¨‹å‡è¢«é˜»å¡ã€‚è¯»å†™é”ç»´æŠ¤äº†ä¸€å¯¹é”ï¼Œä¸€ä¸ªè¯»é”å’Œä¸€ä¸ªå†™é”ï¼Œé€šè¿‡åˆ†ç¦»è¯»é”å’Œå†™é”ï¼Œä½¿å¾—å¹¶å‘æ€§ç›¸æ¯”ä¸€èˆ¬çš„æ’ä»–é”æœ‰äº†å¾ˆå¤§æå‡ã€‚å†™é”ä¸ºç‹¬å é”ï¼Œè¯»é”ä¸ºå…±äº«é”ï¼Œè¯»å†™ä¹‹å‰ç›¸äº’æ’æ–¥ã€‚</p>
<p>é™¤äº†ä¿è¯å†™æ“ä½œå¯¹è¯»æ“ä½œçš„å¯è§æ€§ä»¥åŠæå‡å¹¶å‘æ€§ä¹‹å¤–ï¼Œè¯»å†™é”èƒ½å¤Ÿç®€åŒ–è¯»å†™äº¤äº’åœºæ™¯çš„ç¼–ç¨‹æ–¹å¼ã€‚å‡è®¾åœ¨ç¨‹åºä¸­å®šä¹‰ä¸€ä¸ªå…±äº«çš„ç”¨ä½œç¼“å­˜æ•°æ®ç»“æ„ï¼Œå®ƒå¤§éƒ¨åˆ†æ—¶é—´æä¾›è¯»æœåŠ¡ï¼ˆä¾‹å¦‚æŸ¥è¯¢å’Œæœç´¢ï¼‰ï¼Œè€Œå†™æ“ä½œå æœ‰çš„æ—¶é—´å¾ˆå°‘ï¼Œä½†æ˜¯å†™æ“ä½œå®Œæˆä¹‹åçš„æ›´æ–°éœ€è¦å¯¹åç»­çš„è¯»æœåŠ¡å¯è§ã€‚åœ¨æ²¡æœ‰è¯»å†™é”æ”¯æŒçš„ï¼ˆJava 5ä¹‹å‰ï¼‰æ—¶å€™ï¼Œå¦‚æœéœ€è¦å®Œæˆä¸Šè¿°å·¥ä½œå°±è¦ä½¿ç”¨Javaçš„ç­‰å¾…é€šçŸ¥æœºåˆ¶ï¼Œå°±æ˜¯å½“å†™æ“ä½œå¼€å§‹æ—¶ï¼Œæ‰€æœ‰æ™šäºå†™æ“ä½œçš„è¯»æ“ä½œå‡ä¼šè¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œåªæœ‰å†™æ“ä½œå®Œæˆå¹¶è¿›è¡Œé€šçŸ¥ä¹‹åï¼Œæ‰€æœ‰ç­‰å¾…çš„è¯»æ“ä½œæ‰èƒ½ç»§ç»­æ‰§è¡Œï¼ˆå†™æ“ä½œä¹‹é—´ä¾é synchronizedå…³é”®è¿›è¡ŒåŒæ­¥ï¼‰ï¼Œè¿™æ ·åšçš„ç›®çš„æ˜¯ä½¿è¯»æ“ä½œèƒ½è¯»å–åˆ°æ­£ç¡®çš„æ•°æ®ï¼Œä¸ä¼šå‡ºç°è„è¯»ã€‚æ”¹ç”¨è¯»å†™é”å®ç°ä¸Šè¿°åŠŸèƒ½ï¼Œåªéœ€è¦åœ¨è¯»æ“ä½œæ—¶è·å–è¯»é”ï¼Œå†™æ“ä½œæ—¶è·å–å†™é”å³å¯ã€‚å½“å†™é”è¢«è·å–åˆ°æ—¶ï¼Œåç»­ï¼ˆéå½“å‰å†™æ“ä½œçº¿ç¨‹ï¼‰çš„è¯»å†™æ“ä½œéƒ½ä¼šè¢«é˜»å¡ï¼Œå†™é”é‡Šæ”¾ä¹‹åï¼Œæ‰€æœ‰æ“ä½œç»§ç»­æ‰§è¡Œï¼Œç¼–ç¨‹æ–¹å¼ç›¸å¯¹äºä½¿ç”¨ç­‰å¾…é€šçŸ¥æœºåˆ¶çš„å®ç°æ–¹å¼è€Œè¨€ï¼Œå˜å¾—ç®€å•æ˜äº†ã€‚ </p>
<p>ReentrantReadWriteLockå®ç°äº†ReadAndWriteLockæ¥å£ï¼ŒReadAndWriteLockæ¥å£æä¾›äº†readLock()æ–¹æ³•è·å–è¯»é”ï¼ŒwriteLock()æ–¹æ³•è·å–å†™é”ï¼Œè¯»é”å’Œå†™é”çš„ä½¿ç”¨æ–¹å¼ä¸Lockæ ‡å‡†ç”¨æ³•ç›¸åŒã€‚</p>
<p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè¯»å†™é”çš„æ€§èƒ½éƒ½ä¼šæ¯”æ’å®ƒé”å¥½ï¼Œå› ä¸ºå¤§å¤šæ•°åœºæ™¯è¯»æ˜¯å¤šäºå†™çš„ï¼Œè¯»å†™çš„æ¯”ä¾‹çº¦ä¸º10:1ã€‚åœ¨è¯»å¤šäºå†™çš„æƒ…å†µä¸‹ï¼Œè¯»å†™é”èƒ½å¤Ÿæä¾›æ¯”æ’å®ƒé”æ›´å¥½çš„å¹¶å‘æ€§å’Œååé‡ã€‚</p>
<h5 id="è¯»å†™çŠ¶æ€çš„è®¾è®¡"><a href="#è¯»å†™çŠ¶æ€çš„è®¾è®¡" class="headerlink" title="è¯»å†™çŠ¶æ€çš„è®¾è®¡"></a>è¯»å†™çŠ¶æ€çš„è®¾è®¡</h5><p>è¯»å†™é”åŒæ ·ä¾èµ–è‡ªå®šä¹‰åŒæ­¥å™¨æ¥å®ç°åŒæ­¥åŠŸèƒ½ï¼Œè€Œè¯»å†™çŠ¶æ€å°±æ˜¯å…¶åŒæ­¥å™¨çš„åŒæ­¥çŠ¶æ€ã€‚</p>
<p>å›æƒ³ReentrantLockä¸­è‡ªå®šä¹‰åŒæ­¥å™¨çš„å®ç°ï¼ŒåŒæ­¥çŠ¶æ€è¡¨ç¤ºé”è¢«ä¸€ä¸ªçº¿ç¨‹é‡å¤è·å–çš„æ¬¡æ•°ï¼Œè€Œè¯»å†™é”çš„è‡ªå®šä¹‰åŒæ­¥å™¨éœ€è¦åœ¨åŒæ­¥çŠ¶æ€ï¼ˆä¸€ä¸ªæ•´å‹å˜é‡ï¼‰ä¸Šç»´æŠ¤å¤šä¸ªè¯»çº¿ç¨‹å’Œä¸€ä¸ªå†™çº¿ç¨‹çš„çŠ¶æ€ï¼Œä½¿å¾—è¯¥çŠ¶æ€çš„è®¾è®¡æˆä¸ºè¯»å†™é”å®ç°çš„å…³é”®ã€‚</p>
<p>å¦‚æœåœ¨ä¸€ä¸ªæ•´å‹å˜é‡ä¸Šç»´æŠ¤å¤šç§çŠ¶æ€ï¼Œå°±ä¸€å®šéœ€è¦æŒ‰ä½åˆ‡å‰²ä½¿ç”¨è¿™ä¸ªå˜é‡ï¼Œè¯»å†™é”å°†å˜é‡åˆ‡åˆ†æˆäº†ä¸¤ä¸ªéƒ¨åˆ†ï¼Œé«˜16ä½è¡¨ç¤ºè¯»ï¼Œä½16ä½è¡¨ç¤ºå†™ï¼Œè¯»å†™é”é€šè¿‡ä½è¿ç®—æ¥ç»´æŠ¤å„è‡ªçš„è¿ç®—ã€‚å‡è®¾å½“å‰åŒæ­¥çŠ¶æ€å€¼ä¸ºSï¼Œå†™çŠ¶æ€ç­‰äºS&amp;0x0000FFFFï¼ˆå°†é«˜16ä½å…¨éƒ¨æŠ¹å»ï¼‰ï¼Œè¯»çŠ¶æ€ç­‰äºS&gt;&gt;&gt;16ï¼ˆæ— ç¬¦å·è¡¥0å³ç§»16ä½ï¼‰ã€‚å½“å†™çŠ¶æ€å¢åŠ 1æ—¶ï¼Œç­‰äºS+1ï¼Œå½“è¯»çŠ¶æ€å¢åŠ 1æ—¶ï¼Œç­‰äºS+(1&lt;&lt;16)ï¼Œä¹Ÿå°±æ˜¯S+0x00010000ã€‚æ ¹æ®çŠ¶æ€çš„åˆ’åˆ†èƒ½å¾—å‡ºä¸€ä¸ªæ¨è®ºï¼šSä¸ç­‰äº0æ—¶ï¼Œå½“å†™çŠ¶æ€ï¼ˆS&amp;0x0000FFFFï¼‰ç­‰äº0æ—¶ï¼Œåˆ™è¯»çŠ¶æ€ï¼ˆS&gt;&gt;&gt;16ï¼‰å¤§äº0ï¼Œå³è¯»é”å·²è¢«è·å–ã€‚</p>
<h5 id="å†™é”çš„è·å–ä¸é‡Šæ”¾"><a href="#å†™é”çš„è·å–ä¸é‡Šæ”¾" class="headerlink" title="å†™é”çš„è·å–ä¸é‡Šæ”¾"></a>å†™é”çš„è·å–ä¸é‡Šæ”¾</h5><p>å†™é”æ˜¯ä¸€ä¸ªæ”¯æŒé‡è¿›å…¥çš„æ’å®ƒé”ã€‚å¦‚æœå½“å‰çº¿ç¨‹å·²ç»è·å–äº†å†™é”ï¼Œåˆ™å¢åŠ å†™çŠ¶æ€ã€‚è¯»å†™é”åœ¨å†…éƒ¨æœ‰ä¸€ä¸ªThreadLocalè®°å½•å†™çŠ¶æ€ã€‚å¦‚æœå½“å‰çº¿ç¨‹åœ¨è·å–å†™é”æ—¶ï¼Œè¯»é”å·²ç»è¢«è·å–ï¼ˆè¯»çŠ¶æ€ä¸ä¸º0ï¼‰æˆ–è€…è¯¥çº¿ç¨‹ä¸æ˜¯å·²ç»è·å–å†™é”çš„çº¿ç¨‹ï¼Œåˆ™å½“å‰çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚</p>
<p>è¯¥æ–¹æ³•é™¤äº†é‡å…¥æ¡ä»¶ï¼ˆå½“å‰çº¿ç¨‹ä¸ºè·å–äº†å†™é”çš„çº¿ç¨‹ï¼‰ä¹‹å¤–ï¼Œå¢åŠ äº†ä¸€ä¸ªè¯»é”æ˜¯å¦å­˜åœ¨çš„åˆ¤æ–­ã€‚å¦‚æœå­˜åœ¨è¯»é”ï¼Œåˆ™å†™é”ä¸èƒ½è¢«è·å–ï¼ŒåŸå› åœ¨äºï¼šè¯»å†™é”è¦ç¡®ä¿å†™é”çš„æ“ä½œå¯¹è¯»é”å¯è§ï¼Œå¦‚æœå…è®¸è¯»é”åœ¨å·²è¢«è·å–çš„æƒ…å†µä¸‹å¯¹å†™é”çš„è·å–ï¼Œé‚£ä¹ˆæ­£åœ¨è¿è¡Œçš„å…¶ä»–è¯»çº¿ç¨‹å°±æ— æ³•æ„ŸçŸ¥åˆ°å½“å‰å†™çº¿ç¨‹çš„æ“ä½œã€‚å› æ­¤ï¼Œåªæœ‰ç­‰å¾…å…¶ä»–è¯»çº¿ç¨‹éƒ½é‡Šæ”¾äº†è¯»é”ï¼Œå†™é”æ‰èƒ½è¢«å½“å‰çº¿ç¨‹è·å–ï¼Œè€Œå†™é”ä¸€æ—¦è¢«è·å–ï¼Œåˆ™å…¶ä»–è¯»å†™çº¿ç¨‹çš„åç»­è®¿é—®å‡è¢«é˜»å¡ã€‚</p>
<p>å†™é”çš„é‡Šæ”¾ä¸ReentrantLockçš„é‡Šæ”¾è¿‡ç¨‹åŸºæœ¬ç±»ä¼¼ï¼Œæ¯æ¬¡é‡Šæ”¾å‡å‡å°‘å†™çŠ¶æ€ï¼Œå½“å†™çŠ¶æ€ä¸º0æ—¶è¡¨ç¤ºå†™é”å·²è¢«é‡Šæ”¾ï¼Œä»è€Œç­‰å¾…çš„è¯»å†™çº¿ç¨‹èƒ½å¤Ÿç»§ç»­è®¿é—®è¯»å†™é”ï¼ŒåŒæ—¶å‰æ¬¡å†™çº¿ç¨‹çš„ä¿®æ”¹å¯¹åç»­è¯»å†™çº¿ç¨‹å¯è§ã€‚</p>
<h5 id="è¯»é”çš„è·å–ä¸é‡Šæ”¾"><a href="#è¯»é”çš„è·å–ä¸é‡Šæ”¾" class="headerlink" title="è¯»é”çš„è·å–ä¸é‡Šæ”¾"></a>è¯»é”çš„è·å–ä¸é‡Šæ”¾</h5><p>è¯»é”æ˜¯ä¸€ä¸ªæ”¯æŒé‡è¿›å…¥çš„å…±äº«é”ï¼Œå®ƒèƒ½å¤Ÿè¢«å¤šä¸ªçº¿ç¨‹åŒæ—¶è·å–ï¼Œåœ¨æ²¡æœ‰å…¶ä»–å†™çº¿ç¨‹è®¿é—®ï¼ˆæˆ–è€…å†™çŠ¶æ€ä¸º0ï¼‰æ—¶ï¼Œè¯»é”æ€»ä¼šè¢«æˆåŠŸåœ°è·å–ï¼Œè€Œæ‰€åšçš„ä¹Ÿåªæ˜¯ï¼ˆçº¿ç¨‹å®‰å…¨çš„ï¼‰å¢åŠ è¯»çŠ¶æ€ã€‚å¦‚æœå½“å‰çº¿ç¨‹å·²ç»è·å–äº†è¯»é”ï¼Œåˆ™å¢åŠ è¯»çŠ¶æ€ã€‚</p>
<p>å¦‚æœå½“å‰çº¿ç¨‹åœ¨è·å–è¯»é”æ—¶ï¼Œå†™é”å·²è¢«å…¶ä»–çº¿ç¨‹è·å–ï¼Œåˆ™è¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚è¯»çŠ¶æ€æ˜¯æ‰€æœ‰çº¿ç¨‹è·å–è¯»é”æ¬¡æ•°çš„æ€»å’Œï¼Œè€Œæ¯ä¸ªçº¿ç¨‹å„è‡ªè·å–è¯»é”çš„æ¬¡æ•°åªèƒ½é€‰æ‹©ä¿å­˜åœ¨ThreadLocalä¸­ï¼Œç”±çº¿ç¨‹è‡ªèº«ç»´æŠ¤ã€‚åœ¨tryAcquireShared(int unused)æ–¹æ³•ä¸­ï¼Œå¦‚æœå…¶ä»–çº¿ç¨‹å·²ç»è·å–äº†å†™é”ï¼Œåˆ™å½“å‰çº¿ç¨‹è·å–è¯»é”å¤±è´¥ï¼Œè¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚å¦‚æœå½“å‰çº¿ç¨‹è·å–äº†å†™é”æˆ–è€…å†™é”æœªè¢«è·å–ï¼Œåˆ™å½“å‰çº¿ç¨‹ï¼ˆçº¿ç¨‹å®‰å…¨ï¼Œä¾é CASä¿è¯ï¼‰å¢åŠ è¯»çŠ¶æ€ï¼ŒæˆåŠŸè·å–è¯»é”ã€‚è¯»é”çš„æ¯æ¬¡é‡Šæ”¾ï¼ˆçº¿ç¨‹å®‰å…¨çš„ï¼Œå¯èƒ½æœ‰å¤šä¸ªè¯»çº¿ç¨‹åŒæ—¶é‡Šæ”¾è¯»é”ï¼‰å‡å‡å°‘è¯»çŠ¶æ€ã€‚</p>
<h5 id="é”çš„å‡é™çº§"><a href="#é”çš„å‡é™çº§" class="headerlink" title="é”çš„å‡é™çº§"></a>é”çš„å‡é™çº§</h5><p>é”é™çº§æŒ‡çš„æ˜¯å†™é”é™çº§æˆä¸ºè¯»é”ã€‚å¦‚æœå½“å‰çº¿ç¨‹æ‹¥æœ‰å†™é”ï¼Œç„¶åå°†å…¶é‡Šæ”¾ï¼Œæœ€åå†è·å–è¯»é”ï¼Œè¿™ç§åˆ†æ®µå®Œæˆçš„è¿‡ç¨‹ä¸èƒ½ç§°ä¹‹ä¸ºé”é™çº§ã€‚</p>
<p>é”é™çº§æ˜¯æŒ‡æŠŠæŒä½ï¼ˆå½“å‰æ‹¥æœ‰çš„ï¼‰å†™é”ï¼Œå†è·å–åˆ°è¯»é”ï¼Œéšåé‡Šæ”¾ï¼ˆå…ˆå‰æ‹¥æœ‰çš„ï¼‰å†™é”çš„è¿‡ç¨‹ã€‚</p>
<p>RentrantReadWriteLockä¸æ”¯æŒé”å‡çº§ï¼ˆæŠŠæŒè¯»é”ã€è·å–å†™é”ï¼Œæœ€åé‡Šæ”¾è¯»é”çš„è¿‡ç¨‹ï¼‰ã€‚ç›®çš„æ˜¯ä¿è¯æ•°æ®å¯è§æ€§ï¼Œå¦‚æœè¯»é”å·²è¢«å¤šä¸ªçº¿ç¨‹è·å–ï¼Œå…¶ä¸­ä»»æ„çº¿ç¨‹æˆåŠŸè·å–äº†å†™é”å¹¶æ›´æ–°äº†æ•°æ®ï¼Œåˆ™å…¶æ›´æ–°å¯¹å…¶ä»–è·å–åˆ°è¯»é”çš„çº¿ç¨‹æ˜¯ä¸å¯è§çš„ã€‚</p>
<h3 id="LockSupportå·¥å…·"><a href="#LockSupportå·¥å…·" class="headerlink" title="LockSupportå·¥å…·"></a>LockSupportå·¥å…·</h3><p>LockSupportå®šä¹‰äº†ä¸€ç»„çš„å…¬å…±é™æ€æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•æä¾›äº†æœ€åŸºæœ¬çš„çº¿ç¨‹é˜»å¡å’Œå”¤é†’åŠŸèƒ½ï¼Œè€ŒLockSupportä¹Ÿæˆä¸ºæ„å»ºåŒæ­¥ç»„ä»¶çš„åŸºç¡€å·¥å…·ã€‚</p>
<p>LockSupportå®šä¹‰äº†ä¸€ç»„ä»¥parkå¼€å¤´çš„æ–¹æ³•ç”¨æ¥é˜»å¡å½“å‰çº¿ç¨‹ï¼Œä»¥åŠunpark(Thread thread)æ–¹æ³•æ¥å”¤é†’ä¸€ä¸ªè¢«é˜»å¡çš„çº¿ç¨‹ã€‚åœ¨JDK1.6ä¹‹åLockSupportå¢åŠ äº†park(Object blocker)ã€parkNanos(Object blocker,long nanos)å’ŒparkUntil(Object blocker,long deadline)3ä¸ªæ–¹æ³•ï¼Œä¾¿äºé—®é¢˜æ’æŸ¥å’Œç³»ç»Ÿç›‘æ§ï¼Œå…¶ä¸­å‚æ•°blockeræ˜¯ç”¨æ¥æ ‡è¯†å½“å‰çº¿ç¨‹åœ¨ç­‰å¾…çš„å¯¹è±¡å³è¢«é˜»å¡å¯¹è±¡ã€‚</p>
<h3 id="CLHé˜Ÿåˆ—é”"><a href="#CLHé˜Ÿåˆ—é”" class="headerlink" title="CLHé˜Ÿåˆ—é”"></a>CLHé˜Ÿåˆ—é”</h3><p>CLHé˜Ÿåˆ—é”å³Craig, Landin, and Hagersten (CLH) locksã€‚</p>
<p>CLHé˜Ÿåˆ—é”æ˜¯ä¸€ç§åŸºäºé“¾è¡¨çš„å¯æ‰©å±•ã€é«˜æ€§èƒ½ã€å…¬å¹³çš„è‡ªæ—‹é”ï¼Œç”³è¯·çº¿ç¨‹ä»…ä»…åœ¨æœ¬åœ°å˜é‡ä¸Šè‡ªæ—‹ï¼Œå®ƒä¸æ–­è‡ªæ—‹åˆ¤æ–­å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œå‡è®¾å‘ç°å‰é©±èŠ‚ç‚¹é‡Šæ”¾äº†é”å°±ç»“æŸè‡ªæ—‹ã€‚</p>
<p>å½“ä¸€ä¸ªçº¿ç¨‹éœ€è¦è·å–é”æ—¶ä¼šåˆ›å»ºä¸€ä¸ªçš„QNodeï¼Œå°†å…¶ä¸­çš„lockedè®¾ç½®ä¸ºtrueè¡¨ç¤ºéœ€è¦è·å–é”ï¼ŒmyPredè¡¨ç¤ºå¯¹å…¶å‰é©±èŠ‚ç‚¹çš„å¼•ç”¨</p>
<img src="/blog/2020/07/30/JUC-AQS%E8%AF%A6%E8%A7%A3/pic1.png" srcset="/blog/img/loading.gif" class>

<p>çº¿ç¨‹Aå¯¹tailåŸŸè°ƒç”¨getAndSetæ–¹æ³•ï¼Œä½¿è‡ªå·±æˆä¸ºé˜Ÿåˆ—çš„å°¾éƒ¨ï¼ŒåŒæ—¶è·å–ä¸€ä¸ªæŒ‡å‘å…¶å‰é©±ç»“ç‚¹çš„å¼•ç”¨myPred</p>
<img src="/blog/2020/07/30/JUC-AQS%E8%AF%A6%E8%A7%A3/pic2.png" srcset="/blog/img/loading.gif" class>

<p>çº¿ç¨‹Béœ€è¦è·å¾—é”ï¼ŒåŒæ ·çš„æµç¨‹å†æ¥ä¸€é</p>
<img src="/blog/2020/07/30/JUC-AQS%E8%AF%A6%E8%A7%A3/pic3.png" srcset="/blog/img/loading.gif" class>

<p>çº¿ç¨‹å°±åœ¨å‰é©±ç»“ç‚¹çš„lockedå­—æ®µä¸Šè‡ªæ—‹ï¼Œç›´åˆ°å‰é©±ç»“ç‚¹é‡Šæ”¾é”(å‰é©±èŠ‚ç‚¹çš„é”å€¼ locked == false)</p>
<p>å½“ä¸€ä¸ªçº¿ç¨‹éœ€è¦é‡Šæ”¾é”æ—¶ï¼Œå°†å½“å‰ç»“ç‚¹çš„lockedåŸŸè®¾ç½®ä¸ºfalseï¼ŒåŒæ—¶å›æ”¶å‰é©±ç»“ç‚¹</p>
<img src="/blog/2020/07/30/JUC-AQS%E8%AF%A6%E8%A7%A3/pic4.png" srcset="/blog/img/loading.gif" class>

<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå‰é©±ç»“ç‚¹é‡Šæ”¾é”ï¼Œçº¿ç¨‹Açš„myPredæ‰€æŒ‡å‘çš„å‰é©±ç»“ç‚¹çš„lockedå­—æ®µå˜ä¸ºfalseï¼Œçº¿ç¨‹Aå°±å¯ä»¥è·å–åˆ°é”ã€‚</p>
<p>CLHé˜Ÿåˆ—é”çš„ä¼˜ç‚¹æ˜¯ç©ºé—´å¤æ‚åº¦ä½ï¼ˆå¦‚æœæœ‰nä¸ªçº¿ç¨‹ï¼ŒLä¸ªé”ï¼Œæ¯ä¸ªçº¿ç¨‹æ¯æ¬¡åªè·å–ä¸€ä¸ªé”ï¼Œé‚£ä¹ˆéœ€è¦çš„å­˜å‚¨ç©ºé—´æ˜¯Oï¼ˆL+nï¼‰ï¼Œnä¸ªçº¿ç¨‹æœ‰nä¸ªmyNodeï¼ŒLä¸ªé”æœ‰Lä¸ªtailï¼‰ã€‚CLHé˜Ÿåˆ—é”å¸¸ç”¨åœ¨SMPä½“ç³»ç»“æ„ä¸‹ã€‚</p>
<p>Javaä¸­çš„AQSæ˜¯CLHé˜Ÿåˆ—é”çš„ä¸€ç§å˜ä½“å®ç°ã€‚</p>
<p><strong>æ‰©å±•çŸ¥è¯†ç‚¹</strong></p>
<p>SMPï¼ˆSymmetric Multi-Processorï¼‰å¯¹ç§°å¤šå¤„ç†å™¨ç»“æ„ï¼ŒæŒ‡serverä¸­å¤šä¸ªCPUå¯¹ç§°å·¥ä½œï¼Œæ¯ä¸€ä¸ªCPUè®¿é—®å†…å­˜åœ°å€æ‰€éœ€æ—¶é—´åŒæ ·ã€‚å…¶ä¸»è¦ç‰¹å¾æ˜¯å…±äº«ï¼ŒåŒ…æ‹¬å¯¹CPUï¼Œå†…å­˜ï¼ŒI/Oç­‰è¿›è¡Œå…±äº«ã€‚SMPçš„é•¿å¤„æ˜¯å¯ä»¥ä¿è¯å†…å­˜ä¸€è‡´æ€§ã€‚ç¼ºç‚¹æ˜¯è¿™äº›å…±äº«çš„èµ„æºéå¸¸å¯èƒ½æˆä¸ºæ€§èƒ½ç“¶é¢ˆã€‚éšç€CPUæ•°é‡çš„æ·»åŠ ï¼Œæ¯ä¸€ä¸ªCPUéƒ½è¦è®¿é—®åŒæ ·çš„å†…å­˜èµ„æºï¼Œå¯èƒ½å¯¼è‡´å†…å­˜è®¿é—®å†²çªï¼Œå¯èƒ½ä¼šå¯¼è‡´CPUèµ„æºçš„æµªè´¹ã€‚ç»å¸¸ä½¿ç”¨çš„PCæœºå°±å±äºè¿™æ ·çš„ã€‚</p>
<img src="/blog/2020/07/30/JUC-AQS%E8%AF%A6%E8%A7%A3/pic5.png" srcset="/blog/img/loading.gif" class>

<p>NUMAï¼ˆNon Uniform Memory Access Architectureï¼‰éä¸€è‡´å­˜å‚¨è®¿é—®ï¼Œå°†CPUåˆ†ä¸ºCPUæ¨¡å—ï¼Œæ¯ä¸ªCPUæ¨¡å—ç”±å¤šä¸ª<em>CPU</em>ç»„æˆï¼Œå¹¶ä¸”å…·æœ‰ç‹¬ç«‹çš„æœ¬åœ°å†…å­˜ã€I/Oæ§½å£ç­‰ï¼Œæ¨¡å—ä¹‹é—´å¯ä»¥é€šè¿‡äº’è”æ¨¡å—ç›¸äº’è®¿é—®ï¼Œè®¿é—®æœ¬åœ°å†…å­˜ï¼ˆæœ¬CPUæ¨¡å—çš„å†…å­˜ï¼‰çš„é€Ÿåº¦å°†è¿œè¿œé«˜äºè®¿é—®è¿œåœ°å†…å­˜*(<em>å…¶ä»–CPUæ¨¡å—çš„å†…å­˜</em>)*çš„é€Ÿåº¦ï¼Œè¿™ä¹Ÿæ˜¯éä¸€è‡´å­˜å‚¨è®¿é—®çš„ç”±æ¥ã€‚NUMAè¾ƒå¥½åœ°è§£å†³SMPçš„æ‰©å±•é—®é¢˜ï¼Œå½“CPUæ•°é‡å¢åŠ æ—¶ï¼Œå› ä¸ºè®¿é—®è¿œåœ°å†…å­˜çš„å»¶æ—¶è¿œè¿œè¶…è¿‡æœ¬åœ°å†…å­˜ï¼Œç³»ç»Ÿæ€§èƒ½æ— æ³•çº¿æ€§å¢åŠ ã€‚</p>
<img src="/blog/2020/07/30/JUC-AQS%E8%AF%A6%E8%A7%A3/pic6.png" srcset="/blog/img/loading.gif" class>

<p>CLHå”¯ä¸€çš„ç¼ºç‚¹æ˜¯åœ¨NUMAç³»ç»Ÿç»“æ„ä¸‹æ€§èƒ½å¾ˆå·®ï¼Œä½†æ˜¯åœ¨SMPç³»ç»Ÿç»“æ„ä¸‹è¯¥æ³•è¿˜æ˜¯éå¸¸æœ‰æ•ˆçš„ã€‚è§£å†³NUMAç³»ç»Ÿç»“æ„çš„æ€è·¯æ˜¯MCSé˜Ÿåˆ—é”ã€‚</p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/blog/categories/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/">å¹¶å‘ç¼–ç¨‹</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/blog/tags/AQS/">AQS</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 åè®®</a> ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</p>
              
              
                <div class="post-prevnext row">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/blog/2020/07/30/JUC-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E6%A1%86%E6%9E%B6/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">è‡ªå®šä¹‰å¹¶å‘ä»»åŠ¡æ‰§è¡Œæ¡†æ¶</span>
                        <span class="visible-mobile">ä¸Šä¸€ç¯‡</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/blog/2020/07/28/JUC-%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8/">
                        <span class="hidden-mobile">å¹¶å‘å®¹å™¨</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.staticfile.org/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":200})
    NProgress.start()
    document.addEventListener('DOMContentLoaded', function() {
      window.NProgress && window.NProgress.inc();
    })
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.staticfile.org/jquery/3.5.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.5.3/js/bootstrap.min.js" ></script>
<script  src="/blog/js/debouncer.js" ></script>
<script  src="/blog/js/events.js" ></script>
<script  src="/blog/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/blog/js/lazyload.js" ></script>
  



  



  <script  src="https://cdn.staticfile.org/tocbot/4.12.0/tocbot.min.js" ></script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>





  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/blog/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/blog/local-search.xml";
      var inputArea = document.querySelector("#local-search-input");
      inputArea.onclick = function () {
        searchFunc(path, 'local-search-input', 'local-search-result');
        this.onclick = null
      }
    })()
  </script>















<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ ä¿æŒåœ¨æœ€åº•éƒ¨ -->
<script  src="/blog/js/boot.js" ></script>



</body>
</html>
