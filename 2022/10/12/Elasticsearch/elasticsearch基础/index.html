

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/blog/img/favicon.png">
  <link rel="icon" href="/blog/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="">
  <meta name="keywords" content="">
  
  <title>Elasticsearch基础 - 萤火的博客</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.5.3/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/blog/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.1.2/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/blog/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"zhaoguocheng.gitee.io","root":"/blog/","version":"1.8.11","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":200}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/blog/js/utils.js" ></script>
  <script  src="/blog/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.2.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/blog/">&nbsp;<strong>萤火的博客</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/">
                <i class="iconfont icon-home-fill"></i>
                主页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/blog/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="Elasticsearch基础">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2022-10-12 10:42" pubdate>
        2022年10月12日 上午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      52.2k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      796
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Elasticsearch基础</h1>
            
            <div class="markdown-body">
              <h3 id="Elasticsearch介绍"><a href="#Elasticsearch介绍" class="headerlink" title="Elasticsearch介绍"></a>Elasticsearch介绍</h3><h4 id="lucene和elasticsearch的关系"><a href="#lucene和elasticsearch的关系" class="headerlink" title="lucene和elasticsearch的关系"></a>lucene和elasticsearch的关系</h4><p>lucene是最先进的而且功能最强大的搜索库，lucence是以jar包的形式，提供封装好的各种建立倒排索引和进行搜索的代码，包括各种算法。开发时可以基于jar包中的api进行开发，lucene会在本地磁盘上面，给我们组织索引的数据结构。但是需要深入理解各种索引结构的原理，开发起来非常复杂。</p>
<p><img src="/blog/2022/10/12/Elasticsearch/elasticsearch%E5%9F%BA%E7%A1%80/%E4%BB%80%E4%B9%88%E6%98%AFElasticsearch.png" srcset="/blog/img/loading.gif" lazyload alt="什么是Elasticsearch"></p>
<p>elasticsearch是基于lucene的分布式文档存储引擎，同时提供数据搜索和聚合分析功能，可以支持PB级别的数据。同时隐藏Lucene开发的复杂性，提供简单易用的restful api接口、java api接口以及还有其他语言的api接口。</p>
<h4 id="逻辑结构"><a href="#逻辑结构" class="headerlink" title="逻辑结构"></a>逻辑结构</h4><p>es中的数据逻辑结构为index-&gt;type-&gt;document</p>
<h5 id="index"><a href="#index" class="headerlink" title="index"></a>index</h5><p>尽量使类似的数据放在一个index，非类似的数据放在不同document。类似是指这些document的fields很大一部分是相同的，如果大部分的field都不相同，就不要放在一个index中。index名称必须是小写的，不能用下划线开头，不能包含逗号。</p>
<p><img src="/blog/2022/10/12/Elasticsearch/elasticsearch%E5%9F%BA%E7%A1%80/index%E5%A6%82%E4%BD%95%E5%88%9B%E5%BB%BA%E7%9A%84%E5%8F%8D%E4%BE%8B%E5%88%86%E6%9E%90.png" srcset="/blog/img/loading.gif" lazyload alt="index如何创建的反例分析"></p>
<h5 id="type"><a href="#type" class="headerlink" title="type"></a>type</h5><p>一个index通常会划分为多个type，逻辑上对index中类似但不完全相同的几类数据再次进行分类。比如说，商品，可能划分为电子商品，生鲜商品，日化商品等等。这些数据虽然都属于商品，但还是有几个field有些许差别。type名称可以是大写或者小写，但是同时不能用下划线开头，不能包含逗号。</p>
<h5 id="document"><a href="#document" class="headerlink" title="document"></a>document</h5><p>es中的最小数据单元，一个document可以是一条客户数据，一条商品分类数据，一条订单数据，通常用JSON数据结构表示。实例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;product_id&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>,<br>  <span class="hljs-attr">&quot;product_name&quot;</span>: <span class="hljs-string">&quot;高露洁牙膏&quot;</span>,<br>  <span class="hljs-attr">&quot;product_desc&quot;</span>: <span class="hljs-string">&quot;高效美白&quot;</span>,<br>  <span class="hljs-attr">&quot;category_id&quot;</span>: <span class="hljs-string">&quot;2&quot;</span>,<br>  <span class="hljs-attr">&quot;category_name&quot;</span>: <span class="hljs-string">&quot;日化用品&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h4><ul>
<li>Near Realtime（NRT）：近实时，两个意思，从写入数据到数据可以被搜索到有一个小延迟（大概1秒）；基于es执行搜索和分析可以达到秒级</li>
<li>Cluster：集群，包含多个节点，每个节点属于哪个集群是通过一个配置（集群名称，默认是elasticsearch）来决定的，对于中小型应用来说，刚开始一个集群就一个节点很正常</li>
<li>Node：节点，集群中的一个节点，节点也有一个名称（默认是随机分配的），节点名称很重要（在执行运维管理操作的时候），默认节点会去加入一个名称为“elasticsearch”的集群，如果直接启动一堆节点，那么它们会自动组成一个elasticsearch集群，当然一个节点也可以组成一个elasticsearch集群</li>
<li>Document&amp;field：文档，es中的最小数据单元，一个document可以是一条客户数据，一条商品分类数据，一条订单数据，通常用JSON数据结构表示，每个index下的type中，都可以去存储多个document。一个document里面有多个field，每个field就是一个数据字段。</li>
<li>Index：索引，包含一堆有相似结构的文档数据，比如可以有一个客户索引，商品分类索引，订单索引，索引有一个名称。一个index包含很多document，一个index就代表了一类类似的或者相同的document。比如说建立一个product index，商品索引，里面可能就存放了所有的商品数据，所有的商品document。</li>
<li>Type：类型，每个索引里都可以有一个或多个type，type是index中的一个逻辑数据分类，一个type下的document，都有相同的field，比如博客系统，有一个索引，可以定义用户数据type，博客数据type，评论数据type。</li>
<li>shard：单台机器无法存储大量数据，es可以将一个索引中的数据切分为多个shard，分布在多台服务器上存储。有了shard就可以横向扩展，存储更多数据，让搜索和分析等操作分布到多台服务器上去执行，提升吞吐量和性能。每个shard都是一个lucene index。</li>
<li>replica：任何一个服务器随时可能故障或宕机，此时shard可能就会丢失，因此可以为每个shard创建多个replica副本。replica可以在shard故障时提供备用服务，保证数据不丢失，多个replica还可以提升搜索操作的吞吐量和性能。primary shard（建立索引时一次设置，不能修改，默认5个），replica shard（随时修改数量，默认1个），默认每个索引10个shard，5个primary shard，5个replica shard，最小的高可用配置，是2台服务器。</li>
</ul>
<p><img src="/blog/2022/10/12/Elasticsearch/elasticsearch%E5%9F%BA%E7%A1%80/shard%E5%92%8Creplica%E7%9A%84%E8%A7%A3%E9%87%8A.png" srcset="/blog/img/loading.gif" lazyload></p>
<h4 id="分布式架构"><a href="#分布式架构" class="headerlink" title="分布式架构"></a>分布式架构</h4><p>es采用节点平等的分布式架构，每个节点都能接收所有的请求，然后自动进行请求路由，收集响应后返回。</p>
<p><img src="/blog/2022/10/12/Elasticsearch/elasticsearch%E5%9F%BA%E7%A1%80/ES%E7%9A%84%E5%9F%BA%E7%A1%80%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84.png" srcset="/blog/img/loading.gif" lazyload alt="ES的基础分布式架构"></p>
<h5 id="集群状态"><a href="#集群状态" class="headerlink" title="集群状态"></a>集群状态</h5><ul>
<li>green：每个索引的primary shard和replica shard都是active状态的</li>
<li>yellow：每个索引的primary shard都是active状态的，但是部分replica shard不是active状态，处于不可用的状态</li>
<li>red：不是所有索引的primary shard都是active状态的，部分索引有数据丢失了</li>
</ul>
<h5 id="shard-amp-replica机制"><a href="#shard-amp-replica机制" class="headerlink" title="shard&amp;replica机制"></a>shard&amp;replica机制</h5><ol>
<li>index包含多个shard</li>
<li>每个shard都是一个最小工作单元，承载部分数据，包含一个lucene实例，具有完整的建立索引和处理请求的能力</li>
<li>增减节点时，shard会自动在nodes中负载均衡</li>
<li>primary shard和replica shard，每个document只存在于某一个primary shard以及其对应的replica shard中，不可能存在于多个primary shard</li>
<li>replica shard是primary shard的副本，负责容错，以及承担读请求负载</li>
<li>primary shard的数量在创建索引的时候就固定了，replica shard的数量可以随时修改</li>
<li>primary shard的默认数量是5，replica默认是1，默认有10个shard，5个primary shard，5个replica shard</li>
<li>primary shard不能和自己的replica shard放在同一个节点上（否则节点宕机，primary shard和副本都丢失，起不到容错的作用），但是可以和其他primary shard的replica shard放在同一个节点上</li>
</ol>
<h5 id="扩容分析"><a href="#扩容分析" class="headerlink" title="扩容分析"></a>扩容分析</h5><ol>
<li>扩容的意义：每个node的shard数量越少，IO/CPU/Memory资源给每个shard分配更多，每个shard性能就会更好。</li>
<li>扩容极限：6个shard（3 primary，3 replica），最多扩容到6台机器，每个shard可以占用单台服务器的所有资源，这时性能最好。</li>
<li>超出扩容极限：虽然primary的数量不能修改，但是可以动态修改replica数量，9个shard（3primary，6 replica）可以扩容到9台机器，比3台机器时，拥有3倍的读性能。</li>
<li>容错分析：在3台机器下，9个shard（3 primary，6 replica）虽然性能有所下降，但容错性更好，最多可以容纳2台机器宕机，6个shard只能容纳1台机器宕机。</li>
</ol>
<h5 id="容错机制"><a href="#容错机制" class="headerlink" title="容错机制"></a>容错机制</h5><p>比如现在有3个node，9个shard，当master node 宕机后，集群会依次进行master选举，replica容错以及数据恢复。过程为：</p>
<ol>
<li>master node宕机后会自动进行master选举，此时集群状态为red</li>
<li>master选举完成后，新master将缺失的primary shard的replica提升为primary，此时仍有部分shard的replica数量不足，集群状态为yellow</li>
<li>宕机的node重新上线后，master会在该node重建replica，并同步宕机后的修改，此时集群状态为green</li>
</ol>
<h4 id="元数据"><a href="#元数据" class="headerlink" title="元数据"></a>元数据</h4><p>document中的元数据为：_index、_type、_id</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;test_index&quot;</span>,<br>  <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;test_type&quot;</span>,<br>  <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>,<br>  <span class="hljs-attr">&quot;_version&quot;</span>: <span class="hljs-number">1</span>,<br>  <span class="hljs-attr">&quot;found&quot;</span>: <span class="hljs-literal">true</span>,<br>  <span class="hljs-attr">&quot;_source&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;test_content&quot;</span>: <span class="hljs-string">&quot;test test&quot;</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li><p>_index：代表一个document存放在哪个index中。类似的数据放在一个索引，非类似的数据放不同索引。其实就是index中document的很大一部分fields是相同的。比如product index包含了所有的商品，sales index包含了所有的商品销售数据，inventory index包含了所有库存相关的数据。如果把product，sales，employee，全都放在一个大的index里面比如company index，显然时不合适的。</p>
</li>
<li><p>_type元数据：代表document属于index中的哪个类别。一个索引通常会划分为多个type，逻辑上对index中有些许不同的几类数据进行分类。可能有很多相同的fields，但是还是可能会有一些轻微的不同，比如商品，可能划分为电子商品，生鲜商品，日化商品等</p>
</li>
<li><p>_id元数据：代表document的唯一标识，与index和type一起，可以唯一标识和定位一个document。</p>
<p>创建对象时我们可以手动指定document的id（put /index/type/id），也可以不指定，由es自动为我们创建一个id。</p>
<p>如果导入一些已经有标识数据到es时，会采取这种方式，比如导入数据库中的数据，这时就可以用primary key作为document的id。如果是处理之后的数据，没有id，就不太设置手动指定document id。</p>
<p>自动生成的id，长度为20个字而且使用base64，URL安全，base64编码，GUID，分布式系统并行生成时不可能会发生冲突</p>
</li>
<li><p>_source元数据：创建document时指定的request body中的json串，默认情况下，在get的时候会原封不动返回。</p>
</li>
</ul>
<h4 id="并发冲突"><a href="#并发冲突" class="headerlink" title="并发冲突"></a>并发冲突</h4><p>图解Elasticsearch内部如何基于_version进行乐观锁并发控制</p>
<p><img src="/blog/2022/10/12/Elasticsearch/elasticsearch%E5%9F%BA%E7%A1%80/%E6%B7%B1%E5%BA%A6%E5%9B%BE%E8%A7%A3%E5%89%96%E6%9E%90Elasticsearch%E5%B9%B6%E5%8F%91%E5%86%B2%E7%AA%81%E9%97%AE%E9%A2%98.png" srcset="/blog/img/loading.gif" lazyload></p>
<p><img src="/blog/2022/10/12/Elasticsearch/elasticsearch%E5%9F%BA%E7%A1%80/%E6%B7%B1%E5%BA%A6%E5%9B%BE%E8%A7%A3%E5%89%96%E6%9E%90%E6%82%B2%E8%A7%82%E9%94%81%E4%B8%8E%E4%B9%90%E8%A7%82%E9%94%81%E4%B8%A4%E7%A7%8D%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6%E6%96%B9%E6%A1%88.png" srcset="/blog/img/loading.gif" lazyload alt="深度图解剖析悲观锁与乐观锁两种并发控制方案"></p>
<p>_version元数据</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs gradle">PUT <span class="hljs-regexp">/test_index/</span>test_type/<span class="hljs-number">6</span><br>&#123;<br>  <span class="hljs-string">&quot;test_field&quot;</span>: <span class="hljs-string">&quot;test test&quot;</span><br>&#125;<br><br>&#123;<br>  <span class="hljs-string">&quot;_index&quot;</span>: <span class="hljs-string">&quot;test_index&quot;</span>,<br>  <span class="hljs-string">&quot;_type&quot;</span>: <span class="hljs-string">&quot;test_type&quot;</span>,<br>  <span class="hljs-string">&quot;_id&quot;</span>: <span class="hljs-string">&quot;6&quot;</span>,<br>  <span class="hljs-string">&quot;_version&quot;</span>: <span class="hljs-number">1</span>,<br>  <span class="hljs-string">&quot;result&quot;</span>: <span class="hljs-string">&quot;created&quot;</span>,<br>  <span class="hljs-string">&quot;_shards&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;total&quot;</span>: <span class="hljs-number">2</span>,<br>    <span class="hljs-string">&quot;successful&quot;</span>: <span class="hljs-number">1</span>,<br>    <span class="hljs-string">&quot;failed&quot;</span>: <span class="hljs-number">0</span><br>  &#125;,<br>  <span class="hljs-string">&quot;created&quot;</span>: <span class="hljs-keyword">true</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>第一次创建一个document的时候，它的_version内部版本号就是1；以后，每次对这个document执行修改或者删除操作，都会对这个_version版本号自动加1；哪怕是删除，也会对这条数据的版本号加1</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;found&quot;</span>: <span class="hljs-literal">true</span>,<br>  <span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;test_index&quot;</span>,<br>  <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;test_type&quot;</span>,<br>  <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;6&quot;</span>,<br>  <span class="hljs-attr">&quot;_version&quot;</span>: <span class="hljs-number">4</span>,<br>  <span class="hljs-attr">&quot;result&quot;</span>: <span class="hljs-string">&quot;deleted&quot;</span>,<br>  <span class="hljs-attr">&quot;_shards&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">2</span>,<br>    <span class="hljs-attr">&quot;successful&quot;</span>: <span class="hljs-number">1</span>,<br>    <span class="hljs-attr">&quot;failed&quot;</span>: <span class="hljs-number">0</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/blog/2022/10/12/Elasticsearch/elasticsearch%E5%9F%BA%E7%A1%80/%E5%9B%BE%E8%A7%A3Elasticsearch%E5%86%85%E9%83%A8%E5%A6%82%E4%BD%95%E5%9F%BA%E4%BA%8E_version%E8%BF%9B%E8%A1%8C%E4%B9%90%E8%A7%82%E9%94%81%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6.png" srcset="/blog/img/loading.gif" lazyload></p>
<p>基于external version进行乐观锁并发控制</p>
<p>external version</p>
<p>es提供了一个feature，就是说，你可以不用它提供的内部_version版本号来进行并发控制，可以基于你自己维护的一个版本号来进行并发控制。举个列子，加入你的数据在mysql里也有一份，然后你的应用系统本身就维护了一个版本号，无论是什么自己生成的，程序控制的。这个时候，你进行乐观锁并发控制的时候，可能并不是想要用es内部的_version来进行控制，而是用你自己维护的那个version来进行控制。</p>
<figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs elm">?version=<span class="hljs-number">1</span>&amp;version_<span class="hljs-keyword">type</span>=external<br></code></pre></td></tr></table></figure>

<p>version_type=external，唯一的区别在于，_version，只有当你提供的version与es中的_version一模一样的时候，才可以进行修改，只要不一样，就报错；当version_type=external的时候，只有当你提供的version比es中的_version大的时候，才能完成修改</p>
<p>es，_version=1，?version=1，才能更新成功<br>es，_version=1，?version&gt;1&amp;version_type=external，才能成功，比如version=2&amp;version_type=external</p>
<p>先构造一条数据</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs gradle">PUT <span class="hljs-regexp">/test_index/</span>test_type/<span class="hljs-number">8</span><br>&#123;<br>  <span class="hljs-string">&quot;test_field&quot;</span>: <span class="hljs-string">&quot;test&quot;</span><br>&#125;<br><br>&#123;<br>  <span class="hljs-string">&quot;_index&quot;</span>: <span class="hljs-string">&quot;test_index&quot;</span>,<br>  <span class="hljs-string">&quot;_type&quot;</span>: <span class="hljs-string">&quot;test_type&quot;</span>,<br>  <span class="hljs-string">&quot;_id&quot;</span>: <span class="hljs-string">&quot;8&quot;</span>,<br>  <span class="hljs-string">&quot;_version&quot;</span>: <span class="hljs-number">1</span>,<br>  <span class="hljs-string">&quot;result&quot;</span>: <span class="hljs-string">&quot;created&quot;</span>,<br>  <span class="hljs-string">&quot;_shards&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;total&quot;</span>: <span class="hljs-number">2</span>,<br>    <span class="hljs-string">&quot;successful&quot;</span>: <span class="hljs-number">1</span>,<br>    <span class="hljs-string">&quot;failed&quot;</span>: <span class="hljs-number">0</span><br>  &#125;,<br>  <span class="hljs-string">&quot;created&quot;</span>: <span class="hljs-keyword">true</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>模拟两个客户端同时查询到这条数据</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs gradle">GET <span class="hljs-regexp">/test_index/</span>test_type/<span class="hljs-number">8</span><br><br>&#123;<br>  <span class="hljs-string">&quot;_index&quot;</span>: <span class="hljs-string">&quot;test_index&quot;</span>,<br>  <span class="hljs-string">&quot;_type&quot;</span>: <span class="hljs-string">&quot;test_type&quot;</span>,<br>  <span class="hljs-string">&quot;_id&quot;</span>: <span class="hljs-string">&quot;8&quot;</span>,<br>  <span class="hljs-string">&quot;_version&quot;</span>: <span class="hljs-number">1</span>,<br>  <span class="hljs-string">&quot;found&quot;</span>: <span class="hljs-keyword">true</span>,<br>  <span class="hljs-string">&quot;_source&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;test_field&quot;</span>: <span class="hljs-string">&quot;test&quot;</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>第一个客户端先进行修改，此时客户端程序是在自己的数据库中获取到了这条数据的最新版本号，比如说是2</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">PUT <span class="hljs-string">/test_index/test_type/8</span>?<span class="hljs-keyword">version</span>=2&amp;<span class="hljs-keyword">version</span>_type=external<br>&#123;<br>  <span class="hljs-string">&quot;test_field&quot;</span>: <span class="hljs-string">&quot;test client 1&quot;</span><br>&#125;<br><br>&#123;<br>  <span class="hljs-string">&quot;_index&quot;</span>: <span class="hljs-string">&quot;test_index&quot;</span>,<br>  <span class="hljs-string">&quot;_type&quot;</span>: <span class="hljs-string">&quot;test_type&quot;</span>,<br>  <span class="hljs-string">&quot;_id&quot;</span>: <span class="hljs-string">&quot;8&quot;</span>,<br>  <span class="hljs-string">&quot;_version&quot;</span>: 2,<br>  <span class="hljs-string">&quot;result&quot;</span>: <span class="hljs-string">&quot;updated&quot;</span>,<br>  <span class="hljs-string">&quot;_shards&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;total&quot;</span>: 2,<br>    <span class="hljs-string">&quot;successful&quot;</span>: 1,<br>    <span class="hljs-string">&quot;failed&quot;</span>: 0<br>  &#125;,<br>  <span class="hljs-string">&quot;created&quot;</span>: <span class="hljs-literal">false</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>模拟第二个客户端，同时拿到了自己数据库中维护的那个版本号，也是2，同时基于version=2发起了修改</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">PUT <span class="hljs-string">/test_index/test_type/8</span>?<span class="hljs-keyword">version</span>=2&amp;<span class="hljs-keyword">version</span>_type=external<br>&#123;<br>  <span class="hljs-string">&quot;test_field&quot;</span>: <span class="hljs-string">&quot;test client 2&quot;</span><br>&#125;<br><br>&#123;<br>  <span class="hljs-string">&quot;error&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;root_cause&quot;</span>: [<br>      &#123;<br>        <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;version_conflict_engine_exception&quot;</span>,<br>        <span class="hljs-string">&quot;reason&quot;</span>: <span class="hljs-string">&quot;[test_type][8]: version conflict, current version [2] is higher or equal to the one provided [2]&quot;</span>,<br>        <span class="hljs-string">&quot;index_uuid&quot;</span>: <span class="hljs-string">&quot;6m0G7yx7R1KECWWGnfH1sw&quot;</span>,<br>        <span class="hljs-string">&quot;shard&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>,<br>        <span class="hljs-string">&quot;index&quot;</span>: <span class="hljs-string">&quot;test_index&quot;</span><br>      &#125;<br>    ],<br>    <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;version_conflict_engine_exception&quot;</span>,<br>    <span class="hljs-string">&quot;reason&quot;</span>: <span class="hljs-string">&quot;[test_type][8]: version conflict, current version [2] is higher or equal to the one provided [2]&quot;</span>,<br>    <span class="hljs-string">&quot;index_uuid&quot;</span>: <span class="hljs-string">&quot;6m0G7yx7R1KECWWGnfH1sw&quot;</span>,<br>    <span class="hljs-string">&quot;shard&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>,<br>    <span class="hljs-string">&quot;index&quot;</span>: <span class="hljs-string">&quot;test_index&quot;</span><br>  &#125;,<br>  <span class="hljs-string">&quot;status&quot;</span>: 409<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在并发控制成功后，重新基于最新的版本号发起更新</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs gradle">GET <span class="hljs-regexp">/test_index/</span>test_type/<span class="hljs-number">8</span><br><br>&#123;<br>  <span class="hljs-string">&quot;_index&quot;</span>: <span class="hljs-string">&quot;test_index&quot;</span>,<br>  <span class="hljs-string">&quot;_type&quot;</span>: <span class="hljs-string">&quot;test_type&quot;</span>,<br>  <span class="hljs-string">&quot;_id&quot;</span>: <span class="hljs-string">&quot;8&quot;</span>,<br>  <span class="hljs-string">&quot;_version&quot;</span>: <span class="hljs-number">2</span>,<br>  <span class="hljs-string">&quot;found&quot;</span>: <span class="hljs-keyword">true</span>,<br>  <span class="hljs-string">&quot;_source&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;test_field&quot;</span>: <span class="hljs-string">&quot;test client 1&quot;</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">PUT <span class="hljs-string">/test_index/test_type/8</span>?<span class="hljs-keyword">version</span>=3&amp;<span class="hljs-keyword">version</span>_type=external<br>&#123;<br>  <span class="hljs-string">&quot;test_field&quot;</span>: <span class="hljs-string">&quot;test client 2&quot;</span><br>&#125;<br><br>&#123;<br>  <span class="hljs-string">&quot;_index&quot;</span>: <span class="hljs-string">&quot;test_index&quot;</span>,<br>  <span class="hljs-string">&quot;_type&quot;</span>: <span class="hljs-string">&quot;test_type&quot;</span>,<br>  <span class="hljs-string">&quot;_id&quot;</span>: <span class="hljs-string">&quot;8&quot;</span>,<br>  <span class="hljs-string">&quot;_version&quot;</span>: 3,<br>  <span class="hljs-string">&quot;result&quot;</span>: <span class="hljs-string">&quot;updated&quot;</span>,<br>  <span class="hljs-string">&quot;_shards&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;total&quot;</span>: 2,<br>    <span class="hljs-string">&quot;successful&quot;</span>: 1,<br>    <span class="hljs-string">&quot;failed&quot;</span>: 0<br>  &#125;,<br>  <span class="hljs-string">&quot;created&quot;</span>: <span class="hljs-literal">false</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h4><p>一个index的数据会被分为多片，每片在一个primary shard中，当创建document的时候，es就需要决定这个这个index在那个shard上，这个过程就称为document的路由。primary shard一旦建立，是不允许修改的，但是replica shard可以随时修改。</p>
<p>document路由算法：shard = hash(routing) % number_of_primary_shards</p>
<p>一个index有3个primary shard，P0，P1，P2</p>
<p>每次增删改查一个document的时候，都会带过来一个routing number，默认就是这个document的_id（可能是手动指定，也可能是自动生成）<br>routing = _id，假设_id=1</p>
<p>会将这个routing值，传入一个hash函数中，产出一个routing值的hash值，hash(routing) = 21<br>然后将hash函数产出的值对这个index的primary shard的数量求余数，21 % 3 = 0<br>就决定了，这个document就放在P0上。</p>
<p>决定一个document在哪个shard上，最重要的一个值就是routing值，默认是_id，也可以手动指定，相同的routing值，每次过来，从hash函数中，产出的hash值一定是相同的</p>
<p>无论hash值是几，无论是什么数字，对number_of_primary_shards求余数，结果一定是在0~number_of_primary_shards-1之间这个范围内的。0,1,2。</p>
<p>_id or custom routing value</p>
<p>默认的routing就是_id<br>也可以在发送请求的时候，手动指定一个routing value，比如说put /index/type/id?routing=user_id</p>
<p>手动指定routing value是很有用的，可以保证说，某一类document一定被路由到一个shard上去，那么在后续进行应用级别的负载均衡，以及提升批量读取的性能的时候，是很有帮助的</p>
<h4 id="document增删改操作"><a href="#document增删改操作" class="headerlink" title="document增删改操作"></a>document增删改操作</h4><ol>
<li>客户端选择一个node发送请求过去，这个node就是coordinating node（协调节点）</li>
<li>coordinating node，对document进行路由，将请求转发给对应的node（有primary shard）</li>
<li>实际的node上的primary shard处理请求，然后将数据同步到replica node</li>
<li>coordinating node，如果发现primary node和所有replica node都搞定之后，就返回响应结果给客户端</li>
</ol>
<h4 id="写一致性"><a href="#写一致性" class="headerlink" title="写一致性"></a>写一致性</h4><p>发送任何一个增删改操作的时候，比如说put /index/type/id，都可以带上一个consistency参数，指明想要的写一致性。</p>
<ul>
<li>one：要求我们这个写操作，只要有一个primary shard是active活跃可用的，就可以执行</li>
<li>all：要求我们这个写操作，必须所有的primary shard和replica shard都是活跃的，才可以执行这个写操作 </li>
<li>quorum：默认的值，要求所有的shard中，必须是大部分的shard都是活跃的，可用的，才可以执行这个写操作，int( (primary + number_of_replicas) / 2 ) + 1，当number_of_replicas&gt;1时才生效</li>
</ul>
<p>示例</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">put</span> /<span class="hljs-built_in">index</span>/<span class="hljs-built_in">type</span>/id?consistency=quorum<br></code></pre></td></tr></table></figure>

<p>如果节点数少于quorum数量，可能导致quorum不齐全，进而导致无法执行任何写操作</p>
<p>比如3个primary shard，replica=1，要求至少3个shard是active，3个shard按照之前学习的shard&amp;replica机制，必须在不同的节点上，如果说只有1台机器的话，是不是有可能出现说，3个shard都没法分配齐全，此时就可能会出现写操作无法执行的情况</p>
<p>1个primary shard，replica=3，quorum=((1 + 3) / 2) + 1 = 3，要求1个primary shard + 3个replica shard = 4个shard，其中必须有3个shard是要处于active状态的。如果这个时候只有2台机器的话，会出现什么情况呢？</p>
<p>es提供了一种特殊的处理场景，就是说当number_of_replicas&gt;1时才生效，因为假如就一个primary shard，replica=1，此时就2个shard。(1 + 1 / 2) + 1 = 2，要求必须有2个shard是活跃的，但是可能就1个node，此时就1个shard是活跃的，如果你不特殊处理的话，导致我们的单节点集群就无法工作</p>
<p>quorum不齐全时，可以设置等待的超时时间默认1分钟等待期间，期望活跃的shard数量可以增加，最后实在不行，就会timeout。</p>
<p>我们其实可以在写操作的时候，加一个timeout参数，比如说put /index/type/id?timeout=30，这个就是说自己去设定quorum不齐全的时候，es的timeout时长，可以缩短，也可以增长。</p>
<h4 id="document内部原理"><a href="#document内部原理" class="headerlink" title="document内部原理"></a>document内部原理</h4><ol>
<li>客户端发送请求到任意一个node，成为coordinate node</li>
<li>coordinate node对document进行路由，将请求转发到对应的node，此时会使用round-robin随机轮询算法，在primary shard以及其所有replica中随机选择一个，让读请求负载均衡</li>
<li>接收请求的node返回document给coordinate node</li>
<li>coordinate node返回document给客户端</li>
<li>特殊情况：document如果还在建立索引过程中，可能只有primary shard有，任何一个replica shard都没有，此时可能会导致无法读取到document，但是document完成索引建立之后，primary shard和replica shard就都有了</li>
</ol>
<p><img src="/blog/2022/10/12/Elasticsearch/elasticsearch%E5%9F%BA%E7%A1%80/%E8%AF%BB%E8%AF%B7%E6%B1%82%E5%86%85%E9%83%A8%E5%8E%9F%E7%90%86.png" srcset="/blog/img/loading.gif" lazyload alt="读请求内部原理"></p>
<h4 id="mapping"><a href="#mapping" class="headerlink" title="mapping"></a>mapping</h4><p>在es中，每个type都有对应的mapping，mapping决定了如何将document的数据映射为lucence需要的扁平数据。其中包括数据类型以及如何分词等设置。mapping可以手动建立也可以由es根据数据内容自动建立。如果搜索时结果与预期不同，很可能是mapping出了问题。</p>
<p>es的dynamic mapping，可以在往es里面直接插入数据时，根据数据内容自动建立对应的index、type、以及mapping，包括自动设置数据类型；也可以提前手动创建index和type的mapping，自己对各个field进行设置，包括数据类型，包括索引行为，包括分词器，等等。</p>
<p>插入几条数据，让es自动为我们建立一个索引</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs awk">PUT <span class="hljs-regexp">/website/</span>article/<span class="hljs-number">1</span><br>&#123;<br>  <span class="hljs-string">&quot;post_date&quot;</span>: <span class="hljs-string">&quot;2017-01-01&quot;</span>,<br>  <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;my first article&quot;</span>,<br>  <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;this is my first article in this website&quot;</span>,<br>  <span class="hljs-string">&quot;author_id&quot;</span>: <span class="hljs-number">11400</span><br>&#125;<br><br>PUT <span class="hljs-regexp">/website/</span>article/<span class="hljs-number">2</span><br>&#123;<br>  <span class="hljs-string">&quot;post_date&quot;</span>: <span class="hljs-string">&quot;2017-01-02&quot;</span>,<br>  <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;my second article&quot;</span>,<br>  <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;this is my second article in this website&quot;</span>,<br>  <span class="hljs-string">&quot;author_id&quot;</span>: <span class="hljs-number">11400</span><br>&#125;<br><br>PUT <span class="hljs-regexp">/website/</span>article/<span class="hljs-number">3</span><br>&#123;<br>  <span class="hljs-string">&quot;post_date&quot;</span>: <span class="hljs-string">&quot;2017-01-03&quot;</span>,<br>  <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;my third article&quot;</span>,<br>  <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;this is my third article in this website&quot;</span>,<br>  <span class="hljs-string">&quot;author_id&quot;</span>: <span class="hljs-number">11400</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>尝试各种搜索</p>
<p>GET /website/article/_search?q=2017            3条结果<br>GET /website/article/_search?q=2017-01-01            3条结果<br>GET /website/article/_search?q=post_date:2017-01-01       1条结果<br>GET /website/article/_search?q=post_date:2017             1条结果</p>
<p>产生这样的结果是因为es自动建立mapping的时候，设置了为不同的field设置了不同的data type。不同的data type的分词、搜索等行为是不一样的。所以出现了_all field和post_date field的搜索表现完全不一样。</p>
<p>mapping中定义了每个field的数据类型，不同的data type（比如说text和date）会对应不同的匹配类型，可能有的是exact value，有的是full text。exact value，在建立倒排索引的时候，是将整个值一起作为一个关键词建立到倒排索引中的；而full text会经历各种各样的处理，分词，normaliztion（时态转换，同义词转换，大小写转换），才会建立到倒排索引中。</p>
<p>同时exact value和full text类型的field就决定了，在一个搜索过来的时候，对exact value field或者是full text field进行搜索的行为也是不一样的，会跟建立倒排索引的行为保持一致；比如说exact value搜索的时候，就是直接按照整个值进行匹配，full text query string，也会进行分词和normalization再去倒排索引中去搜索。</p>
<p>查看mapping</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">GET</span> /<span class="hljs-keyword">index</span>/_mapping/<span class="hljs-keyword">type</span><br></code></pre></td></tr></table></figure>

<p>创建mapping，需要在索引写入数据前进行</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/website/</span>_mapping/article<br>&#123;<br>  <span class="hljs-string">&quot;website&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;mappings&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;article&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;author_id&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;long&quot;</span><br>          &#125;,<br>          <span class="hljs-string">&quot;content&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span>,<br>            <span class="hljs-string">&quot;fields&quot;</span>: &#123;<br>              <span class="hljs-string">&quot;keyword&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;keyword&quot;</span>,<br>                <span class="hljs-string">&quot;ignore_above&quot;</span>: <span class="hljs-number">256</span><br>              &#125;<br>            &#125;<br>          &#125;,<br>          <span class="hljs-string">&quot;post_date&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;date&quot;</span><br>          &#125;,<br>          <span class="hljs-string">&quot;title&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span>,<br>            <span class="hljs-string">&quot;fields&quot;</span>: &#123;<br>              <span class="hljs-string">&quot;keyword&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;keyword&quot;</span>,<br>                <span class="hljs-string">&quot;ignore_above&quot;</span>: <span class="hljs-number">256</span><br>              &#125;<br>            &#125;<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>修改mapping，只能创建index时手动建立mapping，或者新增field mapping，但是不能update field mapping</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs dts">PUT /website<br>&#123;<br>  <span class="hljs-string">&quot;mappings&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;article&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;author_id&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;long&quot;</span><br>        &#125;,<br>        <span class="hljs-string">&quot;title&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span>,<br>          <span class="hljs-string">&quot;analyzer&quot;</span>: <span class="hljs-string">&quot;english&quot;</span><br>        &#125;,<br>        <span class="hljs-string">&quot;content&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span><br>        &#125;,<br>        <span class="hljs-string">&quot;post_date&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;date&quot;</span><br>        &#125;,<br>        <span class="hljs-string">&quot;publisher_id&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span>,<br>          <span class="hljs-string">&quot;index&quot;</span>: <span class="hljs-string">&quot;not_analyzed&quot;</span><br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs dts">PUT /website<br>&#123;<br>  <span class="hljs-string">&quot;mappings&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;article&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;author_id&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span><br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br>&#123;<br>  <span class="hljs-string">&quot;error&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;root_cause&quot;</span>: [<br>      &#123;<br>        <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;index_already_exists_exception&quot;</span>,<br>        <span class="hljs-string">&quot;reason&quot;</span>: <span class="hljs-string">&quot;index [website/co1dgJ-uTYGBEEOOL8GsQQ] already exists&quot;</span>,<br>        <span class="hljs-string">&quot;index_uuid&quot;</span>: <span class="hljs-string">&quot;co1dgJ-uTYGBEEOOL8GsQQ&quot;</span>,<br>        <span class="hljs-string">&quot;index&quot;</span>: <span class="hljs-string">&quot;website&quot;</span><br>      &#125;<br>    ],<br>    <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;index_already_exists_exception&quot;</span>,<br>    <span class="hljs-string">&quot;reason&quot;</span>: <span class="hljs-string">&quot;index [website/co1dgJ-uTYGBEEOOL8GsQQ] already exists&quot;</span>,<br>    <span class="hljs-string">&quot;index_uuid&quot;</span>: <span class="hljs-string">&quot;co1dgJ-uTYGBEEOOL8GsQQ&quot;</span>,<br>    <span class="hljs-string">&quot;index&quot;</span>: <span class="hljs-string">&quot;website&quot;</span><br>  &#125;,<br>  <span class="hljs-string">&quot;status&quot;</span>: <span class="hljs-number">400</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>测试mapping</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs ada">PUT /website/_mapping/article<br>&#123;<br>  <span class="hljs-string">&quot;properties&quot;</span> : &#123;<br>    <span class="hljs-string">&quot;new_field&quot;</span> : &#123;<br>      <span class="hljs-string">&quot;type&quot;</span> :    &quot;<span class="hljs-type">string</span><span class="hljs-string">&quot;,</span><br><span class="hljs-string">      &quot;</span>index<span class="hljs-string">&quot;:    &quot;</span>not_analyzed<span class="hljs-string">&quot;</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string">  &#125;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">GET /website/_analyze</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string">  &quot;</span>field<span class="hljs-string">&quot;: &quot;</span>content<span class="hljs-string">&quot;,</span><br><span class="hljs-string">  &quot;</span>text<span class="hljs-string">&quot;: &quot;</span>my-dogs<span class="hljs-string">&quot; </span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">GET website/_analyze</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string">  &quot;</span>field<span class="hljs-string">&quot;: &quot;</span>new_field<span class="hljs-string">&quot;,</span><br><span class="hljs-string">  &quot;</span>text<span class="hljs-string">&quot;: &quot;</span>my dogs<span class="hljs-string">&quot;</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string">  &quot;</span>error<span class="hljs-string">&quot;: &#123;</span><br><span class="hljs-string">    &quot;</span>root_cause<span class="hljs-string">&quot;: [</span><br><span class="hljs-string">      &#123;</span><br><span class="hljs-string">        &quot;</span><span class="hljs-keyword">type</span><span class="hljs-string">&quot;: &quot;</span>remote_transport_exception<span class="hljs-string">&quot;,</span><br><span class="hljs-string">        &quot;</span>reason<span class="hljs-string">&quot;: &quot;</span>[<span class="hljs-number">4</span>onsTYV][<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">9300</span>][indices:admin/analyze[s]]<span class="hljs-string">&quot;</span><br><span class="hljs-string">      &#125;</span><br><span class="hljs-string">    ],</span><br><span class="hljs-string">    &quot;</span><span class="hljs-keyword">type</span><span class="hljs-string">&quot;: &quot;</span>illegal_argument_exception<span class="hljs-string">&quot;,</span><br><span class="hljs-string">    &quot;</span>reason<span class="hljs-string">&quot;: &quot;</span>Can<span class="hljs-symbol">&#x27;t</span> process field [new_field], Analysis requests are only supported on tokenized fields<span class="hljs-string">&quot;</span><br><span class="hljs-string">  &#125;,</span><br><span class="hljs-string">  &quot;</span>status<span class="hljs-string">&quot;: 400</span><br><span class="hljs-string">&#125;</span><br></code></pre></td></tr></table></figure>

<h5 id="动态映射策略"><a href="#动态映射策略" class="headerlink" title="动态映射策略"></a>动态映射策略</h5><p>在添加document时，如果document所在的type或者其中的某个field不存在，可以定制dynamic策略来进行相应的处理：</p>
<ul>
<li>true：遇到陌生字段，就进行dynamic mapping</li>
<li>false：遇到陌生字段，就忽略</li>
<li>strict：遇到陌生字段，就报错</li>
</ul>
<p>示例</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs dts">PUT /my_index<br>&#123;<br>  <span class="hljs-string">&quot;mappings&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;my_type&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;dynamic&quot;</span>: <span class="hljs-string">&quot;strict&quot;</span>,<br>      <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;title&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span><br>        &#125;,<br>        <span class="hljs-string">&quot;address&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;object&quot;</span>,<br>          <span class="hljs-string">&quot;dynamic&quot;</span>: <span class="hljs-string">&quot;true&quot;</span><br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs awk">PUT <span class="hljs-regexp">/my_index/my</span>_type/<span class="hljs-number">1</span><br>&#123;<br>  <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;my article&quot;</span>,<br>  <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;this is my article&quot;</span>,<br>  <span class="hljs-string">&quot;address&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;province&quot;</span>: <span class="hljs-string">&quot;guangdong&quot;</span>,<br>    <span class="hljs-string">&quot;city&quot;</span>: <span class="hljs-string">&quot;guangzhou&quot;</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;error&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;root_cause&quot;</span>: [<br>      &#123;<br>        <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;strict_dynamic_mapping_exception&quot;</span>,<br>        <span class="hljs-attr">&quot;reason&quot;</span>: <span class="hljs-string">&quot;mapping set to strict, dynamic introduction of [content] within [my_type] is not allowed&quot;</span><br>      &#125;<br>    ],<br>    <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;strict_dynamic_mapping_exception&quot;</span>,<br>    <span class="hljs-attr">&quot;reason&quot;</span>: <span class="hljs-string">&quot;mapping set to strict, dynamic introduction of [content] within [my_type] is not allowed&quot;</span><br>  &#125;,<br>  <span class="hljs-attr">&quot;status&quot;</span>: <span class="hljs-number">400</span><br>&#125;<br></code></pre></td></tr></table></figure>



<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs awk">PUT <span class="hljs-regexp">/my_index/my</span>_type/<span class="hljs-number">1</span><br>&#123;<br>  <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;my article&quot;</span>,<br>  <span class="hljs-string">&quot;address&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;province&quot;</span>: <span class="hljs-string">&quot;guangdong&quot;</span>,<br>    <span class="hljs-string">&quot;city&quot;</span>: <span class="hljs-string">&quot;guangzhou&quot;</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/my_index/</span>_mapping/my_type<br><br>&#123;<br>  <span class="hljs-string">&quot;my_index&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;mappings&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;my_type&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;dynamic&quot;</span>: <span class="hljs-string">&quot;strict&quot;</span>,<br>        <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;address&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;dynamic&quot;</span>: <span class="hljs-string">&quot;true&quot;</span>,<br>            <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>              <span class="hljs-string">&quot;city&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span>,<br>                <span class="hljs-string">&quot;fields&quot;</span>: &#123;<br>                  <span class="hljs-string">&quot;keyword&quot;</span>: &#123;<br>                    <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;keyword&quot;</span>,<br>                    <span class="hljs-string">&quot;ignore_above&quot;</span>: <span class="hljs-number">256</span><br>                  &#125;<br>                &#125;<br>              &#125;,<br>              <span class="hljs-string">&quot;province&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span>,<br>                <span class="hljs-string">&quot;fields&quot;</span>: &#123;<br>                  <span class="hljs-string">&quot;keyword&quot;</span>: &#123;<br>                    <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;keyword&quot;</span>,<br>                    <span class="hljs-string">&quot;ignore_above&quot;</span>: <span class="hljs-number">256</span><br>                  &#125;<br>                &#125;<br>              &#125;<br>            &#125;<br>          &#125;,<br>          <span class="hljs-string">&quot;title&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span><br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>date_detection</p>
<p>默认会按照一定格式识别date，比如yyyy-MM-dd。但是如果某个field先过来一个2017-01-01的值，就会被自动dynamic mapping成date，后面如果再来一个”hello world”之类的值，就会报错。可以手动关闭某个type的date_detection，如果有需要，自己手动指定某个field为date类型。</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs gradle">PUT <span class="hljs-regexp">/my_index/</span>_mapping/my_type<br>&#123;<br>    <span class="hljs-string">&quot;date_detection&quot;</span>: <span class="hljs-keyword">false</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>定制自己的dynamic mapping template（type level）</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs dts">PUT /my_index<br>&#123;<br>    <span class="hljs-string">&quot;mappings&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;my_type&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;dynamic_templates&quot;</span>: [<br>                &#123; <span class="hljs-string">&quot;en&quot;</span>: &#123;<br>                      <span class="hljs-string">&quot;match&quot;</span>:              <span class="hljs-string">&quot;*_en&quot;</span>, <br>                      <span class="hljs-string">&quot;match_mapping_type&quot;</span>: <span class="hljs-string">&quot;string&quot;</span>,<br>                      <span class="hljs-string">&quot;mapping&quot;</span>: &#123;<br>                          <span class="hljs-string">&quot;type&quot;</span>:           <span class="hljs-string">&quot;string&quot;</span>,<br>                          <span class="hljs-string">&quot;analyzer&quot;</span>:       <span class="hljs-string">&quot;english&quot;</span><br>                      &#125;<br>                &#125;&#125;<br>            ]<br>&#125;&#125;&#125;<br></code></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs awk">PUT <span class="hljs-regexp">/my_index/my</span>_type/<span class="hljs-number">1</span><br>&#123;<br>  <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;this is my first article&quot;</span><br>&#125;<br><br>PUT <span class="hljs-regexp">/my_index/my</span>_type/<span class="hljs-number">2</span><br>&#123;<br>  <span class="hljs-string">&quot;title_en&quot;</span>: <span class="hljs-string">&quot;this is my first article&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>title没有匹配到任何的dynamic模板，默认就是standard分词器，不会过滤停用词，is会进入倒排索引，用is来搜索是可以搜索到的<br>title_en匹配到了dynamic模板，就是english分词器，会过滤停用词，is这种停用词就会被过滤掉，用is来搜索就搜索不到了</p>
<p>定制自己的default mapping template（index level）</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">PUT</span> <span class="hljs-string">/my_index</span><br>&#123;<br>    <span class="hljs-attr">&quot;mappings&quot;:</span> &#123;<br>        <span class="hljs-attr">&quot;_default_&quot;:</span> &#123;<br>            <span class="hljs-attr">&quot;_all&quot;:</span> &#123; <span class="hljs-attr">&quot;enabled&quot;:</span>  <span class="hljs-literal">false</span> &#125;<br>        &#125;,<br>        <span class="hljs-attr">&quot;blog&quot;:</span> &#123;<br>            <span class="hljs-attr">&quot;_all&quot;:</span> &#123; <span class="hljs-attr">&quot;enabled&quot;:</span>  <span class="hljs-literal">true</span>  &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="定制映射规则"><a href="#定制映射规则" class="headerlink" title="定制映射规则"></a>定制映射规则</h5><p>可以定制dynamic规则，比如某个field的值为10，es默认的数据类型为long，但如果希望动态映射的时候，不按照es默认的规则，而是根据我们的需求去映射，就需要用到dyanmic mapping template，动态映射模板。</p>
<p>默认的动态映射的效果</p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gauss"><span class="hljs-keyword">DELETE</span> /my_index<br></code></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk">PUT <span class="hljs-regexp">/my_index/my</span>_type/<span class="hljs-number">1</span><br>&#123;<br>  <span class="hljs-string">&quot;test_string&quot;</span>: <span class="hljs-string">&quot;hello world&quot;</span>,<br>  <span class="hljs-string">&quot;test_number&quot;</span>: <span class="hljs-number">10</span><br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/my_index/</span>_mapping/my_type<br><br>&#123;<br>  <span class="hljs-string">&quot;my_index&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;mappings&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;my_type&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;test_number&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;long&quot;</span><br>          &#125;,<br>          <span class="hljs-string">&quot;test_string&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span>,<br>            <span class="hljs-string">&quot;fields&quot;</span>: &#123;<br>              <span class="hljs-string">&quot;keyword&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;keyword&quot;</span>,<br>                <span class="hljs-string">&quot;ignore_above&quot;</span>: <span class="hljs-number">256</span><br>              &#125;<br>            &#125;<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>根据类型匹配映射模板</strong></p>
<p>动态映射模板，有两种方式，第一种是根据新加入的field的默认的数据类型，来进行匹配，匹配上某个预定义的模板；第二种是根据新加入的field的名字，去匹配预定义的名字，或者去匹配一个预定义的通配符，然后匹配上某个预定义的模板。</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs dts">PUT my_index<br>&#123;<br>  <span class="hljs-string">&quot;mappings&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;my_type&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;dynamic_templates&quot;</span>: [<br>        &#123;<br>          <span class="hljs-string">&quot;integers&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;match_mapping_type&quot;</span>: <span class="hljs-string">&quot;long&quot;</span>,<br>            <span class="hljs-string">&quot;mapping&quot;</span>: &#123;<br>              <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;integer&quot;</span><br>            &#125;<br>          &#125;<br>        &#125;,<br>        &#123;<br>          <span class="hljs-string">&quot;strings&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;match_mapping_type&quot;</span>: <span class="hljs-string">&quot;string&quot;</span>,<br>            <span class="hljs-string">&quot;mapping&quot;</span>: &#123;<br>              <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span>,<br>              <span class="hljs-string">&quot;fields&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;raw&quot;</span>: &#123;<br>                  <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;keyword&quot;</span>,<br>                  <span class="hljs-string">&quot;ignore_above&quot;</span>: <span class="hljs-number">500</span><br>                &#125;<br>              &#125;<br>            &#125;<br>          &#125;<br>        &#125;<br>      ]<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs awk">PUT <span class="hljs-regexp">/my_index/my</span>_type/<span class="hljs-number">1</span><br>&#123;<br>  <span class="hljs-string">&quot;test_long&quot;</span>: <span class="hljs-number">1</span>,<br>  <span class="hljs-string">&quot;test_string&quot;</span>: <span class="hljs-string">&quot;hello world&quot;</span><br>&#125;<br><br>&#123;<br>  <span class="hljs-string">&quot;my_index&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;mappings&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;my_type&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;dynamic_templates&quot;</span>: [<br>          &#123;<br>            <span class="hljs-string">&quot;integers&quot;</span>: &#123;<br>              <span class="hljs-string">&quot;match_mapping_type&quot;</span>: <span class="hljs-string">&quot;long&quot;</span>,<br>              <span class="hljs-string">&quot;mapping&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;integer&quot;</span><br>              &#125;<br>            &#125;<br>          &#125;,<br>          &#123;<br>            <span class="hljs-string">&quot;strings&quot;</span>: &#123;<br>              <span class="hljs-string">&quot;match_mapping_type&quot;</span>: <span class="hljs-string">&quot;string&quot;</span>,<br>              <span class="hljs-string">&quot;mapping&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;fields&quot;</span>: &#123;<br>                  <span class="hljs-string">&quot;raw&quot;</span>: &#123;<br>                    <span class="hljs-string">&quot;ignore_above&quot;</span>: <span class="hljs-number">500</span>,<br>                    <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;keyword&quot;</span><br>                  &#125;<br>                &#125;,<br>                <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span><br>              &#125;<br>            &#125;<br>          &#125;<br>        ],<br>        <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;test_number&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;integer&quot;</span><br>          &#125;,<br>          <span class="hljs-string">&quot;test_string&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span>,<br>            <span class="hljs-string">&quot;fields&quot;</span>: &#123;<br>              <span class="hljs-string">&quot;raw&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;keyword&quot;</span>,<br>                <span class="hljs-string">&quot;ignore_above&quot;</span>: <span class="hljs-number">500</span><br>              &#125;<br>            &#125;<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br></code></pre></td></tr></table></figure>

<p><strong>根据字段名配映射模板</strong></p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs gams"><span class="hljs-keyword">PUT</span> /my_index <br>&#123;<br>  <span class="hljs-string">&quot;mappings&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;my_type&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;dynamic_templates&quot;</span>: [<br>        &#123;<br>          <span class="hljs-string">&quot;string_as_integer&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;match_mapping_type&quot;</span>: <span class="hljs-string">&quot;string&quot;</span>,<br>            <span class="hljs-string">&quot;match&quot;</span>: <span class="hljs-string">&quot;long_*&quot;</span>,<br>            <span class="hljs-string">&quot;unmatch&quot;</span>: <span class="hljs-string">&quot;*_text&quot;</span>,<br>            <span class="hljs-string">&quot;mapping&quot;</span>: &#123;<br>              <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;integer&quot;</span><br>            &#125;<br>          &#125;<br>        &#125;<br>      ]<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>自动建立的类型</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/my_index/</span>_mapping/my_type<br><br>&#123;<br>  <span class="hljs-string">&quot;my_index&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;mappings&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;my_type&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;dynamic&quot;</span>: <span class="hljs-string">&quot;strict&quot;</span>,<br>        <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;address&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;dynamic&quot;</span>: <span class="hljs-string">&quot;true&quot;</span>,<br>            <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>              <span class="hljs-string">&quot;city&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span>,<br>                <span class="hljs-string">&quot;fields&quot;</span>: &#123;<br>                  <span class="hljs-string">&quot;keyword&quot;</span>: &#123;<br>                    <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;keyword&quot;</span>,<br>                    <span class="hljs-string">&quot;ignore_above&quot;</span>: <span class="hljs-number">256</span><br>                  &#125;<br>                &#125;<br>              &#125;,<br>              <span class="hljs-string">&quot;province&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span>,<br>                <span class="hljs-string">&quot;fields&quot;</span>: &#123;<br>                  <span class="hljs-string">&quot;keyword&quot;</span>: &#123;<br>                    <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;keyword&quot;</span>,<br>                    <span class="hljs-string">&quot;ignore_above&quot;</span>: <span class="hljs-number">256</span><br>                  &#125;<br>                &#125;<br>              &#125;<br>            &#125;<br>          &#125;,<br>          <span class="hljs-string">&quot;title&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span><br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="对象类型存储结构"><a href="#对象类型存储结构" class="headerlink" title="对象类型存储结构"></a>对象类型存储结构</h5><p>es的所有数据类型都会被转为lunce支持的二维数据类型，这里介绍几个特殊类型的底层存储结构，如multivalue field，即数组格式，建立索引时与string是一样的，只能存储单一类型的数据，不能多种数据类型混合。比如：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123; <span class="hljs-attr">&quot;tags&quot;</span>: [ <span class="hljs-string">&quot;tag1&quot;</span>, <span class="hljs-string">&quot;tag2&quot;</span> ]&#125;<br></code></pre></td></tr></table></figure>

<p>empty field即空值，比如null、[]、[null]</p>
<p>object field，对象类型，示例：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs awk">PUT <span class="hljs-regexp">/company/</span>employee/<span class="hljs-number">1</span><br>&#123;<br>  <span class="hljs-string">&quot;address&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;country&quot;</span>: <span class="hljs-string">&quot;china&quot;</span>,<br>    <span class="hljs-string">&quot;province&quot;</span>: <span class="hljs-string">&quot;guangdong&quot;</span>,<br>    <span class="hljs-string">&quot;city&quot;</span>: <span class="hljs-string">&quot;guangzhou&quot;</span><br>  &#125;,<br>  <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;jack&quot;</span>,<br>  <span class="hljs-string">&quot;age&quot;</span>: <span class="hljs-number">27</span>,<br>  <span class="hljs-string">&quot;join_date&quot;</span>: <span class="hljs-string">&quot;2017-01-01&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>其中的address就是object类型，对应的mapping为：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;company&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;mappings&quot;</span>: &#123;<br>      <span class="hljs-attr">&quot;employee&quot;</span>: &#123;<br>        <span class="hljs-attr">&quot;properties&quot;</span>: &#123;<br>          <span class="hljs-attr">&quot;address&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;properties&quot;</span>: &#123;<br>              <span class="hljs-attr">&quot;city&quot;</span>: &#123;<br>                <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span>,<br>                <span class="hljs-attr">&quot;fields&quot;</span>: &#123;<br>                  <span class="hljs-attr">&quot;keyword&quot;</span>: &#123;<br>                    <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;keyword&quot;</span>,<br>                    <span class="hljs-attr">&quot;ignore_above&quot;</span>: <span class="hljs-number">256</span><br>                  &#125;<br>                &#125;<br>              &#125;,<br>              <span class="hljs-attr">&quot;country&quot;</span>: &#123;<br>                <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span>,<br>                <span class="hljs-attr">&quot;fields&quot;</span>: &#123;<br>                  <span class="hljs-attr">&quot;keyword&quot;</span>: &#123;<br>                    <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;keyword&quot;</span>,<br>                    <span class="hljs-attr">&quot;ignore_above&quot;</span>: <span class="hljs-number">256</span><br>                  &#125;<br>                &#125;<br>              &#125;,<br>              <span class="hljs-attr">&quot;province&quot;</span>: &#123;<br>                <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span>,<br>                <span class="hljs-attr">&quot;fields&quot;</span>: &#123;<br>                  <span class="hljs-attr">&quot;keyword&quot;</span>: &#123;<br>                    <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;keyword&quot;</span>,<br>                    <span class="hljs-attr">&quot;ignore_above&quot;</span>: <span class="hljs-number">256</span><br>                  &#125;<br>                &#125;<br>              &#125;<br>            &#125;<br>          &#125;,<br>          <span class="hljs-attr">&quot;age&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;long&quot;</span><br>          &#125;,<br>          <span class="hljs-attr">&quot;join_date&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;date&quot;</span><br>          &#125;,<br>          <span class="hljs-attr">&quot;name&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span>,<br>            <span class="hljs-attr">&quot;fields&quot;</span>: &#123;<br>              <span class="hljs-attr">&quot;keyword&quot;</span>: &#123;<br>                <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;keyword&quot;</span>,<br>                <span class="hljs-attr">&quot;ignore_above&quot;</span>: <span class="hljs-number">256</span><br>              &#125;<br>            &#125;<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>底层存储结构为：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>    <span class="hljs-attr">&quot;name&quot;</span>:            [jack],<br>    <span class="hljs-attr">&quot;age&quot;</span>:          [<span class="hljs-number">27</span>],<br>    <span class="hljs-attr">&quot;join_date&quot;</span>:      [<span class="hljs-number">2017</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span>],<br>    <span class="hljs-attr">&quot;address.country&quot;</span>:         [china],<br>    <span class="hljs-attr">&quot;address.province&quot;</span>:   [guangdong],<br>    <span class="hljs-attr">&quot;address.city&quot;</span>:  [guangzhou]<br>&#125;<br></code></pre></td></tr></table></figure>

<p>multivalue也可以存储object类型如：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>    <span class="hljs-attr">&quot;authors&quot;</span>: [<br>        &#123; <span class="hljs-attr">&quot;age&quot;</span>: <span class="hljs-number">26</span>, <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;Jack White&quot;</span>&#125;,<br>        &#123; <span class="hljs-attr">&quot;age&quot;</span>: <span class="hljs-number">55</span>, <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;Tom Jones&quot;</span>&#125;,<br>        &#123; <span class="hljs-attr">&quot;age&quot;</span>: <span class="hljs-number">39</span>, <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;Kitty Smith&quot;</span>&#125;<br>    ]<br>&#125;<br></code></pre></td></tr></table></figure>

<p>对应的底层存储结构为：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>    <span class="hljs-attr">&quot;authors.age&quot;</span>:    [<span class="hljs-number">26</span>, <span class="hljs-number">55</span>, <span class="hljs-number">39</span>],<br>    <span class="hljs-attr">&quot;authors.name&quot;</span>:   [jack, white, tom, jones, kitty, smith]<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="倒排索引"><a href="#倒排索引" class="headerlink" title="倒排索引"></a>倒排索引</h4><p>初步的倒排索引的建立示例：</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs applescript">doc1：I really liked <span class="hljs-keyword">my</span> small dogs, <span class="hljs-keyword">and</span> I think <span class="hljs-keyword">my</span> mom also liked them.<br>doc2：He never liked any dogs, so I hope <span class="hljs-keyword">that</span> <span class="hljs-keyword">my</span> mom will <span class="hljs-keyword">not</span> expect <span class="hljs-keyword">me</span> <span class="hljs-keyword">to</span> liked him.<br></code></pre></td></tr></table></figure>

<p>分词后</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs markdown">word		doc1			doc2<br><br>I			<span class="hljs-emphasis">*					*</span><br>really		<span class="hljs-emphasis">*</span><br><span class="hljs-emphasis">liked		*</span>					<span class="hljs-emphasis">*</span><br><span class="hljs-emphasis">my			*</span>					<span class="hljs-emphasis">*</span><br><span class="hljs-emphasis">small		*</span>	<br>dogs		<span class="hljs-emphasis">*</span><br><span class="hljs-emphasis">and			*</span><br>think		<span class="hljs-emphasis">*</span><br><span class="hljs-emphasis">mom			*</span>					<span class="hljs-emphasis">*</span><br><span class="hljs-emphasis">also		*</span><br>them		<span class="hljs-emphasis">*	</span><br><span class="hljs-emphasis">He								*</span><br>never							<span class="hljs-emphasis">*</span><br><span class="hljs-emphasis">any								*</span><br>so								<span class="hljs-emphasis">*</span><br><span class="hljs-emphasis">hope							*</span><br>that							<span class="hljs-emphasis">*</span><br><span class="hljs-emphasis">will							*</span><br>not								<span class="hljs-emphasis">*</span><br><span class="hljs-emphasis">expect							*</span><br>me								<span class="hljs-emphasis">*</span><br><span class="hljs-emphasis">to								*</span><br>him								<span class="hljs-emphasis">*</span><br></code></pre></td></tr></table></figure>

<p>上面只展示了document list相关的内容，但倒排索引还包含更多的东西：</p>
<ol>
<li>包含这个关键词的document list</li>
<li>包含这个关键词的所有document的数量：IDF（inverse document frequency）</li>
<li>这个关键词在每个document中出现的次数：TF（term frequency）</li>
<li>这个关键词在这个document中的次序</li>
<li>每个document的长度：length norm</li>
<li>包含这个关键词的所有document的平均长度</li>
</ol>
<p>倒排索引不可变的好处</p>
<ul>
<li>不需要锁，提升并发能力，避免锁的问题</li>
<li>数据不变，一直保存在os cache中，只要cache内存足够</li>
<li>filter cache一直驻留在内存，因为数据不变</li>
<li>可以压缩，节省cpu和io开销</li>
</ul>
<p>倒排索引不可变的坏处：每次都要重新构建整个索引</p>
<h5 id="normalization"><a href="#normalization" class="headerlink" title="normalization"></a>normalization</h5><p>此时如果搜索mother like little dog，不会匹配到任何结果，但mother和mom、like和liked、little和small、dog和dogs代表的意思并没有任何区别。所以在建立倒排索引的时候，会执行一个操作，对拆分出的各个单词进行相应的处理，以提升后面搜索的时候能够搜索到相关联的文档的概率，这个操作被称为normalization。</p>
<p>比如时态的转换，单复数的转换，同义词的转换，大小写的转换</p>
<figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs axapta">mom —&gt; mother<br>liked —&gt; <span class="hljs-keyword">like</span><br>small —&gt; little<br>dogs —&gt; dog<br></code></pre></td></tr></table></figure>

<p>重新建立倒排索引，加入normalization，再次用mother liked little dog搜索，就可以搜索到了</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs markdown">word		doc1			doc2<br><br>I			<span class="hljs-emphasis">*				*</span><br>really		<span class="hljs-emphasis">*</span><br><span class="hljs-emphasis">like		*</span>				<span class="hljs-emphasis">*				liked --&gt; like</span><br><span class="hljs-emphasis">my			*</span>				<span class="hljs-emphasis">*</span><br><span class="hljs-emphasis">little		*</span>								small --&gt; little<br>dogs		<span class="hljs-emphasis">*								dogs --&gt; dog</span><br><span class="hljs-emphasis">and			*</span><br>think		<span class="hljs-emphasis">*</span><br><span class="hljs-emphasis">mom			*</span>				<span class="hljs-emphasis">*</span><br><span class="hljs-emphasis">also		*</span><br>them		<span class="hljs-emphasis">*	</span><br><span class="hljs-emphasis">He							*</span><br>never						<span class="hljs-emphasis">*</span><br><span class="hljs-emphasis">any							*</span><br>so							<span class="hljs-emphasis">*</span><br><span class="hljs-emphasis">hope						*</span><br>that						<span class="hljs-emphasis">*</span><br><span class="hljs-emphasis">will						*</span><br>not							<span class="hljs-emphasis">*</span><br><span class="hljs-emphasis">expect						*</span><br>me							<span class="hljs-emphasis">*</span><br><span class="hljs-emphasis">to							*</span><br>him							<span class="hljs-emphasis">*</span><br></code></pre></td></tr></table></figure>

<p>同样搜索词mother like little dog经过分词及normalization后</p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xl"><span class="hljs-function"><span class="hljs-title">mother</span>	--&gt;</span> mom<br><span class="hljs-function"><span class="hljs-title">like</span>	--&gt;</span> like<br><span class="hljs-function"><span class="hljs-title">little</span>	--&gt;</span> little<br><span class="hljs-function"><span class="hljs-title">dog</span>	--&gt;</span> dog<br></code></pre></td></tr></table></figure>

<p>doc1和doc2都会搜索出来</p>
<h5 id="分词器"><a href="#分词器" class="headerlink" title="分词器"></a>分词器</h5><p>分词器用于将句子切分为一个个单独的单词，在对每个单词进行normalization（时态转换，单复数转换），提升recall召回率，增加能够搜索到的结果的数量。</p>
<p>执行步骤：</p>
<ul>
<li>character filter：在一段文本进行分词之前，先进行预处理，比如说最常见的就是，过滤html标签（&lt;span&gt;hello&lt;span&gt; –&gt; hello），&amp; –&gt; and（I&amp;you –&gt; I and you）</li>
<li>tokenizer：分词，hello you and me –&gt; hello, you, and, me</li>
<li>token filter：lowercase，stop word，synonymom，dogs –&gt; dog，liked –&gt; like，Tom –&gt; tom，a/the/an –&gt; 干掉，mother –&gt; mom，small –&gt; little</li>
</ul>
<p>倒排索引会根据分词器的处理结果来建立，这就显得分词器比较重要。</p>
<p>内置分词器的介绍</p>
<ul>
<li>Set the shape to semi-transparent by calling set_trans(5)</li>
<li>standard analyzer：set, the, shape, to, semi, transparent, by, calling, set_trans, 5（默认的是standard）</li>
<li>simple analyzer：set, the, shape, to, semi, transparent, by, calling, set, trans</li>
<li>whitespace analyzer：Set, the, shape, to, semi-transparent, by, calling, set_trans(5)</li>
<li>language analyzer（特定的语言的分词器，比如说，english，英语分词器）：set, shape, semi, transpar, call, set_tran, 5</li>
</ul>
<p><strong>query string分词</strong></p>
<p>检索时，query string必须以和index建立时相同的analyzer进行分词，而且对于不同类型的field，也会对query string进行区别对待，可能有的就是full text，有的就是exact value，比如date类型使用exact value。</p>
<p>比如我们有一个document，其中有一个field包含的value是：hello you and me，现在要搜索这个document对应的index，搜索文本是hell me。此时这个搜索文本就是query string，默认情况下，es会使用它对应field建立倒排索引时使用的分词器进行分词和normalization，只有这样，才能实现正确的搜索。</p>
<p>分词器的测试</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-builtin-name">GET</span> /_analyze<br>&#123;<br>  <span class="hljs-string">&quot;analyzer&quot;</span>: <span class="hljs-string">&quot;standard&quot;</span>,<br>  <span class="hljs-string">&quot;text&quot;</span>: <span class="hljs-string">&quot;Text to analyze&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>默认的分词器</p>
<p>standard</p>
<ul>
<li>standard tokenizer：以单词边界进行切分</li>
<li>standard token filter：什么都不做</li>
<li>lowercase token filter：将所有字母转换为小写</li>
<li>stop token filer（默认被禁用）：移除停用词，比如a the it等等</li>
</ul>
<p>修改分词器的设置</p>
<p>启用english停用词token filter</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs dts">PUT /my_index<br>&#123;<br>  <span class="hljs-string">&quot;settings&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;analysis&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;analyzer&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;es_std&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;standard&quot;</span>,<br>          <span class="hljs-string">&quot;stopwords&quot;</span>: <span class="hljs-string">&quot;_english_&quot;</span><br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/my_index/</span>_analyze<br>&#123;<br>  <span class="hljs-string">&quot;analyzer&quot;</span>: <span class="hljs-string">&quot;standard&quot;</span>, <br>  <span class="hljs-string">&quot;text&quot;</span>: <span class="hljs-string">&quot;a dog is in the house&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/my_index/</span>_analyze<br>&#123;<br>  <span class="hljs-string">&quot;analyzer&quot;</span>: <span class="hljs-string">&quot;es_std&quot;</span>,<br>  <span class="hljs-string">&quot;text&quot;</span>:<span class="hljs-string">&quot;a dog is in the house&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>定制化自己的分词器</p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs prolog"><span class="hljs-symbol">PUT</span> /my_index<br>&#123;<br>  <span class="hljs-string">&quot;settings&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;analysis&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;char_filter&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;&amp;_to_and&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;mapping&quot;</span>,<br>          <span class="hljs-string">&quot;mappings&quot;</span>: [<span class="hljs-string">&quot;&amp;=&gt; and&quot;</span>]<br>        &#125;<br>      &#125;,<br>      <span class="hljs-string">&quot;filter&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;my_stopwords&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;stop&quot;</span>,<br>          <span class="hljs-string">&quot;stopwords&quot;</span>: [<span class="hljs-string">&quot;the&quot;</span>, <span class="hljs-string">&quot;a&quot;</span>]<br>        &#125;<br>      &#125;,<br>      <span class="hljs-string">&quot;analyzer&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;my_analyzer&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;custom&quot;</span>,<br>          <span class="hljs-string">&quot;char_filter&quot;</span>: [<span class="hljs-string">&quot;html_strip&quot;</span>, <span class="hljs-string">&quot;&amp;_to_and&quot;</span>],<br>          <span class="hljs-string">&quot;tokenizer&quot;</span>: <span class="hljs-string">&quot;standard&quot;</span>,<br>          <span class="hljs-string">&quot;filter&quot;</span>: [<span class="hljs-string">&quot;lowercase&quot;</span>, <span class="hljs-string">&quot;my_stopwords&quot;</span>]<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/my_index/</span>_analyze<br>&#123;<br>  <span class="hljs-string">&quot;text&quot;</span>: <span class="hljs-string">&quot;tom&amp;jerry are a friend in the house, &lt;a&gt;, HAHA!!&quot;</span>,<br>  <span class="hljs-string">&quot;analyzer&quot;</span>: <span class="hljs-string">&quot;my_analyzer&quot;</span><br>&#125;<br><br>PUT <span class="hljs-regexp">/my_index/</span>_mapping/my_type<br>&#123;<br>  <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;content&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span>,<br>      <span class="hljs-string">&quot;analyzer&quot;</span>: <span class="hljs-string">&quot;my_analyzer&quot;</span><br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>IK中文分词器的安装和使用</strong></p>
<p>在elasticsearch中安装ik中文分词器</p>
<ol>
<li>git clone <a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-ik">https://github.com/medcl/elasticsearch-analysis-ik</a></li>
<li>git checkout tags/v5.2.0</li>
<li>mvn package</li>
<li>将target/releases/elasticsearch-analysis-ik-5.2.0.zip拷贝到es/plugins/ik目录下</li>
<li>在es/plugins/ik下对elasticsearch-analysis-ik-5.2.0.zip进行解压缩</li>
<li>重启es</li>
</ol>
<p>ik共有两种analyzer：</p>
<ul>
<li><p>ik_max_world：会对文本做最细粒度的拆分，比如会将“中华人民共和国国歌”拆分为“中华人民共和国,中华人民,中华,华人,人民共和国,人民,人,民,共和国,共和,和,国国,国歌”，会穷尽各种可能的组合。</p>
</li>
<li><p>ik_smart：会对文本做最粗粒度的拆分，比如会将“中华人民共和国国歌”拆分为“中华人民共和国,国歌”。</p>
</li>
</ul>
<p>建立索引</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs gams"><span class="hljs-keyword">PUT</span> /my_index <br>&#123;<br>  <span class="hljs-string">&quot;mappings&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;my_type&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;text&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span>,<br>          <span class="hljs-string">&quot;analyzer&quot;</span>: <span class="hljs-string">&quot;ik_max_word&quot;</span><br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>放入数据</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs n1ql">POST /my_index/my_type/_bulk<br>&#123; &quot;<span class="hljs-keyword">index</span><span class="hljs-string">&quot;: &#123; &quot;</span>_id<span class="hljs-string">&quot;: &quot;</span><span class="hljs-number">1</span><span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span>text<span class="hljs-string">&quot;: &quot;</span>男子偷上万元发红包求交女友 被抓获时仍然单身<span class="hljs-string">&quot; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">index</span><span class="hljs-string">&quot;: &#123; &quot;</span>_id<span class="hljs-string">&quot;: &quot;</span><span class="hljs-number">2</span><span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span>text<span class="hljs-string">&quot;: &quot;</span><span class="hljs-number">16</span>岁少女为结婚“变”<span class="hljs-number">22</span>岁 <span class="hljs-number">7</span>年后想离婚被法院拒绝<span class="hljs-string">&quot; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">index</span><span class="hljs-string">&quot;: &#123; &quot;</span>_id<span class="hljs-string">&quot;: &quot;</span><span class="hljs-number">3</span><span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span>text<span class="hljs-string">&quot;: &quot;</span>深圳女孩骑车逆行撞奔驰 遭索赔被吓哭(图)<span class="hljs-string">&quot; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">index</span><span class="hljs-string">&quot;: &#123; &quot;</span>_id<span class="hljs-string">&quot;: &quot;</span><span class="hljs-number">4</span><span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span>text<span class="hljs-string">&quot;: &quot;</span>女人对护肤品比对男票好？网友神怼<span class="hljs-string">&quot; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">index</span><span class="hljs-string">&quot;: &#123; &quot;</span>_id<span class="hljs-string">&quot;: &quot;</span><span class="hljs-number">5</span><span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span>text<span class="hljs-string">&quot;: &quot;</span>为什么国内的街道招牌用的都是红黄配？<span class="hljs-string">&quot; &#125;</span><br></code></pre></td></tr></table></figure>

<p>搜索</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/my_index/</span>_analyze<br>&#123;<br>  <span class="hljs-string">&quot;text&quot;</span>: <span class="hljs-string">&quot;男子偷上万元发红包求交女友 被抓获时仍然单身&quot;</span>,<br>  <span class="hljs-string">&quot;analyzer&quot;</span>: <span class="hljs-string">&quot;ik_max_word&quot;</span><br>&#125;<br><br>GET <span class="hljs-regexp">/my_index/my</span>_type/_search <br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;text&quot;</span>: <span class="hljs-string">&quot;16岁少女结婚好还是单身好？&quot;</span><br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>IK分词器的配置</strong></p>
<p>配置文件位于es/plugins/ik/config目录</p>
<ul>
<li>IKAnalyzer.cfg.xml：用来配置自定义词库</li>
<li>main.dic：ik原生内置的中文词库，会按照这些词语去分词</li>
<li>quantifier.dic：单位相关的词</li>
<li>suffix.dic：后缀</li>
<li>surname.dic：中文的姓氏</li>
<li>stopword.dic：英文停用词，停用词不会出现在倒排索引中</li>
<li>preposition.dic：语气词</li>
</ul>
<p>同时，还可以通过修改IkAnalyzer.cfg.xml配置文件来对词库进行扩展。</p>
<ul>
<li>ext_dict：词库扩展</li>
<li>ext_stopwords：停用词扩展</li>
</ul>
<h4 id="正排索引"><a href="#正排索引" class="headerlink" title="正排索引"></a>正排索引</h4><h5 id="doc-value-正排索引"><a href="#doc-value-正排索引" class="headerlink" title="doc value 正排索引"></a>doc value 正排索引</h5><p>假设es内部只使用倒排索引结构，要对搜索出来的结果进行agg聚合操作或者排序操作时，需要获取到对应field的值，倒排索引结构只能通过遍历索引结构，才能得到一个doc的完整field，如果field的类型需要进行分词，还需要获取到所有的term，需要完全遍历完倒排索引结构才能确保拿到的是完整的值，效率十分低下。所以es内部增加了doc value即正排索引来提升整体效率。</p>
<p>在PUT/POST时（index-time）会生成doc value数据。doc value也会写入到磁盘中，然后os cache进行缓存，提升doc value的性能。如果os cache大小不够容纳整个正排索引，就会使用磁盘进行存储。</p>
<p>es并没有使用jvm内存来进行缓存，而是基于os cache来进行缓存，这样可以避免一定的gc开销和oom问题。</p>
<p>在对es的服务器进行配置时，一般给jvm较小的内存，将大部分内存留给os cache，比如64g服务器，给jvm最多16g，其余的内存给os cache。</p>
<p>os cache可以提升doc value和倒排索引的缓存和查询效率</p>
<p>es会对column进行压缩：</p>
<ul>
<li>所有值相同，直接保留单值</li>
<li>少于256个值，使用table encoding模式（压缩方式）</li>
<li>大于256个值，看有没有最大公约数，有就除以最大公约数，然后保留这个最大公约数</li>
</ul>
<p>同时，对于一些聚合操作，可以禁用doc value以减小磁盘和内存占用</p>
<figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs puppet">PUT my_index<br>&#123;<br>  <span class="hljs-string">&quot;mappings&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;my_type&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;my_field&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;type&quot;</span>:       <span class="hljs-string">&quot;keyword&quot;</span><br>          <span class="hljs-string">&quot;doc_values&quot;</span>: false <br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="fielddata原理"><a href="#fielddata原理" class="headerlink" title="fielddata原理"></a>fielddata原理</h5><p>对于分词的field执行aggregation操作，会报错：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/test_index/</span>test_type/_search <br>&#123;<br>  <span class="hljs-string">&quot;aggs&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;group_by_test_field&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;terms&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;test_field&quot;</span><br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;error&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;root_cause&quot;</span>: [<br>      &#123;<br>        <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;illegal_argument_exception&quot;</span>,<br>        <span class="hljs-attr">&quot;reason&quot;</span>: <span class="hljs-string">&quot;Fielddata is disabled on text fields by default. Set fielddata=true on [test_field] in order to load fielddata in memory by uninverting the inverted index. Note that this can however use significant memory.&quot;</span><br>      &#125;<br>    ],<br>    <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;search_phase_execution_exception&quot;</span>,<br>    <span class="hljs-attr">&quot;reason&quot;</span>: <span class="hljs-string">&quot;all shards failed&quot;</span>,<br>    <span class="hljs-attr">&quot;phase&quot;</span>: <span class="hljs-string">&quot;query&quot;</span>,<br>    <span class="hljs-attr">&quot;grouped&quot;</span>: <span class="hljs-literal">true</span>,<br>    <span class="hljs-attr">&quot;failed_shards&quot;</span>: [<br>      &#123;<br>        <span class="hljs-attr">&quot;shard&quot;</span>: <span class="hljs-number">0</span>,<br>        <span class="hljs-attr">&quot;index&quot;</span>: <span class="hljs-string">&quot;test_index&quot;</span>,<br>        <span class="hljs-attr">&quot;node&quot;</span>: <span class="hljs-string">&quot;4onsTYVZTjGvIj9_spWz2w&quot;</span>,<br>        <span class="hljs-attr">&quot;reason&quot;</span>: &#123;<br>          <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;illegal_argument_exception&quot;</span>,<br>          <span class="hljs-attr">&quot;reason&quot;</span>: <span class="hljs-string">&quot;Fielddata is disabled on text fields by default. Set fielddata=true on [test_field] in order to load fielddata in memory by uninverting the inverted index. Note that this can however use significant memory.&quot;</span><br>        &#125;<br>      &#125;<br>    ],<br>    <span class="hljs-attr">&quot;caused_by&quot;</span>: &#123;<br>      <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;illegal_argument_exception&quot;</span>,<br>      <span class="hljs-attr">&quot;reason&quot;</span>: <span class="hljs-string">&quot;Fielddata is disabled on text fields by default. Set fielddata=true on [test_field] in order to load fielddata in memory by uninverting the inverted index. Note that this can however use significant memory.&quot;</span><br>    &#125;<br>  &#125;,<br>  <span class="hljs-attr">&quot;status&quot;</span>: <span class="hljs-number">400</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>报错的大概意思是说，必须要打开fielddata，将正排索引数据加载到内存中，才可以对分词的field执行聚合操作，而且会消耗很大的内存。</p>
<p>设置fielddata=true</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs gradle">POST <span class="hljs-regexp">/test_index/</span>_mapping/test_type <br>&#123;<br>  <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;test_field&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span>,<br>      <span class="hljs-string">&quot;fielddata&quot;</span>: <span class="hljs-keyword">true</span><br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/test_index/</span>test_type/_search <br>&#123;<br>  <span class="hljs-string">&quot;size&quot;</span>: <span class="hljs-number">0</span>, <br>  <span class="hljs-string">&quot;aggs&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;group_by_test_field&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;terms&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;test_field&quot;</span><br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;took&quot;</span>: <span class="hljs-number">23</span>,<br>  <span class="hljs-attr">&quot;timed_out&quot;</span>: <span class="hljs-literal">false</span>,<br>  <span class="hljs-attr">&quot;_shards&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">5</span>,<br>    <span class="hljs-attr">&quot;successful&quot;</span>: <span class="hljs-number">5</span>,<br>    <span class="hljs-attr">&quot;failed&quot;</span>: <span class="hljs-number">0</span><br>  &#125;,<br>  <span class="hljs-attr">&quot;hits&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">2</span>,<br>    <span class="hljs-attr">&quot;max_score&quot;</span>: <span class="hljs-number">0</span>,<br>    <span class="hljs-attr">&quot;hits&quot;</span>: []<br>  &#125;,<br>  <span class="hljs-attr">&quot;aggregations&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;group_by_test_field&quot;</span>: &#123;<br>      <span class="hljs-attr">&quot;doc_count_error_upper_bound&quot;</span>: <span class="hljs-number">0</span>,<br>      <span class="hljs-attr">&quot;sum_other_doc_count&quot;</span>: <span class="hljs-number">0</span>,<br>      <span class="hljs-attr">&quot;buckets&quot;</span>: [<br>        &#123;<br>          <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-string">&quot;test&quot;</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">2</span><br>        &#125;<br>      ]<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>也可以使用内置不分词的field.keyword进行聚合</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/test_index/</span>test_type/_search <br>&#123;<br>  <span class="hljs-string">&quot;size&quot;</span>: <span class="hljs-number">0</span>,<br>  <span class="hljs-string">&quot;aggs&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;group_by_test_field&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;terms&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;test_field.keyword&quot;</span><br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;took&quot;</span>: <span class="hljs-number">3</span>,<br>  <span class="hljs-attr">&quot;timed_out&quot;</span>: <span class="hljs-literal">false</span>,<br>  <span class="hljs-attr">&quot;_shards&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">5</span>,<br>    <span class="hljs-attr">&quot;successful&quot;</span>: <span class="hljs-number">5</span>,<br>    <span class="hljs-attr">&quot;failed&quot;</span>: <span class="hljs-number">0</span><br>  &#125;,<br>  <span class="hljs-attr">&quot;hits&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">2</span>,<br>    <span class="hljs-attr">&quot;max_score&quot;</span>: <span class="hljs-number">0</span>,<br>    <span class="hljs-attr">&quot;hits&quot;</span>: []<br>  &#125;,<br>  <span class="hljs-attr">&quot;aggregations&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;group_by_test_field&quot;</span>: &#123;<br>      <span class="hljs-attr">&quot;doc_count_error_upper_bound&quot;</span>: <span class="hljs-number">0</span>,<br>      <span class="hljs-attr">&quot;sum_other_doc_count&quot;</span>: <span class="hljs-number">0</span>,<br>      <span class="hljs-attr">&quot;buckets&quot;</span>: [<br>        &#123;<br>          <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-string">&quot;test&quot;</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">2</span><br>        &#125;<br>      ]<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>原理</strong></p>
<p>对于不需要分词的field，在index-time，就会自动生成doc value，对这些不分词的field执行聚合操作的时候，自动就会用doc value来执行。</p>
<p>对于需要分词field，在index-time，不会生成doc value，因为分词后，占用的空间过大，所以默认是不支持分词field进行聚合的。</p>
<p>如果一定要对分词的field执行聚合，那么必须将fielddata=true，然后es就会在执行聚合操作的时候，会将field对应的数据，建立一份fielddata正排索引，fielddata正排索引的结构跟doc value是类似的，但是只会将fielddata正排索引加载到内存中来，然后基于内存中的fielddata正排索引执行分词field的聚合操作。fielddata需要按照term进行聚合，需要执行更加复杂的算法和操作，如果基于磁盘和os cache，性能会很差。</p>
<p>fielddata加载到内存的过程是lazy加载的，对一个analzyed field执行聚合时，才会加载，而且是field-level加载的<br>一个index的一个field，所有doc都会被加载，而不是少数doc，在index-time不会创建，而是在query-time创建。</p>
<p><strong>内存限制</strong></p>
<p>可以通过elasticsearch.xml中的<code>indices.fielddata.cache.size: 20%</code>配置，对fielddata占用的内存进行限制，如果fielddata占用的内存超出了这个比例的限制，那么就清除掉内存中已有的fielddata数据。默认是无限制的，对限制内存使用，会导致频繁evict和reload、大量IO性能损耗以及内存碎片和gc。</p>
<p>监控fielddata内存使用</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-builtin-name">GET</span> /_stats/fielddata?<span class="hljs-attribute">fields</span>=*<br><span class="hljs-builtin-name">GET</span> /_nodes/stats/indices/fielddata?<span class="hljs-attribute">fields</span>=*<br><span class="hljs-builtin-name">GET</span> /_nodes/stats/indices/fielddata?<span class="hljs-attribute">level</span>=indices&amp;fields=*<br></code></pre></td></tr></table></figure>

<p>circuit breaker断路器</p>
<p>为了避免查询时fielddata占用内存过高引起的oom，circuit breaker会估算query要加载的fielddata大小，如果超出总内存，则本次query直接失败。</p>
<p>indices.breaker.fielddata.limit：fielddata的内存限制，默认60%<br>indices.breaker.request.limit：执行聚合的内存限制，默认40%<br>indices.breaker.total.limit：综合上面两个，限制在70%以内</p>
<p>建立索引时的限制</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs awk">POST <span class="hljs-regexp">/test_index/</span>_mapping/my_type<br>&#123;<br>  <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;my_field&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span>,<br>      <span class="hljs-string">&quot;fielddata&quot;</span>: &#123; <br>        <span class="hljs-string">&quot;filter&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;frequency&quot;</span>: &#123; <br>            <span class="hljs-string">&quot;min&quot;</span>:              <span class="hljs-number">0.01</span>, <br>            <span class="hljs-string">&quot;min_segment_size&quot;</span>: <span class="hljs-number">500</span>  <br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>其中：</p>
<ul>
<li>min：至少在1%的doc中出现的term才会被加载</li>
<li>min_segment_size：少于500 doc的segment不加载fielddata</li>
</ul>
<p>这两个参数比价底层，一般不会设置。</p>
<p><strong>预加载</strong></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs awk">POST <span class="hljs-regexp">/test_index/</span>_mapping/test_type<br>&#123;<br>  <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;test_field&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;string&quot;</span>,<br>      <span class="hljs-string">&quot;fielddata&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;loading&quot;</span> : <span class="hljs-string">&quot;eager&quot;</span> <br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>fielddata生成和加载到内存，由query-time变为index-time，建立倒排索引的时候，会同步生成fielddata并且加载到内存中来，能够提升对分词field的聚合性能。</p>
<p>全局标记预加载，global ordinal</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs awk">POST <span class="hljs-regexp">/test_index/</span>_mapping/test_type<br>&#123;<br>  <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;test_field&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;string&quot;</span>,<br>      <span class="hljs-string">&quot;fielddata&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;loading&quot;</span> : <span class="hljs-string">&quot;eager_global_ordinals&quot;</span> <br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>对于有很多重复值的情况，global ordinal会进行转换，比如：</p>
<p>doc1: status1<br>doc2: status2<br>doc3: status2<br>doc4: status1</p>
<p>会变为</p>
<p>doc1: 0<br>doc2: 1<br>doc3: 1<br>doc4: 0</p>
<p>这样的好处就是减少重复字符串的出现的次数，减少内存的消耗。</p>
<h4 id="type底层结构"><a href="#type底层结构" class="headerlink" title="type底层结构"></a>type底层结构</h4><p>type是一个index中用来区分类似的数据的，不同数据fields不完全相同，需要用不同的属性来控制索引建立，以及分词器的使用。</p>
<p>field的value，在底层的lucene中建立索引的时候，全部是opaque bytes类型，不区分类型，lucene是没有type的概念的，在document中，实际上将type作为一个document的field来存储，即_type，es通过_type来进行type的过滤和筛选。</p>
<p>一个index中的多个type，实际上是放在一起存储的，因此一个index下，不能有多个type重名，但类型或者其他设置不同的，因为那样是无法处理的。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>   <span class="hljs-attr">&quot;ecommerce&quot;</span>: &#123;<br>      <span class="hljs-attr">&quot;mappings&quot;</span>: &#123;<br>         <span class="hljs-attr">&quot;elactronic_goods&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;properties&quot;</span>: &#123;<br>               <span class="hljs-attr">&quot;name&quot;</span>: &#123;<br>                  <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;string&quot;</span>,<br>               &#125;,<br>               <span class="hljs-attr">&quot;price&quot;</span>: &#123;<br>                  <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;double&quot;</span><br>               &#125;,<br>	       <span class="hljs-attr">&quot;service_period&quot;</span>: &#123;<br>		  <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;string&quot;</span><br>	       &#125;			<br>            &#125;<br>         &#125;,<br>         <span class="hljs-attr">&quot;fresh_goods&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;properties&quot;</span>: &#123;<br>               <span class="hljs-attr">&quot;name&quot;</span>: &#123;<br>                  <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;string&quot;</span>,<br>               &#125;,<br>               <span class="hljs-attr">&quot;price&quot;</span>: &#123;<br>                  <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;double&quot;</span><br>               &#125;,<br>	       <span class="hljs-attr">&quot;eat_period&quot;</span>: &#123;<br>		  <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;string&quot;</span><br>	       &#125;<br>            &#125;<br>         &#125;<br>      &#125;<br>   &#125;<br>&#125;<br><br>&#123;<br>  <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;geli kongtiao&quot;</span>,<br>  <span class="hljs-attr">&quot;price&quot;</span>: <span class="hljs-number">1999.0</span>,<br>  <span class="hljs-attr">&quot;service_period&quot;</span>: <span class="hljs-string">&quot;one year&quot;</span><br>&#125;<br><br>&#123;<br>  <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;aozhou dalongxia&quot;</span>,<br>  <span class="hljs-attr">&quot;price&quot;</span>: <span class="hljs-number">199.0</span>,<br>  <span class="hljs-attr">&quot;eat_period&quot;</span>: <span class="hljs-string">&quot;one week&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>在底层的存储</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>   <span class="hljs-attr">&quot;ecommerce&quot;</span>: &#123;<br>      <span class="hljs-attr">&quot;mappings&quot;</span>: &#123;<br>        <span class="hljs-attr">&quot;_type&quot;</span>: &#123;<br>          <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;string&quot;</span>,<br>          <span class="hljs-attr">&quot;index&quot;</span>: <span class="hljs-string">&quot;not_analyzed&quot;</span><br>        &#125;,<br>        <span class="hljs-attr">&quot;name&quot;</span>: &#123;<br>          <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;string&quot;</span><br>        &#125;<br>        <span class="hljs-string">&quot;price&quot;</span>: &#123;<br>          <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;double&quot;</span><br>        &#125;<br>        <span class="hljs-string">&quot;service_period&quot;</span>: &#123;<br>          <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;string&quot;</span><br>        &#125;<br>        <span class="hljs-string">&quot;eat_period&quot;</span>: &#123;<br>          <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;string&quot;</span><br>        &#125;<br>      &#125;<br>   &#125;<br>&#125;<br><br>&#123;<br>  <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;elactronic_goods&quot;</span>,<br>  <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;geli kongtiao&quot;</span>,<br>  <span class="hljs-attr">&quot;price&quot;</span>: <span class="hljs-number">1999.0</span>,<br>  <span class="hljs-attr">&quot;service_period&quot;</span>: <span class="hljs-string">&quot;one year&quot;</span>,<br>  <span class="hljs-attr">&quot;eat_period&quot;</span>: <span class="hljs-string">&quot;&quot;</span><br>&#125;<br><br>&#123;<br>  <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;fresh_goods&quot;</span>,<br>  <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;aozhou dalongxia&quot;</span>,<br>  <span class="hljs-attr">&quot;price&quot;</span>: <span class="hljs-number">199.0</span>,<br>  <span class="hljs-attr">&quot;service_period&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,<br>  <span class="hljs-attr">&quot;eat_period&quot;</span>: <span class="hljs-string">&quot;one week&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>如果将两个type的field完全不同，放在一个index下，那么就每条数据都至少有一半的field在底层的lucene中是空值，会有严重的性能问题。</p>
<h4 id="mapping-root-object"><a href="#mapping-root-object" class="headerlink" title="_mapping root object"></a>_mapping root object</h4><p>root object就是某个type对应的mapping json，包括了properties，metadata（_id，_source，_type），settings（analyzer），其他settings（比如include_in_all）</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs dts">PUT /my_index<br>&#123;<br>  <span class="hljs-string">&quot;mappings&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;my_type&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;properties&quot;</span>: &#123;&#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="properties"><a href="#properties" class="headerlink" title="properties"></a>properties</h5><figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs elm"><span class="hljs-keyword">type</span>，index，analyzer<br><br><span class="hljs-type">PUT</span> /my_index/_mapping/my_<span class="hljs-keyword">type</span><br>&#123;<br>  <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;title&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span><br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="source"><a href="#source" class="headerlink" title="_source"></a>_source</h5><p>好处</p>
<p>（1）查询的时候，直接可以拿到完整的document，不需要先拿document id，再发送一次请求拿document<br>（2）partial update基于_source实现<br>（3）reindex时，直接基于_source实现，不需要从数据库（或者其他外部存储）查询数据再修改<br>（4）可以基于_source定制返回field<br>（5）debug query更容易，因为可以直接看到_source</p>
<p>如果不需要上述好处，可以禁用_source</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs gradle">PUT <span class="hljs-regexp">/my_index/</span>_mapping/my_type2<br>&#123;<br>  <span class="hljs-string">&quot;_source&quot;</span>: &#123;<span class="hljs-string">&quot;enabled&quot;</span>: <span class="hljs-keyword">false</span>&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="all"><a href="#all" class="headerlink" title="_all"></a>_all</h5><p>将所有field打包在一起，作为一个_all field，建立索引。没指定任何field进行搜索时，就是使用_all field在搜索。</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs gradle">PUT <span class="hljs-regexp">/my_index/</span>_mapping/my_type3<br>&#123;<br>  <span class="hljs-string">&quot;_all&quot;</span>: &#123;<span class="hljs-string">&quot;enabled&quot;</span>: <span class="hljs-keyword">false</span>&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>也可以在field级别设置include_in_all field，设置是否要将field的值包含在_all field中</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs gradle">PUT <span class="hljs-regexp">/my_index/</span>_mapping/my_type4<br>&#123;<br>  <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;my_field&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span>,<br>      <span class="hljs-string">&quot;include_in_all&quot;</span>: <span class="hljs-keyword">false</span><br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="标识性metadata"><a href="#标识性metadata" class="headerlink" title="标识性metadata"></a>标识性metadata</h5><p>_index，_type，_id</p>
<h4 id="重建索引"><a href="#重建索引" class="headerlink" title="重建索引"></a>重建索引</h4><p>一个field的设置是不能被修改的，如果要修改一个Field，那么应该重新按照新的mapping，建立一个index，然后将数据批量查询出来，重新用bulk api写入index中</p>
<p>批量查询的时候，建议采用scroll api，并且采用多线程并发的方式来reindex数据，每次scoll就查询指定日期的一段数据，交给一个线程即可。</p>
<p>重建过程</p>
<ol>
<li><p>一开始，依靠dynamic mapping，插入数据，但是有些数据是2017-01-01这种日期格式的，所以title这种field被自动映射为了date类型，实际上它应该是string类型的</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs awk">PUT <span class="hljs-regexp">/my_index/my</span>_type/<span class="hljs-number">3</span><br>&#123;<br>  <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;2017-01-03&quot;</span><br>&#125;<br><br>&#123;<br>  <span class="hljs-string">&quot;my_index&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;mappings&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;my_type&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;title&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;date&quot;</span><br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>当后期向索引中加入string类型的title值的时候，就会报错</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs awk">PUT <span class="hljs-regexp">/my_index/my</span>_type/<span class="hljs-number">4</span><br>&#123;<br>  <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;my first article&quot;</span><br>&#125;<br><br>&#123;<br>  <span class="hljs-string">&quot;error&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;root_cause&quot;</span>: [<br>      &#123;<br>        <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;mapper_parsing_exception&quot;</span>,<br>        <span class="hljs-string">&quot;reason&quot;</span>: <span class="hljs-string">&quot;failed to parse [title]&quot;</span><br>      &#125;<br>    ],<br>    <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;mapper_parsing_exception&quot;</span>,<br>    <span class="hljs-string">&quot;reason&quot;</span>: <span class="hljs-string">&quot;failed to parse [title]&quot;</span>,<br>    <span class="hljs-string">&quot;caused_by&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;illegal_argument_exception&quot;</span>,<br>      <span class="hljs-string">&quot;reason&quot;</span>: <span class="hljs-string">&quot;Invalid format: \&quot;my first article\&quot;&quot;</span><br>    &#125;<br>  &#125;,<br>  <span class="hljs-string">&quot;status&quot;</span>: <span class="hljs-number">400</span><br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>如果此时想修改title的类型，是不可能的</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs awk">PUT <span class="hljs-regexp">/my_index/</span>_mapping/my_type<br>&#123;<br>  <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;title&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span><br>    &#125;<br>  &#125;<br>&#125;<br><br>&#123;<br>  <span class="hljs-string">&quot;error&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;root_cause&quot;</span>: [<br>      &#123;<br>        <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;illegal_argument_exception&quot;</span>,<br>        <span class="hljs-string">&quot;reason&quot;</span>: <span class="hljs-string">&quot;mapper [title] of different type, current_type [date], merged_type [text]&quot;</span><br>      &#125;<br>    ],<br>    <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;illegal_argument_exception&quot;</span>,<br>    <span class="hljs-string">&quot;reason&quot;</span>: <span class="hljs-string">&quot;mapper [title] of different type, current_type [date], merged_type [text]&quot;</span><br>  &#125;,<br>  <span class="hljs-string">&quot;status&quot;</span>: <span class="hljs-number">400</span><br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>此时，唯一的办法，就是进行reindex，也就是说，重新建立一个索引，将旧索引的数据查询出来，再导入新索引</p>
</li>
<li><p>如果说旧索引的名字，是old_index，新索引的名字是new_index，终端java应用，已经在使用old_index在操作了，难道还要去停止java应用，修改使用的index为new_index，才重新启动java应用吗？这个过程中，就会导致java应用停机，可用性降低</p>
</li>
<li><p>所以说，给java应用一个别名，这个别名是指向旧索引的，java应用先用着，java应用先用goods_index alias来操作，此时实际指向的是旧的my_index</p>
<p>PUT /my_index/_alias/goods_index</p>
</li>
<li><p>新建一个index，调整其title的类型为string</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs dts">PUT /my_index_new<br>&#123;<br>  <span class="hljs-string">&quot;mappings&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;my_type&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;title&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span><br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>使用scroll api将数据批量查询出来</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-builtin-name">GET</span> /my_index/_search?<span class="hljs-attribute">scroll</span>=1m<br>&#123;<br>    <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;match_all&quot;</span>: &#123;&#125;<br>    &#125;,<br>    <span class="hljs-string">&quot;sort&quot;</span>: [<span class="hljs-string">&quot;_doc&quot;</span>],<br>    <span class="hljs-string">&quot;size&quot;</span>:  1<br>&#125;<br><br>&#123;<br>  <span class="hljs-string">&quot;_scroll_id&quot;</span>: <span class="hljs-string">&quot;DnF1ZXJ5VGhlbkZldGNoBQAAAAAAADpAFjRvbnNUWVZaVGpHdklqOV9zcFd6MncAAAAAAAA6QRY0b25zVFlWWlRqR3ZJajlfc3BXejJ3AAAAAAAAOkIWNG9uc1RZVlpUakd2SWo5X3NwV3oydwAAAAAAADpDFjRvbnNUWVZaVGpHdklqOV9zcFd6MncAAAAAAAA6RBY0b25zVFlWWlRqR3ZJajlfc3BXejJ3&quot;</span>,<br>  <span class="hljs-string">&quot;took&quot;</span>: 1,<br>  <span class="hljs-string">&quot;timed_out&quot;</span>: <span class="hljs-literal">false</span>,<br>  <span class="hljs-string">&quot;_shards&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;total&quot;</span>: 5,<br>    <span class="hljs-string">&quot;successful&quot;</span>: 5,<br>    <span class="hljs-string">&quot;failed&quot;</span>: 0<br>  &#125;,<br>  <span class="hljs-string">&quot;hits&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;total&quot;</span>: 3,<br>    <span class="hljs-string">&quot;max_score&quot;</span>: <span class="hljs-literal">null</span>,<br>    <span class="hljs-string">&quot;hits&quot;</span>: [<br>      &#123;<br>        <span class="hljs-string">&quot;_index&quot;</span>: <span class="hljs-string">&quot;my_index&quot;</span>,<br>        <span class="hljs-string">&quot;_type&quot;</span>: <span class="hljs-string">&quot;my_type&quot;</span>,<br>        <span class="hljs-string">&quot;_id&quot;</span>: <span class="hljs-string">&quot;2&quot;</span>,<br>        <span class="hljs-string">&quot;_score&quot;</span>: <span class="hljs-literal">null</span>,<br>        <span class="hljs-string">&quot;_source&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;2017-01-02&quot;</span><br>        &#125;,<br>        <span class="hljs-string">&quot;sort&quot;</span>: [<br>          0<br>        ]<br>      &#125;<br>    ]<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>采用bulk api将scoll查出来的一批数据，批量写入新索引</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs dts">POST /_bulk<br>&#123; <span class="hljs-string">&quot;index&quot;</span>:  &#123; <span class="hljs-string">&quot;_index&quot;</span>: <span class="hljs-string">&quot;my_index_new&quot;</span>, <span class="hljs-string">&quot;_type&quot;</span>: <span class="hljs-string">&quot;my_type&quot;</span>, <span class="hljs-string">&quot;_id&quot;</span>: <span class="hljs-string">&quot;2&quot;</span> &#125;&#125;<br>&#123; <span class="hljs-string">&quot;title&quot;</span>:    <span class="hljs-string">&quot;2017-01-02&quot;</span> &#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>反复循环8~9，查询一批又一批的数据出来，采取bulk api将每一批数据批量写入新索引</p>
</li>
<li><p>将goods_index alias切换到my_index_new上去，java应用会直接通过index别名使用新的索引中的数据，java应用程序不需要停机，零提交，高可用</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs dts">POST /_aliases<br>&#123;<br>    <span class="hljs-string">&quot;actions&quot;</span>: [<br>        &#123; <span class="hljs-string">&quot;remove&quot;</span>: &#123; <span class="hljs-string">&quot;index&quot;</span>: <span class="hljs-string">&quot;my_index&quot;</span>, <span class="hljs-string">&quot;alias&quot;</span>: <span class="hljs-string">&quot;goods_index&quot;</span> &#125;&#125;,<br>        &#123; <span class="hljs-string">&quot;add&quot;</span>:    &#123; <span class="hljs-string">&quot;index&quot;</span>: <span class="hljs-string">&quot;my_index_new&quot;</span>, <span class="hljs-string">&quot;alias&quot;</span>: <span class="hljs-string">&quot;goods_index&quot;</span> &#125;&#125;<br>    ]<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>直接通过goods_index别名来查询，是否ok</p>
<p>GET /goods_index/my_type/_search</p>
</li>
<li><p>基于alias对client透明切换index</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-symbol">PUT</span> /my_index_v1/_<span class="hljs-meta">alias</span>/my_index<br><br><span class="hljs-symbol">client</span>对my_index进行操作<br><br><span class="hljs-symbol">reindex</span>操作，完成之后，切换<span class="hljs-built_in">v1</span>到<span class="hljs-built_in">v2</span><br><br><span class="hljs-symbol">POST</span> /_aliases<br>&#123;<br>    <span class="hljs-string">&quot;actions&quot;</span>: [<br>        &#123; <span class="hljs-string">&quot;remove&quot;</span>: &#123; <span class="hljs-string">&quot;index&quot;</span>: <span class="hljs-string">&quot;my_index_v1&quot;</span>, <span class="hljs-string">&quot;alias&quot;</span>: <span class="hljs-string">&quot;my_index&quot;</span> &#125;&#125;,<br>        &#123; <span class="hljs-string">&quot;add&quot;</span>:    &#123; <span class="hljs-string">&quot;index&quot;</span>: <span class="hljs-string">&quot;my_index_v2&quot;</span>, <span class="hljs-string">&quot;alias&quot;</span>: <span class="hljs-string">&quot;my_index&quot;</span> &#125;&#125;<br>    ]<br>&#125;<br></code></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="document写入原理"><a href="#document写入原理" class="headerlink" title="document写入原理"></a>document写入原理</h3><ol>
<li>数据写入buffer中</li>
<li>触发commit point，将buffer中的数据写入新的index segment</li>
<li>等待在os cache中的index segment被fsync强制刷到磁盘上</li>
<li>新的index sgement被打开，供search使用</li>
<li>buffer被清空</li>
</ol>
<p>每次commit point时，会有一个.del文件，标记了哪些segment中的哪些document被标记为deleted了<br>搜索的时候，会依次查询所有的segment，从旧的到新的，比如被修改过的document，在旧的segment中，会标记为deleted，在新的segment中会有其新的数据</p>
<p><img src="/blog/2022/10/12/Elasticsearch/elasticsearch%E5%9F%BA%E7%A1%80/document%E5%A2%9E%E5%88%A0%E6%94%B9%E5%86%85%E6%A0%B8%E7%BA%A7%E5%8E%9F%E7%90%86.png" srcset="/blog/img/loading.gif" lazyload alt="document增删改内核级原理"></p>
<p>现有流程的问题，每次都必须等待fsync将segment刷入磁盘，才能将segment打开供search使用，这样的话，从一个document写入，到它可以被搜索，可能会超过1分钟。这就不是近实时的搜索了，主要是因为fsync实际发生磁盘IO写数据进磁盘时比较耗时。</p>
<p>写入流程别改进如下：</p>
<ol>
<li>数据写入buffer</li>
<li>每隔一定时间，将buffer中的数据写入segment文件，但是只写入os cache中，并不直接写到磁盘上</li>
<li>只要segment写入os cache，那就直接打开供search使用，不立即执行commit</li>
</ol>
<p>数据写入os cache，并被打开供搜索的过程，叫做refresh，默认是每隔1秒refresh一次。也就是说，每隔一秒就会将buffer中的数据写入一个新的index segment file，先写入os cache中。这样就可以实现近实时，数据写入到可以被搜索是1秒左右。</p>
<p>POST /my_index/_refresh，可以手动refresh，一般不需要手动执行，没必要，让es自己搞就可以了</p>
<p>比如说，我们现在的时效性要求，比较低，只要求一条数据写入es，一分钟以后才让我们搜索到就可以了，那么就可以调整refresh interval</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs dts">PUT /my_index<br>&#123;<br>  <span class="hljs-string">&quot;settings&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;refresh_interval&quot;</span>: <span class="hljs-string">&quot;30s&quot;</span> <br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/blog/2022/10/12/Elasticsearch/elasticsearch%E5%9F%BA%E7%A1%80/NRT%E5%86%99%E5%85%A5%E4%BC%98%E5%8C%96.png" srcset="/blog/img/loading.gif" lazyload alt="NRT写入优化"></p>
<p>再次优化的写入流程</p>
<ol>
<li>数据首先写入buffer缓冲和translog日志文件</li>
<li>每隔一秒钟，buffer中的数据被写入新的segment file，并进入os cache，此时打开segment供search使用。</li>
<li>清空buffer</li>
<li>重复1~3，buffer中的数据不断的写入os cache，然后buffer清空，但translog中的数据不断累加</li>
<li>当translog长度达到一定程度的时候，commit操作发生<ol>
<li>首先将当前buffer中的所有数据写入一个新的segment，并写入os cache，并打开供使用</li>
<li>清空buffer</li>
<li>创建commit ponit被写入磁盘，标明将要写入磁盘的index segment</li>
<li>os cache中的所有segment file数据，被fsync强行刷到磁盘上</li>
<li>清空现有的translog，创建一个新的translog</li>
</ol>
</li>
</ol>
<p>基于translog和commit point，如何进行数据恢复</p>
<p>![](elasticsearch基础/commit point+translog进行数据恢复-7157963.png)</p>
<p>fsync+清空translog，就是flush，默认每隔30分钟flush一次，或者当translog过大的时候，也会flush</p>
<p>POST /my_index/_flush，一般来说别手动flush，让它自动执行就可以了</p>
<p>translog，每隔5秒被fsync一次到磁盘上。在一次增删改操作之后，当fsync在primary shard和replica shard都成功之后，那次增删改操作才会成功</p>
<p>但是这种在一次增删改时强行fsync translog可能会导致部分操作比较耗时，也可以允许部分数据丢失，设置异步fsync translog</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk">PUT <span class="hljs-regexp">/my_index/</span>_settings<br>&#123;<br>    <span class="hljs-string">&quot;index.translog.durability&quot;</span>: <span class="hljs-string">&quot;async&quot;</span>,<br>    <span class="hljs-string">&quot;index.translog.sync_interval&quot;</span>: <span class="hljs-string">&quot;5s&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/blog/2022/10/12/Elasticsearch/elasticsearch%E5%9F%BA%E7%A1%80/%E7%BB%88%E6%9E%81%E7%89%88%E6%9C%AC%E7%9A%84es%E6%95%B0%E6%8D%AE%E5%86%99%E5%85%A5%E6%B5%81%E7%A8%8B.png" srcset="/blog/img/loading.gif" lazyload alt="终极版本的es数据写入流程"></p>
<p>如果每秒生成一个segment file，这样的话会产生很多的segment file，而且每次search都要搜索所有的segment会对搜索性能产生影响。</p>
<p>默认会在后台执行segment merge操作，在merge的时候，被标记为deleted的document也会被彻底物理删除</p>
<p>每次merge操作的执行流程</p>
<ol>
<li>选择一些有相似大小的segment进行merge，生成新的segment</li>
<li>将新的segment flush到磁盘上去</li>
<li>写一个新的commit point到磁盘上，标明新创建的segment以及旧的segment</li>
<li>将新的segment打开供搜索</li>
<li>将旧的segment删除</li>
</ol>
<p>可以通过POST /my_index/_optimize?max_num_segments=1，去触发merge操作，但尽量不要手动执行，让它自动默认执行就可以了</p>
<p>![segment merge](elasticsearch基础/segment merge.png)</p>
<h3 id="海量bucket优化机制-深度优先与广度优先"><a href="#海量bucket优化机制-深度优先与广度优先" class="headerlink" title="海量bucket优化机制 深度优先与广度优先"></a>海量bucket优化机制 深度优先与广度优先</h3><p>比如取评论数排名前10的演员，每个演员取评论数排名前5的电影</p>
<p>评论数量排名前10个的演员 –&gt; 每个演员的电影取到评论数量排名前5的电影</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;aggs&quot;</span> : &#123;<br>    <span class="hljs-attr">&quot;actors&quot;</span> : &#123;<br>      <span class="hljs-attr">&quot;terms&quot;</span> : &#123;<br>         <span class="hljs-attr">&quot;field&quot;</span> :        <span class="hljs-string">&quot;actors&quot;</span>,<br>         <span class="hljs-attr">&quot;size&quot;</span> :         <span class="hljs-number">10</span>,<br>         <span class="hljs-attr">&quot;collect_mode&quot;</span> : <span class="hljs-string">&quot;breadth_first&quot;</span> <br>      &#125;,<br>      <span class="hljs-attr">&quot;aggs&quot;</span> : &#123;<br>        <span class="hljs-attr">&quot;costars&quot;</span> : &#123;<br>          <span class="hljs-attr">&quot;terms&quot;</span> : &#123;<br>            <span class="hljs-attr">&quot;field&quot;</span> : <span class="hljs-string">&quot;films&quot;</span>,<br>            <span class="hljs-attr">&quot;size&quot;</span> :  <span class="hljs-number">5</span><br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>深度优先的执行过程：</p>
<p>比如有10万个actor，每个actor平均有10部电影，这时会构建出110万数据量的一棵树，然后进行裁剪。最终10万的actor只剩10个，每个actor的film裁剪掉5个，相当于从110万数据中，裁剪出50个。</p>
<p>广度优先的执行过程：</p>
<p>首先10万个actor，不去构建它下面的film数据，先进性actor的裁剪，然后再对裁剪完成后的actor构建出film，裁剪出其中的5个film，相当于只从10万数据中，裁剪出50个，性能占用较少。</p>
<h3 id="基础操作"><a href="#基础操作" class="headerlink" title="基础操作"></a>基础操作</h3><h4 id="index操作"><a href="#index操作" class="headerlink" title="index操作"></a>index操作</h4><p>查看集群中的index</p>
<p>GET /_cat/indices?v</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">health</span> status index   uuid                   pri rep docs.count docs.deleted store.size pri.store.size<br><span class="hljs-attribute">yellow</span> open   .kibana NWZExo<span class="hljs-number">60</span>SwuTMSTcndyXyQ   <span class="hljs-number">1</span>   <span class="hljs-number">1</span>          <span class="hljs-number">1</span>            <span class="hljs-number">0</span>      <span class="hljs-number">3</span>.<span class="hljs-number">2</span>kb          <span class="hljs-number">3</span>.<span class="hljs-number">2</span>kb<br></code></pre></td></tr></table></figure>

<p>创建index的语法</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">PUT <span class="hljs-string">/my_index</span><br>&#123;<br>    <span class="hljs-string">&quot;settings&quot;</span>: &#123; <span class="hljs-string">...</span> any settings <span class="hljs-string">...</span> &#125;,<br>    <span class="hljs-string">&quot;mappings&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;type_one&quot;</span>: &#123; <span class="hljs-string">...</span> any mappings <span class="hljs-string">...</span> &#125;,<br>        <span class="hljs-string">&quot;type_two&quot;</span>: &#123; <span class="hljs-string">...</span> any mappings <span class="hljs-string">...</span> &#125;,<br>        <span class="hljs-string">...</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>创建index的示例</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs dts">PUT /my_index<br>&#123;<br>  <span class="hljs-string">&quot;settings&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;number_of_shards&quot;</span>: <span class="hljs-number">1</span>,<br>    <span class="hljs-string">&quot;number_of_replicas&quot;</span>: <span class="hljs-number">0</span><br>  &#125;,<br>  <span class="hljs-string">&quot;mappings&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;my_type&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;my_field&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span><br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>修改index</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs awk">PUT <span class="hljs-regexp">/my_index/</span>_settings<br>&#123;<br>    <span class="hljs-string">&quot;number_of_replicas&quot;</span>: <span class="hljs-number">1</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>删除index</p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs gauss"><span class="hljs-keyword">DELETE</span> /my_index<br><span class="hljs-keyword">DELETE</span> /index_one,index_two<br><span class="hljs-keyword">DELETE</span> /index_*<br><span class="hljs-keyword">DELETE</span> /_all<br></code></pre></td></tr></table></figure>

<p>elasticsearch.yml</p>
<p>action.destructive_requires_name: true</p>
<h4 id="docuement操作"><a href="#docuement操作" class="headerlink" title="docuement操作"></a>docuement操作</h4><p>在es中document是不可变的，对es的修改或者替换都会将老的document标记为deleted，然后新增一个document，es会在适当的时机在后台自动删除标记为deleted的document。</p>
<p>新增document，格式为：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs awk">PUT <span class="hljs-regexp">/index/</span>type/id<br>&#123;<br>  <span class="hljs-string">&quot;json数据&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>比如</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs awk">put <span class="hljs-regexp">/ecommerce/</span>product/<span class="hljs-number">1</span><br>&#123;<br>    <span class="hljs-string">&quot;name&quot;</span> : <span class="hljs-string">&quot;gaolujie yagao&quot;</span>,<br>    <span class="hljs-string">&quot;desc&quot;</span> :  <span class="hljs-string">&quot;gaoxiao meibai&quot;</span>,<br>    <span class="hljs-string">&quot;price&quot;</span> :  <span class="hljs-number">30</span>,<br>    <span class="hljs-string">&quot;producer&quot;</span> :      <span class="hljs-string">&quot;gaolujie producer&quot;</span>,<br>    <span class="hljs-string">&quot;tags&quot;</span>: [ <span class="hljs-string">&quot;meibai&quot;</span>, <span class="hljs-string">&quot;fangzhu&quot;</span> ]<br>&#125;<br>PUT <span class="hljs-regexp">/ecommerce/</span>product/<span class="hljs-number">2</span><br>&#123;<br>    <span class="hljs-string">&quot;name&quot;</span> : <span class="hljs-string">&quot;jiajieshi yagao&quot;</span>,<br>    <span class="hljs-string">&quot;desc&quot;</span> :  <span class="hljs-string">&quot;youxiao fangzhu&quot;</span>,<br>    <span class="hljs-string">&quot;price&quot;</span> :  <span class="hljs-number">25</span>,<br>    <span class="hljs-string">&quot;producer&quot;</span> :      <span class="hljs-string">&quot;jiajieshi producer&quot;</span>,<br>    <span class="hljs-string">&quot;tags&quot;</span>: [ <span class="hljs-string">&quot;fangzhu&quot;</span> ]<br>&#125;<br>PUT <span class="hljs-regexp">/ecommerce/</span>product/<span class="hljs-number">3</span><br>&#123;<br>    <span class="hljs-string">&quot;name&quot;</span> : <span class="hljs-string">&quot;zhonghua yagao&quot;</span>,<br>    <span class="hljs-string">&quot;desc&quot;</span> :  <span class="hljs-string">&quot;caoben zhiwu&quot;</span>,<br>    <span class="hljs-string">&quot;price&quot;</span> :  <span class="hljs-number">40</span>,<br>    <span class="hljs-string">&quot;producer&quot;</span> :      <span class="hljs-string">&quot;zhonghua producer&quot;</span>,<br>    <span class="hljs-string">&quot;tags&quot;</span>: [ <span class="hljs-string">&quot;qingxin&quot;</span> ]<br>&#125;<br></code></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;ecommerce&quot;</span>,<br>  <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;product&quot;</span>,<br>  <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>,<br>  <span class="hljs-attr">&quot;_version&quot;</span>: <span class="hljs-number">1</span>,<br>  <span class="hljs-attr">&quot;result&quot;</span>: <span class="hljs-string">&quot;created&quot;</span>,<br>  <span class="hljs-attr">&quot;_shards&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">2</span>,<br>    <span class="hljs-attr">&quot;successful&quot;</span>: <span class="hljs-number">1</span>,<br>    <span class="hljs-attr">&quot;failed&quot;</span>: <span class="hljs-number">0</span><br>  &#125;,<br>  <span class="hljs-attr">&quot;created&quot;</span>: <span class="hljs-literal">true</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>如果index和type不存在，es会自动建立，而且es会对document每个field都建立倒排索引，让其可以被搜索</p>
<p>检索document，格式为：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">GET</span> /<span class="hljs-keyword">index</span>/<span class="hljs-keyword">type</span>/id<br></code></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/ecommerce/</span>product/<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;ecommerce&quot;</span>,<br>  <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;product&quot;</span>,<br>  <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>,<br>  <span class="hljs-attr">&quot;_version&quot;</span>: <span class="hljs-number">1</span>,<br>  <span class="hljs-attr">&quot;found&quot;</span>: <span class="hljs-literal">true</span>,<br>  <span class="hljs-attr">&quot;_source&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;gaolujie yagao&quot;</span>,<br>    <span class="hljs-attr">&quot;desc&quot;</span>: <span class="hljs-string">&quot;gaoxiao meibai&quot;</span>,<br>    <span class="hljs-attr">&quot;price&quot;</span>: <span class="hljs-number">30</span>,<br>    <span class="hljs-attr">&quot;producer&quot;</span>: <span class="hljs-string">&quot;gaolujie producer&quot;</span>,<br>    <span class="hljs-attr">&quot;tags&quot;</span>: [<br>      <span class="hljs-string">&quot;meibai&quot;</span>,<br>      <span class="hljs-string">&quot;fangzhu&quot;</span><br>    ]<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>替换document，语法与创建document是一样的，如果document id不存在，那么就是创建；如果document id已经存在，那么就是全量替换操作。需要带上所有field，未携带的field会被删除。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs awk">PUT <span class="hljs-regexp">/ecommerce/</span>product/<span class="hljs-number">1</span><br>&#123;<br>    <span class="hljs-string">&quot;name&quot;</span> : <span class="hljs-string">&quot;jiaqiangban gaolujie yagao&quot;</span>,<br>    <span class="hljs-string">&quot;desc&quot;</span> :  <span class="hljs-string">&quot;gaoxiao meibai&quot;</span>,<br>    <span class="hljs-string">&quot;price&quot;</span> :  <span class="hljs-number">30</span>,<br>    <span class="hljs-string">&quot;producer&quot;</span> :      <span class="hljs-string">&quot;gaolujie producer&quot;</span>,<br>    <span class="hljs-string">&quot;tags&quot;</span>: [ <span class="hljs-string">&quot;meibai&quot;</span>, <span class="hljs-string">&quot;fangzhu&quot;</span> ]<br>&#125;<br></code></pre></td></tr></table></figure>

<p>强制创建document，如果id存在会直接报错</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">PUT <span class="hljs-regexp">/index/</span>type/id?op_type=create<br>或者<br>PUT <span class="hljs-regexp">/index/</span>type<span class="hljs-regexp">/id/</span>_create<br></code></pre></td></tr></table></figure>

<p>更新document</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs awk">POST <span class="hljs-regexp">/ecommerce/</span>product<span class="hljs-regexp">/1/</span>_update<br>&#123;<br>  <span class="hljs-string">&quot;doc&quot;</span>:&#123;<br>    <span class="hljs-string">&quot;name&quot;</span>:<span class="hljs-string">&quot;jiaqiangban gaolujie yagao&quot;</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>删除document</p>
<p>不会理解物理删除，只会将其标记为deleted，当数据越来越多的时候，在后台自动删除</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-keyword">DELETE</span> <span class="hljs-regexp">/ecommerce/</span>product/<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure>

<h3 id="其他操作"><a href="#其他操作" class="headerlink" title="其他操作"></a>其他操作</h3><h4 id="partial-update"><a href="#partial-update" class="headerlink" title="partial update"></a>partial update</h4><p>es提供了<code>PUT /index/type/id</code>来创建文档或者替换文档，一般对应到应用程序中，每次的执行流程基本是这样的：</p>
<ol>
<li>应用程序先发起一个get请求，获取到document，展示到前台界面，供用户查看和修改</li>
<li>用户在前台界面修改数据，发送到后台</li>
<li>后台代码，会将用户修改的数据在内存中进行执行，然后封装好修改后的全量数据</li>
<li>然后发送PUT请求，到es中，进行全量替换</li>
<li>es将老的document标记为deleted，然后重新创建一个新的document</li>
</ol>
<p>但这种操作是比较复杂的，所以es还提供了partial update来进行document的修改，每次就传递少数几个发生修改的field即可。</p>
<p>partial update内部的执行逻辑为：</p>
<ol>
<li>获取document的json</li>
<li>将传递过来的数据更新到document的json中</li>
<li>将老的document标记为deleted</li>
<li>将修改后的document创建出来</li>
</ol>
<p>相较于put操作，partial update的查询、修改、删除操作均发生在es内部而且都是在一个shard内进行的，基本是毫秒级别的，可以极大的减少并发操作。</p>
<p>partial update内部同样有乐观锁控制，使用了retry策略，首先会获取document数据和最新的版本号，然后基于最新的版本号进行更新，如果失败则重新获取document的数据和版本号，再次进行更新，直到更新成功或者超过retry参数指定的次数。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs awk">post <span class="hljs-regexp">/index/</span>type<span class="hljs-regexp">/id/</span>_update <br>&#123;<br>   <span class="hljs-string">&quot;doc&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;要修改的少数几个field即可，不需要全量的数据&quot;</span><br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs awk">PUT <span class="hljs-regexp">/test_index/</span>test_type/<span class="hljs-number">10</span><br>&#123;<br>  <span class="hljs-string">&quot;test_field1&quot;</span>: <span class="hljs-string">&quot;test1&quot;</span>,<br>  <span class="hljs-string">&quot;test_field2&quot;</span>: <span class="hljs-string">&quot;test2&quot;</span><br>&#125;<br><br>POST <span class="hljs-regexp">/test_index/</span>test_type<span class="hljs-regexp">/10/</span>_update<br>&#123;<br>  <span class="hljs-string">&quot;doc&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;test_field2&quot;</span>: <span class="hljs-string">&quot;updated test2&quot;</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="groovy脚本"><a href="#groovy脚本" class="headerlink" title="groovy脚本"></a>groovy脚本</h4><p>es有内置的脚本支持的，可以基于groovy脚本实现各种各样的复杂操作。</p>
<p>示例</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk">PUT <span class="hljs-regexp">/test_index/</span>test_type/<span class="hljs-number">11</span><br>&#123;<br>  <span class="hljs-string">&quot;num&quot;</span>: <span class="hljs-number">0</span>,<br>  <span class="hljs-string">&quot;tags&quot;</span>: []<br>&#125;<br></code></pre></td></tr></table></figure>

<p>内置脚本</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs gradle">POST <span class="hljs-regexp">/test_index/</span>test_type<span class="hljs-regexp">/11/</span>_update<br>&#123;<br>   <span class="hljs-string">&quot;script&quot;</span> : <span class="hljs-string">&quot;ctx._source.num+=1&quot;</span><br>&#125;<br><br>&#123;<br>  <span class="hljs-string">&quot;_index&quot;</span>: <span class="hljs-string">&quot;test_index&quot;</span>,<br>  <span class="hljs-string">&quot;_type&quot;</span>: <span class="hljs-string">&quot;test_type&quot;</span>,<br>  <span class="hljs-string">&quot;_id&quot;</span>: <span class="hljs-string">&quot;11&quot;</span>,<br>  <span class="hljs-string">&quot;_version&quot;</span>: <span class="hljs-number">2</span>,<br>  <span class="hljs-string">&quot;found&quot;</span>: <span class="hljs-keyword">true</span>,<br>  <span class="hljs-string">&quot;_source&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;num&quot;</span>: <span class="hljs-number">1</span>,<br>    <span class="hljs-string">&quot;tags&quot;</span>: []<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>外部脚本</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs awk">ctx._source.tags+=new_tag<br><br>POST <span class="hljs-regexp">/test_index/</span>test_type<span class="hljs-regexp">/11/</span>_update<br>&#123;<br>  <span class="hljs-string">&quot;script&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;lang&quot;</span>: <span class="hljs-string">&quot;groovy&quot;</span>, <br>    <span class="hljs-string">&quot;file&quot;</span>: <span class="hljs-string">&quot;test-add-tags&quot;</span>,<br>    <span class="hljs-string">&quot;params&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;new_tag&quot;</span>: <span class="hljs-string">&quot;tag1&quot;</span><br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>用脚本删除文档</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs gradle">ctx.op = ctx._source.num == <span class="hljs-keyword">count</span> ? <span class="hljs-string">&#x27;delete&#x27;</span> : <span class="hljs-string">&#x27;none&#x27;</span><br><br>POST <span class="hljs-regexp">/test_index/</span>test_type<span class="hljs-regexp">/11/</span>_update<br>&#123;<br>  <span class="hljs-string">&quot;script&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;lang&quot;</span>: <span class="hljs-string">&quot;groovy&quot;</span>,<br>    <span class="hljs-string">&quot;file&quot;</span>: <span class="hljs-string">&quot;test-delete-document&quot;</span>,<br>    <span class="hljs-string">&quot;params&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;count&quot;</span>: <span class="hljs-number">1</span><br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>upsert操作</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs awk">POST <span class="hljs-regexp">/test_index/</span>test_type<span class="hljs-regexp">/11/</span>_update<br>&#123;<br>  <span class="hljs-string">&quot;doc&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;num&quot;</span>: <span class="hljs-number">1</span><br>  &#125;<br>&#125;<br><br>&#123;<br>  <span class="hljs-string">&quot;error&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;root_cause&quot;</span>: [<br>      &#123;<br>        <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;document_missing_exception&quot;</span>,<br>        <span class="hljs-string">&quot;reason&quot;</span>: <span class="hljs-string">&quot;[test_type][11]: document missing&quot;</span>,<br>        <span class="hljs-string">&quot;index_uuid&quot;</span>: <span class="hljs-string">&quot;6m0G7yx7R1KECWWGnfH1sw&quot;</span>,<br>        <span class="hljs-string">&quot;shard&quot;</span>: <span class="hljs-string">&quot;4&quot;</span>,<br>        <span class="hljs-string">&quot;index&quot;</span>: <span class="hljs-string">&quot;test_index&quot;</span><br>      &#125;<br>    ],<br>    <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;document_missing_exception&quot;</span>,<br>    <span class="hljs-string">&quot;reason&quot;</span>: <span class="hljs-string">&quot;[test_type][11]: document missing&quot;</span>,<br>    <span class="hljs-string">&quot;index_uuid&quot;</span>: <span class="hljs-string">&quot;6m0G7yx7R1KECWWGnfH1sw&quot;</span>,<br>    <span class="hljs-string">&quot;shard&quot;</span>: <span class="hljs-string">&quot;4&quot;</span>,<br>    <span class="hljs-string">&quot;index&quot;</span>: <span class="hljs-string">&quot;test_index&quot;</span><br>  &#125;,<br>  <span class="hljs-string">&quot;status&quot;</span>: <span class="hljs-number">404</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>如果指定的document不存在，就执行upsert中的初始化操作；如果指定的document存在，就执行doc或者script指定的partial update操作</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs awk">POST <span class="hljs-regexp">/test_index/</span>test_type<span class="hljs-regexp">/11/</span>_update<br>&#123;<br>   <span class="hljs-string">&quot;script&quot;</span> : <span class="hljs-string">&quot;ctx._source.num+=1&quot;</span>,<br>   <span class="hljs-string">&quot;upsert&quot;</span>: &#123;<br>       <span class="hljs-string">&quot;num&quot;</span>: <span class="hljs-number">0</span>,<br>       <span class="hljs-string">&quot;tags&quot;</span>: []<br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="mget的语法"><a href="#mget的语法" class="headerlink" title="mget的语法"></a>mget的语法</h4><p>mget批量查询</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-builtin-name">GET</span> /_mget<br>&#123;<br>   <span class="hljs-string">&quot;docs&quot;</span> : [<br>      &#123;<br>         <span class="hljs-string">&quot;_index&quot;</span> : <span class="hljs-string">&quot;test_index&quot;</span>,<br>         <span class="hljs-string">&quot;_type&quot;</span> :  <span class="hljs-string">&quot;test_type&quot;</span>,<br>         <span class="hljs-string">&quot;_id&quot;</span> :    1<br>      &#125;,<br>      &#123;<br>         <span class="hljs-string">&quot;_index&quot;</span> : <span class="hljs-string">&quot;test_index&quot;</span>,<br>         <span class="hljs-string">&quot;_type&quot;</span> :  <span class="hljs-string">&quot;test_type&quot;</span>,<br>         <span class="hljs-string">&quot;_id&quot;</span> :    2<br>      &#125;<br>   ]<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;docs&quot;</span>: [<br>    &#123;<br>      <span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;test_index&quot;</span>,<br>      <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;test_type&quot;</span>,<br>      <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>,<br>      <span class="hljs-attr">&quot;_version&quot;</span>: <span class="hljs-number">2</span>,<br>      <span class="hljs-attr">&quot;found&quot;</span>: <span class="hljs-literal">true</span>,<br>      <span class="hljs-attr">&quot;_source&quot;</span>: &#123;<br>        <span class="hljs-attr">&quot;test_field1&quot;</span>: <span class="hljs-string">&quot;test field1&quot;</span>,<br>        <span class="hljs-attr">&quot;test_field2&quot;</span>: <span class="hljs-string">&quot;test field2&quot;</span><br>      &#125;<br>    &#125;,<br>    &#123;<br>      <span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;test_index&quot;</span>,<br>      <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;test_type&quot;</span>,<br>      <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;2&quot;</span>,<br>      <span class="hljs-attr">&quot;_version&quot;</span>: <span class="hljs-number">1</span>,<br>      <span class="hljs-attr">&quot;found&quot;</span>: <span class="hljs-literal">true</span>,<br>      <span class="hljs-attr">&quot;_source&quot;</span>: &#123;<br>        <span class="hljs-attr">&quot;test_content&quot;</span>: <span class="hljs-string">&quot;my test&quot;</span><br>      &#125;<br>    &#125;<br>  ]<br>&#125;<br></code></pre></td></tr></table></figure>

<p>如果查询的document是一个index下的不同type种的话</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/test_index/</span>_mget<br>&#123;<br>   <span class="hljs-string">&quot;docs&quot;</span> : [<br>      &#123;<br>         <span class="hljs-string">&quot;_type&quot;</span> :  <span class="hljs-string">&quot;test_type&quot;</span>,<br>         <span class="hljs-string">&quot;_id&quot;</span> :    <span class="hljs-number">1</span><br>      &#125;,<br>      &#123;<br>         <span class="hljs-string">&quot;_type&quot;</span> :  <span class="hljs-string">&quot;test_type&quot;</span>,<br>         <span class="hljs-string">&quot;_id&quot;</span> :    <span class="hljs-number">2</span><br>      &#125;<br>   ]<br>&#125;<br></code></pre></td></tr></table></figure>

<p>如果查询的数据都在同一个index下的同一个type下，最简单了</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/test_index/</span>test_type/_mget<br>&#123;<br>   <span class="hljs-string">&quot;ids&quot;</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>]<br>&#125;<br></code></pre></td></tr></table></figure>

<p>mget的重要性</p>
<p>可以说mget是很重要的，一般来说，在进行查询的时候，如果一次性要查询多条数据的话，那么一定要用batch批量操作的api<br>尽可能减少网络开销次数，可能可以将性能提升数倍，甚至数十倍，非常非常之重要</p>
<h4 id="bulk语法"><a href="#bulk语法" class="headerlink" title="bulk语法"></a>bulk语法</h4><p>bulk语法支持的操作</p>
<ol>
<li>delete：删除一个文档，只要1个json串就可以了</li>
<li>create：PUT /index/type/id/_create，强制创建</li>
<li>index：普通的put操作，可以是创建文档，也可以是全量替换文档</li>
<li>update：执行的partial update操作</li>
</ol>
<p>每一个操作要两个json串，语法如下：</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs livescript">&#123;<span class="hljs-string">&quot;action&quot;</span>: &#123;<span class="hljs-string">&quot;meta&quot;</span>&#125;&#125;<span class="hljs-string">\n</span><br>&#123;<span class="hljs-string">&quot;data&quot;</span>&#125;<span class="hljs-string">\n</span><br>&#123;<span class="hljs-string">&quot;action&quot;</span>: &#123;<span class="hljs-string">&quot;meta&quot;</span>&#125;&#125;<span class="hljs-string">\n</span><br>&#123;<span class="hljs-string">&quot;data&quot;</span>&#125;<span class="hljs-string">\n</span><br></code></pre></td></tr></table></figure>

<p>举例，比如你现在要创建一个文档，放bulk里面，看起来会是这样子的：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs clojure">&#123;<span class="hljs-string">&quot;index&quot;</span>: &#123;<span class="hljs-string">&quot;_index&quot;</span>: <span class="hljs-string">&quot;test_index&quot;</span>, <span class="hljs-string">&quot;_type&quot;</span>, <span class="hljs-string">&quot;test_type&quot;</span>, <span class="hljs-string">&quot;_id&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>&#125;&#125;<br>&#123;<span class="hljs-string">&quot;test_field1&quot;</span>: <span class="hljs-string">&quot;test1&quot;</span>, <span class="hljs-string">&quot;test_field2&quot;</span>: <span class="hljs-string">&quot;test2&quot;</span>&#125;<br></code></pre></td></tr></table></figure>

<p>其他例子：</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs n1ql">POST /_bulk<br>&#123; &quot;<span class="hljs-keyword">delete</span><span class="hljs-string">&quot;: &#123; &quot;</span>_index<span class="hljs-string">&quot;: &quot;</span>test_index<span class="hljs-string">&quot;, &quot;</span>_type<span class="hljs-string">&quot;: &quot;</span>test_type<span class="hljs-string">&quot;, &quot;</span>_id<span class="hljs-string">&quot;: &quot;</span><span class="hljs-number">3</span><span class="hljs-string">&quot; &#125;&#125; </span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">create</span><span class="hljs-string">&quot;: &#123; &quot;</span>_index<span class="hljs-string">&quot;: &quot;</span>test_index<span class="hljs-string">&quot;, &quot;</span>_type<span class="hljs-string">&quot;: &quot;</span>test_type<span class="hljs-string">&quot;, &quot;</span>_id<span class="hljs-string">&quot;: &quot;</span><span class="hljs-number">12</span><span class="hljs-string">&quot; &#125;&#125;</span><br><span class="hljs-string">&#123; &quot;</span>test_field<span class="hljs-string">&quot;:    &quot;</span>test12<span class="hljs-string">&quot; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">index</span><span class="hljs-string">&quot;:  &#123; &quot;</span>_index<span class="hljs-string">&quot;: &quot;</span>test_index<span class="hljs-string">&quot;, &quot;</span>_type<span class="hljs-string">&quot;: &quot;</span>test_type<span class="hljs-string">&quot;, &quot;</span>_id<span class="hljs-string">&quot;: &quot;</span><span class="hljs-number">2</span><span class="hljs-string">&quot; &#125;&#125;</span><br><span class="hljs-string">&#123; &quot;</span>test_field<span class="hljs-string">&quot;:    &quot;</span>replaced test2<span class="hljs-string">&quot; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">update</span><span class="hljs-string">&quot;: &#123; &quot;</span>_index<span class="hljs-string">&quot;: &quot;</span>test_index<span class="hljs-string">&quot;, &quot;</span>_type<span class="hljs-string">&quot;: &quot;</span>test_type<span class="hljs-string">&quot;, &quot;</span>_id<span class="hljs-string">&quot;: &quot;</span><span class="hljs-number">1</span><span class="hljs-string">&quot;, &quot;</span>_retry_on_conflict<span class="hljs-string">&quot; : 3&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span>doc<span class="hljs-string">&quot; : &#123;&quot;</span>test_field2<span class="hljs-string">&quot; : &quot;</span>bulk test1<span class="hljs-string">&quot;&#125; &#125;</span><br></code></pre></td></tr></table></figure>

<p>bulk api对json的语法，有严格的要求，每个json串不能换行，只能放一行，同时一个json串和一个json串之间，必须有一个换行，以下格式是错误的。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;took&quot;</span>: <span class="hljs-number">41</span>,<br>  <span class="hljs-attr">&quot;errors&quot;</span>: <span class="hljs-literal">true</span>,<br>  <span class="hljs-attr">&quot;items&quot;</span>: [<br>    &#123;<br>      <span class="hljs-attr">&quot;delete&quot;</span>: &#123;<br>        <span class="hljs-attr">&quot;found&quot;</span>: <span class="hljs-literal">true</span>,<br>        <span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;test_index&quot;</span>,<br>        <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;test_type&quot;</span>,<br>        <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;10&quot;</span>,<br>        <span class="hljs-attr">&quot;_version&quot;</span>: <span class="hljs-number">3</span>,<br>        <span class="hljs-attr">&quot;result&quot;</span>: <span class="hljs-string">&quot;deleted&quot;</span>,<br>        <span class="hljs-attr">&quot;_shards&quot;</span>: &#123;<br>          <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">2</span>,<br>          <span class="hljs-attr">&quot;successful&quot;</span>: <span class="hljs-number">1</span>,<br>          <span class="hljs-attr">&quot;failed&quot;</span>: <span class="hljs-number">0</span><br>        &#125;,<br>        <span class="hljs-attr">&quot;status&quot;</span>: <span class="hljs-number">200</span><br>      &#125;<br>    &#125;,<br>    &#123;<br>      <span class="hljs-attr">&quot;create&quot;</span>: &#123;<br>        <span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;test_index&quot;</span>,<br>        <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;test_type&quot;</span>,<br>        <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;3&quot;</span>,<br>        <span class="hljs-attr">&quot;_version&quot;</span>: <span class="hljs-number">1</span>,<br>        <span class="hljs-attr">&quot;result&quot;</span>: <span class="hljs-string">&quot;created&quot;</span>,<br>        <span class="hljs-attr">&quot;_shards&quot;</span>: &#123;<br>          <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">2</span>,<br>          <span class="hljs-attr">&quot;successful&quot;</span>: <span class="hljs-number">1</span>,<br>          <span class="hljs-attr">&quot;failed&quot;</span>: <span class="hljs-number">0</span><br>        &#125;,<br>        <span class="hljs-attr">&quot;created&quot;</span>: <span class="hljs-literal">true</span>,<br>        <span class="hljs-attr">&quot;status&quot;</span>: <span class="hljs-number">201</span><br>      &#125;<br>    &#125;,<br>    &#123;<br>      <span class="hljs-attr">&quot;create&quot;</span>: &#123;<br>        <span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;test_index&quot;</span>,<br>        <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;test_type&quot;</span>,<br>        <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;2&quot;</span>,<br>        <span class="hljs-attr">&quot;status&quot;</span>: <span class="hljs-number">409</span>,<br>        <span class="hljs-attr">&quot;error&quot;</span>: &#123;<br>          <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;version_conflict_engine_exception&quot;</span>,<br>          <span class="hljs-attr">&quot;reason&quot;</span>: <span class="hljs-string">&quot;[test_type][2]: version conflict, document already exists (current version [1])&quot;</span>,<br>          <span class="hljs-attr">&quot;index_uuid&quot;</span>: <span class="hljs-string">&quot;6m0G7yx7R1KECWWGnfH1sw&quot;</span>,<br>          <span class="hljs-attr">&quot;shard&quot;</span>: <span class="hljs-string">&quot;2&quot;</span>,<br>          <span class="hljs-attr">&quot;index&quot;</span>: <span class="hljs-string">&quot;test_index&quot;</span><br>        &#125;<br>      &#125;<br>    &#125;,<br>    &#123;<br>      <span class="hljs-attr">&quot;index&quot;</span>: &#123;<br>        <span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;test_index&quot;</span>,<br>        <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;test_type&quot;</span>,<br>        <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;4&quot;</span>,<br>        <span class="hljs-attr">&quot;_version&quot;</span>: <span class="hljs-number">1</span>,<br>        <span class="hljs-attr">&quot;result&quot;</span>: <span class="hljs-string">&quot;created&quot;</span>,<br>        <span class="hljs-attr">&quot;_shards&quot;</span>: &#123;<br>          <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">2</span>,<br>          <span class="hljs-attr">&quot;successful&quot;</span>: <span class="hljs-number">1</span>,<br>          <span class="hljs-attr">&quot;failed&quot;</span>: <span class="hljs-number">0</span><br>        &#125;,<br>        <span class="hljs-attr">&quot;created&quot;</span>: <span class="hljs-literal">true</span>,<br>        <span class="hljs-attr">&quot;status&quot;</span>: <span class="hljs-number">201</span><br>      &#125;<br>    &#125;,<br>    &#123;<br>      <span class="hljs-attr">&quot;index&quot;</span>: &#123;<br>        <span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;test_index&quot;</span>,<br>        <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;test_type&quot;</span>,<br>        <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;2&quot;</span>,<br>        <span class="hljs-attr">&quot;_version&quot;</span>: <span class="hljs-number">2</span>,<br>        <span class="hljs-attr">&quot;result&quot;</span>: <span class="hljs-string">&quot;updated&quot;</span>,<br>        <span class="hljs-attr">&quot;_shards&quot;</span>: &#123;<br>          <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">2</span>,<br>          <span class="hljs-attr">&quot;successful&quot;</span>: <span class="hljs-number">1</span>,<br>          <span class="hljs-attr">&quot;failed&quot;</span>: <span class="hljs-number">0</span><br>        &#125;,<br>        <span class="hljs-attr">&quot;created&quot;</span>: <span class="hljs-literal">false</span>,<br>        <span class="hljs-attr">&quot;status&quot;</span>: <span class="hljs-number">200</span><br>      &#125;<br>    &#125;,<br>    &#123;<br>      <span class="hljs-attr">&quot;update&quot;</span>: &#123;<br>        <span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;test_index&quot;</span>,<br>        <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;test_type&quot;</span>,<br>        <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>,<br>        <span class="hljs-attr">&quot;_version&quot;</span>: <span class="hljs-number">3</span>,<br>        <span class="hljs-attr">&quot;result&quot;</span>: <span class="hljs-string">&quot;updated&quot;</span>,<br>        <span class="hljs-attr">&quot;_shards&quot;</span>: &#123;<br>          <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">2</span>,<br>          <span class="hljs-attr">&quot;successful&quot;</span>: <span class="hljs-number">1</span>,<br>          <span class="hljs-attr">&quot;failed&quot;</span>: <span class="hljs-number">0</span><br>        &#125;,<br>        <span class="hljs-attr">&quot;status&quot;</span>: <span class="hljs-number">200</span><br>      &#125;<br>    &#125;<br>  ]<br>&#125;<br></code></pre></td></tr></table></figure>

<p>报错信息：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;error&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;root_cause&quot;</span>: [<br>      &#123;<br>        <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;json_e_o_f_exception&quot;</span>,<br>        <span class="hljs-attr">&quot;reason&quot;</span>: <span class="hljs-string">&quot;Unexpected end-of-input: expected close marker for Object (start marker at [Source: org.elasticsearch.transport.netty4.ByteBufStreamInput@5a5932cd; line: 1, column: 1])\n at [Source: org.elasticsearch.transport.netty4.ByteBufStreamInput@5a5932cd; line: 1, column: 3]&quot;</span><br>      &#125;<br>    ],<br>    <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;json_e_o_f_exception&quot;</span>,<br>    <span class="hljs-attr">&quot;reason&quot;</span>: <span class="hljs-string">&quot;Unexpected end-of-input: expected close marker for Object (start marker at [Source: org.elasticsearch.transport.netty4.ByteBufStreamInput@5a5932cd; line: 1, column: 1])\n at [Source: org.elasticsearch.transport.netty4.ByteBufStreamInput@5a5932cd; line: 1, column: 3]&quot;</span><br>  &#125;,<br>  <span class="hljs-attr">&quot;status&quot;</span>: <span class="hljs-number">500</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>修改为：</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs n1ql">POST /test_index/_bulk<br>&#123; &quot;<span class="hljs-keyword">delete</span><span class="hljs-string">&quot;: &#123; &quot;</span>_type<span class="hljs-string">&quot;: &quot;</span>test_type<span class="hljs-string">&quot;, &quot;</span>_id<span class="hljs-string">&quot;: &quot;</span><span class="hljs-number">3</span><span class="hljs-string">&quot; &#125;&#125; </span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">create</span><span class="hljs-string">&quot;: &#123; &quot;</span>_type<span class="hljs-string">&quot;: &quot;</span>test_type<span class="hljs-string">&quot;, &quot;</span>_id<span class="hljs-string">&quot;: &quot;</span><span class="hljs-number">12</span><span class="hljs-string">&quot; &#125;&#125;</span><br><span class="hljs-string">&#123; &quot;</span>test_field<span class="hljs-string">&quot;:    &quot;</span>test12<span class="hljs-string">&quot; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">index</span><span class="hljs-string">&quot;:  &#123; &quot;</span>_type<span class="hljs-string">&quot;: &quot;</span>test_type<span class="hljs-string">&quot; &#125;&#125;</span><br><span class="hljs-string">&#123; &quot;</span>test_field<span class="hljs-string">&quot;:    &quot;</span>auto-generate id test<span class="hljs-string">&quot; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">index</span><span class="hljs-string">&quot;:  &#123; &quot;</span>_type<span class="hljs-string">&quot;: &quot;</span>test_type<span class="hljs-string">&quot;, &quot;</span>_id<span class="hljs-string">&quot;: &quot;</span><span class="hljs-number">2</span><span class="hljs-string">&quot; &#125;&#125;</span><br><span class="hljs-string">&#123; &quot;</span>test_field<span class="hljs-string">&quot;:    &quot;</span>replaced test2<span class="hljs-string">&quot; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">update</span><span class="hljs-string">&quot;: &#123; &quot;</span>_type<span class="hljs-string">&quot;: &quot;</span>test_type<span class="hljs-string">&quot;, &quot;</span>_id<span class="hljs-string">&quot;: &quot;</span><span class="hljs-number">1</span><span class="hljs-string">&quot;, &quot;</span>_retry_on_conflict<span class="hljs-string">&quot; : 3&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span>doc<span class="hljs-string">&quot; : &#123;&quot;</span>test_field2<span class="hljs-string">&quot; : &quot;</span>bulk test1<span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">POST /test_index/test_type/_bulk</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">delete</span><span class="hljs-string">&quot;: &#123; &quot;</span>_id<span class="hljs-string">&quot;: &quot;</span><span class="hljs-number">3</span><span class="hljs-string">&quot; &#125;&#125; </span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">create</span><span class="hljs-string">&quot;: &#123; &quot;</span>_id<span class="hljs-string">&quot;: &quot;</span><span class="hljs-number">12</span><span class="hljs-string">&quot; &#125;&#125;</span><br><span class="hljs-string">&#123; &quot;</span>test_field<span class="hljs-string">&quot;:    &quot;</span>test12<span class="hljs-string">&quot; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">index</span><span class="hljs-string">&quot;:  &#123; &#125;&#125;</span><br><span class="hljs-string">&#123; &quot;</span>test_field<span class="hljs-string">&quot;:    &quot;</span>auto-generate id test<span class="hljs-string">&quot; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">index</span><span class="hljs-string">&quot;:  &#123; &quot;</span>_id<span class="hljs-string">&quot;: &quot;</span><span class="hljs-number">2</span><span class="hljs-string">&quot; &#125;&#125;</span><br><span class="hljs-string">&#123; &quot;</span>test_field<span class="hljs-string">&quot;:    &quot;</span>replaced test2<span class="hljs-string">&quot; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">update</span><span class="hljs-string">&quot;: &#123; &quot;</span>_id<span class="hljs-string">&quot;: &quot;</span><span class="hljs-number">1</span><span class="hljs-string">&quot;, &quot;</span>_retry_on_conflict<span class="hljs-string">&quot; : 3&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span>doc<span class="hljs-string">&quot; : &#123;&quot;</span>test_field2<span class="hljs-string">&quot; : &quot;</span>bulk test1<span class="hljs-string">&quot;&#125; &#125;</span><br></code></pre></td></tr></table></figure>

<p>bulk数据格式分析：</p>
<p>bulk中的每个操作都可能要转发到不同的node的shard去执行</p>
<p>如果采用比较易读的json数组格式</p>
<p>允许任意的换行，整个可读性非常棒，但是es拿到那种标准格式的json串以后，要按照下述流程去进行处理</p>
<ol>
<li>将json数组解析为JSONArray对象，这个时候，整个数据，就会在内存中出现一份一模一样的拷贝，一份数据是json文本，一份数据是JSONArray对象</li>
<li>解析json数组里的每个json，对每个请求中的document进行路由</li>
<li>为路由到同一个shard上的多个请求，创建一个请求数组</li>
<li>将这个请求数组序列化</li>
<li>将序列化后的请求数组发送到对应的节点上去</li>
</ol>
<p>这样会耗费更多内存，更多的jvm gc开销</p>
<p>假设说现在100个bulk请求发送到了一个节点上去，然后每个请求是10MB，100个请求，就是1000MB = 1GB，然后每个请求的json都copy一份为jsonarray对象，此时内存中的占用就会翻倍，就会占用2GB的内存，甚至还不止。因为弄成jsonarray之后，还可能会多搞一些其他的数据结构，2GB+的内存占用。</p>
<p>占用更多的内存可能就会积压其他请求的内存使用量，比如说最重要的搜索请求，分析请求，等等，此时就可能会导致其他请求的性能急速下降<br>另外的话，占用内存更多，就会导致java虚拟机的垃圾回收次数更多，跟频繁，每次要回收的垃圾对象更多，耗费的时间更多，导致es的java虚拟机停止工作线程的时间更多</p>
<p>现在的奇特格式</p>
<p>{“action”: {“meta”}}\n<br>{“data”}\n<br>{“action”: {“meta”}}\n<br>{“data”}\n</p>
<p>这样的优势：</p>
<ol>
<li>不用将其转换为json对象，不会出现内存中的相同数据的拷贝，直接按照换行符切割json</li>
<li>对每两个一组的json，读取meta，进行document路由</li>
<li>直接将对应的json发送到node上去</li>
</ol>
<p>最大的优势在于，不需要将json数组解析为一个JSONArray对象，形成一份大数据的拷贝，浪费内存空间，尽可能地保证性能，关键在于分割。</p>
<p>bulk size最佳大小</p>
<p>bulk request会加载到内存里，如果太大的话，性能反而会下降，因此需要反复尝试一个最佳的bulk size。一般从1000<del>5000条数据开始，尝试逐渐增加。另外，如果看大小的话，最好是在5</del>15MB之间。</p>
<h3 id="数据搜索"><a href="#数据搜索" class="headerlink" title="数据搜索"></a>数据搜索</h3><h4 id="参数携带方式"><a href="#参数携带方式" class="headerlink" title="参数携带方式"></a>参数携带方式</h4><h5 id="query-string-search"><a href="#query-string-search" class="headerlink" title="query string search"></a>query string search</h5><p>search参数是以http请求的query string进行附带，适用于临时的在命令行使用一些工具，比如curl，快速的发出请求，来检索想要的信息；但是如果查询请求很复杂，是很难去构建的。在生产环境中，几乎很少使用query string search。</p>
<p>示例：</p>
<ul>
<li>搜索全部商品：</li>
</ul>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/ecommerce/</span>product/_search<br></code></pre></td></tr></table></figure>

<ul>
<li>搜索商品名称中包含yagao的商品，而且按照售价降序排序：</li>
</ul>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-builtin-name">GET</span> /ecommerce/product/_search?<span class="hljs-attribute">q</span>=name:yagao&amp;sort=price:desc<br></code></pre></td></tr></table></figure>

<h5 id="query-DSL"><a href="#query-DSL" class="headerlink" title="query DSL"></a>query DSL</h5><p>使用http request body携带DSL（Domain Specified Language 特定领域的语言）构建的查询语法进行查询，这种方式可以方便的构建各种复杂的语法。</p>
<p>在HTTP协议中一般不允许get请求带上request body，但是get类型相比于post更适合描述数据的查询操作，暂时先这么用了。</p>
<p>Query DSL的基本语法</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs css">&#123;<br>    <span class="hljs-attribute">QUERY_NAME</span>: &#123;<br>        ARGUMENT: VALUE,<br>        ARGUMENT: VALUE,...<br>    &#125;<br>&#125;<br><br>&#123;<br>    <span class="hljs-attribute">QUERY_NAME</span>: &#123;<br>        FIELD_NAME: &#123;<br>            ARGUMENT: VALUE,<br>            ARGUMENT: VALUE,...<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/test_index/</span>test_type/_search <br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;test_field&quot;</span>: <span class="hljs-string">&quot;test&quot;</span><br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="搜索类型"><a href="#搜索类型" class="headerlink" title="搜索类型"></a>搜索类型</h4><h5 id="full-text-search（全文检索）"><a href="#full-text-search（全文检索）" class="headerlink" title="full-text search（全文检索）"></a>full-text search（全文检索）</h5><p>通过match进行匹配时，通常使用的是full-text search（全文检索），full-text search会将输入的搜索串拆解开来，去倒排索引里面去一一匹配，只要能匹配上任意一个拆解后的单词，就可以作为结果返回，与之相对的是phrase search（短语搜索），phrase search要求输入的搜索串，必须在指定的字段文本中，完全包含一模一样的，才可以算匹配，才能作为结果返回。</p>
<p>示例：</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs ada">GET /ecommerce/product/_search<br>&#123;<br>    <span class="hljs-string">&quot;query&quot;</span> : &#123;<br>        <span class="hljs-string">&quot;match&quot;</span> : &#123;<br>            <span class="hljs-string">&quot;producer&quot;</span> : &quot;<span class="hljs-type">yagao</span> producer<span class="hljs-string">&quot;</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string">&#125;</span><br></code></pre></td></tr></table></figure>

<p>返回结果</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;took&quot;</span>: <span class="hljs-number">4</span>,<br>  <span class="hljs-attr">&quot;timed_out&quot;</span>: <span class="hljs-literal">false</span>,<br>  <span class="hljs-attr">&quot;_shards&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">5</span>,<br>    <span class="hljs-attr">&quot;successful&quot;</span>: <span class="hljs-number">5</span>,<br>    <span class="hljs-attr">&quot;failed&quot;</span>: <span class="hljs-number">0</span><br>  &#125;,<br>  <span class="hljs-attr">&quot;hits&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">4</span>,<br>    <span class="hljs-attr">&quot;max_score&quot;</span>: <span class="hljs-number">0.70293105</span>,<br>    <span class="hljs-attr">&quot;hits&quot;</span>: [<br>      &#123;<br>        <span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;ecommerce&quot;</span>,<br>        <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;product&quot;</span>,<br>        <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;4&quot;</span>,<br>        <span class="hljs-attr">&quot;_score&quot;</span>: <span class="hljs-number">0.70293105</span>,<br>        <span class="hljs-attr">&quot;_source&quot;</span>: &#123;<br>          <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;special yagao&quot;</span>,<br>          <span class="hljs-attr">&quot;desc&quot;</span>: <span class="hljs-string">&quot;special meibai&quot;</span>,<br>          <span class="hljs-attr">&quot;price&quot;</span>: <span class="hljs-number">50</span>,<br>          <span class="hljs-attr">&quot;producer&quot;</span>: <span class="hljs-string">&quot;special yagao producer&quot;</span>,<br>          <span class="hljs-attr">&quot;tags&quot;</span>: [<br>            <span class="hljs-string">&quot;meibai&quot;</span><br>          ]<br>        &#125;<br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;ecommerce&quot;</span>,<br>        <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;product&quot;</span>,<br>        <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>,<br>        <span class="hljs-attr">&quot;_score&quot;</span>: <span class="hljs-number">0.25811607</span>,<br>        <span class="hljs-attr">&quot;_source&quot;</span>: &#123;<br>          <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;gaolujie yagao&quot;</span>,<br>          <span class="hljs-attr">&quot;desc&quot;</span>: <span class="hljs-string">&quot;gaoxiao meibai&quot;</span>,<br>          <span class="hljs-attr">&quot;price&quot;</span>: <span class="hljs-number">30</span>,<br>          <span class="hljs-attr">&quot;producer&quot;</span>: <span class="hljs-string">&quot;gaolujie producer&quot;</span>,<br>          <span class="hljs-attr">&quot;tags&quot;</span>: [<br>            <span class="hljs-string">&quot;meibai&quot;</span>,<br>            <span class="hljs-string">&quot;fangzhu&quot;</span><br>          ]<br>        &#125;<br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;ecommerce&quot;</span>,<br>        <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;product&quot;</span>,<br>        <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;3&quot;</span>,<br>        <span class="hljs-attr">&quot;_score&quot;</span>: <span class="hljs-number">0.25811607</span>,<br>        <span class="hljs-attr">&quot;_source&quot;</span>: &#123;<br>          <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;zhonghua yagao&quot;</span>,<br>          <span class="hljs-attr">&quot;desc&quot;</span>: <span class="hljs-string">&quot;caoben zhiwu&quot;</span>,<br>          <span class="hljs-attr">&quot;price&quot;</span>: <span class="hljs-number">40</span>,<br>          <span class="hljs-attr">&quot;producer&quot;</span>: <span class="hljs-string">&quot;zhonghua producer&quot;</span>,<br>          <span class="hljs-attr">&quot;tags&quot;</span>: [<br>            <span class="hljs-string">&quot;qingxin&quot;</span><br>          ]<br>        &#125;<br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;ecommerce&quot;</span>,<br>        <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;product&quot;</span>,<br>        <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;2&quot;</span>,<br>        <span class="hljs-attr">&quot;_score&quot;</span>: <span class="hljs-number">0.1805489</span>,<br>        <span class="hljs-attr">&quot;_source&quot;</span>: &#123;<br>          <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;jiajieshi yagao&quot;</span>,<br>          <span class="hljs-attr">&quot;desc&quot;</span>: <span class="hljs-string">&quot;youxiao fangzhu&quot;</span>,<br>          <span class="hljs-attr">&quot;price&quot;</span>: <span class="hljs-number">25</span>,<br>          <span class="hljs-attr">&quot;producer&quot;</span>: <span class="hljs-string">&quot;jiajieshi producer&quot;</span>,<br>          <span class="hljs-attr">&quot;tags&quot;</span>: [<br>            <span class="hljs-string">&quot;fangzhu&quot;</span><br>          ]<br>        &#125;<br>      &#125;<br>    ]<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="phrase-search（短语搜索）"><a href="#phrase-search（短语搜索）" class="headerlink" title="phrase search（短语搜索）"></a>phrase search（短语搜索）</h5><p>跟全文检索相反，phrase search要求输入的搜索串不能进行拆分，必须完全存在才可以算匹配。</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs ada">GET /ecommerce/product/_search<br>&#123;<br>    <span class="hljs-string">&quot;query&quot;</span> : &#123;<br>        <span class="hljs-string">&quot;match_phrase&quot;</span> : &#123;<br>            <span class="hljs-string">&quot;producer&quot;</span> : &quot;<span class="hljs-type">yagao</span> producer<span class="hljs-string">&quot;</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string">&#125;</span><br></code></pre></td></tr></table></figure>

<p>返回结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;took&quot;</span>: <span class="hljs-number">11</span>,<br>  <span class="hljs-attr">&quot;timed_out&quot;</span>: <span class="hljs-literal">false</span>,<br>  <span class="hljs-attr">&quot;_shards&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">5</span>,<br>    <span class="hljs-attr">&quot;successful&quot;</span>: <span class="hljs-number">5</span>,<br>    <span class="hljs-attr">&quot;failed&quot;</span>: <span class="hljs-number">0</span><br>  &#125;,<br>  <span class="hljs-attr">&quot;hits&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">1</span>,<br>    <span class="hljs-attr">&quot;max_score&quot;</span>: <span class="hljs-number">0.70293105</span>,<br>    <span class="hljs-attr">&quot;hits&quot;</span>: [<br>      &#123;<br>        <span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;ecommerce&quot;</span>,<br>        <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;product&quot;</span>,<br>        <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;4&quot;</span>,<br>        <span class="hljs-attr">&quot;_score&quot;</span>: <span class="hljs-number">0.70293105</span>,<br>        <span class="hljs-attr">&quot;_source&quot;</span>: &#123;<br>          <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;special yagao&quot;</span>,<br>          <span class="hljs-attr">&quot;desc&quot;</span>: <span class="hljs-string">&quot;special meibai&quot;</span>,<br>          <span class="hljs-attr">&quot;price&quot;</span>: <span class="hljs-number">50</span>,<br>          <span class="hljs-attr">&quot;producer&quot;</span>: <span class="hljs-string">&quot;special yagao producer&quot;</span>,<br>          <span class="hljs-attr">&quot;tags&quot;</span>: [<br>            <span class="hljs-string">&quot;meibai&quot;</span><br>          ]<br>        &#125;<br>      &#125;<br>    ]<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="结果分析"><a href="#结果分析" class="headerlink" title="结果分析"></a>结果分析</h4><ul>
<li>took：整个搜索请求花费了多少毫秒</li>
<li>hits.total：本次搜索，返回了几条结果</li>
<li>hits.max_score：本次搜索的所有结果中，最大的相关度分数是多少，每一条document对于search的相关度，越相关，_score分数越大，排位越靠前</li>
<li>hits.hits：默认查询前10条数据，完整数据，_score降序排序</li>
<li>shards：shards fail的条件（primary和replica全部挂掉），不影响其他shard。默认情况下来说，一个搜索请求，会打到一个index的所有primary shard上去，当然了，每个primary shard都可能会有一个或多个replic shard，所以请求也可以到primary shard的其中一个replica shard上去。</li>
<li>timeout：指定每个shard在timeout的时间范围内搜索到的数据返回，而不是等待搜索结束后返回，此时可能搜索到了全部数据，也可能搜索到了部分数据。这样可以确保一次请求在用户可接受的范围内完成，对于时间敏感的业务可以有良好的支持。默认无timeout，如果搜索特别慢，每个shard可能要等待几分钟才能返回，那么搜索请求也会等好几分钟后才返回。timeout=10ms，设置方式：GET /_search?timeout=10m或者timeout=1s，timeout=1m，</li>
</ul>
<h4 id="搜索语法"><a href="#搜索语法" class="headerlink" title="搜索语法"></a>搜索语法</h4><ul>
<li>match all</li>
</ul>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-builtin-name">GET</span> /_search<br>&#123;<br>    <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;match_all&quot;</span>: &#123;&#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>match</li>
</ul>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-builtin-name">GET</span> /_search<br>&#123;<br>    <span class="hljs-string">&quot;query&quot;</span>: &#123; <span class="hljs-string">&quot;match&quot;</span>: &#123; <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;my elasticsearch article&quot;</span> &#125;&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>multi match</li>
</ul>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/test_index/</span>test_type/_search<br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;multi_match&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;query&quot;</span>: <span class="hljs-string">&quot;test&quot;</span>,<br>      <span class="hljs-string">&quot;fields&quot;</span>: [<span class="hljs-string">&quot;test_field&quot;</span>, <span class="hljs-string">&quot;test_field1&quot;</span>]<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>range query</li>
</ul>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/company/</span>employee/_search <br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;range&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;age&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;gte&quot;</span>: <span class="hljs-number">30</span><br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>term query</li>
</ul>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/test_index/</span>test_type/_search <br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;term&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;test_field&quot;</span>: <span class="hljs-string">&quot;test hello&quot;</span><br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>terms query</li>
</ul>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-builtin-name">GET</span> /_search<br>&#123;<br>    <span class="hljs-string">&quot;query&quot;</span>: &#123; <span class="hljs-string">&quot;terms&quot;</span>: &#123; <span class="hljs-string">&quot;tag&quot;</span>: [ <span class="hljs-string">&quot;search&quot;</span>, <span class="hljs-string">&quot;full_text&quot;</span>, <span class="hljs-string">&quot;nosql&quot;</span> ] &#125;&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="term-filter-query"><a href="#term-filter-query" class="headerlink" title="term filter/query"></a>term filter/query</h5><p>term filter/query在搜索时不会对文本进行分词，而是直接去倒排索引中匹配，数字、boolean、date类型字段的搜索都是term搜索。es5.2版本在type=text时，会额外设立keyword字段，来存储不分词的内容，辅助进行搜索，最多会保留256字节。可以使用keyword字段进行term filter/query搜索。</p>
<h5 id="multi-index和multi-type搜索模式"><a href="#multi-index和multi-type搜索模式" class="headerlink" title="multi-index和multi-type搜索模式"></a>multi-index和multi-type搜索模式</h5><p>如何一次性搜索多个index和多个type下的数据</p>
<ul>
<li>/_search：所有索引，所有type下的所有数据都搜索出来</li>
<li>/index1/_search：指定一个index，搜索其下所有type的数据</li>
<li>/index1,index2/_search：同时搜索两个index下的数据</li>
<li>/*1,*2/_search：按照通配符去匹配多个索引</li>
<li>/index1/type1/_search：搜索一个index下指定的type的数据</li>
<li>/index1/type1,type2/_search：可以搜索一个index下多个type的数据</li>
<li>/index1,index2/type1,type2/_search：搜索多个index下的多个type的数据</li>
<li>/_all/type1,type2/_search：_all，可以代表搜索所有index下的指定type的数据</li>
</ul>
<h5 id="多条件搜索"><a href="#多条件搜索" class="headerlink" title="多条件搜索"></a>多条件搜索</h5><p>title必须包含elasticsearch，content可以包含elasticsearch也可以不包含，author_id必须不为111</p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs prolog"><span class="hljs-symbol">GET</span> /website/article/<span class="hljs-symbol">_search</span><br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;bool&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;must&quot;</span>: [<br>        &#123;<br>          <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;elasticsearch&quot;</span><br>          &#125;<br>        &#125;<br>      ],<br>      <span class="hljs-string">&quot;should&quot;</span>: [<br>        &#123;<br>          <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;elasticsearch&quot;</span><br>          &#125;<br>        &#125;<br>      ],<br>      <span class="hljs-string">&quot;must_not&quot;</span>: [<br>        &#123;<br>          <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;author_id&quot;</span>: <span class="hljs-number">111</span><br>          &#125;<br>        &#125;<br>      ]<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="all-metadata"><a href="#all-metadata" class="headerlink" title="_all metadata"></a>_all metadata</h5><p>_all metadata直接可以搜索所有的field，任意一个field包含指定的关键字就可以搜索出来。</p>
<p>es中在建立索引的时候将所有field的值，全部用字符串的方式串联起来，变成一个长的字符串作为_all元数据的值。</p>
<p>query string基础语法</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-builtin-name">GET</span> /test_index/test_type/\_search?<span class="hljs-attribute">q</span>=test_field:test<br><span class="hljs-builtin-name">GET</span> /test_index/test_type/\_search?<span class="hljs-attribute">q</span>=+test_field:test<br><span class="hljs-builtin-name">GET</span> /test_index/test_type/\_search?<span class="hljs-attribute">q</span>=-test_field:test<br></code></pre></td></tr></table></figure>

<p>其中 +  表示必须包含， - 表示必须不包含</p>
<p>如果在搜索的时候，没有对某个field指定搜索，就默认搜索_all field，其中是包含了所有field的值的</p>
<p>举个例子</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;jack&quot;</span>,<br>  <span class="hljs-attr">&quot;age&quot;</span>: <span class="hljs-number">26</span>,<br>  <span class="hljs-attr">&quot;email&quot;</span>: <span class="hljs-string">&quot;jack@sina.com&quot;</span>,<br>  <span class="hljs-attr">&quot;address&quot;</span>: <span class="hljs-string">&quot;guamgzhou&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>“jack 26 <a href="mailto:&#x6a;&#x61;&#99;&#x6b;&#64;&#115;&#105;&#x6e;&#97;&#46;&#x63;&#x6f;&#109;">&#x6a;&#x61;&#99;&#x6b;&#64;&#115;&#105;&#x6e;&#97;&#46;&#x63;&#x6f;&#109;</a> guangzhou”，作为这一条document的_all field的值，同时进行分词后建立对应的倒排索引，生产环境不推荐使用。</p>
<h4 id="分页搜索"><a href="#分页搜索" class="headerlink" title="分页搜索"></a>分页搜索</h4><p>es进行分页搜索的语法：</p>
<ul>
<li>GET /_search?size=10</li>
<li>GET /_search?size=10&amp;from=0</li>
<li>GET /_search?size=10&amp;from=20</li>
</ul>
<p>示例</p>
<p>假设将这9条数据分成3页，每一页是3条数据，搜索实现：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle">GET <span class="hljs-regexp">/test_index/</span>test_type/_search?<span class="hljs-keyword">from</span>=<span class="hljs-number">0</span>&amp;<span class="hljs-keyword">size</span>=<span class="hljs-number">3</span><br></code></pre></td></tr></table></figure>

<p>返回数据</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;took&quot;</span>: <span class="hljs-number">2</span>,<br>  <span class="hljs-attr">&quot;timed_out&quot;</span>: <span class="hljs-literal">false</span>,<br>  <span class="hljs-attr">&quot;_shards&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">5</span>,<br>    <span class="hljs-attr">&quot;successful&quot;</span>: <span class="hljs-number">5</span>,<br>    <span class="hljs-attr">&quot;failed&quot;</span>: <span class="hljs-number">0</span><br>  &#125;,<br>  <span class="hljs-attr">&quot;hits&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">9</span>,<br>    <span class="hljs-attr">&quot;max_score&quot;</span>: <span class="hljs-number">1</span>,<br>    <span class="hljs-attr">&quot;hits&quot;</span>: [<br>      &#123;<br>        <span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;test_index&quot;</span>,<br>        <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;test_type&quot;</span>,<br>        <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;8&quot;</span>,<br>        <span class="hljs-attr">&quot;_score&quot;</span>: <span class="hljs-number">1</span>,<br>        <span class="hljs-attr">&quot;_source&quot;</span>: &#123;<br>          <span class="hljs-attr">&quot;test_field&quot;</span>: <span class="hljs-string">&quot;test client 2&quot;</span><br>        &#125;<br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;test_index&quot;</span>,<br>        <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;test_type&quot;</span>,<br>        <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;6&quot;</span>,<br>        <span class="hljs-attr">&quot;_score&quot;</span>: <span class="hljs-number">1</span>,<br>        <span class="hljs-attr">&quot;_source&quot;</span>: &#123;<br>          <span class="hljs-attr">&quot;test_field&quot;</span>: <span class="hljs-string">&quot;tes test&quot;</span><br>        &#125;<br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;test_index&quot;</span>,<br>        <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;test_type&quot;</span>,<br>        <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;4&quot;</span>,<br>        <span class="hljs-attr">&quot;_score&quot;</span>: <span class="hljs-number">1</span>,<br>        <span class="hljs-attr">&quot;_source&quot;</span>: &#123;<br>          <span class="hljs-attr">&quot;test_field&quot;</span>: <span class="hljs-string">&quot;test4&quot;</span><br>        &#125;<br>      &#125;<br>    ]<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>第一页document id为：8、6、4</p>
<p>GET /test_index/test_type/_search?from=3&amp;size=3</p>
<p>第二页document id为：2、自动生成的id、7</p>
<p>GET /test_index/test_type/_search?from=6&amp;size=3</p>
<p>第三页document id为：1、11、3</p>
<h5 id="deep-paging性能问题"><a href="#deep-paging性能问题" class="headerlink" title="deep paging性能问题"></a>deep paging性能问题</h5><p>比如index总共有60000条数据，3个shard，每个shard上有20000条数据，如果要搜索10000-10010条，搜索请求首先打到coordinate node上，这时coordinate node会将请求转发到这个index所在的3个shard上去，然后每个shard返回从第1条到10010条数据，coordinate node根据score排序后，获取第10000-10010条数据，这么做的原因是因为，假设每个shard只返回本shard中分页范围内的数据，有一个shard的第10000条数据评分比某个shard的第1条数据评分都要低，合并后的数据就是极其不合理的，如果返回全量数据，完全可以只取评分高的shard中的数据返回。</p>
<h5 id="分页查询执行过程"><a href="#分页查询执行过程" class="headerlink" title="分页查询执行过程"></a>分页查询执行过程</h5><p>query phase阶段</p>
<ol>
<li>搜索请求发送到某一个coordinate node，构建一个priority queue，长度为paging操作的from+size，比如from 10000，size 10，这时的大小为10010</li>
<li>coordinate node将请求转发到所有shard，每个shard本地搜索，并构建一个本地的priority queue，大小与coordinate node上的大小相同。</li>
<li>各个shard将自己的priority queue返回给coordinate node，coordinate node进行merge操作，将数据放入自己的priority queue中，注意如果返回全部数据，这时会消耗大量资源，所以本阶段只收集doc id信息。</li>
</ol>
<p>fetch phase阶段</p>
<ol>
<li>coordinate node构建完priority queue之后，就发送mget请求去所有shard上获取对应的document</li>
<li>各个shard将document返回给coordinate node</li>
<li>coordinate node将合并后的document结果返回给client客户端</li>
</ol>
<p>一般搜索，如果不加from和size，就默认搜索前10条，按照_score排序。可以通过增加replica的方式提升信心能，因为一次请求要打到所有shard的一个replica/primary上去，如果每个shard都有多个replica，那么同时并发过来的搜索请求可以同时打到其他的replica上去。</p>
<h4 id="fliter"><a href="#fliter" class="headerlink" title="fliter"></a>fliter</h4><p>filter与query对比</p>
<ul>
<li><p>filter，仅仅只是按照搜索条件过滤出需要的数据而已，不计算任何相关度分数，对相关度没有任何影响</p>
</li>
<li><p>query，会去计算每个document相对于搜索条件的相关度，并按照相关度进行排序</p>
</li>
</ul>
<p>一般来说，如果需要将最匹配搜索条件的数据先返回，那么用query；如果只是根据一些条件筛选出一部分数据，不关注其排序，那么用filter。除非希望越符合这些搜索条件的document越排在前面返回，那么这些搜索条件要放在query中；如果不希望一些搜索条件来影响document排序，那么就放在filter中即可</p>
<p>filter与query性能</p>
<ul>
<li>filter，不需要计算相关度分数，不需要按照相关度分数进行排序，同时还有内置的自动cache最常使用filter的数据</li>
<li>query，相反，要计算相关度分数，按照分数进行排序，而且无法cache结果</li>
</ul>
<p>搜索商品名称包含yagao，而且售价大于25元的商品</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs ada">GET /ecommerce/product/_search<br>&#123;<br>    <span class="hljs-string">&quot;query&quot;</span> : &#123;<br>        <span class="hljs-string">&quot;bool&quot;</span> : &#123;<br>            <span class="hljs-string">&quot;must&quot;</span> : &#123;<br>                <span class="hljs-string">&quot;match&quot;</span> : &#123;<br>                    <span class="hljs-string">&quot;name&quot;</span> : &quot;<span class="hljs-type">yagao</span><span class="hljs-string">&quot; </span><br><span class="hljs-string">                &#125;</span><br><span class="hljs-string">            &#125;,</span><br><span class="hljs-string">            &quot;</span>filter<span class="hljs-string">&quot; : &#123;</span><br><span class="hljs-string">                &quot;</span><span class="hljs-keyword">range</span><span class="hljs-string">&quot; : &#123;</span><br><span class="hljs-string">                    &quot;</span>price<span class="hljs-string">&quot; : &#123; &quot;</span>gt<span class="hljs-string">&quot; : 25 &#125; </span><br><span class="hljs-string">                &#125;</span><br><span class="hljs-string">            &#125;</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string">&#125;</span><br></code></pre></td></tr></table></figure>

<p>filter在大部分情况下会在query之前执行，先尽量过滤掉尽可能多的数据。</p>
<ol>
<li><p>在倒排索引中查找搜索串，获取document list</p>
</li>
<li><p>为每个在倒排索引中搜索到的结果，构建一个bitset</p>
<p>bitset就是一个二进制的数组，数组每个元素都是0或1，用来标识一个doc对一个filter条件是否匹配，如果匹配就是1，不匹配就是0</p>
</li>
<li><p>遍历每个过滤条件对应的bitset，优先从最稀疏的开始搜索，查找满足所有条件的document</p>
</li>
<li><p>caching bitset，对在最近256个query中超过一定次数的过滤条件，缓存其bitset。对于小segment（&lt;1000，或&lt;3%），则不缓存bitset。</p>
<p>如果document有新增或修改，cached bitset会自动更新。小的segment很快就会被合并，而且扫描也很快，缓存也就没什么意义。</p>
</li>
<li><p>如果filter条件相同，直接使用cached bitset</p>
</li>
</ol>
<h4 id="组合搜索"><a href="#组合搜索" class="headerlink" title="组合搜索"></a>组合搜索</h4><p>搜索帖子ID为XHDK-A-1293-#fJ3，或者是帖子ID为JODL-X-1937-#pV7而且发帖日期为2017-01-01的帖子</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/forum/</span>article/_search <br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;constant_score&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;filter&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;bool&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;should&quot;</span>: [<br>            &#123;<br>              <span class="hljs-string">&quot;term&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;articleID&quot;</span>: <span class="hljs-string">&quot;XHDK-A-1293-#fJ3&quot;</span><br>              &#125;<br>            &#125;,<br>            &#123;<br>              <span class="hljs-string">&quot;bool&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;must&quot;</span>: [<br>                  &#123;<br>                    <span class="hljs-string">&quot;term&quot;</span>:&#123;<br>                      <span class="hljs-string">&quot;articleID&quot;</span>: <span class="hljs-string">&quot;JODL-X-1937-#pV7&quot;</span><br>                    &#125;<br>                  &#125;,<br>                  &#123;<br>                    <span class="hljs-string">&quot;term&quot;</span>: &#123;<br>                      <span class="hljs-string">&quot;postDate&quot;</span>: <span class="hljs-string">&quot;2017-01-01&quot;</span><br>                    &#125;<br>                  &#125;<br>                ]<br>              &#125;<br>            &#125;<br>          ]<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>bool中可以包含must，must_not，should，filter子查询。</p>
<p>每个子查询都会计算一个document针对它的相关度分数，然后bool综合所有分数，合并为一个分数，当然filter是不会计算分数的</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/company/</span>employee/_search <br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;constant_score&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;filter&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;range&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;age&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;gte&quot;</span>: <span class="hljs-number">30</span><br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="多值搜索"><a href="#多值搜索" class="headerlink" title="多值搜索"></a>多值搜索</h4><p>为帖子数据增加tag字段</p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs prolog"><span class="hljs-symbol">POST</span> /forum/article/<span class="hljs-symbol">_bulk</span><br>&#123; <span class="hljs-string">&quot;update&quot;</span>: &#123; <span class="hljs-string">&quot;_id&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>&#125; &#125;<br>&#123; <span class="hljs-string">&quot;doc&quot;</span> : &#123;<span class="hljs-string">&quot;tag&quot;</span> : [<span class="hljs-string">&quot;java&quot;</span>, <span class="hljs-string">&quot;hadoop&quot;</span>]&#125; &#125;<br>&#123; <span class="hljs-string">&quot;update&quot;</span>: &#123; <span class="hljs-string">&quot;_id&quot;</span>: <span class="hljs-string">&quot;2&quot;</span>&#125; &#125;<br>&#123; <span class="hljs-string">&quot;doc&quot;</span> : &#123;<span class="hljs-string">&quot;tag&quot;</span> : [<span class="hljs-string">&quot;java&quot;</span>]&#125; &#125;<br>&#123; <span class="hljs-string">&quot;update&quot;</span>: &#123; <span class="hljs-string">&quot;_id&quot;</span>: <span class="hljs-string">&quot;3&quot;</span>&#125; &#125;<br>&#123; <span class="hljs-string">&quot;doc&quot;</span> : &#123;<span class="hljs-string">&quot;tag&quot;</span> : [<span class="hljs-string">&quot;hadoop&quot;</span>]&#125; &#125;<br>&#123; <span class="hljs-string">&quot;update&quot;</span>: &#123; <span class="hljs-string">&quot;_id&quot;</span>: <span class="hljs-string">&quot;4&quot;</span>&#125; &#125;<br>&#123; <span class="hljs-string">&quot;doc&quot;</span> : &#123;<span class="hljs-string">&quot;tag&quot;</span> : [<span class="hljs-string">&quot;java&quot;</span>, <span class="hljs-string">&quot;elasticsearch&quot;</span>]&#125; &#125;<br></code></pre></td></tr></table></figure>

<p>搜索articleID为KDKE-B-9947-#kL5或QQPX-R-3956-#aD8的帖子</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/forum/</span>article/_search <br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;constant_score&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;filter&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;terms&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;articleID&quot;</span>: [<br>            <span class="hljs-string">&quot;KDKE-B-9947-#kL5&quot;</span>,<br>            <span class="hljs-string">&quot;QQPX-R-3956-#aD8&quot;</span><br>          ]<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>搜索tag中包含java的帖子</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs ada">GET /forum/article/_search<br>&#123;<br>    <span class="hljs-string">&quot;query&quot;</span> : &#123;<br>        <span class="hljs-string">&quot;constant_score&quot;</span> : &#123;<br>            <span class="hljs-string">&quot;filter&quot;</span> : &#123;<br>                <span class="hljs-string">&quot;terms&quot;</span> : &#123; <br>                    <span class="hljs-string">&quot;tag&quot;</span> : [&quot;<span class="hljs-type">java</span><span class="hljs-string">&quot;]</span><br><span class="hljs-string">                &#125;</span><br><span class="hljs-string">            &#125;</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string">&#125;</span><br></code></pre></td></tr></table></figure>

<p>优化搜索结果，仅仅搜索tag只包含java的帖子，需要借助新字段tag_cnt实现</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs n1ql">POST /forum/article/_bulk<br>&#123; &quot;<span class="hljs-keyword">update</span><span class="hljs-string">&quot;: &#123; &quot;</span>_id<span class="hljs-string">&quot;: &quot;</span><span class="hljs-number">1</span><span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span>doc<span class="hljs-string">&quot; : &#123;&quot;</span>tag_cnt<span class="hljs-string">&quot; : 2&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">update</span><span class="hljs-string">&quot;: &#123; &quot;</span>_id<span class="hljs-string">&quot;: &quot;</span><span class="hljs-number">2</span><span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span>doc<span class="hljs-string">&quot; : &#123;&quot;</span>tag_cnt<span class="hljs-string">&quot; : 1&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">update</span><span class="hljs-string">&quot;: &#123; &quot;</span>_id<span class="hljs-string">&quot;: &quot;</span><span class="hljs-number">3</span><span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span>doc<span class="hljs-string">&quot; : &#123;&quot;</span>tag_cnt<span class="hljs-string">&quot; : 1&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">update</span><span class="hljs-string">&quot;: &#123; &quot;</span>_id<span class="hljs-string">&quot;: &quot;</span><span class="hljs-number">4</span><span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span>doc<span class="hljs-string">&quot; : &#123;&quot;</span>tag_cnt<span class="hljs-string">&quot; : 2&#125; &#125;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/forum/</span>article/_search<br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;constant_score&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;filter&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;bool&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;must&quot;</span>: [<br>            &#123;<br>              <span class="hljs-string">&quot;term&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;tag_cnt&quot;</span>: <span class="hljs-number">1</span><br>              &#125;<br>            &#125;,<br>            &#123;<br>              <span class="hljs-string">&quot;terms&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;tag&quot;</span>: [<span class="hljs-string">&quot;java&quot;</span>]<br>              &#125;<br>            &#125;<br>          ]<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>term+bool实现multiword搜索</p>
<p>普通match转换为term+should</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>    <span class="hljs-attr">&quot;match&quot;</span>: &#123; <span class="hljs-attr">&quot;title&quot;</span>: <span class="hljs-string">&quot;java elasticsearch&quot;</span>&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>使用诸如上面的match query进行多值搜索的时候，es会在底层自动将这个match query转换为bool的语法bool should，指定多个搜索词，同时使用term query</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;bool&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;should&quot;</span>: [<br>      &#123; <span class="hljs-attr">&quot;term&quot;</span>: &#123; <span class="hljs-attr">&quot;title&quot;</span>: <span class="hljs-string">&quot;java&quot;</span> &#125;&#125;,<br>      &#123; <span class="hljs-attr">&quot;term&quot;</span>: &#123; <span class="hljs-attr">&quot;title&quot;</span>: <span class="hljs-string">&quot;elasticsearch&quot;</span>   &#125;&#125;<br>    ]<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>and match转换为term+must</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>    <span class="hljs-attr">&quot;match&quot;</span>: &#123;<br>        <span class="hljs-attr">&quot;title&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;query&quot;</span>:    <span class="hljs-string">&quot;java elasticsearch&quot;</span>,<br>            <span class="hljs-attr">&quot;operator&quot;</span>: <span class="hljs-string">&quot;and&quot;</span><br>        &#125;<br>    &#125;<br>&#125;<br><br>&#123;<br>  <span class="hljs-attr">&quot;bool&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;must&quot;</span>: [<br>      &#123; <span class="hljs-attr">&quot;term&quot;</span>: &#123; <span class="hljs-attr">&quot;title&quot;</span>: <span class="hljs-string">&quot;java&quot;</span> &#125;&#125;,<br>      &#123; <span class="hljs-attr">&quot;term&quot;</span>: &#123; <span class="hljs-attr">&quot;title&quot;</span>: <span class="hljs-string">&quot;elasticsearch&quot;</span>   &#125;&#125;<br>    ]<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>minimum_should_match如何转换</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>    <span class="hljs-attr">&quot;match&quot;</span>: &#123;<br>        <span class="hljs-attr">&quot;title&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;query&quot;</span>:                <span class="hljs-string">&quot;java elasticsearch hadoop spark&quot;</span>,<br>            <span class="hljs-attr">&quot;minimum_should_match&quot;</span>: <span class="hljs-string">&quot;75%&quot;</span><br>        &#125;<br>    &#125;<br>&#125;<br><br>&#123;<br>  <span class="hljs-attr">&quot;bool&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;should&quot;</span>: [<br>      &#123; <span class="hljs-attr">&quot;term&quot;</span>: &#123; <span class="hljs-attr">&quot;title&quot;</span>: <span class="hljs-string">&quot;java&quot;</span> &#125;&#125;,<br>      &#123; <span class="hljs-attr">&quot;term&quot;</span>: &#123; <span class="hljs-attr">&quot;title&quot;</span>: <span class="hljs-string">&quot;elasticsearch&quot;</span>   &#125;&#125;,<br>      &#123; <span class="hljs-attr">&quot;term&quot;</span>: &#123; <span class="hljs-attr">&quot;title&quot;</span>: <span class="hljs-string">&quot;hadoop&quot;</span> &#125;&#125;,<br>      &#123; <span class="hljs-attr">&quot;term&quot;</span>: &#123; <span class="hljs-attr">&quot;title&quot;</span>: <span class="hljs-string">&quot;spark&quot;</span> &#125;&#125;<br>    ],<br>    <span class="hljs-attr">&quot;minimum_should_match&quot;</span>: <span class="hljs-number">3</span> <br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="范围过滤"><a href="#范围过滤" class="headerlink" title="范围过滤"></a>范围过滤</h4><p>增加浏览量的字段</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs n1ql">POST /forum/article/_bulk<br>&#123; &quot;<span class="hljs-keyword">update</span><span class="hljs-string">&quot;: &#123; &quot;</span>_id<span class="hljs-string">&quot;: &quot;</span><span class="hljs-number">1</span><span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span>doc<span class="hljs-string">&quot; : &#123;&quot;</span>view_cnt<span class="hljs-string">&quot; : 30&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">update</span><span class="hljs-string">&quot;: &#123; &quot;</span>_id<span class="hljs-string">&quot;: &quot;</span><span class="hljs-number">2</span><span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span>doc<span class="hljs-string">&quot; : &#123;&quot;</span>view_cnt<span class="hljs-string">&quot; : 50&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">update</span><span class="hljs-string">&quot;: &#123; &quot;</span>_id<span class="hljs-string">&quot;: &quot;</span><span class="hljs-number">3</span><span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span>doc<span class="hljs-string">&quot; : &#123;&quot;</span>view_cnt<span class="hljs-string">&quot; : 100&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">update</span><span class="hljs-string">&quot;: &#123; &quot;</span>_id<span class="hljs-string">&quot;: &quot;</span><span class="hljs-number">4</span><span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span>doc<span class="hljs-string">&quot; : &#123;&quot;</span>view_cnt<span class="hljs-string">&quot; : 80&#125; &#125;</span><br></code></pre></td></tr></table></figure>

<p>搜索浏览量在30~60之间的帖子</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/forum/</span>article/_search<br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;constant_score&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;filter&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;range&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;view_cnt&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;gt&quot;</span>: <span class="hljs-number">30</span>,<br>            <span class="hljs-string">&quot;lt&quot;</span>: <span class="hljs-number">60</span><br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>添加数据</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs gradle">POST <span class="hljs-regexp">/forum/</span>article/_bulk<br>&#123; <span class="hljs-string">&quot;index&quot;</span>: &#123; <span class="hljs-string">&quot;_id&quot;</span>: <span class="hljs-number">5</span> &#125;&#125;<br>&#123; <span class="hljs-string">&quot;articleID&quot;</span> : <span class="hljs-string">&quot;DHJK-B-1395-#Ky5&quot;</span>, <span class="hljs-string">&quot;userID&quot;</span> : <span class="hljs-number">3</span>, <span class="hljs-string">&quot;hidden&quot;</span>: <span class="hljs-keyword">false</span>, <span class="hljs-string">&quot;postDate&quot;</span>: <span class="hljs-string">&quot;2017-03-01&quot;</span>, <span class="hljs-string">&quot;tag&quot;</span>: [<span class="hljs-string">&quot;elasticsearch&quot;</span>], <span class="hljs-string">&quot;tag_cnt&quot;</span>: <span class="hljs-number">1</span>, <span class="hljs-string">&quot;view_cnt&quot;</span>: <span class="hljs-number">10</span> &#125;<br></code></pre></td></tr></table></figure>

<p>搜索发帖日期在最近1个月的帖子</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/forum/</span>article/_search <br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;constant_score&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;filter&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;range&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;postDate&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;gt&quot;</span>: <span class="hljs-string">&quot;2017-03-10||-30d&quot;</span><br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br><br>GET <span class="hljs-regexp">/forum/</span>article/_search <br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;constant_score&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;filter&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;range&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;postDate&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;gt&quot;</span>: <span class="hljs-string">&quot;now-30d&quot;</span><br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="搜索是否合法"><a href="#搜索是否合法" class="headerlink" title="搜索是否合法"></a>搜索是否合法</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/test_index/</span>test_type<span class="hljs-regexp">/_validate/</span>query?explain<br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;math&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;test_field&quot;</span>: <span class="hljs-string">&quot;test&quot;</span><br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;valid&quot;</span>: <span class="hljs-literal">false</span>,<br>  <span class="hljs-attr">&quot;error&quot;</span>: <span class="hljs-string">&quot;org.elasticsearch.common.ParsingException: no [query] registered for [math]&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs gradle">GET <span class="hljs-regexp">/test_index/</span>test_type<span class="hljs-regexp">/_validate/</span>query?explain<br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;test_field&quot;</span>: <span class="hljs-string">&quot;test&quot;</span><br>    &#125;<br>  &#125;<br>&#125;<br><br>&#123;<br>  <span class="hljs-string">&quot;valid&quot;</span>: <span class="hljs-keyword">true</span>,<br>  <span class="hljs-string">&quot;_shards&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;total&quot;</span>: <span class="hljs-number">1</span>,<br>    <span class="hljs-string">&quot;successful&quot;</span>: <span class="hljs-number">1</span>,<br>    <span class="hljs-string">&quot;failed&quot;</span>: <span class="hljs-number">0</span><br>  &#125;,<br>  <span class="hljs-string">&quot;explanations&quot;</span>: [<br>    &#123;<br>      <span class="hljs-string">&quot;index&quot;</span>: <span class="hljs-string">&quot;test_index&quot;</span>,<br>      <span class="hljs-string">&quot;valid&quot;</span>: <span class="hljs-keyword">true</span>,<br>      <span class="hljs-string">&quot;explanation&quot;</span>: <span class="hljs-string">&quot;+test_field:test #(#_type:test_type)&quot;</span><br>    &#125;<br>  ]<br>&#125;<br></code></pre></td></tr></table></figure>

<p>一般用在那种特别复杂庞大的搜索下，比如你一下子写了上百行的搜索，这个时候可以先用validate api去验证一下，搜索是否合法</p>
<h4 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h4><p>默认情况下，是按照_score降序排序的，然而某些情况下，可能没有可用的_score，比如说filter查询产生的结果</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs ada">GET /_search<br>&#123;<br>    <span class="hljs-string">&quot;query&quot;</span> : &#123;<br>        <span class="hljs-string">&quot;bool&quot;</span> : &#123;<br>            <span class="hljs-string">&quot;filter&quot;</span> : &#123;<br>                <span class="hljs-string">&quot;term&quot;</span> : &#123;<br>                    <span class="hljs-string">&quot;author_id&quot;</span> : 1<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>当然，也可以是constant_score</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs ada">GET /_search<br>&#123;<br>    <span class="hljs-string">&quot;query&quot;</span> : &#123;<br>        <span class="hljs-string">&quot;constant_score&quot;</span> : &#123;<br>            <span class="hljs-string">&quot;filter&quot;</span> : &#123;<br>                <span class="hljs-string">&quot;term&quot;</span> : &#123;<br>                    <span class="hljs-string">&quot;author_id&quot;</span> : 1<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这时就可以使用定制排序规则</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/company/</span>employee/_search <br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;constant_score&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;filter&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;range&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;age&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;gte&quot;</span>: <span class="hljs-number">30</span><br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;,<br>  <span class="hljs-string">&quot;sort&quot;</span>: [<br>    &#123;<br>      <span class="hljs-string">&quot;join_date&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;order&quot;</span>: <span class="hljs-string">&quot;asc&quot;</span><br>      &#125;<br>    &#125;<br>  ]<br>&#125;<br></code></pre></td></tr></table></figure>

<p>如果对一个string field进行排序，结果往往不准确，因为分词后是多个单词，再排序就不是我们想要的结果了，通常解决方案是，将一个string field建立两次索引，一个分词，用来进行搜索；一个不分词，用来进行排序</p>
<p>创建mapping</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">PUT <span class="hljs-string">/website</span> <br>&#123;<br>  <span class="hljs-string">&quot;mappings&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;article&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;title&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span>,<br>          <span class="hljs-string">&quot;fields&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;raw&quot;</span>: &#123;<br>              <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;string&quot;</span>,<br>              <span class="hljs-string">&quot;index&quot;</span>: <span class="hljs-string">&quot;not_analyzed&quot;</span><br>            &#125;<br>          &#125;,<br>          <span class="hljs-string">&quot;fielddata&quot;</span>: <span class="hljs-literal">true</span><br>        &#125;,<br>        <span class="hljs-string">&quot;content&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span><br>        &#125;,<br>        <span class="hljs-string">&quot;post_date&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;date&quot;</span><br>        &#125;,<br>        <span class="hljs-string">&quot;author_id&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;long&quot;</span><br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>搜索示例：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/website/</span>article/_search<br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;match_all&quot;</span>: &#123;&#125;<br>  &#125;,<br>  <span class="hljs-string">&quot;sort&quot;</span>: [<br>    &#123;<br>      <span class="hljs-string">&quot;title.raw&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;order&quot;</span>: <span class="hljs-string">&quot;desc&quot;</span><br>      &#125;<br>    &#125;<br>  ]<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="精确度控制"><a href="#精确度控制" class="headerlink" title="精确度控制"></a>精确度控制</h4><p>为帖子数据增加标题字段</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs n1ql">POST /forum/article/_bulk<br>&#123; &quot;<span class="hljs-keyword">update</span><span class="hljs-string">&quot;: &#123; &quot;</span>_id<span class="hljs-string">&quot;: &quot;</span><span class="hljs-number">1</span><span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span>doc<span class="hljs-string">&quot; : &#123;&quot;</span><span class="hljs-built_in">title</span><span class="hljs-string">&quot; : &quot;</span>this <span class="hljs-keyword">is</span> java <span class="hljs-keyword">and</span> elasticsearch blog<span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">update</span><span class="hljs-string">&quot;: &#123; &quot;</span>_id<span class="hljs-string">&quot;: &quot;</span><span class="hljs-number">2</span><span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span>doc<span class="hljs-string">&quot; : &#123;&quot;</span><span class="hljs-built_in">title</span><span class="hljs-string">&quot; : &quot;</span>this <span class="hljs-keyword">is</span> java blog<span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">update</span><span class="hljs-string">&quot;: &#123; &quot;</span>_id<span class="hljs-string">&quot;: &quot;</span><span class="hljs-number">3</span><span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span>doc<span class="hljs-string">&quot; : &#123;&quot;</span><span class="hljs-built_in">title</span><span class="hljs-string">&quot; : &quot;</span>this <span class="hljs-keyword">is</span> elasticsearch blog<span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">update</span><span class="hljs-string">&quot;: &#123; &quot;</span>_id<span class="hljs-string">&quot;: &quot;</span><span class="hljs-number">4</span><span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span>doc<span class="hljs-string">&quot; : &#123;&quot;</span><span class="hljs-built_in">title</span><span class="hljs-string">&quot; : &quot;</span>this <span class="hljs-keyword">is</span> java, elasticsearch, hadoop blog<span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">update</span><span class="hljs-string">&quot;: &#123; &quot;</span>_id<span class="hljs-string">&quot;: &quot;</span><span class="hljs-number">5</span><span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span>doc<span class="hljs-string">&quot; : &#123;&quot;</span><span class="hljs-built_in">title</span><span class="hljs-string">&quot; : &quot;</span>this <span class="hljs-keyword">is</span> spark blog<span class="hljs-string">&quot;&#125; &#125;</span><br></code></pre></td></tr></table></figure>

<p>搜索标题中包含java或elasticsearch的blog</p>
<p>此时需要进行full text全文检索，而不是exact value，所以需要使用match query，如果被检索的field是not_analyzed类型的，match_query也就跟term query相同。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/forum/</span>article/_search<br>&#123;<br>    <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;java elasticsearch&quot;</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>搜索标题中包含java和elasticsearch的blog</p>
<p>搜索结果精准控制的第一步：灵活使用and关键字，如果你是希望所有的搜索关键字都要匹配的，那么就用and，可以实现单纯match query无法实现的效果</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/forum/</span>article/_search<br>&#123;<br>    <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;title&quot;</span>: &#123;<br>		<span class="hljs-string">&quot;query&quot;</span>: <span class="hljs-string">&quot;java elasticsearch&quot;</span>,<br>		<span class="hljs-string">&quot;operator&quot;</span>: <span class="hljs-string">&quot;and&quot;</span><br>   	    &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>搜索包含java，elasticsearch，spark，hadoop，4个关键字中，至少3个的blog</p>
<p>控制搜索结果的精准度的第二步：指定一些关键字中，必须至少匹配其中的多少个关键字，才能作为结果返回</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/forum/</span>article/_search<br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;title&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;query&quot;</span>: <span class="hljs-string">&quot;java elasticsearch spark hadoop&quot;</span>,<br>        <span class="hljs-string">&quot;minimum_should_match&quot;</span>: <span class="hljs-string">&quot;75%&quot;</span><br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>用bool组合多个搜索条件，来搜索title</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/forum/</span>article/_search<br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;bool&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;must&quot;</span>:     &#123; <span class="hljs-string">&quot;match&quot;</span>: &#123; <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;java&quot;</span> &#125;&#125;,<br>      <span class="hljs-string">&quot;must_not&quot;</span>: &#123; <span class="hljs-string">&quot;match&quot;</span>: &#123; <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;spark&quot;</span>  &#125;&#125;,<br>      <span class="hljs-string">&quot;should&quot;</span>: [<br>                  &#123; <span class="hljs-string">&quot;match&quot;</span>: &#123; <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;hadoop&quot;</span> &#125;&#125;,<br>                  &#123; <span class="hljs-string">&quot;match&quot;</span>: &#123; <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;elasticsearch&quot;</span>   &#125;&#125;<br>      ]<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>bool组合多个搜索条件，relevance score计算方式为：must和should搜索对应的分数，加起来，除以must和should的总数。</p>
<p>在上面的搜索中，相关度分数是由should影响的。</p>
<p>must用来确保这个这个关键字必须存在，同时会根据这个must的条件去计算出document对这个搜索条件的relevance score</p>
<p>在满足must的基础之上，should中的条件，不匹配也可以，但是如果匹配的更多，那么document的relevance score就会更高</p>
<p>搜索java，hadoop，spark，elasticsearch，至少包含其中3个关键字</p>
<p>默认情况下，should是可以不匹配任何一个的，如果没有must的话，那么should中必须至少匹配一个才可以，比如下面的搜索，should中有4个条件，默认情况下，只要满足其中一个条件，就可以匹配作为结果返回</p>
<p>但是可以精准控制，should的4个条件中，至少匹配几个才能作为结果返回</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/forum/</span>article/_search<br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;bool&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;should&quot;</span>: [<br>        &#123; <span class="hljs-string">&quot;match&quot;</span>: &#123; <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;java&quot;</span> &#125;&#125;,<br>        &#123; <span class="hljs-string">&quot;match&quot;</span>: &#123; <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;elasticsearch&quot;</span>   &#125;&#125;,<br>        &#123; <span class="hljs-string">&quot;match&quot;</span>: &#123; <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;hadoop&quot;</span>   &#125;&#125;,<br>	&#123; <span class="hljs-string">&quot;match&quot;</span>: &#123; <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;spark&quot;</span>   &#125;&#125;<br>      ],<br>      <span class="hljs-string">&quot;minimum_should_match&quot;</span>: <span class="hljs-number">3</span> <br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="权重控制"><a href="#权重控制" class="headerlink" title="权重控制"></a>权重控制</h4><p>搜索标题中包含java的帖子，如果标题中包含hadoop或elasticsearch就优先搜索出来，如果一个帖子包含java hadoop，一个帖子包含java elasticsearch，包含hadoop的帖子要比elasticsearch优先搜索出来</p>
<p>知识点，搜索条件的权重，boost，可以将某个搜索条件的权重加大，此时当匹配这个搜索条件和匹配另一个搜索条件的document，计算relevance score时，匹配权重更大的搜索条件的document，relevance score会更高，当然也就会优先被返回回来</p>
<p>默认情况下，搜索条件的权重都是一样的，都是1</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/forum/</span>article/_search <br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;bool&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;must&quot;</span>: [<br>        &#123;<br>          <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;blog&quot;</span><br>          &#125;<br>        &#125;<br>      ],<br>      <span class="hljs-string">&quot;should&quot;</span>: [<br>        &#123;<br>          <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;title&quot;</span>: &#123;<br>              <span class="hljs-string">&quot;query&quot;</span>: <span class="hljs-string">&quot;java&quot;</span><br>            &#125;<br>          &#125;<br>        &#125;,<br>        &#123;<br>          <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;title&quot;</span>: &#123;<br>              <span class="hljs-string">&quot;query&quot;</span>: <span class="hljs-string">&quot;hadoop&quot;</span>,<br>              <span class="hljs-string">&quot;boost&quot;</span>: <span class="hljs-number">3</span><br>            &#125;<br>          &#125;<br>        &#125;,<br>        &#123;<br>          <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;title&quot;</span>: &#123;<br>              <span class="hljs-string">&quot;query&quot;</span>: <span class="hljs-string">&quot;elasticsearch&quot;</span>,<br>              <span class="hljs-string">&quot;boost&quot;</span>: <span class="hljs-number">2</span><br>            &#125;<br>          &#125;<br>        &#125;<br>      ]<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="聚合分析"><a href="#聚合分析" class="headerlink" title="聚合分析"></a>聚合分析</h3><p>聚合分析通常使用agg操作来进行，其中有bucket与metric两个核心概念</p>
<p>bucket：按照某个字段进行bucket划分，值相同的数据会划分到一个bucket中</p>
<p>metric：就是对一个bucket执行的某种聚合分析的操作，比如求平均值、最大值、最小值</p>
<h4 id="简单聚合分析"><a href="#简单聚合分析" class="headerlink" title="简单聚合分析"></a>简单聚合分析</h4><p>以一个家电卖场中的电视销售数据为背景，来对各种品牌，各种颜色的电视的销量和销售额，进行各种各样角度的分析。</p>
<p>测试数据</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs dts">PUT /tvs<br>&#123;<br>	<span class="hljs-string">&quot;mappings&quot;</span>: &#123;<br>		<span class="hljs-string">&quot;sales&quot;</span>: &#123;<br>			<span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>				<span class="hljs-string">&quot;price&quot;</span>: &#123;<br>					<span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;long&quot;</span><br>				&#125;,<br>				<span class="hljs-string">&quot;color&quot;</span>: &#123;<br>					<span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;keyword&quot;</span><br>				&#125;,<br>				<span class="hljs-string">&quot;brand&quot;</span>: &#123;<br>					<span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;keyword&quot;</span><br>				&#125;,<br>				<span class="hljs-string">&quot;sold_date&quot;</span>: &#123;<br>					<span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;date&quot;</span><br>				&#125;<br>			&#125;<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs n1ql">POST /tvs/sales/_bulk<br>&#123; &quot;<span class="hljs-keyword">index</span><span class="hljs-string">&quot;: &#123;&#125;&#125;</span><br><span class="hljs-string">&#123; &quot;</span>price<span class="hljs-string">&quot; : 1000, &quot;</span>color<span class="hljs-string">&quot; : &quot;</span>红色<span class="hljs-string">&quot;, &quot;</span>brand<span class="hljs-string">&quot; : &quot;</span>长虹<span class="hljs-string">&quot;, &quot;</span>sold_date<span class="hljs-string">&quot; : &quot;</span><span class="hljs-number">2016</span><span class="hljs-number">-10</span><span class="hljs-number">-28</span><span class="hljs-string">&quot; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">index</span><span class="hljs-string">&quot;: &#123;&#125;&#125;</span><br><span class="hljs-string">&#123; &quot;</span>price<span class="hljs-string">&quot; : 2000, &quot;</span>color<span class="hljs-string">&quot; : &quot;</span>红色<span class="hljs-string">&quot;, &quot;</span>brand<span class="hljs-string">&quot; : &quot;</span>长虹<span class="hljs-string">&quot;, &quot;</span>sold_date<span class="hljs-string">&quot; : &quot;</span><span class="hljs-number">2016</span><span class="hljs-number">-11</span><span class="hljs-number">-05</span><span class="hljs-string">&quot; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">index</span><span class="hljs-string">&quot;: &#123;&#125;&#125;</span><br><span class="hljs-string">&#123; &quot;</span>price<span class="hljs-string">&quot; : 3000, &quot;</span>color<span class="hljs-string">&quot; : &quot;</span>绿色<span class="hljs-string">&quot;, &quot;</span>brand<span class="hljs-string">&quot; : &quot;</span>小米<span class="hljs-string">&quot;, &quot;</span>sold_date<span class="hljs-string">&quot; : &quot;</span><span class="hljs-number">2016</span><span class="hljs-number">-05</span><span class="hljs-number">-18</span><span class="hljs-string">&quot; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">index</span><span class="hljs-string">&quot;: &#123;&#125;&#125;</span><br><span class="hljs-string">&#123; &quot;</span>price<span class="hljs-string">&quot; : 1500, &quot;</span>color<span class="hljs-string">&quot; : &quot;</span>蓝色<span class="hljs-string">&quot;, &quot;</span>brand<span class="hljs-string">&quot; : &quot;</span>TCL<span class="hljs-string">&quot;, &quot;</span>sold_date<span class="hljs-string">&quot; : &quot;</span><span class="hljs-number">2016</span><span class="hljs-number">-07</span><span class="hljs-number">-02</span><span class="hljs-string">&quot; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">index</span><span class="hljs-string">&quot;: &#123;&#125;&#125;</span><br><span class="hljs-string">&#123; &quot;</span>price<span class="hljs-string">&quot; : 1200, &quot;</span>color<span class="hljs-string">&quot; : &quot;</span>绿色<span class="hljs-string">&quot;, &quot;</span>brand<span class="hljs-string">&quot; : &quot;</span>TCL<span class="hljs-string">&quot;, &quot;</span>sold_date<span class="hljs-string">&quot; : &quot;</span><span class="hljs-number">2016</span><span class="hljs-number">-08</span><span class="hljs-number">-19</span><span class="hljs-string">&quot; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">index</span><span class="hljs-string">&quot;: &#123;&#125;&#125;</span><br><span class="hljs-string">&#123; &quot;</span>price<span class="hljs-string">&quot; : 2000, &quot;</span>color<span class="hljs-string">&quot; : &quot;</span>红色<span class="hljs-string">&quot;, &quot;</span>brand<span class="hljs-string">&quot; : &quot;</span>长虹<span class="hljs-string">&quot;, &quot;</span>sold_date<span class="hljs-string">&quot; : &quot;</span><span class="hljs-number">2016</span><span class="hljs-number">-11</span><span class="hljs-number">-05</span><span class="hljs-string">&quot; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">index</span><span class="hljs-string">&quot;: &#123;&#125;&#125;</span><br><span class="hljs-string">&#123; &quot;</span>price<span class="hljs-string">&quot; : 8000, &quot;</span>color<span class="hljs-string">&quot; : &quot;</span>红色<span class="hljs-string">&quot;, &quot;</span>brand<span class="hljs-string">&quot; : &quot;</span>三星<span class="hljs-string">&quot;, &quot;</span>sold_date<span class="hljs-string">&quot; : &quot;</span><span class="hljs-number">2017</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span><span class="hljs-string">&quot; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">index</span><span class="hljs-string">&quot;: &#123;&#125;&#125;</span><br><span class="hljs-string">&#123; &quot;</span>price<span class="hljs-string">&quot; : 2500, &quot;</span>color<span class="hljs-string">&quot; : &quot;</span>蓝色<span class="hljs-string">&quot;, &quot;</span>brand<span class="hljs-string">&quot; : &quot;</span>小米<span class="hljs-string">&quot;, &quot;</span>sold_date<span class="hljs-string">&quot; : &quot;</span><span class="hljs-number">2017</span><span class="hljs-number">-02</span><span class="hljs-number">-12</span><span class="hljs-string">&quot; &#125;</span><br></code></pre></td></tr></table></figure>

<p>2、统计哪种颜色的电视销量最高</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs ada">GET /tvs/sales/_search<br>&#123;<br>    <span class="hljs-string">&quot;size&quot;</span> : 0,<br>    <span class="hljs-string">&quot;aggs&quot;</span> : &#123; <br>        <span class="hljs-string">&quot;popular_colors&quot;</span> : &#123; <br>            <span class="hljs-string">&quot;terms&quot;</span> : &#123; <br>              <span class="hljs-string">&quot;field&quot;</span> : &quot;<span class="hljs-type">color</span><span class="hljs-string">&quot;</span><br><span class="hljs-string">            &#125;</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string">&#125;</span><br></code></pre></td></tr></table></figure>

<ul>
<li><p>size：0标志只获取聚合结果，而不要执行聚合的原始数据</p>
</li>
<li><p>aggs：固定语法，要对一份数据执行分组聚合操作</p>
</li>
<li><p>popular_colors：就是对每个aggs，都要起一个名字，随便取什么都可以</p>
</li>
<li><p>terms：根据指定字段的值进行分组</p>
</li>
<li><p>field：指定字段的名称</p>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;took&quot;</span>: <span class="hljs-number">61</span>,<br>  <span class="hljs-attr">&quot;timed_out&quot;</span>: <span class="hljs-literal">false</span>,<br>  <span class="hljs-attr">&quot;_shards&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">5</span>,<br>    <span class="hljs-attr">&quot;successful&quot;</span>: <span class="hljs-number">5</span>,<br>    <span class="hljs-attr">&quot;failed&quot;</span>: <span class="hljs-number">0</span><br>  &#125;,<br>  <span class="hljs-attr">&quot;hits&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">8</span>,<br>    <span class="hljs-attr">&quot;max_score&quot;</span>: <span class="hljs-number">0</span>,<br>    <span class="hljs-attr">&quot;hits&quot;</span>: []<br>  &#125;,<br>  <span class="hljs-attr">&quot;aggregations&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;popular_color&quot;</span>: &#123;<br>      <span class="hljs-attr">&quot;doc_count_error_upper_bound&quot;</span>: <span class="hljs-number">0</span>,<br>      <span class="hljs-attr">&quot;sum_other_doc_count&quot;</span>: <span class="hljs-number">0</span>,<br>      <span class="hljs-attr">&quot;buckets&quot;</span>: [<br>        &#123;<br>          <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-string">&quot;红色&quot;</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">4</span><br>        &#125;,<br>        &#123;<br>          <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-string">&quot;绿色&quot;</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">2</span><br>        &#125;,<br>        &#123;<br>          <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-string">&quot;蓝色&quot;</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">2</span><br>        &#125;<br>      ]<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>hits.hits：我们指定了size是0，所以hits.hits就是空的，否则会把执行聚合的那些原始数据返回回来</li>
<li>aggregations：聚合结果</li>
<li>popular_color：指定的某个聚合的名称</li>
<li>buckets：根据我们指定的field划分出的buckets</li>
<li>key：每个bucket对应的那个值</li>
<li>doc_count：这个bucket分组内，有多少个数据数量，其实就是这种颜色的销量，每种颜色对应的bucket中的数据的默认的排序规则：按照doc_count降序排序。 </li>
</ul>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/tvs/</span>sales/_search<br>&#123;<br>   <span class="hljs-string">&quot;size&quot;</span> : <span class="hljs-number">0</span>,<br>   <span class="hljs-string">&quot;aggs&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;colors&quot;</span>: &#123;<br>         <span class="hljs-string">&quot;terms&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;color&quot;</span><br>         &#125;,<br>         <span class="hljs-string">&quot;aggs&quot;</span>: &#123; <br>            <span class="hljs-string">&quot;avg_price&quot;</span>: &#123; <br>               <span class="hljs-string">&quot;avg&quot;</span>: &#123;<br>                  <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;price&quot;</span> <br>               &#125;<br>            &#125;<br>         &#125;<br>      &#125;<br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>按照color划分bucket，可以拿到每个color bucket中的数量，这个仅仅只是一个bucket操作，doc_count其实只是es的bucket操作默认执行的一个内置metric</p>
<p>除了bucket操作，分组，还可以对每个bucket执行一个metric聚合统计操作</p>
<p>在一个aggs执行的bucket操作（terms）的平级的json结构下，再加一个aggs，这个aggs内部，同样取个名字，执行一个metric操作：avg，对之前的每个bucket中的数据的指定的field：price field，就是对一个bucket分组操作之后，再去求这个bucket分组的平均值，每个bucket分组都要执行。</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs 1c"><span class="hljs-string">&quot;aggs&quot;</span>: &#123; <br>   <span class="hljs-string">&quot;avg_price&quot;</span>: &#123; <br>      <span class="hljs-string">&quot;avg&quot;</span>: &#123;<br>         <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;price&quot;</span> <br>      &#125;<br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;took&quot;</span>: <span class="hljs-number">28</span>,<br>  <span class="hljs-attr">&quot;timed_out&quot;</span>: <span class="hljs-literal">false</span>,<br>  <span class="hljs-attr">&quot;_shards&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">5</span>,<br>    <span class="hljs-attr">&quot;successful&quot;</span>: <span class="hljs-number">5</span>,<br>    <span class="hljs-attr">&quot;failed&quot;</span>: <span class="hljs-number">0</span><br>  &#125;,<br>  <span class="hljs-attr">&quot;hits&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">8</span>,<br>    <span class="hljs-attr">&quot;max_score&quot;</span>: <span class="hljs-number">0</span>,<br>    <span class="hljs-attr">&quot;hits&quot;</span>: []<br>  &#125;,<br>  <span class="hljs-attr">&quot;aggregations&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;group_by_color&quot;</span>: &#123;<br>      <span class="hljs-attr">&quot;doc_count_error_upper_bound&quot;</span>: <span class="hljs-number">0</span>,<br>      <span class="hljs-attr">&quot;sum_other_doc_count&quot;</span>: <span class="hljs-number">0</span>,<br>      <span class="hljs-attr">&quot;buckets&quot;</span>: [<br>        &#123;<br>          <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-string">&quot;红色&quot;</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">4</span>,<br>          <span class="hljs-attr">&quot;avg_price&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">3250</span><br>          &#125;<br>        &#125;,<br>        &#123;<br>          <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-string">&quot;绿色&quot;</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">2</span>,<br>          <span class="hljs-attr">&quot;avg_price&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">2100</span><br>          &#125;<br>        &#125;,<br>        &#123;<br>          <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-string">&quot;蓝色&quot;</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">2</span>,<br>          <span class="hljs-attr">&quot;avg_price&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">2000</span><br>          &#125;<br>        &#125;<br>      ]<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>此时buckets，除了key和doc_count中还有：</p>
<ul>
<li>avg_price：我们自己取的metric aggs的名字</li>
<li>value：我们的metric计算的结果，每个bucket中的数据的price字段求平均值后的结果</li>
</ul>
<h4 id="多层下钻分析"><a href="#多层下钻分析" class="headerlink" title="多层下钻分析"></a>多层下钻分析</h4><p>从颜色到品牌进行下钻分析，每种颜色的平均价格，以及找到每种颜色每个品牌的平均价格。就是指对颜色进行分组后，对分组内的数据再次分组，然后执行聚合分析操作。es的下钻分析就是对bucket进行多层嵌套，多次分组，每层的bucket都可以执行吃一次metric聚合操作。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/tvs/</span>sales/_search <br>&#123;<br>  <span class="hljs-string">&quot;size&quot;</span>: <span class="hljs-number">0</span>,<br>  <span class="hljs-string">&quot;aggs&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;group_by_color&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;terms&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;color&quot;</span><br>      &#125;,<br>      <span class="hljs-string">&quot;aggs&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;color_avg_price&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;avg&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;price&quot;</span><br>          &#125;<br>        &#125;,<br>        <span class="hljs-string">&quot;group_by_brand&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;terms&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;brand&quot;</span><br>          &#125;,<br>          <span class="hljs-string">&quot;aggs&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;brand_avg_price&quot;</span>: &#123;<br>              <span class="hljs-string">&quot;avg&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;price&quot;</span><br>              &#125;<br>            &#125;<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>返回结果</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;took&quot;</span>: <span class="hljs-number">8</span>,<br>  <span class="hljs-attr">&quot;timed_out&quot;</span>: <span class="hljs-literal">false</span>,<br>  <span class="hljs-attr">&quot;_shards&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">5</span>,<br>    <span class="hljs-attr">&quot;successful&quot;</span>: <span class="hljs-number">5</span>,<br>    <span class="hljs-attr">&quot;failed&quot;</span>: <span class="hljs-number">0</span><br>  &#125;,<br>  <span class="hljs-attr">&quot;hits&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">8</span>,<br>    <span class="hljs-attr">&quot;max_score&quot;</span>: <span class="hljs-number">0</span>,<br>    <span class="hljs-attr">&quot;hits&quot;</span>: []<br>  &#125;,<br>  <span class="hljs-attr">&quot;aggregations&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;group_by_color&quot;</span>: &#123;<br>      <span class="hljs-attr">&quot;doc_count_error_upper_bound&quot;</span>: <span class="hljs-number">0</span>,<br>      <span class="hljs-attr">&quot;sum_other_doc_count&quot;</span>: <span class="hljs-number">0</span>,<br>      <span class="hljs-attr">&quot;buckets&quot;</span>: [<br>        &#123;<br>          <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-string">&quot;红色&quot;</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">4</span>,<br>          <span class="hljs-attr">&quot;color_avg_price&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">3250</span><br>          &#125;,<br>          <span class="hljs-attr">&quot;group_by_brand&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;doc_count_error_upper_bound&quot;</span>: <span class="hljs-number">0</span>,<br>            <span class="hljs-attr">&quot;sum_other_doc_count&quot;</span>: <span class="hljs-number">0</span>,<br>            <span class="hljs-attr">&quot;buckets&quot;</span>: [<br>              &#123;<br>                <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-string">&quot;长虹&quot;</span>,<br>                <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">3</span>,<br>                <span class="hljs-attr">&quot;brand_avg_price&quot;</span>: &#123;<br>                  <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">1666.6666666666667</span><br>                &#125;<br>              &#125;,<br>              &#123;<br>                <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-string">&quot;三星&quot;</span>,<br>                <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">1</span>,<br>                <span class="hljs-attr">&quot;brand_avg_price&quot;</span>: &#123;<br>                  <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">8000</span><br>                &#125;<br>              &#125;<br>            ]<br>          &#125;<br>        &#125;,<br>        &#123;<br>          <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-string">&quot;绿色&quot;</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">2</span>,<br>          <span class="hljs-attr">&quot;color_avg_price&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">2100</span><br>          &#125;,<br>          <span class="hljs-attr">&quot;group_by_brand&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;doc_count_error_upper_bound&quot;</span>: <span class="hljs-number">0</span>,<br>            <span class="hljs-attr">&quot;sum_other_doc_count&quot;</span>: <span class="hljs-number">0</span>,<br>            <span class="hljs-attr">&quot;buckets&quot;</span>: [<br>              &#123;<br>                <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-string">&quot;TCL&quot;</span>,<br>                <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">1</span>,<br>                <span class="hljs-attr">&quot;brand_avg_price&quot;</span>: &#123;<br>                  <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">1200</span><br>                &#125;<br>              &#125;,<br>              &#123;<br>                <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-string">&quot;小米&quot;</span>,<br>                <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">1</span>,<br>                <span class="hljs-attr">&quot;brand_avg_price&quot;</span>: &#123;<br>                  <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">3000</span><br>                &#125;<br>              &#125;<br>            ]<br>          &#125;<br>        &#125;,<br>        &#123;<br>          <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-string">&quot;蓝色&quot;</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">2</span>,<br>          <span class="hljs-attr">&quot;color_avg_price&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">2000</span><br>          &#125;,<br>          <span class="hljs-attr">&quot;group_by_brand&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;doc_count_error_upper_bound&quot;</span>: <span class="hljs-number">0</span>,<br>            <span class="hljs-attr">&quot;sum_other_doc_count&quot;</span>: <span class="hljs-number">0</span>,<br>            <span class="hljs-attr">&quot;buckets&quot;</span>: [<br>              &#123;<br>                <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-string">&quot;TCL&quot;</span>,<br>                <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">1</span>,<br>                <span class="hljs-attr">&quot;brand_avg_price&quot;</span>: &#123;<br>                  <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">1500</span><br>                &#125;<br>              &#125;,<br>              &#123;<br>                <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-string">&quot;小米&quot;</span>,<br>                <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">1</span>,<br>                <span class="hljs-attr">&quot;brand_avg_price&quot;</span>: &#123;<br>                  <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">2500</span><br>                &#125;<br>              &#125;<br>            ]<br>          &#125;<br>        &#125;<br>      ]<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="metric操作"><a href="#metric操作" class="headerlink" title="metric操作"></a>metric操作</h4><ul>
<li>count：bucket，terms，自动就会有一个doc_count，就相当于是count</li>
<li>avg：avg, aggs，求平均值</li>
<li>max：求一个bucket内，指定field值最大的那个数据</li>
<li>min：求一个bucket内，指定field值最小的那个数据</li>
<li>sum：求一个bucket内，指定field值的总和</li>
</ul>
<p>一般来说，90%的常见的数据分析的操作就是count，avg，max，min，sum</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/tvs/</span>sales/_search<br>&#123;<br>   <span class="hljs-string">&quot;size&quot;</span> : <span class="hljs-number">0</span>,<br>   <span class="hljs-string">&quot;aggs&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;colors&quot;</span>: &#123;<br>         <span class="hljs-string">&quot;terms&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;color&quot;</span><br>         &#125;,<br>         <span class="hljs-string">&quot;aggs&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;avg_price&quot;</span>: &#123; <span class="hljs-string">&quot;avg&quot;</span>: &#123; <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;price&quot;</span> &#125; &#125;,<br>            <span class="hljs-string">&quot;min_price&quot;</span> : &#123; <span class="hljs-string">&quot;min&quot;</span>: &#123; <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;price&quot;</span>&#125; &#125;, <br>            <span class="hljs-string">&quot;max_price&quot;</span> : &#123; <span class="hljs-string">&quot;max&quot;</span>: &#123; <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;price&quot;</span>&#125; &#125;,<br>            <span class="hljs-string">&quot;sum_price&quot;</span> : &#123; <span class="hljs-string">&quot;sum&quot;</span>: &#123; <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;price&quot;</span> &#125; &#125; <br>         &#125;<br>      &#125;<br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>求总和，就可以拿到一个颜色下的所有电视的销售总额</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs clojure">&#123;<br>  <span class="hljs-string">&quot;took&quot;</span>: <span class="hljs-number">16</span>,<br>  <span class="hljs-string">&quot;timed_out&quot;</span>: <span class="hljs-literal">false</span>,<br>  <span class="hljs-string">&quot;_shards&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;total&quot;</span>: <span class="hljs-number">5</span>,<br>    <span class="hljs-string">&quot;successful&quot;</span>: <span class="hljs-number">5</span>,<br>    <span class="hljs-string">&quot;failed&quot;</span>: <span class="hljs-number">0</span><br>  &#125;,<br>  <span class="hljs-string">&quot;hits&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;total&quot;</span>: <span class="hljs-number">8</span>,<br>    <span class="hljs-string">&quot;max_score&quot;</span>: <span class="hljs-number">0</span>,<br>    <span class="hljs-string">&quot;hits&quot;</span>: []<br>  &#125;,<br>  <span class="hljs-string">&quot;aggregations&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;group_by_color&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;doc_count_error_upper_bound&quot;</span>: <span class="hljs-number">0</span>,<br>      <span class="hljs-string">&quot;sum_other_doc_count&quot;</span>: <span class="hljs-number">0</span>,<br>      <span class="hljs-string">&quot;buckets&quot;</span>: [<br>        &#123;<br>          <span class="hljs-string">&quot;key&quot;</span>: <span class="hljs-string">&quot;红色&quot;</span>,<br>          <span class="hljs-string">&quot;doc_count&quot;</span>: <span class="hljs-number">4</span>,<br>          <span class="hljs-string">&quot;max_price&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">8000</span><br>          &#125;,<br>          <span class="hljs-string">&quot;min_price&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">1000</span><br>          &#125;,<br>          <span class="hljs-string">&quot;avg_price&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">3250</span><br>          &#125;,<br>          <span class="hljs-string">&quot;sum_price&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">13000</span><br>          &#125;<br>        &#125;,<br>        &#123;<br>          <span class="hljs-string">&quot;key&quot;</span>: <span class="hljs-string">&quot;绿色&quot;</span>,<br>          <span class="hljs-string">&quot;doc_count&quot;</span>: <span class="hljs-number">2</span>,<br>          <span class="hljs-string">&quot;max_price&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">3000</span><br>          &#125;,<br>          <span class="hljs-string">&quot;min_price&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;value&quot;</span>:<br>          &#125;, <span class="hljs-number">1200</span><br>          <span class="hljs-string">&quot;avg_price&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">2100</span><br>          &#125;,<br>          <span class="hljs-string">&quot;sum_price&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">4200</span><br>          &#125;<br>        &#125;,<br>        &#123;<br>          <span class="hljs-string">&quot;key&quot;</span>: <span class="hljs-string">&quot;蓝色&quot;</span>,<br>          <span class="hljs-string">&quot;doc_count&quot;</span>: <span class="hljs-number">2</span>,<br>          <span class="hljs-string">&quot;max_price&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">2500</span><br>          &#125;,<br>          <span class="hljs-string">&quot;min_price&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">1500</span><br>          &#125;,<br>          <span class="hljs-string">&quot;avg_price&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">2000</span><br>          &#125;,<br>          <span class="hljs-string">&quot;sum_price&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">4000</span><br>          &#125;<br>        &#125;<br>      ]<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="histogram操作"><a href="#histogram操作" class="headerlink" title="histogram操作"></a>histogram操作</h4><p>histogram：类似于terms，也是进行bucket分组操作，接收一个field，按照这个field的值的各个范围区间，进行bucket分组操作</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/tvs/</span>sales/_search<br>&#123;<br>   <span class="hljs-string">&quot;size&quot;</span> : <span class="hljs-number">0</span>,<br>   <span class="hljs-string">&quot;aggs&quot;</span>:&#123;<br>      <span class="hljs-string">&quot;price&quot;</span>:&#123;<br>         <span class="hljs-string">&quot;histogram&quot;</span>:&#123; <br>            <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;price&quot;</span>,<br>            <span class="hljs-string">&quot;interval&quot;</span>: <span class="hljs-number">2000</span><br>         &#125;,<br>         <span class="hljs-string">&quot;aggs&quot;</span>:&#123;<br>            <span class="hljs-string">&quot;revenue&quot;</span>: &#123;<br>               <span class="hljs-string">&quot;sum&quot;</span>: &#123; <br>                 <span class="hljs-string">&quot;field&quot;</span> : <span class="hljs-string">&quot;price&quot;</span><br>               &#125;<br>             &#125;<br>         &#125;<br>      &#125;<br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>其中interval：2000表示分组区间为2000，划分出的区间：0<del>2000、2000</del>4000、4000<del>6000、6000</del>8000、8000<del>10000，然后根据price的值，比如2500，看落在哪个区间内，比如2000</del>4000，此时就会将这条数据放入2000~4000对应的那个bucket中。</p>
<p>划分完bucket有了之后，一样的再去对每个bucket执行各种metric操作，进行聚合分析。</p>
<p>执行结果</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs yaml">&#123;<br>  <span class="hljs-attr">&quot;took&quot;:</span> <span class="hljs-number">13</span>,<br>  <span class="hljs-attr">&quot;timed_out&quot;:</span> <span class="hljs-literal">false</span>,<br>  <span class="hljs-attr">&quot;_shards&quot;:</span> &#123;<br>    <span class="hljs-attr">&quot;total&quot;:</span> <span class="hljs-number">5</span>,<br>    <span class="hljs-attr">&quot;successful&quot;:</span> <span class="hljs-number">5</span>,<br>    <span class="hljs-attr">&quot;failed&quot;:</span> <span class="hljs-number">0</span><br>  &#125;,<br>  <span class="hljs-attr">&quot;hits&quot;:</span> &#123;<br>    <span class="hljs-attr">&quot;total&quot;:</span> <span class="hljs-number">8</span>,<br>    <span class="hljs-attr">&quot;max_score&quot;:</span> <span class="hljs-number">0</span>,<br>    <span class="hljs-attr">&quot;hits&quot;:</span> []<br>  &#125;,<br>  <span class="hljs-attr">&quot;aggregations&quot;:</span> &#123;<br>    <span class="hljs-attr">&quot;group_by_price&quot;:</span> &#123;<br>      <span class="hljs-attr">&quot;buckets&quot;:</span> [<br>        &#123;<br>          <span class="hljs-attr">&quot;key&quot;:</span> <span class="hljs-number">0</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;:</span> <span class="hljs-number">3</span>,<br>          <span class="hljs-attr">&quot;sum_price&quot;:</span> &#123;<br>            <span class="hljs-attr">&quot;value&quot;:</span> <span class="hljs-number">3700</span><br>          &#125;<br>        &#125;,<br>        &#123;<br>          <span class="hljs-attr">&quot;key&quot;:</span> <span class="hljs-number">2000</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;:</span> <span class="hljs-number">4</span>,<br>          <span class="hljs-attr">&quot;sum_price&quot;:</span> &#123;<br>            <span class="hljs-attr">&quot;value&quot;:</span> <span class="hljs-number">9500</span><br>          &#125;<br>        &#125;,<br>        &#123;<br>          <span class="hljs-attr">&quot;key&quot;:</span> <span class="hljs-number">4000</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;:</span> <span class="hljs-number">0</span>,<br>          <span class="hljs-attr">&quot;sum_price&quot;:</span> &#123;<br>            <span class="hljs-attr">&quot;value&quot;:</span> <span class="hljs-number">0</span><br>          &#125;<br>        &#125;,<br>        &#123;<br>          <span class="hljs-attr">&quot;key&quot;:</span> <span class="hljs-number">6000</span>,<br>          <span class="hljs-string">&quot;doc_count: &#123;</span><br><span class="hljs-string">            &quot;</span><span class="hljs-string">value&quot;:&quot;:</span> <span class="hljs-number">0</span>,<br>          <span class="hljs-string">&quot;sum_price&quot;</span> <span class="hljs-number">0</span><br>          &#125;<br>        &#125;,<br>        &#123;<br>          <span class="hljs-attr">&quot;key&quot;:</span> <span class="hljs-number">8000</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;:</span> <span class="hljs-number">1</span>,<br>          <span class="hljs-attr">&quot;sum_price&quot;:</span> &#123;<br>            <span class="hljs-attr">&quot;value&quot;:</span> <span class="hljs-number">8000</span><br>          &#125;<br>        &#125;<br>      ]<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="date-histogram操作"><a href="#date-histogram操作" class="headerlink" title="date_histogram操作"></a>date_histogram操作</h4><p>histogram是按照某个值指定的interval划分bucket，而date_histogram就是对类型为date的值，按照指定的interval划分bucket。</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs ada">GET /tvs/sales/_search<br>&#123;<br>   <span class="hljs-string">&quot;size&quot;</span> : 0,<br>   <span class="hljs-string">&quot;aggs&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;sales&quot;</span>: &#123;<br>         <span class="hljs-string">&quot;date_histogram&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;sold_date&quot;</span>,<br>            <span class="hljs-string">&quot;interval&quot;</span>: <span class="hljs-string">&quot;month&quot;</span>, <br>            <span class="hljs-string">&quot;format&quot;</span>: <span class="hljs-string">&quot;yyyy-MM-dd&quot;</span>,<br>            <span class="hljs-string">&quot;min_doc_count&quot;</span> : 0, <br>            <span class="hljs-string">&quot;extended_bounds&quot;</span> : &#123; <br>                <span class="hljs-string">&quot;min&quot;</span> : &quot;2016-01-01&quot;,<br>                <span class="hljs-string">&quot;max&quot;</span> : &quot;2017-12-31&quot;<br>            &#125;<br>         &#125;<br>      &#125;<br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>其中min_doc_count是指即使某个区间中一条数据都没有，这个区间也是要返回的，默认没有数据的区间就不进行返回。</p>
<p>extended_bounds是指扩展的时间范围，划分bucket时对范围内的时间进行划分，如果指定的时间范围超出了数据所在的时间范围，也会进行划分，比如下面结果中最大的date为2017-02-12，但划分的时间范围最大为2017-12-01。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;took&quot;</span>: <span class="hljs-number">2</span>,<br>  <span class="hljs-attr">&quot;timed_out&quot;</span>: <span class="hljs-literal">false</span>,<br>  <span class="hljs-attr">&quot;_shards&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">5</span>,<br>    <span class="hljs-attr">&quot;successful&quot;</span>: <span class="hljs-number">5</span>,<br>    <span class="hljs-attr">&quot;skipped&quot;</span>: <span class="hljs-number">0</span>,<br>    <span class="hljs-attr">&quot;failed&quot;</span>: <span class="hljs-number">0</span><br>  &#125;,<br>  <span class="hljs-attr">&quot;hits&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">8</span>,<br>    <span class="hljs-attr">&quot;max_score&quot;</span>: <span class="hljs-number">0</span>,<br>    <span class="hljs-attr">&quot;hits&quot;</span>: []<br>  &#125;,<br>  <span class="hljs-attr">&quot;aggregations&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;sales&quot;</span>: &#123;<br>      <span class="hljs-attr">&quot;buckets&quot;</span>: [<br>        &#123;<br>          <span class="hljs-attr">&quot;key_as_string&quot;</span>: <span class="hljs-string">&quot;2016-01-01&quot;</span>,<br>          <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-number">1451606400000</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">0</span><br>        &#125;,<br>        &#123;<br>          <span class="hljs-attr">&quot;key_as_string&quot;</span>: <span class="hljs-string">&quot;2016-02-01&quot;</span>,<br>          <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-number">1454284800000</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">0</span><br>        &#125;,<br>        &#123;<br>          <span class="hljs-attr">&quot;key_as_string&quot;</span>: <span class="hljs-string">&quot;2016-03-01&quot;</span>,<br>          <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-number">1456790400000</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">0</span><br>        &#125;,<br>        &#123;<br>          <span class="hljs-attr">&quot;key_as_string&quot;</span>: <span class="hljs-string">&quot;2016-04-01&quot;</span>,<br>          <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-number">1459468800000</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">0</span><br>        &#125;,<br>        &#123;<br>          <span class="hljs-attr">&quot;key_as_string&quot;</span>: <span class="hljs-string">&quot;2016-05-01&quot;</span>,<br>          <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-number">1462060800000</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">1</span><br>        &#125;,<br>        &#123;<br>          <span class="hljs-attr">&quot;key_as_string&quot;</span>: <span class="hljs-string">&quot;2016-06-01&quot;</span>,<br>          <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-number">1464739200000</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">0</span><br>        &#125;,<br>        &#123;<br>          <span class="hljs-attr">&quot;key_as_string&quot;</span>: <span class="hljs-string">&quot;2016-07-01&quot;</span>,<br>          <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-number">1467331200000</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">1</span><br>        &#125;,<br>        &#123;<br>          <span class="hljs-attr">&quot;key_as_string&quot;</span>: <span class="hljs-string">&quot;2016-08-01&quot;</span>,<br>          <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-number">1470009600000</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">1</span><br>        &#125;,<br>        &#123;<br>          <span class="hljs-attr">&quot;key_as_string&quot;</span>: <span class="hljs-string">&quot;2016-09-01&quot;</span>,<br>          <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-number">1472688000000</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">0</span><br>        &#125;,<br>        &#123;<br>          <span class="hljs-attr">&quot;key_as_string&quot;</span>: <span class="hljs-string">&quot;2016-10-01&quot;</span>,<br>          <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-number">1475280000000</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">1</span><br>        &#125;,<br>        &#123;<br>          <span class="hljs-attr">&quot;key_as_string&quot;</span>: <span class="hljs-string">&quot;2016-11-01&quot;</span>,<br>          <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-number">1477958400000</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">2</span><br>        &#125;,<br>        &#123;<br>          <span class="hljs-attr">&quot;key_as_string&quot;</span>: <span class="hljs-string">&quot;2016-12-01&quot;</span>,<br>          <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-number">1480550400000</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">0</span><br>        &#125;,<br>        &#123;<br>          <span class="hljs-attr">&quot;key_as_string&quot;</span>: <span class="hljs-string">&quot;2017-01-01&quot;</span>,<br>          <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-number">1483228800000</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">1</span><br>        &#125;,<br>        &#123;<br>          <span class="hljs-attr">&quot;key_as_string&quot;</span>: <span class="hljs-string">&quot;2017-02-01&quot;</span>,<br>          <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-number">1485907200000</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">1</span><br>        &#125;,<br>        &#123;<br>          <span class="hljs-attr">&quot;key_as_string&quot;</span>: <span class="hljs-string">&quot;2017-03-01&quot;</span>,<br>          <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-number">1488326400000</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">0</span><br>        &#125;,<br>        &#123;<br>          <span class="hljs-attr">&quot;key_as_string&quot;</span>: <span class="hljs-string">&quot;2017-04-01&quot;</span>,<br>          <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-number">1491004800000</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">0</span><br>        &#125;,<br>        &#123;<br>          <span class="hljs-attr">&quot;key_as_string&quot;</span>: <span class="hljs-string">&quot;2017-05-01&quot;</span>,<br>          <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-number">1493596800000</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">0</span><br>        &#125;,<br>        &#123;<br>          <span class="hljs-attr">&quot;key_as_string&quot;</span>: <span class="hljs-string">&quot;2017-06-01&quot;</span>,<br>          <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-number">1496275200000</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">0</span><br>        &#125;,<br>        &#123;<br>          <span class="hljs-attr">&quot;key_as_string&quot;</span>: <span class="hljs-string">&quot;2017-07-01&quot;</span>,<br>          <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-number">1498867200000</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">0</span><br>        &#125;,<br>        &#123;<br>          <span class="hljs-attr">&quot;key_as_string&quot;</span>: <span class="hljs-string">&quot;2017-08-01&quot;</span>,<br>          <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-number">1501545600000</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">0</span><br>        &#125;,<br>        &#123;<br>          <span class="hljs-attr">&quot;key_as_string&quot;</span>: <span class="hljs-string">&quot;2017-09-01&quot;</span>,<br>          <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-number">1504224000000</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">0</span><br>        &#125;,<br>        &#123;<br>          <span class="hljs-attr">&quot;key_as_string&quot;</span>: <span class="hljs-string">&quot;2017-10-01&quot;</span>,<br>          <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-number">1506816000000</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">0</span><br>        &#125;,<br>        &#123;<br>          <span class="hljs-attr">&quot;key_as_string&quot;</span>: <span class="hljs-string">&quot;2017-11-01&quot;</span>,<br>          <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-number">1509494400000</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">0</span><br>        &#125;,<br>        &#123;<br>          <span class="hljs-attr">&quot;key_as_string&quot;</span>: <span class="hljs-string">&quot;2017-12-01&quot;</span>,<br>          <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-number">1512086400000</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">0</span><br>        &#125;<br>      ]<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="聚合示例"><a href="#聚合示例" class="headerlink" title="聚合示例"></a>聚合示例</h4><h5 id="统计每季度每品牌的销售额"><a href="#统计每季度每品牌的销售额" class="headerlink" title="统计每季度每品牌的销售额"></a>统计每季度每品牌的销售额</h5><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/tvs/</span>sales/_search <br>&#123;<br>  <span class="hljs-string">&quot;size&quot;</span>: <span class="hljs-number">0</span>,<br>  <span class="hljs-string">&quot;aggs&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;group_by_sold_date&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;date_histogram&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;sold_date&quot;</span>,<br>        <span class="hljs-string">&quot;interval&quot;</span>: <span class="hljs-string">&quot;quarter&quot;</span>,<br>        <span class="hljs-string">&quot;format&quot;</span>: <span class="hljs-string">&quot;yyyy-MM-dd&quot;</span>,<br>        <span class="hljs-string">&quot;min_doc_count&quot;</span>: <span class="hljs-number">0</span>,<br>        <span class="hljs-string">&quot;extended_bounds&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;min&quot;</span>: <span class="hljs-string">&quot;2016-01-01&quot;</span>,<br>          <span class="hljs-string">&quot;max&quot;</span>: <span class="hljs-string">&quot;2017-12-31&quot;</span><br>        &#125;<br>      &#125;,<br>      <span class="hljs-string">&quot;aggs&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;group_by_brand&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;terms&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;brand&quot;</span><br>          &#125;,<br>          <span class="hljs-string">&quot;aggs&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;sum_price&quot;</span>: &#123;<br>              <span class="hljs-string">&quot;sum&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;price&quot;</span><br>              &#125;<br>            &#125;<br>          &#125;<br>        &#125;,<br>        <span class="hljs-string">&quot;total_sum_price&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;sum&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;price&quot;</span><br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="搜索-聚合"><a href="#搜索-聚合" class="headerlink" title="搜索+聚合"></a>搜索+聚合</h5><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/tvs/</span>sales/_search <br>&#123;<br>  <span class="hljs-string">&quot;size&quot;</span>: <span class="hljs-number">0</span>,<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;term&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;brand&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-string">&quot;小米&quot;</span><br>      &#125;<br>    &#125;<br>  &#125;,<br>  <span class="hljs-string">&quot;aggs&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;group_by_color&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;terms&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;color&quot;</span><br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>聚合一般都是对搜索出来的数据进行聚合</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;took&quot;</span>: <span class="hljs-number">5</span>,<br>  <span class="hljs-attr">&quot;timed_out&quot;</span>: <span class="hljs-literal">false</span>,<br>  <span class="hljs-attr">&quot;_shards&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">5</span>,<br>    <span class="hljs-attr">&quot;successful&quot;</span>: <span class="hljs-number">5</span>,<br>    <span class="hljs-attr">&quot;failed&quot;</span>: <span class="hljs-number">0</span><br>  &#125;,<br>  <span class="hljs-attr">&quot;hits&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">2</span>,<br>    <span class="hljs-attr">&quot;max_score&quot;</span>: <span class="hljs-number">0</span>,<br>    <span class="hljs-attr">&quot;hits&quot;</span>: []<br>  &#125;,<br>  <span class="hljs-attr">&quot;aggregations&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;group_by_color&quot;</span>: &#123;<br>      <span class="hljs-attr">&quot;doc_count_error_upper_bound&quot;</span>: <span class="hljs-number">0</span>,<br>      <span class="hljs-attr">&quot;sum_other_doc_count&quot;</span>: <span class="hljs-number">0</span>,<br>      <span class="hljs-attr">&quot;buckets&quot;</span>: [<br>        &#123;<br>          <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-string">&quot;绿色&quot;</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">1</span><br>        &#125;,<br>        &#123;<br>          <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-string">&quot;蓝色&quot;</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">1</span><br>        &#125;<br>      ]<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>global</strong></p>
<p>可以通过global对所有数据进行聚合</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/tvs/</span>sales/_search <br>&#123;<br>  <span class="hljs-string">&quot;size&quot;</span>: <span class="hljs-number">0</span>, <br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;term&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;brand&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-string">&quot;长虹&quot;</span><br>      &#125;<br>    &#125;<br>  &#125;,<br>  <span class="hljs-string">&quot;aggs&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;single_brand_avg_price&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;avg&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;price&quot;</span><br>      &#125;<br>    &#125;,<br>    <span class="hljs-string">&quot;all&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;global&quot;</span>: &#123;&#125;,<br>      <span class="hljs-string">&quot;aggs&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;all_brand_avg_price&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;avg&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;price&quot;</span><br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>global就是global bucket，就是将所有数据纳入聚合的scope，而不管之前的query。这时会出来两个结果，一个是基于query搜索结果来聚合的; 一个是对所有数据执行聚合的</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;took&quot;</span>: <span class="hljs-number">4</span>,<br>  <span class="hljs-attr">&quot;timed_out&quot;</span>: <span class="hljs-literal">false</span>,<br>  <span class="hljs-attr">&quot;_shards&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">5</span>,<br>    <span class="hljs-attr">&quot;successful&quot;</span>: <span class="hljs-number">5</span>,<br>    <span class="hljs-attr">&quot;failed&quot;</span>: <span class="hljs-number">0</span><br>  &#125;,<br>  <span class="hljs-attr">&quot;hits&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">3</span>,<br>    <span class="hljs-attr">&quot;max_score&quot;</span>: <span class="hljs-number">0</span>,<br>    <span class="hljs-attr">&quot;hits&quot;</span>: []<br>  &#125;,<br>  <span class="hljs-attr">&quot;aggregations&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;all&quot;</span>: &#123;<br>      <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">8</span>,<br>      <span class="hljs-attr">&quot;all_brand_avg_price&quot;</span>: &#123;<br>        <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">2650</span><br>      &#125;<br>    &#125;,<br>    <span class="hljs-attr">&quot;single_brand_avg_price&quot;</span>: &#123;<br>      <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">1666.6666666666667</span><br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>single_brand_avg_price：就是针对query搜索结果，执行的，拿到的，就是长虹品牌的平均价格</p>
<p>all.all_brand_avg_price：针对所有数据平均价格</p>
<h5 id="过滤-聚合"><a href="#过滤-聚合" class="headerlink" title="过滤+聚合"></a>过滤+聚合</h5><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/tvs/</span>sales/_search <br>&#123;<br>  <span class="hljs-string">&quot;size&quot;</span>: <span class="hljs-number">0</span>,<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;constant_score&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;filter&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;range&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;price&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;gte&quot;</span>: <span class="hljs-number">1200</span><br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;,<br>  <span class="hljs-string">&quot;aggs&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;avg_price&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;avg&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;price&quot;</span><br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;took&quot;</span>: <span class="hljs-number">41</span>,<br>  <span class="hljs-attr">&quot;timed_out&quot;</span>: <span class="hljs-literal">false</span>,<br>  <span class="hljs-attr">&quot;_shards&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">5</span>,<br>    <span class="hljs-attr">&quot;successful&quot;</span>: <span class="hljs-number">5</span>,<br>    <span class="hljs-attr">&quot;failed&quot;</span>: <span class="hljs-number">0</span><br>  &#125;,<br>  <span class="hljs-attr">&quot;hits&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">7</span>,<br>    <span class="hljs-attr">&quot;max_score&quot;</span>: <span class="hljs-number">0</span>,<br>    <span class="hljs-attr">&quot;hits&quot;</span>: []<br>  &#125;,<br>  <span class="hljs-attr">&quot;aggregations&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;avg_price&quot;</span>: &#123;<br>      <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">2885.714285714286</span><br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="统计品牌某个时间段的平均价格"><a href="#统计品牌某个时间段的平均价格" class="headerlink" title="统计品牌某个时间段的平均价格"></a>统计品牌某个时间段的平均价格</h5><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/tvs/</span>sales/_search <br>&#123;<br>  <span class="hljs-string">&quot;size&quot;</span>: <span class="hljs-number">0</span>,<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;term&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;brand&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-string">&quot;长虹&quot;</span><br>      &#125;<br>    &#125;<br>  &#125;,<br>  <span class="hljs-string">&quot;aggs&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;recent_150d&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;filter&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;range&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;sold_date&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;gte&quot;</span>: <span class="hljs-string">&quot;now-150d&quot;</span><br>          &#125;<br>        &#125;<br>      &#125;,<br>      <span class="hljs-string">&quot;aggs&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;recent_150d_avg_price&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;avg&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;price&quot;</span><br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;,<br>    <span class="hljs-string">&quot;recent_140d&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;filter&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;range&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;sold_date&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;gte&quot;</span>: <span class="hljs-string">&quot;now-140d&quot;</span><br>          &#125;<br>        &#125;<br>      &#125;,<br>      <span class="hljs-string">&quot;aggs&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;recent_140d_avg_price&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;avg&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;price&quot;</span><br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;,<br>    <span class="hljs-string">&quot;recent_130d&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;filter&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;range&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;sold_date&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;gte&quot;</span>: <span class="hljs-string">&quot;now-130d&quot;</span><br>          &#125;<br>        &#125;<br>      &#125;,<br>      <span class="hljs-string">&quot;aggs&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;recent_130d_avg_price&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;avg&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;price&quot;</span><br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="按照bucket的metric结果排序"><a href="#按照bucket的metric结果排序" class="headerlink" title="按照bucket的metric结果排序"></a>按照bucket的metric结果排序</h5><p>默认会按照doc_count排序</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/tvs/</span>sales/_search <br>&#123;<br>  <span class="hljs-string">&quot;size&quot;</span>: <span class="hljs-number">0</span>,<br>  <span class="hljs-string">&quot;aggs&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;group_by_color&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;terms&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;color&quot;</span>,<br>        <span class="hljs-string">&quot;order&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;avg_price&quot;</span>: <span class="hljs-string">&quot;asc&quot;</span><br>        &#125;<br>      &#125;,<br>      <span class="hljs-string">&quot;aggs&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;avg_price&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;avg&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;price&quot;</span><br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/tvs/</span>sales/_search <br>&#123;<br>  <span class="hljs-string">&quot;size&quot;</span>: <span class="hljs-number">0</span>,<br>  <span class="hljs-string">&quot;aggs&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;group_by_color&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;terms&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;color&quot;</span><br>      &#125;,<br>      <span class="hljs-string">&quot;aggs&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;group_by_brand&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;terms&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;brand&quot;</span>,<br>            <span class="hljs-string">&quot;order&quot;</span>: &#123;<br>              <span class="hljs-string">&quot;avg_price&quot;</span>: <span class="hljs-string">&quot;desc&quot;</span><br>            &#125;<br>          &#125;,<br>          <span class="hljs-string">&quot;aggs&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;avg_price&quot;</span>: &#123;<br>              <span class="hljs-string">&quot;avg&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;price&quot;</span><br>              &#125;<br>            &#125;<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="并行聚合算法"><a href="#并行聚合算法" class="headerlink" title="并行聚合算法"></a>并行聚合算法</h4><p>有些聚合算法比较容易并行比如max，每个node只返回一个max值，内存中只驻留一个值。</p>
<p><img src="/blog/2022/10/12/Elasticsearch/elasticsearch%E5%9F%BA%E7%A1%80/%E6%98%93%E5%B9%B6%E8%A1%8C%E7%AE%97%E6%B3%95-2832722.png" srcset="/blog/img/loading.gif" lazyload alt="易并行算法"></p>
<p>有些聚合分析算法不好并行，比如count(distinct)，es会采取近似聚合的方式，就是采用在每个node上进行近估计的方式，得到最终的结论，会存在5%左右的错误率，不完全准确，但是速度会很快，一般会达到完全精准的算法的性能的数十倍。</p>
<p><img src="/blog/2022/10/12/Elasticsearch/elasticsearch%E5%9F%BA%E7%A1%80/%E4%B8%8D%E6%98%93%E5%B9%B6%E8%A1%8C%E7%9A%84%E7%AE%97%E6%B3%95.png" srcset="/blog/img/loading.gif" lazyload></p>
<h4 id="三角选择原则"><a href="#三角选择原则" class="headerlink" title="三角选择原则"></a>三角选择原则</h4><p>精准、实时、大数据量中只能实现2个</p>
<ol>
<li>精准、实时：没有大数据，数据量很小，那么一般就是单击跑，随便你则么玩儿就可以。</li>
<li>精准、大数据：hadoop，批处理，非实时，可以处理海量数据，保证精准，可能会跑几个小时。</li>
<li>大数据、实时：es，不精准，近似估计，可能会有百分之几的错误率。</li>
</ol>
<h4 id="近似聚合算法"><a href="#近似聚合算法" class="headerlink" title="近似聚合算法"></a>近似聚合算法</h4><p>如果采取近似估计的算法：延时在100ms左右，0.5%错误</p>
<p>如果采取100%精准的算法：延时一般在几s~几十s，甚至几十分钟，几小时， 0%错误</p>
<h5 id="cardinality去重"><a href="#cardinality去重" class="headerlink" title="cardinality去重"></a>cardinality去重</h5><p>cardinality metric可以对每个bucket中的指定的field进行去重，然后计算数量，类似于count(distcint)，cardinality性能在100ms左右，但是有5%的错误率。</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs ada">GET /tvs/sales/_search<br>&#123;<br>  <span class="hljs-string">&quot;size&quot;</span> : 0,<br>  <span class="hljs-string">&quot;aggs&quot;</span> : &#123;<br>      <span class="hljs-string">&quot;months&quot;</span> : &#123;<br>        <span class="hljs-string">&quot;date_histogram&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;sold_date&quot;</span>,<br>          <span class="hljs-string">&quot;interval&quot;</span>: <span class="hljs-string">&quot;month&quot;</span><br>        &#125;,<br>        <span class="hljs-string">&quot;aggs&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;distinct_colors&quot;</span> : &#123;<br>              <span class="hljs-string">&quot;cardinality&quot;</span> : &#123;<br>                <span class="hljs-string">&quot;field&quot;</span> : &quot;<span class="hljs-type">brand</span><span class="hljs-string">&quot;</span><br><span class="hljs-string">              &#125;</span><br><span class="hljs-string">          &#125;</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string">      &#125;</span><br><span class="hljs-string">  &#125;</span><br><span class="hljs-string">&#125;</span><br></code></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;took&quot;</span>: <span class="hljs-number">70</span>,<br>  <span class="hljs-attr">&quot;timed_out&quot;</span>: <span class="hljs-literal">false</span>,<br>  <span class="hljs-attr">&quot;_shards&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">5</span>,<br>    <span class="hljs-attr">&quot;successful&quot;</span>: <span class="hljs-number">5</span>,<br>    <span class="hljs-attr">&quot;failed&quot;</span>: <span class="hljs-number">0</span><br>  &#125;,<br>  <span class="hljs-attr">&quot;hits&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">8</span>,<br>    <span class="hljs-attr">&quot;max_score&quot;</span>: <span class="hljs-number">0</span>,<br>    <span class="hljs-attr">&quot;hits&quot;</span>: []<br>  &#125;,<br>  <span class="hljs-attr">&quot;aggregations&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;group_by_sold_date&quot;</span>: &#123;<br>      <span class="hljs-attr">&quot;buckets&quot;</span>: [<br>        &#123;<br>          <span class="hljs-attr">&quot;key_as_string&quot;</span>: <span class="hljs-string">&quot;2016-05-01T00:00:00.000Z&quot;</span>,<br>          <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-number">1462060800000</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">1</span>,<br>          <span class="hljs-attr">&quot;distinct_brand_cnt&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">1</span><br>          &#125;<br>        &#125;,<br>        &#123;<br>          <span class="hljs-attr">&quot;key_as_string&quot;</span>: <span class="hljs-string">&quot;2016-06-01T00:00:00.000Z&quot;</span>,<br>          <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-number">1464739200000</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">0</span>,<br>          <span class="hljs-attr">&quot;distinct_brand_cnt&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">0</span><br>          &#125;<br>        &#125;,<br>        &#123;<br>          <span class="hljs-attr">&quot;key_as_string&quot;</span>: <span class="hljs-string">&quot;2016-07-01T00:00:00.000Z&quot;</span>,<br>          <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-number">1467331200000</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">1</span>,<br>          <span class="hljs-attr">&quot;distinct_brand_cnt&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">1</span><br>          &#125;<br>        &#125;,<br>        &#123;<br>          <span class="hljs-attr">&quot;key_as_string&quot;</span>: <span class="hljs-string">&quot;2016-08-01T00:00:00.000Z&quot;</span>,<br>          <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-number">1470009600000</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">1</span>,<br>          <span class="hljs-attr">&quot;distinct_brand_cnt&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">1</span><br>          &#125;<br>        &#125;,<br>        &#123;<br>          <span class="hljs-attr">&quot;key_as_string&quot;</span>: <span class="hljs-string">&quot;2016-09-01T00:00:00.000Z&quot;</span>,<br>          <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-number">1472688000000</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">0</span>,<br>          <span class="hljs-attr">&quot;distinct_brand_cnt&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">0</span><br>          &#125;<br>        &#125;,<br>        &#123;<br>          <span class="hljs-attr">&quot;key_as_string&quot;</span>: <span class="hljs-string">&quot;2016-10-01T00:00:00.000Z&quot;</span>,<br>          <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-number">1475280000000</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">1</span>,<br>          <span class="hljs-attr">&quot;distinct_brand_cnt&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">1</span><br>          &#125;<br>        &#125;,<br>        &#123;<br>          <span class="hljs-attr">&quot;key_as_string&quot;</span>: <span class="hljs-string">&quot;2016-11-01T00:00:00.000Z&quot;</span>,<br>          <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-number">1477958400000</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">2</span>,<br>          <span class="hljs-attr">&quot;distinct_brand_cnt&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">1</span><br>          &#125;<br>        &#125;,<br>        &#123;<br>          <span class="hljs-attr">&quot;key_as_string&quot;</span>: <span class="hljs-string">&quot;2016-12-01T00:00:00.000Z&quot;</span>,<br>          <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-number">1480550400000</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">0</span>,<br>          <span class="hljs-attr">&quot;distinct_brand_cnt&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">0</span><br>          &#125;<br>        &#125;,<br>        &#123;<br>          <span class="hljs-attr">&quot;key_as_string&quot;</span>: <span class="hljs-string">&quot;2017-01-01T00:00:00.000Z&quot;</span>,<br>          <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-number">1483228800000</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">1</span>,<br>          <span class="hljs-attr">&quot;distinct_brand_cnt&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">1</span><br>          &#125;<br>        &#125;,<br>        &#123;<br>          <span class="hljs-attr">&quot;key_as_string&quot;</span>: <span class="hljs-string">&quot;2017-02-01T00:00:00.000Z&quot;</span>,<br>          <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-number">1485907200000</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">1</span>,<br>          <span class="hljs-attr">&quot;distinct_brand_cnt&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">1</span><br>          &#125;<br>        &#125;<br>      ]<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="precision-threshold优化准确率和内存开销"><a href="#precision-threshold优化准确率和内存开销" class="headerlink" title="precision_threshold优化准确率和内存开销"></a>precision_threshold优化准确率和内存开销</h5><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs ada">GET /tvs/sales/_search<br>&#123;<br>    <span class="hljs-string">&quot;size&quot;</span> : 0,<br>    <span class="hljs-string">&quot;aggs&quot;</span> : &#123;<br>        <span class="hljs-string">&quot;distinct_brand&quot;</span> : &#123;<br>            <span class="hljs-string">&quot;cardinality&quot;</span> : &#123;<br>              <span class="hljs-string">&quot;field&quot;</span> : &quot;<span class="hljs-type">brand</span><span class="hljs-string">&quot;,</span><br><span class="hljs-string">              &quot;</span>precision_threshold<span class="hljs-string">&quot; : 100 </span><br><span class="hljs-string">            &#125;</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string">&#125;</span><br></code></pre></td></tr></table></figure>

<p>precision_threshold表示在多少个unique value以内，几乎保证100%准确。但是precision_threshold每位会占用8 byte的内存。</p>
<h5 id="HyperLogLog-HLL-算法性能优化"><a href="#HyperLogLog-HLL-算法性能优化" class="headerlink" title="HyperLogLog++ (HLL)算法性能优化"></a>HyperLogLog++ (HLL)算法性能优化</h5><p>cardinality底层使用HLL算法，HLL算法会对所有的uqniue value取hash值，通过hash值近似去求distcint count。</p>
<p>默认情况下，发送一个cardinality请求的时候，会动态地对所有的field value取hash值，可以将取hash值的操作，前移到建立索引的时候来优化cardinality的性能。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs awk">PUT <span class="hljs-regexp">/tvs/</span><br>&#123;<br>  <span class="hljs-string">&quot;mappings&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;sales&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;brand&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span>,<br>          <span class="hljs-string">&quot;fields&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;hash&quot;</span>: &#123;<br>              <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;murmur3&quot;</span> <br>            &#125;<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs ada">GET /tvs/sales/_search<br>&#123;<br>    <span class="hljs-string">&quot;size&quot;</span> : 0,<br>    <span class="hljs-string">&quot;aggs&quot;</span> : &#123;<br>        <span class="hljs-string">&quot;distinct_brand&quot;</span> : &#123;<br>            <span class="hljs-string">&quot;cardinality&quot;</span> : &#123;<br>              <span class="hljs-string">&quot;field&quot;</span> : &quot;<span class="hljs-type">brand.hash</span><span class="hljs-string">&quot;,</span><br><span class="hljs-string">              &quot;</span>precision_threshold<span class="hljs-string">&quot; : 100 </span><br><span class="hljs-string">            &#125;</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string">&#125;</span><br></code></pre></td></tr></table></figure>

<h4 id="percentiles百分比算法"><a href="#percentiles百分比算法" class="headerlink" title="percentiles百分比算法"></a>percentiles百分比算法</h4><p>比如有一个网站，记录下了每次请求的访问的耗时，需要统计tp50，tp90，tp99</p>
<ul>
<li>tp50：50%的请求的耗时最长的时间</li>
<li>tp90：90%的请求的耗时最长的时间</li>
<li>tp99：99%的请求的耗时最长的时间</li>
</ul>
<p>测试数据</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs dts">PUT /website<br>&#123;<br>    <span class="hljs-string">&quot;mappings&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;logs&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;latency&quot;</span>: &#123;<br>                    <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;long&quot;</span><br>                &#125;,<br>                <span class="hljs-string">&quot;province&quot;</span>: &#123;<br>                    <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;keyword&quot;</span><br>                &#125;,<br>                <span class="hljs-string">&quot;timestamp&quot;</span>: &#123;<br>                    <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;date&quot;</span><br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs n1ql">POST /website/logs/_bulk<br>&#123; &quot;<span class="hljs-keyword">index</span><span class="hljs-string">&quot;: &#123;&#125;&#125;</span><br><span class="hljs-string">&#123; &quot;</span>latency<span class="hljs-string">&quot; : 105, &quot;</span>province<span class="hljs-string">&quot; : &quot;</span>江苏<span class="hljs-string">&quot;, &quot;</span>timestamp<span class="hljs-string">&quot; : &quot;</span><span class="hljs-number">2016</span><span class="hljs-number">-10</span><span class="hljs-number">-28</span><span class="hljs-string">&quot; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">index</span><span class="hljs-string">&quot;: &#123;&#125;&#125;</span><br><span class="hljs-string">&#123; &quot;</span>latency<span class="hljs-string">&quot; : 83, &quot;</span>province<span class="hljs-string">&quot; : &quot;</span>江苏<span class="hljs-string">&quot;, &quot;</span>timestamp<span class="hljs-string">&quot; : &quot;</span><span class="hljs-number">2016</span><span class="hljs-number">-10</span><span class="hljs-number">-29</span><span class="hljs-string">&quot; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">index</span><span class="hljs-string">&quot;: &#123;&#125;&#125;</span><br><span class="hljs-string">&#123; &quot;</span>latency<span class="hljs-string">&quot; : 92, &quot;</span>province<span class="hljs-string">&quot; : &quot;</span>江苏<span class="hljs-string">&quot;, &quot;</span>timestamp<span class="hljs-string">&quot; : &quot;</span><span class="hljs-number">2016</span><span class="hljs-number">-10</span><span class="hljs-number">-29</span><span class="hljs-string">&quot; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">index</span><span class="hljs-string">&quot;: &#123;&#125;&#125;</span><br><span class="hljs-string">&#123; &quot;</span>latency<span class="hljs-string">&quot; : 112, &quot;</span>province<span class="hljs-string">&quot; : &quot;</span>江苏<span class="hljs-string">&quot;, &quot;</span>timestamp<span class="hljs-string">&quot; : &quot;</span><span class="hljs-number">2016</span><span class="hljs-number">-10</span><span class="hljs-number">-28</span><span class="hljs-string">&quot; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">index</span><span class="hljs-string">&quot;: &#123;&#125;&#125;</span><br><span class="hljs-string">&#123; &quot;</span>latency<span class="hljs-string">&quot; : 68, &quot;</span>province<span class="hljs-string">&quot; : &quot;</span>江苏<span class="hljs-string">&quot;, &quot;</span>timestamp<span class="hljs-string">&quot; : &quot;</span><span class="hljs-number">2016</span><span class="hljs-number">-10</span><span class="hljs-number">-28</span><span class="hljs-string">&quot; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">index</span><span class="hljs-string">&quot;: &#123;&#125;&#125;</span><br><span class="hljs-string">&#123; &quot;</span>latency<span class="hljs-string">&quot; : 76, &quot;</span>province<span class="hljs-string">&quot; : &quot;</span>江苏<span class="hljs-string">&quot;, &quot;</span>timestamp<span class="hljs-string">&quot; : &quot;</span><span class="hljs-number">2016</span><span class="hljs-number">-10</span><span class="hljs-number">-29</span><span class="hljs-string">&quot; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">index</span><span class="hljs-string">&quot;: &#123;&#125;&#125;</span><br><span class="hljs-string">&#123; &quot;</span>latency<span class="hljs-string">&quot; : 101, &quot;</span>province<span class="hljs-string">&quot; : &quot;</span>新疆<span class="hljs-string">&quot;, &quot;</span>timestamp<span class="hljs-string">&quot; : &quot;</span><span class="hljs-number">2016</span><span class="hljs-number">-10</span><span class="hljs-number">-28</span><span class="hljs-string">&quot; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">index</span><span class="hljs-string">&quot;: &#123;&#125;&#125;</span><br><span class="hljs-string">&#123; &quot;</span>latency<span class="hljs-string">&quot; : 275, &quot;</span>province<span class="hljs-string">&quot; : &quot;</span>新疆<span class="hljs-string">&quot;, &quot;</span>timestamp<span class="hljs-string">&quot; : &quot;</span><span class="hljs-number">2016</span><span class="hljs-number">-10</span><span class="hljs-number">-29</span><span class="hljs-string">&quot; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">index</span><span class="hljs-string">&quot;: &#123;&#125;&#125;</span><br><span class="hljs-string">&#123; &quot;</span>latency<span class="hljs-string">&quot; : 166, &quot;</span>province<span class="hljs-string">&quot; : &quot;</span>新疆<span class="hljs-string">&quot;, &quot;</span>timestamp<span class="hljs-string">&quot; : &quot;</span><span class="hljs-number">2016</span><span class="hljs-number">-10</span><span class="hljs-number">-29</span><span class="hljs-string">&quot; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">index</span><span class="hljs-string">&quot;: &#123;&#125;&#125;</span><br><span class="hljs-string">&#123; &quot;</span>latency<span class="hljs-string">&quot; : 654, &quot;</span>province<span class="hljs-string">&quot; : &quot;</span>新疆<span class="hljs-string">&quot;, &quot;</span>timestamp<span class="hljs-string">&quot; : &quot;</span><span class="hljs-number">2016</span><span class="hljs-number">-10</span><span class="hljs-number">-28</span><span class="hljs-string">&quot; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">index</span><span class="hljs-string">&quot;: &#123;&#125;&#125;</span><br><span class="hljs-string">&#123; &quot;</span>latency<span class="hljs-string">&quot; : 389, &quot;</span>province<span class="hljs-string">&quot; : &quot;</span>新疆<span class="hljs-string">&quot;, &quot;</span>timestamp<span class="hljs-string">&quot; : &quot;</span><span class="hljs-number">2016</span><span class="hljs-number">-10</span><span class="hljs-number">-28</span><span class="hljs-string">&quot; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">index</span><span class="hljs-string">&quot;: &#123;&#125;&#125;</span><br><span class="hljs-string">&#123; &quot;</span>latency<span class="hljs-string">&quot; : 302, &quot;</span>province<span class="hljs-string">&quot; : &quot;</span>新疆<span class="hljs-string">&quot;, &quot;</span>timestamp<span class="hljs-string">&quot; : &quot;</span><span class="hljs-number">2016</span><span class="hljs-number">-10</span><span class="hljs-number">-29</span><span class="hljs-string">&quot; &#125;</span><br></code></pre></td></tr></table></figure>

<p>搜索</p>
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs autohotkey">GET /website/logs/_search <br>&#123;<br>  <span class="hljs-string">&quot;size&quot;</span>: <span class="hljs-number">0</span>,<br>  <span class="hljs-string">&quot;aggs&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;latency_percentiles&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;percentiles&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;latency&quot;</span>,<br>        <span class="hljs-string">&quot;percents&quot;</span>: [<br><span class="hljs-built_in">          50,</span><br><span class="hljs-built_in">          95,</span><br>          <span class="hljs-number">99</span><br>        ]<br>      &#125;<br>    &#125;,<br>    <span class="hljs-string">&quot;latency_avg&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;avg&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;latency&quot;</span><br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;took&quot;</span>: <span class="hljs-number">31</span>,<br>  <span class="hljs-attr">&quot;timed_out&quot;</span>: <span class="hljs-literal">false</span>,<br>  <span class="hljs-attr">&quot;_shards&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">5</span>,<br>    <span class="hljs-attr">&quot;successful&quot;</span>: <span class="hljs-number">5</span>,<br>    <span class="hljs-attr">&quot;failed&quot;</span>: <span class="hljs-number">0</span><br>  &#125;,<br>  <span class="hljs-attr">&quot;hits&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">12</span>,<br>    <span class="hljs-attr">&quot;max_score&quot;</span>: <span class="hljs-number">0</span>,<br>    <span class="hljs-attr">&quot;hits&quot;</span>: []<br>  &#125;,<br>  <span class="hljs-attr">&quot;aggregations&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;latency_avg&quot;</span>: &#123;<br>      <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">201.91666666666666</span><br>    &#125;,<br>    <span class="hljs-attr">&quot;latency_percentiles&quot;</span>: &#123;<br>      <span class="hljs-attr">&quot;values&quot;</span>: &#123;<br>        <span class="hljs-attr">&quot;50.0&quot;</span>: <span class="hljs-number">108.5</span>,<br>        <span class="hljs-attr">&quot;95.0&quot;</span>: <span class="hljs-number">508.24999999999983</span>,<br>        <span class="hljs-attr">&quot;99.0&quot;</span>: <span class="hljs-number">624.8500000000001</span><br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>50%的请求中数值的最大的值是多少，不是完全准确的</p>
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs autohotkey">GET /website/logs/_search <br>&#123;<br>  <span class="hljs-string">&quot;size&quot;</span>: <span class="hljs-number">0</span>,<br>  <span class="hljs-string">&quot;aggs&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;group_by_province&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;terms&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;province&quot;</span><br>      &#125;,<br>      <span class="hljs-string">&quot;aggs&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;latency_percentiles&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;percentiles&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;latency&quot;</span>,<br>            <span class="hljs-string">&quot;percents&quot;</span>: [<br><span class="hljs-built_in">              50,</span><br><span class="hljs-built_in">              95,</span><br>              <span class="hljs-number">99</span><br>            ]<br>          &#125;<br>        &#125;,<br>        <span class="hljs-string">&quot;latency_avg&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;avg&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;latency&quot;</span><br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;took&quot;</span>: <span class="hljs-number">33</span>,<br>  <span class="hljs-attr">&quot;timed_out&quot;</span>: <span class="hljs-literal">false</span>,<br>  <span class="hljs-attr">&quot;_shards&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">5</span>,<br>    <span class="hljs-attr">&quot;successful&quot;</span>: <span class="hljs-number">5</span>,<br>    <span class="hljs-attr">&quot;failed&quot;</span>: <span class="hljs-number">0</span><br>  &#125;,<br>  <span class="hljs-attr">&quot;hits&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">12</span>,<br>    <span class="hljs-attr">&quot;max_score&quot;</span>: <span class="hljs-number">0</span>,<br>    <span class="hljs-attr">&quot;hits&quot;</span>: []<br>  &#125;,<br>  <span class="hljs-attr">&quot;aggregations&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;group_by_province&quot;</span>: &#123;<br>      <span class="hljs-attr">&quot;doc_count_error_upper_bound&quot;</span>: <span class="hljs-number">0</span>,<br>      <span class="hljs-attr">&quot;sum_other_doc_count&quot;</span>: <span class="hljs-number">0</span>,<br>      <span class="hljs-attr">&quot;buckets&quot;</span>: [<br>        &#123;<br>          <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-string">&quot;新疆&quot;</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">6</span>,<br>          <span class="hljs-attr">&quot;latency_avg&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">314.5</span><br>          &#125;,<br>          <span class="hljs-attr">&quot;latency_percentiles&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;values&quot;</span>: &#123;<br>              <span class="hljs-attr">&quot;50.0&quot;</span>: <span class="hljs-number">288.5</span>,<br>              <span class="hljs-attr">&quot;95.0&quot;</span>: <span class="hljs-number">587.75</span>,<br>              <span class="hljs-attr">&quot;99.0&quot;</span>: <span class="hljs-number">640.75</span><br>            &#125;<br>          &#125;<br>        &#125;,<br>        &#123;<br>          <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-string">&quot;江苏&quot;</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">6</span>,<br>          <span class="hljs-attr">&quot;latency_avg&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">89.33333333333333</span><br>          &#125;,<br>          <span class="hljs-attr">&quot;latency_percentiles&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;values&quot;</span>: &#123;<br>              <span class="hljs-attr">&quot;50.0&quot;</span>: <span class="hljs-number">87.5</span>,<br>              <span class="hljs-attr">&quot;95.0&quot;</span>: <span class="hljs-number">110.25</span>,<br>              <span class="hljs-attr">&quot;99.0&quot;</span>: <span class="hljs-number">111.65</span><br>            &#125;<br>          &#125;<br>        &#125;<br>      ]<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="percentile-ranks计算网站的SLA"><a href="#percentile-ranks计算网站的SLA" class="headerlink" title="percentile_ranks计算网站的SLA"></a>percentile_ranks计算网站的SLA</h5><p>SLA：提供的服务的标准，大型的互联网公司的访问延时SLA一般是要确保100%的请求都控制在200ms以内，如果超过1s，则需要升级到A级故障，代表网站的访问性能和用户体验急剧下降。</p>
<p>需求：在200ms以内的，有百分之多少，在1000毫秒以内的有百分之多少。</p>
<p>按照品牌分组，计算，电视机，售价在1000占比，2000占比，3000占比</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/website/</span>logs/_search <br>&#123;<br>  <span class="hljs-string">&quot;size&quot;</span>: <span class="hljs-number">0</span>,<br>  <span class="hljs-string">&quot;aggs&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;group_by_province&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;terms&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;province&quot;</span><br>      &#125;,<br>      <span class="hljs-string">&quot;aggs&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;latency_percentile_ranks&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;percentile_ranks&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;latency&quot;</span>,<br>            <span class="hljs-string">&quot;values&quot;</span>: [<br>              <span class="hljs-number">200</span>,<br>              <span class="hljs-number">1000</span><br>            ]<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;took&quot;</span>: <span class="hljs-number">38</span>,<br>  <span class="hljs-attr">&quot;timed_out&quot;</span>: <span class="hljs-literal">false</span>,<br>  <span class="hljs-attr">&quot;_shards&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">5</span>,<br>    <span class="hljs-attr">&quot;successful&quot;</span>: <span class="hljs-number">5</span>,<br>    <span class="hljs-attr">&quot;failed&quot;</span>: <span class="hljs-number">0</span><br>  &#125;,<br>  <span class="hljs-attr">&quot;hits&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">12</span>,<br>    <span class="hljs-attr">&quot;max_score&quot;</span>: <span class="hljs-number">0</span>,<br>    <span class="hljs-attr">&quot;hits&quot;</span>: []<br>  &#125;,<br>  <span class="hljs-attr">&quot;aggregations&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;group_by_province&quot;</span>: &#123;<br>      <span class="hljs-attr">&quot;doc_count_error_upper_bound&quot;</span>: <span class="hljs-number">0</span>,<br>      <span class="hljs-attr">&quot;sum_other_doc_count&quot;</span>: <span class="hljs-number">0</span>,<br>      <span class="hljs-attr">&quot;buckets&quot;</span>: [<br>        &#123;<br>          <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-string">&quot;新疆&quot;</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">6</span>,<br>          <span class="hljs-attr">&quot;latency_percentile_ranks&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;values&quot;</span>: &#123;<br>              <span class="hljs-attr">&quot;200.0&quot;</span>: <span class="hljs-number">29.40613026819923</span>,<br>              <span class="hljs-attr">&quot;1000.0&quot;</span>: <span class="hljs-number">100</span><br>            &#125;<br>          &#125;<br>        &#125;,<br>        &#123;<br>          <span class="hljs-attr">&quot;key&quot;</span>: <span class="hljs-string">&quot;江苏&quot;</span>,<br>          <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">6</span>,<br>          <span class="hljs-attr">&quot;latency_percentile_ranks&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;values&quot;</span>: &#123;<br>              <span class="hljs-attr">&quot;200.0&quot;</span>: <span class="hljs-number">100</span>,<br>              <span class="hljs-attr">&quot;1000.0&quot;</span>: <span class="hljs-number">100</span><br>            &#125;<br>          &#125;<br>        &#125;<br>      ]<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="percentile的优化"><a href="#percentile的优化" class="headerlink" title="percentile的优化"></a>percentile的优化</h5><p>percentile的优化底层使用TDigest算法，用很多节点来执行百分比的计算，近似估计，有误差，节点越多，越精准。</p>
<p>compression</p>
<p>限制节点数量最多 compression * 20 = 2000个node去计算</p>
<p>默认100</p>
<p>越大，占用内存越多，越精准，性能越差</p>
<p>一个节点占用32字节，100 * 20 * 32 = 64KB</p>
<p>如果你想要percentile算法越精准，compression可以设置的越大。</p>
<h3 id="进阶使用"><a href="#进阶使用" class="headerlink" title="进阶使用"></a>进阶使用</h3><h4 id="跨字段搜索的优化"><a href="#跨字段搜索的优化" class="headerlink" title="跨字段搜索的优化"></a>跨字段搜索的优化</h4><h5 id="基于dis-max实现best-fields"><a href="#基于dis-max实现best-fields" class="headerlink" title="基于dis_max实现best fields"></a>基于dis_max实现best fields</h5><p>为帖子数据增加content字段</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs n1ql">POST /forum/article/_bulk<br>&#123; &quot;<span class="hljs-keyword">update</span><span class="hljs-string">&quot;: &#123; &quot;</span>_id<span class="hljs-string">&quot;: &quot;</span><span class="hljs-number">1</span><span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span>doc<span class="hljs-string">&quot; : &#123;&quot;</span>content<span class="hljs-string">&quot; : &quot;</span>i <span class="hljs-keyword">like</span> <span class="hljs-keyword">to</span> write best elasticsearch article<span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">update</span><span class="hljs-string">&quot;: &#123; &quot;</span>_id<span class="hljs-string">&quot;: &quot;</span><span class="hljs-number">2</span><span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span>doc<span class="hljs-string">&quot; : &#123;&quot;</span>content<span class="hljs-string">&quot; : &quot;</span>i think java <span class="hljs-keyword">is</span> the best programming language<span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">update</span><span class="hljs-string">&quot;: &#123; &quot;</span>_id<span class="hljs-string">&quot;: &quot;</span><span class="hljs-number">3</span><span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span>doc<span class="hljs-string">&quot; : &#123;&quot;</span>content<span class="hljs-string">&quot; : &quot;</span>i am only an elasticsearch beginner<span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">update</span><span class="hljs-string">&quot;: &#123; &quot;</span>_id<span class="hljs-string">&quot;: &quot;</span><span class="hljs-number">4</span><span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span>doc<span class="hljs-string">&quot; : &#123;&quot;</span>content<span class="hljs-string">&quot; : &quot;</span>elasticsearch <span class="hljs-keyword">and</span> hadoop are <span class="hljs-keyword">all</span> very good solution, i am a beginner<span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">update</span><span class="hljs-string">&quot;: &#123; &quot;</span>_id<span class="hljs-string">&quot;: &quot;</span><span class="hljs-number">5</span><span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span>doc<span class="hljs-string">&quot; : &#123;&quot;</span>content<span class="hljs-string">&quot; : &quot;</span>spark <span class="hljs-keyword">is</span> best big data solution based <span class="hljs-keyword">on</span> scala ,an programming language similar <span class="hljs-keyword">to</span> java<span class="hljs-string">&quot;&#125; &#125;</span><br></code></pre></td></tr></table></figure>

<p>搜索title或content中包含java或solution的帖子</p>
<p>下面这个就是multi-field搜索，多字段搜索</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/forum/</span>article/_search<br>&#123;<br>    <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;bool&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;should&quot;</span>: [<br>                &#123; <span class="hljs-string">&quot;match&quot;</span>: &#123; <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;java solution&quot;</span> &#125;&#125;,<br>                &#123; <span class="hljs-string">&quot;match&quot;</span>: &#123; <span class="hljs-string">&quot;content&quot;</span>:  <span class="hljs-string">&quot;java solution&quot;</span> &#125;&#125;<br>            ]<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>结果分析</p>
<p>期望的是doc5被排在最前面，因为doc5中的content的内容最接近搜索结果，但结果是doc2,doc4排在了前面。</p>
<p>es内部计算每个document的relevance score为，每个query的分数加起来乘以matched query数量，除以总query数量。</p>
<p>此时doc4的分数：</p>
<p><code>&#123; &quot;match&quot;: &#123; &quot;title&quot;: &quot;java solution&quot; &#125;&#125;</code>对于doc4，假设为1.1，<code>&#123; &quot;match&quot;: &#123; &quot;content&quot;:  &quot;java solution&quot; &#125;&#125;</code>对于doc4，假设为1.2。所以doc4的分数：（1.1+1.2）* 2 / 2 = 2.3。</p>
<p>doc5的分数：</p>
<p><code>&#123; &quot;match&quot;: &#123; &quot;title&quot;: &quot;java solution&quot; &#125;&#125;</code>，对于doc5，没有分数，<code>&#123; &quot;match&quot;: &#123; &quot;content&quot;:  &quot;java solution&quot; &#125;&#125;</code>，对于doc5因为匹配度较高，假设为2.3，所以doc5的分数为：2.3 * 1 / 2 = 1.15。</p>
<p>doc5的分数 &lt; doc4的分数，所以doc5排在了后面。</p>
<p>es内部提供了dis_max语法，实现了best fields策略。就是说，搜索到的结果，应该是某一个field中匹配到了尽可能多的关键词被排在前面；而不是尽可能多的field匹配到了少数的关键词排在了前面。</p>
<p>dis_max语法，可以直接取多个query中，分数最高的那一个query的分数作为本次搜索的分数。</p>
<p>使用方式：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/forum/</span>article/_search<br>&#123;<br>    <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;dis_max&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;queries&quot;</span>: [<br>                &#123; <span class="hljs-string">&quot;match&quot;</span>: &#123; <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;java solution&quot;</span> &#125;&#125;,<br>                &#123; <span class="hljs-string">&quot;match&quot;</span>: &#123; <span class="hljs-string">&quot;content&quot;</span>:  <span class="hljs-string">&quot;java solution&quot;</span> &#125;&#125;<br>            ]<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>&#123; &quot;match&quot;: &#123; &quot;title&quot;: &quot;java solution&quot; &#125;&#125;</code>，对于doc4，为1.1分，<code>&#123; &quot;match&quot;: &#123; &quot;content&quot;:  &quot;java solution&quot; &#125;&#125;</code>对于doc4，为1.2分，此时会取最大的分数，1.2分。同理，doc5中的最大分数为2.3分，所以doc5就会排在doc4的前面。</p>
<p>dis_max只取某一个query最大的分数，完全不考虑其他query的分数，可以使用使用tie_breaker将其他query的分数也考虑进去。</p>
<p>tie_breaker参数的意义，在于说，将其他query的分数，乘以tie_breaker，然后综合与最高分数的那个query的分数，综合在一起进行计算，除了取最高分以外，还会考虑其他的query的分数，tie_breaker的值，在0~1之间，是个小数，就ok</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/forum/</span>article/_search<br>&#123;<br>    <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;dis_max&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;queries&quot;</span>: [<br>                &#123; <span class="hljs-string">&quot;match&quot;</span>: &#123; <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;java beginner&quot;</span> &#125;&#125;,<br>                &#123; <span class="hljs-string">&quot;match&quot;</span>: &#123; <span class="hljs-string">&quot;body&quot;</span>:  <span class="hljs-string">&quot;java beginner&quot;</span> &#125;&#125;<br>            ],<br>            <span class="hljs-string">&quot;tie_breaker&quot;</span>: <span class="hljs-number">0.3</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>minimum_should_match：控制搜索结果的精准度，只有匹配一定数量的关键词的数据，才能返回，主要用来去长尾。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/forum/</span>article/_search<br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;multi_match&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;query&quot;</span>:                <span class="hljs-string">&quot;java solution&quot;</span>,<br>        <span class="hljs-string">&quot;type&quot;</span>:                 <span class="hljs-string">&quot;best_fields&quot;</span>, <br>        <span class="hljs-string">&quot;fields&quot;</span>:               [ <span class="hljs-string">&quot;title^2&quot;</span>, <span class="hljs-string">&quot;content&quot;</span> ],<br>        <span class="hljs-string">&quot;tie_breaker&quot;</span>:          <span class="hljs-number">0.3</span>,<br>        <span class="hljs-string">&quot;minimum_should_match&quot;</span>: <span class="hljs-string">&quot;50%&quot;</span> <br>    &#125;<br>  &#125; <br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="基于multi-match实现most-fields"><a href="#基于multi-match实现most-fields" class="headerlink" title="基于multi_match实现most fields"></a>基于multi_match实现most fields</h5><p>从best-fields换成most-fields策略<br>best-fields策略，主要是说将某一个field匹配尽可能多的关键词的doc优先返回回来<br>most-fields策略，主要是说尽可能返回更多field匹配到某个关键词的doc，优先返回回来</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/forum/</span>article/_search<br>&#123;<br>   <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;multi_match&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;query&quot;</span>:  <span class="hljs-string">&quot;learning courses&quot;</span>,<br>            <span class="hljs-string">&quot;type&quot;</span>:   <span class="hljs-string">&quot;most_fields&quot;</span>, <br>            <span class="hljs-string">&quot;fields&quot;</span>: [ <span class="hljs-string">&quot;sub_title&quot;</span>, <span class="hljs-string">&quot;sub_title.std&quot;</span> ]<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>（1）best_fields，是对多个field进行搜索，挑选某个field匹配度最高的那个分数，同时在多个query最高分相同的情况下，在一定程度上考虑其他query的分数。简单来说，你对多个field进行搜索，就想搜索到某一个field尽可能包含更多关键字的数据</p>
<p>优点：通过best_fields策略，以及综合考虑其他field，还有minimum_should_match支持，可以尽可能精准地将匹配的结果推送到最前面<br>缺点：除了那些精准匹配的结果，其他差不多大的结果，排序结果不是太均匀，没有什么区分度了</p>
<p>实际的例子：百度之类的搜索引擎，最匹配的到最前面，但是其他的就没什么区分度了</p>
<p>（2）most_fields，综合多个field一起进行搜索，尽可能多地让所有field的query参与到总分数的计算中来，此时就会是个大杂烩，出现类似best_fields案例最开始的那个结果，结果不一定精准，某一个document的一个field包含更多的关键字，但是因为其他document有更多field匹配到了，所以排在了前面；所以需要建立类似sub_title.std这样的field，尽可能让某一个field精准匹配query string，贡献更高的分数，将更精准匹配的数据排到前面</p>
<p>优点：将尽可能匹配更多field的结果推送到最前面，整个排序结果是比较均匀的<br>缺点：可能那些精准匹配的结果，无法推送到最前面</p>
<h5 id="most-fields进行cross-fields-search"><a href="#most-fields进行cross-fields-search" class="headerlink" title="most_fields进行cross-fields search"></a>most_fields进行cross-fields search</h5><p>cross-fields搜索跨多个field的标识，比如姓名和地址。姓名可以散落在多个field中，比如first_name和last_name中，地址可以散落在country，province，city中。</p>
<p>初步来说，如果要实现，可能用most_fields比较合适。因为best_fields是优先搜索单个field最匹配的结果，cross-fields本身就不是一个field的问题了。</p>
<p>测试数据</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs n1ql">POST /forum/article/_bulk<br>&#123; &quot;<span class="hljs-keyword">update</span><span class="hljs-string">&quot;: &#123; &quot;</span>_id<span class="hljs-string">&quot;: &quot;</span><span class="hljs-number">1</span><span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span>doc<span class="hljs-string">&quot; : &#123;&quot;</span>author_first_name<span class="hljs-string">&quot; : &quot;</span>Peter<span class="hljs-string">&quot;, &quot;</span>author_last_name<span class="hljs-string">&quot; : &quot;</span>Smith<span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">update</span><span class="hljs-string">&quot;: &#123; &quot;</span>_id<span class="hljs-string">&quot;: &quot;</span><span class="hljs-number">2</span><span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span>doc<span class="hljs-string">&quot; : &#123;&quot;</span>author_first_name<span class="hljs-string">&quot; : &quot;</span>Smith<span class="hljs-string">&quot;, &quot;</span>author_last_name<span class="hljs-string">&quot; : &quot;</span>Williams<span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">update</span><span class="hljs-string">&quot;: &#123; &quot;</span>_id<span class="hljs-string">&quot;: &quot;</span><span class="hljs-number">3</span><span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span>doc<span class="hljs-string">&quot; : &#123;&quot;</span>author_first_name<span class="hljs-string">&quot; : &quot;</span>Jack<span class="hljs-string">&quot;, &quot;</span>author_last_name<span class="hljs-string">&quot; : &quot;</span>Ma<span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">update</span><span class="hljs-string">&quot;: &#123; &quot;</span>_id<span class="hljs-string">&quot;: &quot;</span><span class="hljs-number">4</span><span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span>doc<span class="hljs-string">&quot; : &#123;&quot;</span>author_first_name<span class="hljs-string">&quot; : &quot;</span>Robbin<span class="hljs-string">&quot;, &quot;</span>author_last_name<span class="hljs-string">&quot; : &quot;</span>Li<span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">update</span><span class="hljs-string">&quot;: &#123; &quot;</span>_id<span class="hljs-string">&quot;: &quot;</span><span class="hljs-number">5</span><span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span>doc<span class="hljs-string">&quot; : &#123;&quot;</span>author_first_name<span class="hljs-string">&quot; : &quot;</span>Tonny<span class="hljs-string">&quot;, &quot;</span>author_last_name<span class="hljs-string">&quot; : &quot;</span>Peter Smith<span class="hljs-string">&quot;&#125; &#125;</span><br></code></pre></td></tr></table></figure>

<p>搜索</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/forum/</span>article/_search<br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;multi_match&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;query&quot;</span>:       <span class="hljs-string">&quot;Peter Smith&quot;</span>,<br>      <span class="hljs-string">&quot;type&quot;</span>:        <span class="hljs-string">&quot;most_fields&quot;</span>,<br>      <span class="hljs-string">&quot;fields&quot;</span>:      [ <span class="hljs-string">&quot;author_first_name&quot;</span>, <span class="hljs-string">&quot;author_last_name&quot;</span> ]<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>结果分析</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;took&quot;</span>: <span class="hljs-number">2</span>,<br>  <span class="hljs-attr">&quot;timed_out&quot;</span>: <span class="hljs-literal">false</span>,<br>  <span class="hljs-attr">&quot;_shards&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">5</span>,<br>    <span class="hljs-attr">&quot;successful&quot;</span>: <span class="hljs-number">5</span>,<br>    <span class="hljs-attr">&quot;failed&quot;</span>: <span class="hljs-number">0</span><br>  &#125;,<br>  <span class="hljs-attr">&quot;hits&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">3</span>,<br>    <span class="hljs-attr">&quot;max_score&quot;</span>: <span class="hljs-number">0.6931472</span>,<br>    <span class="hljs-attr">&quot;hits&quot;</span>: [<br>      &#123;<br>        <span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;forum&quot;</span>,<br>        <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;article&quot;</span>,<br>        <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;2&quot;</span>,<br>        <span class="hljs-attr">&quot;_score&quot;</span>: <span class="hljs-number">0.6931472</span>,<br>        <span class="hljs-attr">&quot;_source&quot;</span>: &#123;<br>          <span class="hljs-attr">&quot;articleID&quot;</span>: <span class="hljs-string">&quot;KDKE-B-9947-#kL5&quot;</span>,<br>          <span class="hljs-attr">&quot;userID&quot;</span>: <span class="hljs-number">1</span>,<br>          <span class="hljs-attr">&quot;hidden&quot;</span>: <span class="hljs-literal">false</span>,<br>          <span class="hljs-attr">&quot;postDate&quot;</span>: <span class="hljs-string">&quot;2017-01-02&quot;</span>,<br>          <span class="hljs-attr">&quot;tag&quot;</span>: [<br>            <span class="hljs-string">&quot;java&quot;</span><br>          ],<br>          <span class="hljs-attr">&quot;tag_cnt&quot;</span>: <span class="hljs-number">1</span>,<br>          <span class="hljs-attr">&quot;view_cnt&quot;</span>: <span class="hljs-number">50</span>,<br>          <span class="hljs-attr">&quot;title&quot;</span>: <span class="hljs-string">&quot;this is java blog&quot;</span>,<br>          <span class="hljs-attr">&quot;content&quot;</span>: <span class="hljs-string">&quot;i think java is the best programming language&quot;</span>,<br>          <span class="hljs-attr">&quot;sub_title&quot;</span>: <span class="hljs-string">&quot;learned a lot of course&quot;</span>,<br>          <span class="hljs-attr">&quot;author_first_name&quot;</span>: <span class="hljs-string">&quot;Smith&quot;</span>,<br>          <span class="hljs-attr">&quot;author_last_name&quot;</span>: <span class="hljs-string">&quot;Williams&quot;</span><br>        &#125;<br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;forum&quot;</span>,<br>        <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;article&quot;</span>,<br>        <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>,<br>        <span class="hljs-attr">&quot;_score&quot;</span>: <span class="hljs-number">0.5753642</span>,<br>        <span class="hljs-attr">&quot;_source&quot;</span>: &#123;<br>          <span class="hljs-attr">&quot;articleID&quot;</span>: <span class="hljs-string">&quot;XHDK-A-1293-#fJ3&quot;</span>,<br>          <span class="hljs-attr">&quot;userID&quot;</span>: <span class="hljs-number">1</span>,<br>          <span class="hljs-attr">&quot;hidden&quot;</span>: <span class="hljs-literal">false</span>,<br>          <span class="hljs-attr">&quot;postDate&quot;</span>: <span class="hljs-string">&quot;2017-01-01&quot;</span>,<br>          <span class="hljs-attr">&quot;tag&quot;</span>: [<br>            <span class="hljs-string">&quot;java&quot;</span>,<br>            <span class="hljs-string">&quot;hadoop&quot;</span><br>          ],<br>          <span class="hljs-attr">&quot;tag_cnt&quot;</span>: <span class="hljs-number">2</span>,<br>          <span class="hljs-attr">&quot;view_cnt&quot;</span>: <span class="hljs-number">30</span>,<br>          <span class="hljs-attr">&quot;title&quot;</span>: <span class="hljs-string">&quot;this is java and elasticsearch blog&quot;</span>,<br>          <span class="hljs-attr">&quot;content&quot;</span>: <span class="hljs-string">&quot;i like to write best elasticsearch article&quot;</span>,<br>          <span class="hljs-attr">&quot;sub_title&quot;</span>: <span class="hljs-string">&quot;learning more courses&quot;</span>,<br>          <span class="hljs-attr">&quot;author_first_name&quot;</span>: <span class="hljs-string">&quot;Peter&quot;</span>,<br>          <span class="hljs-attr">&quot;author_last_name&quot;</span>: <span class="hljs-string">&quot;Smith&quot;</span><br>        &#125;<br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;forum&quot;</span>,<br>        <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;article&quot;</span>,<br>        <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;5&quot;</span>,<br>        <span class="hljs-attr">&quot;_score&quot;</span>: <span class="hljs-number">0.51623213</span>,<br>        <span class="hljs-attr">&quot;_source&quot;</span>: &#123;<br>          <span class="hljs-attr">&quot;articleID&quot;</span>: <span class="hljs-string">&quot;DHJK-B-1395-#Ky5&quot;</span>,<br>          <span class="hljs-attr">&quot;userID&quot;</span>: <span class="hljs-number">3</span>,<br>          <span class="hljs-attr">&quot;hidden&quot;</span>: <span class="hljs-literal">false</span>,<br>          <span class="hljs-attr">&quot;postDate&quot;</span>: <span class="hljs-string">&quot;2017-03-01&quot;</span>,<br>          <span class="hljs-attr">&quot;tag&quot;</span>: [<br>            <span class="hljs-string">&quot;elasticsearch&quot;</span><br>          ],<br>          <span class="hljs-attr">&quot;tag_cnt&quot;</span>: <span class="hljs-number">1</span>,<br>          <span class="hljs-attr">&quot;view_cnt&quot;</span>: <span class="hljs-number">10</span>,<br>          <span class="hljs-attr">&quot;title&quot;</span>: <span class="hljs-string">&quot;this is spark blog&quot;</span>,<br>          <span class="hljs-attr">&quot;content&quot;</span>: <span class="hljs-string">&quot;spark is best big data solution based on scala ,an programming language similar to java&quot;</span>,<br>          <span class="hljs-attr">&quot;sub_title&quot;</span>: <span class="hljs-string">&quot;haha, hello world&quot;</span>,<br>          <span class="hljs-attr">&quot;author_first_name&quot;</span>: <span class="hljs-string">&quot;Tonny&quot;</span>,<br>          <span class="hljs-attr">&quot;author_last_name&quot;</span>: <span class="hljs-string">&quot;Peter Smith&quot;</span><br>        &#125;<br>      &#125;<br>    ]<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>结果分析：</p>
<p>由于在first_name中smith只出现了一次，在last_name中出现了5次，这就导致在first_name中出现Smith的结果IDF分数较高，在last_name中的Smith分数较低。</p>
<p>出现的问题</p>
<p>问题1：只是找到尽可能多的field匹配的doc，而不是某个field完全匹配的doc</p>
<p>问题2：most_fields，没办法用minimum_should_match去掉长尾数据，就是匹配的特别少的结果</p>
<p>问题3：TF/IDF算法，比如Peter Smith和Smith Williams，搜索Peter Smith的时候，由于first_name中很少有Smith的，所以query在所有document中的频率很低，得到的分数很高，可能Smith Williams反而会排在Peter Smith前面</p>
<h5 id="copy-to定制组合field解决cross-fields问题"><a href="#copy-to定制组合field解决cross-fields问题" class="headerlink" title="copy_to定制组合field解决cross fields问题"></a>copy_to定制组合field解决cross fields问题</h5><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs awk">PUT <span class="hljs-regexp">/forum/</span>_mapping/article<br>&#123;<br>  <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;new_author_first_name&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;type&quot;</span>:     <span class="hljs-string">&quot;string&quot;</span>,<br>          <span class="hljs-string">&quot;copy_to&quot;</span>:  <span class="hljs-string">&quot;new_author_full_name&quot;</span> <br>      &#125;,<br>      <span class="hljs-string">&quot;new_author_last_name&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;type&quot;</span>:     <span class="hljs-string">&quot;string&quot;</span>,<br>          <span class="hljs-string">&quot;copy_to&quot;</span>:  <span class="hljs-string">&quot;new_author_full_name&quot;</span> <br>      &#125;,<br>      <span class="hljs-string">&quot;new_author_full_name&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;type&quot;</span>:     <span class="hljs-string">&quot;string&quot;</span><br>      &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>初始化内容</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs n1ql">POST /forum/article/_bulk<br>&#123; &quot;<span class="hljs-keyword">update</span><span class="hljs-string">&quot;: &#123; &quot;</span>_id<span class="hljs-string">&quot;: &quot;</span><span class="hljs-number">1</span><span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span>doc<span class="hljs-string">&quot; : &#123;&quot;</span>new_author_first_name<span class="hljs-string">&quot; : &quot;</span>Peter<span class="hljs-string">&quot;, &quot;</span>new_author_last_name<span class="hljs-string">&quot; : &quot;</span>Smith<span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">update</span><span class="hljs-string">&quot;: &#123; &quot;</span>_id<span class="hljs-string">&quot;: &quot;</span><span class="hljs-number">2</span><span class="hljs-string">&quot;&#125; &#125;	</span><br><span class="hljs-string">&#123; &quot;</span>doc<span class="hljs-string">&quot; : &#123;&quot;</span>new_author_first_name<span class="hljs-string">&quot; : &quot;</span>Smith<span class="hljs-string">&quot;, &quot;</span>new_author_last_name<span class="hljs-string">&quot; : &quot;</span>Williams<span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">update</span><span class="hljs-string">&quot;: &#123; &quot;</span>_id<span class="hljs-string">&quot;: &quot;</span><span class="hljs-number">3</span><span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span>doc<span class="hljs-string">&quot; : &#123;&quot;</span>new_author_first_name<span class="hljs-string">&quot; : &quot;</span>Jack<span class="hljs-string">&quot;, &quot;</span>new_author_last_name<span class="hljs-string">&quot; : &quot;</span>Ma<span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">update</span><span class="hljs-string">&quot;: &#123; &quot;</span>_id<span class="hljs-string">&quot;: &quot;</span><span class="hljs-number">4</span><span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span>doc<span class="hljs-string">&quot; : &#123;&quot;</span>new_author_first_name<span class="hljs-string">&quot; : &quot;</span>Robbin<span class="hljs-string">&quot;, &quot;</span>new_author_last_name<span class="hljs-string">&quot; : &quot;</span>Li<span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">update</span><span class="hljs-string">&quot;: &#123; &quot;</span>_id<span class="hljs-string">&quot;: &quot;</span><span class="hljs-number">5</span><span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span>doc<span class="hljs-string">&quot; : &#123;&quot;</span>new_author_first_name<span class="hljs-string">&quot; : &quot;</span>Tonny<span class="hljs-string">&quot;, &quot;</span>new_author_last_name<span class="hljs-string">&quot; : &quot;</span>Peter Smith<span class="hljs-string">&quot;&#125; &#125;</span><br></code></pre></td></tr></table></figure>

<p>搜索</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/forum/</span>article/_search<br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;new_author_full_name&quot;</span>:       <span class="hljs-string">&quot;Peter Smith&quot;</span><br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这时peter smith分数较高，但是仍不是最高分数。</p>
<p>问题1：只是找到尽可能多的field匹配的doc，而不是某个field完全匹配的doc –&gt; 解决，最匹配的document被最先返回</p>
<p>问题2：most_fields，没办法用minimum_should_match去掉长尾数据，就是匹配的特别少的结果 –&gt; 解决，可以使用minimum_should_match去掉长尾数据</p>
<p>问题3：TF/IDF算法，比如Peter Smith和Smith Williams，搜索Peter Smith的时候，由于first_name中很少有Smith的，所以query在所有document中的频率很低，得到的分数很高，可能Smith Williams反而会排在Peter Smith前面 –&gt; 解决，Smith和Peter在一个field了，所以在所有document中出现的次数是均匀的，不会有极端的偏差</p>
<h5 id="原生cross-fields搜索"><a href="#原生cross-fields搜索" class="headerlink" title="原生cross fields搜索"></a>原生cross fields搜索</h5><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/forum/</span>article/_search<br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;multi_match&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;query&quot;</span>: <span class="hljs-string">&quot;Peter Smith&quot;</span>,<br>      <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;cross_fields&quot;</span>, <br>      <span class="hljs-string">&quot;operator&quot;</span>: <span class="hljs-string">&quot;and&quot;</span>,<br>      <span class="hljs-string">&quot;fields&quot;</span>: [<span class="hljs-string">&quot;author_first_name&quot;</span>, <span class="hljs-string">&quot;author_last_name&quot;</span>]<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>问题1：只是找到尽可能多的field匹配的doc，而不是某个field完全匹配的doc –&gt; 解决，要求每个term都必须在任何一个field中出现</p>
<p>Peter，Smith</p>
<p>要求Peter必须在author_first_name或author_last_name中出现<br>要求Smith必须在author_first_name或author_last_name中出现</p>
<p>Peter Smith可能是横跨在多个field中的，所以必须要求每个term都在某个field中出现，组合起来才能组成我们想要的标识</p>
<p>原来most_fields搜索方式，可能像Smith Williams也可能会出现，因为most_fields要求只是任何一个field匹配了就可以，匹配的field越多，分数越高。</p>
<p>问题2：most_fields，没办法用minimum_should_match去掉长尾数据，就是匹配的特别少的结果 –&gt; 解决，既然每个term都要求出现，长尾肯定被去除掉了</p>
<p>问题3：TF/IDF算法，比如Peter Smith和Smith Williams，搜索Peter Smith的时候，由于first_name中很少有Smith的，所以query在所有document中的频率很低，得到的分数很高，可能Smith Williams反而会排在Peter Smith前面 –&gt; 计算IDF的时候，将每个query在每个field中的IDF都取出来，取最小值，就不会出现极端情况下的极大值了</p>
<p>Peter Smith</p>
<p>Peter<br>Smith</p>
<p>Smith，在author_first_name这个field中，在所有doc的这个Field中，出现的频率很低，导致IDF分数很高；Smith在所有doc的author_last_name field中的频率算出一个IDF分数，因为一般来说last_name中的Smith频率都较高，所以IDF分数是正常的，不会太高；然后对于Smith来说，会取两个IDF分数中，较小的那个分数。就不会出现IDF分过高的情况。</p>
<h4 id="近似匹配"><a href="#近似匹配" class="headerlink" title="近似匹配"></a>近似匹配</h4><h5 id="phrase-matching搜索"><a href="#phrase-matching搜索" class="headerlink" title="phrase matching搜索"></a>phrase matching搜索</h5><p>比如说，有两个句子</p>
<p>java is my favourite programming language, and I also think spark is a very good big data system.<br>java spark are very related, because scala is spark’s programming language and scala is also based on jvm like java.</p>
<p>如果说，要实现两个需求：</p>
<p>1、java spark，就靠在一起，中间不能插入任何其他字符，就要搜索出来这种doc<br>2、java spark，但是要求，java和spark两个单词靠的越近，doc的分数越高，排名越靠前</p>
<p>要实现上述两个需求，用match做全文检索，是搞不定的，必须得用proximity match，近似匹配</p>
<p>修改测试数据</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs awk">POST <span class="hljs-regexp">/forum/</span>article<span class="hljs-regexp">/5/</span>_update<br>&#123;<br>  <span class="hljs-string">&quot;doc&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;spark is best big data solution based on scala ,an programming language similar to java spark&quot;</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>phrase match，proximity match：短语匹配，近似匹配</p>
<p>match_phrase语法</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/forum/</span>article/_search<br>&#123;<br>    <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;match_phrase&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;java spark&quot;</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="slop参数实现近似匹配"><a href="#slop参数实现近似匹配" class="headerlink" title="slop参数实现近似匹配"></a>slop参数实现近似匹配</h5><p>query string中的term要经过几次移动，才能跟document匹配上，比如java is very good ，spark is alse very good，search string为java spark，其中，java匹配上之后，spark需要移动3次，才能匹配到，这时的slop就是3。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/forum/</span>article/_search<br>&#123;<br>    <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;match_phrase&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;title&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;query&quot;</span>: <span class="hljs-string">&quot;java spark&quot;</span>,<br>                <span class="hljs-string">&quot;slop&quot;</span>:  <span class="hljs-number">3</span><br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>slop参数的含义指，在进行匹配时query string中的term最多可以移动3次。如果search string中term的出现顺序与docuemnt中的不同，则需要额外的slop进行反转。</p>
<p>在slop搜索下，关键词离的越近，relevance score就会越高</p>
<h5 id="召回率与精准度的平衡"><a href="#召回率与精准度的平衡" class="headerlink" title="召回率与精准度的平衡"></a>召回率与精准度的平衡</h5><p>召回率是指能够匹配到的结果数量在整个doc中所占的比例</p>
<p>直接用match_parse短语搜索，会导致必须所有term都在doc file中出现，而且距离在slop限定范围内，才能匹配上。精准度较高，但召回率比较低。</p>
<p>如果可以只匹配到部分term，就可以作为结果返回，同时也能用上match_phrase中根据距离计算分数的功能，让term距离近的分数较高，优先返回，这样就能兼顾召回率与精准度。</p>
<p>用bool组合match query和match_phrase query一起，来实现上述效果</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/forum/</span>article/_search<br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;bool&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;must&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;match&quot;</span>: &#123; <br>          <span class="hljs-string">&quot;content&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;query&quot;</span>: <span class="hljs-string">&quot;java spark&quot;</span><br>          &#125;<br>        &#125;<br>      &#125;,<br>      <span class="hljs-string">&quot;should&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;match_phrase&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;content&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;query&quot;</span>: <span class="hljs-string">&quot;java spark&quot;</span>,<br>            <span class="hljs-string">&quot;slop&quot;</span>:  <span class="hljs-number">50</span><br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>只使用match中的内容，在对只包含 java或spark或java spark的结果中，java和spark靠前，但是没法区分java和spark的距离，也许java和spark靠的很近，但是没法排在最前面。</p>
<p>在使用match中的内容后，在slop以内，如果java spark能匹配上一个doc，那么就会对doc贡献自己的relevance score，如果java和spark靠的越近，那么就分数越高。</p>
<h5 id="rescoring机制优化近似匹配性能"><a href="#rescoring机制优化近似匹配性能" class="headerlink" title="rescoring机制优化近似匹配性能"></a>rescoring机制优化近似匹配性能</h5><p>match匹配时只需要通过倒排索引找到包含term的doc list，但phrase match除了找到包含所有term的doc list之外，还会对每个doc计算每个term的position，判断是否在指定的范围。而且slop需要进行复杂的运算，来判断能否通过slop移动，匹配一个doc。</p>
<p>match query的性能比phrase match和proximity match（含有slop的phrase match）要高很多。因为后两者都要计算position的距离。match query比phrase match的性能要高10倍，比proximity match的性能要高20倍。</p>
<p>但es的性能一般都在毫秒级别，match query一般就在几毫秒，或者几十毫秒，而phrase match和proximity match的性能在几十毫秒到几百毫秒之间，所以也是可以接受的。</p>
<p>优化proximity match的性能，一般就是减少要进行proximity match搜索的document数量。主要思路就是，用match query先过滤出需要的数据，然后再用proximity match来根据term距离提高doc的分数，同时proximity match只针对每个shard的分数排名前n个doc起作用，来重新调整它们的分数，这个过程称之为rescoring，重计分。因为一般用户会分页查询，只会看到前几页的数据，所以不需要对所有结果进行proximity match操作。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/forum/</span>article/_search <br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;java spark&quot;</span><br>    &#125;<br>  &#125;,<br>  <span class="hljs-string">&quot;rescore&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;window_size&quot;</span>: <span class="hljs-number">50</span>,<br>    <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;rescore_query&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;match_phrase&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;content&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;query&quot;</span>: <span class="hljs-string">&quot;java spark&quot;</span>,<br>            <span class="hljs-string">&quot;slop&quot;</span>: <span class="hljs-number">50</span><br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="搜索推荐"><a href="#搜索推荐" class="headerlink" title="搜索推荐"></a>搜索推荐</h4><h5 id="前缀搜索、通配符搜索、正则搜索"><a href="#前缀搜索、通配符搜索、正则搜索" class="headerlink" title="前缀搜索、通配符搜索、正则搜索"></a>前缀搜索、通配符搜索、正则搜索</h5><p>测试数据</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs awk">PUT my_index<br>&#123;<br>  <span class="hljs-string">&quot;mappings&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;my_type&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;title&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;keyword&quot;</span><br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br>PUT <span class="hljs-regexp">/my_index/my</span>_type/<span class="hljs-number">1</span><br>&#123;<br>  <span class="hljs-string">&quot;title&quot;</span>:<span class="hljs-string">&quot;C3D0-KD345&quot;</span><br>&#125;<br>PUT <span class="hljs-regexp">/my_index/my</span>_type/<span class="hljs-number">2</span><br>&#123;<br>  <span class="hljs-string">&quot;title&quot;</span>:<span class="hljs-string">&quot;C3K5-DFG65&quot;</span><br>&#125;<br>PUT <span class="hljs-regexp">/my_index/my</span>_type/<span class="hljs-number">3</span><br>&#123;<br>  <span class="hljs-string">&quot;title&quot;</span>:<span class="hljs-string">&quot;C4I8-UI365&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>前缀搜索</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET my_index<span class="hljs-regexp">/my_type/</span>_search<br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;prefix&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;title&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-string">&quot;C3&quot;</span><br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>prefix query不计算relevance score，与prefix filter唯一的区别就是，filter会进行cache</p>
<p>全文检索不需要扫描整个倒排索引就能匹配到数据，像C3-D0-KD345这种数据，可以被分词器拆解为单个的term，就可以使用全文检索获取到数据，但C3D0-KD345这种数据必须使用前缀搜索，与全文检索不同，前缀搜索需要扫描完整个索引，结束，前缀越短，要处理的doc越多，性能越差。所以尽可能使用长前缀搜索。</p>
<p>通配符搜索</p>
<p>跟前缀搜索类似，功能更加强大。但性能一样差，必须扫描整个倒排索引。</p>
<p>使用方式：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET my_index<span class="hljs-regexp">/my_type/</span>_search<br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;wildcard&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;title&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-string">&quot;C?K*5&quot;</span><br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>其中，?表示任意字符，*表示0个或任意多个字符</p>
<p>正则搜索</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/my_index/my</span>_type/_search <br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;regexp&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;C[0-9].+&quot;</span><br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>wildcard和regexp，与prefix原理一致，都会扫描整个索引，性能很差</p>
<h5 id="match-parse-prefix实现search-time搜索推荐"><a href="#match-parse-prefix实现search-time搜索推荐" class="headerlink" title="match_parse_prefix实现search-time搜索推荐"></a>match_parse_prefix实现search-time搜索推荐</h5><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/my_index/my</span>_type/_search <br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;match_phrase_prefix&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;hello w&quot;</span>,<br>      <span class="hljs-string">&quot;slop&quot;</span>: <span class="hljs-number">10</span>,<br>      <span class="hljs-string">&quot;max_expansions&quot;</span>: <span class="hljs-number">50</span><br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>原理跟match_phrase类似，唯一的区别就是把最后一个term作为前缀去搜索</p>
<p>hello就是去进行match，搜索对应的doc</p>
<p>w，会作为前缀，去扫描整个倒排索引，找到所有w开头的doc</p>
<p>然后找到所有doc中，即包含hello，又包含w开头的字符的doc</p>
<p>根据你的slop去计算，看在slop范围内，能不能让hello w，正好跟doc中的hello和w开头的单词的position相匹配</p>
<p>也可以指定slop，但是只有最后一个term会作为前缀</p>
<p>max_expansions：指定prefix最多匹配多少个term，超过这个数量就不继续匹配了，限定性能。默认情况下，前缀要扫描所有的倒排索引中的term，去查找w开头的单词，但是这样性能太差。可以用max_expansions限定，w前缀最多匹配多少个term，就不再继续搜索倒排索引了。</p>
<p>最后一个前缀始终要去扫描大量的索引，性能可能会很差，尽量不要使用。</p>
<h5 id="edge分词机制实现index-time搜索推荐"><a href="#edge分词机制实现index-time搜索推荐" class="headerlink" title="edge分词机制实现index-time搜索推荐"></a>edge分词机制实现index-time搜索推荐</h5><p>使用edge ngram将每个单词都进行进一步的分词切分，用切分后的ngram来实现前缀搜索推荐功能。</p>
<p>ngram和index-time搜索推荐原理</p>
<p>5种长度下的ngram拆解结果</p>
<p>ngram length=1，q u i c k<br>ngram length=2，qu ui ic ck<br>ngram length=3，qui uic ick<br>ngram length=4，quic uick<br>ngram length=5，quick</p>
<p>edge ngram拆解结果：</p>
<p>q<br>qu<br>qui<br>quic<br>quick</p>
<p>使用edge ngram将每个单词都进行进一步的分词切分后，ngram也可以实现前缀搜索推荐功能</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs dts">PUT /my_index<br>&#123;<br>    <span class="hljs-string">&quot;settings&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;analysis&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;filter&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;autocomplete_filter&quot;</span>: &#123; <br>                    <span class="hljs-string">&quot;type&quot;</span>:     <span class="hljs-string">&quot;edge_ngram&quot;</span>,<br>                    <span class="hljs-string">&quot;min_gram&quot;</span>: <span class="hljs-number">1</span>,<br>                    <span class="hljs-string">&quot;max_gram&quot;</span>: <span class="hljs-number">20</span><br>                &#125;<br>            &#125;,<br>            <span class="hljs-string">&quot;analyzer&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;autocomplete&quot;</span>: &#123;<br>                    <span class="hljs-string">&quot;type&quot;</span>:      <span class="hljs-string">&quot;custom&quot;</span>,<br>                    <span class="hljs-string">&quot;tokenizer&quot;</span>: <span class="hljs-string">&quot;standard&quot;</span>,<br>                    <span class="hljs-string">&quot;filter&quot;</span>: [<br>                        <span class="hljs-string">&quot;lowercase&quot;</span>,<br>                        <span class="hljs-string">&quot;autocomplete_filter&quot;</span> <br>                    ]<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>再进行搜索，就不需要再根据前缀来扫描整个倒排索引，只需要去根据前缀到倒排索引中匹配即可。</p>
<p>注意：ngram拆分只需要在建立倒排索引时进行，搜索时不需要进行。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/my_index/</span>_analyze<br>&#123;<br>  <span class="hljs-string">&quot;analyzer&quot;</span>: <span class="hljs-string">&quot;autocomplete&quot;</span>,<br>  <span class="hljs-string">&quot;text&quot;</span>: <span class="hljs-string">&quot;quick brown&quot;</span><br>&#125;<br><br>PUT <span class="hljs-regexp">/my_index/</span>_mapping/my_type<br>&#123;<br>  <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;title&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;type&quot;</span>:     <span class="hljs-string">&quot;string&quot;</span>,<br>          <span class="hljs-string">&quot;analyzer&quot;</span>: <span class="hljs-string">&quot;autocomplete&quot;</span>,<br>          <span class="hljs-string">&quot;search_analyzer&quot;</span>: <span class="hljs-string">&quot;standard&quot;</span><br>      &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>搜索时，如果用match，只有hello的也会出来，全文检索，只是分数比较低。<br>推荐使用match_phrase，要求每个term都有，而且position刚好靠着1位，符合我们的期望的。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/my_index/my</span>_type/_search <br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;match_phrase&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;hello w&quot;</span><br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="fuzzy模糊搜索技术"><a href="#fuzzy模糊搜索技术" class="headerlink" title="fuzzy模糊搜索技术"></a>fuzzy模糊搜索技术</h4><p>fuzzy搜索技术会自动将拼写错误的搜索文本，进行纠正，纠正以后去尝试匹配索引中的数据。</p>
<p>测试数据</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs awk">POST <span class="hljs-regexp">/my_index/my</span>_type/_bulk<br>&#123; <span class="hljs-string">&quot;index&quot;</span>: &#123; <span class="hljs-string">&quot;_id&quot;</span>: <span class="hljs-number">1</span> &#125;&#125;<br>&#123; <span class="hljs-string">&quot;text&quot;</span>: <span class="hljs-string">&quot;Surprise me!&quot;</span>&#125;<br>&#123; <span class="hljs-string">&quot;index&quot;</span>: &#123; <span class="hljs-string">&quot;_id&quot;</span>: <span class="hljs-number">2</span> &#125;&#125;<br>&#123; <span class="hljs-string">&quot;text&quot;</span>: <span class="hljs-string">&quot;That was surprising.&quot;</span>&#125;<br>&#123; <span class="hljs-string">&quot;index&quot;</span>: &#123; <span class="hljs-string">&quot;_id&quot;</span>: <span class="hljs-number">3</span> &#125;&#125;<br>&#123; <span class="hljs-string">&quot;text&quot;</span>: <span class="hljs-string">&quot;I wasn&#x27;t surprised.&quot;</span>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/my_index/my</span>_type/_search <br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;fuzzy&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;text&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-string">&quot;surprize&quot;</span>,<br>        <span class="hljs-string">&quot;fuzziness&quot;</span>: <span class="hljs-number">2</span><br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>出现的问题：按理说surprize –&gt; surprising 在fuzziness为5时就可以匹配上，但实际过程中，尽管设置到了20也没法匹配。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/my_index/my</span>_type/_search <br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;text&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;query&quot;</span>: <span class="hljs-string">&quot;SURPIZE ME&quot;</span>,<br>        <span class="hljs-string">&quot;fuzziness&quot;</span>: <span class="hljs-string">&quot;AUTO&quot;</span>,<br>        <span class="hljs-string">&quot;operator&quot;</span>: <span class="hljs-string">&quot;and&quot;</span><br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="completion-suggest实现搜索提示"><a href="#completion-suggest实现搜索提示" class="headerlink" title="completion suggest实现搜索提示"></a>completion suggest实现搜索提示</h4><p>completion是指在进行搜索时，不需要输入全部文本，搜索引擎会自动提示想要搜索的文本。es对于completion的实现是非常高性能的，底层结构是用于进行前缀搜索的一种特殊的数据结构，而且会全部放在内存中，所以auto completion进行的前缀搜索提示，性能是非常高的。</p>
<p>建立结构</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs ada">PUT /news_website<br>&#123;<br>  <span class="hljs-string">&quot;mappings&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;news&quot;</span> : &#123;<br>      <span class="hljs-string">&quot;properties&quot;</span> : &#123;<br>        <span class="hljs-string">&quot;title&quot;</span> : &#123;<br>          <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span>,<br>          <span class="hljs-string">&quot;analyzer&quot;</span>: <span class="hljs-string">&quot;ik_max_word&quot;</span>,<br>          <span class="hljs-string">&quot;fields&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;suggest&quot;</span> : &#123;<br>              <span class="hljs-string">&quot;type&quot;</span> : &quot;<span class="hljs-type">completion</span><span class="hljs-string">&quot;,</span><br><span class="hljs-string">              &quot;</span>analyzer<span class="hljs-string">&quot;: &quot;</span>ik_max_word<span class="hljs-string">&quot;</span><br><span class="hljs-string">            &#125;</span><br><span class="hljs-string">          &#125;</span><br><span class="hljs-string">        &#125;,</span><br><span class="hljs-string">        &quot;</span>content<span class="hljs-string">&quot;: &#123;</span><br><span class="hljs-string">          &quot;</span><span class="hljs-keyword">type</span><span class="hljs-string">&quot;: &quot;</span>text<span class="hljs-string">&quot;,</span><br><span class="hljs-string">          &quot;</span>analyzer<span class="hljs-string">&quot;: &quot;</span>ik_max_word<span class="hljs-string">&quot;</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string">      &#125;</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string">  &#125;</span><br><span class="hljs-string">&#125;</span><br></code></pre></td></tr></table></figure>

<p>数据</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs awk">PUT <span class="hljs-regexp">/news_website/</span>news/<span class="hljs-number">1</span><br>&#123;<br>  <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;大话西游电影&quot;</span>,<br>  <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;大话西游的电影时隔20年即将在2017年4月重映&quot;</span><br>&#125;<br>PUT <span class="hljs-regexp">/news_website/</span>news/<span class="hljs-number">2</span><br>&#123;<br>  <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;大话西游小说&quot;</span>,<br>  <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;某知名网络小说作家已经完成了大话西游同名小说的出版&quot;</span><br>&#125;<br>PUT <span class="hljs-regexp">/news_website/</span>news/<span class="hljs-number">3</span><br>&#123;<br>  <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;大话西游手游&quot;</span>,<br>  <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;网易游戏近日出品了大话西游经典IP的手游，正在火爆内测中&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>查询</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs ada">GET /news_website/news/_search<br>&#123;<br>  <span class="hljs-string">&quot;suggest&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;my-suggest&quot;</span> : &#123;<br>      <span class="hljs-string">&quot;prefix&quot;</span> : &quot;大话西游&quot;,<br>      <span class="hljs-string">&quot;completion&quot;</span> : &#123;<br>        <span class="hljs-string">&quot;field&quot;</span> : &quot;<span class="hljs-type">title.suggest</span><span class="hljs-string">&quot;</span><br><span class="hljs-string">      &#125;</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string">  &#125;</span><br><span class="hljs-string">&#125;</span><br></code></pre></td></tr></table></figure>

<h3 id><a href="#" class="headerlink" title></a></h3><h4 id="search-template搜索模版"><a href="#search-template搜索模版" class="headerlink" title="search template搜索模版"></a>search template搜索模版</h4><p>搜索模板，search template高级功能，可以将一些搜索进行模板化，如果需要执行这个搜索，就直接调用模板，然后传入一些参数就可以了。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/blog_website/</span>blogs<span class="hljs-regexp">/_search/</span>template<br>&#123;<br>  <span class="hljs-string">&quot;inline&quot;</span> : &#123;<br>    <span class="hljs-string">&quot;query&quot;</span>: &#123; <br>      <span class="hljs-string">&quot;match&quot;</span> : &#123; <br>        <span class="hljs-string">&quot;&#123;&#123;field&#125;&#125;&quot;</span> : <span class="hljs-string">&quot;&#123;&#123;value&#125;&#125;&quot;</span> <br>      &#125; <br>    &#125;<br>  &#125;,<br>  <span class="hljs-string">&quot;params&quot;</span> : &#123;<br>      <span class="hljs-string">&quot;field&quot;</span> : <span class="hljs-string">&quot;title&quot;</span>,<br>      <span class="hljs-string">&quot;value&quot;</span> : <span class="hljs-string">&quot;博客&quot;</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>toJson</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/blog_website/</span>blogs<span class="hljs-regexp">/_search/</span>template<br>&#123;<br>  <span class="hljs-string">&quot;inline&quot;</span>: <span class="hljs-string">&quot;&#123;\&quot;query\&quot;: &#123;\&quot;match\&quot;: &#123;&#123;#toJson&#125;&#125;matchCondition&#123;&#123;/toJson&#125;&#125;&#125;&#125;&quot;</span>,<br>  <span class="hljs-string">&quot;params&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;matchCondition&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;博客&quot;</span><br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>join</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/blog_website/</span>blogs<span class="hljs-regexp">/_search/</span>template<br>&#123;<br>  <span class="hljs-string">&quot;inline&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;&#123;&#123;#join delimiter=&#x27; &#x27;&#125;&#125;titles&#123;&#123;/join delimiter=&#x27; &#x27;&#125;&#125;&quot;</span><br>      &#125;<br>    &#125;<br>  &#125;,<br>  <span class="hljs-string">&quot;params&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;titles&quot;</span>: [<span class="hljs-string">&quot;博客&quot;</span>, <span class="hljs-string">&quot;网站&quot;</span>]<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>default value</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/blog_website/</span>blogs<span class="hljs-regexp">/_search/</span>template<br>&#123;<br>  <span class="hljs-string">&quot;inline&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;range&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;views&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;gte&quot;</span>: <span class="hljs-string">&quot;&#123;&#123;start&#125;&#125;&quot;</span>,<br>          <span class="hljs-string">&quot;lte&quot;</span>: <span class="hljs-string">&quot;&#123;&#123;end&#125;&#125;&#123;&#123;^end&#125;&#125;20&#123;&#123;/end&#125;&#125;&quot;</span><br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;,<br>  <span class="hljs-string">&quot;params&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;start&quot;</span>: <span class="hljs-number">1</span>,<br>    <span class="hljs-string">&quot;end&quot;</span>: <span class="hljs-number">10</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>conditional</p>
<p>需要现在es的config/scripts目录下，预先保存这个复杂的模板，后缀名是.mustache，文件名是conditonal，内容为：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs clojure">&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;bool&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;must&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;line&quot;</span>: <span class="hljs-string">&quot;&#123;&#123;text&#125;&#125;&quot;</span> <br>        &#125;<br>      &#125;,<br>      <span class="hljs-string">&quot;filter&quot;</span>: &#123;<br>        &#123;&#123;#line_no&#125;&#125; <br>          <span class="hljs-string">&quot;range&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;line_no&quot;</span>: &#123;<br>              &#123;&#123;#start&#125;&#125; <br>                <span class="hljs-string">&quot;gte&quot;</span>: <span class="hljs-string">&quot;&#123;&#123;start&#125;&#125;&quot;</span> <br>                &#123;&#123;#end&#125;&#125;,&#123;&#123;/end&#125;&#125; <br>              &#123;&#123;/start&#125;&#125; <br>              &#123;&#123;#end&#125;&#125; <br>                <span class="hljs-string">&quot;lte&quot;</span>: <span class="hljs-string">&quot;&#123;&#123;end&#125;&#125;&quot;</span> <br>              &#123;&#123;/end&#125;&#125; <br>            &#125;<br>          &#125;<br>        &#123;&#123;/line_no&#125;&#125; <br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>查询时：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs gradle">GET <span class="hljs-regexp">/my_index/my</span>_type<span class="hljs-regexp">/_search/</span>template<br>&#123;<br>  <span class="hljs-string">&quot;file&quot;</span>: <span class="hljs-string">&quot;conditional&quot;</span>,<br>  <span class="hljs-string">&quot;params&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;text&quot;</span>: <span class="hljs-string">&quot;博客&quot;</span>,<br>    <span class="hljs-string">&quot;line_no&quot;</span>: <span class="hljs-keyword">true</span>,<br>    <span class="hljs-string">&quot;start&quot;</span>: <span class="hljs-number">1</span>,<br>    <span class="hljs-string">&quot;end&quot;</span>: <span class="hljs-number">10</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="geo-point地址位置搜索"><a href="#geo-point地址位置搜索" class="headerlink" title="geo_point地址位置搜索"></a>geo_point地址位置搜索</h4><p>geo_point就是地理位置的数据类型，其中包含了经纬度信息。</p>
<p>建立geo_point类型的mapping</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs gams"><span class="hljs-keyword">PUT</span> /my_index <br>&#123;<br>  <span class="hljs-string">&quot;mappings&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;my_type&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;location&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;geo_point&quot;</span><br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>写入geo_point的3种方法</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs awk">PUT my_index<span class="hljs-regexp">/my_type/</span><span class="hljs-number">1</span><br>&#123;<br>  <span class="hljs-string">&quot;text&quot;</span>: <span class="hljs-string">&quot;Geo-point as an object&quot;</span>,<br>  <span class="hljs-string">&quot;location&quot;</span>: &#123; <br>    <span class="hljs-string">&quot;lat&quot;</span>: <span class="hljs-number">41.12</span>,<br>    <span class="hljs-string">&quot;lon&quot;</span>: -<span class="hljs-number">71.34</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>latitude：维度<br>longitude：经度</p>
<p>不建议用下面两种语法</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs awk">PUT my_index<span class="hljs-regexp">/my_type/</span><span class="hljs-number">2</span><br>&#123;<br>  <span class="hljs-string">&quot;text&quot;</span>: <span class="hljs-string">&quot;Geo-point as a string&quot;</span>,<br>  <span class="hljs-string">&quot;location&quot;</span>: <span class="hljs-string">&quot;41.12,-71.34&quot;</span> <br>&#125;<br><br>PUT my_index<span class="hljs-regexp">/my_type/</span><span class="hljs-number">4</span><br>&#123;<br>  <span class="hljs-string">&quot;text&quot;</span>: <span class="hljs-string">&quot;Geo-point as an array&quot;</span>,<br>  <span class="hljs-string">&quot;location&quot;</span>: [ -<span class="hljs-number">71.34</span>, <span class="hljs-number">41.12</span> ] <br>&#125;<br></code></pre></td></tr></table></figure>

<p>根据地理位置进行查询</p>
<p>查询某个矩形的地理位置范围内的坐标点</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/my_index/my</span>_type/_search <br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;geo_bounding_box&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;location&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;top_left&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;lat&quot;</span>: <span class="hljs-number">42</span>,<br>          <span class="hljs-string">&quot;lon&quot;</span>: -<span class="hljs-number">72</span><br>        &#125;,<br>        <span class="hljs-string">&quot;bottom_right&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;lat&quot;</span>: <span class="hljs-number">40</span>,<br>          <span class="hljs-string">&quot;lon&quot;</span>: -<span class="hljs-number">74</span><br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>返回结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;took&quot;</span>: <span class="hljs-number">81</span>,<br>  <span class="hljs-attr">&quot;timed_out&quot;</span>: <span class="hljs-literal">false</span>,<br>  <span class="hljs-attr">&quot;_shards&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">5</span>,<br>    <span class="hljs-attr">&quot;successful&quot;</span>: <span class="hljs-number">5</span>,<br>    <span class="hljs-attr">&quot;failed&quot;</span>: <span class="hljs-number">0</span><br>  &#125;,<br>  <span class="hljs-attr">&quot;hits&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">1</span>,<br>    <span class="hljs-attr">&quot;max_score&quot;</span>: <span class="hljs-number">1</span>,<br>    <span class="hljs-attr">&quot;hits&quot;</span>: [<br>      &#123;<br>        <span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;my_index&quot;</span>,<br>        <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;my_type&quot;</span>,<br>        <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>,<br>        <span class="hljs-attr">&quot;_score&quot;</span>: <span class="hljs-number">1</span>,<br>        <span class="hljs-attr">&quot;_source&quot;</span>: &#123;<br>          <span class="hljs-attr">&quot;location&quot;</span>: &#123;<br>            <span class="hljs-attr">&quot;lat&quot;</span>: <span class="hljs-number">41.12</span>,<br>            <span class="hljs-attr">&quot;lon&quot;</span>: <span class="hljs-number">-71.34</span><br>          &#125;<br>        &#125;<br>      &#125;<br>    ]<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="搜索案例"><a href="#搜索案例" class="headerlink" title="搜索案例"></a>搜索案例</h5><p>搜索指定区域范围内的酒店，比如指定两个地点，要搜索在东方明珠大厦和上海路组成的矩阵的范围内，寻找想要的酒店</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs dts">PUT /hotel_app<br>&#123;<br>    <span class="hljs-string">&quot;mappings&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;hotels&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;pin&quot;</span>: &#123;<br>                    <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>                        <span class="hljs-string">&quot;location&quot;</span>: &#123;<br>                            <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;geo_point&quot;</span><br>                        &#125;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs ada">PUT /hotel_app/hotels/<span class="hljs-number">1</span><br>&#123;<br>    <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;喜来登大酒店&quot;</span>,<br>    <span class="hljs-string">&quot;pin&quot;</span> : &#123;<br>        <span class="hljs-string">&quot;location&quot;</span> : &#123;<br>            <span class="hljs-string">&quot;lat&quot;</span> : 40.12,<br>            <span class="hljs-string">&quot;lon&quot;</span> : -71.34<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>搜索示例：</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs ada">GET /hotel_app/hotels/_search<br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;bool&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;must&quot;</span>: [<br>        &#123;<br>          <span class="hljs-string">&quot;match_all&quot;</span>: &#123;&#125;<br>        &#125;<br>      ],<br>      <span class="hljs-string">&quot;filter&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;geo_bounding_box&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;pin.location&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;top_left&quot;</span> : &#123;<br>                <span class="hljs-string">&quot;lat&quot;</span> : 40.73,<br>                <span class="hljs-string">&quot;lon&quot;</span> : -74.1<br>            &#125;,<br>            <span class="hljs-string">&quot;bottom_right&quot;</span> : &#123;<br>                <span class="hljs-string">&quot;lat&quot;</span> : 40.01,<br>                <span class="hljs-string">&quot;lon&quot;</span> : -71.12<br>            &#125;<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>如果要搜索东方明珠大厦，上海路，上海博物馆，这三个地区组成的多边形的范围内的酒店</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/hotel_app/</span>hotels/_search <br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;bool&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;must&quot;</span>: [<br>        &#123;<br>          <span class="hljs-string">&quot;match_all&quot;</span>: &#123;&#125;<br>        &#125;<br>      ],<br>      <span class="hljs-string">&quot;filter&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;geo_polygon&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;pin.location&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;points&quot;</span>: [<br>              &#123;<span class="hljs-string">&quot;lat&quot;</span> : <span class="hljs-number">40.73</span>, <span class="hljs-string">&quot;lon&quot;</span> : -<span class="hljs-number">74.1</span>&#125;,<br>              &#123;<span class="hljs-string">&quot;lat&quot;</span> : <span class="hljs-number">40.01</span>, <span class="hljs-string">&quot;lon&quot;</span> : -<span class="hljs-number">71.12</span>&#125;,<br>              &#123;<span class="hljs-string">&quot;lat&quot;</span> : <span class="hljs-number">50.56</span>, <span class="hljs-string">&quot;lon&quot;</span> : -<span class="hljs-number">90.58</span>&#125;<br>            ]<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>搜索一定距离范围内的酒店</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/hotel_app/</span>hotels/_search<br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;bool&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;must&quot;</span>: [<br>        &#123;<br>          <span class="hljs-string">&quot;match_all&quot;</span>: &#123;&#125;<br>        &#125;<br>      ],<br>      <span class="hljs-string">&quot;filter&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;geo_distance&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;distance&quot;</span>: <span class="hljs-string">&quot;200km&quot;</span>,<br>          <span class="hljs-string">&quot;pin.location&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;lat&quot;</span>: <span class="hljs-number">40</span>,<br>            <span class="hljs-string">&quot;lon&quot;</span>: -<span class="hljs-number">70</span><br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="聚合分析-1"><a href="#聚合分析-1" class="headerlink" title="聚合分析"></a>聚合分析</h5><p>比如搜索距离0-100m、100m-300m、300m以上有多少数据</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/hotel_app/</span>hotels/_search<br>&#123;<br>  <span class="hljs-string">&quot;size&quot;</span>: <span class="hljs-number">0</span>,<br>  <span class="hljs-string">&quot;aggs&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;agg_by_distance_range&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;geo_distance&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;pin.location&quot;</span>,<br>        <span class="hljs-string">&quot;origin&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;lat&quot;</span>: <span class="hljs-number">40</span>,<br>          <span class="hljs-string">&quot;lon&quot;</span>: -<span class="hljs-number">70</span><br>        &#125;,<br>        <span class="hljs-string">&quot;unit&quot;</span>: <span class="hljs-string">&quot;mi&quot;</span>, <br>        <span class="hljs-string">&quot;ranges&quot;</span>: [<br>          &#123;<br>            <span class="hljs-string">&quot;to&quot;</span>: <span class="hljs-number">100</span><br>          &#125;,<br>          &#123;<br>            <span class="hljs-string">&quot;from&quot;</span>: <span class="hljs-number">100</span>,<br>            <span class="hljs-string">&quot;to&quot;</span>: <span class="hljs-number">300</span><br>          &#125;,<br>          &#123;<br>            <span class="hljs-string">&quot;from&quot;</span>: <span class="hljs-number">300</span><br>          &#125;<br>        ]<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>distance_type:</p>
<ul>
<li>sloppy_arc：默认</li>
<li>arc：比较精准但是速度慢</li>
<li>plane：速度比较快但是不精准</li>
</ul>
<h4 id="highlight高亮显示"><a href="#highlight高亮显示" class="headerlink" title="highlight高亮显示"></a>highlight高亮显示</h4><p>例子</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs dts">PUT /blog_website<br>&#123;<br>  <span class="hljs-string">&quot;mappings&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;blogs&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;title&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span>,<br>          <span class="hljs-string">&quot;analyzer&quot;</span>: <span class="hljs-string">&quot;ik_max_word&quot;</span><br>        &#125;,<br>        <span class="hljs-string">&quot;content&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span>,<br>          <span class="hljs-string">&quot;analyzer&quot;</span>: <span class="hljs-string">&quot;ik_max_word&quot;</span><br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk">PUT <span class="hljs-regexp">/blog_website/</span>blogs/<span class="hljs-number">1</span><br>&#123;<br>  <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;我的第一篇博客&quot;</span>,<br>  <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;大家好，这是我写的第一篇博客，特别喜欢这个博客网站！！！&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/blog_website/</span>blogs/_search <br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;博客&quot;</span><br>    &#125;<br>  &#125;,<br>  <span class="hljs-string">&quot;highlight&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;fields&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;title&quot;</span>: &#123;&#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>highlight中的field，必须跟query中的field一一对齐的</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;took&quot;</span>: <span class="hljs-number">103</span>,<br>  <span class="hljs-attr">&quot;timed_out&quot;</span>: <span class="hljs-literal">false</span>,<br>  <span class="hljs-attr">&quot;_shards&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">5</span>,<br>    <span class="hljs-attr">&quot;successful&quot;</span>: <span class="hljs-number">5</span>,<br>    <span class="hljs-attr">&quot;failed&quot;</span>: <span class="hljs-number">0</span><br>  &#125;,<br>  <span class="hljs-attr">&quot;hits&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">1</span>,<br>    <span class="hljs-attr">&quot;max_score&quot;</span>: <span class="hljs-number">0.28582606</span>,<br>    <span class="hljs-attr">&quot;hits&quot;</span>: [<br>      &#123;<br>        <span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;blog_website&quot;</span>,<br>        <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;blogs&quot;</span>,<br>        <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>,<br>        <span class="hljs-attr">&quot;_score&quot;</span>: <span class="hljs-number">0.28582606</span>,<br>        <span class="hljs-attr">&quot;_source&quot;</span>: &#123;<br>          <span class="hljs-attr">&quot;title&quot;</span>: <span class="hljs-string">&quot;我的第一篇博客&quot;</span>,<br>          <span class="hljs-attr">&quot;content&quot;</span>: <span class="hljs-string">&quot;大家好，这是我写的第一篇博客，特别喜欢这个博客网站！！！&quot;</span><br>        &#125;,<br>        <span class="hljs-attr">&quot;highlight&quot;</span>: &#123;<br>          <span class="hljs-attr">&quot;title&quot;</span>: [<br>            <span class="hljs-string">&quot;我的第一篇&lt;em&gt;博客&lt;/em&gt;&quot;</span><br>          ]<br>        &#125;<br>      &#125;<br>    ]<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>&lt;em&gt;&lt;/em&gt;中的内容会变成红色，如果指定的field中，包含搜索关键词的话，就会在field的文本中，对搜索词进行红色的高亮显示。</p>
<h5 id="三种highlight介绍"><a href="#三种highlight介绍" class="headerlink" title="三种highlight介绍"></a>三种highlight介绍</h5><p><strong>plain highlight</strong></p>
<p>底层使用lucene highlight，是默认的hihlight方式</p>
<p><strong>posting highlight</strong></p>
<p>通过设置index_options=offsets来使用，性能比plain highlight要高，因为不需要重新对高亮文本进行分词，对磁盘的消耗更少，可以将文本切割为句子，并且对句子进行高亮，效果更好。</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">DELETE <span class="hljs-string">/blog_website</span><br>PUT <span class="hljs-string">/blog_website</span><br>&#123;<br>  <span class="hljs-string">&quot;mappings&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;blogs&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;title&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span>,<br>          <span class="hljs-string">&quot;analyzer&quot;</span>: <span class="hljs-string">&quot;ik_max_word&quot;</span><br>        &#125;,<br>        <span class="hljs-string">&quot;content&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span>,<br>          <span class="hljs-string">&quot;analyzer&quot;</span>: <span class="hljs-string">&quot;ik_max_word&quot;</span>,<br>          <span class="hljs-string">&quot;index_options&quot;</span>: <span class="hljs-string">&quot;offsets&quot;</span><br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk">PUT <span class="hljs-regexp">/blog_website/</span>blogs/<span class="hljs-number">1</span><br>&#123;<br>  <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;我的第一篇博客&quot;</span>,<br>  <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;大家好，这是我写的第一篇博客，特别喜欢这个博客网站！！！&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/blog_website/</span>blogs/_search <br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;博客&quot;</span><br>    &#125;<br>  &#125;,<br>  <span class="hljs-string">&quot;highlight&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;fields&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;content&quot;</span>: &#123;&#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>fast vector highlight</strong></p>
<p>通过将index-time term vector设置在mapping中，就会用fast verctor highlight</p>
<p>对大field而言（大于1mb），性能更高</p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gauss"><span class="hljs-keyword">DELETE</span> /blog_website<br></code></pre></td></tr></table></figure>

<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs dts">PUT /blog_website<br>&#123;<br>  <span class="hljs-string">&quot;mappings&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;blogs&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;title&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span>,<br>          <span class="hljs-string">&quot;analyzer&quot;</span>: <span class="hljs-string">&quot;ik_max_word&quot;</span><br>        &#125;,<br>        <span class="hljs-string">&quot;content&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span>,<br>          <span class="hljs-string">&quot;analyzer&quot;</span>: <span class="hljs-string">&quot;ik_max_word&quot;</span>,<br>          <span class="hljs-string">&quot;term_vector&quot;</span> : <span class="hljs-string">&quot;with_positions_offsets&quot;</span><br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/blog_website/</span>blogs/_search <br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;博客&quot;</span><br>    &#125;<br>  &#125;,<br>  <span class="hljs-string">&quot;highlight&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;fields&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;content&quot;</span>: &#123;&#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>也可以强制使用某种highlighter，比如对于开启了term vector的field而言，可以强制使用plain highlight</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/blog_website/</span>blogs/_search <br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;博客&quot;</span><br>    &#125;<br>  &#125;,<br>  <span class="hljs-string">&quot;highlight&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;fields&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;content&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;plain&quot;</span><br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>总结一下，其实可以根据你的实际情况去考虑，一般情况下，用plain highlight也就足够了，不需要做其他额外的设置。如果对高亮的性能要求很高，可以尝试启用posting highlight。如果field的值特别大，超过了1M，那么可以用fast vector highlight。</p>
<h5 id="设置高亮html标签"><a href="#设置高亮html标签" class="headerlink" title="设置高亮html标签"></a>设置高亮html标签</h5><p>默认是&lt;em&gt;标签</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/blog_website/</span>blogs/_search <br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;博客&quot;</span><br>    &#125;<br>  &#125;,<br>  <span class="hljs-string">&quot;highlight&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;pre_tags&quot;</span>: [<span class="hljs-string">&quot;&lt;tag1&gt;&quot;</span>],<br>    <span class="hljs-string">&quot;post_tags&quot;</span>: [<span class="hljs-string">&quot;&lt;/tag2&gt;&quot;</span>], <br>    <span class="hljs-string">&quot;fields&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;content&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;plain&quot;</span><br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="高亮片段fragment的设置"><a href="#高亮片段fragment的设置" class="headerlink" title="高亮片段fragment的设置"></a>高亮片段fragment的设置</h5><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs ada">GET /_search<br>&#123;<br>    <span class="hljs-string">&quot;query&quot;</span> : &#123;<br>        <span class="hljs-string">&quot;match&quot;</span>: &#123; <span class="hljs-string">&quot;user&quot;</span>: <span class="hljs-string">&quot;kimchy&quot;</span> &#125;<br>    &#125;,<br>    <span class="hljs-string">&quot;highlight&quot;</span> : &#123;<br>        <span class="hljs-string">&quot;fields&quot;</span> : &#123;<br>            <span class="hljs-string">&quot;content&quot;</span> : &#123;&quot;<span class="hljs-type">fragment_size</span><span class="hljs-string">&quot; : 150, &quot;</span>number_of_fragments<span class="hljs-string">&quot; : 3, &quot;</span>no_match_size<span class="hljs-string">&quot;: 150 &#125;</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string">&#125;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>fragment_size: 设置要显示出来的包含关键字fragment的长度，默认是100。如果超过长度且关键词匹配了多个，会根据fragment对内容进行拆分。</li>
<li>number_of_fragments：如果高亮的fragment文本片段有多个片段，可以指定就显示几个片段</li>
</ul>
<h4 id="scoll"><a href="#scoll" class="headerlink" title="scoll"></a>scoll</h4><p>如果一次性要查出来比如10万条数据，那么性能会很差，此时一般会采取用scoll滚动查询，一批一批的查，直到所有数据都查询完处理完</p>
<p>使用scoll滚动搜索，可以先搜索一批数据，然后下次再搜索一批数据，以此类推，直到搜索出全部的数据来<br>scoll搜索会在第一次搜索的时候，保存一个当时的视图快照，之后只会基于该旧的视图快照提供数据搜索，如果这个期间数据变更，是不会让用户看到的<br>采用基于_doc进行排序的方式，性能较高<br>每次发送scroll请求，我们还需要指定一个scoll参数，指定一个时间窗口，每次搜索请求只要在这个时间窗口内能完成就可以了</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-builtin-name">GET</span> /test_index/test_type/_search?<span class="hljs-attribute">scroll</span>=1m<br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;match_all&quot;</span>: &#123;&#125;<br>  &#125;,<br>  <span class="hljs-string">&quot;sort&quot;</span>: [ <span class="hljs-string">&quot;_doc&quot;</span> ],<br>  <span class="hljs-string">&quot;size&quot;</span>: 3<br>&#125;<br><br>&#123;<br>  <span class="hljs-string">&quot;_scroll_id&quot;</span>: <span class="hljs-string">&quot;DnF1ZXJ5VGhlbkZldGNoBQAAAAAAACxeFjRvbnNUWVZaVGpHdklqOV9zcFd6MncAAAAAAAAsYBY0b25zVFlWWlRqR3ZJajlfc3BXejJ3AAAAAAAALF8WNG9uc1RZVlpUakd2SWo5X3NwV3oydwAAAAAAACxhFjRvbnNUWVZaVGpHdklqOV9zcFd6MncAAAAAAAAsYhY0b25zVFlWWlRqR3ZJajlfc3BXejJ3&quot;</span>,<br>  <span class="hljs-string">&quot;took&quot;</span>: 5,<br>  <span class="hljs-string">&quot;timed_out&quot;</span>: <span class="hljs-literal">false</span>,<br>  <span class="hljs-string">&quot;_shards&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;total&quot;</span>: 5,<br>    <span class="hljs-string">&quot;successful&quot;</span>: 5,<br>    <span class="hljs-string">&quot;failed&quot;</span>: 0<br>  &#125;,<br>  <span class="hljs-string">&quot;hits&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;total&quot;</span>: 10,<br>    <span class="hljs-string">&quot;max_score&quot;</span>: <span class="hljs-literal">null</span>,<br>    <span class="hljs-string">&quot;hits&quot;</span>: [<br>      &#123;<br>        <span class="hljs-string">&quot;_index&quot;</span>: <span class="hljs-string">&quot;test_index&quot;</span>,<br>        <span class="hljs-string">&quot;_type&quot;</span>: <span class="hljs-string">&quot;test_type&quot;</span>,<br>        <span class="hljs-string">&quot;_id&quot;</span>: <span class="hljs-string">&quot;8&quot;</span>,<br>        <span class="hljs-string">&quot;_score&quot;</span>: <span class="hljs-literal">null</span>,<br>        <span class="hljs-string">&quot;_source&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;test_field&quot;</span>: <span class="hljs-string">&quot;test client 2&quot;</span><br>        &#125;,<br>        <span class="hljs-string">&quot;sort&quot;</span>: [<br>          0<br>        ]<br>      &#125;,<br>      &#123;<br>        <span class="hljs-string">&quot;_index&quot;</span>: <span class="hljs-string">&quot;test_index&quot;</span>,<br>        <span class="hljs-string">&quot;_type&quot;</span>: <span class="hljs-string">&quot;test_type&quot;</span>,<br>        <span class="hljs-string">&quot;_id&quot;</span>: <span class="hljs-string">&quot;6&quot;</span>,<br>        <span class="hljs-string">&quot;_score&quot;</span>: <span class="hljs-literal">null</span>,<br>        <span class="hljs-string">&quot;_source&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;test_field&quot;</span>: <span class="hljs-string">&quot;tes test&quot;</span><br>        &#125;,<br>        <span class="hljs-string">&quot;sort&quot;</span>: [<br>          0<br>        ]<br>      &#125;,<br>      &#123;<br>        <span class="hljs-string">&quot;_index&quot;</span>: <span class="hljs-string">&quot;test_index&quot;</span>,<br>        <span class="hljs-string">&quot;_type&quot;</span>: <span class="hljs-string">&quot;test_type&quot;</span>,<br>        <span class="hljs-string">&quot;_id&quot;</span>: <span class="hljs-string">&quot;AVp4RN0bhjxldOOnBxaE&quot;</span>,<br>        <span class="hljs-string">&quot;_score&quot;</span>: <span class="hljs-literal">null</span>,<br>        <span class="hljs-string">&quot;_source&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;test_content&quot;</span>: <span class="hljs-string">&quot;my test&quot;</span><br>        &#125;,<br>        <span class="hljs-string">&quot;sort&quot;</span>: [<br>          0<br>        ]<br>      &#125;<br>    ]<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>获得的结果会有一个scoll_id，下一次再发送scoll请求的时候，必须带上这个scoll_id</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/_search/</span>scroll<br>&#123;<br>    <span class="hljs-string">&quot;scroll&quot;</span>: <span class="hljs-string">&quot;1m&quot;</span>, <br>    <span class="hljs-string">&quot;scroll_id&quot;</span> : <span class="hljs-string">&quot;DnF1ZXJ5VGhlbkZldGNoBQAAAAAAACxeFjRvbnNUWVZaVGpHdklqOV9zcFd6MncAAAAAAAAsYBY0b25zVFlWWlRqR3ZJajlfc3BXejJ3AAAAAAAALF8WNG9uc1RZVlpUakd2SWo5X3NwV3oydwAAAAAAACxhFjRvbnNUWVZaVGpHdklqOV9zcFd6MncAAAAAAAAsYhY0b25zVFlWWlRqR3ZJajlfc3BXejJ3&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>11,4,7<br>3,2,1<br>20</p>
<p>scoll，看起来挺像分页的，但是其实使用场景不一样。分页主要是用来一页一页搜索，给用户看的；scoll主要是用来一批一批检索数据，让系统进行处理的</p>
<h4 id="搜索相关参数"><a href="#搜索相关参数" class="headerlink" title="搜索相关参数"></a>搜索相关参数</h4><ul>
<li><p>preference：决定了哪些shard会被用来执行搜索操作。</p>
<p><code>_primary, _primary_first, _local, _only_node:xyz, _prefer_node:xyz, _shards:2,3</code></p>
<p>bouncing results问题，两个document排序，field值相同；不同的shard上，可能排序不同；每次请求轮询打到不同的replica shard上；每次页面上看到的搜索结果的排序都不一样。这就是bouncing result，也就是跳跃的结果。</p>
<p>搜索的时候，是轮询将搜索请求发送到每一个replica shard（primary shard），但是在不同的shard上，可能document的排序不同</p>
<p>解决方案就是将preference设置为一个字符串，比如说user_id，让每个user每次搜索的时候，都使用同一个replica shard去执行，就不会看到bouncing results了</p>
</li>
<li><p>timeout：限定在一定时间内，将部分获取到的数据直接返回，避免查询耗时过长</p>
</li>
<li><p>routing：document文档路由，_id路由，routing=user_id，这样的话可以让同一个user对应的数据到一个shard上去</p>
</li>
<li><p>search_type：</p>
<ul>
<li>default：query_then_fetch</li>
<li>dfs_query_then_fetch，可以提升revelance sort精准度</li>
</ul>
</li>
</ul>
<h4 id="文件搜索"><a href="#文件搜索" class="headerlink" title="文件搜索"></a>文件搜索</h4><p>1、文件系统数据构造</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs dts">PUT /fs<br>&#123;<br>  <span class="hljs-string">&quot;settings&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;analysis&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;analyzer&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;paths&quot;</span>: &#123; <br>          <span class="hljs-string">&quot;tokenizer&quot;</span>: <span class="hljs-string">&quot;path_hierarchy&quot;</span><br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>path_hierarchy tokenizer会按照文件系统格式进行分词，如/a/b/c/d-&gt; /a/b/c/d, /a/b/c, /a/b, /a。</p>
<p>设置index结构</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs gradle">PUT <span class="hljs-regexp">/fs/</span>_mapping/<span class="hljs-keyword">file</span><br>&#123;<br>  <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;name&quot;</span>: &#123; <br>      <span class="hljs-string">&quot;type&quot;</span>:  <span class="hljs-string">&quot;keyword&quot;</span><br>    &#125;,<br>    <span class="hljs-string">&quot;path&quot;</span>: &#123; <br>      <span class="hljs-string">&quot;type&quot;</span>:  <span class="hljs-string">&quot;keyword&quot;</span>,<br>      <span class="hljs-string">&quot;fields&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;tree&quot;</span>: &#123; <br>          <span class="hljs-string">&quot;type&quot;</span>:     <span class="hljs-string">&quot;text&quot;</span>,<br>          <span class="hljs-string">&quot;analyzer&quot;</span>: <span class="hljs-string">&quot;paths&quot;</span><br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>放入数据</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs gradle">PUT <span class="hljs-regexp">/fs/</span><span class="hljs-keyword">file</span>/<span class="hljs-number">1</span><br>&#123;<br>  <span class="hljs-string">&quot;name&quot;</span>:     <span class="hljs-string">&quot;README.txt&quot;</span>, <br>  <span class="hljs-string">&quot;path&quot;</span>:     <span class="hljs-string">&quot;/workspace/projects/helloworld&quot;</span>, <br>  <span class="hljs-string">&quot;contents&quot;</span>: <span class="hljs-string">&quot;这是我的第一个elasticsearch程序&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>对文件系统执行搜索</p>
<p>文件搜索需求：查找一份，内容包括elasticsearch，在/workspace/projects/hellworld这个目录下的文件</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs gradle">GET <span class="hljs-regexp">/fs/</span><span class="hljs-keyword">file</span>/_search <br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;bool&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;must&quot;</span>: [<br>        &#123;<br>          <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;contents&quot;</span>: <span class="hljs-string">&quot;elasticsearch&quot;</span><br>          &#125;<br>        &#125;,<br>        &#123;<br>          <span class="hljs-string">&quot;constant_score&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;filter&quot;</span>: &#123;<br>              <span class="hljs-string">&quot;term&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;path&quot;</span>: <span class="hljs-string">&quot;/workspace/projects/helloworld&quot;</span><br>              &#125;<br>            &#125;<br>          &#125;<br>        &#125;<br>      ]<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>返回结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;took&quot;</span>: <span class="hljs-number">2</span>,<br>  <span class="hljs-attr">&quot;timed_out&quot;</span>: <span class="hljs-literal">false</span>,<br>  <span class="hljs-attr">&quot;_shards&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">5</span>,<br>    <span class="hljs-attr">&quot;successful&quot;</span>: <span class="hljs-number">5</span>,<br>    <span class="hljs-attr">&quot;failed&quot;</span>: <span class="hljs-number">0</span><br>  &#125;,<br>  <span class="hljs-attr">&quot;hits&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">1</span>,<br>    <span class="hljs-attr">&quot;max_score&quot;</span>: <span class="hljs-number">1.284885</span>,<br>    <span class="hljs-attr">&quot;hits&quot;</span>: [<br>      &#123;<br>        <span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;fs&quot;</span>,<br>        <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;file&quot;</span>,<br>        <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>,<br>        <span class="hljs-attr">&quot;_score&quot;</span>: <span class="hljs-number">1.284885</span>,<br>        <span class="hljs-attr">&quot;_source&quot;</span>: &#123;<br>          <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;README.txt&quot;</span>,<br>          <span class="hljs-attr">&quot;path&quot;</span>: <span class="hljs-string">&quot;/workspace/projects/helloworld&quot;</span>,<br>          <span class="hljs-attr">&quot;contents&quot;</span>: <span class="hljs-string">&quot;这是我的第一个elasticsearch程序&quot;</span><br>        &#125;<br>      &#125;<br>    ]<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>搜索需求2：搜索/workspace目录下，内容包含elasticsearch的所有的文件</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs gradle">GET <span class="hljs-regexp">/fs/</span><span class="hljs-keyword">file</span>/_search <br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;bool&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;must&quot;</span>: [<br>        &#123;<br>          <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;contents&quot;</span>: <span class="hljs-string">&quot;elasticsearch&quot;</span><br>          &#125;<br>        &#125;,<br>        &#123;<br>          <span class="hljs-string">&quot;constant_score&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;filter&quot;</span>: &#123;<br>              <span class="hljs-string">&quot;term&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;path.tree&quot;</span>: <span class="hljs-string">&quot;/workspace&quot;</span><br>              &#125;<br>            &#125;<br>          &#125;<br>        &#125;<br>      ]<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="nested-object"><a href="#nested-object" class="headerlink" title="nested object"></a>nested object</h4><p>测试数据</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs awk">PUT <span class="hljs-regexp">/website/</span>blogs/<span class="hljs-number">6</span><br>&#123;<br>  <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;花无缺发表的一篇帖子&quot;</span>,<br>  <span class="hljs-string">&quot;content&quot;</span>:  <span class="hljs-string">&quot;我是花无缺，大家要不要考虑一下投资房产和买股票的事情啊。。。&quot;</span>,<br>  <span class="hljs-string">&quot;tags&quot;</span>:  [ <span class="hljs-string">&quot;投资&quot;</span>, <span class="hljs-string">&quot;理财&quot;</span> ],<br>  <span class="hljs-string">&quot;comments&quot;</span>: [ <br>    &#123;<br>      <span class="hljs-string">&quot;name&quot;</span>:    <span class="hljs-string">&quot;小鱼儿&quot;</span>,<br>      <span class="hljs-string">&quot;comment&quot;</span>: <span class="hljs-string">&quot;什么股票啊？推荐一下呗&quot;</span>,<br>      <span class="hljs-string">&quot;age&quot;</span>:     <span class="hljs-number">28</span>,<br>      <span class="hljs-string">&quot;stars&quot;</span>:   <span class="hljs-number">4</span>,<br>      <span class="hljs-string">&quot;date&quot;</span>:    <span class="hljs-string">&quot;2016-09-01&quot;</span><br>    &#125;,<br>    &#123;<br>      <span class="hljs-string">&quot;name&quot;</span>:    <span class="hljs-string">&quot;黄药师&quot;</span>,<br>      <span class="hljs-string">&quot;comment&quot;</span>: <span class="hljs-string">&quot;我喜欢投资房产，风，险大收益也大&quot;</span>,<br>      <span class="hljs-string">&quot;age&quot;</span>:     <span class="hljs-number">31</span>,<br>      <span class="hljs-string">&quot;stars&quot;</span>:   <span class="hljs-number">5</span>,<br>      <span class="hljs-string">&quot;date&quot;</span>:    <span class="hljs-string">&quot;2016-10-22&quot;</span><br>    &#125;<br>  ]<br>&#125;<br></code></pre></td></tr></table></figure>

<p>比如现在需要搜索年龄是28岁，名字为黄药师评论过的博客</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/website/</span>blogs/_search<br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;bool&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;must&quot;</span>: [<br>        &#123; <span class="hljs-string">&quot;match&quot;</span>: &#123; <span class="hljs-string">&quot;comments.name&quot;</span>: <span class="hljs-string">&quot;黄药师&quot;</span> &#125;&#125;,<br>        &#123; <span class="hljs-string">&quot;match&quot;</span>: &#123; <span class="hljs-string">&quot;comments.age&quot;</span>:  <span class="hljs-number">28</span>      &#125;&#125; <br>      ]<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>返回结果</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;took&quot;</span>: <span class="hljs-number">102</span>,<br>  <span class="hljs-attr">&quot;timed_out&quot;</span>: <span class="hljs-literal">false</span>,<br>  <span class="hljs-attr">&quot;_shards&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">5</span>,<br>    <span class="hljs-attr">&quot;successful&quot;</span>: <span class="hljs-number">5</span>,<br>    <span class="hljs-attr">&quot;failed&quot;</span>: <span class="hljs-number">0</span><br>  &#125;,<br>  <span class="hljs-attr">&quot;hits&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">1</span>,<br>    <span class="hljs-attr">&quot;max_score&quot;</span>: <span class="hljs-number">1.8022683</span>,<br>    <span class="hljs-attr">&quot;hits&quot;</span>: [<br>      &#123;<br>        <span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;website&quot;</span>,<br>        <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;blogs&quot;</span>,<br>        <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;6&quot;</span>,<br>        <span class="hljs-attr">&quot;_score&quot;</span>: <span class="hljs-number">1.8022683</span>,<br>        <span class="hljs-attr">&quot;_source&quot;</span>: &#123;<br>          <span class="hljs-attr">&quot;title&quot;</span>: <span class="hljs-string">&quot;花无缺发表的一篇帖子&quot;</span>,<br>          <span class="hljs-attr">&quot;content&quot;</span>: <span class="hljs-string">&quot;我是花无缺，大家要不要考虑一下投资房产和买股票的事情啊。。。&quot;</span>,<br>          <span class="hljs-attr">&quot;tags&quot;</span>: [<br>            <span class="hljs-string">&quot;投资&quot;</span>,<br>            <span class="hljs-string">&quot;理财&quot;</span><br>          ],<br>          <span class="hljs-attr">&quot;comments&quot;</span>: [<br>            &#123;<br>              <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;小鱼儿&quot;</span>,<br>              <span class="hljs-attr">&quot;comment&quot;</span>: <span class="hljs-string">&quot;什么股票啊？推荐一下呗&quot;</span>,<br>              <span class="hljs-attr">&quot;age&quot;</span>: <span class="hljs-number">28</span>,<br>              <span class="hljs-attr">&quot;stars&quot;</span>: <span class="hljs-number">4</span>,<br>              <span class="hljs-attr">&quot;date&quot;</span>: <span class="hljs-string">&quot;2016-09-01&quot;</span><br>            &#125;,<br>            &#123;<br>              <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;黄药师&quot;</span>,<br>              <span class="hljs-attr">&quot;comment&quot;</span>: <span class="hljs-string">&quot;我喜欢投资房产，风，险大收益也大&quot;</span>,<br>              <span class="hljs-attr">&quot;age&quot;</span>: <span class="hljs-number">31</span>,<br>              <span class="hljs-attr">&quot;stars&quot;</span>: <span class="hljs-number">5</span>,<br>              <span class="hljs-attr">&quot;date&quot;</span>: <span class="hljs-string">&quot;2016-10-22&quot;</span><br>            &#125;<br>          ]<br>        &#125;<br>      &#125;<br>    ]<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>原因分析：</p>
<p>object类型数据结构的底层存储，会将一个json数组中的数据，进行扁平化，所以直接命中了这个document，name=黄药师，age=28，正好符合。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;title&quot;</span>:            [ <span class="hljs-string">&quot;花无缺&quot;</span>, <span class="hljs-string">&quot;发表&quot;</span>, <span class="hljs-string">&quot;一篇&quot;</span>, <span class="hljs-string">&quot;帖子&quot;</span> ],<br>  <span class="hljs-attr">&quot;content&quot;</span>:             [ <span class="hljs-string">&quot;我&quot;</span>, <span class="hljs-string">&quot;是&quot;</span>, <span class="hljs-string">&quot;花无缺&quot;</span>, <span class="hljs-string">&quot;大家&quot;</span>, <span class="hljs-string">&quot;要不要&quot;</span>, <span class="hljs-string">&quot;考虑&quot;</span>, <span class="hljs-string">&quot;一下&quot;</span>, <span class="hljs-string">&quot;投资&quot;</span>, <span class="hljs-string">&quot;房产&quot;</span>, <span class="hljs-string">&quot;买&quot;</span>, <span class="hljs-string">&quot;股票&quot;</span>, <span class="hljs-string">&quot;事情&quot;</span> ],<br>  <span class="hljs-attr">&quot;tags&quot;</span>:             [ <span class="hljs-string">&quot;投资&quot;</span>, <span class="hljs-string">&quot;理财&quot;</span> ],<br>  <span class="hljs-attr">&quot;comments.name&quot;</span>:    [ <span class="hljs-string">&quot;小鱼儿&quot;</span>, <span class="hljs-string">&quot;黄药师&quot;</span> ],<br>  <span class="hljs-attr">&quot;comments.comment&quot;</span>: [ <span class="hljs-string">&quot;什么&quot;</span>, <span class="hljs-string">&quot;股票&quot;</span>, <span class="hljs-string">&quot;推荐&quot;</span>, <span class="hljs-string">&quot;我&quot;</span>, <span class="hljs-string">&quot;喜欢&quot;</span>, <span class="hljs-string">&quot;投资&quot;</span>, <span class="hljs-string">&quot;房产&quot;</span>, <span class="hljs-string">&quot;风险&quot;</span>, <span class="hljs-string">&quot;收益&quot;</span>, <span class="hljs-string">&quot;大&quot;</span> ],<br>  <span class="hljs-attr">&quot;comments.age&quot;</span>:     [ <span class="hljs-number">28</span>, <span class="hljs-number">31</span> ],<br>  <span class="hljs-attr">&quot;comments.stars&quot;</span>:   [ <span class="hljs-number">4</span>, <span class="hljs-number">5</span> ],<br>  <span class="hljs-attr">&quot;comments.date&quot;</span>:    [ <span class="hljs-number">2016</span><span class="hljs-number">-09</span><span class="hljs-number">-01</span>, <span class="hljs-number">2016</span><span class="hljs-number">-10</span><span class="hljs-number">-22</span> ]<br>&#125;<br></code></pre></td></tr></table></figure>

<p>引入nested object类型，来解决object类型底层数据结构导致的问题</p>
<p>修改mapping，将comments的类型从object设置为nested</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs dts">PUT /website<br>&#123;<br>  <span class="hljs-string">&quot;mappings&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;blogs&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;comments&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;nested&quot;</span>, <br>          <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;name&quot;</span>:    &#123; <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;string&quot;</span>  &#125;,<br>            <span class="hljs-string">&quot;comment&quot;</span>: &#123; <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;string&quot;</span>  &#125;,<br>            <span class="hljs-string">&quot;age&quot;</span>:     &#123; <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;short&quot;</span>   &#125;,<br>            <span class="hljs-string">&quot;stars&quot;</span>:   &#123; <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;short&quot;</span>   &#125;,<br>            <span class="hljs-string">&quot;date&quot;</span>:    &#123; <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;date&quot;</span>    &#125;<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这时底层结构会变为：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123; <br>  <span class="hljs-attr">&quot;comments.name&quot;</span>:    [ <span class="hljs-string">&quot;小鱼儿&quot;</span> ],<br>  <span class="hljs-attr">&quot;comments.comment&quot;</span>: [ <span class="hljs-string">&quot;什么&quot;</span>, <span class="hljs-string">&quot;股票&quot;</span>, <span class="hljs-string">&quot;推荐&quot;</span> ],<br>  <span class="hljs-attr">&quot;comments.age&quot;</span>:     [ <span class="hljs-number">28</span> ],<br>  <span class="hljs-attr">&quot;comments.stars&quot;</span>:   [ <span class="hljs-number">4</span> ],<br>  <span class="hljs-attr">&quot;comments.date&quot;</span>:    [ <span class="hljs-number">2014</span><span class="hljs-number">-09</span><span class="hljs-number">-01</span> ]<br>&#125;<br>&#123; <br>  <span class="hljs-attr">&quot;comments.name&quot;</span>:    [ <span class="hljs-string">&quot;黄药师&quot;</span> ],<br>  <span class="hljs-attr">&quot;comments.comment&quot;</span>: [ <span class="hljs-string">&quot;我&quot;</span>, <span class="hljs-string">&quot;喜欢&quot;</span>, <span class="hljs-string">&quot;投资&quot;</span>, <span class="hljs-string">&quot;房产&quot;</span>, <span class="hljs-string">&quot;风险&quot;</span>, <span class="hljs-string">&quot;收益&quot;</span>, <span class="hljs-string">&quot;大&quot;</span> ],<br>  <span class="hljs-attr">&quot;comments.age&quot;</span>:     [ <span class="hljs-number">31</span> ],<br>  <span class="hljs-attr">&quot;comments.stars&quot;</span>:   [ <span class="hljs-number">5</span> ],<br>  <span class="hljs-attr">&quot;comments.date&quot;</span>:    [ <span class="hljs-number">2014</span><span class="hljs-number">-10</span><span class="hljs-number">-22</span> ]<br>&#125;<br>&#123; <br>  <span class="hljs-attr">&quot;title&quot;</span>:            [ <span class="hljs-string">&quot;花无缺&quot;</span>, <span class="hljs-string">&quot;发表&quot;</span>, <span class="hljs-string">&quot;一篇&quot;</span>, <span class="hljs-string">&quot;帖子&quot;</span> ],<br>  <span class="hljs-attr">&quot;body&quot;</span>:             [ <span class="hljs-string">&quot;我&quot;</span>, <span class="hljs-string">&quot;是&quot;</span>, <span class="hljs-string">&quot;花无缺&quot;</span>, <span class="hljs-string">&quot;大家&quot;</span>, <span class="hljs-string">&quot;要不要&quot;</span>, <span class="hljs-string">&quot;考虑&quot;</span>, <span class="hljs-string">&quot;一下&quot;</span>, <span class="hljs-string">&quot;投资&quot;</span>, <span class="hljs-string">&quot;房产&quot;</span>, <span class="hljs-string">&quot;买&quot;</span>, <span class="hljs-string">&quot;股票&quot;</span>, <span class="hljs-string">&quot;事情&quot;</span> ],<br>  <span class="hljs-attr">&quot;tags&quot;</span>:             [ <span class="hljs-string">&quot;投资&quot;</span>, <span class="hljs-string">&quot;理财&quot;</span> ]<br>&#125;<br></code></pre></td></tr></table></figure>

<p>再次搜索</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/website/</span>blogs/_search <br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;bool&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;must&quot;</span>: [<br>        &#123;<br>          <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;花无缺&quot;</span><br>          &#125;<br>        &#125;,<br>        &#123;<br>          <span class="hljs-string">&quot;nested&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;path&quot;</span>: <span class="hljs-string">&quot;comments&quot;</span>,<br>            <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>              <span class="hljs-string">&quot;bool&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;must&quot;</span>: [<br>                  &#123;<br>                    <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>                      <span class="hljs-string">&quot;comments.name&quot;</span>: <span class="hljs-string">&quot;黄药师&quot;</span><br>                    &#125;<br>                  &#125;,<br>                  &#123;<br>                    <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>                      <span class="hljs-string">&quot;comments.age&quot;</span>: <span class="hljs-number">28</span><br>                    &#125;<br>                  &#125;<br>                ]<br>              &#125;<br>            &#125;<br>          &#125;<br>        &#125;<br>      ]<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>score_mode：max，min，avg，none，默认是avg</p>
<p>如果搜索命中了多个nested document，如何讲个多个nested document的分数合并为一个分数</p>
<h5 id="聚合分析-2"><a href="#聚合分析-2" class="headerlink" title="聚合分析"></a>聚合分析</h5><p>按照评论日期进行bucket划分，然后拿到每个月的评论的评分的平均值</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/website/</span>blogs/_search <br>&#123;<br>  <span class="hljs-string">&quot;size&quot;</span>: <span class="hljs-number">0</span>, <br>  <span class="hljs-string">&quot;aggs&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;comments_path&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;nested&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;path&quot;</span>: <span class="hljs-string">&quot;comments&quot;</span><br>      &#125;, <br>      <span class="hljs-string">&quot;aggs&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;group_by_comments_date&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;date_histogram&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;comments.date&quot;</span>,<br>            <span class="hljs-string">&quot;interval&quot;</span>: <span class="hljs-string">&quot;month&quot;</span>,<br>            <span class="hljs-string">&quot;format&quot;</span>: <span class="hljs-string">&quot;yyyy-MM&quot;</span><br>          &#125;,<br>          <span class="hljs-string">&quot;aggs&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;avg_stars&quot;</span>: &#123;<br>              <span class="hljs-string">&quot;avg&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;comments.stars&quot;</span><br>              &#125;<br>            &#125;<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>同时，在对nested object的属性进行下钻分析时，也可以使用外层的属性进行操作</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/website/</span>blogs/_search <br>&#123;<br>  <span class="hljs-string">&quot;size&quot;</span>: <span class="hljs-number">0</span>,<br>  <span class="hljs-string">&quot;aggs&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;comments_path&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;nested&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;path&quot;</span>: <span class="hljs-string">&quot;comments&quot;</span><br>      &#125;,<br>      <span class="hljs-string">&quot;aggs&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;group_by_comments_age&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;histogram&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;comments.age&quot;</span>,<br>            <span class="hljs-string">&quot;interval&quot;</span>: <span class="hljs-number">10</span><br>          &#125;,<br>          <span class="hljs-string">&quot;aggs&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;reverse_path&quot;</span>: &#123;<br>              <span class="hljs-string">&quot;reverse_nested&quot;</span>: &#123;&#125;, <br>              <span class="hljs-string">&quot;aggs&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;group_by_tags&quot;</span>: &#123;<br>                  <span class="hljs-string">&quot;terms&quot;</span>: &#123;<br>                    <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;tags.keyword&quot;</span><br>                  &#125;<br>                &#125;<br>              &#125;<br>            &#125;<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="parent-child建模方式"><a href="#parent-child建模方式" class="headerlink" title="parent child建模方式"></a>parent child建模方式</h4><p>nested object的建模，采取的是类似冗余数据的方式，将所有有关联的实体组合为一个整体存放，维护成本就比较高。</p>
<p>parent child建模方式，采取的是类似于关系型数据库的三范式类的建模，每个实体之间都通过一些关联方式，进行父子关系的关联，各种数据不需要整体存放，父doc和子doc分别在进行更新的时候，都不会影响对方，维护起来比较方便。</p>
<p>在进行搜索时，由es自动进行父子关系元数据映射，用于确保查询时候的高性能，但是有一个限制，就是父子数据必须存在于一个shard中。</p>
<p>多个type之间有父子关系，用_parent指定父type</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs dts">PUT /company<br>&#123;<br>  <span class="hljs-string">&quot;mappings&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;rd_center&quot;</span>: &#123;&#125;,<br>    <span class="hljs-string">&quot;employee&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;_parent&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;rd_center&quot;</span> <br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs awk">POST <span class="hljs-regexp">/company/</span>rd_center/_bulk<br>&#123; <span class="hljs-string">&quot;index&quot;</span>: &#123; <span class="hljs-string">&quot;_id&quot;</span>: <span class="hljs-string">&quot;1&quot;</span> &#125;&#125;<br>&#123; <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;北京研发总部&quot;</span>, <span class="hljs-string">&quot;city&quot;</span>: <span class="hljs-string">&quot;北京&quot;</span>, <span class="hljs-string">&quot;country&quot;</span>: <span class="hljs-string">&quot;中国&quot;</span> &#125;<br>&#123; <span class="hljs-string">&quot;index&quot;</span>: &#123; <span class="hljs-string">&quot;_id&quot;</span>: <span class="hljs-string">&quot;2&quot;</span> &#125;&#125;<br>&#123; <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;上海研发中心&quot;</span>, <span class="hljs-string">&quot;city&quot;</span>: <span class="hljs-string">&quot;上海&quot;</span>, <span class="hljs-string">&quot;country&quot;</span>: <span class="hljs-string">&quot;中国&quot;</span> &#125;<br>&#123; <span class="hljs-string">&quot;index&quot;</span>: &#123; <span class="hljs-string">&quot;_id&quot;</span>: <span class="hljs-string">&quot;3&quot;</span> &#125;&#125;<br>&#123; <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;硅谷人工智能实验室&quot;</span>, <span class="hljs-string">&quot;city&quot;</span>: <span class="hljs-string">&quot;硅谷&quot;</span>, <span class="hljs-string">&quot;country&quot;</span>: <span class="hljs-string">&quot;美国&quot;</span> &#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs awk">PUT <span class="hljs-regexp">/company/</span>employee/<span class="hljs-number">1</span>?parent=<span class="hljs-number">1</span> <br>&#123;<br>  <span class="hljs-string">&quot;name&quot;</span>:  <span class="hljs-string">&quot;张三&quot;</span>,<br>  <span class="hljs-string">&quot;birthday&quot;</span>:   <span class="hljs-string">&quot;1970-10-24&quot;</span>,<br>  <span class="hljs-string">&quot;hobby&quot;</span>: <span class="hljs-string">&quot;爬山&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>维护父子关系的核心，parent=1，指定了这个数据的父doc的id，此时，parent-child关系就已经建立了。</p>
<p>在进行shard路由的时候，默认会根据id进行路由，如果指定parent就会根据parent的id进行路由，确保父子数据存在一个shard中。</p>
<h5 id="搜索聚合"><a href="#搜索聚合" class="headerlink" title="搜索聚合"></a>搜索聚合</h5><p>搜索有1980年以后出生的员工的研发中心</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/company/</span>rd_center/_search<br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;has_child&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;employee&quot;</span>,<br>      <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;range&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;birthday&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;gte&quot;</span>: <span class="hljs-string">&quot;1980-01-01&quot;</span><br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>搜索有名叫张三的员工的研发中心</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/company/</span>rd_center/_search<br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;has_child&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;type&quot;</span>:<span class="hljs-string">&quot;employee&quot;</span>,<br>      <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;张三&quot;</span><br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>搜索有至少2个以上员工的研发中心</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/company/</span>rd_center/_search<br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;has_child&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;type&quot;</span>:<span class="hljs-string">&quot;employee&quot;</span>,<br>      <span class="hljs-string">&quot;min_children&quot;</span>: <span class="hljs-number">2</span>, <br>      <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;match_all&quot;</span>: &#123;&#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>搜索在中国的研发中心的员工</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/company/</span>employee/_search <br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;has_parent&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;parent_type&quot;</span>: <span class="hljs-string">&quot;rd_center&quot;</span>,<br>      <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;term&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;country.keyword&quot;</span>: <span class="hljs-string">&quot;中国&quot;</span><br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>统计每个国家的喜欢每种爱好的员工有多少个</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/company/</span>rd_center/_search <br>&#123;<br>  <span class="hljs-string">&quot;size&quot;</span>: <span class="hljs-number">0</span>,<br>  <span class="hljs-string">&quot;aggs&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;group_by_country&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;terms&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;country.keyword&quot;</span><br>      &#125;,<br>      <span class="hljs-string">&quot;aggs&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;group_by_child_employee&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;children&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;employee&quot;</span><br>          &#125;,<br>          <span class="hljs-string">&quot;aggs&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;group_by_hobby&quot;</span>: &#123;<br>              <span class="hljs-string">&quot;terms&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;hobby.keyword&quot;</span><br>              &#125;<br>            &#125;<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="多层建模"><a href="#多层建模" class="headerlink" title="多层建模"></a>多层建模</h5><p>country -&gt; rd_center -&gt; employee，三层数据模型</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs dts">PUT /company<br>&#123;<br>  <span class="hljs-string">&quot;mappings&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;country&quot;</span>: &#123;&#125;,<br>    <span class="hljs-string">&quot;rd_center&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;_parent&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;country&quot;</span> <br>      &#125;<br>    &#125;,<br>    <span class="hljs-string">&quot;employee&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;_parent&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;rd_center&quot;</span> <br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk">POST <span class="hljs-regexp">/company/</span>country/_bulk<br>&#123; <span class="hljs-string">&quot;index&quot;</span>: &#123; <span class="hljs-string">&quot;_id&quot;</span>: <span class="hljs-string">&quot;1&quot;</span> &#125;&#125;<br>&#123; <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;中国&quot;</span> &#125;<br>&#123; <span class="hljs-string">&quot;index&quot;</span>: &#123; <span class="hljs-string">&quot;_id&quot;</span>: <span class="hljs-string">&quot;2&quot;</span> &#125;&#125;<br>&#123; <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;美国&quot;</span> &#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs awk">POST <span class="hljs-regexp">/company/</span>rd_center/_bulk<br>&#123; <span class="hljs-string">&quot;index&quot;</span>: &#123; <span class="hljs-string">&quot;_id&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>, <span class="hljs-string">&quot;parent&quot;</span>: <span class="hljs-string">&quot;1&quot;</span> &#125;&#125;<br>&#123; <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;北京研发总部&quot;</span> &#125;<br>&#123; <span class="hljs-string">&quot;index&quot;</span>: &#123; <span class="hljs-string">&quot;_id&quot;</span>: <span class="hljs-string">&quot;2&quot;</span>, <span class="hljs-string">&quot;parent&quot;</span>: <span class="hljs-string">&quot;1&quot;</span> &#125;&#125;<br>&#123; <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;上海研发中心&quot;</span> &#125;<br>&#123; <span class="hljs-string">&quot;index&quot;</span>: &#123; <span class="hljs-string">&quot;_id&quot;</span>: <span class="hljs-string">&quot;3&quot;</span>, <span class="hljs-string">&quot;parent&quot;</span>: <span class="hljs-string">&quot;2&quot;</span> &#125;&#125;<br>&#123; <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;硅谷人工智能实验室&quot;</span> &#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs awk">PUT <span class="hljs-regexp">/company/</span>employee/<span class="hljs-number">1</span>?parent=<span class="hljs-number">1</span>&amp;routing=<span class="hljs-number">1</span><br>&#123;<br>  <span class="hljs-string">&quot;name&quot;</span>:  <span class="hljs-string">&quot;张三&quot;</span>,<br>  <span class="hljs-string">&quot;dob&quot;</span>:   <span class="hljs-string">&quot;1970-10-24&quot;</span>,<br>  <span class="hljs-string">&quot;hobby&quot;</span>: <span class="hljs-string">&quot;爬山&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>注意：在创建employee类型的数据时，必须指定routing为country的id，否则默认会根据parnet的id进行路由，导致三层数据不在一个shard上。</p>
<p>搜索有爬山爱好的员工所在的国家</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/company/</span>country/_search<br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;has_child&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;rd_center&quot;</span>,<br>      <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;has_child&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;employee&quot;</span>,<br>          <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>              <span class="hljs-string">&quot;hobby&quot;</span>: <span class="hljs-string">&quot;爬山&quot;</span><br>            &#125;<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="并发控制"><a href="#并发控制" class="headerlink" title="并发控制"></a>并发控制</h4><p>如果有多个线程需要修改/workspace/projects/helloworld下的README.txt名称，这时就需要避免出现多线程的并发安全问题，比如多个线程并发修改导致先执行的修改操作被后执行的修改操作给覆盖了。</p>
<h5 id="全局悲观锁"><a href="#全局悲观锁" class="headerlink" title="全局悲观锁"></a>全局悲观锁</h5><p>在修改数据前，使用_create创建一个doc，锁掉整个index。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">PUT <span class="hljs-regexp">/fs/</span>lock<span class="hljs-regexp">/global/</span>_create<br>&#123;&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>fs: 需要上锁的那个index</li>
<li>lock: 指定的一个对这个index上全局锁的一个type</li>
<li>global: 就是全局锁对应doc的id</li>
<li>_create：强制必须是创建，如果doc已经存在，就直接报错</li>
</ul>
<p>上锁成功：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs csharp">/fs/<span class="hljs-keyword">lock</span>/<span class="hljs-keyword">global</span><br><br>&#123;<br>  <span class="hljs-string">&quot;_index&quot;</span>: <span class="hljs-string">&quot;fs&quot;</span>,<br>  <span class="hljs-string">&quot;_type&quot;</span>: <span class="hljs-string">&quot;lock&quot;</span>,<br>  <span class="hljs-string">&quot;_id&quot;</span>: <span class="hljs-string">&quot;global&quot;</span>,<br>  <span class="hljs-string">&quot;_version&quot;</span>: <span class="hljs-number">1</span>,<br>  <span class="hljs-string">&quot;result&quot;</span>: <span class="hljs-string">&quot;created&quot;</span>,<br>  <span class="hljs-string">&quot;_shards&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;total&quot;</span>: <span class="hljs-number">2</span>,<br>    <span class="hljs-string">&quot;successful&quot;</span>: <span class="hljs-number">1</span>,<br>    <span class="hljs-string">&quot;failed&quot;</span>: <span class="hljs-number">0</span><br>  &#125;,<br>  <span class="hljs-string">&quot;created&quot;</span>: <span class="hljs-literal">true</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>上锁失败：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;error&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;root_cause&quot;</span>: [<br>      &#123;<br>        <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;version_conflict_engine_exception&quot;</span>,<br>        <span class="hljs-attr">&quot;reason&quot;</span>: <span class="hljs-string">&quot;[lock][global]: version conflict, document already exists (current version [1])&quot;</span>,<br>        <span class="hljs-attr">&quot;index_uuid&quot;</span>: <span class="hljs-string">&quot;IYbj0OLGQHmMUpLfbhD4Hw&quot;</span>,<br>        <span class="hljs-attr">&quot;shard&quot;</span>: <span class="hljs-string">&quot;2&quot;</span>,<br>        <span class="hljs-attr">&quot;index&quot;</span>: <span class="hljs-string">&quot;fs&quot;</span><br>      &#125;<br>    ],<br>    <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;version_conflict_engine_exception&quot;</span>,<br>    <span class="hljs-attr">&quot;reason&quot;</span>: <span class="hljs-string">&quot;[lock][global]: version conflict, document already exists (current version [1])&quot;</span>,<br>    <span class="hljs-attr">&quot;index_uuid&quot;</span>: <span class="hljs-string">&quot;IYbj0OLGQHmMUpLfbhD4Hw&quot;</span>,<br>    <span class="hljs-attr">&quot;shard&quot;</span>: <span class="hljs-string">&quot;2&quot;</span>,<br>    <span class="hljs-attr">&quot;index&quot;</span>: <span class="hljs-string">&quot;fs&quot;</span><br>  &#125;,<br>  <span class="hljs-attr">&quot;status&quot;</span>: <span class="hljs-number">409</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>操作完成后删除锁：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-keyword">DELETE</span> <span class="hljs-regexp">/fs/</span>lock/global<br></code></pre></td></tr></table></figure>

<p>全局锁的优点和缺点</p>
<p>优点：操作非常简单，非常容易使用，成本低<br>缺点：对整个index加锁，导致整个系统的并发能力很低</p>
<p>上锁解锁的操作不是频繁，然后每次上锁之后，执行的操作的耗时不会太长，用这种方式。</p>
<h5 id="doc粒度悲观锁"><a href="#doc粒度悲观锁" class="headerlink" title="doc粒度悲观锁"></a>doc粒度悲观锁</h5><p>document粒度的一个锁，每次只锁需要执行增删改的那些doc，只阻止其他线程对已经上锁doc的增删改操作。对其他doc不影响。</p>
<p>上锁操作：</p>
<p>在es目录下config/scripts/中新建judge-lock.groovy文件，内容为：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-keyword">if</span> ( ctx.<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">_source</span>.</span></span>process_id != process_id ) &#123; <span class="hljs-keyword">assert</span> <span class="hljs-literal">false</span> &#125;; ctx.op = &#x27;noop&#x27;;<br></code></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs awk">POST <span class="hljs-regexp">/fs/</span>lock<span class="hljs-regexp">/1/</span>_update<br>&#123;<br>  <span class="hljs-string">&quot;upsert&quot;</span>: &#123; <span class="hljs-string">&quot;process_id&quot;</span>: <span class="hljs-number">123</span> &#125;,<br>  <span class="hljs-string">&quot;script&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;lang&quot;</span>: <span class="hljs-string">&quot;groovy&quot;</span>,<br>    <span class="hljs-string">&quot;file&quot;</span>: <span class="hljs-string">&quot;judge-lock&quot;</span>, <br>    <span class="hljs-string">&quot;params&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;process_id&quot;</span>: <span class="hljs-number">123</span><br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li><p>/fs/lock，是固定的，就是说fs下的lock type，专门用于进行上锁</p>
</li>
<li><p>/fs/lock/id，比如1，id其实就是你要上锁的那个doc的id，代表了某个doc数据对应的lock（也是一个doc）<br>_update + upsert：执行upsert操作</p>
</li>
<li><p>params：process_id是指当前占用锁的线程id，java系统中，可以用给每个系统分配一个UUID，然后使用UUID+thread id来标识一个线程。此处的123仅仅是一个示范。</p>
</li>
<li><p>script：脚本执行逻辑为，如果process_id不相同则抛出异常，如果相同则ctx.op = ‘noop’不做任何操作</p>
</li>
</ul>
<p>执行此操作时：如果该document之前没有被锁，/fs/lock/1之前不存在，也就是doc id=1没有被别人上过锁;。upsert的语法就会执行index操作，创建一个/fs/lock/id这条数据，而且用params中的数据作为这个lock的数据。process_id被设置为123，script不执行。这个时候象征着process_id=123的进程已经锁了一个doc了。</p>
<p>如果document被锁了，/fs/lock/1已经存在，则代表doc id=1已经被某个进程给锁了。就会执行update操作，执行script中的内容，此时会比对process_id，如果相同，则代表线程重复加锁，不执行任何操作，返回success。 如果process_id比对不上，说明doc被其他doc给锁了，此时报错。</p>
<h5 id="共享锁和排他锁"><a href="#共享锁和排他锁" class="headerlink" title="共享锁和排他锁"></a>共享锁和排他锁</h5><p>共享锁锁住的数据是共享的，每个线程都可以获取同一个数据的共享锁，排他锁锁住的数据是独占的，只能有一个线程获取到数据的排他锁。</p>
<p>在读写锁中，如果只是读取数据的话，每个线程都可以获取共享锁读取数据，如果需要修改数据，线程就会尝试获取排他锁，排他锁会跟共享锁及排他锁互斥，如果共享锁或者排他锁还没有释放，就必须等待锁释放。</p>
<p>上锁操作：</p>
<p>共享锁上锁：</p>
<p>在es目录下config/scripts/中新建judge-lock-2.groovy文件，内容为：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-keyword">if</span> (ctx.<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">_source</span>.</span></span>lock_type<span class="hljs-operator"> == </span>&#x27;exclusive&#x27;) &#123; <span class="hljs-keyword">assert</span> <span class="hljs-literal">false</span> &#125;; ctx.<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">_source</span>.</span></span>lock_count++<br></code></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs awk">POST <span class="hljs-regexp">/fs/</span>lock<span class="hljs-regexp">/1/</span>_update <br>&#123;<br>  <span class="hljs-string">&quot;upsert&quot;</span>: &#123; <br>    <span class="hljs-string">&quot;lock_type&quot;</span>:  <span class="hljs-string">&quot;shared&quot;</span>,<br>    <span class="hljs-string">&quot;lock_count&quot;</span>: <span class="hljs-number">1</span><br>  &#125;,<br>  <span class="hljs-string">&quot;script&quot;</span>: &#123;<br>  	<span class="hljs-string">&quot;lang&quot;</span>: <span class="hljs-string">&quot;groovy&quot;</span>,<br>  	<span class="hljs-string">&quot;file&quot;</span>: <span class="hljs-string">&quot;judge-lock-2&quot;</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>共享锁解锁：</p>
<p>在es目录下config/scripts/中新建unlock-shared.groovy文件，内容为：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-keyword">if</span> (ctx.<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">_source</span>.</span></span>lock_type<span class="hljs-operator"> == </span>&#x27;exclusive&#x27;) &#123; <span class="hljs-keyword">assert</span> <span class="hljs-literal">false</span> &#125;; ctx.<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">_source</span>.</span></span>lock_count++<br></code></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs awk">POST <span class="hljs-regexp">/fs/</span>lock<span class="hljs-regexp">/1/</span>_update<br>&#123;<br>  <span class="hljs-string">&quot;script&quot;</span>: &#123;<br>  	<span class="hljs-string">&quot;lang&quot;</span>: <span class="hljs-string">&quot;groovy&quot;</span>,<br>  	<span class="hljs-string">&quot;file&quot;</span>: <span class="hljs-string">&quot;unlock-shared&quot;</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>每次解锁一个共享锁，就对lock_count先减1，如果减完之后结果是0，那么说明所有的共享锁都解锁完了，此时就将/fs/lock/1删除，就彻底解锁所有的共享锁</p>
<p>排他锁上锁：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">PUT <span class="hljs-regexp">/fs/</span>lock<span class="hljs-regexp">/1/</span>_create<br>&#123; <span class="hljs-string">&quot;lock_type&quot;</span>: <span class="hljs-string">&quot;exclusive&quot;</span> &#125;<br></code></pre></td></tr></table></figure>

<p>排他锁解锁：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-keyword">DELETE</span> <span class="hljs-regexp">/fs/</span>lock/<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure>

<p>排他锁用的不是upsert语法，create语法，要求lock必须不能存在。</p>
<h3 id="评分机制"><a href="#评分机制" class="headerlink" title="评分机制"></a>评分机制</h3><h4 id="relevance-score算法"><a href="#relevance-score算法" class="headerlink" title="relevance score算法"></a>relevance score算法</h4><p>relevance score算法即相关度算法，简单来说就是计算出一个索引中的文本与搜索文本之间的关联匹配程度。</p>
<p>Elasticsearch使用的是 term frequency/inverse document frequency算法，简称为TF/IDF算法，评分规则大致包括：</p>
<ul>
<li><p>TF：Term frequency，搜索文本中的某个词条在field文本中出现的次数，出现次数越多该词条对应的分数越高。</p>
</li>
<li><p>IDF：Inverse document frequency，搜索文本中的各个词条在整个index的所有document中出现了多少次，出现的次数越多，词条对应分数越低。</p>
</li>
<li><p>length norm：词条所在内容的长度，长度越长相关度越弱。</p>
</li>
</ul>
<p>最后综合TF、IDF、length norm的分数，计算出一个综合分数，综合分数计算时，使用到了vector space model（空间向量模型）。</p>
<p>es会根据多个term计算出一个query vector向量，比如有两个term：hello和world，</p>
<p>hello给的基于所有doc的一个评分就是2</p>
<p>work给的基于所有doc的评分是5</p>
<p>那么query vector就是[2,5]</p>
<p>在三个doc中，会对每个term计算出一个分数，再拿所有的term分数组成一个doc vector。</p>
<p>doc1中包含hello，doc vector为[2, 0]</p>
<p>doc2中包含world，doc vector为[0, 5]</p>
<p>doc3中包含hello world，doc vector为[2, 5]</p>
<p>每个doc vector计算出对query vector的弧度，最后基于这个弧度给出一个doc相对于query中多个term的总分数。弧度越大，分数越；弧度越小，分数越高。</p>
<h4 id="relevance-score不准确问题"><a href="#relevance-score不准确问题" class="headerlink" title="relevance score不准确问题"></a>relevance score不准确问题</h4><p>在进行IDF算法时，只会统计各个词条在本shard的所有document中一共出现多少次，而不是对整个index进行统计，如果index有多个primary shard，就会导致relevance score不准确问题。</p>
<p>在数据量很大的情况下，es会自动进行负载均衡，shard中的数据是比较均匀的，这样计算出的score的偏差并不是很大。也可以将索引的primary shard设置为1个，所有的document都在一个shard里面，就没有这个问题了。</p>
<p>也可以在搜索时附带search_type=dfs_query_then_fetch参数，在计算一个doc的相关度分数的时候，就会将所有shard对的local IDF计算一下，获取出来在本地进行global IDF分数的计算，会将所有shard的doc作为上下文来进行计算，也能确保准确性。但是这样会导致搜索性能极差，生产环境下，不推荐使用。</p>
<h4 id="lucence的相关度算法"><a href="#lucence的相关度算法" class="headerlink" title="lucence的相关度算法"></a>lucence的相关度算法</h4><p>practical scoring function，是lucence来计算一个query对一个doc的分数的公式，该函数会使用一个公式来计算。</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs erlang"><span class="hljs-function"><span class="hljs-title">score</span><span class="hljs-params">(q,d)</span>  =  </span><br><span class="hljs-function">            <span class="hljs-title">queryNorm</span><span class="hljs-params">(q)</span>  </span><br><span class="hljs-function">          · <span class="hljs-title">coord</span><span class="hljs-params">(q,d)</span>    </span><br><span class="hljs-function">          · ∑ <span class="hljs-params">(           </span></span><br><span class="hljs-function"><span class="hljs-params">                tf(t in d)   </span></span><br><span class="hljs-function"><span class="hljs-params">              · idf(t)<span class="hljs-number">2</span>      </span></span><br><span class="hljs-function"><span class="hljs-params">              · t.getBoost() </span></span><br><span class="hljs-function"><span class="hljs-params">              · norm(t,d)    </span></span><br><span class="hljs-function"><span class="hljs-params">            )</span> <span class="hljs-params">(t in q)</span>  </span><br><span class="hljs-function"></span><br></code></pre></td></tr></table></figure>

<ul>
<li><p>score(q,d) score(q,d) is the relevance score of document d for query q.这个公式的最终结果，是一个query（叫做q），对一个doc（叫做d）的最终的总评分。</p>
</li>
<li><p>queryNorm(q) is the query normalization factor (new).是用来让一个doc的分数处于一个合理的区间内，减小偏差。</p>
</li>
<li><p>ccoord(q,d) is the coordination factor (new).简单来说，就是对更加匹配的doc，进行一些分数上的成倍的奖励</p>
</li>
<li><p>∑ (t in q) The sum of the weights for each term t in the query q for document d.query中每个term对doc的分数，进行求和，多个term对一个doc的分数，组成一个vector space。求和的符号</p>
</li>
</ul>
<p>计算每一个term对doc的分数的时候</p>
<ul>
<li><p>tf(t in d) is the term frequency for term t in document d.TF算法</p>
</li>
<li><p>idf(t) is the inverse document frequency for term t.IDF算法</p>
</li>
<li><p>t.getBoost() is the boost that has been applied to the query (new).权重增强</p>
</li>
<li><p>norm(t,d) is the field-length norm, combined with the index-time field-level boost, if any. (new).length norm，长度对评分的影响</p>
</li>
</ul>
<p>query normalization factor逻辑：</p>
<p>queryNorm = 1 / √sumOfSquaredWeights</p>
<ul>
<li>sumOfSquaredWeights 表示所有term的IDF分数之和，对sumOfSquaredWeights 开一个平方根，然后做一个平方根分之1。主要是为了将分数进行规范化，开平方根之后分数会变下，再用1去除以这个平方根，分数就会变为几点几的这种小数。</li>
</ul>
<p>query coodination逻辑：</p>
<p>主要是为那些匹配更多字符的doc增加更多的分数，大概逻辑为是把计算出来的总分数 * 匹配上的term数量 / 总的term数量，让匹配不同term/query数量的doc分数之间拉开差距。</p>
<p>field level boost逻辑：</p>
<p>通过bost权重计算分数</p>
<h4 id="对相关度评分进行调节和优化的常见的4种方法"><a href="#对相关度评分进行调节和优化的常见的4种方法" class="headerlink" title="对相关度评分进行调节和优化的常见的4种方法"></a>对相关度评分进行调节和优化的常见的4种方法</h4><ul>
<li><p><strong>query-time boost</strong>：增加权重设置</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/forum/</span>article/_search<br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;bool&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;should&quot;</span>: [<br>        &#123;<br>          <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;title&quot;</span>: &#123;<br>              <span class="hljs-string">&quot;query&quot;</span>: <span class="hljs-string">&quot;java spark&quot;</span>,<br>              <span class="hljs-string">&quot;boost&quot;</span>: <span class="hljs-number">2</span><br>            &#125;<br>          &#125;<br>        &#125;,<br>        &#123;<br>          <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;java spark&quot;</span><br>          &#125;<br>        &#125;<br>      ]<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p><strong>重构查询结构</strong></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/forum/</span>article/_search <br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;bool&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;should&quot;</span>: [<br>        &#123;<br>          <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;java&quot;</span><br>          &#125;<br>        &#125;,<br>        &#123;<br>          <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;spark&quot;</span><br>          &#125;<br>        &#125;,<br>        &#123;<br>          <span class="hljs-string">&quot;bool&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;should&quot;</span>: [<br>              &#123;<br>                <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>                  <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;solution&quot;</span><br>                &#125;<br>              &#125;,<br>              &#123;<br>                <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>                  <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;beginner&quot;</span><br>                &#125;<br>              &#125;<br>            ]<br>          &#125;<br>        &#125;<br>      ]<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p><strong>negative boost</strong>：比如需要尽量搜索包含java，不包含spark的doc，如果只搜索包含java，不包含spark的doc，这样就会过于死板，所以需要搜索包含java，尽量不包含spark的doc，如果包含了spark，不会说排除掉这个doc，而是说将这个doc的分数降低。只包含java，不包含spark的doc</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/forum/</span>article/_search <br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;bool&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;must&quot;</span>: [<br>        &#123;<br>          <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;java&quot;</span><br>          &#125;<br>        &#125;<br>      ],<br>      <span class="hljs-string">&quot;must_not&quot;</span>: [<br>        &#123;<br>          <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;spark&quot;</span><br>          &#125;<br>        &#125;<br>      ]<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>包含java，尽量不包含spark的doc</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/forum/</span>article/_search <br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;boosting&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;positive&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;java&quot;</span><br>        &#125;<br>      &#125;,<br>      <span class="hljs-string">&quot;negative&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;spark&quot;</span><br>        &#125;<br>      &#125;,<br>      <span class="hljs-string">&quot;negative_boost&quot;</span>: <span class="hljs-number">0.2</span><br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>此时如果doc中包含了negative中的term，分数就会乘以negative_boost，降低分数。</p>
</li>
<li><p><strong>constant_score</strong>：如果不需要相关度评分，就可以直接走constant_score加filter，所有的doc分数都是1，没有评分的概念了</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/forum/</span>article/_search <br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;bool&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;should&quot;</span>: [<br>        &#123;<br>          <span class="hljs-string">&quot;constant_score&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>              <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;java&quot;</span><br>              &#125;<br>            &#125;<br>          &#125;<br>        &#125;,<br>        &#123;<br>          <span class="hljs-string">&quot;constant_score&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>              <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;spark&quot;</span><br>              &#125;<br>            &#125;<br>          &#125;<br>        &#125;<br>      ]<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="用function-score自定义相关度分数算法"><a href="#用function-score自定义相关度分数算法" class="headerlink" title="用function_score自定义相关度分数算法"></a>用function_score自定义相关度分数算法</h4><p>测试数据</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs n1ql">POST /forum/article/_bulk<br>&#123; &quot;<span class="hljs-keyword">update</span><span class="hljs-string">&quot;: &#123; &quot;</span>_id<span class="hljs-string">&quot;: &quot;</span><span class="hljs-number">1</span><span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span>doc<span class="hljs-string">&quot; : &#123;&quot;</span>follower_num<span class="hljs-string">&quot; : 5&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">update</span><span class="hljs-string">&quot;: &#123; &quot;</span>_id<span class="hljs-string">&quot;: &quot;</span><span class="hljs-number">2</span><span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span>doc<span class="hljs-string">&quot; : &#123;&quot;</span>follower_num<span class="hljs-string">&quot; : 10&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">update</span><span class="hljs-string">&quot;: &#123; &quot;</span>_id<span class="hljs-string">&quot;: &quot;</span><span class="hljs-number">3</span><span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span>doc<span class="hljs-string">&quot; : &#123;&quot;</span>follower_num<span class="hljs-string">&quot; : 25&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">update</span><span class="hljs-string">&quot;: &#123; &quot;</span>_id<span class="hljs-string">&quot;: &quot;</span><span class="hljs-number">4</span><span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span>doc<span class="hljs-string">&quot; : &#123;&quot;</span>follower_num<span class="hljs-string">&quot; : 3&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span><span class="hljs-keyword">update</span><span class="hljs-string">&quot;: &#123; &quot;</span>_id<span class="hljs-string">&quot;: &quot;</span><span class="hljs-number">5</span><span class="hljs-string">&quot;&#125; &#125;</span><br><span class="hljs-string">&#123; &quot;</span>doc<span class="hljs-string">&quot; : &#123;&quot;</span>follower_num<span class="hljs-string">&quot; : 60&#125; &#125;</span><br></code></pre></td></tr></table></figure>

<p>将对帖子搜索得到的分数，跟follower_num进行运算，由follower_num在一定程度上增强帖子的分数<br>看帖子的人越多，那么帖子的分数就越高</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/forum/</span>article/_search<br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;function_score&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;multi_match&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;query&quot;</span>: <span class="hljs-string">&quot;java spark&quot;</span>,<br>          <span class="hljs-string">&quot;fields&quot;</span>: [<span class="hljs-string">&quot;tile&quot;</span>, <span class="hljs-string">&quot;content&quot;</span>]<br>        &#125;<br>      &#125;,<br>      <span class="hljs-string">&quot;field_value_factor&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;follower_num&quot;</span>,<br>        <span class="hljs-string">&quot;modifier&quot;</span>: <span class="hljs-string">&quot;log1p&quot;</span>,<br>        <span class="hljs-string">&quot;factor&quot;</span>: <span class="hljs-number">0.5</span><br>      &#125;,<br>      <span class="hljs-string">&quot;boost_mode&quot;</span>: <span class="hljs-string">&quot;sum&quot;</span>,<br>      <span class="hljs-string">&quot;max_boost&quot;</span>: <span class="hljs-number">2</span><br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>如果只有field，那么会将每个doc的分数都乘以follower_num，如果有的doc follower是0，那么分数就会变为0，效果很不好。因此一般会加个log1p函数，公式会变为，new_score = old_score * log(1 + number_of_votes)，这样出来的分数会比较合理</p>
<p>factor，可以进一步影响分数，new_score = old_score * log(1 + factor * number_of_votes)</p>
<p>boost_mode，可以决定分数与指定字段的值如何计算，multiply，sum，min，max，replace</p>
<p>max_boost，限制计算出来的分数不要超过max_boost指定的值</p>
<h4 id="查看score计算过程"><a href="#查看score计算过程" class="headerlink" title="查看score计算过程"></a>查看score计算过程</h4><p>使用explain查看_score是如何被计算出来的</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/test_index/</span>test_type/_search?explain<br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;test_field&quot;</span>: <span class="hljs-string">&quot;test hello&quot;</span><br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>结果示例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;took&quot;</span>: <span class="hljs-number">6</span>,<br>  <span class="hljs-attr">&quot;timed_out&quot;</span>: <span class="hljs-literal">false</span>,<br>  <span class="hljs-attr">&quot;_shards&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">5</span>,<br>    <span class="hljs-attr">&quot;successful&quot;</span>: <span class="hljs-number">5</span>,<br>    <span class="hljs-attr">&quot;failed&quot;</span>: <span class="hljs-number">0</span><br>  &#125;,<br>  <span class="hljs-attr">&quot;hits&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">4</span>,<br>    <span class="hljs-attr">&quot;max_score&quot;</span>: <span class="hljs-number">1.595089</span>,<br>    <span class="hljs-attr">&quot;hits&quot;</span>: [<br>      &#123;<br>        <span class="hljs-attr">&quot;_shard&quot;</span>: <span class="hljs-string">&quot;[test_index][2]&quot;</span>,<br>        <span class="hljs-attr">&quot;_node&quot;</span>: <span class="hljs-string">&quot;4onsTYVZTjGvIj9_spWz2w&quot;</span>,<br>        <span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;test_index&quot;</span>,<br>        <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;test_type&quot;</span>,<br>        <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;20&quot;</span>,<br>        <span class="hljs-attr">&quot;_score&quot;</span>: <span class="hljs-number">1.595089</span>,<br>        <span class="hljs-attr">&quot;_source&quot;</span>: &#123;<br>          <span class="hljs-attr">&quot;test_field&quot;</span>: <span class="hljs-string">&quot;test hello&quot;</span><br>        &#125;,<br>        <span class="hljs-attr">&quot;_explanation&quot;</span>: &#123;<br>          <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">1.595089</span>,<br>          <span class="hljs-attr">&quot;description&quot;</span>: <span class="hljs-string">&quot;sum of:&quot;</span>,<br>          <span class="hljs-attr">&quot;details&quot;</span>: [<br>            &#123;<br>              <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">1.595089</span>,<br>              <span class="hljs-attr">&quot;description&quot;</span>: <span class="hljs-string">&quot;sum of:&quot;</span>,<br>              <span class="hljs-attr">&quot;details&quot;</span>: [<br>                &#123;<br>                  <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">0.58279467</span>,<br>                  <span class="hljs-attr">&quot;description&quot;</span>: <span class="hljs-string">&quot;weight(test_field:test in 0) [PerFieldSimilarity], result of:&quot;</span>,<br>                  <span class="hljs-attr">&quot;details&quot;</span>: [<br>                    &#123;<br>                      <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">0.58279467</span>,<br>                      <span class="hljs-attr">&quot;description&quot;</span>: <span class="hljs-string">&quot;score(doc=0,freq=1.0 = termFreq=1.0\n), product of:&quot;</span>,<br>                      <span class="hljs-attr">&quot;details&quot;</span>: [<br>                        &#123;<br>                          <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">0.6931472</span>,<br>                          <span class="hljs-attr">&quot;description&quot;</span>: <span class="hljs-string">&quot;idf, computed as log(1 + (docCount - docFreq + 0.5) / (docFreq + 0.5)) from:&quot;</span>,<br>                          <span class="hljs-attr">&quot;details&quot;</span>: [<br>                            &#123;<br>                              <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">2</span>,<br>                              <span class="hljs-attr">&quot;description&quot;</span>: <span class="hljs-string">&quot;docFreq&quot;</span>,<br>                              <span class="hljs-attr">&quot;details&quot;</span>: []<br>                            &#125;,<br>                            &#123;<br>                              <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">4</span>,<br>                              <span class="hljs-attr">&quot;description&quot;</span>: <span class="hljs-string">&quot;docCount&quot;</span>,<br>                              <span class="hljs-attr">&quot;details&quot;</span>: []<br>                            &#125;<br>                          ]<br>                        &#125;,<br>                        &#123;<br>                          <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">0.840795</span>,<br>                          <span class="hljs-attr">&quot;description&quot;</span>: <span class="hljs-string">&quot;tfNorm, computed as (freq * (k1 + 1)) / (freq + k1 * (1 - b + b * fieldLength / avgFieldLength)) from:&quot;</span>,<br>                          <span class="hljs-attr">&quot;details&quot;</span>: [<br>                            &#123;<br>                              <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">1</span>,<br>                              <span class="hljs-attr">&quot;description&quot;</span>: <span class="hljs-string">&quot;termFreq=1.0&quot;</span>,<br>                              <span class="hljs-attr">&quot;details&quot;</span>: []<br>                            &#125;,<br>                            &#123;<br>                              <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">1.2</span>,<br>                              <span class="hljs-attr">&quot;description&quot;</span>: <span class="hljs-string">&quot;parameter k1&quot;</span>,<br>                              <span class="hljs-attr">&quot;details&quot;</span>: []<br>                            &#125;,<br>                            &#123;<br>                              <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">0.75</span>,<br>                              <span class="hljs-attr">&quot;description&quot;</span>: <span class="hljs-string">&quot;parameter b&quot;</span>,<br>                              <span class="hljs-attr">&quot;details&quot;</span>: []<br>                            &#125;,<br>                            &#123;<br>                              <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">1.75</span>,<br>                              <span class="hljs-attr">&quot;description&quot;</span>: <span class="hljs-string">&quot;avgFieldLength&quot;</span>,<br>                              <span class="hljs-attr">&quot;details&quot;</span>: []<br>                            &#125;,<br>                            &#123;<br>                              <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">2.56</span>,<br>                              <span class="hljs-attr">&quot;description&quot;</span>: <span class="hljs-string">&quot;fieldLength&quot;</span>,<br>                              <span class="hljs-attr">&quot;details&quot;</span>: []<br>                            &#125;<br>                          ]<br>                        &#125;<br>                      ]<br>                    &#125;<br>                  ]<br>                &#125;,<br>                &#123;<br>                  <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">1.0122943</span>,<br>                  <span class="hljs-attr">&quot;description&quot;</span>: <span class="hljs-string">&quot;weight(test_field:hello in 0) [PerFieldSimilarity], result of:&quot;</span>,<br>                  <span class="hljs-attr">&quot;details&quot;</span>: [<br>                    &#123;<br>                      <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">1.0122943</span>,<br>                      <span class="hljs-attr">&quot;description&quot;</span>: <span class="hljs-string">&quot;score(doc=0,freq=1.0 = termFreq=1.0\n), product of:&quot;</span>,<br>                      <span class="hljs-attr">&quot;details&quot;</span>: [<br>                        &#123;<br>                          <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">1.2039728</span>,<br>                          <span class="hljs-attr">&quot;description&quot;</span>: <span class="hljs-string">&quot;idf, computed as log(1 + (docCount - docFreq + 0.5) / (docFreq + 0.5)) from:&quot;</span>,<br>                          <span class="hljs-attr">&quot;details&quot;</span>: [<br>                            &#123;<br>                              <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">1</span>,<br>                              <span class="hljs-attr">&quot;description&quot;</span>: <span class="hljs-string">&quot;docFreq&quot;</span>,<br>                              <span class="hljs-attr">&quot;details&quot;</span>: []<br>                            &#125;,<br>                            &#123;<br>                              <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">4</span>,<br>                              <span class="hljs-attr">&quot;description&quot;</span>: <span class="hljs-string">&quot;docCount&quot;</span>,<br>                              <span class="hljs-attr">&quot;details&quot;</span>: []<br>                            &#125;<br>                          ]<br>                        &#125;,<br>                        &#123;<br>                          <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">0.840795</span>,<br>                          <span class="hljs-attr">&quot;description&quot;</span>: <span class="hljs-string">&quot;tfNorm, computed as (freq * (k1 + 1)) / (freq + k1 * (1 - b + b * fieldLength / avgFieldLength)) from:&quot;</span>,<br>                          <span class="hljs-attr">&quot;details&quot;</span>: [<br>                            &#123;<br>                              <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">1</span>,<br>                              <span class="hljs-attr">&quot;description&quot;</span>: <span class="hljs-string">&quot;termFreq=1.0&quot;</span>,<br>                              <span class="hljs-attr">&quot;details&quot;</span>: []<br>                            &#125;,<br>                            &#123;<br>                              <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">1.2</span>,<br>                              <span class="hljs-attr">&quot;description&quot;</span>: <span class="hljs-string">&quot;parameter k1&quot;</span>,<br>                              <span class="hljs-attr">&quot;details&quot;</span>: []<br>                            &#125;,<br>                            &#123;<br>                              <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">0.75</span>,<br>                              <span class="hljs-attr">&quot;description&quot;</span>: <span class="hljs-string">&quot;parameter b&quot;</span>,<br>                              <span class="hljs-attr">&quot;details&quot;</span>: []<br>                            &#125;,<br>                            &#123;<br>                              <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">1.75</span>,<br>                              <span class="hljs-attr">&quot;description&quot;</span>: <span class="hljs-string">&quot;avgFieldLength&quot;</span>,<br>                              <span class="hljs-attr">&quot;details&quot;</span>: []<br>                            &#125;,<br>                            &#123;<br>                              <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">2.56</span>,<br>                              <span class="hljs-attr">&quot;description&quot;</span>: <span class="hljs-string">&quot;fieldLength&quot;</span>,<br>                              <span class="hljs-attr">&quot;details&quot;</span>: []<br>                            &#125;<br>                          ]<br>                        &#125;<br>                      ]<br>                    &#125;<br>                  ]<br>                &#125;<br>              ]<br>            &#125;,<br>            &#123;<br>              <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">0</span>,<br>              <span class="hljs-attr">&quot;description&quot;</span>: <span class="hljs-string">&quot;match on required clause, product of:&quot;</span>,<br>              <span class="hljs-attr">&quot;details&quot;</span>: [<br>                &#123;<br>                  <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">0</span>,<br>                  <span class="hljs-attr">&quot;description&quot;</span>: <span class="hljs-string">&quot;# clause&quot;</span>,<br>                  <span class="hljs-attr">&quot;details&quot;</span>: []<br>                &#125;,<br>                &#123;<br>                  <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">1</span>,<br>                  <span class="hljs-attr">&quot;description&quot;</span>: <span class="hljs-string">&quot;*:*, product of:&quot;</span>,<br>                  <span class="hljs-attr">&quot;details&quot;</span>: [<br>                    &#123;<br>                      <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">1</span>,<br>                      <span class="hljs-attr">&quot;description&quot;</span>: <span class="hljs-string">&quot;boost&quot;</span>,<br>                      <span class="hljs-attr">&quot;details&quot;</span>: []<br>                    &#125;,<br>                    &#123;<br>                      <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">1</span>,<br>                      <span class="hljs-attr">&quot;description&quot;</span>: <span class="hljs-string">&quot;queryNorm&quot;</span>,<br>                      <span class="hljs-attr">&quot;details&quot;</span>: []<br>                    &#125;<br>                  ]<br>                &#125;<br>              ]<br>            &#125;<br>          ]<br>        &#125;<br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">&quot;_shard&quot;</span>: <span class="hljs-string">&quot;[test_index][2]&quot;</span>,<br>        <span class="hljs-attr">&quot;_node&quot;</span>: <span class="hljs-string">&quot;4onsTYVZTjGvIj9_spWz2w&quot;</span>,<br>        <span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;test_index&quot;</span>,<br>        <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;test_type&quot;</span>,<br>        <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;6&quot;</span>,<br>        <span class="hljs-attr">&quot;_score&quot;</span>: <span class="hljs-number">0.58279467</span>,<br>        <span class="hljs-attr">&quot;_source&quot;</span>: &#123;<br>          <span class="hljs-attr">&quot;test_field&quot;</span>: <span class="hljs-string">&quot;tes test&quot;</span><br>        &#125;,<br>        <span class="hljs-attr">&quot;_explanation&quot;</span>: &#123;<br>          <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">0.58279467</span>,<br>          <span class="hljs-attr">&quot;description&quot;</span>: <span class="hljs-string">&quot;sum of:&quot;</span>,<br>          <span class="hljs-attr">&quot;details&quot;</span>: [<br>            &#123;<br>              <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">0.58279467</span>,<br>              <span class="hljs-attr">&quot;description&quot;</span>: <span class="hljs-string">&quot;sum of:&quot;</span>,<br>              <span class="hljs-attr">&quot;details&quot;</span>: [<br>                &#123;<br>                  <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">0.58279467</span>,<br>                  <span class="hljs-attr">&quot;description&quot;</span>: <span class="hljs-string">&quot;weight(test_field:test in 0) [PerFieldSimilarity], result of:&quot;</span>,<br>                  <span class="hljs-attr">&quot;details&quot;</span>: [<br>                    &#123;<br>                      <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">0.58279467</span>,<br>                      <span class="hljs-attr">&quot;description&quot;</span>: <span class="hljs-string">&quot;score(doc=0,freq=1.0 = termFreq=1.0\n), product of:&quot;</span>,<br>                      <span class="hljs-attr">&quot;details&quot;</span>: [<br>                        &#123;<br>                          <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">0.6931472</span>,<br>                          <span class="hljs-attr">&quot;description&quot;</span>: <span class="hljs-string">&quot;idf, computed as log(1 + (docCount - docFreq + 0.5) / (docFreq + 0.5)) from:&quot;</span>,<br>                          <span class="hljs-attr">&quot;details&quot;</span>: [<br>                            &#123;<br>                              <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">2</span>,<br>                              <span class="hljs-attr">&quot;description&quot;</span>: <span class="hljs-string">&quot;docFreq&quot;</span>,<br>                              <span class="hljs-attr">&quot;details&quot;</span>: []<br>                            &#125;,<br>                            &#123;<br>                              <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">4</span>,<br>                              <span class="hljs-attr">&quot;description&quot;</span>: <span class="hljs-string">&quot;docCount&quot;</span>,<br>                              <span class="hljs-attr">&quot;details&quot;</span>: []<br>                            &#125;<br>                          ]<br>                        &#125;,<br>                        &#123;<br>                          <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">0.840795</span>,<br>                          <span class="hljs-attr">&quot;description&quot;</span>: <span class="hljs-string">&quot;tfNorm, computed as (freq * (k1 + 1)) / (freq + k1 * (1 - b + b * fieldLength / avgFieldLength)) from:&quot;</span>,<br>                          <span class="hljs-attr">&quot;details&quot;</span>: [<br>                            &#123;<br>                              <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">1</span>,<br>                              <span class="hljs-attr">&quot;description&quot;</span>: <span class="hljs-string">&quot;termFreq=1.0&quot;</span>,<br>                              <span class="hljs-attr">&quot;details&quot;</span>: []<br>                            &#125;,<br>                            &#123;<br>                              <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">1.2</span>,<br>                              <span class="hljs-attr">&quot;description&quot;</span>: <span class="hljs-string">&quot;parameter k1&quot;</span>,<br>                              <span class="hljs-attr">&quot;details&quot;</span>: []<br>                            &#125;,<br>                            &#123;<br>                              <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">0.75</span>,<br>                              <span class="hljs-attr">&quot;description&quot;</span>: <span class="hljs-string">&quot;parameter b&quot;</span>,<br>                              <span class="hljs-attr">&quot;details&quot;</span>: []<br>                            &#125;,<br>                            &#123;<br>                              <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">1.75</span>,<br>                              <span class="hljs-attr">&quot;description&quot;</span>: <span class="hljs-string">&quot;avgFieldLength&quot;</span>,<br>                              <span class="hljs-attr">&quot;details&quot;</span>: []<br>                            &#125;,<br>                            &#123;<br>                              <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">2.56</span>,<br>                              <span class="hljs-attr">&quot;description&quot;</span>: <span class="hljs-string">&quot;fieldLength&quot;</span>,<br>                              <span class="hljs-attr">&quot;details&quot;</span>: []<br>                            &#125;<br>                          ]<br>                        &#125;<br>                      ]<br>                    &#125;<br>                  ]<br>                &#125;<br>              ]<br>            &#125;,<br>            &#123;<br>              <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">0</span>,<br>              <span class="hljs-attr">&quot;description&quot;</span>: <span class="hljs-string">&quot;match on required clause, product of:&quot;</span>,<br>              <span class="hljs-attr">&quot;details&quot;</span>: [<br>                &#123;<br>                  <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">0</span>,<br>                  <span class="hljs-attr">&quot;description&quot;</span>: <span class="hljs-string">&quot;# clause&quot;</span>,<br>                  <span class="hljs-attr">&quot;details&quot;</span>: []<br>                &#125;,<br>                &#123;<br>                  <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">1</span>,<br>                  <span class="hljs-attr">&quot;description&quot;</span>: <span class="hljs-string">&quot;*:*, product of:&quot;</span>,<br>                  <span class="hljs-attr">&quot;details&quot;</span>: [<br>                    &#123;<br>                      <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">1</span>,<br>                      <span class="hljs-attr">&quot;description&quot;</span>: <span class="hljs-string">&quot;boost&quot;</span>,<br>                      <span class="hljs-attr">&quot;details&quot;</span>: []<br>                    &#125;,<br>                    &#123;<br>                      <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-number">1</span>,<br>                      <span class="hljs-attr">&quot;description&quot;</span>: <span class="hljs-string">&quot;queryNorm&quot;</span>,<br>                      <span class="hljs-attr">&quot;details&quot;</span>: []<br>                    &#125;<br>                  ]<br>                &#125;<br>              ]<br>            &#125;<br>          ]<br>        &#125;<br>      &#125;<br>    ]<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="数据探查"><a href="#数据探查" class="headerlink" title="数据探查"></a>数据探查</h3><p>term vector可以获取document中的某个field内的各个term的统计信息：</p>
<ul>
<li>term information: term frequency in the field, term positions, start and end offsets, term payloads</li>
<li>term statistics: 设置term_statistics=true; total term frequency, 一个term在所有document中出现的频率; document frequency，有多少document包含这个term</li>
<li>field statistics: document count，有多少document包含这个field; sum of document frequency，一个field中所有term的df之和; sum of total term frequency，一个field中的所有term的tf之和</li>
</ul>
<p>term statistics和field statistics并不精准，有些已经被删除的term仍会被考虑进去。 常用于一些数据探查，比如，查询某个term在多少个document中出现了。</p>
<p>term vector，涉及了很多的term和field相关的统计信息，有两种方式可以采集到这个统计信息</p>
<ul>
<li>index-time，在mapping里配置一下，然后建立索引的时候，就直接生成这些term和field的统计信息</li>
<li>query-time，你之前没有生成过任何的Term vector信息，然后在查看term vector的时候，直接就可以看到了，会on the fly，现场计算出各种统计信息，然后返回</li>
</ul>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs ada">PUT /my_index<br>&#123;<br>  <span class="hljs-string">&quot;mappings&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;my_type&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;text&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span>,<br>            <span class="hljs-string">&quot;term_vector&quot;</span>: <span class="hljs-string">&quot;with_positions_offsets_payloads&quot;</span>,<br>            <span class="hljs-string">&quot;store&quot;</span> : <span class="hljs-type">true</span>,<br>            <span class="hljs-string">&quot;analyzer&quot;</span> : &quot;<span class="hljs-type">fulltext_analyzer</span><span class="hljs-string">&quot;</span><br><span class="hljs-string">         &#125;,</span><br><span class="hljs-string">         &quot;</span>fullname<span class="hljs-string">&quot;: &#123;</span><br><span class="hljs-string">            &quot;</span><span class="hljs-keyword">type</span><span class="hljs-string">&quot;: &quot;</span>text<span class="hljs-string">&quot;,</span><br><span class="hljs-string">            &quot;</span>analyzer<span class="hljs-string">&quot; : &quot;</span>fulltext_analyzer<span class="hljs-string">&quot;</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string">      &#125;</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string">  &#125;,</span><br><span class="hljs-string">  &quot;</span>settings<span class="hljs-string">&quot; : &#123;</span><br><span class="hljs-string">    &quot;</span>index<span class="hljs-string">&quot; : &#123;</span><br><span class="hljs-string">      &quot;</span>number_of_shards<span class="hljs-string">&quot; : 1,</span><br><span class="hljs-string">      &quot;</span>number_of_replicas<span class="hljs-string">&quot; : 0</span><br><span class="hljs-string">    &#125;,</span><br><span class="hljs-string">    &quot;</span>analysis<span class="hljs-string">&quot;: &#123;</span><br><span class="hljs-string">      &quot;</span>analyzer<span class="hljs-string">&quot;: &#123;</span><br><span class="hljs-string">        &quot;</span>fulltext_analyzer<span class="hljs-string">&quot;: &#123;</span><br><span class="hljs-string">          &quot;</span><span class="hljs-keyword">type</span><span class="hljs-string">&quot;: &quot;</span>custom<span class="hljs-string">&quot;,</span><br><span class="hljs-string">          &quot;</span>tokenizer<span class="hljs-string">&quot;: &quot;</span>whitespace<span class="hljs-string">&quot;,</span><br><span class="hljs-string">          &quot;</span>filter<span class="hljs-string">&quot;: [</span><br><span class="hljs-string">            &quot;</span>lowercase<span class="hljs-string">&quot;,</span><br><span class="hljs-string">            &quot;</span>type_as_payload<span class="hljs-string">&quot;</span><br><span class="hljs-string">          ]</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string">      &#125;</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string">  &#125;</span><br><span class="hljs-string">&#125;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs awk">PUT <span class="hljs-regexp">/my_index/my</span>_type/<span class="hljs-number">1</span><br>&#123;<br>  <span class="hljs-string">&quot;fullname&quot;</span> : <span class="hljs-string">&quot;Leo Li&quot;</span>,<br>  <span class="hljs-string">&quot;text&quot;</span> : <span class="hljs-string">&quot;hello test test test &quot;</span><br>&#125;<br><br>PUT <span class="hljs-regexp">/my_index/my</span>_type/<span class="hljs-number">2</span><br>&#123;<br>  <span class="hljs-string">&quot;fullname&quot;</span> : <span class="hljs-string">&quot;Leo Li&quot;</span>,<br>  <span class="hljs-string">&quot;text&quot;</span> : <span class="hljs-string">&quot;other hello test ...&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="探查示例"><a href="#探查示例" class="headerlink" title="探查示例"></a>探查示例</h4><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs gradle">GET <span class="hljs-regexp">/my_index/my</span>_type<span class="hljs-regexp">/1/</span>_termvectors<br>&#123;<br>  <span class="hljs-string">&quot;fields&quot;</span> : [<span class="hljs-string">&quot;text&quot;</span>],<br>  <span class="hljs-string">&quot;offsets&quot;</span> : <span class="hljs-keyword">true</span>,<br>  <span class="hljs-string">&quot;payloads&quot;</span> : <span class="hljs-keyword">true</span>,<br>  <span class="hljs-string">&quot;positions&quot;</span> : <span class="hljs-keyword">true</span>,<br>  <span class="hljs-string">&quot;term_statistics&quot;</span> : <span class="hljs-keyword">true</span>,<br>  <span class="hljs-string">&quot;field_statistics&quot;</span> : <span class="hljs-keyword">true</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;my_index&quot;</span>,<br>  <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;my_type&quot;</span>,<br>  <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>,<br>  <span class="hljs-attr">&quot;_version&quot;</span>: <span class="hljs-number">1</span>,<br>  <span class="hljs-attr">&quot;found&quot;</span>: <span class="hljs-literal">true</span>,<br>  <span class="hljs-attr">&quot;took&quot;</span>: <span class="hljs-number">10</span>,<br>  <span class="hljs-attr">&quot;term_vectors&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;text&quot;</span>: &#123;<br>      <span class="hljs-attr">&quot;field_statistics&quot;</span>: &#123;<br>        <span class="hljs-attr">&quot;sum_doc_freq&quot;</span>: <span class="hljs-number">6</span>,<br>        <span class="hljs-attr">&quot;doc_count&quot;</span>: <span class="hljs-number">2</span>,<br>        <span class="hljs-attr">&quot;sum_ttf&quot;</span>: <span class="hljs-number">8</span><br>      &#125;,<br>      <span class="hljs-attr">&quot;terms&quot;</span>: &#123;<br>        <span class="hljs-attr">&quot;hello&quot;</span>: &#123;<br>          <span class="hljs-attr">&quot;doc_freq&quot;</span>: <span class="hljs-number">2</span>,<br>          <span class="hljs-attr">&quot;ttf&quot;</span>: <span class="hljs-number">2</span>,<br>          <span class="hljs-attr">&quot;term_freq&quot;</span>: <span class="hljs-number">1</span>,<br>          <span class="hljs-attr">&quot;tokens&quot;</span>: [<br>            &#123;<br>              <span class="hljs-attr">&quot;position&quot;</span>: <span class="hljs-number">0</span>,<br>              <span class="hljs-attr">&quot;start_offset&quot;</span>: <span class="hljs-number">0</span>,<br>              <span class="hljs-attr">&quot;end_offset&quot;</span>: <span class="hljs-number">5</span>,<br>              <span class="hljs-attr">&quot;payload&quot;</span>: <span class="hljs-string">&quot;d29yZA==&quot;</span><br>            &#125;<br>          ]<br>        &#125;,<br>        <span class="hljs-attr">&quot;test&quot;</span>: &#123;<br>          <span class="hljs-attr">&quot;doc_freq&quot;</span>: <span class="hljs-number">2</span>,<br>          <span class="hljs-attr">&quot;ttf&quot;</span>: <span class="hljs-number">4</span>,<br>          <span class="hljs-attr">&quot;term_freq&quot;</span>: <span class="hljs-number">3</span>,<br>          <span class="hljs-attr">&quot;tokens&quot;</span>: [<br>            &#123;<br>              <span class="hljs-attr">&quot;position&quot;</span>: <span class="hljs-number">1</span>,<br>              <span class="hljs-attr">&quot;start_offset&quot;</span>: <span class="hljs-number">6</span>,<br>              <span class="hljs-attr">&quot;end_offset&quot;</span>: <span class="hljs-number">10</span>,<br>              <span class="hljs-attr">&quot;payload&quot;</span>: <span class="hljs-string">&quot;d29yZA==&quot;</span><br>            &#125;,<br>            &#123;<br>              <span class="hljs-attr">&quot;position&quot;</span>: <span class="hljs-number">2</span>,<br>              <span class="hljs-attr">&quot;start_offset&quot;</span>: <span class="hljs-number">11</span>,<br>              <span class="hljs-attr">&quot;end_offset&quot;</span>: <span class="hljs-number">15</span>,<br>              <span class="hljs-attr">&quot;payload&quot;</span>: <span class="hljs-string">&quot;d29yZA==&quot;</span><br>            &#125;,<br>            &#123;<br>              <span class="hljs-attr">&quot;position&quot;</span>: <span class="hljs-number">3</span>,<br>              <span class="hljs-attr">&quot;start_offset&quot;</span>: <span class="hljs-number">16</span>,<br>              <span class="hljs-attr">&quot;end_offset&quot;</span>: <span class="hljs-number">20</span>,<br>              <span class="hljs-attr">&quot;payload&quot;</span>: <span class="hljs-string">&quot;d29yZA==&quot;</span><br>            &#125;<br>          ]<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="query-time-term-vector"><a href="#query-time-term-vector" class="headerlink" title="query-time term vector"></a>query-time term vector</h4><p>一般来说如果条件允许，直接使用query time的term vector就可以。</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs gradle">GET <span class="hljs-regexp">/my_index/my</span>_type<span class="hljs-regexp">/1/</span>_termvectors<br>&#123;<br>  <span class="hljs-string">&quot;fields&quot;</span> : [<span class="hljs-string">&quot;fullname&quot;</span>],<br>  <span class="hljs-string">&quot;offsets&quot;</span> : <span class="hljs-keyword">true</span>,<br>  <span class="hljs-string">&quot;positions&quot;</span> : <span class="hljs-keyword">true</span>,<br>  <span class="hljs-string">&quot;term_statistics&quot;</span> : <span class="hljs-keyword">true</span>,<br>  <span class="hljs-string">&quot;field_statistics&quot;</span> : <span class="hljs-keyword">true</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="手动指定doc的term-vector"><a href="#手动指定doc的term-vector" class="headerlink" title="手动指定doc的term vector"></a>手动指定doc的term vector</h4><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs gradle">GET <span class="hljs-regexp">/my_index/my</span>_type/_termvectors<br>&#123;<br>  <span class="hljs-string">&quot;doc&quot;</span> : &#123;<br>    <span class="hljs-string">&quot;fullname&quot;</span> : <span class="hljs-string">&quot;Leo Li&quot;</span>,<br>    <span class="hljs-string">&quot;text&quot;</span> : <span class="hljs-string">&quot;hello test test test&quot;</span><br>  &#125;,<br>  <span class="hljs-string">&quot;fields&quot;</span> : [<span class="hljs-string">&quot;text&quot;</span>],<br>  <span class="hljs-string">&quot;offsets&quot;</span> : <span class="hljs-keyword">true</span>,<br>  <span class="hljs-string">&quot;payloads&quot;</span> : <span class="hljs-keyword">true</span>,<br>  <span class="hljs-string">&quot;positions&quot;</span> : <span class="hljs-keyword">true</span>,<br>  <span class="hljs-string">&quot;term_statistics&quot;</span> : <span class="hljs-keyword">true</span>,<br>  <span class="hljs-string">&quot;field_statistics&quot;</span> : <span class="hljs-keyword">true</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>手动指定一个doc，实际上不是要指定doc，而是要指定你想要探查的词条，比如需要探查hello test，那么就可以放在一个field中。es会将这些hello test进行分词，然后对每个term，都去计算它在现有的所有doc中的一些统计信息，即手动指定要探查的term的数据情况。</p>
<h4 id="手动指定analyzer来生成term-vector"><a href="#手动指定analyzer来生成term-vector" class="headerlink" title="手动指定analyzer来生成term vector"></a>手动指定analyzer来生成term vector</h4><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs gradle">GET <span class="hljs-regexp">/my_index/my</span>_type/_termvectors<br>&#123;<br>  <span class="hljs-string">&quot;doc&quot;</span> : &#123;<br>    <span class="hljs-string">&quot;fullname&quot;</span> : <span class="hljs-string">&quot;Leo Li&quot;</span>,<br>    <span class="hljs-string">&quot;text&quot;</span> : <span class="hljs-string">&quot;hello test test test&quot;</span><br>  &#125;,<br>  <span class="hljs-string">&quot;fields&quot;</span> : [<span class="hljs-string">&quot;text&quot;</span>],<br>  <span class="hljs-string">&quot;offsets&quot;</span> : <span class="hljs-keyword">true</span>,<br>  <span class="hljs-string">&quot;payloads&quot;</span> : <span class="hljs-keyword">true</span>,<br>  <span class="hljs-string">&quot;positions&quot;</span> : <span class="hljs-keyword">true</span>,<br>  <span class="hljs-string">&quot;term_statistics&quot;</span> : <span class="hljs-keyword">true</span>,<br>  <span class="hljs-string">&quot;field_statistics&quot;</span> : <span class="hljs-keyword">true</span>,<br>  <span class="hljs-string">&quot;per_field_analyzer&quot;</span> : &#123;<br>    <span class="hljs-string">&quot;text&quot;</span>: <span class="hljs-string">&quot;standard&quot;</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="terms-filter"><a href="#terms-filter" class="headerlink" title="terms filter"></a>terms filter</h4><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs gradle">GET <span class="hljs-regexp">/my_index/my</span>_type/_termvectors<br>&#123;<br>  <span class="hljs-string">&quot;doc&quot;</span> : &#123;<br>    <span class="hljs-string">&quot;fullname&quot;</span> : <span class="hljs-string">&quot;Leo Li&quot;</span>,<br>    <span class="hljs-string">&quot;text&quot;</span> : <span class="hljs-string">&quot;hello test test test&quot;</span><br>  &#125;,<br>  <span class="hljs-string">&quot;fields&quot;</span> : [<span class="hljs-string">&quot;text&quot;</span>],<br>  <span class="hljs-string">&quot;offsets&quot;</span> : <span class="hljs-keyword">true</span>,<br>  <span class="hljs-string">&quot;payloads&quot;</span> : <span class="hljs-keyword">true</span>,<br>  <span class="hljs-string">&quot;positions&quot;</span> : <span class="hljs-keyword">true</span>,<br>  <span class="hljs-string">&quot;term_statistics&quot;</span> : <span class="hljs-keyword">true</span>,<br>  <span class="hljs-string">&quot;field_statistics&quot;</span> : <span class="hljs-keyword">true</span>,<br>  <span class="hljs-string">&quot;filter&quot;</span> : &#123;<br>      <span class="hljs-string">&quot;max_num_terms&quot;</span> : <span class="hljs-number">3</span>,<br>      <span class="hljs-string">&quot;min_term_freq&quot;</span> : <span class="hljs-number">1</span>,<br>      <span class="hljs-string">&quot;min_doc_freq&quot;</span> : <span class="hljs-number">1</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这个就是说，根据term统计信息，过滤出你想要看到的term vector统计结果<br>也挺有用的，比如你探查数据把，可以过滤掉一些出现频率过低的term，就不考虑了</p>
<h4 id="multi-term-vector"><a href="#multi-term-vector" class="headerlink" title="multi term vector"></a>multi term vector</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-builtin-name">GET</span> _mtermvectors<br>&#123;<br>   <span class="hljs-string">&quot;docs&quot;</span>: [<br>      &#123;<br>         <span class="hljs-string">&quot;_index&quot;</span>: <span class="hljs-string">&quot;my_index&quot;</span>,<br>         <span class="hljs-string">&quot;_type&quot;</span>: <span class="hljs-string">&quot;my_type&quot;</span>,<br>         <span class="hljs-string">&quot;_id&quot;</span>: <span class="hljs-string">&quot;2&quot;</span>,<br>         <span class="hljs-string">&quot;term_statistics&quot;</span>: <span class="hljs-literal">true</span><br>      &#125;,<br>      &#123;<br>         <span class="hljs-string">&quot;_index&quot;</span>: <span class="hljs-string">&quot;my_index&quot;</span>,<br>         <span class="hljs-string">&quot;_type&quot;</span>: <span class="hljs-string">&quot;my_type&quot;</span>,<br>         <span class="hljs-string">&quot;_id&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>,<br>         <span class="hljs-string">&quot;fields&quot;</span>: [<br>            <span class="hljs-string">&quot;text&quot;</span><br>         ]<br>      &#125;<br>   ]<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs gradle">GET <span class="hljs-regexp">/my_index/</span>_mtermvectors<br>&#123;<br>   <span class="hljs-string">&quot;docs&quot;</span>: [<br>      &#123;<br>         <span class="hljs-string">&quot;_type&quot;</span>: <span class="hljs-string">&quot;test&quot;</span>,<br>         <span class="hljs-string">&quot;_id&quot;</span>: <span class="hljs-string">&quot;2&quot;</span>,<br>         <span class="hljs-string">&quot;fields&quot;</span>: [<br>            <span class="hljs-string">&quot;text&quot;</span><br>         ],<br>         <span class="hljs-string">&quot;term_statistics&quot;</span>: <span class="hljs-keyword">true</span><br>      &#125;,<br>      &#123;<br>         <span class="hljs-string">&quot;_type&quot;</span>: <span class="hljs-string">&quot;test&quot;</span>,<br>         <span class="hljs-string">&quot;_id&quot;</span>: <span class="hljs-string">&quot;1&quot;</span><br>      &#125;<br>   ]<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs gradle">GET <span class="hljs-regexp">/my_index/my</span>_type/_mtermvectors<br>&#123;<br>   <span class="hljs-string">&quot;docs&quot;</span>: [<br>      &#123;<br>         <span class="hljs-string">&quot;_id&quot;</span>: <span class="hljs-string">&quot;2&quot;</span>,<br>         <span class="hljs-string">&quot;fields&quot;</span>: [<br>            <span class="hljs-string">&quot;text&quot;</span><br>         ],<br>         <span class="hljs-string">&quot;term_statistics&quot;</span>: <span class="hljs-keyword">true</span><br>      &#125;,<br>      &#123;<br>         <span class="hljs-string">&quot;_id&quot;</span>: <span class="hljs-string">&quot;1&quot;</span><br>      &#125;<br>   ]<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-builtin-name">GET</span> /_mtermvectors<br>&#123;<br>   <span class="hljs-string">&quot;docs&quot;</span>: [<br>      &#123;<br>         <span class="hljs-string">&quot;_index&quot;</span>: <span class="hljs-string">&quot;my_index&quot;</span>,<br>         <span class="hljs-string">&quot;_type&quot;</span>: <span class="hljs-string">&quot;my_type&quot;</span>,<br>         <span class="hljs-string">&quot;doc&quot;</span> : &#123;<br>            <span class="hljs-string">&quot;fullname&quot;</span> : <span class="hljs-string">&quot;Leo Li&quot;</span>,<br>            <span class="hljs-string">&quot;text&quot;</span> : <span class="hljs-string">&quot;hello test test test&quot;</span><br>         &#125;<br>      &#125;,<br>      &#123;<br>         <span class="hljs-string">&quot;_index&quot;</span>: <span class="hljs-string">&quot;my_index&quot;</span>,<br>         <span class="hljs-string">&quot;_type&quot;</span>: <span class="hljs-string">&quot;my_type&quot;</span>,<br>         <span class="hljs-string">&quot;doc&quot;</span> : &#123;<br>           <span class="hljs-string">&quot;fullname&quot;</span> : <span class="hljs-string">&quot;Leo Li&quot;</span>,<br>           <span class="hljs-string">&quot;text&quot;</span> : <span class="hljs-string">&quot;other hello test ...&quot;</span><br>         &#125;<br>      &#125;<br>   ]<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="数据建模"><a href="#数据建模" class="headerlink" title="数据建模"></a>数据建模</h3><h4 id="关系型与document类型数据模型对比"><a href="#关系型与document类型数据模型对比" class="headerlink" title="关系型与document类型数据模型对比"></a>关系型与document类型数据模型对比</h4><p>比如员工数据模型</p>
<p>java对象如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Department</span> </span>&#123;<br>	<br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">Integer</span> deptId;<br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">String</span> name;<br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">String</span> desc;<br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">List</span>&lt;Employee&gt; employees;<br><br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Employee</span> </span>&#123;<br>	<br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">Integer</span> empId;<br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">String</span> name;<br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">Integer</span> age;<br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">String</span> gender;<br>	<span class="hljs-keyword">private</span> Department dept;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>在关系型数据库中需要两张表通过外键关联</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">department表<br><br>dept_id<br><span class="hljs-type">name</span><br><span class="hljs-keyword">desc</span><br><br>employee表<br><br>emp_id<br><span class="hljs-type">name</span><br>age<br>gender<br>dept_id<br></code></pre></td></tr></table></figure>

<p>es中的文档数据模型</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>	<span class="hljs-attr">&quot;deptId&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>,<br>	<span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;研发部门&quot;</span>,<br>	<span class="hljs-attr">&quot;desc&quot;</span>: <span class="hljs-string">&quot;负责公司的所有研发项目&quot;</span>,<br>	<span class="hljs-attr">&quot;employees&quot;</span>: [<br>		&#123;<br>			<span class="hljs-attr">&quot;empId&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>,<br>			<span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;张三&quot;</span>,<br>			<span class="hljs-attr">&quot;age&quot;</span>: <span class="hljs-number">28</span>,<br>			<span class="hljs-attr">&quot;gender&quot;</span>: <span class="hljs-string">&quot;男&quot;</span><br>		&#125;,<br>		&#123;<br>			<span class="hljs-attr">&quot;empId&quot;</span>: <span class="hljs-string">&quot;2&quot;</span>,<br>			<span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;王兰&quot;</span>,<br>			<span class="hljs-attr">&quot;age&quot;</span>: <span class="hljs-number">25</span>,<br>			<span class="hljs-attr">&quot;gender&quot;</span>: <span class="hljs-string">&quot;女&quot;</span><br>		&#125;,<br>		&#123;<br>			<span class="hljs-attr">&quot;empId&quot;</span>: <span class="hljs-string">&quot;3&quot;</span>,<br>			<span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;李四&quot;</span>,<br>			<span class="hljs-attr">&quot;age&quot;</span>: <span class="hljs-number">34</span>,<br>			<span class="hljs-attr">&quot;gender&quot;</span>: <span class="hljs-string">&quot;男&quot;</span><br>		&#125;<br>	]<br>&#125;<br></code></pre></td></tr></table></figure>

<p>es更加类似于面向对象的数据模型，将所有由关联关系的数据，放在一个doc json类型数据中，整个数据的关系，还有完整的数据，都放在了一起。</p>
<h4 id="博客网站案例"><a href="#博客网站案例" class="headerlink" title="博客网站案例"></a>博客网站案例</h4><p>构造用户与博客数据</p>
<p>在构造数据模型的时候，还是将有关联关系的数据，然后分割为不同的实体，类似于关系型数据库中的模型</p>
<p>案例背景：博客网站， 我们会模拟各种用户发表各种博客，然后针对用户和博客之间的关系进行数据建模，同时针对建模好的数据执行各种搜索/聚合的操作</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs awk">PUT <span class="hljs-regexp">/website/u</span>sers/<span class="hljs-number">1</span> <br>&#123;<br>  <span class="hljs-string">&quot;name&quot;</span>:     <span class="hljs-string">&quot;小鱼儿&quot;</span>,<br>  <span class="hljs-string">&quot;email&quot;</span>:    <span class="hljs-string">&quot;xiaoyuer@sina.com&quot;</span>,<br>  <span class="hljs-string">&quot;birthday&quot;</span>:      <span class="hljs-string">&quot;1980-01-01&quot;</span><br>&#125;<br><br>PUT <span class="hljs-regexp">/website/</span>blogs/<span class="hljs-number">1</span><br>&#123;<br>  <span class="hljs-string">&quot;title&quot;</span>:    <span class="hljs-string">&quot;我的第一篇博客&quot;</span>,<br>  <span class="hljs-string">&quot;content&quot;</span>:     <span class="hljs-string">&quot;这是我的第一篇博客，开通啦！！！&quot;</span><br>  <span class="hljs-string">&quot;userId&quot;</span>:     <span class="hljs-number">1</span> <br>&#125;<br></code></pre></td></tr></table></figure>

<p>一个用户对应多个博客，一对多的关系，做了建模</p>
<h5 id="建模方式1"><a href="#建模方式1" class="headerlink" title="建模方式1"></a>建模方式1</h5><p>分割实体，用类似三范式的方式，使用主外键关联关系，将多个实体关联起来</p>
<p>搜索小鱼儿发表的所有博客</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs gradle">GET <span class="hljs-regexp">/website/u</span>sers/_search <br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;term&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;name.keyword&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-string">&quot;小鱼儿&quot;</span><br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br><br>&#123;<br>  <span class="hljs-string">&quot;took&quot;</span>: <span class="hljs-number">91</span>,<br>  <span class="hljs-string">&quot;timed_out&quot;</span>: <span class="hljs-keyword">false</span>,<br>  <span class="hljs-string">&quot;_shards&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;total&quot;</span>: <span class="hljs-number">5</span>,<br>    <span class="hljs-string">&quot;successful&quot;</span>: <span class="hljs-number">5</span>,<br>    <span class="hljs-string">&quot;failed&quot;</span>: <span class="hljs-number">0</span><br>  &#125;,<br>  <span class="hljs-string">&quot;hits&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;total&quot;</span>: <span class="hljs-number">1</span>,<br>    <span class="hljs-string">&quot;max_score&quot;</span>: <span class="hljs-number">0.2876821</span>,<br>    <span class="hljs-string">&quot;hits&quot;</span>: [<br>      &#123;<br>        <span class="hljs-string">&quot;_index&quot;</span>: <span class="hljs-string">&quot;website&quot;</span>,<br>        <span class="hljs-string">&quot;_type&quot;</span>: <span class="hljs-string">&quot;users&quot;</span>,<br>        <span class="hljs-string">&quot;_id&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>,<br>        <span class="hljs-string">&quot;_score&quot;</span>: <span class="hljs-number">0.2876821</span>,<br>        <span class="hljs-string">&quot;_source&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;小鱼儿&quot;</span>,<br>          <span class="hljs-string">&quot;email&quot;</span>: <span class="hljs-string">&quot;xiaoyuer@sina.com&quot;</span>,<br>          <span class="hljs-string">&quot;birthday&quot;</span>: <span class="hljs-string">&quot;1980-01-01&quot;</span><br>        &#125;<br>      &#125;<br>    ]<br>  &#125;<br>&#125;<br><br><br></code></pre></td></tr></table></figure>

<p>比如这里搜索的是，1万个用户的博客，可能第一次搜索，会得到1万个userId</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/website/</span>blogs/_search <br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;constant_score&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;filter&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;terms&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;userId&quot;</span>: [<br>            <span class="hljs-number">1</span><br>          ]<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>第二次搜索的时候，要放入terms中1万个userId，才能进行搜索，这个时候性能比较差了</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;took&quot;</span>: <span class="hljs-number">4</span>,<br>  <span class="hljs-attr">&quot;timed_out&quot;</span>: <span class="hljs-literal">false</span>,<br>  <span class="hljs-attr">&quot;_shards&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">5</span>,<br>    <span class="hljs-attr">&quot;successful&quot;</span>: <span class="hljs-number">5</span>,<br>    <span class="hljs-attr">&quot;failed&quot;</span>: <span class="hljs-number">0</span><br>  &#125;,<br>  <span class="hljs-attr">&quot;hits&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span>: <span class="hljs-number">1</span>,<br>    <span class="hljs-attr">&quot;max_score&quot;</span>: <span class="hljs-number">1</span>,<br>    <span class="hljs-attr">&quot;hits&quot;</span>: [<br>      &#123;<br>        <span class="hljs-attr">&quot;_index&quot;</span>: <span class="hljs-string">&quot;website&quot;</span>,<br>        <span class="hljs-attr">&quot;_type&quot;</span>: <span class="hljs-string">&quot;blogs&quot;</span>,<br>        <span class="hljs-attr">&quot;_id&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>,<br>        <span class="hljs-attr">&quot;_score&quot;</span>: <span class="hljs-number">1</span>,<br>        <span class="hljs-attr">&quot;_source&quot;</span>: &#123;<br>          <span class="hljs-attr">&quot;title&quot;</span>: <span class="hljs-string">&quot;小鱼儿的第一篇博客&quot;</span>,<br>          <span class="hljs-attr">&quot;content&quot;</span>: <span class="hljs-string">&quot;大家好，我是小鱼儿，这是我写的第一篇博客！&quot;</span>,<br>          <span class="hljs-attr">&quot;userId&quot;</span>: <span class="hljs-number">1</span><br>        &#125;<br>      &#125;<br>    ]<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>上面的操作，就属于应用层的join，在应用层先查出一份数据，然后再查出一份数据，进行关联</p>
<p>优点和缺点</p>
<p>优点：数据不冗余，维护方便<br>缺点：应用层join，如果关联数据过多，导致查询过大，性能很差</p>
<h5 id="建模方式2"><a href="#建模方式2" class="headerlink" title="建模方式2"></a>建模方式2</h5><p>构造冗余的用户和博客数据</p>
<p>第二种建模方式：用冗余数据，采用文档数据模型，进行数据建模，实现用户和博客的关联</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs awk">PUT <span class="hljs-regexp">/website/u</span>sers/<span class="hljs-number">1</span><br>&#123;<br>  <span class="hljs-string">&quot;name&quot;</span>:     <span class="hljs-string">&quot;小鱼儿&quot;</span>,<br>  <span class="hljs-string">&quot;email&quot;</span>:    <span class="hljs-string">&quot;xiaoyuer@sina.com&quot;</span>,<br>  <span class="hljs-string">&quot;birthday&quot;</span>:      <span class="hljs-string">&quot;1980-01-01&quot;</span><br>&#125;<br><br>PUT <span class="hljs-regexp">/website/</span>blogs/<span class="hljs-number">1</span><br>&#123;<br>  <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;小鱼儿的第一篇博客&quot;</span>,<br>  <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;大家好，我是小鱼儿。。。&quot;</span>,<br>  <span class="hljs-string">&quot;userInfo&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;userId&quot;</span>: <span class="hljs-number">1</span>,<br>    <span class="hljs-string">&quot;username&quot;</span>: <span class="hljs-string">&quot;小鱼儿&quot;</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>冗余数据，就是说，将可能会进行搜索的条件和要搜索的数据，放在一个doc中</p>
<p>2、基于冗余用户数据搜索博客</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/website/</span>blogs/_search <br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;term&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;userInfo.username.keyword&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-string">&quot;小鱼儿&quot;</span><br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>就不需要走应用层的join，先搜一个数据，找到id，再去搜另一份数据</p>
<p>直接走一个有冗余数据的type即可，指定要的搜索条件，即可搜索出自己想要的数据来</p>
<p>3、优点和缺点</p>
<p>优点：性能高，不需要执行两次搜索<br>缺点：数据冗余，维护成本高，每次如果你的username变化了，同时要更新user type和blog type。</p>
<p>一般来说，对于es这种NoSQL类型的数据存储来讲，都是冗余模式。当然维护数据的关联关系也是很有必要的，一旦出现冗余数据的修改，必须记得将所有关联的数据全部更新</p>
<h5 id="分组查询"><a href="#分组查询" class="headerlink" title="分组查询"></a>分组查询</h5><p>1、构造更多测试数据</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs awk">PUT <span class="hljs-regexp">/website/u</span>sers/<span class="hljs-number">3</span><br>&#123;<br>  <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;黄药师&quot;</span>,<br>  <span class="hljs-string">&quot;email&quot;</span>: <span class="hljs-string">&quot;huangyaoshi@sina.com&quot;</span>,<br>  <span class="hljs-string">&quot;birthday&quot;</span>: <span class="hljs-string">&quot;1970-10-24&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs awk">PUT <span class="hljs-regexp">/website/</span>blogs/<span class="hljs-number">3</span><br>&#123;<br>  <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;我是黄药师&quot;</span>,<br>  <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;我是黄药师啊！！！&quot;</span>,<br>  <span class="hljs-string">&quot;userInfo&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;userId&quot;</span>: <span class="hljs-number">1</span>,<br>    <span class="hljs-string">&quot;userName&quot;</span>: <span class="hljs-string">&quot;黄药师&quot;</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs awk">PUT <span class="hljs-regexp">/website/u</span>sers/<span class="hljs-number">2</span><br>&#123;<br>  <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;花无缺&quot;</span>,<br>  <span class="hljs-string">&quot;email&quot;</span>: <span class="hljs-string">&quot;huawuque@sina.com&quot;</span>,<br>  <span class="hljs-string">&quot;birthday&quot;</span>: <span class="hljs-string">&quot;1980-02-02&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs awk">PUT <span class="hljs-regexp">/website/</span>blogs/<span class="hljs-number">4</span><br>&#123;<br>  <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;花无缺的身世揭秘&quot;</span>,<br>  <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;大家好，我是花无缺，所以我的身世是。。。&quot;</span>,<br>  <span class="hljs-string">&quot;userInfo&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;userId&quot;</span>: <span class="hljs-number">2</span>,<br>    <span class="hljs-string">&quot;userName&quot;</span>: <span class="hljs-string">&quot;花无缺&quot;</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>2、对每个用户发表的博客进行分组</p>
<p>比如说，小鱼儿发表的那些博客，花无缺发表了哪些博客，黄药师发表了哪些博客</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/website/</span>blogs/_search <br>&#123;<br>  <span class="hljs-string">&quot;size&quot;</span>: <span class="hljs-number">0</span>, <br>  <span class="hljs-string">&quot;aggs&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;group_by_username&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;terms&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;userInfo.username.keyword&quot;</span><br>      &#125;,<br>      <span class="hljs-string">&quot;aggs&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;top_blogs&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;top_hits&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;_source&quot;</span>: &#123;<br>              <span class="hljs-string">&quot;include&quot;</span>: <span class="hljs-string">&quot;title&quot;</span><br>            &#125;, <br>            <span class="hljs-string">&quot;size&quot;</span>: <span class="hljs-number">5</span><br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="java-api"><a href="#java-api" class="headerlink" title="java api"></a>java api</h3><h4 id="client集群自动探查"><a href="#client集群自动探查" class="headerlink" title="client集群自动探查"></a>client集群自动探查</h4><p>默认情况下，es是根据手动指定的节点，代码如下：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">TransportClient client = <span class="hljs-keyword">new</span> <span class="hljs-constructor">PreBuiltTransportClient(<span class="hljs-params">settings</span>)</span><br>				.add<span class="hljs-constructor">TransportAddress(<span class="hljs-params">new</span> InetSocketTransportAddress(InetAddress.<span class="hljs-params">getByName</span>(<span class="hljs-string">&quot;localhost1&quot;</span>)</span>, <span class="hljs-number">9300</span>))<br>				.add<span class="hljs-constructor">TransportAddress(<span class="hljs-params">new</span> InetSocketTransportAddress(InetAddress.<span class="hljs-params">getByName</span>(<span class="hljs-string">&quot;localhost2&quot;</span>)</span>, <span class="hljs-number">9300</span>))<br>				.add<span class="hljs-constructor">TransportAddress(<span class="hljs-params">new</span> InetSocketTransportAddress(InetAddress.<span class="hljs-params">getByName</span>(<span class="hljs-string">&quot;localhost3&quot;</span>)</span>, <span class="hljs-number">9300</span>));<br></code></pre></td></tr></table></figure>

<p>es会依次轮询节点发送请求，但如果节点过多，手动指定是非常麻烦的，所以es client提供了集群节点自动探查的功能，通过集群状态自动获取当前集群中的所有data node，然后用这份完整的列表更新自己内部要发送请求的node list。默认每隔5秒钟，就会更新一次node list。</p>
<p>注意，es cilent是不会将Master node纳入node list的，因为要避免给master node发送搜索等请求。</p>
<p>使用自动探查之后，直接指定几个master node，或者1个node就好了，client会自动去探查集群的所有节点，而且每隔5秒还会自动刷新。</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">Settings settings = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Settings</span>.</span></span>builder<span class="hljs-literal">()</span><br>        .put(<span class="hljs-string">&quot;client.transport.sniff&quot;</span>, <span class="hljs-literal">true</span>).build<span class="hljs-literal">()</span>;<br>TransportClient client = <span class="hljs-keyword">new</span> <span class="hljs-constructor">PreBuiltTransportClient(<span class="hljs-params">settings</span>)</span>;<br></code></pre></td></tr></table></figure>

<p>使用上述的settings配置，将client.transport.sniff设置为true即可打开集群节点自动探查功能</p>
<h4 id="upsert操作"><a href="#upsert操作" class="headerlink" title="upsert操作"></a>upsert操作</h4><p>建立汽车的数据结构</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs dts">PUT /car_shop<br>&#123;<br>    <span class="hljs-string">&quot;mappings&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;cars&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;brand&quot;</span>: &#123;<br>                    <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span>,<br>                    <span class="hljs-string">&quot;analyzer&quot;</span>: <span class="hljs-string">&quot;ik_max_word&quot;</span>,<br>                    <span class="hljs-string">&quot;fields&quot;</span>: &#123;<br>                        <span class="hljs-string">&quot;raw&quot;</span>: &#123;<br>                            <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;keyword&quot;</span><br>                        &#125;<br>                    &#125;<br>                &#125;,<br>                <span class="hljs-string">&quot;name&quot;</span>: &#123;<br>                    <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span>,<br>                    <span class="hljs-string">&quot;analyzer&quot;</span>: <span class="hljs-string">&quot;ik_max_word&quot;</span>,<br>                    <span class="hljs-string">&quot;fields&quot;</span>: &#123;<br>                        <span class="hljs-string">&quot;raw&quot;</span>: &#123;<br>                            <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;keyword&quot;</span><br>                        &#125;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>使用upsert语法，如果这个汽车的信息之前不存在，那么就insert，如果存在，那么就update</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">IndexRequest indexRequest = <span class="hljs-keyword">new</span> <span class="hljs-constructor">IndexRequest(<span class="hljs-string">&quot;car_shop&quot;</span>, <span class="hljs-string">&quot;cars&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>)</span><br>        .source(json<span class="hljs-constructor">Builder()</span><br>            .start<span class="hljs-constructor">Object()</span><br>                .field(<span class="hljs-string">&quot;brand&quot;</span>, <span class="hljs-string">&quot;宝马&quot;</span>)<br>                .field(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;宝马320&quot;</span>)<br>                .field(<span class="hljs-string">&quot;price&quot;</span>, <span class="hljs-number">320000</span>)<br>                .field(<span class="hljs-string">&quot;produce_date&quot;</span>, <span class="hljs-string">&quot;2017-01-01&quot;</span>)<br>            .<span class="hljs-keyword">end</span><span class="hljs-constructor">Object()</span>);<br><br>UpdateRequest updateRequest = <span class="hljs-keyword">new</span> <span class="hljs-constructor">UpdateRequest(<span class="hljs-string">&quot;car_shop&quot;</span>, <span class="hljs-string">&quot;cars&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>)</span><br>        .doc(json<span class="hljs-constructor">Builder()</span><br>            .start<span class="hljs-constructor">Object()</span><br>                .field(<span class="hljs-string">&quot;price&quot;</span>, <span class="hljs-number">320000</span>)<br>            .<span class="hljs-keyword">end</span><span class="hljs-constructor">Object()</span>)<br>        .upsert(indexRequest);       <br>               <br>client.update(updateRequest).get<span class="hljs-literal">()</span>;<br><br>IndexRequest indexRequest = <span class="hljs-keyword">new</span> <span class="hljs-constructor">IndexRequest(<span class="hljs-string">&quot;car_shop&quot;</span>, <span class="hljs-string">&quot;cars&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>)</span><br>        .source(json<span class="hljs-constructor">Builder()</span><br>            .start<span class="hljs-constructor">Object()</span><br>                .field(<span class="hljs-string">&quot;brand&quot;</span>, <span class="hljs-string">&quot;宝马&quot;</span>)<br>                .field(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;宝马320&quot;</span>)<br>                .field(<span class="hljs-string">&quot;price&quot;</span>, <span class="hljs-number">310000</span>)<br>                .field(<span class="hljs-string">&quot;produce_date&quot;</span>, <span class="hljs-string">&quot;2017-01-01&quot;</span>)<br>            .<span class="hljs-keyword">end</span><span class="hljs-constructor">Object()</span>);<br>UpdateRequest updateRequest = <span class="hljs-keyword">new</span> <span class="hljs-constructor">UpdateRequest(<span class="hljs-string">&quot;car_shop&quot;</span>, <span class="hljs-string">&quot;cars&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>)</span><br>        .doc(json<span class="hljs-constructor">Builder()</span><br>            .start<span class="hljs-constructor">Object()</span><br>                .field(<span class="hljs-string">&quot;price&quot;</span>, <span class="hljs-number">310000</span>)<br>            .<span class="hljs-keyword">end</span><span class="hljs-constructor">Object()</span>)<br>        .upsert(indexRequest);              <br>client.update(updateRequest).get<span class="hljs-literal">()</span>;<br></code></pre></td></tr></table></figure>

<h4 id="mget操作"><a href="#mget操作" class="headerlink" title="mget操作"></a>mget操作</h4><p>mget，可以一次性将多个document的数据查询出来，放在一起显示。</p>
<p>放入数据：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs awk">PUT <span class="hljs-regexp">/car_shop/</span>cars/<span class="hljs-number">2</span><br>&#123;<br>	<span class="hljs-string">&quot;brand&quot;</span>: <span class="hljs-string">&quot;奔驰&quot;</span>,<br>	<span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;奔驰C200&quot;</span>,<br>	<span class="hljs-string">&quot;price&quot;</span>: <span class="hljs-number">350000</span>,<br>	<span class="hljs-string">&quot;produce_date&quot;</span>: <span class="hljs-string">&quot;2017-01-05&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs routeros">MultiGetResponse multiGetItemResponses = client.prepareMultiGet()<br>    .<span class="hljs-builtin-name">add</span>(<span class="hljs-string">&quot;car_shop&quot;</span>, <span class="hljs-string">&quot;cars&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>)           <br>    .<span class="hljs-builtin-name">add</span>(<span class="hljs-string">&quot;car_shop&quot;</span>, <span class="hljs-string">&quot;cars&quot;</span>, <span class="hljs-string">&quot;2&quot;</span>)        <br>    .<span class="hljs-builtin-name">get</span>();<br><br><span class="hljs-keyword">for</span> (MultiGetItemResponse itemResponse : multiGetItemResponses) &#123; <br>    GetResponse response = itemResponse.getResponse();<br>    <span class="hljs-keyword">if</span> (response.isExists()) &#123;                      <br>        String json = response.getSourceAsString(); <br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="bulk操作"><a href="#bulk操作" class="headerlink" title="bulk操作"></a>bulk操作</h4><p>测试数据</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs awk">PUT <span class="hljs-regexp">/car_shop/</span>sales/<span class="hljs-number">1</span><br>&#123;<br>    <span class="hljs-string">&quot;brand&quot;</span>: <span class="hljs-string">&quot;宝马&quot;</span>,<br>    <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;宝马320&quot;</span>,<br>    <span class="hljs-string">&quot;price&quot;</span>: <span class="hljs-number">320000</span>,<br>    <span class="hljs-string">&quot;produce_date&quot;</span>: <span class="hljs-string">&quot;2017-01-01&quot;</span>,<br>    <span class="hljs-string">&quot;sale_price&quot;</span>: <span class="hljs-number">300000</span>,<br>    <span class="hljs-string">&quot;sale_date&quot;</span>: <span class="hljs-string">&quot;2017-01-21&quot;</span><br>&#125;<br><br>PUT <span class="hljs-regexp">/car_shop/</span>sales/<span class="hljs-number">2</span><br>&#123;<br>    <span class="hljs-string">&quot;brand&quot;</span>: <span class="hljs-string">&quot;宝马&quot;</span>,<br>    <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;宝马320&quot;</span>,<br>    <span class="hljs-string">&quot;price&quot;</span>: <span class="hljs-number">320000</span>,<br>    <span class="hljs-string">&quot;produce_date&quot;</span>: <span class="hljs-string">&quot;2017-01-01&quot;</span>,<br>    <span class="hljs-string">&quot;sale_price&quot;</span>: <span class="hljs-number">300000</span>,<br>    <span class="hljs-string">&quot;sale_date&quot;</span>: <span class="hljs-string">&quot;2017-01-21&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>代码</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">BulkRequestBuilder bulkRequest = client.prepare<span class="hljs-constructor">Bulk()</span>;<br><br>bulkRequest.add(client.prepare<span class="hljs-constructor">Index(<span class="hljs-string">&quot;car_shop&quot;</span>, <span class="hljs-string">&quot;sales&quot;</span>, <span class="hljs-string">&quot;3&quot;</span>)</span><br>        .set<span class="hljs-constructor">Source(<span class="hljs-params">jsonBuilder</span>()</span><br>                    .start<span class="hljs-constructor">Object()</span><br>                        .field(<span class="hljs-string">&quot;brand&quot;</span>, <span class="hljs-string">&quot;奔驰&quot;</span>)<br>                        .field(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;奔驰C200&quot;</span>)<br>                        .field(<span class="hljs-string">&quot;price&quot;</span>, <span class="hljs-number">350000</span>)<br>                        .field(<span class="hljs-string">&quot;produce_date&quot;</span>, <span class="hljs-string">&quot;2017-01-05&quot;</span>)<br>                        .field(<span class="hljs-string">&quot;sale_price&quot;</span>, <span class="hljs-number">340000</span>)<br>                        .field(<span class="hljs-string">&quot;sale_date&quot;</span>, <span class="hljs-string">&quot;2017-02-03&quot;</span>)<br>                    .<span class="hljs-keyword">end</span><span class="hljs-constructor">Object()</span><br>                  )<br>        );<br><br>bulkRequest.add(client.prepare<span class="hljs-constructor">Update(<span class="hljs-string">&quot;car_shop&quot;</span>, <span class="hljs-string">&quot;sales&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>)</span><br>        .set<span class="hljs-constructor">Doc(<span class="hljs-params">jsonBuilder</span>()</span>               <br>		            .start<span class="hljs-constructor">Object()</span><br>		                .field(<span class="hljs-string">&quot;sale_price&quot;</span>, <span class="hljs-string">&quot;290000&quot;</span>)<br>		            .<span class="hljs-keyword">end</span><span class="hljs-constructor">Object()</span><br>		        )<br>        );<br><br>bulkRequest.add(client.prepare<span class="hljs-constructor">Delete(<span class="hljs-string">&quot;car_shop&quot;</span>, <span class="hljs-string">&quot;sales&quot;</span>, <span class="hljs-string">&quot;2&quot;</span>)</span>);<br><br>BulkResponse bulkResponse = bulkRequest.get<span class="hljs-literal">()</span>;<br><br><span class="hljs-keyword">for</span>(BulkItemResponse bulkItemResponse : bulkRsponse.get<span class="hljs-constructor">Items()</span>)&#123;<br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span></span>out.println(<span class="hljs-string">&quot;version&quot;</span>+bulkItemResponse.get<span class="hljs-constructor">Version()</span>);<br>&#125;<br><br>client.close<span class="hljs-literal">()</span>;<br></code></pre></td></tr></table></figure>

<h4 id="scroll操作"><a href="#scroll操作" class="headerlink" title="scroll操作"></a>scroll操作</h4><p>测试数据</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs awk">PUT <span class="hljs-regexp">/car_shop/</span>sales/<span class="hljs-number">4</span><br>&#123;<br>    <span class="hljs-string">&quot;brand&quot;</span>: <span class="hljs-string">&quot;宝马&quot;</span>,<br>    <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;宝马320&quot;</span>,<br>    <span class="hljs-string">&quot;price&quot;</span>: <span class="hljs-number">320000</span>,<br>    <span class="hljs-string">&quot;produce_date&quot;</span>: <span class="hljs-string">&quot;2017-01-01&quot;</span>,<br>    <span class="hljs-string">&quot;sale_price&quot;</span>: <span class="hljs-number">280000</span>,<br>    <span class="hljs-string">&quot;sale_date&quot;</span>: <span class="hljs-string">&quot;2017-01-25&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>2条数据，分两个批次下载完成</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">SearchResponse scrollResp = client.prepare<span class="hljs-constructor">Search(<span class="hljs-string">&quot;car_shop&quot;</span>)</span><br>		.add<span class="hljs-constructor">Types(<span class="hljs-string">&quot;sales&quot;</span>)</span><br>        .set<span class="hljs-constructor">Scroll(<span class="hljs-params">new</span> TimeValue(60000)</span>)<br>        .set<span class="hljs-constructor">Query(<span class="hljs-params">termQuery</span>(<span class="hljs-string">&quot;brand.raw&quot;</span>, <span class="hljs-string">&quot;宝马&quot;</span>)</span>)<br>        .set<span class="hljs-constructor">Size(1)</span><br>        .get<span class="hljs-literal">()</span>; <br><span class="hljs-built_in">int</span> batchCount = <span class="hljs-number">0</span>;<br><br><span class="hljs-keyword">do</span> &#123;<br>    <span class="hljs-keyword">for</span> (SearchHit hit : scrollResp.get<span class="hljs-constructor">Hits()</span>.get<span class="hljs-constructor">Hits()</span>) &#123;<br>    	<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span></span>out.println(<span class="hljs-string">&quot;batch:&quot;</span>,+ ++batchCount);<br>    	<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span></span>out.println(searchHit.get<span class="hljs-constructor">SourceAsString()</span>);<br>    &#125;<br>    <br>    scrollResp = client.prepare<span class="hljs-constructor">SearchScroll(<span class="hljs-params">scrollResp</span>.<span class="hljs-params">getScrollId</span>()</span>)<br>            .set<span class="hljs-constructor">Scroll(<span class="hljs-params">new</span> TimeValue(60000)</span>)<br>            .execute<span class="hljs-literal">()</span><br>            .action<span class="hljs-constructor">Get()</span>;<br>&#125; <span class="hljs-keyword">while</span>(scrollResp.get<span class="hljs-constructor">Hits()</span>.get<span class="hljs-constructor">Hits()</span>.length != <span class="hljs-number">0</span>);<br><br></code></pre></td></tr></table></figure>

<h4 id="search-template使用"><a href="#search-template使用" class="headerlink" title="search template使用"></a>search template使用</h4><p>在config中添加模版：page_query_by_brand.mustache</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs clojure">&#123;<br>  <span class="hljs-string">&quot;from&quot;</span>: &#123;&#123;from&#125;&#125;,<br>  <span class="hljs-string">&quot;size&quot;</span>: &#123;&#123;size&#125;&#125;,<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;brand.keyword&quot;</span>: <span class="hljs-string">&quot;&#123;&#123;brand&#125;&#125;&quot;</span> <br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>使用：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">SearchResponse sr = <span class="hljs-keyword">new</span> <span class="hljs-constructor">SearchTemplateRequestBuilder(<span class="hljs-params">client</span>)</span><br>    .set<span class="hljs-constructor">Script(<span class="hljs-string">&quot;page_query_by_brand&quot;</span>)</span>                 <br>    .set<span class="hljs-constructor">ScriptType(ScriptService.ScriptType.FILE)</span> <br>    .set<span class="hljs-constructor">ScriptParams(<span class="hljs-params">template_params</span>)</span>             <br>    .set<span class="hljs-constructor">Request(<span class="hljs-params">new</span> SearchRequest()</span>)              <br>    .get<span class="hljs-literal">()</span>                                        <br>    .get<span class="hljs-constructor">Response()</span>; <br></code></pre></td></tr></table></figure>

<h4 id="全文检索"><a href="#全文检索" class="headerlink" title="全文检索"></a>全文检索</h4><p>添加数据</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs awk">PUT <span class="hljs-regexp">/car_shop/</span>cars/<span class="hljs-number">5</span><br>&#123;<br>        <span class="hljs-string">&quot;brand&quot;</span>: <span class="hljs-string">&quot;华晨宝马&quot;</span>,<br>        <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;宝马318&quot;</span>,<br>        <span class="hljs-string">&quot;price&quot;</span>: <span class="hljs-number">270000</span>,<br>        <span class="hljs-string">&quot;produce_date&quot;</span>: <span class="hljs-string">&quot;2017-01-20&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>搜索</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-comment">// 全文检索</span><br>SearchResponse response = client.prepare<span class="hljs-constructor">Search(<span class="hljs-string">&quot;car_shop&quot;</span>)</span><br>        .set<span class="hljs-constructor">Types(<span class="hljs-string">&quot;cars&quot;</span>)</span><br>        .set<span class="hljs-constructor">Query(QueryBuilders.<span class="hljs-params">matchQuery</span>(<span class="hljs-string">&quot;brand&quot;</span>, <span class="hljs-string">&quot;宝马&quot;</span>)</span>)                <br>        .get<span class="hljs-literal">()</span>;<br><span class="hljs-comment">// 多字段搜索</span><br>SearchResponse response = client.prepare<span class="hljs-constructor">Search(<span class="hljs-string">&quot;car_shop&quot;</span>)</span><br>        .set<span class="hljs-constructor">Types(<span class="hljs-string">&quot;cars&quot;</span>)</span><br>        .set<span class="hljs-constructor">Query(QueryBuilders.<span class="hljs-params">multiMatchQuery</span>(<span class="hljs-string">&quot;宝马&quot;</span>, <span class="hljs-string">&quot;brand&quot;</span>, <span class="hljs-string">&quot;name&quot;</span>)</span>)                <br>        .get<span class="hljs-literal">()</span>;<br><span class="hljs-comment">// 精确搜索</span><br>SearchResponse response = client.prepare<span class="hljs-constructor">Search(<span class="hljs-string">&quot;car_shop&quot;</span>)</span><br>        .set<span class="hljs-constructor">Types(<span class="hljs-string">&quot;cars&quot;</span>)</span><br>        .set<span class="hljs-constructor">Query(QueryBuilders.<span class="hljs-params">termQuery</span>(<span class="hljs-string">&quot;name.raw&quot;</span>, <span class="hljs-string">&quot;宝马320&quot;</span>)</span>)                <br>        .get<span class="hljs-literal">()</span>;<br><span class="hljs-comment">// 前缀搜索</span><br>SearchResponse response = client.prepare<span class="hljs-constructor">Search(<span class="hljs-string">&quot;car_shop&quot;</span>)</span><br>        .set<span class="hljs-constructor">Types(<span class="hljs-string">&quot;cars&quot;</span>)</span><br>        .set<span class="hljs-constructor">Query(QueryBuilders.<span class="hljs-params">prefixQuery</span>(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;宝&quot;</span>)</span>)                <br>        .get<span class="hljs-literal">()</span>;    <br></code></pre></td></tr></table></figure>

<h4 id="bool操作"><a href="#bool操作" class="headerlink" title="bool操作"></a>bool操作</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">QueryBuilder qb = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">QueryBuilders</span>.</span></span><span class="hljs-built_in">bool</span><span class="hljs-constructor">Query()</span><br>    .must(<span class="hljs-keyword">match</span><span class="hljs-constructor">Query(<span class="hljs-string">&quot;brand&quot;</span>, <span class="hljs-string">&quot;宝马&quot;</span>)</span>)    <br>    .must<span class="hljs-constructor">Not(<span class="hljs-params">termQuery</span>(<span class="hljs-string">&quot;name.raw&quot;</span>, <span class="hljs-string">&quot;宝马318&quot;</span>)</span>) <br>    .should(term<span class="hljs-constructor">Query(<span class="hljs-string">&quot;produce_date&quot;</span>, <span class="hljs-string">&quot;2017-01-02&quot;</span>)</span>)  <br>    .filter(range<span class="hljs-constructor">Query(<span class="hljs-string">&quot;price&quot;</span>)</span>.gte(<span class="hljs-string">&quot;280000&quot;</span>).lt(<span class="hljs-string">&quot;350000&quot;</span>));<br><br>SearchResponse response = client.prepare<span class="hljs-constructor">Search(<span class="hljs-string">&quot;car_shop&quot;</span>)</span><br>        .set<span class="hljs-constructor">Types(<span class="hljs-string">&quot;cars&quot;</span>)</span><br>        .set<span class="hljs-constructor">Query(<span class="hljs-params">qb</span>)</span>                <br>        .get<span class="hljs-literal">()</span>;<br></code></pre></td></tr></table></figure>

<h4 id="geo-point操作"><a href="#geo-point操作" class="headerlink" title="geo_point操作"></a>geo_point操作</h4><p>添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.locationtech.spatial4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spatial4j<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.6<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>                        <br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.vividsolutions<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jts<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.13<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>                         <br>    <span class="hljs-tag">&lt;<span class="hljs-name">exclusions</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">exclusion</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>xerces<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>xercesImpl<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">exclusion</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">exclusions</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>添加测试数据</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs ada">POST /car_shop/_mapping/shops<br>&#123;<br>  <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;pin&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;properties&quot;</span>: &#123;<br>              <span class="hljs-string">&quot;location&quot;</span>: &#123;<br>                  <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;geo_point&quot;</span><br>              &#125;<br>          &#125;<br>      &#125;<br>  &#125;<br>&#125;<br><br>PUT /car_shop/shops/<span class="hljs-number">1</span><br>&#123;<br>    <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;上海至全宝马4S店&quot;</span>,<br>    <span class="hljs-string">&quot;pin&quot;</span> : &#123;<br>        <span class="hljs-string">&quot;location&quot;</span> : &#123;<br>            <span class="hljs-string">&quot;lat&quot;</span> : 40.12,<br>            <span class="hljs-string">&quot;lon&quot;</span> : -71.34<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>搜索两个坐标点组成的一个区域</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">SearchResponse response = client.prepareSearch(<span class="hljs-string">&quot;car_shop&quot;</span>)<br>        .setTypes(<span class="hljs-string">&quot;shops&quot;</span>)<br>        .setQuery(QueryBuilders.geoBoundingBoxQuery(<span class="hljs-string">&quot;pin.location&quot;</span>)<br>                .setCorners(<span class="hljs-number">40.73</span>, -<span class="hljs-number">74.1</span>, <span class="hljs-number">40.01</span>, -<span class="hljs-number">71.12</span>))<br>        .get();<br></code></pre></td></tr></table></figure>

<p>指定一个区域，由三个坐标点，组成，比如上海大厦，东方明珠塔，上海火车站</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">List&lt;GeoPoint&gt; points = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>points.add(<span class="hljs-keyword">new</span> GeoPoint(<span class="hljs-number">40.73</span>, -<span class="hljs-number">74.1</span>));<br>points.add(<span class="hljs-keyword">new</span> GeoPoint(<span class="hljs-number">40.01</span>, -<span class="hljs-number">71.12</span>));<br>points.add(<span class="hljs-keyword">new</span> GeoPoint(<span class="hljs-number">50.56</span>, -<span class="hljs-number">90.58</span>));<br><br>response = client.prepareSearch(<span class="hljs-string">&quot;car_shop&quot;</span>)<br>        .setTypes(<span class="hljs-string">&quot;shops&quot;</span>)<br>        .setQuery(QueryBuilders.geoPolygonQuery(<span class="hljs-string">&quot;pin.location&quot;</span>, points))<br>        .get();<br></code></pre></td></tr></table></figure>

<p>搜索距离当前位置在200公里内的4s店</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">response = client<span class="hljs-number">.</span>prepareSearch(<span class="hljs-string">&quot;car_shop&quot;</span>)<br><span class="hljs-meta">        .setTypes</span>(<span class="hljs-string">&quot;shops&quot;</span>)<br><span class="hljs-meta">        .setQuery</span>(QueryBuilders<span class="hljs-number">.</span>geoDistanceQuery(<span class="hljs-string">&quot;pin.location&quot;</span>)<br><span class="hljs-meta">                .point</span>(<span class="hljs-number">40</span>, -<span class="hljs-number">70</span>)<br><span class="hljs-meta">                .distance</span>(<span class="hljs-number">200</span>, DistanceUnit<span class="hljs-number">.</span>KILOMETERS))<br><span class="hljs-meta">        .get</span>()<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure>

<h4 id="api位置"><a href="#api位置" class="headerlink" title="api位置"></a>api位置</h4><ol>
<li>query类型，使用QueryBuilders中的方法</li>
<li>聚合类型，使用AggregationBuilders中的方法</li>
</ol>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/blog/categories/Elasticsearch/">Elasticsearch</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/blog/tags/elasticsearch/">elasticsearch</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/blog/2022/10/12/Elasticsearch/elasticsearch%E9%9B%86%E7%BE%A4/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Elasticsearch集群</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/blog/2022/03/29/%E5%88%86%E5%B8%83%E5%BC%8F%E5%BC%80%E5%8F%91%E6%8A%80%E6%9C%AF/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90/">
                        <span class="hidden-mobile">分布式锁实现分析</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.staticfile.org/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":200})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.staticfile.org/jquery/3.5.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.5.3/js/bootstrap.min.js" ></script>
<script  src="/blog/js/events.js" ></script>
<script  src="/blog/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/blog/js/img-lazyload.js" ></script>
  



  



  <script  src="https://cdn.staticfile.org/tocbot/4.12.0/tocbot.min.js" ></script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>






  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/blog/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/blog/local-search.xml";
      jQuery('#local-search-input').on('click', function() {
        searchFunc(path, 'local-search-input', 'local-search-result');
      });
      jQuery('#modalSearch').on('shown.bs.modal', function() {
        jQuery('#local-search-input').focus();
      });
    })()
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/blog/js/boot.js" ></script>


</body>
</html>
