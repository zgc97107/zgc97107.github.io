

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="">
  <meta name="keywords" content="">
  
    <meta name="description" content="集群名称和节点名称默认情况下，es会启动一个名称为elasticsearch的集群。通常建议一定要将自己的集群名称重新进行命名，主要是避免公司网络环境中，也许某个开发人员的开发机会无意中加入你的集群。在elasticsearch.yml中，可以设置集群名称：cluster.name: elasticsearch_production。 此外，每个node启动的时候，es也会分配一个随机的名称。但是">
<meta property="og:type" content="article">
<meta property="og:title" content="Elasticsearch配置">
<meta property="og:url" content="https://zgc97107.github.io/2022/10/12/Elasticsearch/elasticsearch%E9%85%8D%E7%BD%AE/index.html">
<meta property="og:site_name" content="萤火的博客">
<meta property="og:description" content="集群名称和节点名称默认情况下，es会启动一个名称为elasticsearch的集群。通常建议一定要将自己的集群名称重新进行命名，主要是避免公司网络环境中，也许某个开发人员的开发机会无意中加入你的集群。在elasticsearch.yml中，可以设置集群名称：cluster.name: elasticsearch_production。 此外，每个node启动的时候，es也会分配一个随机的名称。但是">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-10-12T02:45:15.000Z">
<meta property="article:modified_time" content="2022-10-12T02:45:15.000Z">
<meta property="article:tag" content="elasticsearch">
<meta name="twitter:card" content="summary_large_image">
  
  
  
  <title>Elasticsearch配置 - 萤火的博客</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"zgc97107.github.io","root":"/","version":"1.9.3","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 5.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>萤火的博客</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                主页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Elasticsearch配置"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-10-12 10:45" pubdate>
          2022年10月12日 上午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          17k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          139 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar category-bar" style="margin-right: -1rem">
    





<div class="category-list">
  
  
    
    
    
    <div class="category row nomargin-x">
      <a class="category-item 
          list-group-item category-item-action col-10 col-md-11 col-xm-11" title="Elasticsearch"
        id="heading-45e23a169652aaf95ce80da844f3df0d" role="tab" data-toggle="collapse" href="#collapse-45e23a169652aaf95ce80da844f3df0d"
        aria-expanded="true"
      >
        Elasticsearch
        <span class="list-group-count">(6)</span>
        <i class="iconfont icon-arrowright"></i>
      </a>
      
      <div class="category-collapse collapse show" id="collapse-45e23a169652aaf95ce80da844f3df0d"
           role="tabpanel" aria-labelledby="heading-45e23a169652aaf95ce80da844f3df0d">
        
        
          
  <div class="category-post-list">
    
    
      
      
        <a href="/2022/10/12/Elasticsearch/elasticsearch%E5%8D%87%E7%BA%A7/" title="Elasticsearch升级"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">Elasticsearch升级</span>
        </a>
      
    
      
      
        <a href="/2022/10/12/Elasticsearch/elasticsearch%E5%9F%BA%E7%A1%80/" title="Elasticsearch基础"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">Elasticsearch基础</span>
        </a>
      
    
      
      
        <a href="/2022/10/12/Elasticsearch/elasticsearch%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" title="Elasticsearch性能优化"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">Elasticsearch性能优化</span>
        </a>
      
    
      
      
        <a href="/2022/10/12/Elasticsearch/elasticsearch%E7%B4%A2%E5%BC%95%E7%AE%A1%E7%90%86/" title="Elasticsearch索引管理"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">Elasticsearch索引管理</span>
        </a>
      
    
      
      
        <a href="/2022/10/12/Elasticsearch/elasticsearch%E9%85%8D%E7%BD%AE/" title="Elasticsearch配置"
           class="list-group-item list-group-item-action
           active">
          <span class="category-post">Elasticsearch配置</span>
        </a>
      
    
      
      
        <a href="/2022/10/12/Elasticsearch/elasticsearch%E9%9B%86%E7%BE%A4/" title="Elasticsearch集群"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">Elasticsearch集群</span>
        </a>
      
    
  </div>

        
      </div>
    </div>
  
</div>


  </aside>


    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Elasticsearch配置</h1>
            
            
              <div class="markdown-body">
                
                <h3 id="集群名称和节点名称"><a href="#集群名称和节点名称" class="headerlink" title="集群名称和节点名称"></a>集群名称和节点名称</h3><p>默认情况下，es会启动一个名称为elasticsearch的集群。通常建议一定要将自己的集群名称重新进行命名，主要是避免公司网络环境中，也许某个开发人员的开发机会无意中加入你的集群。在elasticsearch.yml中，可以设置集群名称：<code>cluster.name: elasticsearch_production</code>。</p>
<p>此外，每个node启动的时候，es也会分配一个随机的名称。但是随机名称也不适合在生产环境中使用，这样会导致没法分辨机器。而且每次重启节点都会随机分配，node名称也会因为重启发生变化。因此通常在生产环境中是需要给每个node都分配一个名称的。在elasticsearch.yml中配置即可：<code>node.name:elasticsearch_005_data。</code></p>
<h3 id="文件路径"><a href="#文件路径" class="headerlink" title="文件路径"></a>文件路径</h3><p>数据目录、日志目录以及插件目录</p>
<p>默认情况下，es会将plugin，log，还有data ，config，file都放在es的安装目录中。这有一个问题，就是在进行es升级的时候，可能会导致这些目录被覆盖掉。导致我们丢失之前安装好的plugin，已有的log，还有已有的数据，以及配置好的配置文件。</p>
<p>所以一般建议在生产环境中，必须将这些重要的文件路径，都重新设置一下，放在es安装目录之外。path.data用于设置数据文件的目录，path.logs用于设置日志文件的目录，path.plugins用于设置插件存放的目录。path.data可以指定多个目录，用逗号分隔即可。如果多个目录在不同的磁盘上，那么这就是一个最简单的RAID 0的方式，将数据在本地进行条带化存储了，可以提升整体的磁盘读写性能。es会自动将数据在多个磁盘的多个目录中条带化存储数据。</p>
<p>一般建议的目录地址是：</p>
<ul>
<li>path.logs: /var/log/elasticsearch</li>
<li>path.data: /var/data/elasticsearch</li>
<li>path.plugins: /var/plugin/elasticsearch</li>
<li>config：/etc/elasticsearch</li>
</ul>
<p>在RAID 0的存储级别下，每个磁盘上回存储一部分数据，但是如果一个磁盘故障了，那么可能导致这台机器上的部分数据就丢失了。如果我们的es是有replica的，那么在其他机器上还是会有一份副本的。如果data file指定了多个目录，为了尽量减少数据丢失的风险，es会将某个shard的数据都分配到一个磁盘上去。这就意味着每个shard都仅仅会放在一个磁盘上。es不会将一个shard的数据条带化存储到多个磁盘上去，因为如果一个磁盘丢失了，就会导致整个shard数据丢失。</p>
<p>但是这又引入了性能的问题，如果我们给一个机器添加更多的磁盘来提升单个索引的读写性能，是没有效果的。因为这个索引在这个机器上的shard仅仅存在于一个磁盘上。因此data file指定多个目录，仅仅对于你的一台机器上存储了多个index的多个shard时，才会有效果的。因为不同index的shard可能就被存储到不同的磁盘上去了，对多个index的shard读写可以走不同磁盘，提升了性能。</p>
<p>虽然multiple data path是一个很有用的功能，但是es毕竟不是一个专门的RAID软件。如果我们要对RAID存储策略进行更多的配置，提高存储的健壮性以及灵活性，还是要用专门的RAID软件来进行机器的磁盘数据存储，而不是用multiple data path策略。</p>
<p>综上所述，multiple data path功能在实际的生产环境中，其实是较少使用的。</p>
<p>配置文件目录</p>
<p>es有两个配置文件，elasticsearch.yml，用于配置es，还有一个log4j.properties用来配置es日志打印。这些文件都被放在config目录下，默认就是ES_HOME/config。可以在启动时进行设置：./bin/elasticsearch -Epath.conf=/path/to/my/config/。</p>
<p>配置文件的格式是yaml格式的，比如下面这种格式：</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs crystal"><span class="hljs-symbol">path:</span><br>    <span class="hljs-symbol">data:</span> /var/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">elasticsearch</span></span><br>    <span class="hljs-symbol">logs:</span> /var/log/elasticsearch<br></code></pre></td></tr></table></figure>

<p>​<br>path.data: /var/lib/elasticsearch<br>path.logs: /var/log/elasticsearch</p>
<p>4、日志配置</p>
<p>es使用log4j2来记录日志，log4j2可以通过log4j2.properties文件来进行配置。比如下面的这份配置文件：</p>
<figure class="highlight roboconf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs roboconf">appender.rolling.type = RollingFile <br>appender.rolling.name = rolling<br><span class="hljs-comment"># 日志路径</span><br>appender.rolling.fileName = $&#123;<span class="hljs-attribute">sys</span>:es<span class="hljs-variable">.logs</span><span class="hljs-variable">.base_path</span>&#125;$&#123;sys:file<span class="hljs-variable">.separator</span>&#125;$&#123;sys:es<span class="hljs-variable">.logs</span><span class="hljs-variable">.cluster_name</span>&#125;<span class="hljs-variable">.log</span> <br>appender<span class="hljs-variable">.rolling</span><span class="hljs-variable">.layout</span><span class="hljs-variable">.type</span> = PatternLayout<br>appender<span class="hljs-variable">.rolling</span><span class="hljs-variable">.layout</span><span class="hljs-variable">.pattern</span> = [%d&#123;ISO8601&#125;][%-5p][%-25c] %.10000m%n<br>appender<span class="hljs-variable">.rolling</span><span class="hljs-variable">.filePattern</span> = $&#123;sys:es<span class="hljs-variable">.logs</span><span class="hljs-variable">.base_path</span>&#125;$&#123;sys:file<span class="hljs-variable">.separator</span>&#125;$&#123;sys:es<span class="hljs-variable">.logs</span><span class="hljs-variable">.cluster_name</span>&#125;-%d&#123;yyyy-MM-dd&#125;<span class="hljs-variable">.log</span> <br>appender<span class="hljs-variable">.rolling</span><span class="hljs-variable">.policies</span><span class="hljs-variable">.type</span> = Policies<br># 基于时间的roll策略<br>appender<span class="hljs-variable">.rolling</span><span class="hljs-variable">.policies</span><span class="hljs-variable">.time</span><span class="hljs-variable">.type</span> = TimeBasedTriggeringPolicy <br># 设置了每天一份日志文件<br>appender<span class="hljs-variable">.rolling</span><span class="hljs-variable">.policies</span><span class="hljs-variable">.time</span><span class="hljs-variable">.interval</span> = 1 <br># 设置了根据自然天来划分文件，而不是24小时,还可以配置将日志文件保留一段时间内，同时删除之前的日志文件<br>appender<span class="hljs-variable">.rolling</span><span class="hljs-variable">.policies</span><span class="hljs-variable">.time</span><span class="hljs-variable">.modulate</span> = true <br></code></pre></td></tr></table></figure>

<figure class="highlight roboconf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs roboconf"><span class="hljs-comment">#默认的DefaultRolloverStrategy</span><br>appender.rolling.strategy.type = DefaultRolloverStrategy <br><span class="hljs-comment">#在rollover之后，就会删除文件</span><br>appender.rolling.strategy.action.type = Delete <br><span class="hljs-comment">#es log的基础路径</span><br>appender.rolling.strategy.action.basepath = $&#123;<span class="hljs-attribute">sys</span>:es<span class="hljs-variable">.logs</span><span class="hljs-variable">.base_path</span>&#125; <br>#rollover发生的条件，是基于IfLastModified<br>appender<span class="hljs-variable">.rolling</span><span class="hljs-variable">.strategy</span><span class="hljs-variable">.action</span><span class="hljs-variable">.condition</span><span class="hljs-variable">.type</span> = IfLastModified <br>#保留的天数，这里是7天<br>appender<span class="hljs-variable">.rolling</span><span class="hljs-variable">.strategy</span><span class="hljs-variable">.action</span><span class="hljs-variable">.condition</span><span class="hljs-variable">.age</span> = 7D <br>#删除匹配7天前的文件<br>appender<span class="hljs-variable">.rolling</span><span class="hljs-variable">.strategy</span><span class="hljs-variable">.action</span><span class="hljs-variable">.PathConditions</span><span class="hljs-variable">.type</span> = IfFileName <br>#删除文件的格式，这样就只是删除过期日志文件，但是不要删除慢查询日志<br>appender<span class="hljs-variable">.rolling</span><span class="hljs-variable">.strategy</span><span class="hljs-variable">.action</span><span class="hljs-variable">.PathConditions</span><span class="hljs-variable">.glob</span> = $&#123;sys:es<span class="hljs-variable">.logs</span><span class="hljs-variable">.cluster_name</span>&#125;-* <br></code></pre></td></tr></table></figure>

<h3 id="es调优注意事项"><a href="#es调优注意事项" class="headerlink" title="es调优注意事项"></a>es调优注意事项</h3><p>对于es来说，大部分的参数都保留为默认的就可以了。因为这些参数经常被滥用和错误的调节，继而导致严重的稳定性问题以及性能的急剧下降。</p>
<h4 id="jvm-gc"><a href="#jvm-gc" class="headerlink" title="jvm gc"></a>jvm gc</h4><p>es默认用的垃圾回收器是CMS。CMS回收器是并发式的回收器，能够跟应用程序工作线程并发工作，最大程度减少垃圾回收时的服务停顿时间。但是CMS还是会有两个停顿阶段，同时在回收特别大的heap时也会有一些问题。尽管有一些缺点，但是CMS对于要求低延时请求响应的软件来说，还是最佳的垃圾回收器，因此官方的推荐就是使用CMS垃圾回收器。</p>
<p>有一种最新的垃圾回收器叫做G1。G1回收器可以比CMS提供更少的回收停顿时间，而且能够这对大heap有更好的回收表现。它会将heap划分为多个region，然后自动预测哪个region会有最多可以回收的空间。通过回收那些region，就可以最小化停顿时长，而且可以针对大heap进行回收。</p>
<p>听起来还挺不错的，但是不幸的是，G1还是比较年轻的一种垃圾回收器，而且经常会发现一些新的bug，这些bug可能会导致jvm挂掉。lucene的测试套件就检查出来了G1的一些bug。因此es官方不推荐现在使用G1垃圾回收器，也许在不久的未来，等G1更加稳定的时候，可以使用G1。</p>
<h4 id="threadpool"><a href="#threadpool" class="headerlink" title="threadpool"></a>threadpool</h4><p>每个人都很喜欢去调优线程池，而且大部分人都特别喜欢增加线程池的线程数量，无论是大量的写入，还是大量的搜索，或者是感觉服务器的cpu idle空闲率太高，都会增加更多的线程。在es中，默认的threadpool设置是非常合理的，对于所有的threadpool来说，除了搜索的线程池，都是线程数量设置的跟cpu core一样多的。如果我们有8个cpu core，那么就可以并行运行8个线程。那么对于大部分的线程池来说，分配8个线程就是最合理的数量。</p>
<p>不过搜索会有一个更加大的threadpool，一般被配置为：cpu core * 3 / 2 + 1。</p>
<p>也许我们会觉得有些线程可能会因为磁盘IO等操作block住，所以我们需要更多的线程。但是在es中这并不是一个问题，大多数的磁盘IO操作都是由lucene的线程管理的，而不是由es管理的，因此es的线程不需要关心这个问题。此外，threadpool还会通过在彼此之间传递任务来协作执行，我们不需要担心某一个网络线程会因为等待一次磁盘写操作，而导致自己被block住，无法处理网络请求。网络线程可以将那个磁盘写操作交给其他线程池去执行，然后自己接着回来处理网络请求。</p>
<p>其实我们的进程的计算能力是有限的，分配更多的线程只会强迫cpu在多个线程上下文之间频繁来回切换。一个cpu core在同一时间只能运行一条线程，所以如果cpu要切换到另外一个线程去执行，需要将当前的state保存起来，然后加载其他的线程进来执行。如果线程上下文切换发生在一个cpu core内，那么还好一些，但是如果在多个cpu core之间发生线程上下文切换，那么还需要走一个cpu core内部的通信。这种线程上下文切换会消耗掉很多的cpu资源，对于现在的cpu来说，每次线程上下文切换，都会导致30微秒的时间开销，所以宁愿将这些时间花费在任务的处理上。</p>
<p>很多人会将threadpool大小设置为一些很大的数值，在一个8核的机器上，可能运行了超过60，100，甚至1000个线程。这么多的线程会导致cpu资源利用率很低。所以下次如果我们要调节线程池的话，记住，千万别这么干。如果一定要调节线程数量，也得记住要根据你的cpu core数量来调节，比如设置为cpu core的两倍，如果设置的再多，那么就是一种浪费了。</p>
<h4 id="jvm-heap分配"><a href="#jvm-heap分配" class="headerlink" title="jvm heap分配"></a>jvm heap分配</h4><p>es默认会给jvm heap分配2个G的大小，对于几乎所有的生产环境来说，这个内存都太小了。如果用这个默认的heap size，那么生产环境的集群肯定表现不会太好。</p>
<h5 id="调节方式"><a href="#调节方式" class="headerlink" title="调节方式"></a>调节方式</h5><p>有两个方式来调节es中的jvm heap size。最简单的就是设置环境变量，ES_HEAP_SIZE。当es进程启动的时候，会读取这个环境变量的值，然后设置为jvm的heap size。举例来说，可以这样来设置：export ES_HEAP_SIZE=10g。此外，还可以在启动es进程的时候，传递一个jvm的option，比如：ES_JAVA_OPTS=”-Xms10g -Xmx10g” ./bin/elasticsearch，但是要注意-Xms和-Xmx最小和最大堆内存一定设置的一样，避免运行过程中的jvm heap resize，那会是一个非常耗时的过程。</p>
<p>在老版本的es中，比如es 2.x里面，一般推荐用ES_HEAP_SIZE环境变量的方式来设置jvm heap size。</p>
<p>在新版本的es中，比如es 5.x里面，一般推荐在jvm.options文件里面去设置jvm相关的参数。</p>
<h5 id="compressed-oops技术"><a href="#compressed-oops技术" class="headerlink" title="compressed oops技术"></a>compressed oops技术</h5><p>不要将过多的内存分配给es的jvm heap。如果heap小于32G的化，jvm会用一种技术来压缩对象的指针（object pointer）。在java中，所有的对象都会被分配到heap中，然后被一个pointer给引用。object pointer会指向heap中的对象，引用的是二进制格式的地址。</p>
<p>对于32位的系统来说，jvm最大的heap size就是4G。解释一下，32位，0和1值，0和1在32位的组合是2^32次方的字节，除以1024就是多少k，再除以1024就是多少mb，再除以1024就是多少gb，最后算下来就是4G。对于64位的系统来说，heap size可以更大，但是64位的object pointer会耗费更多的空间，因为object pointer更大了。比浪费更多内存空间更恶劣的是，过大的object pointer会在cpu，main memory和LLC、L1等多级缓存间移动数据的时候，吃掉更多的带宽。</p>
<p>所以jvm用了一种技术，叫做compressed oops来解决object pointer耗费过大空间的问题。这个技术的核心思想是，不要让object pointer引用内存中的二进制地址，而是让object pointer引用object offset。这就意味着32位的pointer可以引用400万个对象，而不是400万字节。这也意味着，使用32位的pointer，最大的heap大小可以到32G。此时只要heap size在32G以内，jvm就会自动启用32位的object pointer，因为32位的对象指针，足够引用32G的内存了，就可以用32位的pointer替代64位的pointer。但是32位的pointer比64位的pointer可以耗费更少的内存耗费。</p>
<p>如果你给jvm heap分配的内存小于32G，此时jvm会自动使用32位的object pointer，同时是让pointer指向对象的offset，32位的object pointer就足以引用32G的内存，同时32位的pointer占用的内存空间很少，对cpu和memory之间移动数据的带宽开销也很少。这个过程就叫做compressed oops。</p>
<p>但是一旦我们越过了32G这个界限，就是给jvm heap分配了超过32G的内存，就没有办法用32位的pointer+引用object offset的模式了，因为32位的pointer最多引用32G的内存，超过了32G，就没法用32位pointer。不用32位pointer，就只能用64位pointer，才能引用超过32G的内存空间。此时pointer就会退回到传统的object pointer引用对象的二进制地址的模式，此时object pinter的大小会急剧增长，可能1/3的内存都被object pointer占据了，更多的cpu到内存的带宽会被占据，更多的内存被耗费。不用compressed oops时，如果给jvm heap分配了一个40~50G的内存的可用空间，实际上被object pointer可能都要占据十几G的内存空间，可用的空间量，可能跟使用了compressed oops时的32GB内存的可用空间，20多个G，几乎是一样的。</p>
<p>一般来说，如果你的es要处理的数据量上亿的话，几亿，或者十亿以内的规模的话，用5台64G的内存的机器比较合适。给jvm heap分配32G，留下32G给os cache。</p>
<p>实际上将jvm heap size设置为31G比较安全一些。主要是要确保设置的这个jvm heap大小，可以让es启用compressed oops这种优化机制。此外，可以给jvm option加入-XX:+PrintFlagsFinal，然后可以打印出来UseCompressedOops是否为true。这就可以让我们找到最佳的内存设置。因为可以不断调节内存大小，然后观察是否启用compressed oops。</p>
<p>举例来说，如果在mac os上启动一个java 1.7，同时将heap size设置为32600mb，那么compressed oops是会开启的；但是如果设置为32766m，compressed oops就不会开启。相反的是，使用jdk 1.8的化，分配32766m，compressed oops是会开启的，设置为32767m，就不会开启。所以说，这个东西不是固定的。根据不同的操作系统以及jvm版本而定。</p>
<p>在es启动日志中，我们可以查看compressed oops是否开启，比如下面的字样：[2015-12-16 13:53:33,417][INFO ][env] [Illyana Rasputin] heap size [989.8mb], compressed ordinary object pointers [true]。</p>
<h5 id="分配建议"><a href="#分配建议" class="headerlink" title="分配建议"></a>分配建议</h5><p>es的性能其实是由有多少内存留给操作系统的os cache，供lucene去缓存索引文件，来决定的。一个常见的问题就是将es进程的jvm heap size设置的过于大了。虽然heap对于es来说是非常重要的，jvm heap被es用来存放很多内存中的数据结构来提供更快的操作性能。但是lucene的设计就是要使用底层的os filesystem cache来缓存数据结构。lucene的segment是保存在单独的文件中的，这些segment是不可变的，所以这些文件实际上也从来不会改变。底层的os cache会将hot segment驻留在内存中以供更快的访问。这些segment包括了倒排索引（为了全文检索）以及正排索引（为了聚合操作）。lucene的性能是严重依赖于底层的os的，如果我们给了过多的内存到es的jvm heap，那么就没有足够的内存留给lucene，这会极大的影响性能。</p>
<p>一般建议的是，将50%的内存分配给es jvm heap，然后留50%的内存给os cache。留给os cache的内存是不会不使用的，lucene会将剩下的内存全部用光，用来cache segment file。如果不对分词的text field进行聚合操作，那么就不需要使用fielddata，因为fielddata是要用jvm heap，就可以考虑给os cache更多的内存。如果给jvm heap更少的内存，那么实际上es的性能反而会更好，因为更多的内存留给了lucene用os cache提升索引读写性能，同时es的jvm heap的gc耗时会更少。</p>
<p>如果我们的机器是一台超级服务器，内存资源甚至达到了1TB，或者512G，128G，es官方是建议避免用这种超级服务器来部署es集群的，但是如果我们只有这种机器可以用的话，我们要考虑以下几点：</p>
<ol>
<li><p>我们是否在做大量的全文检索？考虑一下分配4~32G的内存给es进程，同时给lucene留下其余所有的内存用来做os filesystem cache。所有的剩余的内存都会用来cache segment file，而且可以提供非常高性能的搜索，几乎所有的数据都是可以在内存中缓存的，es集群的性能会非常高</p>
</li>
<li><p>是否在做大量的排序或者聚合操作？聚合操作是不是针对数字、日期或者未分词的string？如果是的化，那么还是给es 4~32G的内存即可，其他的留给es filesystem cache，可以将聚合好用的正排索引，doc values放在os cache中</p>
</li>
<li><p>如果在针对分词的string做大量的排序或聚合操作？如果是的话，那么就需要使用fielddata，这就得给jvm heap分配更大的内存空间。此时不建议运行一个节点在机器上，而是运行多个节点在一台机器上，那么如果我们的服务器有128G的内存，可以运行两个es节点，然后每个节点分配32G的内存，剩下64G留给os cache。如果在一台机器上运行多个es node，建议设置：cluster.routing.allocation.same_shard.host: true。这会避免在同一台物理机上分配一个primary shard和它的replica shard。</p>
</li>
</ol>
<h4 id="swapping"><a href="#swapping" class="headerlink" title="swapping"></a>swapping</h4><p>如果频繁的将es进程的内存swap到磁盘上，绝对会是一个服务器的性能杀手。想象一下，内存中的操作都是要求快速完成的，如果需要将内存页的数据从磁盘swap回main memory的化，性能会有多差。如果内存被swap到了磁盘，那么100微秒的操作会瞬间变成10毫秒，那么如果是大量的这种内存操作呢？这会导致性能急剧下降。</p>
<p>因此通常建议彻底关闭机器上的swap，swapoff -a，如果要永久性关闭，需要在/etc/fstab中配置</p>
<p>如果没法完全关闭swap，那么可以尝试调低swappiness至，这个值是控制os会如何将内存swap到磁盘的。这会在正常情况下阻止swap，但是在紧急情况下，还是会swap。一般用sysctl来设置，vm.swappiness = 1。如果swappiness也不能设置，那么就需要启用mlockall，这就可以让我们的jvm lock住自己的内存不被swap到磁盘上去，在elasticsearch.yml中可以设置：bootstrap.mlockall: true。</p>
<h3 id="系统的重要配置"><a href="#系统的重要配置" class="headerlink" title="系统的重要配置"></a>系统的重要配置</h3><p>理想情况下，es应该单独在一个服务器上运行，能够使用服务器上的所有资源。为了达到上述目标，我们需要配置操作系统，来允许用户运行es并且获取比默认情况下更多的资源。</p>
<p>在生产环境中下面的一些设置必须配置一下：</p>
<ul>
<li>禁止swapping</li>
<li>确保拥有足够的虚拟内存</li>
<li>确保拥有足够的线程数量</li>
</ul>
<p>默认情况下，es会假设你是在开发模式下运行的。如果上面的任何配置没有正确的设置，那么会输出一些warning到日志文件中，但是我们还是可以启动es进程的。</p>
<p>但是如果我们配置了网络设置，比如network.host，es会认为我们是运行在生产环境中的，然后就会将上述warning升级为exception。这些exception会阻止我们的es节点启动。这是一个重要的安全保障措施来确保我们不会因为错误的配置了es server，而导致数据丢失。</p>
<h4 id="配置方式"><a href="#配置方式" class="headerlink" title="配置方式"></a>配置方式</h4><h5 id="系统参数"><a href="#系统参数" class="headerlink" title="系统参数"></a>系统参数</h5><p>在/etc/security/limits.conf中，可以配置系统设置，也可以用ulimit临时配置系统设置。</p>
<p>在linux操作系统中，ulimit可以用来临时的改变资源限制。通常需要用root权限来设置ulimit。</p>
<p>举例，如果要设置file descriptor为65536，可以用如下的命令来设置：</p>
<p>ulimit -n 65536</p>
<p>但是在linux操作系统中，实际上永久性的资源限制可以通过编辑/etc/security/limits.conf文件来设置。比如要设置file descriptor，可以再limits.conf中加入下面的行：</p>
<p>elasticsearch - nofile 65536</p>
<p>在下一次elasticsearch用户开启一个新的会话时就会生效</p>
<h5 id="jvm-option"><a href="#jvm-option" class="headerlink" title="jvm option"></a>jvm option</h5><p>一般建议通过jvm.options配置文件来设置es的jvm option。默认的地址是config/jvm.options</p>
<p>每行是一个jvm argument</p>
<p>此外，如也可以通过ES_JAVA_OPTS环境变量来设置jvm option，比如下面的命令：</p>
<p>export ES_JAVA_OPTS=”$ES_JAVA_OPTS -Djava.io.tmpdir=/path/to/temp/dir”</p>
<h4 id="禁止swapping"><a href="#禁止swapping" class="headerlink" title="禁止swapping"></a>禁止swapping</h4><p>大多数操作系统都会使用尽量多的内存来进行file system cache，并且尽量将不经常使用的java应用的内存swap到磁盘中去。这会导致jvm heap的部分内存，甚至是用来执行代码的内存页被swap到磁盘中去。</p>
<p>swapping对于性能来说是非常差劲的，为了es节点的稳定性考虑，应该尽量避免这种swapping。因为swapping会导致gc过程从毫秒级变成分钟级，在gc的时候需要将内存从磁盘中swapping到内存里，特别耗时，这会导致es节点响应请求变得很慢，甚至导致es node跟cluster失联。在一个弹性的分布式系统中，让操作系统kill掉某一个节点，是很高效的。</p>
<p>有三种方法可以disable swapping。推荐的option是彻底禁用swap，如果做不到的化，也得尽量最小化swappiness的影响，比如通过lock memory的方法。</p>
<ol>
<li><p>禁用所有的swapping file</p>
<p>通常来说，es进程会在一个节点上单独运行，那么es进程的内存使用是由jvm option控制的。可以使用下面的命令临时性禁止swap：swapoff -a。要永久性的禁止swap，需要修改/etc/fstab文件，然后将所有包含swap的行都注释掉</p>
</li>
<li><p>配置swappiness</p>
<p>将vm.swappiness设置为1，这可以尽量减少linux内核swap的倾向，在正常情况下，就不会进行swap，但是在紧急情况下，还是会进行swap操作。sysctl -w vm.swappiness=1</p>
</li>
<li><p>启用bootstrap.memory_lock</p>
<p>最后一个选项，就是用mlockall，将es jvm进程的address space锁定在内存中，阻止es内存被swap out到磁盘上去。在config/elasticsearch.yml中，可以配置：</p>
<p>bootstrap.memory_lock: true</p>
<p>GET _nodes?filter_path=**.mlockall，通过这行命令可以检查mlockall是否开启了</p>
<p>如果发现mlockall是false，那么意味着mlockall请求失败了。会看到一行日志，unable to lock jvm memory。最大可能的原因，就是在linux系统中，启动es进程的用户没有权限去lock memory，需要通过以下方式进行授权：</p>
<p>ulimit -l unlimited</p>
<p>/etc/security/limits.conf，memlock设置为unlimited</p>
<p>另外一个原因可能是临时目录使用noexec option来mount了。可以通过指定一个新的临时目录来解决。</p>
<p>export ES_JAVA_OPTS=”$ES_JAVA_OPTS -Djava.io.tmpdir=/path/to/temp/dir”</p>
<p>当然也可以通过在jvm.options文件中来设置java.io.tmpdir</p>
</li>
</ol>
<h4 id="虚拟内存"><a href="#虚拟内存" class="headerlink" title="虚拟内存"></a>虚拟内存</h4><p>es使用hybrid mmapfs / niofs目录来存储index数据，操作系统的默认mmap count限制是很低的，可能会导致内存耗尽的异常。</p>
<p>需要提升mmap count的限制：sysctl -w vm.max_map_count=262144</p>
<p>如果要永久性设置这个值，要修改/etc/sysctl.conf，将vm.max_map_count的值修改一下，重启过后，用sysctl vm.max_map_count来验证一下数值是否修改成功。</p>
<p>es同时会用NioFS和MMapFS来处理不同的文件，我们需要设置最大的map刷另，这样我们才能有足够的虚拟内存来给mmapped文件使用，可以用sysctl来设置：sysctl -w vm.max_map_count=262144。还可以再/etc/sysctl.conf中，对vm.max_map_count来设置。</p>
<h4 id="线程的数量"><a href="#线程的数量" class="headerlink" title="线程的数量"></a>线程的数量</h4><p>es用了很多线程池来应对不同类型的操作，在需要的时候创建新的线程是很重要的。要确保es用户能创建的最大线程数量至少在2048以上。</p>
<p>可以通过ulimit -u 2048来临时设置，也可以在/etc/security/limits.conf中设置nproc为2048来永久性设置。</p>
<h3 id="bootstrap-check"><a href="#bootstrap-check" class="headerlink" title="bootstrap check"></a>bootstrap check</h3><p>在es以前的老版本中，对这些设置错误的配置，会在日志里记录一些warning告警。但是有时候用户会忽略这些日志中的告警信息。为了确保说这些设置的错误配置告警信息可以引起用户的注意，es的新版本中引入了bootstrap check，也就是启动时检查。这些启动时检查操作，会检查许多es和系统的设置，将这些配置的值跟es期望的安全值去进行比较。如果es在development mode下，那么失败的检查仅仅在日志中打印warning。如果es运行在生产模式下，任何启动时检查的失败都会导致es拒绝启动。</p>
<p>默认情况下，es绑定到localhost hostname，来进行http和内部通信。这对于下载es并简单试用一下，包括日常的开发，都是非常方便的，但是对于生产环境是不行的。如果要组建一个es集群，es实例必须能够通过内部通信协议互相连通，所必须绑定通信到一个外部的接口上。因此如果一个es实例没有绑定通信到外部接口（默认情况下），那么就认为es是处于开发模式下。反之，如果绑定通信到外部接口，那么就是处于生产模式下。</p>
<p>同时也可以通过http.host和transport.host，单独配置http的传输。这就可以配置一个es实例通过http可达，但是却不触发生产模式。</p>
<p>因为有时用户需要将通信绑定到外部解耦来测试client的调用。对于这种场景，es提供了single-node恢复模式（将discovery.type设置为single-node），配置过后，一个节点会选举自己作为master，而且不会跟其他任何节点组成集群。</p>
<p>如果在生产模式下运行一个single node实例，就可以规避掉启动时检查（不要将通信绑定到外部接口，或者将通信绑定到外部接口，但是设置discovery type为single-node）。在这种场景下，可以设置es.enforce.bootstrap.checks为true（通过jvm参数来设置），来强制bootstrap check的执行。</p>
<h4 id="heap-size-check"><a href="#heap-size-check" class="headerlink" title="heap size check"></a>heap size check</h4><p>如果jvm启动的时候设置的初始队大小和最大堆大小不同，可能会导致es运行期间的暂停，因为jvm堆在系统运行期间可能会改变大小。为了避免这种jvm resize导致的es进程暂停，建议启动jvm时，将初始堆大小和最大堆大小设置的相等。除此之外，如果bootstrap.memory_lock被启用了，jvm会在启动期间锁定jvm的初始大小。</p>
<h4 id="file-descriptor-check"><a href="#file-descriptor-check" class="headerlink" title="file descriptor check"></a>file descriptor check</h4><p>file descriptor是unix操作系统的一种数据结构，用来track打开的文件。在unix操作系统中，所有东西都是file。比如，file可以是物理文件，虚拟文件，或者网络socket。es需要大量的file descriptor，比如说每个shard都由多个segment和其他文件组成，还有跟其他节点之间的网络通信连接。</p>
<p>因为es要使用大量的file descriptor，所以如果file descriptor耗尽的话，会是一场灾难，甚至可能会导致数据丢失。尽量给es的file descriptor提升到65536，甚至更高。</p>
<p>可以在/etc/security/limits.conf中，设置nofile为65536</p>
<p>lucene会使用大量的文件，同时es也会使用大量的socket在节点间和client间进行通信，这些都是需要大量的file descriptor的。但是通常来说，现在的linux操作系统，都是给每个进程默认的1024个file descriptor的，这对于一个es进程来说是远远不够的。</p>
<p>我们需要将es进程的file descriptor增加到非常非常大，比如说65535个。一般需要根据我们的操作系统的文档来查看如何设置file descriptor。然后可以直接对es集群查看GET，来确认file descriptor的数量：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-builtin-name">GET</span> _nodes/stats/process?<span class="hljs-attribute">filter_path</span>=**.max_file_descriptors<br></code></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;nodes&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;zF_aLKOySKuWlV9vvK8_eg&quot;</span>: &#123;<br>      <span class="hljs-attr">&quot;process&quot;</span>: &#123;<br>        <span class="hljs-attr">&quot;max_file_descriptors&quot;</span>: <span class="hljs-number">1048576</span><br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="memory-lock-check"><a href="#memory-lock-check" class="headerlink" title="memory lock check"></a>memory lock check</h4><p>如果jvm进行一个major gc的话，那么就会涉及到heap中的每一个内存页，此时如果任何一个内存页被swap到了磁盘上，那么此时就会被swap回内存中。这就会导致很多的磁盘读写开销，而这些磁盘读写开销如果节省下来，可以让es服务更多的请求。有很多方法可以配置系统禁止swap。其中一种方法就是让jvm去lock heap内存在物理内存中，设置bootstrap.memory_lock即可。</p>
<p>GET _nodes?filter_path=**.mlockall</p>
<p>检查一下，mlockall是否开启，如果是false，那么说明lock memory失败了，而且日志里可能会有unable to lock jvm memory的字样。</p>
<p>可能就是因为运行es的用户没有lock memory的权限，此时就需要进行授权</p>
<p>/etc/security/limits.conf</p>
<p>设置memlock为unlimited即可完成授权</p>
<p>另外一个原因导致lock memory失败，可能是因为临时目录，/tmp用noexec option来mount了</p>
<p>那么就需要设置ES_JAVA_OPTS，export ES_JAVA_OPTS=”$ES_JAVA_OPTS -Djava.io.tmpdir=/path/to/temp/dir”</p>
<p>或者在jvm.options中设置这个参数。</p>
<h4 id="maximum-number-of-thread-check"><a href="#maximum-number-of-thread-check" class="headerlink" title="maximum number of thread check"></a>maximum number of thread check</h4><p>es会将每个请求拆分成多个stage，然后将stage分配到不同的线程池中去执行。在es中有多个线程池来执行不同的任务。所以es会创建许多的线程。最大线程数量的检查会确保说，es实例有权限去创建足够的线程。如果要通过这个检查，必须允许es进程能够创建超过2048个线程。</p>
<p>/etc/security/limits.conf，在这个文件中，用nproc来设置</p>
<h4 id="maximum-size-virtual-memory-check"><a href="#maximum-size-virtual-memory-check" class="headerlink" title="maximum size virtual memory check"></a>maximum size virtual memory check</h4><p>es使用mmap来将索引映射到es的address space中，这可以让jvm heap外但是内存中的索引数据，可以有非常告诉的读写速度。因此es需要拥有unlimited address space。最大虚拟内存大小的检查，会要求es进程有unlimited address space。</p>
<p>/etc/security/limits.conf，设置as为unlimited</p>
<h4 id="maximum-map-count-check"><a href="#maximum-map-count-check" class="headerlink" title="maximum map count check"></a>maximum map count check</h4><p>要高效使用mmap的话，es同样要求创建许多memory-mapped area。因此要求linux内核允许进程拥有至少262144个memory-mapped area，需要通过sysctl设置vm.max_map_count至少超过262144。</p>
<h4 id="client-jvm-check"><a href="#client-jvm-check" class="headerlink" title="client jvm check"></a>client jvm check</h4><p>jvm有两种模式，client jvm和server jvm。不同的jvm会用不同的编译器来从java源码生成可执行机器代码。client jvm被优化了来减少startup time和内存占用，server jvm被优化了来最大化性能。两种jvm之间的性能区别是很明显的。client jvm check会确保es没有运行在client jvm下。必须使用server jvm模式来启动es，而server jvm是默认的。</p>
<h4 id="use-serial-collector-check"><a href="#use-serial-collector-check" class="headerlink" title="use serial collector check"></a>use serial collector check</h4><p>针对不同的工作负载，jvm提供了不同的垃圾回收器。串行化垃圾回收期对于单cpu机器或者小内存，是很有效的。但是对于es来说，用串行化垃圾回收器，会成为一场性能上的灾难。因此这个check会确保es没有被配置使用串行化垃圾回收器。es默认的就是cms垃圾回收器。</p>
<h4 id="system-call-filter-check"><a href="#system-call-filter-check" class="headerlink" title="system call filter check"></a>system call filter check</h4><p>es会根据不同的操作系统来安装system call filter，用来阻止执行作为defense机制的fork相关system call，进而避免任意代码执行的攻击。这个check会检查是否允许system call filter，然后安装这些system call filter。避免bootstrap.system_call_filter设置为false。</p>
<h4 id="OnError-and-OnOutOfMemoryError-check"><a href="#OnError-and-OnOutOfMemoryError-check" class="headerlink" title="OnError and OnOutOfMemoryError check"></a>OnError and OnOutOfMemoryError check</h4><p>jvm参数，OnError和OnOutOfMemoryError允许在jvm遇到了fatal error或者是OutOfMemoryErro的时候，执行我们预定义的命令。然而，默认情况下，es system call filter是启用的，这些filter是阻止forking操作的。因此，用OnError和OnOutOfMemroyError和system call filter是不兼容的。这个check会检查，如果启用了system call filter，还设置了这两个jvm option，那么就不能启动。所以不要在jvm option中设置这两个参数。</p>
<h4 id="early-access-check"><a href="#early-access-check" class="headerlink" title="early-access check"></a>early-access check</h4><p>jdk提供了early-access快照，为即将到来的版本。这些版本不适合用作生产环境。这个check会检查有没有使用jdk的early-access快照版本。我们应该用jdk稳定版本，而不是试用版本。</p>
<h4 id="G1-GC-check"><a href="#G1-GC-check" class="headerlink" title="G1 GC check"></a>G1 GC check</h4><p>jdk 8的jvm早期版本中的g1 gc，有已知的问题可能导致索引破损。在JDK 8u40之前的版本都有这个问题。这个check会检查是否使用了那种早期的JDk版本。</p>
<h3 id="daemon模式启动es"><a href="#daemon模式启动es" class="headerlink" title="daemon模式启动es"></a>daemon模式启动es</h3><p>在生产环境中，会使用daemon进程的方式来启动es，而不是直接采用前台进程的方式来启动es，具体命令如下</p>
<p>./bin/elasticsearch -d -p pid</p>
<p>上面命令中的-d option用来指定es以daemon进程方式启动，并且-p option指定将进程id记录在指定文件中</p>
<p>es启动后，日志信息可以在ES_HOME/logs目录中查看</p>
<p>此外，启动es进程的时候，还可以直接覆盖一些配置，使用-E即可，如下面的命令，通常用于调试集群参数时，方便快速调节参数，查看效果</p>
<h4 id="常见错误"><a href="#常见错误" class="headerlink" title="常见错误"></a>常见错误</h4><ul>
<li><p>log4j的配置不能有空格</p>
</li>
<li><p>es运行需要创建专门的elasticsearch用户并授权，或者启动时添加-Des.insercure.allow.root=true允许root用户启动</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># 创建用户</span><br>adduser elasticsearch<br>passwd elasticsearch<br><span class="hljs-comment"># 授权</span><br>chown -R elasticsearch <span class="hljs-regexp">/usr/</span>local/elasticsearch<br>chown -R elasticsearch <span class="hljs-regexp">/var/</span>log/elasticsearch<br>chown -R elasticsearch <span class="hljs-regexp">/var/</span>data/elasticsearch<br>chown -R elasticsearch <span class="hljs-regexp">/var/</span>plugin/elasticsearch<br>chown -R elasticsearch <span class="hljs-regexp">/etc/</span>elasticsearch<br>chown -R elasticsearch <span class="hljs-regexp">/usr/</span>local/tmp<br></code></pre></td></tr></table></figure>
</li>
<li><p>修改/etc/security/limits.conf中的用户为elasticsearch，加入memlock的soft unlimited，内容为：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">elasticsearch</span> hard memlock unlimited<br><span class="hljs-attribute">elasticsearch</span> soft memlock unlimited<br><span class="hljs-attribute">elasticsearch</span> hard nproc   <span class="hljs-number">2048</span><br><span class="hljs-attribute">elasticsearch</span> hard nofile  <span class="hljs-number">65536</span><br><span class="hljs-attribute">elasticsearch</span> hard as      unlimited<br></code></pre></td></tr></table></figure>
</li>
<li><p>path.plugins配置失效，删除这行配置</p>
</li>
<li><p>将es的bin加入环境变量PATH中</p>
</li>
<li><p>切换到elasticsearch用户来启动es进程</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs arcade">su elasticsearch<br>elasticsearch -d -Epath.conf=<span class="hljs-regexp">/etc/</span>elasticsearch<br></code></pre></td></tr></table></figure>
</li>
<li><p>jvm.options用的还是原本目录中的配置文件</p>
</li>
</ul>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Elasticsearch/" class="category-chain-item">Elasticsearch</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/elasticsearch/">#elasticsearch</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Elasticsearch配置</div>
      <div>https://zgc97107.github.io/2022/10/12/Elasticsearch/elasticsearch配置/</div>
    </div>
    <div class="license-meta">
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2022年10月12日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/10/12/Elasticsearch/elasticsearch%E5%8D%87%E7%BA%A7/" title="Elasticsearch升级">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Elasticsearch升级</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/10/12/Elasticsearch/elasticsearch%E9%9B%86%E7%BE%A4/" title="Elasticsearch集群">
                        <span class="hidden-mobile">Elasticsearch集群</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
